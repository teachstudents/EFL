<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Detail Drills</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Confetti Animation */
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100px) rotate(720deg); opacity: 0; }
        }
        .animate-confetti {
            animation-name: confetti;
            animation-timing-function: ease-out;
            animation-fill-mode: forwards;
        }

        /* Fade In Animation */
        .animate-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 overflow-hidden h-screen w-screen">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- INLINE ICONS (To prevent CDN errors) ---
        const Icon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Play = (p) => <Icon {...p}><polygon points="5 3 19 12 5 21 5 3"></polygon></Icon>;
        const Square = (p) => <Icon {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></Icon>;
        const RefreshCw = (p) => <Icon {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 21h-5v-5"></path></Icon>;
        const Check = (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"></polyline></Icon>;
        const X = (p) => <Icon {...p}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>;
        const MapIcon = (p) => <Icon {...p}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></Icon>;
        const BookOpen = (p) => <Icon {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></Icon>;
        const Clock = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></Icon>;
        const Calendar = (p) => <Icon {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></Icon>;
        const Phone = (p) => <Icon {...p}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></Icon>;
        const DollarSign = (p) => <Icon {...p}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></Icon>;
        const Navigation = (p) => <Icon {...p}><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></Icon>;
        const Mail = (p) => <Icon {...p}><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></Icon>;
        const Ruler = (p) => <Icon {...p}><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0l12.6 12.6z"></path><line x1="13" y1="5.7" x2="15.3" y2="8"></line><line x1="9" y1="9.7" x2="11.3" y2="12"></line><line x1="5" y1="13.7" x2="7.3" y2="16"></line></Icon>;
        const Users = (p) => <Icon {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></Icon>;
        const List = (p) => <Icon {...p}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></Icon>;
        const MessageCircle = (p) => <Icon {...p}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></Icon>;
        const Trophy = (p) => <Icon {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17"></path><path d="M14 14.66V17"></path><path d="M18 2h-5.5a5.5 5.5 0 1 0 0 11h5.5a8 8 0 0 0 0-16z"></path><path d="M10 0v4"></path><path d="M14 0v4"></path></Icon>;
        const Sparkles = (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M9 3v4"></path><path d="M3 5h4"></path><path d="M3 9h4"></path></Icon>;
        const HelpCircle = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></Icon>;
        const Zap = (p) => <Icon {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></Icon>;

        // --- CONFIGURATION ---
        const DEFAULT_SPEECH_RATE = 0.85; 
        const TOTAL_QUESTIONS_PER_ROUND = 10;

        // --- AUDIO FX ---
        const playSoundFx = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.connect(gain);
            gain.connect(ctx.destination);

            if (type === 'correct') {
                const now = ctx.currentTime;
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, now); // C5
                osc.frequency.setValueAtTime(659.25, now + 0.1); // E5
                osc.frequency.setValueAtTime(783.99, now + 0.2); // G5
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'hint') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(400, ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.05, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.2);
                osc.start();
                osc.stop(ctx.currentTime + 0.2);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            }
        };

        // --- UTILITIES ---
        const PRAISES = ["Brilliant!", "Spot on!", "Excellent!", "Perfect!", "Well done!", "Fantastic!"];

        const checkAnswer = (user, correct, type) => {
            if (!user) return false;
            const u = user.toLowerCase().trim().replace(/[\s-]/g, '');
            const c = correct.toString().toLowerCase().trim().replace(/[\s-]/g, '');
            
            if (u === c) return true;
            if (type === 'price') return u.includes(c) || c.includes(u);
            if (type === 'time') return u.replace('.',':') === c.replace('.',':');
            if (type === 'measurement') return u === c || u === c.replace(/meters|cms|kgs/, '').trim();
            return false;
        };

        const generateHint = (answer) => {
            return answer.toString().split('').map((char, index) => {
                if (index === 0) return char; // Reveal first char
                if (char === ' ' || char === ':' || char === '.' || char === '@') return char; // Reveal separators
                return '_';
            }).join(' ');
        };

        // --- DATA BANKS ---
        const NAMES = ['Weston', 'Bailey', 'Patterson', 'Jenkins', 'Martinez', 'Sutherland', 'Blackwood', 'Yates', 'Oliver', 'Franklin', 'Davidson', 'Holloway', 'Redgrave', 'Winchester', 'Kensington', 'Barrington', 'Stephenson', 'Macdonald', 'Fletcher', 'Underwood'];
        const STREETS = ['Green', 'Broad', 'Church', 'Kings', 'Queens', 'North', 'West', 'Oak', 'Pine', 'Cedar', 'Maple', 'High', 'Station', 'Victoria', 'Albert', 'Chestnut', 'Market', 'Bridge', 'Park', 'Garden'];
        const EVENTS = ['conference', 'seminar', 'workshop', 'meeting', 'lecture', 'tutorial', 'exam', 'ceremony', 'orientation', 'interview'];
        const FURNITURE = ['desk', 'sofa', 'table', 'bookshelf', 'cabinet', 'wardrobe', 'mirror', 'rug', 'armchair', 'lamp'];
        const TRAIN_DESTINATIONS = ['London', 'Birmingham', 'Manchester', 'Leeds', 'Newcastle', 'Edinburgh', 'Bristol', 'Cardiff', 'Liverpool', 'Glasgow'];
        const PRICE_ITEMS = ['ticket', 'membership', 'textbook', 'course fee', 'registration', 'locker deposit', 'printing card', 'excursion'];
        const TRANSPORT = ['bus', 'train', 'taxi', 'shuttle', 'tram', 'ferry', 'bicycle', 'coach'];
        const DESTINATIONS = ['airport', 'city center', 'university', 'stadium', 'museum', 'harbour', 'central station', 'town hall'];

        // --- QUESTION GENERATOR ---
        const generateQuestion = (category) => {
            const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

            let q = { category, type: category.id };

            switch (category.id) {
                case 1: // Names & Spelling
                    const surname = rand(NAMES);
                    const spelling = surname.split('').join('... ');
                    q.stem = "Write the correct spelling of the surname.";
                    q.answer = surname;
                    q.script = [
                        { speaker: 'A', text: `Can I have your surname for the form, please?` },
                        { speaker: 'B', text: `Yes, it's ${surname}.` },
                        { speaker: 'A', text: `Could you spell that for me?` },
                        { speaker: 'B', text: `Certainly. It is ${spelling}.` },
                        { speaker: 'A', text: `${spelling}. Thank you.` } 
                    ];
                    break;
                case 2: // Phone / ID
                    const p1 = randInt(100, 999);
                    const p2 = randInt(1000, 9999);
                    const wrongP2 = p2 + randInt(1, 9);
                    q.stem = "Write the phone number.";
                    q.answer = `07${p1} ${p2}`;
                    q.script = [
                        { speaker: 'A', text: `What's the best contact number for you?` },
                        { speaker: 'B', text: `Well, my old number was 07${p1} ${wrongP2}, but I've lost that phone.` },
                        { speaker: 'A', text: `Oh, I see. So what is the current one?` },
                        { speaker: 'B', text: `It is 07${p1} ${p2}.` },
                        { speaker: 'A', text: `07${p1} ${p2}. Got it.` } 
                    ];
                    break;
                case 3: // Dates
                    const month = rand(['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']);
                    const day = randInt(10, 28);
                    const event = rand(EVENTS);
                    q.stem = `On what date will the ${event} take place?`;
                    q.answer = `${day}th ${month}`;
                    q.script = [
                        { speaker: 'A', text: `Shall we book the venue for the ${day - 5}th of ${month}?` },
                        { speaker: 'B', text: `I'm afraid it's fully booked then.` },
                        { speaker: 'B', text: `The only date available for the ${event} is the ${day}th of ${month}.` },
                        { speaker: 'A', text: `Okay, let's go with the ${day}th of ${month} then.` } 
                    ];
                    break;
                case 4: // Times
                    const hr = randInt(2, 10);
                    const min = rand([15, 30, 45, 10, 20, 40, 50]);
                    const dest = rand(TRAIN_DESTINATIONS);
                    q.stem = `What time does the train to ${dest} leave?`;
                    q.answer = `${hr}:${min}`;
                    q.script = [
                        { speaker: 'A', text: `Does the train to ${dest} leave at ${hr} o'clock?` },
                        { speaker: 'B', text: `No, that's the slow train.` },
                        { speaker: 'B', text: `The express departs at ${hr}:${min}.` },
                        { speaker: 'A', text: `Right, ${hr}:${min}. I'd better hurry.` } 
                    ];
                    break;
                case 5: // Schedules
                    const open = randInt(7, 9);
                    const close = randInt(4, 6);
                    const facility = rand(['library', 'gym', 'computer lab', 'cafeteria', 'health center', 'reception']);
                    q.stem = `When does the ${facility} close?`;
                    q.answer = `${close} pm`;
                    q.script = [
                        { speaker: 'A', text: `I need to use the ${facility} later.` },
                        { speaker: 'B', text: `Well, we open at ${open} am.` },
                        { speaker: 'A', text: `And how late do you stay open?` },
                        { speaker: 'B', text: `We usually close at ${close} pm.` },
                        { speaker: 'A', text: `${close} pm. Okay, thanks.` } 
                    ];
                    break;
                case 6: // Prices
                    const base = randInt(10, 50);
                    const discount = base - 5;
                    const item = rand(PRICE_ITEMS);
                    q.stem = `How much does the ${item} cost for students?`;
                    q.answer = `£${discount}`;
                    q.script = [
                        { speaker: 'A', text: `How much is the ${item}?` },
                        { speaker: 'B', text: `The standard price is £${base}.` },
                        { speaker: 'A', text: `I have a valid student card.` },
                        { speaker: 'B', text: `Ah, in that case, it's reduced to £${discount}.` },
                        { speaker: 'A', text: `Lovely, £${discount}. Here you go.` } 
                    ];
                    break;
                case 7: // Travel
                    const mins = rand([25, 35, 45, 55]);
                    const transport = rand(TRANSPORT);
                    const destPlace = rand(DESTINATIONS);
                    q.stem = `How long does it take to get to the ${destPlace} by ${transport}?`;
                    q.answer = `${mins} minutes`;
                    q.script = [
                        { speaker: 'A', text: `Is it far to the ${destPlace}?` },
                        { speaker: 'B', text: `If you walk, it's over an hour.` },
                        { speaker: 'A', text: `What about the ${transport}?` },
                        { speaker: 'B', text: `The ${transport} is quicker. It takes about ${mins} minutes.` },
                        { speaker: 'A', text: `Okay, ${mins} minutes isn't too bad.` } 
                    ];
                    break;
                case 8: // Addresses
                    const num = randInt(1, 99);
                    const street = rand(STREETS);
                    const type = rand(['Road', 'Street', 'Lane', 'Avenue', 'Drive', 'Close']);
                    q.stem = "What is the address?";
                    q.answer = `${num} ${street} ${type}`;
                    q.script = [
                        { speaker: 'A', text: `Where should I deliver the package?` },
                        { speaker: 'B', text: `To number ${num}, ${street} ${type}.` },
                        { speaker: 'A', text: `Did you say ${street} Court?` },
                        { speaker: 'B', text: `No, ${street} ${type}. Like the tree.` },
                        { speaker: 'A', text: `Number ${num}, ${street} ${type}. Noted.` } 
                    ];
                    break;
                case 9: // Emails
                    const name = rand(['info', 'admin', 'sales', 'help', 'jobs', 'events', 'media', 'staff']);
                    const domain = rand(['gym', 'school', 'shop', 'club', 'tech', 'arts', 'uni']);
                    const tld = rand(['com', 'net', 'org', 'uk', 'edu']);
                    q.stem = "Write down the email address.";
                    q.answer = `${name}@${domain}.${tld}`;
                    const spellName = name.toUpperCase().split('').join('-');
                    const spellDomain = domain.toUpperCase().split('').join('-');
                    q.script = [
                        { speaker: 'A', text: `Where should I send the documents?` },
                        { speaker: 'B', text: `Please email them to ${name} at ${domain} dot ${tld}.` },
                        { speaker: 'A', text: `Sorry, could you spell that?` },
                        { speaker: 'B', text: `Sure. It is ${spellName}, at symbol, ${spellDomain}, dot ${tld}.` },
                        { speaker: 'A', text: `${name}@${domain}.${tld}. I've sent it.` } 
                    ];
                    break;
                case 10: // Measurements
                    const val = rand([1.5, 2.4, 3.8, 5.2, 0.75, 10.5]);
                    const dimension = rand(['width', 'height', 'depth', 'length']);
                    const obj = rand(FURNITURE);
                    q.stem = `What is the ${dimension} of the ${obj}?`;
                    q.answer = `${val} meters`;
                    q.script = [
                        { speaker: 'A', text: `Will this ${obj} fit in my room?` },
                        { speaker: 'B', text: `It's quite large.` },
                        { speaker: 'B', text: `I don't have the full dimensions, but the ${dimension} is ${val} meters.` },
                        { speaker: 'A', text: `Okay, I'll note that down: ${val} meters ${dimension}.` } 
                    ];
                    break;
                case 11: // Quantities
                    const total = randInt(15, 100);
                    const present = total - randInt(2, 10);
                    const group = rand(['students', 'delegates', 'members', 'applicants', 'tourists']);
                    q.stem = `How many ${group} actually attended?`;
                    q.answer = `${present}`;
                    q.script = [
                        { speaker: 'A', text: `Did the event go well?` },
                        { speaker: 'B', text: `Yes, we had ${total} ${group} sign up initially.` },
                        { speaker: 'A', text: `That's a good turnout.` },
                        { speaker: 'B', text: `However, a few cancelled, so only ${present} actually attended.` },
                        { speaker: 'A', text: `Ah, ${present}. Still a decent number.` } 
                    ];
                    break;
                case 12: // Map Locations
                    const locations = ['Library', 'Cafe', 'Gym', 'Main Hall'];
                    const target = rand(locations);
                    const locs = locations.filter(l => l !== target);
                    const ref = locs[0];
                    let prep = "";
                    let desc = "";
                    if (Math.random() > 0.5) {
                        prep = "Next to";
                        desc = `It is immediately next to the ${ref}.`;
                    } else {
                        prep = "Opposite";
                        desc = `It is directly opposite the ${ref}, on the other side of the path.`;
                    }
                    q.stem = `Where is the ${target}?`;
                    q.answer = `${prep} ${ref}`;
                    q.isMap = true;
                    q.target = target;
                    q.ref = ref;
                    q.script = [
                        { speaker: 'A', text: `Excuse me, I'm looking for the ${target}.` },
                        { speaker: 'B', text: `Right. Do you see the ${ref}?` },
                        { speaker: 'A', text: `Yes, I see it.` },
                        { speaker: 'B', text: `${desc}` },
                        { speaker: 'A', text: `${prep} the ${ref}. Thanks!` } 
                    ];
                    break;
                case 13: // Options
                    const opts = ['A', 'B', 'C'];
                    const choice = rand(opts);
                    const subject = rand(['plan', 'route', 'package', 'design']);
                    q.stem = `Which ${subject} (A, B, or C) does the speaker choose?`;
                    q.answer = choice;
                    q.script = [
                        { speaker: 'A', text: `We have three ${subject}s available.` },
                        { speaker: 'A', text: `Option A is cheap but basic. Option B is premium but pricey.` },
                        { speaker: 'B', text: `What about Option C?` },
                        { speaker: 'A', text: `It's a good balance of both.` },
                        { speaker: 'B', text: `Okay, I'll go with Option ${choice} then.` },
                        { speaker: 'A', text: `Option ${choice}, excellent choice.` } 
                    ];
                    break;
                case 14: // Facts & Opinions
                    const topics = ['food', 'weather', 'hotel', 'lecture', 'concert', 'exhibition', 'service'];
                    const topic = rand(topics);
                    const isPositive = Math.random() > 0.5;
                    q.stem = `What is the speaker's opinion of the ${topic}? (Good/Bad)`;
                    q.answer = isPositive ? "Good" : "Bad";
                    let text = "";
                    if (isPositive) text = "I was worried at first, but actually, it exceeded my expectations. Very pleasant.";
                    else text = "I had high hopes, but honestly, it was a letdown. Quite disappointing.";
                    q.script = [
                        { speaker: 'A', text: `What did you think of the ${topic}?` },
                        { speaker: 'B', text: text },
                        { speaker: 'A', text: `So it was ${isPositive ? 'good' : 'bad'} then?` }, 
                        { speaker: 'B', text: `Yes, exactly.` }
                    ];
                    break;
                default: break;
            }
            return q;
        };

        const CATEGORIES = [
            { id: 1, name: "Names & Spelling", icon: <BookOpen className="w-5 h-5" /> },
            { id: 2, name: "Phone / ID", icon: <Phone className="w-5 h-5" /> },
            { id: 3, name: "Dates", icon: <Calendar className="w-5 h-5" /> },
            { id: 4, name: "Times", icon: <Clock className="w-5 h-5" /> },
            { id: 5, name: "Schedules", icon: <List className="w-5 h-5" /> },
            { id: 6, name: "Prices", icon: <DollarSign className="w-5 h-5" /> },
            { id: 7, name: "Travel Details", icon: <Navigation className="w-5 h-5" /> },
            { id: 8, name: "Addresses", icon: <MapIcon className="w-5 h-5" /> },
            { id: 9, name: "Emails", icon: <Mail className="w-5 h-5" /> },
            { id: 10, name: "Measurements", icon: <Ruler className="w-5 h-5" /> },
            { id: 11, name: "Quantities", icon: <Users className="w-5 h-5" /> },
            { id: 12, name: "Map Locations", icon: <MapIcon className="w-5 h-5" /> },
            { id: 13, name: "Options", icon: <Check className="w-5 h-5" /> },
            { id: 14, name: "Facts & Opinions", icon: <MessageCircle className="w-5 h-5" /> },
        ];

        const Confetti = () => {
            return (
                <div className="absolute inset-0 pointer-events-none overflow-hidden z-50">
                    {[...Array(20)].map((_, i) => (
                        <div
                            key={i}
                            className="absolute w-2 h-2 bg-yellow-400 rounded-full animate-confetti"
                            style={{
                                left: `${Math.random() * 100}%`,
                                top: `${Math.random() * 50}%`,
                                backgroundColor: ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1'][Math.floor(Math.random() * 4)],
                                animationDelay: `${Math.random() * 0.5}s`,
                                animationDuration: `${0.5 + Math.random()}s`
                            }}
                        />
                    ))}
                </div>
            );
        };

        const MapVisual = () => (
            <div className="bg-slate-100 border-2 border-slate-300 rounded-xl p-4 mb-4 relative h-64 w-full">
                <div className="absolute top-2 left-2 text-xs font-bold text-slate-400">NORTH ↑</div>
                <div className="grid grid-cols-2 gap-8 h-full">
                    <div className="bg-blue-100 border-2 border-blue-300 rounded flex items-center justify-center font-bold text-blue-800">Gym</div>
                    <div className="bg-red-100 border-2 border-red-300 rounded flex items-center justify-center font-bold text-red-800">Cafe</div>
                    <div className="bg-green-100 border-2 border-green-300 rounded flex items-center justify-center font-bold text-green-800">Library</div>
                    <div className="bg-purple-100 border-2 border-purple-300 rounded flex items-center justify-center font-bold text-purple-800">Main Hall</div>
                </div>
                <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                    <div className="bg-white px-2 py-1 rounded border border-slate-200 shadow-sm text-xs font-bold text-slate-500">Path</div>
                </div>
            </div>
        );

        const IELTSDetailDrills = () => {
            const [activeCat, setActiveCat] = useState(CATEGORIES[0]);
            const [question, setQuestion] = useState(null);
            const [input, setInput] = useState('');
            const [status, setStatus] = useState('idle'); 
            const [feedback, setFeedback] = useState('');
            const [praisePhrase, setPraisePhrase] = useState('');
            const [isPlaying, setIsPlaying] = useState(false);
            const [voices, setVoices] = useState([]);
            const [roundScore, setRoundScore] = useState(0);
            const [questionsLeft, setQuestionsLeft] = useState(TOTAL_QUESTIONS_PER_ROUND);
            const [showHint, setShowHint] = useState(false);
            const [speechRate, setSpeechRate] = useState(DEFAULT_SPEECH_RATE);
            const isCancelled = useRef(false);

            useEffect(() => {
                const initVoices = () => {
                    const vs = window.speechSynthesis.getVoices();
                    setVoices(vs);
                };
                initVoices();
                window.speechSynthesis.onvoiceschanged = initVoices;
            }, []);

            // --- STRICT VOICE SELECTION ---
            const getVoicePair = () => {
                const targets = ['Ava', 'Emma', 'Brian', 'Andrew'];
                
                const validVoices = voices.filter(v => 
                    v.name.includes('Microsoft') && 
                    targets.some(t => v.name.includes(t))
                );

                const females = validVoices.filter(v => v.name.includes('Ava') || v.name.includes('Emma'));
                const males = validVoices.filter(v => v.name.includes('Brian') || v.name.includes('Andrew'));

                let female = null;
                let male = null;

                if (females.length > 0) {
                    female = females[Math.floor(Math.random() * females.length)];
                } else {
                    female = voices.find(v => v.name.includes('Female')) || voices[0];
                }

                if (males.length > 0) {
                    male = males[Math.floor(Math.random() * males.length)];
                } else {
                    male = voices.find(v => v.name.includes('Male')) || voices[1] || voices[0];
                }

                return Math.random() > 0.5 ? { A: female, B: male } : { A: male, B: female };
            };

            const speakScript = async (script) => {
                isCancelled.current = false;
                setIsPlaying(true);
                window.speechSynthesis.cancel();
                
                const { A, B } = getVoicePair();
                
                if (!A && !B && voices.length === 0) {
                    alert("Voices still loading, please try again in a moment.");
                    return;
                }
                
                for (let line of script) {
                    if (isCancelled.current) break;
                    await new Promise(resolve => {
                        const utt = new SpeechSynthesisUtterance(line.text);
                        utt.voice = line.speaker === 'A' ? A : B;
                        utt.rate = speechRate;
                        utt.pitch = 1;
                        utt.lang = 'en-GB';
                        utt.onend = () => setTimeout(resolve, 500); 
                        utt.onerror = () => resolve();
                        window.speechSynthesis.speak(utt);
                    });
                }
                setIsPlaying(false);
            };

            const stopAudio = () => {
                isCancelled.current = true;
                window.speechSynthesis.cancel();
                setIsPlaying(false);
            };

            const newQuestion = () => {
                stopAudio();
                if (questionsLeft <= 0) {
                    setRoundScore(0);
                    setQuestionsLeft(TOTAL_QUESTIONS_PER_ROUND);
                }
                const q = generateQuestion(activeCat);
                setQuestion(q);
                setInput('');
                setStatus('idle');
                setFeedback('');
                setPraisePhrase('');
                setShowHint(false);
            };

            const switchCategory = (cat) => {
                stopAudio();
                setActiveCat(cat);
                setRoundScore(0);
                setQuestionsLeft(TOTAL_QUESTIONS_PER_ROUND);
                setShowHint(false);
            };

            const handleCheck = (e) => {
                e.preventDefault();
                stopAudio();
                const isCorrect = checkAnswer(input, question.answer, question.type === 6 ? 'price' : (question.type === 4 ? 'time' : 'text'));
                
                if (isCorrect) {
                    setStatus('correct');
                    setRoundScore(prev => prev + 1);
                    playSoundFx('correct');
                    setPraisePhrase(PRAISES[Math.floor(Math.random() * PRAISES.length)]);
                    setFeedback('Correct!');
                } else {
                    setStatus('incorrect');
                    playSoundFx('incorrect');
                    setFeedback(`Incorrect. Answer: ${question.answer}`);
                }
                setQuestionsLeft(prev => Math.max(0, prev - 1));
            };

            const toggleHint = () => {
                setShowHint(true);
                playSoundFx('hint');
            };

            const toggleSpeed = () => {
                setSpeechRate(prev => prev === DEFAULT_SPEECH_RATE ? 1.0 : DEFAULT_SPEECH_RATE);
            };

            useEffect(() => {
                newQuestion();
            }, [activeCat]);

            useEffect(() => () => stopAudio(), []);

            // Progress bar calc
            const progress = ((TOTAL_QUESTIONS_PER_ROUND - questionsLeft) / TOTAL_QUESTIONS_PER_ROUND) * 100;

            return (
                <div className="flex flex-col md:flex-row h-full w-full">
                    {/* SIDEBAR */}
                    <div className="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 md:h-full h-auto max-h-[30vh] md:max-h-full overflow-y-auto z-20 shadow-lg md:shadow-none">
                        <div className="p-2 space-y-1">
                            {CATEGORIES.map(cat => (
                                <button
                                    key={cat.id}
                                    onClick={() => switchCategory(cat)}
                                    className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-bold transition-all ${activeCat.id === cat.id ? 'bg-blue-50 text-blue-700 border border-blue-200 shadow-sm' : 'text-slate-600 hover:bg-slate-50 border border-transparent'}`}
                                >
                                    {cat.icon}
                                    {cat.name}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* MAIN AREA */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50">
                        {/* PROGRESS BAR */}
                        <div className="h-2 w-full bg-slate-200 shrink-0">
                            <div 
                                className="h-full bg-blue-500 transition-all duration-500 ease-out"
                                style={{ width: `${progress}%` }}
                            ></div>
                        </div>

                        {/* HEADER */}
                        <header className="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-sm z-10 shrink-0">
                            <div className="flex items-center gap-2">
                                <div className="p-2 bg-blue-100 text-blue-600 rounded-lg">{activeCat.icon}</div>
                                <div>
                                    <h2 className="font-bold text-lg leading-none">{activeCat.name}</h2>
                                    <p className="text-xs text-slate-400 font-medium mt-1">Practice Mode</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                {/* SPEED TOGGLE */}
                                <button
                                    onClick={toggleSpeed}
                                    className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border text-xs font-bold transition-colors ${speechRate === 1.0 ? 'bg-purple-100 border-purple-200 text-purple-700' : 'bg-slate-100 border-slate-200 text-slate-500 hover:bg-slate-200'}`}
                                    title={speechRate === 1.0 ? "Exam Speed (1.0x)" : "Drill Speed (0.85x)"}
                                >
                                    <Zap className={`w-3 h-3 ${speechRate === 1.0 ? 'fill-current' : ''}`} />
                                    {speechRate === 1.0 ? 'Exam (1.0x)' : 'Drill (0.85x)'}
                                </button>

                                <div className="flex items-center gap-2 bg-green-50 border border-green-200 px-3 py-1.5 rounded-lg">
                                    <Trophy className="w-4 h-4 text-green-600" />
                                    <div className="flex flex-col leading-none">
                                        <span className="text-[10px] font-bold text-green-600 uppercase">Correct</span>
                                        <span className="text-lg font-black text-green-800">{roundScore}</span>
                                    </div>
                                </div>
                            </div>
                        </header>

                        {/* WORKSPACE */}
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 max-w-3xl mx-auto w-full pb-32">
                            {question ? (
                                <div className="space-y-6 animate-in">
                                    <div className="bg-white rounded-2xl shadow-sm border-2 border-slate-200 p-6 md:p-8 relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-2 h-full bg-blue-500"></div>
                                        {status === 'correct' && <Confetti />}
                                        <div className="flex justify-between items-start mb-6">
                                            <span className="inline-block px-3 py-1 rounded-full bg-slate-100 text-slate-500 text-xs font-black uppercase tracking-wider border border-slate-200">
                                                Question Stem
                                            </span>
                                            <button 
                                                onClick={newQuestion}
                                                className="md:hidden flex items-center gap-2 text-slate-400 hover:text-slate-600"
                                            >
                                                <RefreshCw className="w-4 h-4" />
                                            </button>
                                        </div>

                                        <h3 className="text-2xl font-black text-slate-800 mb-6">
                                            "{question.stem}"
                                        </h3>
                                        {question.type === 12 && <MapVisual />}
                                        
                                        <div className="flex flex-wrap items-center gap-4 mb-8">
                                            {!isPlaying ? (
                                                <button 
                                                    onClick={() => speakScript(question.script)}
                                                    className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white pl-5 pr-6 py-3 rounded-full font-bold text-lg shadow-[0_4px_0_rgb(29,78,216)] active:shadow-none active:translate-y-1 transition-all w-full md:w-auto justify-center"
                                                >
                                                    <Play className="fill-current w-5 h-5" /> Listen
                                                </button>
                                            ) : (
                                                <button 
                                                    onClick={stopAudio}
                                                    className="flex items-center gap-2 bg-red-500 hover:bg-red-400 text-white pl-5 pr-6 py-3 rounded-full font-bold text-lg shadow-[0_4px_0_rgb(185,28,28)] active:shadow-none active:translate-y-1 transition-all w-full md:w-auto justify-center"
                                                >
                                                    <Square className="fill-current w-5 h-5" /> Stop
                                                </button>
                                            )}
                                        </div>

                                        <form onSubmit={handleCheck} className="relative">
                                            <input 
                                                type="text" 
                                                value={input}
                                                onChange={(e) => setInput(e.target.value)}
                                                placeholder={showHint ? generateHint(question.answer) : "Type your answer..."}
                                                disabled={status === 'correct' || status === 'incorrect'}
                                                className={`w-full bg-slate-50 border-2 rounded-xl px-5 py-4 text-xl font-bold outline-none transition-all ${status === 'correct' ? 'border-green-500 text-green-700 bg-green-50' : status === 'incorrect' ? 'border-red-500 text-red-700 bg-red-50' : 'border-slate-300 focus:border-blue-500 focus:bg-white'}`}
                                            />
                                            <button 
                                                type="submit"
                                                disabled={!input || status !== 'idle'}
                                                className="absolute right-2 top-2 bottom-2 bg-slate-800 disabled:opacity-20 disabled:cursor-not-allowed hover:bg-slate-700 text-white px-6 rounded-lg font-bold transition-all"
                                            >
                                                Check
                                            </button>
                                        </form>
                                        
                                        {/* HINT BUTTON */}
                                        {status === 'idle' && !showHint && (
                                            <div className="mt-2 flex justify-end">
                                                <button 
                                                    onClick={toggleHint}
                                                    className="text-xs font-bold text-slate-400 hover:text-blue-500 flex items-center gap-1 transition-colors"
                                                >
                                                    <HelpCircle className="w-3 h-3" /> Need a hint?
                                                </button>
                                            </div>
                                        )}

                                        {status !== 'idle' && (
                                            <div className={`mt-6 p-4 rounded-xl border-2 flex items-start gap-3 animate-in ${status === 'correct' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                                                {status === 'correct' ? <div className="bg-green-200 p-2 rounded-full"><Sparkles className="w-6 h-6 shrink-0 text-green-700" /></div> : <X className="w-6 h-6 shrink-0 mt-1" />}
                                                <div className="flex-1">
                                                    <p className="font-black text-xl flex items-center gap-2">
                                                        {status === 'correct' ? praisePhrase : 'Incorrect'}
                                                    </p>
                                                    <p className="text-sm opacity-90 mt-1 font-medium">
                                                        {status === 'correct' ? 'Great job! Moving to transcript...' : `The correct answer was: ${question.answer}`}
                                                    </p>
                                                    {questionsLeft > 0 && (
                                                        <button 
                                                            onClick={newQuestion}
                                                            className={`mt-3 text-sm font-bold px-4 py-2 rounded-lg flex items-center gap-2 transition-colors ${status === 'correct' ? 'bg-green-200 hover:bg-green-300 text-green-900' : 'bg-red-200 hover:bg-red-300 text-red-900'}`}
                                                        >
                                                            Next Question <RefreshCw className="w-3 h-3" />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {(status === 'correct' || status === 'incorrect') && (
                                        <div className="bg-slate-100 rounded-2xl border-2 border-slate-200 p-6 md:p-8 animate-in">
                                            <div className="flex items-center gap-2 mb-4 text-slate-400">
                                                <MessageCircle className="w-4 h-4" />
                                                <span className="text-xs font-black uppercase tracking-widest">Transcript</span>
                                            </div>
                                            <div className="space-y-4">
                                                {question.script.map((line, idx) => (
                                                    <div key={idx} className="flex gap-4">
                                                        <div className={`w-8 h-8 shrink-0 rounded-full flex items-center justify-center font-bold text-sm ${line.speaker === 'A' ? 'bg-white border-2 border-slate-200 text-slate-600' : 'bg-slate-800 text-white'}`}>
                                                            {line.speaker}
                                                        </div>
                                                        <div className="bg-white p-3 rounded-lg rounded-tl-none border border-slate-200 shadow-sm">
                                                            <p className="text-slate-700 font-medium leading-relaxed">
                                                                {line.text}
                                                            </p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full py-12 text-center animate-in">
                                    <div className="bg-yellow-100 p-6 rounded-full mb-6">
                                        <Trophy className="w-16 h-16 text-yellow-600" />
                                    </div>
                                    <h2 className="text-3xl font-black text-slate-800 mb-2">Round Complete!</h2>
                                    <p className="text-slate-500 font-medium mb-8">You scored {roundScore} out of {TOTAL_QUESTIONS_PER_ROUND}</p>
                                    <button 
                                        onClick={() => { setRoundScore(0); setQuestionsLeft(TOTAL_QUESTIONS_PER_ROUND); newQuestion(); }}
                                        className="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-blue-500 shadow-xl transition-all"
                                    >
                                        Start New Round
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<IELTSDetailDrills />);
    </script>
</body>
</html>
