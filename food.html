<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatic Food Emoji Championship</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", 'Arial', sans-serif;
            background: #1a1a1a;
            color: #ffde7d;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Food Background */
        .food-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.4;
            background: linear-gradient(135deg, #ff8c00, #ff4500, #d2691e);
        }

        .food-bubble {
            position: absolute;
            bottom: -50px;
            font-size: 24px;
            animation: foodFloat linear infinite;
            opacity: 0.7;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        @keyframes foodFloat {
            0% { transform: translateY(50px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.7; }
            90% { opacity: 0.7; }
            100% { transform: translateY(-105vh) rotate(360deg); opacity: 0; }
        }

        /* Game Container */
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            position: relative;
            z-index: 10;
        }

        /* Game Modes */
        .game-modes {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            margin: 5rem 0;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 1.2rem 2.5rem;
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ffde7d, #ffb703);
            color: #000;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 222, 125, 0.5);
        }

        .mode-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 222, 125, 0.8);
        }
        
        /* Learning Mode */
        .learning-mode {
            display: none;
            text-align: center;
            background: rgba(255, 183, 3, 0.1);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid #ffde7d;
        }

        .learning-card {
            background: rgba(0,0,0,0.8);
            border-radius: 20px;
            padding: 1rem 2rem 2rem;
            margin: 1rem auto;
            max-width: 450px;
            border: 2px solid #ffde7d;
            box-shadow: 0 0 30px rgba(255, 222, 125, 0.3);
        }

        .learning-emoji {
            font-size: 6rem;
            margin-bottom: 1rem;
            animation: emojiPulse 2s ease-in-out infinite;
        }

        @keyframes emojiPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .learning-text {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px #ffde7d;
        }

        .learning-progress {
            width: 100%;
            height: 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .learning-progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #ffde7d, #ffb703);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        /* Game Play */
        .game-play { 
            display: none; 
            position: relative;
        }

        .game-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #ffde7d;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .round-info, .score-display { font-size: 1.3rem; font-weight: bold; text-shadow: 0 0 10px #ffde7d; }
        
        .player-area {
            background: rgba(0,0,0,0.8);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid #ffde7d;
            text-align: center;
            position: relative;
        }
        
        .question-text {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 15px #ffde7d;
            margin-bottom: 2rem;
            min-height: 80px;
        }

        .question-emoji {
            font-size: 6rem;
            margin-bottom: 1rem;
            animation: emojiPulse 2s ease-in-out infinite;
        }

        .emoji-buttons { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 1rem; 
        }

        .emoji-btn {
            padding: 1.5rem;
            font-size: 4rem;
            background: linear-gradient(45deg, rgba(255, 183, 3, 0.3), rgba(251, 133, 0, 0.3));
            color: #ffde7d; border: 2px solid #ffde7d; border-radius: 15px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .emoji-btn:hover { background: linear-gradient(45deg, rgba(255, 183, 3, 0.6), rgba(251, 133, 0, 0.6)); transform: scale(1.05); }
        .emoji-btn.correct { background: linear-gradient(45deg, #ffde7d, #ffb703); color: #000; animation: correctPulse 0.5s ease; }
        .emoji-btn.incorrect { background: linear-gradient(45deg, #ff0040, #ff4060); color: #fff; animation: incorrectShake 0.5s ease; }
        @keyframes correctPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        @keyframes incorrectShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

        .praise-word, .point-badge {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 1.8rem; font-weight: bold;
            z-index: 100; pointer-events: none; animation: praise-animation 2.5s ease-out forwards;
            line-height: 1.4;
            width: 100%;
            text-align: center;
        }
        .point-badge { font-size: 2rem; color: #ffb703; text-shadow: 0 0 10px #ff8c00; top: 15%; }
        @keyframes praise-animation { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -200%) scale(1.2); opacity: 0; } }

        .encouragement-phrase {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 1.5rem; font-weight: bold;
            z-index: 100; pointer-events: none; animation: encouragement-animation 2s ease-out forwards;
            color: #ffb703; text-shadow: 0 0 10px #ff8c00; text-align: center; width: 80%;
        }
        @keyframes encouragement-animation {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
            80% { transform: translate(-50%, -100%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -120%) scale(1); opacity: 0; }
        }

        /* Timer */
        .timer-container { margin-top: 1rem; text-align: center; }
        .timer-display { font-size: 2.5rem; font-weight: bold; color: #ffb703; text-shadow: 0 0 20px #ffb703; margin-bottom: 0.5rem; }
        .timer-bar { width: 100%; height: 15px; background: rgba(0,0,0,0.5); border-radius: 10px; overflow: hidden; border: 2px solid #ffde7d; }
        .timer-progress { height: 100%; background: linear-gradient(45deg, #ffb703, #ff8c00); transition: width 0.1s linear; border-radius: 10px; }

        /* Fireworks */
        .fireworks-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
        .firework { position: absolute; width: 6px; height: 6px; border-radius: 50%; animation: fireworkExplode 2s ease-out forwards; }
        @keyframes fireworkExplode { 0% { transform: scale(0); opacity: 1; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }

        /* Certificate */
        .certificate {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #000; padding: 3rem; border-radius: 20px; text-align: center;
            border: 5px solid #ff8c00; box-shadow: 0 0 50px rgba(255,215,0,0.8);
            z-index: 2000; max-width: 600px;
        }

        .player-area.correct-answer-glow {
            animation: glow 1.5s ease-out;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px #ffde7d, 0 0 10px #ffb703; }
            50% { box-shadow: 0 0 20px #ffde7d, 0 0 40px #ffb703, 0 0 60px #ff8c00; }
            100% { box-shadow: 0 0 5px #ffde7d, 0 0 10px #ffb703; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .mode-btn { padding: 1rem 2rem; font-size: 1.2rem; }
            .question-text { font-size: 1.5rem; }
            .emoji-btn { font-size: 3rem; padding: 1rem; }
        }

        /* Phase Transition */
        .phase-transition {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: rgba(0,0,0,0.9);
            color: #ffde7d; padding: 3rem; border-radius: 20px; text-align: center;
            border: 3px solid #ffde7d; box-shadow: 0 0 50px rgba(255, 222, 125, 0.8);
            z-index: 1500; font-size: 2rem; font-weight: bold; text-shadow: 0 0 20px #ffde7d;
        }
        
        /* Sparkle Effect */
        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: yellow;
            border-radius: 50%;
            pointer-events: none;
            z-index: 200;
            opacity: 0;
            animation: sparkle-animation 1s ease-out forwards;
            box-shadow: 0 0 10px yellow, 0 0 20px gold;
        }
        @keyframes sparkle-animation {
            0% { transform: translate(0, 0) scale(0.5); opacity: 1; }
            100% { transform: translate(var(--x), var(--y)) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Backgrounds and Effects -->
    <div class="food-bg" id="foodBg"></div>
    <div class="fireworks-container" id="fireworksContainer"></div>
    <div class="phase-transition" id="phaseTransition"><div id="transitionText"></div></div>

    <div class="game-container">
        <!-- Grade Selection (Start Screen) -->
        <div class="game-modes" id="gameModes">
            <button class="mode-btn" onclick="startGame()">Start Championship</button>
        </div>

        <!-- All other game sections are hidden by default -->
        <div id="game-content" style="display: none;">
            <!-- Learning Mode -->
            <div class="learning-mode" id="learningMode">
                <div class="learning-card">
                    <div class="learning-emoji" id="learningEmoji"></div>
                    <div class="learning-text" id="learningText"></div>
                </div>
                <div class="learning-progress"><div class="learning-progress-bar" id="learningProgressBar" style="width: 0%"></div></div>
                <p style="margin-top: 1rem; font-size: 1rem;">Progress: <span id="learningCounter">0</span> / <span id="totalLearningItems">0</span></p>
            </div>

            <!-- Game Play -->
            <div class="game-play" id="gamePlay">
                <div class="player-area">
                    <div class="question-emoji" id="questionEmoji"></div>
                    <div class="question-text" id="questionText"></div>
                    <div class="emoji-buttons" id="emojiButtons"></div>
                </div>
                <div class="game-status">
                    <div class="score-display">Score: <span id="score">0</span></div>
                    <div class="round-info" id="roundInfo"></div>
                </div>
                <div class="timer-container">
                    <div class="timer-display" id="timerDisplay">7</div>
                    <div class="timer-bar"><div class="timer-progress" id="timerProgress"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Certificate -->
    <div class="certificate" id="certificate">
        <h2>üèÜ FOOD CHAMPIONSHIP COMPLETE üèÜ</h2>
        <div class="certificate-content">
            <p>Congratulations!</p>
            <p>You have successfully completed the Food Emoji Championship!</p>
            <div class="final-score" id="certificateScore"></div>
        </div>
        <div class="certificate-date" id="certificateDate"></div>
        <button class="mode-btn" onclick="resetGame()" style="margin-top: 2rem;">üîÑ Play Again</button>
    </div>

    <script>
        // Game Data
        const mealSets = [
            { name: "üçΩ Monday Menu", items: [
                { emoji: "ü•û", name: "Buttermilk Pancakes with Maple Syrup" }, { emoji: "üçì", name: "Fresh Strawberry Bowl" }, { emoji: "‚òï", name: "Brewed Black Coffee" }, { emoji: "üçî", name: "Cheeseburger with Lettuce & Tomato" }, { emoji: "üç£", name: "Salmon Nigiri" }, { emoji: "üêü", name: "Pan-Seared Fish with Herbs" }, { emoji: "üç¶", name: "Vanilla Ice Cream Cone" }, { emoji: "üç´", name: "Dark Chocolate Bar" }
            ]},
            { name: "üçΩ Tuesday Menu", items: [
                { emoji: "üßá", name: "Belgian Waffles with Whipped Cream" }, { emoji: "üçå", name: "Banana Slices with Honey" }, { emoji: "ü•õ", name: "Cold Glass of Milk" }, { emoji: "üçï", name: "Pepperoni Pizza Slice" }, { emoji: "üê†", name: "Grilled Whitefish Fillet" }, { emoji: "üçù", name: "Spaghetti Bolognese" }, { emoji: "üçß", name: "Shaved Ice with Syrup" }, { emoji: "üç¨", name: "Assorted Candies" }
            ]},
            { name: "üçΩ Wednesday Menu", items: [
                { emoji: "üç≥", name: "Classic Fried Eggs" }, { emoji: "üçá", name: "Chilled Grape Cup" }, { emoji: "üßÉ", name: "Mixed Fruit Juice" }, { emoji: "ü•™", name: "Turkey & Cheese Sandwich" }, { emoji: "ü¶ë", name: "Stir-Fried Squid" }, { emoji: "üçõ", name: "Chicken Curry with Rice" }, { emoji: "üç®", name: "Chocolate Sundae" }, { emoji: "üç≠", name: "Rainbow Lollipop" }
            ]},
            { name: "üçΩ Thursday Menu", items: [
                { emoji: "ü•ì", name: "Crispy Bacon Strips" }, { emoji: "üçé", name: "Apple Segments" }, { emoji: "üçµ", name: "Green Tea" }, { emoji: "ü•ó", name: "Garden Salad with Vinaigrette" }, { emoji: "ü¶ê", name: "Garlic Butter Shrimp" }, { emoji: "üçó", name: "Roasted Chicken Drumstick" }, { emoji: "üç©", name: "Glazed Donut" }, { emoji: "üçÆ", name: "Caramel Flan" }
            ]},
            { name: "üçΩ Friday Menu", items: [
                { emoji: "ü•ê", name: "Buttered French Croissant" }, { emoji: "üçâ", name: "Watermelon Wedges" }, { emoji: "üßã", name: "Brown Sugar Bubble Tea" }, { emoji: "üåÆ", name: "Beef Tacos with Salsa" }, { emoji: "ü¶™", name: "Fresh Oysters on Ice" }, { emoji: "ü•©", name: "Grilled Ribeye Steak" }, { emoji: "üç™", name: "Chocolate Chip Cookies" }, { emoji: "üçØ", name: "Honey Drizzle" }
            ]},
            { name: "üçΩ Saturday Menu", items: [
                { emoji: "ü•ñ", name: "Rustic Baguette with Jam" }, { emoji: "üçä", name: "Orange Segments" }, { emoji: "üçπ", name: "Morning Citrus Cooler" }, { emoji: "üçü", name: "Golden French Fries" }, { emoji: "ü¶û", name: "Lobster Tail with Lemon Butter" }, { emoji: "ü•ü", name: "Pork Dumplings" }, { emoji: "üéÇ", name: "Birthday Cake Slice" }, { emoji: "ü•ú", name: "Roasted Peanuts" }
            ]},
            { name: "üçΩ Sunday Menu", items: [
                { emoji: "ü•£", name: "Oatmeal with Berries" }, { emoji: "üçç", name: "Pineapple Chunks" }, { emoji: "üç∑", name: "Mocktail" }, { emoji: "ü•®", name: "Salted Soft Pretzel" }, { emoji: "ü•ô", name: "Falafel Pita Wrap" }, { emoji: "ü•†", name: "Fortune Cookie" }, { emoji: "üç∞", name: "Strawberry Shortcake" }, { emoji: "ü´ò", name: "Baked Beans" }
            ]}
        ];
        
        const praisePhrases = [
            "The cake is golden-brown on top.", "Her salad looks vibrant with red tomatoes and green cucumbers.", "The soup smells aromatic with fresh herbs.", "The cheese is pungent, but tasty.", "This lemonade is tangy and sweet.", "The curry is rich with spices.", "Dark chocolate tastes bitter but smooth.", "The chips are crunchy and salty.", "The ice cream is creamy and cold.", "The bread is flaky and soft inside.", "The soda is fizzy and fun.", "The tea feels soothing on my throat.", "The apple juice is crisp and fresh."
        ];

        const incorrectPhrases = ["Great attempt! Let's try another.", "Not this time, but you're getting warmer!", "Every try is a step forward. Keep going!", "Mistakes are proof that you are trying. Don't stop!", "That's not the answer, but I believe in you!", "So close! What's your next idea?", "Don't worry, the best discoveries come after a few tries.", "That's a learning opportunity! Try again.", "Your persistence is inspiring. Let's go again.", "Even experts get it wrong sometimes. You've got this!"];
        
        // Game State
        let gameState;
        function resetGameState() {
            gameState = {
                phase: 'menu', 
                currentSet: 0, 
                learningIndex: 0,
                questionIndex: 0,
                score: 0,
                roundTimer: null, 
                currentAnswer: null,
                currentQuestion: null, 
                askedQuestionsThisSet: [],
                allEmojis: []
            };
        }
        resetGameState();

        // --- Sound Engine ---
        let preferredVoices = [];
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            if (voices.length === 0) return;

            const requestedVoiceNames = ['Ava', 'Brian', 'Andrew', 'Emma'];
            const foundVoices = [];

            requestedVoiceNames.forEach(name => {
                const match = voices.find(v =>
                    v.name.toLowerCase().includes(name.toLowerCase()) &&
                    v.name.toLowerCase().includes('natural') &&
                    v.lang.toLowerCase().startsWith('en')
                );
                if (match) foundVoices.push(match);
            });

            if (foundVoices.length < requestedVoiceNames.length) {
                requestedVoiceNames.forEach(name => {
                    if (!foundVoices.some(v => v.name.toLowerCase().includes(name.toLowerCase()))) {
                        const fallback = voices.find(v =>
                            v.name.toLowerCase().includes(name.toLowerCase()) &&
                            v.lang.toLowerCase().startsWith('en')
                        );
                        if (fallback) foundVoices.push(fallback);
                    }
                });
            }

            preferredVoices = foundVoices;

            if (preferredVoices.length === 0) {
                preferredVoices.push(
                    voices.find(v => v.lang.startsWith('en-US')) ||
                    voices.find(v => v.lang.startsWith('en-'))
                );
            }
        }
        
        speechSynthesis.onvoiceschanged = loadVoices;

        function playAudio(text, voiceIndex = 0, lang = 'en-US') {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                if (preferredVoices.length > 0 && preferredVoices[voiceIndex % preferredVoices.length]) {
                    utterance.voice = preferredVoices[voiceIndex % preferredVoices.length];
                }
                utterance.lang = lang;
                utterance.rate = 0.85; 
                speechSynthesis.speak(utterance);
            }
        }
        const correctSounds=[{seq:[{freq:880,dur:.3}]},{seq:[{freq:660,dur:.2},{freq:880,dur:.2}]},{seq:[{freq:500,dur:.3},{freq:1500,dur:.1}]},{seq:[{freq:784,dur:.4}]},{seq:[{freq:880,type:"square",dur:.15},{freq:1320,type:"square",dur:.15}]},{seq:[{freq:1200,type:"sawtooth",dur:.15},{freq:1800,type:"sawtooth",dur:.15}]},{seq:[{freq:660,dur:.15},{freq:880,dur:.15},{freq:990,dur:.15}]},{seq:[{freq:1e3,type:"square",dur:.05}]},{seq:[{freq:1200,dur:.1},{freq:2e3,dur:.1}]},{seq:[{freq:660,dur:.15},{freq:880,dur:.15},{freq:1320,dur:.15}]},{seq:[{freq:523,dur:.1},{freq:659,dur:.1},{freq:784,dur:.1},{freq:1046,dur:.1}]},{seq:[{freq:988,dur:.05,gap:.05},{freq:1046,dur:.05,gap:.05},{freq:988,dur:.05,gap:.05},{freq:1046,dur:.05}]},{seq:[{freq:784,dur:.15},{freq:1046,dur:.25}]},{seq:[{freq:600,type:"triangle",dur:.1},{freq:1200,type:"triangle",dur:.1,gap:.1}]},{seq:[{freq:900,type:"sawtooth",vol:.3,dur:.2}]},{seq:[{freq:2e3,dur:.05},{freq:2500,dur:.05,gap:.1},{freq:3e3,dur:.05}]},{seq:[{freq:440,dur:.1},{freq:550,dur:.1},{freq:660,dur:.1}]},{seq:[{freq:1500,dur:.4,vol:.4},{freq:1510,dur:.4,vol:.4,gap:-.4}]},{seq:[{freq:330,type:"square",dur:.1},{freq:440,type:"square",dur:.1},{freq:660,type:"square",dur:.2}]},{seq:[{freq:1046,dur:.5}]}];
        const incorrectSounds=[{seq:[{freq:200,type:"square",dur:.5}]},{seq:[{freq:200,type:"square",dur:.2},{freq:200,type:"square",dur:.2}]},{seq:[{freq:600,dur:.2},{freq:200,dur:.3}]},{seq:[{freq:150,dur:.4}]},{seq:[{freq:400,type:"sawtooth",dur:.3}]},{seq:[{freq:1e3,type:"square",dur:.05},{freq:300,type:"square",dur:.05}]},{seq:[{freq:400,dur:.2},{freq:300,dur:.2},{freq:200,dur:.3}]},{seq:[{freq:100,type:"square",dur:.05}]},{seq:[{freq:500,dur:.2},{freq:500,dur:.2}]},{seq:[{freq:800,dur:.2},{freq:100,dur:.3}]},{seq:[{freq:300,dur:.4},{freq:290,dur:.4,gap:-.4}]},{seq:[{freq:500,type:"sawtooth",dur:.05},{freq:400,type:"sawtooth",dur:.05},{freq:300,type:"sawtooth",dur:.05},{freq:200,type:"sawtooth",dur:.2}]},{seq:[{freq:220,dur:.5},{freq:225,dur:.5,gap:-.5}]},{seq:[{freq:100,type:"triangle",dur:.2,vol:.8}]},{seq:[{freq:1800,type:"sawtooth",dur:.05},{freq:1900,type:"sawtooth",dur:.05,gap:-.05},{freq:1700,type:"sawtooth",dur:.05,gap:-.05}]},{seq:[{freq:330,dur:.2},{freq:220,dur:.2},{freq:110,dur:.3}]},{seq:[{freq:800,type:"square",dur:.1},{freq:810,type:"square",dur:.1,gap:-.1}]},{seq:[{freq:155,type:"sawtooth",dur:.4}]},{seq:[{freq:523,dur:.1},{freq:392,dur:.1},{freq:261,dur:.2}]},{seq:[{freq:900,type:"square",dur:.02,gap:.02},{freq:900,type:"square",dur:.02,gap:.02},{freq:900,type:"square",dur:.02}]}];
        function playSound(type){let e;if("correct"===type)e=correctSounds;else if("incorrect"===type)e=incorrectSounds;else return;let t=e[Math.floor(Math.random()*e.length)],o=audioContext.currentTime;t.seq.forEach(e=>{e.gap&&e.gap>0&&(o+=e.gap);let t=audioContext.createOscillator(),n=audioContext.createGain();t.connect(n),n.connect(audioContext.destination),t.frequency.setValueAtTime(e.freq,o),t.type=e.type||"sine",n.gain.setValueAtTime(e.vol||.5,o),n.gain.exponentialRampToValueAtTime(.001,o+e.dur),t.start(o),t.stop(o+e.dur),e.gap&&e.gap>=0||(o+=e.dur)})}
        
        function switchScreen(activeScreen) {
            ['learningMode', 'gamePlay'].forEach(screenId => {
                document.getElementById(screenId).style.display = (screenId === activeScreen) ? 'block' : 'none';
            });
        }
        
        function startGame() {
            gameState.allEmojis = mealSets.flatMap(set => set.items.map(item => item.emoji));

            document.getElementById('gameModes').style.display = 'none';
            document.getElementById('game-content').style.display = 'block';
            startLearningPhase();
        }

        function startLearningPhase() {
            gameState.phase = 'learning';
            gameState.learningIndex = 0;
            
            switchScreen('learningMode');
            const set = mealSets[gameState.currentSet];
            document.getElementById('totalLearningItems').textContent = set.items.length;
            showLearningCard();
        }

        function showLearningCard() {
            const set = mealSets[gameState.currentSet];
            const item = set.items[gameState.learningIndex];
            document.getElementById('learningEmoji').textContent = item.emoji;
            document.getElementById('learningText').textContent = item.name;
            document.getElementById('learningCounter').textContent = gameState.learningIndex + 1;
            document.getElementById('learningProgressBar').style.width = `${((gameState.learningIndex + 1) / set.items.length) * 100}%`;
            
            setTimeout(() => playAudio(item.name, gameState.currentSet, 'en-US'), 500);
            
            const words = item.name.split(/\s+/).length;
            const baseTime = 2500;
            const extraPerWord = 400;
            const displayTime = baseTime + (words * extraPerWord);

            setTimeout(() => {
                gameState.learningIndex++;
                if (gameState.learningIndex < set.items.length) {
                    showLearningCard();
                } else {
                    showPhaseTransition(`üß† Now, Guess the Emoji!`, 2000);
                    setTimeout(startReverseMode, 2000);
                }
            }, displayTime);
        }

        function startReverseMode() {
            gameState.phase = 'playing';
            gameState.questionIndex = 0;
            gameState.askedQuestionsThisSet = [];
            switchScreen('gamePlay');
            playNextReverseCard();
        }

        function playNextReverseCard() {
            const currentSetItems = mealSets[gameState.currentSet].items;
            if (gameState.askedQuestionsThisSet.length >= currentSetItems.length) {
                // Move to the next set
                gameState.currentSet++;
                if (gameState.currentSet >= mealSets.length) {
                    endGame();
                    return;
                } else {
                    // Start learning for the new set
                    showPhaseTransition(`Next up: ${mealSets[gameState.currentSet].name}`, 2000);
                    setTimeout(startLearningPhase, 2000);
                    return;
                }
            }

            updateGameStatus();
            setupReverseQuestion();
            startRoundTimer();
        }

        function updateGameStatus() {
            document.getElementById('score').textContent = gameState.score;
            const roundInfo = document.getElementById('roundInfo');
            const set = mealSets[gameState.currentSet];
            roundInfo.textContent = `${set.name} | Question: ${gameState.askedQuestionsThisSet.length + 1}/${set.items.length}`;
        }
        
        function setupReverseQuestion() {
            const currentSetItems = mealSets[gameState.currentSet].items;
            let availableItems = currentSetItems.filter(item => !gameState.askedQuestionsThisSet.includes(item.name));
            
            gameState.currentQuestion = availableItems[Math.floor(Math.random() * availableItems.length)];
            const correctAnswer = gameState.currentQuestion;

            document.getElementById('questionEmoji').textContent = correctAnswer.emoji;
            document.getElementById('questionText').textContent = correctAnswer.name;
            
            const buttonsContainer = document.getElementById('emojiButtons');
            buttonsContainer.innerHTML = '';

            let answerOptions = [correctAnswer.emoji];
            let incorrectEmojis = [...gameState.allEmojis].filter(e => e !== correctAnswer.emoji);
            
            while(answerOptions.length < 4 && incorrectEmojis.length > 0) {
                const randomIndex = Math.floor(Math.random() * incorrectEmojis.length);
                const randomEmoji = incorrectEmojis.splice(randomIndex, 1)[0];
                if (!answerOptions.includes(randomEmoji)) {
                    answerOptions.push(randomEmoji);
                }
            }

            answerOptions.sort(() => .5 - Math.random());

            answerOptions.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.onclick = () => selectEmojiAnswer(emoji, btn);
                buttonsContainer.appendChild(btn);
            });
            
            gameState.currentAnswer = null;
        }

        function showPraise() {
            const phrase = praisePhrases[Math.floor(Math.random() * praisePhrases.length)];
            const el = document.createElement('div');
            el.className = 'praise-word';
            el.textContent = "Excellent!";
            el.style.color = '#39FF14';
            playAudio(phrase, 3, 'en-US');

            const badge = document.createElement('div');
            badge.className = 'point-badge';
            badge.textContent = "+1";

            const playerArea = document.querySelector('.player-area');
            playerArea.appendChild(el);
            playerArea.appendChild(badge);
            
            createSparkleTrail(playerArea);
            playerArea.classList.add('correct-answer-glow');
            setTimeout(() => playerArea.classList.remove('correct-answer-glow'), 1500);

            setTimeout(() => {
                el.remove();
                badge.remove();
            }, 2500);
        }
        
        function createSparkleTrail(element) {
            const container = element.offsetParent || document.body;
            const rect = element.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            for (let i = 0; i < 20; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                
                const startX = rect.left - containerRect.left + rect.width / 2;
                const startY = rect.top - containerRect.top + rect.height / 2;

                sparkle.style.left = `${startX}px`;
                sparkle.style.top = `${startY}px`;

                sparkle.style.setProperty('--x', `${(Math.random() - 0.5) * 300}px`);
                sparkle.style.setProperty('--y', `${(Math.random() - 0.5) * 300}px`);
                sparkle.style.animationDelay = `${Math.random() * 0.3}s`;

                container.appendChild(sparkle);
                setTimeout(() => sparkle.remove(), 1000);
            }
        }

        function showEncouragement() {
            const phrase = incorrectPhrases[Math.floor(Math.random() * incorrectPhrases.length)];
            const el = document.createElement('div');
            el.className = 'encouragement-phrase'; el.textContent = phrase;
            const playerArea = document.querySelector('.player-area');
            playerArea.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        function selectEmojiAnswer(selectedEmoji, buttonEl) {
            if (gameState.currentAnswer) return;

            const isCorrect = selectedEmoji === gameState.currentQuestion.emoji;
            gameState.currentAnswer = { correct: isCorrect };
            
            buttonEl.classList.add(isCorrect ? 'correct' : 'incorrect');
            playSound(isCorrect ? 'correct' : 'incorrect');

            if (isCorrect) {
                gameState.score++;
                showPraise();
                createFireworks();
            } else {
                showEncouragement();
            }

            gameState.askedQuestionsThisSet.push(gameState.currentQuestion.name);
            document.getElementById('score').textContent = gameState.score;
            
            // Disable all buttons
            const allButtons = document.querySelectorAll('.emoji-btn');
            allButtons.forEach(btn => btn.onclick = null);

            // Reveal correct answer if wrong
            if (!isCorrect) {
                allButtons.forEach(btn => {
                    if (btn.textContent === gameState.currentQuestion.emoji) {
                        btn.classList.add('correct');
                    }
                });
            }
            
            clearTimeout(gameState.roundTimer);
            setTimeout(playNextReverseCard, 2000);
        }

        function revealCorrectAnswer() {
             const allButtons = document.querySelectorAll('.emoji-btn');
             allButtons.forEach(btn => {
                if (btn.textContent === gameState.currentQuestion.emoji) {
                    btn.classList.add('correct');
                }
                btn.onclick = null;
            });
            gameState.askedQuestionsThisSet.push(gameState.currentQuestion.name);
        }

        function startRoundTimer() {
            clearTimeout(gameState.roundTimer);
            let timeLeft = 7;
            const timerDisp = document.getElementById('timerDisplay');
            const timerProg = document.getElementById('timerProgress');
            timerDisp.textContent = timeLeft;
            timerProg.style.width = '100%';
            gameState.roundTimer = setInterval(() => {
                timeLeft--;
                timerDisp.textContent = timeLeft;
                timerProg.style.width = `${(timeLeft / 7) * 100}%`;
                if (timeLeft <= 0) {
                    clearInterval(gameState.roundTimer);
                    revealCorrectAnswer();
                    playSound('incorrect');
                    setTimeout(playNextReverseCard, 2000); 
                }
            }, 1000);
        }
        
        function showPhaseTransition(text, duration = 3000) {
            const transition = document.getElementById('phaseTransition');
            document.getElementById('transitionText').textContent = text;
            transition.style.display = 'block';
            
            setTimeout(() => {
                transition.style.display = 'none';
            }, duration);
        }

        function endGame() {
            clearInterval(gameState.roundTimer);
            document.getElementById('game-content').style.display = 'none';
            showCertificate();
            for (let i = 0; i < 100; i++) setTimeout(createFireworks, i * 50);
        }

        function showCertificate() {
            const cert = document.getElementById('certificate');
            document.getElementById('certificateScore').textContent = `Final Score: ${gameState.score}`;
            document.getElementById('certificateDate').textContent = `Date: ${new Date().toLocaleDateString()}`;
            cert.style.display = 'block';
        }

        function createFireworks() {
            const container = document.getElementById('fireworksContainer');
            const colors = ['#ff006e', '#8338ec', '#06ffa5', '#ffd700', '#ff8c00', '#ffde7d'];
            for (let i = 0; i < 15; i++) {
                const fw = document.createElement('div');
                fw.className = 'firework';
                fw.style.left = `${Math.random() * 100}%`;
                fw.style.top = `${Math.random() * 100}%`;
                const color = colors[Math.floor(Math.random() * colors.length)];
                fw.style.background = color;
                fw.style.boxShadow = `0 0 20px ${color}`;
                container.appendChild(fw);
                setTimeout(() => fw.remove(), 2000);
            }
        }

        function resetGame() {
            clearInterval(gameState.roundTimer);
            resetGameState();
            document.getElementById('game-content').style.display = 'none';
            document.getElementById('certificate').style.display = 'none';
            document.getElementById('phaseTransition').style.display = 'none';
            document.getElementById('gameModes').style.display = 'flex';
            speechSynthesis.cancel();
        }

        window.addEventListener('load', () => {
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            loadVoices();

            const foodBg = document.getElementById('foodBg');
            const emojis = ['ü•û','ü•Ø','üåÆ','ü•≠','‚òï','üçú','üç£','üçù','ü•©','üçõ','üçî','üçï'];
            for(let i=0;i<30;i++){let e=document.createElement("div");e.className="food-bubble",e.style.left=100*Math.random()+"%",e.style.animationDuration=6+8*Math.random()+"s",e.style.animationDelay=5*Math.random()+"s",e.textContent=emojis[Math.floor(Math.random()*emojis.length)],foodBg.appendChild(e)}
        });
    </script>
</body>
</html>
