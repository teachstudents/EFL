<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chefchaouen – The Blue Pearl of Morocco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @keyframes moroccanSky {
            0% { background-color: #3b82f6; } /* blue-500 */
            25% { background-color: #60a5fa; } /* blue-400 */
            50% { background-color: #f97316; } /* orange-500 */
            75% { background-color: #60a5fa; } /* blue-400 */
            100% { background-color: #3b82f6; } /* blue-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            animation: moroccanSky 240s linear infinite;
            padding-top: 85px; /* Adjusted padding for progress bar */
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
            border: none;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px -1px rgba(0,0,0,0.2), 0 1px 2px -2px rgba(0,0,0,0.1), inset 0 -2px 0 0 rgba(0,0,0,0.2);
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 44px; padding: 0 4px;
            border: 2px dashed #9ca3af; border-radius: 8px; margin: 0 4px;
            vertical-align: middle; background-color: #f3f4f6;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 8px;
            background-color: white; user-select: none;
        }
        .word-bank-word.selected { outline: 2px solid #6366f1; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; }
        .gap.correct .word-bank-word { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .gap.incorrect .word-bank-word { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Feedback Message & Badge Notification */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #fde047, #f97316); }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 20px; } to { opacity: 0; bottom: 0; } }

        /* Certificate Canvas */
        #completion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* Progress Bar */
        #progress-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 8px; width: 100%; margin-top: 8px; }
        #progress-bar { height: 100%; width: 0%; background-color: #38bdf8; transition: width 0.5s ease-out; }
        
        /* Vocab Game Timer */
        #vocab-game-timer-bar { height: 6px; background-color: #38bdf8; transition: width 0.1s linear; }
        
        /* Shake Animation for incorrect answers */
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        .explanation-text {
            margin-top: 12px;
            padding: 10px;
            background-color: #f3f4f6;
            border-left: 4px solid #f59e0b;
            font-size: 0.9em;
            color: #4b5563;
            border-radius: 4px;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #certificate-to-print, #certificate-to-print * { visibility: visible; }
            #certificate-to-print { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="antialiased text-gray-800 text-lg">
    <canvas id="background-canvas"></canvas>
    <div id="reward-animation-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]"></div>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-md mx-auto bg-white/90 backdrop-blur-sm shadow-lg rounded-full p-2">
            <div class="flex justify-center items-center gap-2">
                <button onclick="goBack()" class="nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="font-bold text-base text-blue-500 px-3 whitespace-nowrap">Points ✨: <span id="score-display">0</span></div>
                <button onclick="navigateTo('main-menu')" class="nav-button bg-gray-800 text-white font-bold p-2 rounded-full hover:bg-gray-900">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                </button>
                <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-full hover:bg-gray-200" title="Toggle Sound">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
                </button>
                <button onclick="goNext()" class="nav-button bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
        </div>
    </header>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <section id="page-title-screen" class="page active text-center bg-white rounded-2xl shadow-lg p-8">
            <div class="h-full flex flex-col justify-center items-center">
                <h1 id="main-title" class="text-5xl md:text-6xl font-bold text-slate-800 mb-4"></h1>
                <p id="main-subtitle" class="text-xl md:text-2xl text-gray-600 mb-8"></p>
                <div id="main-svg-container" class="rounded-lg mb-8 w-full max-w-lg mx-auto"></div>
                <button onclick="startApp()" class="action-button bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-2xl hover:bg-blue-700">START LESSON</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION (CHEFCHAOUEN) ---
        // ===================================================================================
        const lessonData = {
            title: "Chefchaouen",
            subtitle: "The Blue Pearl of Morocco <span aria-hidden='true'>🇲🇦</span>",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-tps', text: '0. Think-Pair-Share <span aria-hidden="true">🧠</span>', color: 'green', target: 'tps-start' },
                { id: 'menu-goals', text: '1. Learning Goals <span aria-hidden="true">🎯</span>', color: 'teal', target: 'learning-goals' },
                { id: 'menu-warmup', text: '2. Warm-Up & Vocab <span aria-hidden="true">📚</span>', color: 'sky', target: 'warm-up' },
                { id: 'menu-vocab-game', text: 'Vocab Game <span aria-hidden="true">🎮</span>', color: 'sky', target: 'vocab-game'},
                { id: 'menu-reading', text: '3. Reading & Comprehension <span aria-hidden="true">📖</span>', color: 'blue', target: 'reading-main' },
                { id: 'menu-convo', text: '4. Conversation Practice <span aria-hidden="true">🗣️</span>', color: 'indigo', target: 'conversation-practice' },
                { id: 'menu-lecture', text: '5. Listening: Class Lecture <span aria-hidden="true">🧑‍🏫</span>', color: 'amber', target: 'lecture-pre' },
                { id: 'menu-lecture2', text: '6. Listening: History & Economy <span aria-hidden="true">📈</span>', color: 'orange', target: 'lecture-history-pre' },
                { id: 'menu-lecture3', text: '7. Listening: Tourism Paradox <span aria-hidden="true">🤔</span>', color: 'rose', target: 'lecture-tourism-pre' },
                { id: 'menu-discussion', text: '8. Listening: Classroom Discussion <span aria-hidden="true">💬</span>', color: 'lime', target: 'discussion-pre' },
                { id: 'menu-thinking', text: '9. Thinking & Exam Prep <span aria-hidden="true">📝</span>', color: 'purple', target: 'thinking-prompts' },
                { id: 'menu-final', text: '10. Final Project <span aria-hidden="true">✍️</span>', color: 'violet', target: 'final-project-hub' },
            ],
            vocabulary: [
                { word: 'Amazigh', def: 'The indigenous Berber people of North Africa and their language.', sentence: 'Efforts are being made to revitalize the Amazigh language in Morocco.' },
                { word: 'Medina', def: 'The historic, walled old town center in many North African cities.', sentence: 'The medina of Chefchaouen is famous for its narrow, blue-painted streets.' },
                { word: 'Linguistic Activism', def: 'Efforts and actions taken to preserve or promote an endangered language.', sentence: 'Linguistic activism has helped raise the status of the Amazigh language.' },
                { word: 'Cultural Identity', def: 'The feeling of belonging to a group, based on shared traditions, language, and heritage.', sentence: 'Preserving their language is crucial for their cultural identity.' },
                { word: 'Place-Based Learning', def: 'Education that connects classroom lessons to the local culture, history, and environment.', sentence: 'Place-based learning in Chefchaouen helps students value their unique heritage.' },
                { word: 'Heritage', def: 'The traditions, languages, or buildings that a society inherits from the past and considers important.', sentence: 'The blue walls are an important part of the city\'s cultural heritage.' },
                { word: 'Preservation', def: 'The act of keeping something in its original state or in good condition.', sentence: 'Cultural preservation is important for future generations.' },
                { word: 'Architecture', def: 'The art and practice of designing and constructing buildings.', sentence: 'The architecture of the city reflects both Spanish and Moorish influences.' }
            ],
            pages: [
                // 0. Think Pair Share
                { id: 'tps-start', type: 'simple', content: { title: 'Activity: Think-Pair-Share <span aria-hidden="true">🧠</span>', text: 'Let\'s explore the idea of cultural traditions.' } },
                { id: 'tps-think', type: 'timer', content: { title: '1. Think <span aria-hidden="true">🤔</span>', text: 'Think about a tradition in your own culture or hometown. What makes it special? How does it connect to your identity?', duration: 120, timerId: 'timer-think' } },
                { id: 'tps-pair', type: 'timer', content: { title: '2. Pair <span aria-hidden="true">👥</span>', text: 'With a partner, discuss how your local tradition compares to what you might expect from a historic city like Chefchaouen.', duration: 180, timerId: 'timer-pair' } },
                { id: 'tps-share', type: 'timer', content: { title: '3. Share <span aria-hidden="true">🗣️</span>', text: 'Let\'s share our ideas as a class. How do traditions, big or small, help shape the identity of a place and its people?', duration: 300, timerId: 'timer-share' } },
                
                // 1. Learning Goals
                { id: 'learning-goals', type: 'html-content', content: { title: 'Learning Goals <span aria-hidden="true">🎯</span>', html: `
                                        <div class="text-left space-y-4">
                                            <p><strong class="text-teal-600">Learning Intention:</strong> We are learning about Chefchaouen to understand how culture and language shape a community's identity.</p>
                                            <hr class="my-4">
                                            <h3 class="text-2xl font-bold text-teal-600 mb-3">Success Criteria</h3>
                                            <ul class="list-disc list-inside space-y-2 text-xl">
                                                <li>I can describe the key historical and cultural features of Chefchaouen.</li>
                                                <li>I can explain how preserving a language like <strong>Amazigh</strong> helps protect <strong>cultural identity</strong>.</li>
                                                <li>I can analyze how a city's appearance can reflect its history and values.</li>
                                            </ul>
                                        </div>` } },
                
                // 2. Warm-Up & Vocab
                { id: 'warm-up', type: 'html-content', content: { title: 'Warm-Up Questions <span aria-hidden="true">📚</span>', html: `
                                        <ol class="list-decimal list-inside space-y-4 text-xl text-left">
                                            <li>What colors do you associate with different cities? Why?</li>
                                            <li>Why do you think it is important to preserve old traditions and languages?</li>
                                            <li>What comes to mind when you think of Morocco?</li>
                                            <li>Why might a whole city be painted one color, like blue?</li>
                                        </ol>` } },
                { id: 'vocab-start', type: 'simple', content: { title: 'Unit Vocabulary <span aria-hidden="true">📚</span>', text: 'Let\'s learn the key terms for this unit. Click the "Next" arrow to cycle through the words.' } },
                { id: 'vocab-game', type: 'vocab-game', content: { title: 'Vocabulary Review Game <span aria-hidden="true">🎮</span>'} },
                
                // 3. Reading & Comprehension
                { id: 'reading-main', type: 'html-content', content: { title: 'Reading: The Blue Pearl <span aria-hidden="true">📖</span>', html: `
                                        <div class="space-y-6 text-left">
                                            <div class="bg-blue-50 p-4 rounded-lg">
                                                <h4 class="font-bold text-xl text-blue-800">Text 1: A City of Blue</h4>
                                                <p>Chefchaouen is a famous city in the mountains of Morocco. It is known as the "Blue Pearl" because almost all the buildings in its old town, or <strong>medina</strong>, are painted in beautiful shades of blue. Walking through its narrow streets feels like being in a dream. People say the blue color keeps the city cool and also keeps mosquitoes away. It is a peaceful and beautiful place that many tourists love to visit.</p>
                                            </div>
                                            <div class="bg-yellow-50 p-4 rounded-lg">
                                                <h4 class="font-bold text-xl text-yellow-800">Text 2: A Mix of Cultures</h4>
                                                <p>Chefchaouen's story is a mix of cultures. It was founded in 1471, and its population grew when Muslim and Jewish people came from Spain. The tradition of painting walls blue is said to have been brought by Jewish refugees, as blue is an important spiritual color in Judaism. Today, the city's unique <strong>architecture</strong> shows both Spanish and Moorish influences. The people of Chefchaouen are proud of this rich <strong>heritage</strong> and work hard for its <strong>preservation</strong>.</p>
                                            </div>
                                            <div class="bg-red-50 p-4 rounded-lg">
                                                <h4 class="font-bold text-xl text-red-800">Text 3: Language and Identity</h4>
                                                <p>Chefchaouen is more than just a pretty city; it is a center for a strong <strong>cultural identity</strong>. While Arabic is widely spoken, this region is a heartland for the <strong>Amazigh</strong> people, the indigenous group of North Africa. For many years, their language and culture were not officially recognized. Today, there is a powerful movement of <strong>linguistic activism</strong> to protect and promote the Amazigh language. Schools in the area are using <strong>place-based learning</strong>, connecting lessons to local traditions and history to ensure that the unique identity of the Amazigh people continues for generations to come.</p>
                                            </div>
                                        </div>` } },
                { id: 'reading-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap Fill', sentences: [] } },
                { id: 'reading-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False/Not Given', questions: [] } },
                { id: 'reading-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [] } },
                
                // 4. Conversation Practice
                { id: 'conversation-practice', type: 'dialogue', content: { title: 'Conversation Practice <span aria-hidden="true">🗣️</span>', dialogue: "A: Have you ever heard of Chefchaouen?\n\nB: Yes! It’s the city with the blue buildings, right?\n\nA: Exactly. Do you know why it’s blue?\n\nB: I think it has something to do with spirituality and history. Maybe from Jewish traditions?\n\nA: That’s right. They also say it keeps bugs away!\n\nB: Interesting! What languages do people speak there?\n\nA: The main languages are Arabic and the local Amazigh language. But many people in tourism also speak French, Spanish, and English.\n\nB: Wow, that’s a lot! I’d love to visit someday and see the blue medina for myself." } },
                 
                // 5. Listening: Class Lecture
                { id: 'lecture-pre', type: 'html-content', content: { title: 'Pre-Listening Questions <span aria-hidden="true">🎧</span>', html: `
                                        <div class="text-left space-y-4 text-xl">
                                            <p>Before listening to the lecture, think about these questions:</p>
                                            <ol class="list-decimal list-inside pl-4 space-y-2">
                                                <li>What kind of information do you expect to hear in a lecture about a historic city?</li>
                                                <li>Besides color, what other architectural features might make a city unique?</li>
                                                <li>How can a city's location (e.g., in the mountains) influence its history and culture?</li>
                                            </ol>
                                        </div>` } },
                { id: 'lecture-main', type: 'dialogue', content: { title: 'Listening: Lecture on Chefchaouen <span aria-hidden="true">🧑‍🏫</span>', dialogue: "Professor: Alright class. Let's continue our exploration of natural and cultural wonders. Today, we're journeying to the stunning blue city of Morocco, Chefchaouen. Before we delve into the details, let's consider the key questions we'll address today. What is the most striking feature of Chefchaouen, and where is it located? Why is the city painted blue? What are the theories behind this? What is the historical significance of Chefchaouen? And finally, what are some aspects of its architecture and culture that stand out? By the end of our discussion, you should be able to answer these. Let's start with the first question. Aisha, in your research, what did you find is the most striking feature of Chefchaouen and its location?\n\nAisha: Oh, professor, that's easy. The most striking thing is definitely all the blue buildings. It's just everywhere in the pictures. And it's in Morocco, right? Like in the mountains?\n\nProfessor: You're absolutely right about the blue buildings, Aisha. And yes, Ben, where exactly is it located?\n\nBen: Yeah, I remember reading it's nestled in the Rif Mountains, in the northwestern part of Morocco. It looks pretty, uh, scenic.\n\nProfessor: Excellent. The blue is indeed its defining characteristic, which leads us to our second question. Why blue? Aisha, did you uncover any reasons or theories behind this unique color?\n\nAisha: Yes, I did. There are a few ideas, actually. Some people say it helps keep the houses cool, which makes sense in a warm climate. And others think it, um, repels mosquitoes.\n\nBen: Oh, yeah, I heard about the mosquito thing. But there's also that theory about the Jewish refugees, right? Like, from the 1930s?\n\nProfessor: Precisely, Ben. A widely held belief is that Jewish refugees who settled there in the 1930s introduced the practice, you know, seeing blue as a color symbolizing the sky and heaven, bringing a spiritual element to the city. Moving on, let's consider Chefchaouen's historical significance. Ben, what did you learn about the city's past?\n\nBen: Well, it was founded back in 1471, I think, as, like, a fortress to fight off the Portuguese. And then later it became a place for exiles from Spain, both Muslim and Jewish people who were, uh, kicked out, basically.\n\nProfessor: That's a good summary, Ben. It served as a strategic defense point and later as a haven for those fleeing the Spanish Reconquista. This influx of people from Andalusia significantly shaped the city. And how is that history reflected in its architecture and culture? Aisha, what did you find in that regard?\n\nAisha: You can really see the Spanish and Moorish influences, professor. Especially in the architecture, like narrow, winding streets in the old city, the medina. And the central square, the Plaza Uta el-Hammam, has a very, um, Andalusian feel.\n\nBen: Yeah, I saw pictures of that square. It looks pretty lively. And I guess the culture is a mix of Moroccan and, uh, those Andalusian traditions?\n\nProfessor: That's a fair assessment. The blend of cultures is evident throughout the city, contributing to its unique atmosphere. Excellent work, both of you. To quickly review our questions, we've established that Chefchaouen's most striking feature is its blue color, located in the Rif Mountains of Northwestern Morocco. The theories behind the blue range from practical reasons like cooling and mosquito repulsion to symbolic ones tied to Jewish tradition. Historically, it was founded as a fortress and served as a refuge for exiles from Spain, which influenced its distinct Andalusian architecture and culture, visible in its winding streets and the Plaza Uta el-Hammam. Thank you both for sharing your insights on this fascinating city.\n\nAisha: Thank you, professor. It was really interesting to learn about.\n\nBen: Yeah, thanks. Definitely want to see it now.\n\nProfessor: I highly recommend it. It's a truly memorable place." } },
                { id: 'lecture-quiz-mcq', type: 'quiz-mcq', content: { title: 'Lecture Quiz (MCQ)', questions: [] } },
                { id: 'lecture-quiz-tfng', type: 'quiz-tfng', content: { title: 'Lecture Quiz (TFNG)', questions: [] } },
                { id: 'lecture-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Lecture Quiz (Gap Fill)', sentences: [] } },
                
                // 6. Listening: History & Economy
                { id: 'lecture-history-pre', type: 'html-content', content: { title: 'Pre-Listening: History & Economy <span aria-hidden="true">📈</span>', html: `<div class="text-left space-y-4 text-xl"><p>Before listening, consider:</p><ol class="list-decimal list-inside pl-4 space-y-2"><li>How might social media change a small town?</li><li>What is the difference between a place's original purpose and its modern identity?</li></ol></div>`}},
                { id: 'lecture-history-main', type: 'dialogue', content: { title: 'Listening: History & Economy', dialogue: "Professor: Good day. Today, we turn our attention to the city of Chefchaouen in North Africa. Our essential question is, how can a community embrace the economic benefits of tourism while preserving the authentic culture and sense of place that attracted visitors in the first place? To begin, I will outline our lecture. First, we will cover the city's geography and historical origins. Second, we will analyze the theories behind its famous blue color. Finally, we will review the modern economic shift from agriculture to tourism. Let's start with the location. Chefchaouen is located in the Rif Mountains of northwest Morocco. The city was founded in the year 1471. Its initial purpose was as a fortress to defend against Portuguese invaders. Shortly after, it became a primary refuge for both Muslims and Jews fleeing the Spanish Reconquista. This brings us to the city's most defining feature: its blue-washed medina, or old town. There are several theories for the origin of the color. The most widely cited theory suggests that Jewish refugees, arriving in the 1930s to escape persecution in Europe, painted the buildings blue to symbolize the sky and heaven, reminding them of God. Another popular theory is more practical: that the blue color helps to repel mosquitoes. Finally, let's look at the city's economy. For centuries, the region's economy was based on traditional agriculture. However, beginning in the 2010s, the rise of social media platforms like Instagram transformed Chefchaouen into a global tourism hotspot. Data shows a massive increase in international visitors during this decade. Today, a significant percentage of the local economy is directly dependent on the thousands of tourists who come to photograph the blue streets. To review the key points: Chefchaouen was founded in 1471 as a mountain refuge. Its iconic blue color likely has cultural origins tied to Jewish refugees. And its modern economy has been completely reshaped by a social media-driven tourism boom that began around 2010." }},
                { id: 'lecture-history-quiz-mcq', type: 'quiz-mcq', content: { title: 'History & Economy Quiz (MCQ)', questions: [] } },
                { id: 'lecture-history-quiz-tfng', type: 'quiz-tfng', content: { title: 'History & Economy Quiz (TFNG)', questions: [] } },
                { id: 'lecture-history-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'History & Economy Quiz (Gap Fill)', sentences: [] } },

                // 7. Listening: Tourism Paradox
                { id: 'lecture-tourism-pre', type: 'html-content', content: { title: 'Pre-Listening: Tourism Paradox <span aria-hidden="true">🤔</span>', html: `<div class="text-left space-y-4 text-xl"><p>Before you listen to the tour guide, think about:</p><ol class="list-decimal list-inside pl-4 space-y-2"><li>What does it mean to be a "responsible visitor"?</li><li>What is the difference between a "living community" and a "theme park"?</li></ol></div>`}},
                { id: 'lecture-tourism-main', type: 'dialogue', content: { title: 'Listening: The Tourism Paradox', dialogue: "Guide: Hello. When you first walk into the medina of Chefchaouen, the blue pearl of Morocco, the feeling is unforgettable. It's a labyrinth of narrow alleyways, all painted in a hundred different shades of blue. But as we explore, I want you to think about our essential question: How can a community embrace the economic benefits of tourism while preserving the authentic culture that attracted visitors in the first place? My talk will outline this challenge. First, we'll look at the human story behind the blue walls. Second, we will discuss the original inhabitants of the region. And finally, we will review the paradox of being 'Instagram famous'. So, while there are many theories, the most powerful story connects the blue color to the Jewish refugees who sought sanctuary here. For them, the blue was a symbol of divinity, a constant prayer. It wasn't about aesthetics; it was about survival and faith. This adds a deep layer of meaning to what visitors see. But it's also important to remember the indigenous people of the Rif Mountains, the Berbers. Their culture is the bedrock of this region's identity. This leads us to the modern paradox. Today, thousands of tourists visit every year, drawn by images they've seen online. This tourism provides vital income for many local families. However, there's a growing concern that the city is becoming a victim of its own beauty. Residents' daily lives are often interrupted by photoshoots on their doorsteps, and some worry the city is becoming more of a theme park than a living community. Let's review, then. The city's blue walls tell a story of refuge and faith. The region's culture is rooted in the Berber people. And today, the global attention brought by tourism presents a profound challenge. The key takeaway is this: to be a responsible visitor, we must look beyond the beautiful photos and engage with the deep history and living culture of the place, ensuring our visits support the community without overwhelming it." }},
                { id: 'lecture-tourism-quiz-mcq', type: 'quiz-mcq', content: { title: 'Tourism Paradox Quiz (MCQ)', questions: [] } },
                { id: 'lecture-tourism-quiz-tfng', type: 'quiz-tfng', content: { title: 'Tourism Paradox Quiz (TFNG)', questions: [] } },
                { id: 'lecture-tourism-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Tourism Paradox Quiz (Gap Fill)', sentences: [] } },

                // 8. Listening: Classroom Discussion
                { id: 'discussion-pre', type: 'html-content', content: { title: 'Pre-Listening: Classroom Discussion <span aria-hidden="true">💬</span>', html: `<div class="text-left space-y-4 text-xl"><p>Before listening, consider:</p><ol class="list-decimal list-inside pl-4 space-y-2"><li>What makes a place feel "authentic"?</li><li>What are the pros and cons of a city becoming a major tourist destination?</li></ol></div>`}},
                { id: 'discussion-main', type: 'dialogue', content: { title: 'Listening: Classroom Discussion', dialogue: "Professor: All right, class. Let's shift our focus today to a truly unique and visually stunning city: Chefchaouen in Morocco, often called the 'Blue Pearl.' Its distinctive blue-washed buildings are quite famous. Has anyone here, perhaps, seen photos or read anything about Chefchaouen before? Emily, maybe you?\n\nEmily: Yes, professor. I've seen so many photos online. It looks absolutely beautiful, almost like a dream or something. All that blue is just incredible.\n\nProfessor: That's a great way to put it, Emily, 'like a dream.' It really does have that ethereal quality. Oliver, what about you? Any prior knowledge or impressions of Chefchaouen?\n\nOliver: Hello, professor. Yes, I've seen the pictures as well. It looks quite striking. The blue is definitely the main thing you notice straight away.\n\nProfessor: It does look incredible, Oliver. The blue is certainly its most striking feature. The exact reason for painting the city blue is debated, but theories range from keeping cool to warding off mosquitoes or even religious significance. Beyond the color, what other aspects of Chefchaouen make it such a fascinating place? Emily, what did you find interesting?\n\nEmily: Well, besides the blue, I think the atmosphere seems really relaxed and peaceful, compared to, say, Marrakesh or Fes. And I read that it's in the mountains, so the scenery around it looks amazing, too.\n\nProfessor: Absolutely, Emily. The relaxed atmosphere is a big draw for many visitors. It feels less hectic than some of the larger Moroccan cities. And the surrounding Rif Mountains offer incredible opportunities for hiking and exploring nature. Oliver, did you come across any information about the culture or daily life in Chefchaouen?\n\nOliver: I didn't read too much about the culture specifically, but I imagine it's quite different from the bigger cities. I suppose with tourism being a big part of its economy now, there's always that balance between catering to visitors and maintaining local traditions.\n\nProfessor: That's a good point, Oliver. While tourism is important, it's crucial to understand and respect the local culture and traditions. Chefchaouen has a rich history, influenced by Andalusian refugees who settled there. The local markets, or souks, are vibrant and a central part of daily life. What about the challenges Chefchaouen might face, perhaps related to its popularity or location? Emily, any thoughts?\n\nEmily: Hmm, challenges? I guess managing the tourism, like keeping it authentic while still having lots of visitors. And maybe infrastructure, like, can the city handle all the people?\n\nProfessor: You've hit on key challenges, Emily. Managing the influx of tourists while preserving the city's unique character and infrastructure is a delicate balancing act. Providing adequate facilities and ensuring sustainable tourism practices are essential. Oliver, are there any environmental considerations, given its mountain location?\n\nOliver: Environmentally, I suppose water could be an issue, being in the mountains, and maybe waste management. With more tourists, that would become more of a challenge, I'd think.\n\nProfessor: Excellent point, Oliver. Water management and waste disposal are particularly important in a place like Chefchaouen, nestled in the mountains. Protecting the natural beauty of the Rif Mountains is also vital for the city's appeal and the local ecosystem. So, in conclusion, Chefchaouen's captivating blue architecture, relaxed atmosphere, and stunning natural surroundings make it a remarkable destination. However, its growing popularity brings challenges related to sustainable tourism, infrastructure, and environmental protection. It's a city striving to balance its unique charm with the demands of the modern world. Thank you both for your insights into this beautiful Blue Pearl of Morocco." }},
                { id: 'discussion-quiz-mcq', type: 'quiz-mcq', content: { title: 'Discussion Quiz (MCQ)', questions: [] } },
                { id: 'discussion-quiz-tfng', type: 'quiz-tfng', content: { title: 'Discussion Quiz (TFNG)', questions: [] } },
                { id: 'discussion-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Discussion Quiz (Gap Fill)', sentences: [] } },

                // 9. Thinking & Exam Prep
                { id: 'thinking-prompts', type: 'html-content', content: { title: 'Thinking & Exam Prep <span aria-hidden="true">📝</span>', html: `
                                        <div class="text-left space-y-8">
                                            <div>
                                                <h3 class="text-2xl font-bold text-purple-600 mb-3">Higher-Order Thinking Questions</h3>
                                                <ul class="list-disc list-inside space-y-2 text-lg">
                                                    <li><b>Analyze:</b> How does Chefchaouen’s blue architecture reflect its history and cultural values?</li>
                                                    <li><b>Evaluate:</b> In your opinion, is linguistic activism an effective way to preserve a culture? Why or why not?</li>
                                                    <li><b>Create:</b> Imagine you are designing a one-day cultural tour of Chefchaouen for other students. What three activities would you include to highlight its unique identity?</li>
                                                </ul>
                                            </div>
                                             <div>
                                                <h3 class="text-2xl font-bold text-purple-600 mb-3">IELTS & TOEFL Practice</h3>
                                                <p class="mb-2"><strong>IELTS Part 2:</strong> Describe a city that you think is very beautiful.</p>
                                                <p><strong>TOEFL Speaking:</strong> Discuss the importance of preserving historic buildings and cultural traditions in a city.</p>
                                            </div>
                                        </div>` } },

                // 10. Final Project
                { id: 'final-project-hub', type: 'html-content', content: { title: 'Final Project Hub <span aria-hidden="true">✍️</span>', html: `
                                        <div class="bg-white rounded-2xl shadow-xl p-8 text-left">
                                        <h2 class="text-3xl font-bold text-violet-600 mb-4">GRASPS Task: Cultural Showcase Presentation</h2>
                                        <div class="space-y-3 text-lg">
                                            <p><strong class="font-semibold text-violet-700">Goal:</strong> To produce a written and oral presentation that explains Chefchaouen’s cultural and linguistic significance.</p>
                                            <p><strong class="font-semibold text-violet-700">Role:</strong> You are a cultural researcher preparing a report for a global studies class.</p>
                                            <p><strong class="font-semibold text-violet-700">Audience:</strong> Your classmates and teacher.</p>
                                            <p><strong class="font-semibold text-violet-700">Situation:</strong> You have been asked to present at a cultural showcase on how a specific place preserves its identity.</p>
                                            <p><strong class="font-semibold text-violet-700">Product:</strong> A 3-5 minute oral presentation, supported by a one-page written summary (200-250 words).</p>
                                            <p><strong class="font-semibold text-violet-700">Standards:</strong> Your presentation will be evaluated on your clear explanation of cultural preservation, the role of language, and your ability to connect these ideas to Chefchaouen.</p>
                                        </div>
                                        </div>` } },
                { id: 'writing-task', type: 'writing-task', content: { 
                    title: 'Project Writing Activity <span aria-hidden="true">✍️</span>', 
                    prompt: 'Describe how Chefchaouen preserves its culture through its unique appearance, language, and education. (200-250 words)', 
                    starters: [
                        "Chefchaouen is known for…",
                        "One way the city preserves its culture is…",
                        "Language plays a critical role in…",
                        "I think this is important because…"
                    ],
                    wordBank: ['Amazigh', 'architecture', 'blue', 'culture', 'heritage', 'identity', 'language', 'Medina', 'place-based', 'preservation', 'tradition']
                } },
                { id: 'self-assessment', type: 'html-content', content: { title: 'Self-Assessment <span aria-hidden="true">🧑‍🏫</span>', html: `
                                        <div class="text-left">
                                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Metacognitive Self-Assessment</h3>
                                            <ol class="list-decimal list-inside space-y-4 text-xl">
                                                <li>“How did learning about Chefchaouen change my view of how a city's color or appearance can tell a story?”</li>
                                                <li>“What is one thing I still want to learn about linguistic activism or the Amazigh culture?”</li>
                                            </ol>
                                        </div>` } },
                { id: 'certificate', type: 'certificate', content: { title: 'Module Complete! <span aria-hidden="true">🎉</span>', text: 'You have successfully completed the "The Blue Pearl of Morocco" module.', certificateTitle: 'Certificate of Cultural Exploration' } }
            ]
        };
        // --- END OF LESSON CONTENT CONFIGURATION ---
        // ===================================================================================

        class SpeechService {
             constructor() { this.synth = window.speechSynthesis; this.isInitialized = false; this.isTtsEnabled = true; this.voices = {}; this.speechRate = 0.85; this.isDialoguePlaying = false; }
             async _setupVoices() {
                 const voicesPromise = new Promise(resolve => { if (this.synth.getVoices().length) return resolve(this.synth.getVoices()); this.synth.onvoiceschanged = () => resolve(this.synth.getVoices()); });
                 const availableVoices = await voicesPromise;
                 if (!availableVoices.length) { console.warn("No speech synthesis voices available."); return; }
                 const speakerToVoiceMap = {
                    // General conversation practice speakers
                    'a': ['Microsoft Emma Online (Natural) - English (United States)', 'Microsoft Ava Online (Natural) - English (United States)'],
                    'b': ['Microsoft Brian Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)'],
                    
                    // Speakers for the lectures
                    'professor': ['Microsoft Brian Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)', 'Google US English'],
                    'aisha': ['Microsoft Emma Online (Natural) - English (United States)', 'Google US English'],
                    'ben': ['Microsoft Andrew Online (Natural) - English (United States)', 'Google US English'],
                    'guide': ['Microsoft Ava Online (Natural) - English (United States)', 'Google US English'],
                    'emily': ['Microsoft Emma Online (Natural) - English (United States)', 'Google US English'],
                    'oliver': ['Microsoft Andrew Online (Natural) - English (United States)', 'Google US English']
                 };
                 for (const speaker in speakerToVoiceMap) {
                     const voicePriorityList = speakerToVoiceMap[speaker];
                     let chosenVoice = null;
                     for (const voiceName of voicePriorityList) {
                         const foundVoice = availableVoices.find(v => v.name === voiceName);
                         if (foundVoice) { chosenVoice = foundVoice; break; }
                     }
                     if (chosenVoice) { this.voices[speaker] = chosenVoice; } else { console.warn(`Could not find specified voices for speaker: "${speaker}"`); }
                 }
                 this.voices['default'] = availableVoices.find(v => v.name === 'Microsoft Ava Online (Natural) - English (United States)') || availableVoices.find(v => v.lang === 'en-US');
             }
             async init() { if (this.isInitialized) return; try { const warmUp = new SpeechSynthesisUtterance(' '); warmUp.volume = 0; this.synth.speak(warmUp); this.synth.cancel(); await this._setupVoices(); this.isInitialized = true; } catch (e) { console.error("Speech synthesis setup failed:", e); } }
             _cleanTextForSpeech(text) { const tempDiv = document.createElement('div'); const textWithoutSpans = text.replace(/<span aria-hidden="true">.*?<\/span>/g, ' '); tempDiv.innerHTML = textWithoutSpans; let cleanText = tempDiv.textContent || tempDiv.innerText || ''; cleanText = cleanText.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, ''); return cleanText; }
             async speak(text, { onEndCallback = null, voiceKey = 'default' } = {}) { 
                if (!this.isInitialized || !this.isTtsEnabled || !text) { 
                    if (onEndCallback) onEndCallback(); 
                    return; 
                } 
                if (this.synth.speaking) { 
                    this.synth.cancel(); 
                    await new Promise(resolve => setTimeout(resolve, 100)); 
                } 
                const cleanText = this._cleanTextForSpeech(text); 
                if (!cleanText.trim()) { 
                    if (onEndCallback) onEndCallback(); 
                    return; 
                } 
                const utter = new SpeechSynthesisUtterance(cleanText); 
                utter.voice = this.voices[voiceKey] || this.voices['default']; 
                utter.rate = this.speechRate; 
                if (onEndCallback) utter.onend = onEndCallback; 
                utter.onerror = (e) => { 
                    console.error('SpeechSynthesisUtterance.onerror', e); 
                    if (onEndCallback) onEndCallback(); 
                }; 
                try { 
                    this.synth.speak(utter); 
                } catch (e) { 
                    console.error("Error calling synth.speak:", e); 
                    if (onEndCallback) onEndCallback(); 
                } 
            }
             async speakDialogue(text) { if (!this.isInitialized || !this.isTtsEnabled || !text || this.isDialoguePlaying) return; this.cancel(); this.isDialoguePlaying = true; const lines = text.split('\n').filter(line => line.trim() !== '' && line.includes(':')); const queue = lines.map(line => { const [speaker, ...parts] = line.split(':'); const dialogue = parts.join(':').trim(); const cleanDialogue = this._cleanTextForSpeech(dialogue); const voiceKey = speaker.toLowerCase().replace(/dr\. |professor /g, '').trim(); return { text: cleanDialogue, voiceKey: voiceKey }; }).filter(item => item.text); if (queue.length === 0) { this.isDialoguePlaying = false; return; } const playNext = () => { if (queue.length > 0 && this.isTtsEnabled) { const item = queue.shift(); const utter = new SpeechSynthesisUtterance(item.text); utter.voice = this.voices[item.voiceKey] || this.voices['default']; utter.rate = this.speechRate; utter.onend = playNext; utter.onerror = (e) => { console.warn('A speech synthesis error occurred, attempting to recover.', e.error); try { this.synth.cancel(); } catch (cancelError) { console.error("Error while cancelling synth:", cancelError); } setTimeout(playNext, 250); }; try { this.synth.speak(utter); } catch(e) { console.error("Error in synth.speak:", e); setTimeout(playNext, 250); } } else { this.isDialoguePlaying = false; } }; playNext(); }
             cancel() { if (this.synth) { this.isDialoguePlaying = false; this.synth.cancel(); } }
             toggleTTS(forceState) { this.isTtsEnabled = forceState === undefined ? !this.isTtsEnabled : forceState; if (!this.isTtsEnabled) { this.cancel(); } return this.isTtsEnabled; }
        }

        // --- Global App State and Functions ---
        const speechService = new SpeechService();
        let score = 0, currentPage = lessonData.startPageId, timerInterval;
        const pageHistory = [lessonData.startPageId];
        let pageSequence = [];
        let completedSections = new Set();
        let vocabGameTimer;
        let selectedWord = { element: null, text: '' };

        // --- Sound and Reward Effects ---
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();
        function playCorrectSound() {
            if (!speechService.isTtsEnabled) return; // Respect the mute button
            try {
                const now = Tone.now();
                synth.triggerAttackRelease(["C5", "E5", "G5"], "8n", now);
            } catch(e) {
                console.warn("Tone.js sound failed to play:", e);
            }
        }

        function triggerRewardAnimation() {
            const container = document.getElementById('reward-animation-container');
            if (!container) return;
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
                confetti.style.position = 'absolute';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * -50 - 50}px`; /* Start above screen */
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = confetti.style.width;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.opacity = '1';
                
                container.appendChild(confetti);

                const animation = confetti.animate([
                    { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
                    { transform: `translateY(120vh) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                ], {
                    duration: Math.random() * 2000 + 3000,
                    easing: 'ease-out',
                    iterations: 1
                });

                animation.onfinish = () => {
                    confetti.remove();
                };
            }
        }

        // --- Progress and Completion Logic ---
        const pageToMenuMap = {};
        function buildPageToMenuMap() {
            lessonData.mainMenu.forEach(menuItem => {
                let queue = [menuItem.target];
                let visited = new Set(queue);
                while (queue.length > 0) {
                    const pageId = queue.shift();
                    pageToMenuMap[pageId] = menuItem.id;
                    const pageDef = lessonData.pages.find(p => p.id === pageId);
                    if (pageDef && pageDef.type.startsWith('quiz')) {
                        const nextQuizPage = getNextQuizPage(pageId);
                        if (nextQuizPage && !visited.has(nextQuizPage) && lessonData.pages.some(p => p.id === nextQuizPage)) {
                            queue.push(nextQuizPage);
                            visited.add(nextQuizPage);
                        }
                    }
                }
            });
            // Manual mapping for vocab game
            pageToMenuMap['vocab-game'] = 'menu-vocab-game';
        }

        function getNextQuizPage(pageId) {
            const sequence = ['mcq','tfng', 'gap-fill'];
            const parts = pageId.split('-quiz-');
            if (parts.length < 2) return null;
            const prefix = parts[0];
            const type = parts[1];
            const currentIndex = sequence.indexOf(type);
            if (currentIndex > -1 && currentIndex < sequence.length - 1) {
                return `${prefix}-quiz-${sequence[currentIndex + 1]}`;
            }
            return null;
        }

        function updateProgressBar() {
            const progress = (completedSections.size / lessonData.mainMenu.length) * 100;
            const bar = document.getElementById('progress-bar');
            if (bar) bar.style.width = `${progress}%`;
        }

        function updateMenuCompletionState() {
            const menuContainer = document.getElementById('page-main-menu');
            if (!menuContainer) return;
            lessonData.mainMenu.forEach(item => {
                const button = menuContainer.querySelector(`#menu-btn-${item.id}`);
                if (button && completedSections.has(item.id)) {
                    if (!button.innerHTML.includes('✓')) {
                        button.innerHTML += ' <span class="text-green-300">✓</span>';
                    }
                }
            });
        }

        function markSectionAsComplete(pageId) {
            const menuId = pageToMenuMap[pageId];
            if (menuId && !completedSections.has(menuId)) {
                completedSections.add(menuId);
                updateProgressBar();
            }
        }
        
        function checkQuizPageCompletion(pageId) {
            const pageElement = document.getElementById(`page-${pageId}`);
            if (!pageElement) return false;

            if (pageId.includes('gap-fill')) {
                const gaps = pageElement.querySelectorAll('.gap');
                return gaps.length > 0 && Array.from(gaps).every(g => g.classList.contains('correct'));
            } else {
                const questions = pageElement.querySelectorAll('.question-group');
                return questions.length > 0 && Array.from(questions).every(q => q.querySelector('button:disabled'));
            }
        }


        // --- App Navigation ---
        window.toggleTTS = (button) => {
            const isNowEnabled = speechService.toggleTTS();
            const iconPath = isNowEnabled 
                ? "M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"
                : "M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z M17 14l-4-4m0 4l4-4";
            button.querySelector('svg').classList.toggle('text-gray-600', isNowEnabled);
            button.querySelector('svg').classList.toggle('text-gray-400', !isNowEnabled);
            button.querySelector('path').setAttribute('d', iconPath);

            if (isNowEnabled) {
                const pageData = lessonData.pages.find(p => p.id === currentPage);
                const targetPage = document.getElementById(`page-${currentPage}`);
                if (pageData && pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else if (targetPage) {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    if (readableContent) speechService.speak(readableContent.innerText);
                    else if (titleElement) speechService.speak(titleElement.innerText);
                }
            }
        };

        window.startApp = async function() {
            await speechService.init(); 
            try { await Tone.start(); } catch (e) { console.error(e); }
            navigateTo(lessonData.homePageId);
        }
        
        function startTimer(duration, display, onComplete) {
            let timer = duration;
            const update = () => { display.textContent = `${String(Math.floor(timer/60)).padStart(2,'0')}:${String(timer%60).padStart(2,'0')}`; };
            update();
            timerInterval = setInterval(() => { timer--; update(); if (timer < 0) { clearInterval(timerInterval); if (onComplete) onComplete(); } }, 1000);
        }

        window.navigateTo = (pageId) => {
            const previousPageId = currentPage;
            
            // Mark completion if leaving a quiz page and it's fully answered
            if (previousPageId.includes('-quiz-')) {
                if (checkQuizPageCompletion(previousPageId)) {
                    markSectionAsComplete(previousPageId);
                }
            }
            
            const targetPage = document.getElementById(`page-${pageId}`);
            if (!targetPage) return console.warn('navigateTo: no page found for id', pageId);
            if (pageId === currentPage) return;
            
            clearInterval(timerInterval);
            clearTimeout(vocabGameTimer);
            speechService.cancel();

            // Mark simple pages as complete on navigation
            const previousPageDef = lessonData.pages.find(p => p.id === previousPageId);
            if (previousPageDef && !previousPageDef.type.startsWith('quiz') && previousPageId !== 'vocab-game') {
                 markSectionAsComplete(previousPageId);
            }

            document.getElementById(`page-${currentPage}`)?.classList.remove('active');
            targetPage.classList.add('active');
            currentPage = pageId;
            if (pageHistory[pageHistory.length - 1] !== currentPage) pageHistory.push(currentPage);
            
            const pageData = lessonData.pages.find(p => p.id === pageId);
            if (pageData) {
                if (pageData.type === 'timer') {
                    const timerEl = document.getElementById(pageData.content.timerId);
                    if (timerEl) startTimer(pageData.content.duration, timerEl, goNext);
                } else if (pageData.type === 'vocab-game') {
                    startVocabGame();
                }
                
                if (pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    let contentToSpeak = readableContent ? readableContent.innerText : (titleElement ? titleElement.innerText : '');
                    let voice = 'default';
                    if (pageId.startsWith('vocab-') || pageId === 'reading-main') {
                       voice = 'oliver'; // Andrew voice
                       if (pageId === 'reading-main') {
                           contentToSpeak = Array.from(targetPage.querySelectorAll('h4, p')).map(el => el.innerText).join(' ');
                       }
                    }
                    speechService.speak(contentToSpeak, { voiceKey: voice });
                }
            } else if (pageId === lessonData.homePageId) {
                speechService.speak(targetPage.querySelector('h2').innerText);
                updateMenuCompletionState();
            }
            updateNavButtons();
            window.scrollTo(0, 0);
        }

        window.goNext = () => { const currentIndex = pageSequence.indexOf(currentPage); if (currentIndex > -1 && currentIndex < pageSequence.length - 1) navigateTo(pageSequence[currentIndex + 1]); }
        window.goBack = () => { if (pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); } }

        function updateNavButtons() {
            const nav = document.getElementById('nav-header');
            if (!nav) return;
            nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
            const backBtn = nav.querySelector('button:first-child');
            backBtn.disabled = pageHistory.length <= 1;
            backBtn.classList.toggle('opacity-50', backBtn.disabled);
            const nextBtn = nav.querySelector('button:last-child');
            const currentIndex = pageSequence.indexOf(currentPage);
            const isLast = currentIndex >= pageSequence.length - 1;
            nextBtn.disabled = isLast || currentPage === lessonData.homePageId;
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }
        
        function showFeedbackMessage(isCorrect) {
            const correctFeedback = ["That's right!", "Excellent!", "Perfect!", "Great job!"];
            const incorrectFeedback = ["Not quite.", "Keep trying!", "Almost there."];
            const message = isCorrect ? correctFeedback[Math.floor(Math.random() * correctFeedback.length)] : incorrectFeedback[Math.floor(Math.random() * incorrectFeedback.length)];
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `feedback-toast ${isCorrect ? 'correct' : 'encouraging'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function updateScore(points) { score += points; document.getElementById('score-display').textContent = score; }

        function checkCompletionAndMark() {
            if(checkQuizPageCompletion(currentPage)) {
                markSectionAsComplete(currentPage);
            }
        }

        window.checkTfngAnswer = function(clickedButton, chosenAnswer, correctAnswer) {
            const buttonContainer = clickedButton.parentElement;
            Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
            const isCorrect = chosenAnswer === correctAnswer;
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                updateScore(10);
                playCorrectSound();
                triggerRewardAnimation();
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-green-500');
            } else {
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-red-600');
                const correctBtn = Array.from(buttonContainer.children).find(btn => btn.textContent === correctAnswer.charAt(0));
                if (correctBtn) correctBtn.className = correctBtn.className.replace(/bg-\w+-500/, 'bg-green-500');
            }
            setTimeout(checkCompletionAndMark, 100);
        }
        
        window.checkMcqAnswer = function(button, isCorrect) {
            const questionGroup = button.closest('.question-group');
            questionGroup.querySelectorAll('.quiz-option').forEach(opt => opt.disabled = true);
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                updateScore(10);
                playCorrectSound();
                triggerRewardAnimation();
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'border-green-600', 'text-white');
            } else {
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'border-red-600', 'text-white', 'shake');
                const correctButton = questionGroup.querySelector(".quiz-option[data-correct='true']");
                if (correctButton) {
                    correctButton.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    correctButton.classList.add('bg-green-500', 'border-green-600', 'text-white');
                }
            }
            setTimeout(checkCompletionAndMark, 100);
        }

        function initGapFill(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return;
            const gaps = page.querySelectorAll('.gap');
            const words = page.querySelectorAll('.word-bank-word');
            const wordBank = page.querySelector('.word-bank-container');

            words.forEach(word => {
                word.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', word.dataset.word); });
                word.addEventListener('click', handleWordClick);
            });
            gaps.forEach(gap => {
                gap.addEventListener('dragover', e => e.preventDefault());
                gap.addEventListener('drop', e => handleDrop(e, gap));
                gap.addEventListener('click', handleGapClick);
            });

            function handleWordClick(e) {
                const clickedWord = e.currentTarget;
                if (clickedWord.parentElement.classList.contains('gap')) { 
                    wordBank.appendChild(clickedWord); 
                    clickedWord.parentElement.classList.remove('correct', 'incorrect');
                    return; 
                }
                if (selectedWord.element) selectedWord.element.classList.remove('selected');
                if (selectedWord.element === clickedWord) { selectedWord = { element: null, text: '' }; } 
                else { selectedWord = { element: clickedWord, text: clickedWord.dataset.word }; clickedWord.classList.add('selected'); }
            }
            function handleGapClick(e) {
                const clickedGap = e.currentTarget;
                if(clickedGap.children.length > 0) {
                     wordBank.appendChild(clickedGap.children[0]);
                     clickedGap.classList.remove('correct', 'incorrect');
                }
                if (!selectedWord.element) return;
                clickedGap.appendChild(selectedWord.element);
                checkGap(clickedGap);
                selectedWord.element.classList.remove('selected');
                selectedWord = { element: null, text: '' };
            }
            function handleDrop(e, gap) {
                e.preventDefault();
                if (gap.children.length > 0) return;
                const wordText = e.dataTransfer.getData('text/plain');
                const wordElement = page.querySelector(`.word-bank-word[data-word="${wordText}"]`);
                if (wordElement) { gap.appendChild(wordElement); checkGap(gap); }
            }
            function checkGap(gap) {
                const word = gap.querySelector('.word-bank-word');
                const isCorrect = word && word.dataset.word.toLowerCase() === gap.dataset.answer.toLowerCase();
                gap.classList.toggle('correct', isCorrect);
                gap.classList.toggle('incorrect', !isCorrect);
                if (isCorrect) { 
                    updateScore(10); 
                    playCorrectSound();
                    triggerRewardAnimation();
                    showFeedbackMessage(true); 
                } else { 
                    showFeedbackMessage(false); 
                }
                setTimeout(checkCompletionAndMark, 100);
            }
        }

        // --- Vocab Game Logic ---
        let vocabGameQuestions = [];
        let vocabGameCurrentIndex = 0;
        let vocabGameScore = 0;
        const ROUND_TIME = 10000; // 10 seconds

        function startVocabGame() {
            vocabGameQuestions = [...lessonData.vocabulary].sort(() => 0.5 - Math.random());
            vocabGameCurrentIndex = 0;
            vocabGameScore = 0;
            document.getElementById('vocab-game-score').textContent = '0';
            nextVocabGameRound();
        }

        function nextVocabGameRound() {
            if (vocabGameCurrentIndex >= vocabGameQuestions.length) {
                endVocabGame();
                return;
            }
            
            const question = vocabGameQuestions[vocabGameCurrentIndex];
            document.getElementById('vocab-game-definition').textContent = question.def;
            
            const options = [question.word];
            const wrongAnswers = lessonData.vocabulary.filter(v => v.word !== question.word);
            while (options.length < 4 && wrongAnswers.length > 0) {
                const randomWrong = wrongAnswers.splice(Math.floor(Math.random() * wrongAnswers.length), 1)[0];
                options.push(randomWrong.word);
            }
            
            const optionsContainer = document.getElementById('vocab-game-options');
            optionsContainer.innerHTML = '';
            options.sort(() => 0.5 - Math.random()).forEach(opt => {
                const button = document.createElement('button');
                button.className = 'quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200';
                button.textContent = opt;
                button.onclick = () => checkVocabGameAnswer(button, opt === question.word);
                optionsContainer.appendChild(button);
            });

            startRoundTimer();
        }
        
        function startRoundTimer() {
            clearTimeout(vocabGameTimer);
            const timerBar = document.getElementById('vocab-game-timer-bar');
            timerBar.style.transition = 'none';
            timerBar.style.width = '100%';
            
            setTimeout(() => {
                timerBar.style.transition = `width ${ROUND_TIME / 1000}s linear`;
                timerBar.style.width = '0%';
            }, 100);

            vocabGameTimer = setTimeout(() => {
                showFeedbackMessage(false);
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, ROUND_TIME);
        }

        function checkVocabGameAnswer(button, isCorrect) {
            clearTimeout(vocabGameTimer);
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                vocabGameScore++;
                updateScore(5);
                playCorrectSound();
                triggerRewardAnimation();
                document.getElementById('vocab-game-score').textContent = vocabGameScore;
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'text-white');
            } else {
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'text-white', 'shake');
            }
            
            const optionsContainer = document.getElementById('vocab-game-options');
            optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

            setTimeout(() => {
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, 1500);
        }

        function endVocabGame() {
            document.getElementById('vocab-game-definition').textContent = `Game Over! You scored ${vocabGameScore} out of ${vocabGameQuestions.length}.`;
            document.getElementById('vocab-game-options').innerHTML = `<button onclick="startVocabGame()" class="action-button bg-blue-500 text-white font-bold p-3 rounded-lg">Play Again</button>`;
            markSectionAsComplete('vocab-game');
        }


        function createPageElement(id, content) {
            const section = document.createElement('section');
            section.id = `page-${id}`;
            section.className = 'page';
            section.innerHTML = content;
            document.getElementById('dynamic-pages-container').appendChild(section);
        }
        
        function populateAllQuizzes() {
            // Reading Quizzes
            const readingGapFill = lessonData.pages.find(p => p.id === 'reading-quiz-gap-fill');
            if (readingGapFill) readingGapFill.content.sentences = [ { text: ['The old town center in Chefchaouen is called the', '.'], answer: 'Medina' }, { text: ['The local indigenous language of the region is', '.'], answer: 'Amazigh' }, { text: ["The city's unique", 'shows Spanish and Moorish influences.'], answer: 'architecture' }, { text: ["A feeling of belonging to a group based on shared traditions is called", '.'], answer: 'cultural identity' }, { text: ['Actions taken to protect an endangered language are known as', '.'], answer: 'linguistic activism' } ];
            const readingTfng = lessonData.pages.find(p => p.id === 'reading-quiz-tfng');
            if(readingTfng) readingTfng.content.questions = [ { statement: 'Chefchaouen is located on the coast of Morocco.', correctAnswer: 'False' }, { statement: 'The text suggests the blue color might help keep mosquitoes away.', correctAnswer: 'True' }, { statement: 'The city was founded by French colonists in the 20th century.', correctAnswer: 'False' }, { statement: "The text says that only Arabic is spoken in Chefchaouen.", correctAnswer: 'False' }, { statement: 'Place-based learning is used in local schools to connect lessons with culture.', correctAnswer: 'True' } ];
            const readingMcq = lessonData.pages.find(p => p.id === 'reading-quiz-mcq');
            if(readingMcq) readingMcq.content.questions = [ { question: 'What is Chefchaouen\'s nickname?', options: ['The Red City', 'The White Dove', 'The Blue Pearl', 'The Green Oasis'], correctAnswer: 'The Blue Pearl' }, { question: 'The tradition of painting walls blue is said to have been brought by which group?', options: ['Spanish explorers', 'Jewish refugees', 'French traders', 'Amazigh nomads'], correctAnswer: 'Jewish refugees' }, { question: 'What is "linguistic activism" in the context of the article?', options: ['A festival of languages', 'A law that forces people to speak a certain language', 'Efforts to protect and promote the Amazigh language', 'A style of poetry'], correctAnswer: 'Efforts to protect and promote the Amazigh language' }, { question: 'The historic old town center of a Moroccan city is called a:', options: ['Souk', 'Kasbah', 'Riad', 'Medina'], correctAnswer: 'Medina' }, { question: 'What is the goal of "place-based learning" as described in the text?', options: ['To make all lessons about geography', 'To help students value their local heritage', 'To encourage students to travel', 'To build more schools in the area'], correctAnswer: 'To help students value their local heritage' } ];

            // Class Lecture Quizzes
            const lectureMcq = lessonData.pages.find(p => p.id === 'lecture-quiz-mcq');
            if(lectureMcq) lectureMcq.content.questions = [
                { question: "Where is Chefchaouen located?", options: ['In the Atlas Mountains', 'In the Rif Mountains', 'On the Atlantic coast', 'Near the Sahara Desert'], correctAnswer: 'In the Rif Mountains' },
                { question: "What is a practical reason mentioned for painting the city blue?", options: ['It is the cheapest paint color.', 'It attracts tourists.', 'It keeps houses cool and repels mosquitoes.', 'It is the national color of Morocco.'], correctAnswer: 'It keeps houses cool and repels mosquitoes.' },
                { question: "Which group is credited with introducing the blue color for spiritual reasons?", options: ['Portuguese soldiers', 'Andalusian exiles', 'Jewish refugees', 'The Amazigh people'], correctAnswer: 'Jewish refugees' },
                { question: "What was the original purpose of Chefchaouen when it was founded in 1471?", options: ['A trading post', 'A royal palace', 'A religious center', 'A fortress against the Portuguese'], correctAnswer: 'A fortress against the Portuguese' },
                { question: "The architecture and culture of Chefchaouen show a strong influence from where?", options: ['France', 'Andalusia (Spain)', 'Sub-Saharan Africa', 'The Ottoman Empire'], correctAnswer: 'Andalusia (Spain)' }
            ];
            const lectureTfng = lessonData.pages.find(p => p.id === 'lecture-quiz-tfng');
            if(lectureTfng) lectureTfng.content.questions = [
                { statement: "The lecture states that the only reason the city is blue is to repel mosquitoes.", correctAnswer: 'False' },
                { statement: "Chefchaouen was founded in the 20th century.", correctAnswer: 'False' },
                { statement: "The city served as a refuge for both Muslim and Jewish exiles from Spain.", correctAnswer: 'True' },
                { statement: "The central square, Plaza Uta el-Hammam, is mentioned as an example of modern architecture.", correctAnswer: 'False' },
                { statement: "The professor believes the city's history is simple and involves only one culture.", correctAnswer: 'False' }
            ];
            const lectureGap = lessonData.pages.find(p => p.id === 'lecture-quiz-gap-fill');
            if(lectureGap) lectureGap.content.sentences = [
                { text: ["The city's blue color is its defining", '.'], answer: 'characteristic' },
                { text: ["According to one theory, the blue color has a", 'element tied to the sky and heaven.'], answer: 'spiritual' },
                { text: ["The city served as a strategic", 'point against invaders.'], answer: 'defense' },
                { text: ["The influx of people from Andalusia", 'shaped the city.'], answer: 'significantly' },
                { text: ["The Plaza Uta el-Hammam has a distinct", 'feel.'], answer: 'Andalusian' }
            ];
            
            // History & Economy Lecture Quizzes
            const lectureHistoryMcq = lessonData.pages.find(p => p.id === 'lecture-history-quiz-mcq');
            if(lectureHistoryMcq) lectureHistoryMcq.content.questions = [
                { question: "What was the initial purpose of Chefchaouen when founded in 1471?", options: ["A trading post", "A fortress", "A religious pilgrimage site", "A royal residence"], correctAnswer: "A fortress" },
                { question: "Which group is NOT mentioned as taking refuge in Chefchaouen after its founding?", options: ["Muslims from Spain", "Jews from Spain", "Portuguese invaders", "Refugees of the Reconquista"], correctAnswer: "Portuguese invaders" },
                { question: "What event in the 2010s transformed Chefchaouen's economy?", options: ["The discovery of natural resources", "A new agricultural revolution", "The rise of social media platforms", "A government investment program"], correctAnswer: "The rise of social media platforms" },
                { question: "For centuries, the region's economy was primarily based on what?", options: ["Tourism", "Fishing", "Manufacturing", "Traditional agriculture"], correctAnswer: "Traditional agriculture" },
                { question: "According to the most 'widely-cited' theory, why did Jewish refugees in the 1930s paint the city blue?", options: ["To repel mosquitoes", "To keep their homes cool", "To symbolize the sky and heaven", "It was the only color available"], correctAnswer: "To symbolize the sky and heaven" }
            ];
            const lectureHistoryTfng = lessonData.pages.find(p => p.id === 'lecture-history-quiz-tfng');
            if(lectureHistoryTfng) lectureHistoryTfng.content.questions = [
                { statement: "Chefchaouen is located in the southern part of Morocco.", correctAnswer: "False" },
                { statement: "The city was founded to defend against Spanish invaders.", correctAnswer: "False" },
                { statement: "The lecture mentions a theory that blue paint attracts birds.", correctAnswer: "Not Given" },
                { statement: "The city's economy has always been primarily based on tourism.", correctAnswer: "False" },
                { statement: "A massive increase in international tourism began around the year 2010.", correctAnswer: "True" }
            ];
            const lectureHistoryGap = lessonData.pages.find(p => p.id === 'lecture-history-quiz-gap-fill');
            if(lectureHistoryGap) lectureHistoryGap.content.sentences = [
                { text: ["The city is located in the", "Mountains of northwest Morocco."], answer: "Rif" },
                { text: ["It became a primary", "for people fleeing the Spanish Reconquista."], answer: "refuge" },
                { text: ["One practical theory suggests the blue color helps to", "mosquitoes."], answer: "repel" },
                { text: ["The city became a global tourism", "due to platforms like Instagram."], answer: "hotspot" },
                { text: ["Today, the local economy is directly", "on the thousands of tourists."], answer: "dependent" }
            ];

            // Tourism Paradox Lecture Quizzes
            const lectureTourismMcq = lessonData.pages.find(p => p.id === 'lecture-tourism-quiz-mcq');
            if(lectureTourismMcq) lectureTourismMcq.content.questions = [
                { question: "What is the 'essential question' the speaker asks listeners to consider?", options: ["Which shade of blue is the most beautiful?", "How to get the most likes on Instagram?", "How to balance tourism benefits with cultural preservation?", "What is the best local food to try?"], correctAnswer: "How to balance tourism benefits with cultural preservation?" },
                { question: "The most powerful story connects the blue walls to the ideas of survival and...", options: ["Aesthetics", "Wealth", "Faith", "Politics"], correctAnswer: "Faith" },
                { question: "Who are described as the indigenous people whose culture is the 'bedrock' of the region?", options: ["The Spanish", "The Jewish refugees", "The Moroccans", "The Berber people"], correctAnswer: "The Berber people" },
                { question: "What is a negative consequence of the city becoming 'Instagram famous'?", options: ["The paint is fading faster.", "It provides too much income for locals.", "It is becoming more like a theme park than a living community.", "There are not enough hotels for visitors."], correctAnswer: "It is becoming more like a theme park than a living community." },
                { question: "According to the speaker, what is the key takeaway for being a responsible visitor?", options: ["Only take photos in designated areas.", "Look beyond the photos and engage with the history and culture.", "Spend a lot of money in local shops.", "Visit during the off-season to avoid crowds."], correctAnswer: "Look beyond the photos and engage with the history and culture." }
            ];
            const lectureTourismTfng = lessonData.pages.find(p => p.id === 'lecture-tourism-quiz-tfng');
            if(lectureTourismTfng) lectureTourismTfng.content.questions = [
                { statement: "The speaker believes the blue color was originally just about making the city look good.", correctAnswer: "False" },
                { statement: "The Berber culture is described as the foundation of the region's identity.", correctAnswer: "True" },
                { statement: "The speaker says tourism has had no negative impact on the daily lives of residents.", correctAnswer: "False" },
                { statement: "The lecture suggests that tourists should stop taking photos in the city.", correctAnswer: "Not Given" },
                { statement: "A responsible visitor supports the community without overwhelming it.", correctAnswer: "True" }
            ];
            const lectureTourismGap = lessonData.pages.find(p => p.id === 'lecture-tourism-quiz-gap-fill');
            if(lectureTourismGap) lectureTourismGap.content.sentences = [
                { text: ["The medina is described as a", "of narrow alleyways."], answer: "labyrinth" },
                { text: ["For Jewish refugees, the blue color was a symbol of", ", representing a constant prayer."], answer: "divinity" },
                { text: ["The modern challenge the city faces is described as a", "."], answer: "paradox" },
                { text: ["Tourism provides vital", "for many local families."], answer: "income" },
                { text: ["The goal is to support the community without", "it."], answer: "overwhelming" }
            ];
            
            // Classroom Discussion Quizzes
            const discussionMcq = lessonData.pages.find(p => p.id === 'discussion-quiz-mcq');
            if(discussionMcq) discussionMcq.content.questions = [
                { question: "How does Emily describe her impression of Chefchaouen from online photos?", options: ["Busy and chaotic", "Like a dream", "Old and decaying", "Similar to other Moroccan cities"], correctAnswer: "Like a dream" },
                { question: "Besides the blue color, what aspect of Chefchaouen does Emily find appealing?", options: ["Its famous cuisine", "Its modern infrastructure", "Its relaxed and peaceful atmosphere", "Its bustling nightlife"], correctAnswer: "Its relaxed and peaceful atmosphere" },
                { question: "What concern does Oliver raise about the impact of tourism on Chefchaouen?", options: ["It makes the city too crowded.", "It causes prices to increase.", "The challenge of balancing tourism with local traditions.", "It leads to environmental pollution."], correctAnswer: "The challenge of balancing tourism with local traditions." },
                { question: "According to the professor, what historical group influenced Chefchaouen's culture?", options: ["French colonists", "Roman traders", "Ottoman governors", "Andalusian refugees"], correctAnswer: "Andalusian refugees" },
                { question: "What potential environmental challenge does Oliver mention for a mountain city like Chefchaouen?", options: ["Air pollution from factories", "Soil erosion from farming", "Water management and waste disposal", "Noise pollution from airports"], correctAnswer: "Water management and waste disposal" }
            ];
            const discussionTfng = lessonData.pages.find(p => p.id === 'discussion-quiz-tfng');
            if(discussionTfng) discussionTfng.content.questions = [
                { statement: "Oliver had never heard of or seen pictures of Chefchaouen before the class.", correctAnswer: "False" },
                { statement: "The professor states that the exact reason for the blue color is known and not debated.", correctAnswer: "False" },
                { statement: "Emily mentions that the mountain scenery around the city looks amazing.", correctAnswer: "True" },
                { statement: "The professor says that the local markets (souks) are a quiet part of the city.", correctAnswer: "False" },
                { statement: "The discussion concludes that tourism has had no negative challenges for Chefchaouen.", correctAnswer: "False" }
            ];
            const discussionGap = lessonData.pages.find(p => p.id === 'discussion-quiz-gap-fill');
            if(discussionGap) discussionGap.content.sentences = [
                { text: ["Emily describes the city's visual appearance as having an", "quality."], answer: "ethereal" },
                { text: ["The city's relaxed atmosphere feels less", "than larger Moroccan cities."], answer: "hectic" },
                { text: ["Managing the influx of tourists while preserving the city's unique character is a delicate", "act."], answer: "balancing" },
                { text: ["Oliver suggests that", "management could be a challenge with more tourists."], answer: "waste" },
                { text: ["The city is striving to balance its unique charm with the", "of the modern world."], answer: "demands" }
            ];
        }

        function initializeLesson() {
            document.getElementById('main-title').innerHTML = lessonData.title;
            document.getElementById('main-subtitle').innerHTML = lessonData.subtitle;
            document.getElementById('main-svg-container').innerHTML = `<svg viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="grad-blue" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect width="600" height="300" fill="#eff6ff"/>
                <path d="M 200 300 L 200 120 Q 300 80 400 120 L 400 300 Z" fill="url(#grad-blue)"/>
                <rect x="250" y="200" width="100" height="100" fill="#dbeafe"/>
                <circle cx="300" cy="160" r="30" fill="#dbeafe"/>
                <text x="50%" y="50" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="48" fill="#1e3a8a" font-weight="bold">The Blue Pearl</text>
            </svg>`;

            populateAllQuizzes();
            buildPageToMenuMap();

            const menuButtons = lessonData.mainMenu.map(item => {
                const colors = { green: 'bg-green-500 border-green-700', blue: 'bg-blue-500 border-blue-700', sky: 'bg-sky-500 border-sky-700', amber: 'bg-amber-500 border-amber-700', rose: 'bg-rose-500 border-rose-700', violet: 'bg-violet-500 border-violet-700', teal: 'bg-teal-500 border-teal-700', orange: 'bg-orange-500 border-orange-700', indigo: 'bg-indigo-500 border-indigo-700', lime: 'bg-lime-500 border-lime-700', emerald: 'bg-emerald-500 border-emerald-700', red: 'bg-red-500 border-red-700', purple: 'bg-purple-500 border-purple-700' };
                return `<button id="menu-btn-${item.id}" onclick="navigateTo('${item.target}')" class="btn-animated-3d ${colors[item.color] || colors['green']} text-white font-bold text-xl p-4 rounded-xl">${item.text}</button>`;
            }).join('');
            createPageElement(lessonData.homePageId, `<div class="bg-white rounded-2xl shadow-lg p-8"><h2 class="text-4xl font-bold text-center text-slate-800 mb-8">Main Menu</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${menuButtons}</div></div>`);
            
            const pageOrderMap = { 
                'warm-up': ['vocab-start'], 
                'vocab-start': lessonData.vocabulary.map((v, i) => `vocab-${i}`), 
                'reading-main': ['reading-quiz-gap-fill', 'reading-quiz-tfng', 'reading-quiz-mcq'], 
                'lecture-pre': ['lecture-main', 'lecture-quiz-mcq', 'lecture-quiz-tfng', 'lecture-quiz-gap-fill'],
                'lecture-history-pre': ['lecture-history-main', 'lecture-history-quiz-mcq', 'lecture-history-quiz-tfng', 'lecture-history-quiz-gap-fill'],
                'lecture-tourism-pre': ['lecture-tourism-main', 'lecture-tourism-quiz-mcq', 'lecture-tourism-quiz-tfng', 'lecture-tourism-quiz-gap-fill'],
                'discussion-pre': ['discussion-main', 'discussion-quiz-mcq', 'discussion-quiz-tfng', 'discussion-quiz-gap-fill'],
                'final-project-hub': ['writing-task', 'self-assessment', 'certificate'] 
            };
            let flatPageList = [lessonData.startPageId];
            lessonData.mainMenu.forEach(item => {
                let queue = [item.target];
                let visited = new Set();
                while(queue.length > 0) {
                    let current = queue.shift();
                    if (visited.has(current)) continue;
                    visited.add(current);
                    flatPageList.push(current);
                    if (pageOrderMap[current]) {
                        queue.push(...pageOrderMap[current]);
                    }
                }
            });
            pageSequence = [...new Set(flatPageList)];

            lessonData.vocabulary.forEach((v, i) => {
                createPageElement(`vocab-${i}`, `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h3 class="text-2xl font-bold text-sky-600 mb-2">Vocabulary ${i + 1} / ${lessonData.vocabulary.length}</h3><div class="my-8"><h2 class="text-5xl font-bold text-gray-800 mb-4">${v.word}</h2><p class="text-2xl text-gray-600 mb-4">${v.def}</p><p class="text-xl text-gray-500 italic">"${v.sentence}"</p></div></div></div>`);
            });

            lessonData.pages.forEach(page => {
                let pageHTML = '';
                switch (page.type) {
                    case 'simple': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-gray-800 mb-6">${page.content.title}</h2><p class="text-xl text-gray-600 mb-8">${page.content.text}</p></div></div>`; break;
                    case 'timer': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-left pt-16"><div class="w-full flex justify-between items-center mb-4"><h2 class="text-2xl md:text-3xl font-bold text-blue-700">${page.content.title}</h2><div id="${page.content.timerId}" class="text-3xl md:text-4xl font-bold text-gray-700 ml-4"></div></div><div class="readable-content"><p class="text-lg md:text-xl text-gray-600 mt-8">${page.content.text}</p></div></div>`; break;
                    case 'dialogue':
                    case 'html-content':
                        const contentHTML = page.type === 'html-content' ? page.content.html : (page.content.dialogue || '').split('\n').map(line => `<p class="mb-2">${line.replace(/([^:]+):/, '<strong class="font-semibold text-blue-700">$1:</strong>')}</p>`).join('');
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-slate-800 mb-6">${page.content.title}</h2><div class="readable-content text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg max-h-[70vh] overflow-y-auto">${contentHTML}</div></div>`;
                        break;
                    case 'vocab-game':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-sky-600 mb-4">${page.content.title}</h2><div class="text-center mb-4 text-lg">Score: <span id="vocab-game-score" class="font-bold">0</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mb-4"><div id="vocab-game-timer-bar" class="bg-blue-600 h-2.5 rounded-full"></div></div><div id="vocab-game-definition" class="text-center text-2xl font-semibold my-6 min-h-[6rem]"></div><div id="vocab-game-options" class="grid grid-cols-2 gap-4"></div></div>`;
                        break;
                    case 'writing-task':
                        const startersHTML = page.content.starters.map(s => `<li class="text-gray-500">${s}</li>`).join('');
                        const wordBankHTML = page.content.wordBank ? `<div class="mt-6"><h4 class="font-bold text-lg text-violet-600">Word Bank:</h4><div class="flex flex-wrap gap-2 mt-2 p-4 bg-gray-100 rounded-lg">${page.content.wordBank.map(w => `<span class="bg-white px-2 py-1 rounded-md shadow-sm text-gray-700">${w}</span>`).join('')}</div></div>` : '';
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-center text-violet-700 mb-6">${page.content.title}</h2><div class="text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg"><h3 class="font-bold text-xl text-violet-600">Prompt:</h3><p>${page.content.prompt}</p><h3 class="font-bold text-xl text-violet-600 mt-4">Sentence Starters:</h3><ul class="list-disc list-inside ml-4">${startersHTML}</ul>${wordBankHTML}</div></div><div class="text-center mt-6"><button onclick="goNext()" class="action-button bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-xl hover:bg-blue-700">Continue</button></div></div>`;
                        break;
                    case 'certificate':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16 relative overflow-hidden"><canvas id="completion-canvas"></canvas><div class="relative z-10"><div class="readable-content"><h2 class="text-4xl font-bold text-amber-600 mb-4">${page.content.title}</h2><p class="text-xl text-gray-600 mb-6">${page.content.text}</p></div><div id="certificate-to-print" class="bg-blue-50 border-4 border-dashed border-blue-300 rounded-lg p-8 max-w-2xl mx-auto"><div class="flex justify-center mb-4"><span class="text-6xl"><span aria-hidden="true">🇲🇦</span></span></div><h3 class="text-3xl font-bold text-slate-800">${page.content.certificateTitle}</h3><p class="mt-4 text-lg">This certificate is awarded to</p><p id="certificate-name" class="text-2xl font-bold text-blue-600 my-2 border-b-2 border-gray-400 pb-2">[Enter Your Name Here]</p><p class="mt-4 text-lg">for successfully completing this lesson.</p><p class="mt-6 text-md"><strong>Final Score:</strong> <span id="certificate-score" class="font-bold"></span> points</p><p class="text-sm mt-1"><strong>Date of Completion:</strong> <span id="certificate-date"></span></p></div><div id="cert-controls" class="mt-6"><div id="cert-initial-controls"><input type="text" id="name-input-cert" placeholder="Enter your name for the certificate" class="text-center p-2 border rounded-lg w-full max-w-md"><button onclick="generateCertificate()" class="action-button mt-4 bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700">Generate Certificate</button></div><div id="cert-generated-controls" class="hidden mt-4 flex flex-wrap justify-center gap-4"><button onclick="downloadCertificateAsImage()" class="action-button bg-sky-600 text-white font-bold py-2 px-4 rounded-full text-sm">Download Image</button></div></div></div></div>`;
                        break;
                    case 'quiz-tfng':
                    case 'quiz-mcq':
                    case 'quiz-gap-fill':
                        let questionsHTML = '';
                        if (page.type === 'quiz-tfng' && page.content.questions) {
                            questionsHTML = page.content.questions.map((q, i) => `<div class="question-group flex items-center gap-4 p-4 rounded-lg bg-gray-100"><div class="flex-shrink-0 flex gap-2">${['True', 'False', 'Not Given'].map(l => `<button onclick="checkTfngAnswer(this, '${l}', '${q.correctAnswer}')" class="tfng-button bg-${l==='True'?'blue':l==='False'?'red':'gray'}-500 text-white font-bold w-12 h-10 rounded-full">${l.charAt(0)}</button>`).join('')}</div><p>${i + 1}. ${q.statement}</p></div>`).join('');
                        } else if (page.type === 'quiz-mcq' && page.content.questions) {
                            questionsHTML = page.content.questions.map((q, i) => `<div class="question-group ${i > 0 ? 'border-t pt-6 mt-6' : ''}"><p class="font-semibold mb-2">${i + 1}. ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-2">${q.options.map(o => `<button onclick="checkMcqAnswer(this, '${o.replace(/'/g, "\\'")}' === '${q.correctAnswer.replace(/'/g, "\\'")}')" data-correct="${o === q.correctAnswer}" class="quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200">${o}</button>`).join('')}</div></div>`).join('');
                        } else if (page.type === 'quiz-gap-fill' && page.content.sentences) {
                            const words = page.content.sentences.map(s => s.answer).sort(() => Math.random() - 0.5);
                            questionsHTML = `<div class="gap-fill-container">${page.content.sentences.map((s, i) => `<p class="text-lg mb-4">${i + 1}. ${s.text[0]} <span class="gap" data-answer="${s.answer}"></span> ${s.text[1]}</p>`).join('')}</div><div class="word-bank-container mt-8 p-4 bg-gray-100 rounded-lg flex flex-wrap gap-4 justify-center">${words.map(w => `<div class="word-bank-word" draggable="true" data-word="${w}">${w}</div>`).join('')}</div>`;
                        }
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h3 class="text-3xl font-bold text-rose-600 mb-6 text-center">${page.content.title}</h3><div class="space-y-6">${questionsHTML}</div></div>`;
                        break;
                }
                if (pageHTML) {
                    createPageElement(page.id, pageHTML);
                    if (page.type === 'quiz-gap-fill') initGapFill(`page-${page.id}`);
                }
            });
            updateNavButtons();
        }

        function generateCertificate() {
            const name = document.getElementById('name-input-cert').value || 'Dedicated Student';
            document.getElementById('certificate-name').textContent = name;
            document.getElementById('certificate-score').textContent = score;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
            document.getElementById('cert-initial-controls').classList.add('hidden');
            document.getElementById('cert-generated-controls').classList.remove('hidden');

            const canvas = document.getElementById('completion-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            let particles = [];
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 5 + 2,
                    color: ['#fde047', '#f97316', '#fb923c', '#fed7aa'][Math.floor(Math.random() * 4)],
                    speed: Math.random() * 2 + 1
                });
            }

            function drawConfetti() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.y += p.speed;
                    if (p.y > canvas.height) {
                        p.y = -p.radius;
                        p.x = Math.random() * canvas.width;
                    }
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                });
                requestAnimationFrame(drawConfetti);
            }
            drawConfetti();
        }

        function downloadCertificateAsImage() {
            html2canvas(document.querySelector("#certificate-to-print")).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Chefchaouen_Certificate.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            initializeLesson();
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            let particles = [];
            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                particles.forEach((p, i) => {
                    p.y -= p.speed;
                    if (p.y < -p.radius) particles.splice(i, 1);
                    bgCtx.beginPath();
                    bgCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    bgCtx.fillStyle = p.color;
                    bgCtx.fill();
                });
                if (Math.random() > 0.95 && particles.length < 50) {
                    particles.push({ 
                        x: Math.random() * bgCanvas.width, 
                        y: bgCanvas.height + 20, 
                        radius: Math.random() * 8 + 2, 
                        speed: Math.random() * 1 + 0.5, 
                        color: `rgba(255, 255, 255, ${Math.random() * 0.2 + 0.1})`
                    });
                }
                requestAnimationFrame(animateBackground);
            }
            window.addEventListener('resize', () => { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; });
            animateBackground();
        });
    </script>
</body>
</html>
