<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatic Food Emoji Championship</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", 'Arial', sans-serif;
            background: #1a1a1a;
            color: #ffde7d;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Food Background */
        .food-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.4;
            background: linear-gradient(135deg, #ff8c00, #ff4500, #d2691e);
        }

        .food-bubble {
            position: absolute;
            bottom: -50px;
            font-size: 24px;
            animation: foodFloat linear infinite;
            opacity: 0.7;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        @keyframes foodFloat {
            0% { transform: translateY(50px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.7; }
            90% { opacity: 0.7; }
            100% { transform: translateY(-105vh) rotate(360deg); opacity: 0; }
        }

        /* Game Container */
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            position: relative;
            z-index: 10;
        }

        /* Game Progress */
        .game-progress {
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #ffde7d;
            text-align: center;
        }

        .progress-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .progress-item {
            font-size: 1.1rem;
            font-weight: bold;
            text-shadow: 0 0 10px #ffde7d;
        }

        .phase-indicator {
            font-size: 1.3rem;
            color: #ffb703;
            text-shadow: 0 0 15px #ffb703;
        }

        /* Game Modes */
        .game-modes {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            margin: 5rem 0;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 1.2rem 2.5rem;
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ffde7d, #ffb703);
            color: #000;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 222, 125, 0.5);
        }

        .mode-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 222, 125, 0.8);
        }
        
        /* Learning Mode */
        .learning-mode {
            display: none;
            text-align: center;
            background: rgba(255, 183, 3, 0.1);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid #ffde7d;
        }

        .learning-card {
            background: rgba(0,0,0,0.8);
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem auto;
            max-width: 450px;
            border: 2px solid #ffde7d;
            box-shadow: 0 0 30px rgba(255, 222, 125, 0.3);
        }

        .learning-emoji {
            font-size: 6rem;
            margin-bottom: 1rem;
            animation: emojiPulse 2s ease-in-out infinite;
        }

        @keyframes emojiPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .learning-text {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px #ffde7d;
        }

        .learning-progress {
            width: 100%;
            height: 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .learning-progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #ffde7d, #ffb703);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        /* Team Setup */
        .team-setup {
            display: none;
            text-align: center;
            background: rgba(255, 183, 3, 0.1);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid #ffde7d;
        }

        .teams-display {
            display: flex;
            justify-content: space-between;
            gap: 2rem;
            margin-top: 1rem;
        }

        .team {
            flex: 1;
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            padding: 1.5rem;
            border: 2px solid #ffde7d;
        }

        .team h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px #ffde7d;
        }

        .team-member {
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: rgba(255, 183, 3, 0.2);
            border-radius: 10px;
            font-size: 1rem;
        }

        /* Player Selection */
        .player-selection {
            display: none;
            text-align: center;
            background: rgba(255, 183, 3, 0.1);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid #ffde7d;
        }

        .slot-machine {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 2rem;
            margin: 1.5rem auto;
        }
        
        .player-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .team-slot-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px #ffb703;
            min-height: 20px;
        }

        .slot-reel {
            width: 250px;
            height: 250px;
            border: 5px solid #ffde7d;
            border-radius: 15px;
            background: rgba(0,0,0,0.8);
            overflow: hidden;
            position: relative;
        }

        .slot-window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 100px;
            background: rgba(0,0,0,0.8);
            border: 2px solid #ffde7d;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            z-index: 10;
            padding: 10px;
            word-wrap: break-word;
        }

        .slot-strip {
            position: absolute;
            width: 100%;
            transition: transform 3s ease-out;
        }

        .slot-item {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            color: #ffde7d;
            text-align: center;
            padding: 0 10px;
            border-bottom: 1px solid rgba(255, 183, 3, 0.3);
        }

        /* Game Play */
        .game-play { display: none; }

        .game-status {
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #ffde7d;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .round-info { font-size: 1.3rem; font-weight: bold; text-shadow: 0 0 10px #ffde7d; }
        .card-counter { font-size: 1.2rem; color: #ffb703; text-shadow: 0 0 10px #ffb703; }
        .game-area { display: flex; justify-content: space-between; align-items: stretch; gap: 1rem; }

        .versus-indicator {
            font-size: 3rem;
            font-weight: bold;
            color: #ffb703;
            text-shadow: 0 0 15px #ff8c00;
            animation: bonusPulse 1.5s ease-in-out infinite;
            align-self: center;
        }

        .team-game-area { flex: 1; display: flex; flex-direction: column; gap: 1rem; position: relative; }
        
        .team-score-display {
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            padding: 0.5rem;
            border: 2px solid #ffde7d;
            text-align: center;
        }

        .team-score-display .team-name { font-size: 1.1rem; font-weight: bold; }
        .team-score-display .score-number { font-size: 2rem; color: #ffb703; text-shadow: 0 0 15px #ffb703; }

        .player-area {
            flex: 1;
            background: rgba(0,0,0,0.8);
            border-radius: 20px;
            padding: 1.5rem;
            border: 2px solid #ffde7d;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative; /* This is the key fix */
        }

        .player-name { 
            font-size: 1.4rem; 
            font-weight: bold; 
            margin-top: 1rem; 
            text-shadow: 0 0 10px #ffde7d;
            min-height: 40px; 
        }
        .emoji-display { font-size: 5rem; margin-bottom: 1rem; animation: emojiFloat 3s ease-in-out infinite; }
        @keyframes emojiFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }

        .answer-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .answer-btn {
            padding: 0.8rem; font-size: 1rem; font-weight: bold;
            background: linear-gradient(45deg, rgba(255, 183, 3, 0.3), rgba(251, 133, 0, 0.3));
            color: #ffde7d; border: 2px solid #ffde7d; border-radius: 10px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .answer-btn:hover { background: linear-gradient(45deg, rgba(255, 183, 3, 0.6), rgba(251, 133, 0, 0.6)); transform: scale(1.05); }
        .answer-btn.correct { background: linear-gradient(45deg, #ffde7d, #ffb703); color: #000; animation: correctPulse 0.5s ease; }
        .answer-btn.incorrect { background: linear-gradient(45deg, #ff0040, #ff4060); color: #fff; animation: incorrectShake 0.5s ease; }
        @keyframes correctPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        @keyframes incorrectShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

        .praise-word, .point-badge {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 1.8rem; font-weight: bold;
            z-index: 100; pointer-events: none; animation: praise-animation 2.5s ease-out forwards;
            line-height: 1.4;
            width: 100%;
            text-align: center;
        }
        .point-badge { font-size: 2rem; color: #ffb703; text-shadow: 0 0 10px #ff8c00; top: 15%; }
        @keyframes praise-animation { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -200%) scale(1.2); opacity: 0; } }

        .encouragement-phrase {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 1.5rem; font-weight: bold;
            z-index: 100; pointer-events: none; animation: encouragement-animation 2s ease-out forwards;
            color: #ffb703; text-shadow: 0 0 10px #ff8c00; text-align: center; width: 80%;
        }
        @keyframes encouragement-animation {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
            80% { transform: translate(-50%, -100%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -120%) scale(1); opacity: 0; }
        }

        /* Timer */
        .timer-container { margin: 1rem 0; text-align: center; }
        .timer-display { font-size: 2.5rem; font-weight: bold; color: #ffb703; text-shadow: 0 0 20px #ffb703; margin-bottom: 0.5rem; }
        .timer-bar { width: 100%; height: 15px; background: rgba(0,0,0,0.5); border-radius: 10px; overflow: hidden; border: 2px solid #ffde7d; }
        .timer-progress { height: 100%; background: linear-gradient(45deg, #ffb703, #ff8c00); transition: width 0.1s linear; border-radius: 10px; }

        /* Fireworks */
        .fireworks-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
        .firework { position: absolute; width: 6px; height: 6px; border-radius: 50%; animation: fireworkExplode 2s ease-out forwards; }
        @keyframes fireworkExplode { 0% { transform: scale(0); opacity: 1; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }

        /* Certificate */
        .certificate {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #000; padding: 3rem; border-radius: 20px; text-align: center;
            border: 5px solid #ff8c00; box-shadow: 0 0 50px rgba(255,215,0,0.8);
            z-index: 2000; max-width: 600px;
        }

        .player-area.correct-answer-glow {
            animation: glow 1.5s ease-out;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px #ffde7d, 0 0 10px #ffb703; }
            50% { box-shadow: 0 0 20px #ffde7d, 0 0 40px #ffb703, 0 0 60px #ff8c00; }
            100% { box-shadow: 0 0 5px #ffde7d, 0 0 10px #ffb703; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .game-area, .teams-display, .progress-info, .game-status, .game-modes, .slot-machine { flex-direction: column; }
            .mode-btn { padding: 1rem 2rem; font-size: 1.2rem; }
        }

        /* Bonus Round Styles */
        .bonus-indicator { font-size: 1.8rem; font-weight: bold; color: #ff0040; text-shadow: 0 0 20px #ff0040; animation: bonusPulse 1s ease-in-out infinite; }
        @keyframes bonusPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Phase Transition */
        .phase-transition {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: rgba(0,0,0,0.9);
            color: #ffde7d; padding: 3rem; border-radius: 20px; text-align: center;
            border: 3px solid #ffde7d; box-shadow: 0 0 50px rgba(255, 222, 125, 0.8);
            z-index: 1500; font-size: 2rem; font-weight: bold; text-shadow: 0 0 20px #ffde7d;
        }
        
        /* Sparkle Effect */
        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: yellow;
            border-radius: 50%;
            pointer-events: none;
            z-index: 200;
            opacity: 0;
            animation: sparkle-animation 1s ease-out forwards;
            box-shadow: 0 0 10px yellow, 0 0 20px gold;
        }
        @keyframes sparkle-animation {
            0% { transform: translate(0, 0) scale(0.5); opacity: 1; }
            100% { transform: translate(var(--x), var(--y)) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Backgrounds and Effects -->
    <div class="food-bg" id="foodBg"></div>
    <div class="fireworks-container" id="fireworksContainer"></div>
    <div class="phase-transition" id="phaseTransition"><div id="transitionText"></div></div>

    <div class="game-container">
        <!-- Game Progress (shown after start) -->
        

        <!-- Grade Selection (Start Screen) -->
        <div class="game-modes" id="gameModes">
            <button class="mode-btn" onclick="selectGradeAndStart(10)">Grade 10</button>
            <button class="mode-btn" onclick="selectGradeAndStart(11)">Grade 11</button>
            <button class="mode-btn" onclick="selectGradeAndStart(12)">Grade 12</button>
        </div>

        <!-- All other game sections are hidden by default -->
        <div id="game-content" style="display: none;">
            <!-- Team Setup -->
            <div class="team-setup" id="teamSetup">
                <h2 style="font-size: 2rem; margin-bottom: 1rem; text-shadow: 0 0 15px #ffde7d;">üë• Team Formation</h2>
                <div class="teams-display">
                    <div class="team"><h3 id="team1Name"></h3><div id="team1Members"></div></div>
                    <div class="team"><h3 id="team2Name"></h3><div id="team2Members"></div></div>
                </div>
            </div>

            <!-- Learning Mode -->
            <div class="learning-mode" id="learningMode">
                <h2 style="font-size: 2rem; margin-bottom: 1rem; text-shadow: 0 0 15px #ffde7d;">üìñ Learning: <span id="learningSetName">Breakfast</span></h2>
                <div class="learning-card">
                    <div class="learning-emoji" id="learningEmoji"></div>
                    <div class="learning-text" id="learningText"></div>
                </div>
                <div class="learning-progress"><div class="learning-progress-bar" id="learningProgressBar" style="width: 0%"></div></div>
                <p style="margin-top: 1rem; font-size: 1rem;">Progress: <span id="learningCounter">0</span> / <span id="totalLearningItems">0</span></p>
            </div>

            <!-- Player Selection -->
            <div class="player-selection" id="playerSelection">
                <h2 style="font-size: 2rem; margin-bottom: 1rem; text-shadow: 0 0 15px #ffde7d;">üé∞ Player Selection</h2>
                <div class="slot-machine">
                    <div class="player-column">
                        <h3 id="slot1TeamName" class="team-slot-title"></h3>
                        <div class="slot-reel">
                            <div class="slot-window" id="slot1Window">---</div>
                            <div class="slot-strip" id="slot1Strip"></div>
                        </div>
                    </div>
                    <div class="player-column">
                        <h3 id="slot2TeamName" class="team-slot-title"></h3>
                        <div class="slot-reel">
                            <div class="slot-window" id="slot2Window">---</div>
                            <div class="slot-strip" id="slot2Strip"></div>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem; font-size: 1.2rem; color: #ffb703;">
                    <div id="selectionCountdown">Game starts in <span id="countdownTimer">10</span>s...</div>
                </div>
            </div>


            <!-- Game Play -->
            <div class="game-play" id="gamePlay">
                <div class="game-area">
                    <div class="team-game-area" id="team1GameArea">
                        <div class="player-area">
                            <div class="emoji-display" id="player1Emoji"></div>
                            <div class="answer-buttons" id="player1Buttons"></div>
                            <div class="player-name" id="player1Name"></div>
                            <div class="team-score-display" style="margin-top: 1rem;">
                                <div class="team-name" id="gameTeam1Name"></div>
                                <div class="score-number" id="team1Score">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="versus-indicator">VS</div>
                    <div class="team-game-area" id="team2GameArea">
                        <div class="player-area">
                            <div class="emoji-display" id="player2Emoji"></div>
                            <div class="answer-buttons" id="player2Buttons"></div>
                            <div class="player-name" id="player2Name"></div>
                            <div class="team-score-display" style="margin-top: 1rem;">
                                <div class="team-name" id="gameTeam2Name"></div>
                                <div class="score-number" id="team2Score">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="game-status"><div class="round-info" id="roundInfo"></div></div>
                <div class="timer-container"><div class="timer-display" id="timerDisplay">7</div><div class="timer-bar"><div class="timer-progress" id="timerProgress"></div></div></div>
            </div>
        </div>
    </div>

    <!-- Certificate -->
    <div class="certificate" id="certificate">
        <h2>üèÜ FOOD CHAMPIONSHIP CERTIFICATE üèÜ</h2>
        <div class="certificate-content">
            <p>This certifies that</p>
            <div class="winning-team" id="certificateTeam"></div>
            <p>has won the <strong>FOOD EMOJI CHAMPIONSHIP</strong></p>
            <div class="final-score" id="certificateScore"></div>
            <div id="certificateMembers" style="margin: 1rem 0; font-weight: bold;"></div>
        </div>
        <div class="certificate-date" id="certificateDate"></div>
        <button class="mode-btn" onclick="resetGame()" style="margin-top: 2rem;">üîÑ Play Again</button>
    </div>

    <script>
        // Player Data
        const grade10Players = ["ÂÜØÂ•ïÂ∞ò / Feng, Yichen", "ÈªÑËã•Ê∂µ / Huang, Ruohan", "Êùé‰∏∞Â±π / Li, Fengyi", "ÊùéÈπèÊΩû / Li, Penglu", "Ê¢ÅÈî¶Â§© / Ling, Jintian", "ÂàòÊôØÊâ¨ / Liu, Jingyang", "Èæô‰øäÂøó / Long, Junzhi", "È©¨Ëµ´ / Ma, He", "ËÅÇÊ∫™Â∫∑ / Nie, Xikang", "Â∫û‰∫ëËîö / Pang, Yunwei", "Êõ≤ÂÆ∂Áëû / Qu, Jiarui", "Â≠ôËØóÁ´• / Sun, Shitong", "ÁéãÂ≠êË®Ä / Wang, Ziyan", "Êù®Êô¥Áè∫ / Yang, Qingjun", "Âº†ÂÆ∏ÊÅ∫ / Zhang, Chenkai", "ËµµÊµ©Êñá / Zhao, Haowen"];
        const grade11Players = ["ÈôàÂ≥ªÂºò / Chen, Junhong", "Èü©ÁùøÈõÑ / Han, Ruixiong", "‰ΩïÊÄ°Êïè / He, Yimin", "Â∫∑Ëâ∫Ëä∏ / Kang, Yiyun", "ÊùéÈõ®Èúè / Li, Yufei", "ÊùéÊ≤æË°£ / Li, Zhanyi", "ÂàòÂúÉË®Ä / Liu, Puyan", "Â∫ûÊ≥ΩÈúñ / Pang, Zelin", "ÁéãÊ¢ìÊôó / Wang, Zihan", "Â∞π‰πùÊÄù / Yin, Jiusi", "Ê∏∏È°πÈõØ / You, Xiangwen", "‰∫éÊµöÂì≤ / Yu, Junzhe", "ËáßÂßùÂ©∑ / Zang, Shuting", "Âº†ÊæúÈ¶® / Zhang, Lanxin"];
        const grade12Players = ["ÂÆâÊîøËÅø / An, Zhengyu", "Ëî°Â≠êÂ¢® / Cai, Zimo", "ÂàòÈïáÊ¶ï / Liu, Zhenrong", "È©¨Áü•Ë°å / Ma, Zhixing", "ÈÇ±Â§© / Qiu, Tian", "ÁõõÊÄùËØ≠ / Sheng, Siyu", "ÂîêÂèØÁõà / Tang, Keying", "Áî∞Â≠êÂá° / Tian, Zifan", "Ë∞¢ÊñØÈ£û / Xie, Sifei", "Êù®Âä†È∫í / Yang, Jiaqi", "Âº†Á®ãÁöì / Zhang, Chenghao", "ËµµÊô®ËææÈë´ / Zhao, Chendaxin", "Âë®ÈÄ∏Âá° / Zhou, Yifan"];
        let playerNames = [];

        // Game Data
        const mealSets = [
            { name: "üçΩ Monday Menu", items: [
                { emoji: "ü•û", name: "Buttermilk Pancakes with Maple Syrup" }, // Brunch
                { emoji: "üçì", name: "Fresh Strawberry Bowl" }, // Fruits
                { emoji: "‚òï", name: "Brewed Black Coffee" }, // Beverages
                { emoji: "üçî", name: "Cheeseburger with Lettuce & Tomato" }, // Savory Mains
                { emoji: "üç£", name: "Salmon Nigiri" }, // International
                { emoji: "üêü", name: "Pan-Seared Fish with Herbs" }, // Other Mains
                { emoji: "üç¶", name: "Vanilla Ice Cream Cone" }, // Desserts
                { emoji: "üç´", name: "Dark Chocolate Bar" } // Sweets
            ]},
            { name: "üçΩ Tuesday Menu", items: [
                { emoji: "üßá", name: "Belgian Waffles with Whipped Cream" },
                { emoji: "üçå", name: "Banana Slices with Honey" },
                { emoji: "ü•õ", name: "Cold Glass of Milk" },
                { emoji: "üçï", name: "Pepperoni Pizza Slice" },
                { emoji: "üê†", name: "Grilled Whitefish Fillet" },
                { emoji: "üçù", name: "Spaghetti Bolognese" },
                { emoji: "üçß", name: "Shaved Ice with Syrup" },
                { emoji: "üç¨", name: "Assorted Candies" }
            ]},
            { name: "üçΩ Wednesday Menu", items: [
                { emoji: "üç≥", name: "Classic Fried Eggs" },
                { emoji: "üçá", name: "Chilled Grape Cup" },
                { emoji: "üßÉ", name: "Mixed Fruit Juice" },
                { emoji: "ü•™", name: "Turkey & Cheese Sandwich" },
                { emoji: "ü¶ë", name: "Stir-Fried Squid" },
                { emoji: "üçõ", name: "Chicken Curry with Rice" },
                { emoji: "üç®", name: "Chocolate Sundae" },
                { emoji: "üç≠", name: "Rainbow Lollipop" }
            ]},
            { name: "üçΩ Thursday Menu", items: [
                { emoji: "ü•ì", name: "Crispy Bacon Strips" },
                { emoji: "üçé", name: "Apple Segments" },
                { emoji: "üçµ", name: "Green Tea" },
                { emoji: "ü•ó", name: "Garden Salad with Vinaigrette" },
                { emoji: "ü¶ê", name: "Garlic Butter Shrimp" },
                { emoji: "üçó", name: "Roasted Chicken Drumstick" },
                { emoji: "üç©", name: "Glazed Donut" },
                { emoji: "üçÆ", name: "Caramel Flan" }
            ]},
            { name: "üçΩ Friday Menu", items: [
                { emoji: "ü•ê", name: "Buttered French Croissant" },
                { emoji: "üçâ", name: "Watermelon Wedges" },
                { emoji: "üßã", name: "Brown Sugar Bubble Tea" },
                { emoji: "üåÆ", name: "Beef Tacos with Salsa" },
                { emoji: "ü¶™", name: "Fresh Oysters on Ice" },
                { emoji: "ü•©", name: "Grilled Ribeye Steak" },
                { emoji: "üç™", name: "Chocolate Chip Cookies" },
                { emoji: "üçØ", name: "Honey Drizzle" }
            ]},
            { name: "üçΩ Saturday Menu", items: [
                { emoji: "ü•ñ", name: "Rustic Baguette with Jam" },
                { emoji: "üçä", name: "Orange Segments" },
                { emoji: "üçπ", name: "Morning Citrus Cooler" },
                { emoji: "üçü", name: "Golden French Fries" },
                { emoji: "ü¶û", name: "Lobster Tail with Lemon Butter" },
                { emoji: "ü•ü", name: "Pork Dumplings" },
                { emoji: "üéÇ", name: "Birthday Cake Slice" },
                { emoji: "ü•ú", name: "Roasted Peanuts" }
            ]},
            { name: "üçΩ Sunday Menu", items: [
                { emoji: "ü•£", name: "Oatmeal with Berries" },
                { emoji: "üçç", name: "Pineapple Chunks" },
                { emoji: "üç∑", name: "Mocktail" },
                { emoji: "ü•®", name: "Salted Soft Pretzel" },
                { emoji: "ü•ô", name: "Falafel Pita Wrap" },
                { emoji: "ü•†", name: "Fortune Cookie" },
                { emoji: "üç∞", name: "Strawberry Shortcake" },
                { emoji: "ü´ò", name: "Baked Beans" }
            ]}
        ];
        
        const praisePhrases = [
            "The cake is golden-brown on top.",
            "Her salad looks vibrant with red tomatoes and green cucumbers.",
            "The soup smells aromatic with fresh herbs.",
            "The cheese is pungent, but tasty.",
            "This lemonade is tangy and sweet.",
            "The curry is rich with spices.",
            "Dark chocolate tastes bitter but smooth.",
            "The chips are crunchy and salty.",
            "The ice cream is creamy and cold.",
            "The bread is flaky and soft inside.",
            "The soda is fizzy and fun.",
            "The tea feels soothing on my throat.",
            "The apple juice is crisp and fresh."
        ];

        const incorrectPhrases = ["Great attempt! Let's try another.", "Not this time, but you're getting warmer!", "Every try is a step forward. Keep going!", "Mistakes are proof that you are trying. Don't stop!", "That's not the answer, but I believe in you!", "So close! What's your next idea?", "Don't worry, the best discoveries come after a few tries.", "That's a learning opportunity! Try again.", "Your persistence is inspiring. Let's go again.", "Even experts get it wrong sometimes. You've got this!"];
        
        const TEAM_REVEAL_TIME = 5000;

        // Game State
        let gameState;
        function resetGameState() {
            gameState = {
                phase: 'menu', currentSet: 0, currentRound: 1, currentCard: 1,
                totalRoundsPlayed: 0, 
                team1: { name: '', players: [] }, 
                team2: { name: '', players: [] }, 
                team1Score: 0, team2Score: 0,
                currentPlayer1: '', currentPlayer2: '',
                team1Queue: [], team2Queue: [],
                learningIndex: 0,
                roundTimer: null, currentAnswers: { player1: null, player2: null },
                currentQuestions: { player1: null, player2: null }, 
                askedQuestionsThisRound: [],
                isAutoMode: false, totalRoundsNeeded: 0
            };
        }
        resetGameState();

        // --- Sound Engine ---
        let preferredVoices = [];
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            if (voices.length === 0) return;

            const requestedVoiceNames = ['Ava', 'Brian', 'Andrew', 'Emma'];
            const foundVoices = [];

            requestedVoiceNames.forEach(name => {
                const match = voices.find(v =>
                    v.name.toLowerCase().includes(name.toLowerCase()) &&
                    v.name.toLowerCase().includes('natural') && // Prefer Natural Online
                    v.lang.toLowerCase().startsWith('en')
                );
                if (match) foundVoices.push(match);
            });

            // If any requested voices not found as Natural, try without 'Natural' filter
            if (foundVoices.length < requestedVoiceNames.length) {
                requestedVoiceNames.forEach(name => {
                    if (!foundVoices.some(v => v.name.toLowerCase().includes(name.toLowerCase()))) {
                        const fallback = voices.find(v =>
                            v.name.toLowerCase().includes(name.toLowerCase()) &&
                            v.lang.toLowerCase().startsWith('en')
                        );
                        if (fallback) foundVoices.push(fallback);
                    }
                });
            }

            preferredVoices = foundVoices;

            // Final fallback if none found
            if (preferredVoices.length === 0) {
                preferredVoices.push(
                    voices.find(v => v.lang.startsWith('en-US')) ||
                    voices.find(v => v.lang.startsWith('en-'))
                );
            }
        }
        
        speechSynthesis.onvoiceschanged = loadVoices;

        function playAudio(text, voiceIndex = 0, lang = 'en-US', onEndCallback) {
            if (!('speechSynthesis' in window) || !text) {
                if (onEndCallback) setTimeout(onEndCallback, 500);
                return;
            }

            const allVoices = speechSynthesis.getVoices();
            if (allVoices.length === 0) {
                console.warn("Speech synthesis voices not ready, skipping TTS for:", text);
                if (onEndCallback) setTimeout(onEndCallback, 500);
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);

            let voiceToUse = null;
            if (lang.startsWith('zh')) {
                voiceToUse = allVoices.find(v => v.lang.startsWith('zh-CN') && v.name.includes('Huihui')) || allVoices.find(v => v.lang.startsWith('zh'));
            } else {
                if (preferredVoices.length > 0 && preferredVoices[voiceIndex % preferredVoices.length]) {
                    voiceToUse = preferredVoices[voiceIndex % preferredVoices.length];
                }
            }

            if (voiceToUse) {
                utterance.voice = voiceToUse;
            } else {
                console.warn(`Could not find a suitable voice for lang=${lang}`);
            }

            utterance.lang = lang;
            utterance.rate = 0.85;

            utterance.onend = () => {
                if (onEndCallback) onEndCallback();
            };
            utterance.onerror = (e) => {
                // Log a more detailed error message
                console.error(`Speech synthesis error: "${e.error}" for text: "${text}"`);
                if (onEndCallback) onEndCallback(); // Continue game flow even on error
            };

            // This robust handling of cancel/speak helps prevent errors
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                // A tiny delay allows the cancel command to process before speaking again
                setTimeout(() => {
                    speechSynthesis.speak(utterance);
                }, 100);
            } else {
                speechSynthesis.speak(utterance);
            }
        }
        const correctSounds=[{seq:[{freq:880,dur:.3}]},{seq:[{freq:660,dur:.2},{freq:880,dur:.2}]},{seq:[{freq:500,dur:.3},{freq:1500,dur:.1}]},{seq:[{freq:784,dur:.4}]},{seq:[{freq:880,type:"square",dur:.15},{freq:1320,type:"square",dur:.15}]},{seq:[{freq:1200,type:"sawtooth",dur:.15},{freq:1800,type:"sawtooth",dur:.15}]},{seq:[{freq:660,dur:.15},{freq:880,dur:.15},{freq:990,dur:.15}]},{seq:[{freq:1e3,type:"square",dur:.05}]},{seq:[{freq:1200,dur:.1},{freq:2e3,dur:.1}]},{seq:[{freq:660,dur:.15},{freq:880,dur:.15},{freq:1320,dur:.15}]},{seq:[{freq:523,dur:.1},{freq:659,dur:.1},{freq:784,dur:.1},{freq:1046,dur:.1}]},{seq:[{freq:988,dur:.05,gap:.05},{freq:1046,dur:.05,gap:.05},{freq:988,dur:.05,gap:.05},{freq:1046,dur:.05}]},{seq:[{freq:784,dur:.15},{freq:1046,dur:.25}]},{seq:[{freq:600,type:"triangle",dur:.1},{freq:1200,type:"triangle",dur:.1,gap:.1}]},{seq:[{freq:900,type:"sawtooth",vol:.3,dur:.2}]},{seq:[{freq:2e3,dur:.05},{freq:2500,dur:.05,gap:.1},{freq:3e3,dur:.05}]},{seq:[{freq:440,dur:.1},{freq:550,dur:.1},{freq:660,dur:.1}]},{seq:[{freq:1500,dur:.4,vol:.4},{freq:1510,dur:.4,vol:.4,gap:-.4}]},{seq:[{freq:330,type:"square",dur:.1},{freq:440,type:"square",dur:.1},{freq:660,type:"square",dur:.2}]},{seq:[{freq:1046,dur:.5}]}];
        const incorrectSounds=[{seq:[{freq:200,type:"square",dur:.5}]},{seq:[{freq:200,type:"square",dur:.2},{freq:200,type:"square",dur:.2}]},{seq:[{freq:600,dur:.2},{freq:200,dur:.3}]},{seq:[{freq:150,dur:.4}]},{seq:[{freq:400,type:"sawtooth",dur:.3}]},{seq:[{freq:1e3,type:"square",dur:.05},{freq:300,type:"square",dur:.05}]},{seq:[{freq:400,dur:.2},{freq:300,dur:.2},{freq:200,dur:.3}]},{seq:[{freq:100,type:"square",dur:.05}]},{seq:[{freq:500,dur:.2},{freq:500,dur:.2}]},{seq:[{freq:800,dur:.2},{freq:100,dur:.3}]},{seq:[{freq:300,dur:.4},{freq:290,dur:.4,gap:-.4}]},{seq:[{freq:500,type:"sawtooth",dur:.05},{freq:400,type:"sawtooth",dur:.05},{freq:300,type:"sawtooth",dur:.05},{freq:200,type:"sawtooth",dur:.2}]},{seq:[{freq:220,dur:.5},{freq:225,dur:.5,gap:-.5}]},{seq:[{freq:100,type:"triangle",dur:.2,vol:.8}]},{seq:[{freq:1800,type:"sawtooth",dur:.05},{freq:1900,type:"sawtooth",dur:.05,gap:-.05},{freq:1700,type:"sawtooth",dur:.05,gap:-.05}]},{seq:[{freq:330,dur:.2},{freq:220,dur:.2},{freq:110,dur:.3}]},{seq:[{freq:800,type:"square",dur:.1},{freq:810,type:"square",dur:.1,gap:-.1}]},{seq:[{freq:155,type:"sawtooth",dur:.4}]},{seq:[{freq:523,dur:.1},{freq:392,dur:.1},{freq:261,dur:.2}]},{seq:[{freq:900,type:"square",dur:.02,gap:.02},{freq:900,type:"square",dur:.02,gap:.02},{freq:900,type:"square",dur:.02}]}];
        function playSound(type){let e;if("correct"===type)e=correctSounds;else if("incorrect"===type)e=incorrectSounds;else return;let t=e[Math.floor(Math.random()*e.length)],o=audioContext.currentTime;t.seq.forEach(e=>{e.gap&&e.gap>0&&(o+=e.gap);let t=audioContext.createOscillator(),n=audioContext.createGain();t.connect(n),n.connect(audioContext.destination),t.frequency.setValueAtTime(e.freq,o),t.type=e.type||"sine",n.gain.setValueAtTime(e.vol||.5,o),n.gain.exponentialRampToValueAtTime(.001,o+e.dur),t.start(o),t.stop(o+e.dur),e.gap&&e.gap>=0||(o+=e.dur)})}
        
        function switchScreen(activeScreen) {
            ['teamSetup', 'learningMode', 'playerSelection', 'gamePlay'].forEach(screenId => {
                document.getElementById(screenId).style.display = (screenId === activeScreen) ? 'block' : 'none';
            });
        }
        
        function selectGradeAndStart(grade) {
            if (grade === 10) playerNames = [...grade10Players];
            if (grade === 11) playerNames = [...grade11Players];
            if (grade === 12) playerNames = [...grade12Players];
            if (playerNames.length === 0) return;
            gameState.totalRoundsNeeded = Math.ceil(playerNames.length / 2);
            startAutoChampionship();
        }

        function startAutoChampionship() {
            gameState.isAutoMode = true;
            gameState.phase = 'team-setup';
            document.getElementById('gameModes').style.display = 'none';
            document.getElementById('game-content').style.display = 'block';
            
            shuffleTeams(); 
            switchScreen('teamSetup');
            
            setTimeout(() => {
                showPhaseTransition('üç≥ Starting Championship!', 2000);
                setTimeout(() => startLearningPhase(), 2000);
            }, TEAM_REVEAL_TIME); 
        }

        function shuffleTeams() {
            const foodTeams = ["Apples üçé", "Burgers üçî", "Pizzas üçï", "Tacos üåÆ", "Donuts üç©", "Cookies üç™"];
            const shuffledTeams = foodTeams.sort(() => .5 - Math.random());
            gameState.team1.name = shuffledTeams[0];
            gameState.team2.name = shuffledTeams[1];
            
            const shuffledPlayers = [...playerNames].sort(() => .5 - Math.random());
            const mid = Math.ceil(shuffledPlayers.length / 2);
            gameState.team1.players = shuffledPlayers.slice(0, mid);
            gameState.team2.players = shuffledPlayers.slice(mid);
            
            displayTeams();
        }
        
        function displayTeams() {
            document.getElementById('team1Name').innerHTML = gameState.team1.name;
            document.getElementById('team2Name').innerHTML = gameState.team2.name;
            const t1Members = document.getElementById('team1Members');
            const t2Members = document.getElementById('team2Members');
            t1Members.innerHTML = gameState.team1.players.map(p => `<div class="team-member">${p}</div>`).join('');
            t2Members.innerHTML = gameState.team2.players.map(p => `<div class="team-member">${p}</div>`).join('');
        }

        function startLearningPhase() {
            gameState.phase = 'learning';
            gameState.learningIndex = 0;
            
            switchScreen('learningMode');
            const set = mealSets[gameState.currentSet];
            document.getElementById('learningSetName').textContent = set.name;
            document.getElementById('totalLearningItems').textContent = set.items.length;
            showLearningCard();
        }

        function showLearningCard() {
            const set = mealSets[gameState.currentSet];
            const item = set.items[gameState.learningIndex];
            document.getElementById('learningEmoji').textContent = item.emoji;
            document.getElementById('learningText').textContent = item.name;
            document.getElementById('learningCounter').textContent = gameState.learningIndex + 1;
            document.getElementById('learningProgressBar').style.width = `${((gameState.learningIndex + 1) / set.items.length) * 100}%`;
            
            setTimeout(() => playAudio(item.name, gameState.currentSet, 'en-US'), 500);
            
            const words = item.name.split(/\s+/).length;
            const baseTime = 2500; // minimum time
            const extraPerWord = 400; // add 0.4s per word
            const displayTime = baseTime + (words * extraPerWord) + 3000; // Added 3 seconds

            setTimeout(() => {
                gameState.learningIndex++;
                if (gameState.learningIndex < set.items.length) {
                    showLearningCard();
                } else {
                    setTimeout(startPlayingPhase, 1000);
                }
            }, displayTime);
        }

        function startPlayingPhase() {
            gameState.phase = 'player-selection';
            gameState.currentCard = 1;
            showPhaseTransition(`‚öîÔ∏è Competition Round ${gameState.currentRound}`, 2000);
            setTimeout(selectPlayersForRound, 2000);
        }
        
        function selectPlayersForRound() {
            if (gameState.team1Queue.length === 0) {
                gameState.team1Queue = [...gameState.team1.players].sort(() => 0.5 - Math.random());
            }
            if (gameState.team2Queue.length === 0) {
                gameState.team2Queue = [...gameState.team2.players].sort(() => 0.5 - Math.random());
            }

            gameState.currentPlayer1 = gameState.team1Queue.pop();
            gameState.currentPlayer2 = gameState.team2Queue.pop();
            
            
            switchScreen('playerSelection');
            createSlotMachine();
        }

        function createSlotMachine() {
            document.getElementById('slot1TeamName').innerHTML = gameState.team1.name;
            document.getElementById('slot2TeamName').innerHTML = gameState.team2.name;

            const s1 = document.getElementById('slot1Strip');
            const s2 = document.getElementById('slot2Strip');
            s1.innerHTML = ''; s2.innerHTML = '';
            for (let i = 0; i < 40; i++) {
                s1.innerHTML += `<div class="slot-item">${gameState.team1.players[i % gameState.team1.players.length]}</div>`;
                s2.innerHTML += `<div class="slot-item">${gameState.team2.players[i % gameState.team2.players.length]}</div>`;
            }
            const i1 = gameState.team1.players.indexOf(gameState.currentPlayer1);
            const i2 = gameState.team2.players.indexOf(gameState.currentPlayer2);
            [s1, s2].forEach(s => { s.style.transition = 'none'; s.style.transform = 'translateY(0)'; s.offsetHeight; s.style.transition = 'transform 3s ease-out'; });
            s1.style.transform = `translateY(-${(40 - (gameState.team1.players.length - i1)) * 60}px)`;
            s2.style.transform = `translateY(-${(40 - (gameState.team2.players.length - i2)) * 60}px)`;
            setTimeout(() => {
                document.getElementById('slot1Window').textContent = gameState.currentPlayer1;
                document.getElementById('slot2Window').textContent = gameState.currentPlayer2;
                
                // Announce players in Chinese
                const player1Chinese = gameState.currentPlayer1.split('/')[0].trim();
                const player2Chinese = gameState.currentPlayer2.split('/')[0].trim();
                const announcement = `${player1Chinese}, Âíå ${player2Chinese}, ËØ∑ÂáÜÂ§áÊØîËµõ„ÄÇ`;
                playAudio(announcement, 0, 'zh-CN');

                startGameCountdown();
            }, 3000);
        }

        function startGameCountdown() {
            let count = 10; // Changed from 5 to 10
            const timerEl = document.getElementById('countdownTimer');
            timerEl.textContent = count;
            const interval = setInterval(() => {
                count--;
                timerEl.textContent = count;
                if (count <= 0) { clearInterval(interval); start5CardRound(); }
            }, 1000);
        }
        
        function start5CardRound() {
            gameState.phase = 'playing';
            gameState.currentCard = 1;
            gameState.askedQuestionsThisRound = []; // Reset for the new round
            switchScreen('gamePlay');
            
            playNextCard();
        }

        function playNextCard() {
            if (gameState.currentCard > 5) {
                gameState.totalRoundsPlayed++;
                playSound('correct');
                showPhaseTransition(`üéâ Round Complete!`, 3000);

                setTimeout(() => {
                    if (gameState.totalRoundsPlayed >= gameState.totalRoundsNeeded) {
                        endGame();
                        return;
                    }

                    gameState.currentRound++;

                    if (gameState.currentSet < mealSets.length - 1) {
                        gameState.currentSet++;
                        startLearningPhase();
                    } else {
                        startBonusRound();
                    }
                }, 3000);
                return;
            }

            updateGameStatus();
            setupQuestions();
            startRoundTimer();
        }

        function updateGameStatus() {
            document.getElementById('gameTeam1Name').innerHTML = gameState.team1.name;
            document.getElementById('gameTeam2Name').innerHTML = gameState.team2.name;
            const roundInfo = document.getElementById('roundInfo');
            
            if (gameState.currentRound > mealSets.length) {
                roundInfo.textContent = `üéâ BONUS ROUND ${gameState.currentRound} | Card: ${gameState.currentCard}/5`;
                roundInfo.className = 'round-info bonus-indicator';
            } else {
                const pairIndex = gameState.totalRoundsPlayed;
                const menuIndex = pairIndex % mealSets.length;
                roundInfo.textContent = `Round ${gameState.currentRound}/${gameState.totalRoundsNeeded} | ${mealSets[menuIndex].name} | Card: ${gameState.currentCard}/5`;
                roundInfo.className = 'round-info';
            }
            document.getElementById('player1Name').textContent = gameState.currentPlayer1;
            document.getElementById('player2Name').textContent = gameState.currentPlayer2;
            document.getElementById('team1Score').textContent = gameState.team1Score;
            document.getElementById('team2Score').textContent = gameState.team2Score;
        }
        
        function setupQuestions() {
            // Pair index (0-based for array indexing)
            const pairIndex = gameState.totalRoundsPlayed;

            // Map pair to menu index (Pair 0 -> Monday, Pair 1 -> Tuesday, etc.)
            const menuIndex = pairIndex % mealSets.length;

            let items = mealSets[menuIndex].items;

            // Filter out already asked in this round
            let availableItems = items.filter(item => !gameState.askedQuestionsThisRound.includes(item.name));
            if (availableItems.length < 2) availableItems = items;

            const shuffled = [...availableItems].sort(() => 0.5 - Math.random());
            gameState.currentQuestions.player1 = shuffled[0];
            gameState.currentQuestions.player2 = shuffled[1] || shuffled[0];

            document.getElementById('player1Emoji').textContent = gameState.currentQuestions.player1.emoji;
            document.getElementById('player2Emoji').textContent = gameState.currentQuestions.player2.emoji;

            setupAnswerButtons(1, gameState.currentQuestions.player1, items);
            setupAnswerButtons(2, gameState.currentQuestions.player2, items);

            gameState.currentAnswers = { player1: null, player2: null };

            // Play a descriptive phrase for the card
            const phrase = praisePhrases[Math.floor(Math.random() * praisePhrases.length)];
            // Using voice 3 (Emma) as before, with a small delay
            setTimeout(() => playAudio(phrase, 3, 'en-US'), 500);
        }
        
        function setupAnswerButtons(playerNum, correctAns, allItems) {
            const container = document.getElementById(`player${playerNum}Buttons`);
            container.innerHTML = '';
            let answers = [correctAns.name];
            const incorrect = allItems.map(i => i.name).filter(n => n !== correctAns.name);
            while (answers.length < 4 && incorrect.length > 0) {
                answers.push(incorrect.splice(Math.floor(Math.random() * incorrect.length), 1)[0]);
            }
            answers.sort(() => .5 - Math.random()).forEach((ans, i) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = ans;
                btn.onclick = () => selectAnswer(playerNum, i, ans);
                container.appendChild(btn);
            });
        }

        function showPraise(playerNum) {
            const el = document.createElement('div');
            el.className = 'praise-word';
            el.textContent = "Excellent!";
            el.style.color = '#39FF14';

            const badge = document.createElement('div');
            badge.className = 'point-badge';
            badge.textContent = "+1";

            const playerArea = document.getElementById(`team${playerNum}GameArea`).querySelector('.player-area');
            
            playerArea.appendChild(el);
            playerArea.appendChild(badge);
            
            const scoreDisplay = playerArea.querySelector('.team-score-display');
            createSparkleTrail(scoreDisplay);

            // Add glow effect to player area
            playerArea.classList.add('correct-answer-glow');
            setTimeout(() => {
                playerArea.classList.remove('correct-answer-glow');
            }, 1500);


            setTimeout(() => {
                el.remove();
                badge.remove();
            }, 2500);
        }
        
        function createSparkleTrail(element) {
            const container = element.offsetParent || document.body;
            const rect = element.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            for (let i = 0; i < 20; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                
                const startX = rect.left - containerRect.left + rect.width / 2;
                const startY = rect.top - containerRect.top + rect.height / 2;

                sparkle.style.left = `${startX}px`;
                sparkle.style.top = `${startY}px`;

                sparkle.style.setProperty('--x', `${(Math.random() - 0.5) * 300}px`);
                sparkle.style.setProperty('--y', `${(Math.random() - 0.5) * 300}px`);
                sparkle.style.animationDelay = `${Math.random() * 0.3}s`;

                container.appendChild(sparkle);
                setTimeout(() => sparkle.remove(), 1000);
            }
        }

        function showEncouragement(playerNum) {
            const phrase = incorrectPhrases[Math.floor(Math.random() * incorrectPhrases.length)];
            const el = document.createElement('div');
            el.className = 'encouragement-phrase'; el.textContent = phrase;
            const playerArea = document.getElementById(`team${playerNum}GameArea`).querySelector('.player-area');
            playerArea.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        function selectAnswer(playerNum, btnIndex, selectedAns) {
            if (gameState.currentAnswers['player' + playerNum]) return;
            const correctAns = gameState.currentQuestions['player' + playerNum].name;
            const isCorrect = selectedAns === correctAns;
            gameState.currentAnswers['player' + playerNum] = { correct: isCorrect, btnIndex };
            const btns = document.getElementById(`player${playerNum}Buttons`).children;
            btns[btnIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
            playSound(isCorrect ? 'correct' : 'incorrect');
            if (isCorrect) {
                // Add correctly answered question to the list to prevent repeats
                const correctQuestionName = gameState.currentQuestions['player' + playerNum].name;
                if (!gameState.askedQuestionsThisRound.includes(correctQuestionName)) {
                    gameState.askedQuestionsThisRound.push(correctQuestionName);
                }

                if (playerNum === 1) gameState.team1Score++; else gameState.team2Score++;
                showPraise(playerNum); createFireworks();
            } else {
                if (playerNum === 1) gameState.team2Score++; else gameState.team1Score++;
                showEncouragement(playerNum);
            }
            document.getElementById('team1Score').textContent = gameState.team1Score;
            document.getElementById('team2Score').textContent = gameState.team2Score;
            Array.from(btns).forEach(btn => btn.onclick = null);
        }

        function revealCorrectAnswers() {
            for (let i = 1; i <= 2; i++) {
                if (!gameState.currentAnswers['player' + i]) {
                    const buttons = document.getElementById(`player${i}Buttons`).children;
                    const correctAnswer = gameState.currentQuestions['player' + i].name;
                    for (let btn of buttons) {
                        if (btn.textContent === correctAnswer) {
                            btn.classList.add('correct');
                        }
                        btn.onclick = null;
                    }
                }
            }
        }

        function nextCard() {
            gameState.currentCard++;
            playNextCard();
        }

        function startRoundTimer() {
            clearTimeout(gameState.roundTimer);
            let timeLeft = 7;
            const timerDisp = document.getElementById('timerDisplay');
            const timerProg = document.getElementById('timerProgress');
            timerDisp.textContent = timeLeft;
            timerProg.style.width = '100%';
            gameState.roundTimer = setInterval(() => {
                timeLeft--;
                timerDisp.textContent = timeLeft;
                timerProg.style.width = `${(timeLeft / 7) * 100}%`;
                if (timeLeft <= 0) {
                    clearInterval(gameState.roundTimer);
                    revealCorrectAnswers();
                    if (!gameState.currentAnswers.player1) { gameState.team2Score++; playSound('incorrect'); }
                    if (!gameState.currentAnswers.player2) { gameState.team1Score++; playSound('incorrect'); }
                    document.getElementById('team1Score').textContent = gameState.team1Score;
                    document.getElementById('team2Score').textContent = gameState.team2Score;
                    
                    setTimeout(nextCard, 2000); 
                }
            }, 1000);
        }
        
        function showPhaseTransition(text, duration = 3000) {
            const transition = document.getElementById('phaseTransition');
            document.getElementById('transitionText').textContent = text;
            transition.style.display = 'block';
            
            setTimeout(() => {
                transition.style.display = 'none';
            }, duration);
        }

        function startBonusRound() {
            gameState.phase = 'player-selection';
            gameState.currentCard = 1;
            showPhaseTransition(`üéâ BONUS ROUND ${gameState.currentRound}! üéâ`, 3000);
            setTimeout(selectPlayersForRound, 3000);
        }

        function endGame() {
            clearInterval(gameState.roundTimer);
            const winner = gameState.team1Score > gameState.team2Score ? gameState.team1.name : (gameState.team2Score > gameState.team1Score ? gameState.team2.name : 'Tie Game');
            const members = gameState.team1Score > gameState.team2Score ? gameState.team1.players : (gameState.team2Score > gameState.team1Score ? gameState.team2.players : [...gameState.team1.players, ...gameState.team2.players]);
            document.getElementById('game-content').style.display = 'none';
            
            showCertificate(winner, members);
            for (let i = 0; i < 100; i++) setTimeout(createFireworks, i * 50);
        }

        function showCertificate(winner, members) {
            const cert = document.getElementById('certificate');
            document.getElementById('certificateTeam').textContent = winner;
            document.getElementById('certificateScore').textContent = `Final Score: ${gameState.team1Score} - ${gameState.team2Score}`;
            document.getElementById('certificateDate').textContent = `Date: ${new Date().toLocaleDateString()}`;
            document.getElementById('certificateMembers').textContent = members.join(', ');
            cert.style.display = 'block';
        }

        function createFireworks() {
            const container = document.getElementById('fireworksContainer');
            const colors = ['#ff006e', '#8338ec', '#06ffa5', '#ffd700', '#ff8c00', '#ffde7d'];
            for (let i = 0; i < 15; i++) {
                const fw = document.createElement('div');
                fw.className = 'firework';
                fw.style.left = `${Math.random() * 100}%`;
                fw.style.top = `${Math.random() * 100}%`;
                const color = colors[Math.floor(Math.random() * colors.length)];
                fw.style.background = color;
                fw.style.boxShadow = `0 0 20px ${color}`;
                container.appendChild(fw);
                setTimeout(() => fw.remove(), 2000);
            }
        }

        function resetGame() {
            clearInterval(gameState.roundTimer);
            resetGameState();
            document.getElementById('game-content').style.display = 'none';
            document.getElementById('certificate').style.display = 'none';
            document.getElementById('phaseTransition').style.display = 'none';
            document.getElementById('gameModes').style.display = 'flex';
            speechSynthesis.cancel();
        }

        window.addEventListener('load', () => {
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            loadVoices();

            const foodBg = document.getElementById('foodBg');
            const emojis = ['ü•û','ü•Ø','üåÆ','ü•≠','‚òï','üçú','üç£','üçù','ü•©','üçõ','üçî','üçï'];
            for(let i=0;i<30;i++){let e=document.createElement("div");e.className="food-bubble",e.style.left=100*Math.random()+"%",e.style.animationDuration=6+8*Math.random()+"s",e.style.animationDelay=5*Math.random()+"s",e.textContent=emojis[Math.floor(Math.random()*emojis.length)],foodBg.appendChild(e)}
        });
    </script>
</body>
</html>
