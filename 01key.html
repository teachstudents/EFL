<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2 KEY (KET) Reading Practice - Complete Edition</title>
    <style>
        :root {
            --correct-bg: linear-gradient(145deg, #e8f5e8, #c8e6c9);
            --correct-border: #4CAF50;
            --incorrect-bg: linear-gradient(145deg, #ffebee, #ffcdd2);
            --incorrect-border: #f44336;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            color: #333;
        }
        .floating-elements { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .floating-element { position: absolute; font-size: 2em; animation: float 12s ease-in-out infinite; opacity: 0.2; }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.2; }
            50% { transform: translateY(-25px) rotate(180deg); opacity: 0.4; }
        }
        .container { max-width: 980px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }
        .header {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 30px;
            box-shadow: 10px 10px 20px rgba(0,0,0,0.1), -10px -10px 20px rgba(255,255,255,0.8);
        }
        .header h1 { font-size: 2.2em; margin: 0; cursor: pointer; }

        .student-info {
            background: rgba(255,255,255,0.95); border-radius: 15px; padding: 30px; margin-bottom: 30px;
            text-align: center; backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.3);
        }
        .name-input {
            padding: 15px 25px; font-size: 1.2em; border: 3px solid #4ECDC4; border-radius: 25px;
            margin: 20px 0; min-width: 300px; text-align: center; background: white;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .progress-container {
            background: rgba(255,255,255,0.9); border-radius: 15px; padding: 20px; margin-bottom: 30px;
            display: flex; align-items: center; flex-wrap: wrap; gap: 20px;
        }
        .progress-bar { flex: 1; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden; min-width: 200px; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(45deg, #4CAF50, #81C784); border-radius: 12px; transition: width 0.5s ease; }
        .progress-text { font-weight: bold; }
        .score-display {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4); color: white; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative;
        }
        .part-container {
            background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; margin-bottom: 30px;
            backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .part-header { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 3px solid #4ECDC4; }
        .part-title { font-size: 2em; margin-bottom: 10px; }
        .part-description { color: #666; font-size: 1.1em; }
        .question-container {
             margin: 25px 0; padding: 20px; background: linear-gradient(145deg, #ffffff, #f5f5f5);
             border-radius: 15px; box-shadow: 8px 8px 16px rgba(0,0,0,0.1), -8px -8px 16px rgba(255,255,255,0.8);
        }
        .question-text { font-size: 1.1em; font-weight: 500; margin-bottom: 15px; }
        .stimulus-sign {
            border: 4px solid #333; padding: 20px; text-align: center; font-weight: bold; font-size: 1.1em; margin: 15px auto; max-width: 300px; border-radius: 8px; background: #fff;
        }
        .options-container { display: flex; flex-direction: column; gap: 12px; }
        .option {
            background: linear-gradient(145deg, #ffffff, #f0f0f0); border: 2px solid transparent;
            border-radius: 12px; padding: 15px 20px; cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.1), -5px -5px 10px rgba(255,255,255,0.8);
        }
        .option.correct { background: var(--correct-bg); border-color: var(--correct-border); animation: correctAnswer 0.5s ease; }
        .option.incorrect { background: var(--incorrect-bg); border-color: var(--incorrect-border); animation: incorrectAnswer 0.5s ease; }
        .option-letter {
            background: linear-gradient(45deg, #667eea, #764ba2); color: white; width: 30px; height: 30px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; flex-shrink: 0;
        }
        .feedback { font-size: 0.9em; margin-top: 8px; padding: 8px; border-radius: 6px; display: none; }
        .feedback.correct { background: #e8f5e9; color: #1e4620; }
        .feedback.incorrect { background: #ffebee; color: #b71c1c; }
        .controls { display: flex; justify-content: center; gap: 20px; margin: 30px 0; }
        .btn {
            background: linear-gradient(145deg, #ffffff, #e6e6e6); color: #333; border: none;
            padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold;
            font-size: 1.1em; transition: all 0.3s ease;
            box-shadow: 8px 8px 16px rgba(0,0,0,0.2), -8px -8px 16px rgba(255,255,255,0.8);
        }
        .btn-primary { background: linear-gradient(45deg, #4ECDC4, #44A08D); color: white; }
        .results-container, .certificate-container { background: white; border-radius: 20px; padding: 40px; text-align: center; margin: 30px 0; }
        .results-title, .certificate-title { font-size: 2.5em; margin-bottom: 20px; }
        .results-score, .certificate-score { font-size: 3em; font-weight: bold; margin: 20px 0; color: #4ECDC4; }
        .student-name { font-size: 2.2em; color: #FF6B6B; font-weight: bold; margin: 20px 0; }
        .hidden { display: none; }
        .reward-token {
            position: fixed; font-size: 1.5em; z-index: 100; pointer-events: none;
            animation: flyToScore 1s ease-in-out forwards;
        }
        /* Part 2 Styles */
        .drop-zone {
            display: inline-block; min-width: 100px; height: 38px;
            border: 2px dashed #aaa; border-radius: 8px;
            text-align: center; vertical-align: middle;
            background: #f0f0f0; margin: 0 4px; padding: 6px;
        }
        .drop-zone.correct { background: var(--correct-bg); border-color: var(--correct-border); font-weight: bold; }
        .drop-zone.incorrect { background: var(--incorrect-bg); border-color: var(--incorrect-border); animation: incorrectAnswer 0.5s ease; }
        .word-bank { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; justify-content: center; }
        .draggable-word { padding: 8px 16px; background: white; border: 1px solid #ccc; border-radius: 20px; cursor: grab; user-select: none; }
        .draggable-word.dragging, .draggable-word.tapped { opacity: 0.5; background: #4ECDC4; color: white; }

        /* Part 3 Styles */
        .reading-passage { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }

        @keyframes flyToScore {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.5); }
        }
        @keyframes correctAnswer { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        @keyframes incorrectAnswer {
           10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); }
           30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); }
        }
    </style>
</head>
<body>
    <div class="floating-elements" id="floatingElements"></div>
    <div class="container">
        <header class="header">
            <h1 id="headerTitle" onclick="speakText(this.textContent, 'Emma')">A2 KEY (KET) Reading Practice</h1>
        </header>

        <section class="student-info" id="studentInfo">
            <h2 onclick="speakText(this.textContent, 'Ava')">üë®‚Äçüéì Student Information</h2>
            <p onclick="speakText('Please enter your name to begin.', 'Ava')">Please enter your name to begin:</p>
            <input type="text" class="name-input" id="studentName" placeholder="Enter your full name">
            <button class="btn btn-primary" onclick="startTest()">üöÄ Start Practice</button>
        </section>

        <div class="progress-container hidden" id="progressContainer">
            <div class="progress-text" id="progressText">Part 1 of 3</div>
            <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
            <div class="score-display" id="scoreDisplay">Score: 0 / 90</div>
        </div>

        <section class="part-container hidden" id="part1">
            <header class="part-header" onclick="speakText(this.innerText, 'Brian')">
                <h2 class="part-title">Part 1: Signs, Notices & Messages</h2>
                <p class="part-description">Look at the text in each question. What does it say? Choose the best answer.</p>
            </header>
            <div id="part1Content"></div>
        </section>

        <section class="part-container hidden" id="part2">
            <header class="part-header" onclick="speakText(this.innerText, 'Brian')">
                <h2 class="part-title">Part 2: Gap-Fill Stories</h2>
                <p class="part-description">Complete the stories. Drag a word from the bank to fill each gap.</p>
            </header>
            <div id="part2Content"></div>
        </section>

        <section class="part-container hidden" id="part3">
            <header class="part-header" onclick="speakText(this.innerText, 'Brian')">
                <h2 class="part-title">Part 3: Reading Comprehension</h2>
                <p class="part-description">Read the texts and answer the questions.</p>
            </header>
            <div id="part3Content"></div>
        </section>

        <div class="controls hidden" id="controls">
            <button class="btn" onclick="previousPart()" id="prevBtn" disabled>‚¨ÖÔ∏è Previous</button>
            <button class="btn btn-primary" onclick="nextPart()" id="nextBtn">Next Part ‚û°Ô∏è</button>
            <button class="btn btn-primary hidden" onclick="finishTest()" id="finishBtn">üèÜ Finish & See Results</button>
        </div>
        
        <section class="results-container hidden" id="resultsContainer">
            <h2 class="results-title">üéâ Practice Complete!</h2>
            <div class="results-score" id="finalScore"></div>
            <p id="finalFeedback"></p>
            <div class="controls">
                 <button class="btn btn-primary" onclick="generateCertificate()">üìú Generate Certificate</button>
                 <button class="btn" onclick="window.location.reload()">üîÑ Restart</button>
            </div>
        </section>

        <section class="certificate-container hidden" id="certificateContainer">
            <h2 class="certificate-title">üèÜ Certificate of Achievement</h2>
            <p>This is to certify that</p>
            <div class="student-name" id="certificateStudentName"></div>
            <p>has successfully completed the A2 KEY (KET) Reading Practice achieving a score of</p>
            <div class="certificate-score" id="certificateScore"></div>
            <div class="controls">
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print Certificate</button>
            </div>
        </section>
    </div>

<script>
// --- DATA, STATE, and AUDIO ---
const KETData = {
  part1: [
    { id: 1, question: "What does this sign mean?", stimulus: '<div class="stimulus-sign" style="background: #fff3cd; border-color: #ffeeba;">‚ö†Ô∏è<br>WET FLOOR</div>', options: ["You can slide on the floor.", "Be careful, the floor is wet.", "The floor is being cleaned later."], answer: 1, feedback: "Correct! 'Wet floor' is a warning to walk carefully to avoid slipping." },
    { id: 2, question: "What should you do?", stimulus: '<div class="stimulus-sign" style="background: #f8d7da; border-color: #f5c6cb;">üö´üçî<br>NO FOOD OR DRINK</div>', options: ["You can eat your own food here.", "Ask before you bring a drink.", "You must not eat or drink here."], answer: 2, feedback: "Correct! This sign means eating and drinking are not allowed in this area." },
    { id: 3, question: "What does this notice mean?", stimulus: '<div class="stimulus-sign" style="background: #d4edda; border-color: #c3e6cb;">‚Üí<br>PLEASE QUEUE HERE</div>', options: ["The line is closed.", "Wait in a line here.", "You can go to the front."], answer: 1, feedback: "Correct! 'Queue here' means you need to wait in a line for your turn." },
    { id: 4, question: "What must you do?", stimulus: '<div class="stimulus-sign" style="background: #d1ecf1; border-color: #bee5eb;">ü§´üì±<br>MOBILE PHONES SILENT</div>', options: ["Turn off the sound on your phone.", "You cannot use your phone here.", "You can talk on the phone quietly."], answer: 0, feedback: "Correct! 'Silent' means your phone should not make any noise." },
    { id: 5, question: "What does this sign tell you?", stimulus: '<div class="stimulus-sign" style="border-color: #333;">üö™<br>PULL</div>', options: ["Push the door to open it.", "The door opens towards you.", "This is not a door."], answer: 1, feedback: "Correct! 'Pull' means you need to pull the handle towards yourself to open the door." },
    { id: 6, question: "Who can use this door?", stimulus: '<div class="stimulus-sign" style="background: #fefefe; border-color: #ddd;">STAFF ONLY</div>', options: ["Any staff member can enter.", "Only the manager can enter.", "Customers can use this door."], answer: 0, feedback: "Correct! 'Staff Only' means this entrance is just for people who work here." },
    { id: 7, question: "What does this message say?", stimulus: '<div class="stimulus-sign" style="font-size: 0.9em; padding: 15px; background: aliceblue; border-color: lightskyblue;"><strong>To:</strong> All students<br><strong>From:</strong> The Office<br><br>The library will close at 4pm today for a meeting.</div>', options: ["The library is closed all day.", "The library has a meeting now.", "The library is closing earlier than usual."], answer: 2, feedback: "Correct! Closing at 4pm is an earlier time than normal." },
    { id: 8, question: "What does this sign mean?", stimulus: '<div class="stimulus-sign" style="background: #fff3cd; border-color: #ffeeba;">MIND THE STEP</div>', options: ["Take one step.", "Go up the stairs.", "Be careful of a step."], answer: 2, feedback: "Correct! 'Mind the step' is a warning to be careful because there is a change in the floor level." },
    { id: 9, question: "What can you do here?", stimulus: '<div class="stimulus-sign" style="background: #d4edda; border-color: #c3e6cb;">‚ôªÔ∏è<br>PLEASE RECYCLE BOTTLES & CANS HERE</div>', options: ["Throw all your rubbish here.", "Put plastic and metal in this bin.", "You can buy bottles and cans here."], answer: 1, feedback: "Correct! Recycling bins are for specific materials like plastic bottles and metal cans." },
    { id: 10, question: "Why has David sent this text?", stimulus: '<div class="stimulus-sign" style="font-size: 0.9em; text-align: left; padding: 15px; background: #f0f0f0; border-color: #ccc;"><strong>Hi Sam,</strong><br>I\'m running about 10 mins late. Can you get us a table?<br><strong>David</strong></div>', options: ["To tell Sam he will be late.", "To ask where the restaurant is.", "To cancel his plans with Sam."], answer: 0, feedback: "Correct! 'Running late' means he will not arrive at the agreed time." }
  ],
  part2: Array.from({ length: 10 }, (_, i) => {
    const stories = [
      { story: "My friend, Alex, loves weekends. On Saturday, he goes to the park to ______ football with his friends. Afterwards, they sometimes go to the ______ to watch a new film. On Sunday, he likes to go to the ______ to borrow books because he loves reading. He always takes the bus from the ______ to get there. It's his favourite way to ______.", answers: ["play", "cinema", "library", "station", "travel"] },
      { story: "Last summer, my family and I went on ______. We stayed in a nice ______ near the sea. Every day, we went to the ______ and swam in the water. In the evening, we ate delicious food at a local ______. I bought a small ______ as a gift for my friend.", answers: ["holiday", "hotel", "beach", "restaurant", "souvenir"] },
      { story: "My sister has a new ______. She works as a ______ in a busy hospital. She helps people who are sick. She has to wear a white ______. She works long hours, but she loves her job because she enjoys ______ people.", answers: ["job", "nurse", "uniform", "helping", "working"] },
      { story: "I am planning a birthday ______ for my friend, Maria. I sent out an ______ to all her friends. I need to buy a ______ and some decorations. We will play some fun ______ and listen to music. I hope she will be ______.", answers: ["party", "invitation", "cake", "games", "surprised"] },
      { story: "Yesterday, I went shopping. I needed to buy a new ______ of jeans. I went to a big department ______. I tried on a few pairs in the changing room. I found a blue pair that was a perfect ______. I paid for it with my credit ______.", answers: ["pair", "store", "fit", "card", "money"] },
      { story: "My favourite ______ of the year is winter. I love the cold ______. It's the perfect time to drink hot ______. Sometimes it snows, and we can build a ______. I always wear a warm coat, a hat, and a ______ when I go outside.", answers: ["season", "weather", "chocolate", "snowman", "scarf"] },
      { story: "I have an important ______ tomorrow. I need to study hard tonight. I will go to the library to find a quiet ______. I will read my notes and review my ______. I hope to get a good ______ so my parents will be proud.", answers: ["exam", "place", "textbooks", "grade", "happy"] },
      { story: "Let's cook dinner tonight. We can make ______. First, we need to boil some water in a large ______. Then, we add the pasta. While it's cooking, we can prepare the ______. I like to add cheese and tomatoes. It‚Äôs an ______ and tasty meal.", answers: ["pasta", "pot", "sauce", "easy", "delicious"] },
      { story: "I like to stay ______ and healthy. Every morning, I go for a ______ in the park. I also go to the ______ twice a week. I try to eat a lot of fruit and ______. It's important to drink plenty of ______ too.", answers: ["fit", "run", "gym", "vegetables", "water"] },
      { story: "My hobby is ______ pictures. I have a good ______. I love to take photos of animals and ______. Last weekend, I went to the zoo and took many photos of the lions. My dream is to travel the ______ and take pictures of different places.", answers: ["taking", "camera", "nature", "world", "people"] }
    ];
    return { storyId: i + 1, ...stories[i] };
  }),
  part3: Array.from({ length: 10 }, (_, i) => {
    const passages = [
        { passage: "Maria had a busy day yesterday. In the morning, she went to the market and bought some fresh fruit. For lunch, she met her friend Lucia at a small cafe. They ate pizza and talked for an hour. In the afternoon, Maria went to the sports centre because she had a tennis class.", questions: [{ q: "Where did Maria go in the morning?", opts: ["The sports centre", "A small cafe", "The market"], ans: 2 }, { q: "Who did Maria have lunch with?", opts: ["Her mother", "Her friend Lucia", "She ate alone"], ans: 1 }, { q: "What did she do in the afternoon?", opts: ["She bought fruit", "She had a tennis class", "She ate pizza"], ans: 1 }] },
        { passage: "Advertisement: 'The new City Bookstore is now open! We are on Green Street, opposite the train station. Come and see our huge collection of books. We have stories, dictionaries, and travel guides. Open 9am-6pm, Monday to Saturday.'", questions: [{ q: "Where is the new bookstore?", opts: ["Next to the train station", "Opposite the train station", "Inside the train station"], ans: 1 }, { q: "What does the store NOT sell?", opts: ["Stories", "Travel guides", "Computers"], ans: 2 }, { q: "When is the bookstore closed?", opts: ["Saturday", "Monday", "Sunday"], ans: 2 }] },
        { passage: "Email from Tom: 'Hi Sarah, Thanks for the invitation to your party on Friday! I'd love to come. What time does it start? Should I bring anything, like some snacks or drinks? Let me know. Best, Tom'", questions: [{ q: "Why is Tom writing this email?", opts: ["To invite Sarah to a party", "To ask for information about a party", "To say he cannot go to the party"], ans: 1 }, { q: "What does Tom want to know?", opts: ["The party's date", "The party's start time", "The party's location"], ans: 1 }, { q: "What does Tom offer to do?", opts: ["Bring some music", "Bring some friends", "Bring some food or drinks"], ans: 2 }] },
        { passage: "My name is Carlos. I'm a student from Brazil, and I'm studying English in London for six months. I live with a British family. They are very kind. I take the bus to school every day. I love London, but the weather is very different from Brazil ‚Äì it's often cold and rainy here!", questions: [{ q: "Where is Carlos from?", opts: ["London", "A British family", "Brazil"], ans: 2 }, { q: "How does Carlos get to school?", opts: ["By car", "By bus", "He walks"], ans: 1 }, { q: "What does Carlos think about London's weather?", opts: ["It's better than in Brazil", "It's the same as in Brazil", "It's colder and rainier than in Brazil"], ans: 2 }] },
        { passage: "Notice: 'To all gym members. The swimming pool will be closed for cleaning from Monday, 10th August to Thursday, 13th August. It will open again on Friday, 14th August. We are sorry for any problems this may cause.'", questions: [{ q: "What is closed at the gym?", opts: ["The whole gym", "The swimming pool", "The changing rooms"], ans: 1 }, { q: "How long will it be closed?", opts: ["Three days", "Four days", "One week"], ans: 1 }, { q: "When can members use it again?", opts: ["On Monday", "On Thursday", "On Friday"], ans: 2 }] },
        { passage: "My best friend is called Sofia. She is very friendly and funny. She has long, dark hair and brown eyes. She loves playing the guitar and listening to rock music. We often go to concerts together. Her favourite food is pizza.", questions: [{ q: "What does Sofia look like?", opts: ["Friendly and funny", "Long, dark hair and brown eyes", "Loves rock music"], ans: 1 }, { q: "What does Sofia enjoy doing?", opts: ["Eating pizza", "Going to concerts alone", "Playing the guitar"], ans: 2 }, { q: "Who does the writer go to concerts with?", opts: ["Their family", "Sofia", "Their other friends"], ans: 1 }] },
        { passage: "Class Trip: 'Our class is going to the Science Museum next Wednesday. The bus will leave the school at 9:00 am. Please bring a packed lunch and a drink. We will return to school by 3:30 pm. You will need to wear your school uniform.'", questions: [{ q: "Where is the class going?", opts: ["To a park", "To the Science Museum", "To the school library"], ans: 1 }, { q: "What must students bring?", opts: ["Money for food", "Their own food and drink", "Science books"], ans: 1 }, { q: "What time will the trip finish?", opts: ["At 9:00 am", "At 3:30 pm", "After 3:30 pm"], ans: 1 }] },
        { passage: "For Sale: 'Blue mountain bike, almost new. I bought it six months ago but have only used it a few times. It's a great bike for parks and countryside. Price: ¬£100. Call Marco on 077-1234-5678.'", questions: [{ q: "What is for sale?", opts: ["A new bike", "A blue car", "A used bike"], ans: 2 }, { q: "Why is Marco selling the bike?", opts: ["It is too old", "He does not use it much", "He wants a new one"], ans: 1 }, { q: "How much does the bike cost?", opts: ["One hundred pounds", "One thousand pounds", "Seventy-seven pounds"], ans: 0 }] },
        { passage: "Website: 'Welcome to 'Happy Pets' pet shop. We sell everything you need for your favourite animal. We have food, toys, and beds for dogs, cats, fish, and birds. Find us at 15 Apple Street. We are open every day from 10 am to 5 pm.'", questions: [{ q: "What kind of shop is this?", opts: ["A toy shop", "A pet shop", "A food shop"], ans: 1 }, { q: "Which animal is NOT mentioned?", opts: ["Dogs", "Birds", "Rabbits"], ans: 2 }, { q: "When can you visit the shop?", opts: ["Only on weekdays", "Every day of the week", "Only in the morning"], ans: 1 }] },
        { passage: "Lost: 'I have lost my black wallet with my student card and about ¬£20 inside. I think I left it on the number 12 bus this morning. If you find it, please call me. My name is Anna and my number is 079-8765-4321. Thank you!'", questions: [{ q: "What did Anna lose?", opts: ["Her bus ticket", "Her student card", "Her black wallet"], ans: 2 }, { q: "Where does she think she lost it?", opts: ["In a shop", "On a bus", "At school"], ans: 1 }, { q: "What does Anna want people to do?", opts: ["Find her money", "Call her if they find the wallet", "Buy her a new student card"], ans: 1 }] }
    ];
    return { passageId: i + 1, ...passages[i] };
  })
};
const TOTAL_QUESTIONS = KETData.part1.length + (KETData.part2.length * 5) + (KETData.part3.length * 3);
const preferredVoices = { "Ava": "Microsoft Ava Online (Natural) - English (United States)", "Brian": "Microsoft Brian Online (Natural) - English (United States)", "Emma": "Microsoft Emma Online (Natural) - English (United Kingdom)", "Andrew": "Microsoft Andrew Online (Natural) - English (Australia)", "William": "Microsoft William Online (Natural) - English (United Kingdom)" };
let currentPart = 1, studentName = "", score = 0;
const userAnswers = {};
let draggedItem = null, tappedItem = null;
const successSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YS"+Array(300).join("120"));
const failSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YS"+Array(300).join("12109876543210"));
let availableVoices = [], voicesLoaded = false;


// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    loadVoices();
    renderAllParts();
    createFloatingElements();
});

function loadVoices() {
    if ('speechSynthesis' in window) {
        const setVoices = () => {
            availableVoices = speechSynthesis.getVoices();
            if (availableVoices.length > 0) { voicesLoaded = true; }
        };
        setVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = setVoices;
        }
    }
}


// --- CORE APP FLOW ---
function startTest() {
    studentName = document.getElementById('studentName').value.trim();
    if (!studentName) { alert('Please enter your name to start.'); return; }
    document.getElementById('headerTitle').textContent = `A2 KEY Practice for ${studentName}`;
    document.getElementById('studentInfo').classList.add('hidden');
    document.getElementById('progressContainer').classList.remove('hidden');
    document.getElementById('controls').classList.remove('hidden');
    showPart(1);
    document.getElementById('scoreDisplay').textContent = `Score: 0 / ${TOTAL_QUESTIONS}`;
}

function showPart(partNum) {
    currentPart = partNum;
    document.querySelectorAll('.part-container').forEach(p => p.classList.add('hidden'));
    document.getElementById(`part${partNum}`).classList.remove('hidden');
    document.getElementById('progressText').textContent = `Part ${partNum} of 3`;
    document.getElementById('progressFill').style.width = `${((partNum - 1) / 3) * 100}%`;
    document.getElementById('prevBtn').disabled = partNum === 1;
    document.getElementById('nextBtn').classList.toggle('hidden', partNum === 3);
    document.getElementById('finishBtn').classList.toggle('hidden', partNum !== 3);
}

function nextPart() { if (currentPart < 3) showPart(currentPart + 1); }
function previousPart() { if (currentPart > 1) showPart(currentPart - 1); }

function finishTest() {
    document.querySelectorAll('.part-container').forEach(p => p.classList.add('hidden'));
    document.getElementById('progressContainer').classList.add('hidden');
    document.getElementById('controls').classList.add('hidden');
    document.getElementById('resultsContainer').classList.remove('hidden');

    const percentage = Math.round((score / TOTAL_QUESTIONS) * 100);
    document.getElementById('finalScore').textContent = `Your Score: ${score} / ${TOTAL_QUESTIONS} (${percentage}%)`;
    let feedback = percentage >= 80 ? 'üåü Excellent work!' : percentage >= 60 ? 'üëç Good job!' : 'üìö Keep practicing!';
    document.getElementById('finalFeedback').textContent = feedback;
    speakText(`Practice Complete! Your score is ${score} out of ${TOTAL_QUESTIONS}. ${feedback}`, 'Emma');
}

function generateCertificate() {
    document.getElementById('resultsContainer').classList.add('hidden');
    document.getElementById('certificateContainer').classList.remove('hidden');
    document.getElementById('certificateStudentName').textContent = studentName;
    document.getElementById('certificateScore').textContent = `${score} / ${TOTAL_QUESTIONS}`;
    speakText(`Certificate generated for ${studentName}.`, 'Emma');
}

// --- DYNAMIC RENDERING ---
function renderAllParts() {
    // Part 1
    const part1Container = document.getElementById('part1Content');
    KETData.part1.forEach(q => {
        const qContainer = document.createElement('div');
        qContainer.className = 'question-container';
        qContainer.innerHTML = `
            <p class="question-text" onclick="speakText('${q.question}', 'Ava')"><strong>Q${q.id}:</strong> ${q.question}</p>
            <div onclick="speakText(this.innerText.replace(/\\n/g, ' '), 'Brian')">${q.stimulus}</div>
            <div class="options-container" id="options-${q.id}">
                ${q.options.map((opt, i) => `<div class="option" onclick="selectMCQOption(this, ${q.id}, ${i}, 'part1')"><div class="option-letter">${String.fromCharCode(65 + i)}</div><div class="option-text">${opt}</div></div>`).join('')}
            </div>`;
        part1Container.appendChild(qContainer);
    });

    // Part 2
    const part2Container = document.getElementById('part2Content');
    KETData.part2.forEach(story => {
        const storyContainer = document.createElement('div');
        storyContainer.className = 'question-container';
        
        // Prepare visual HTML with empty spans
        let storyHTML = story.story;
        story.answers.forEach((ans, index) => {
            storyHTML = storyHTML.replace('______', `<span class="drop-zone" id="drop-${story.storyId}-${index}" data-answer="${ans}"></span>`);
        });

        // Prepare audio text with "blank" and escape it for the onclick attribute
        const audioText = story.story.replaceAll('______', ' blank ').replace(/'/g, "\\'");

        // Set the innerHTML. Visual part doesn't have "blank", but the onclick does.
        storyContainer.innerHTML = `<p class="question-text" onclick="speakText('${audioText}', 'Ava')">${storyHTML}</p>`;
        
        const wordBank = [...story.answers].sort(() => 0.5 - Math.random());
        const wordBankContainer = document.createElement('div');
        wordBankContainer.className = 'word-bank';
        wordBankContainer.innerHTML = wordBank.map(word => `<div class="draggable-word" draggable="true">${word}</div>`).join('');
        storyContainer.appendChild(wordBankContainer);
        part2Container.appendChild(storyContainer);
    });
    setupDragDrop();
    
    // Part 3
    const part3Container = document.getElementById('part3Content');
    KETData.part3.forEach((passage, index) => {
        const passageContainer = document.createElement('div');
        passageContainer.className = 'question-container';
        let passageHTML = `<div class="reading-passage"><p onclick="speakText(this.innerText, 'William')">${passage.passage}</p></div>`;
        passage.questions.forEach((q, qIndex) => {
            const questionId = (KETData.part1.length + (index * 3)) + qIndex + 1;
            passageHTML += `
                <p class="question-text" onclick="speakText('${q.q}', 'Ava')"><strong>Q${questionId}:</strong> ${q.q}</p>
                <div class="options-container" id="options-${questionId}">
                    ${q.opts.map((opt, i) => `<div class="option" onclick="selectMCQOption(this, ${questionId}, ${i}, 'part3')"><div class="option-letter">${String.fromCharCode(65 + i)}</div><div class="option-text">${opt}</div></div>`).join('')}
                </div>`;
        });
        passageContainer.innerHTML = passageHTML;
        part3Container.appendChild(passageContainer);
    });
}

// --- INTERACTIVITY & SCORING ---
function speakText(text, voiceName = "Ava") {
    if (!voicesLoaded) { console.warn("Voices not loaded yet."); return; }
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    const targetVoiceName = preferredVoices[voiceName];
    const voice = availableVoices.find(v => v.name === targetVoiceName);
    if (voice) {
       utterance.voice = voice;
    } else {
        console.error(`Voice ${voiceName} (${targetVoiceName}) not found.`);
        // No generic fallback to meet strict requirement
    }
    utterance.rate = 0.85; // Slow down speech
    speechSynthesis.speak(utterance);
}

function selectMCQOption(el, qId, optIndex, part) {
    if (userAnswers[qId] !== undefined) return;
    let qData;
    if (part === 'part1') {
        qData = KETData.part1.find(q => q.id === qId);
    } else { // part3
        let questionIndex = 0;
        for (const passage of KETData.part3) {
            for (const question of passage.questions) {
                const currentQId = KETData.part1.length + (passage.passageId-1)*3 + questionIndex % 3 + 1;
                if(currentQId === qId){
                    qData = { answer: question.ans, feedback: "Correct!" }; // Simplified feedback for part 3
                    break;
                }
                questionIndex++;
            }
            if(qData) break;
        }
    }
    
    userAnswers[qId] = optIndex;
    const isCorrect = optIndex === qData.answer;
    const parent = el.closest('.options-container');
    el.classList.add(isCorrect ? 'correct' : 'incorrect');

    if (isCorrect) {
        score++;
        successSound.play();
        createRewardToken(el);
        speakText('Correct.', 'Emma');
    } else {
        failSound.play();
        parent.children[qData.answer].classList.add('correct');
        speakText('Incorrect.', 'Emma');
    }
    
    Array.from(parent.children).forEach(child => child.style.pointerEvents = 'none');
    updateScoreDisplay();
}

function setupDragDrop() {
    document.querySelectorAll('.draggable-word').forEach(item => {
        item.addEventListener('dragstart', e => { draggedItem = e.target; });
        item.addEventListener('click', e => {
            if (tappedItem) tappedItem.classList.remove('tapped');
            tappedItem = e.target;
            tappedItem.classList.add('tapped');
        });
    });
    document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.addEventListener('dragover', e => e.preventDefault());
        const handlePlacement = (e) => {
            e.preventDefault();
            const wordEl = e.type === 'drop' ? draggedItem : tappedItem;
            if (!wordEl || zone.textContent !== "") return;
            const qId = zone.id;
            if(userAnswers[qId] !== undefined) return;

            zone.textContent = wordEl.textContent;
            userAnswers[qId] = zone.textContent;
            const isCorrect = zone.dataset.answer.toLowerCase() === zone.textContent.toLowerCase();
            zone.classList.add(isCorrect ? 'correct' : 'incorrect');
            if (isCorrect) {
                score++;
                successSound.play();
                createRewardToken(zone);
            } else {
                failSound.play();
            }
            updateScoreDisplay();
            wordEl.style.display = 'none';
            if (tappedItem) tappedItem.classList.remove('tapped');
            draggedItem = null;
            tappedItem = null;
        };
        zone.addEventListener('drop', handlePlacement);
        zone.addEventListener('click', handlePlacement);
    });
}

function updateScoreDisplay() {
    document.getElementById('scoreDisplay').textContent = `Score: ${score} / ${TOTAL_QUESTIONS}`;
}

// --- AESTHETICS & REWARDS ---
function createFloatingElements() {
    const container = document.getElementById('floatingElements');
    if (container.children.length > 0) return;
    const elements = ['üìö', '‚úèÔ∏è', 'üéì', '‚≠ê', 'üèÜ', 'üìñ'];
    for (let i = 0; i < 15; i++) {
        const el = document.createElement('div');
        el.className = 'floating-element';
        el.textContent = elements[Math.floor(Math.random() * elements.length)];
        el.style.left = Math.random() * 100 + 'vw';
        el.style.top = Math.random() * 100 + 'vh';
        el.style.animationDelay = Math.random() * 12 + 's';
        container.appendChild(el);
    }
}

function createRewardToken(targetElement) {
    const token = document.createElement('div');
    token.textContent = '‚≠ê';
    token.className = 'reward-token';
    document.body.appendChild(token);
    const startRect = targetElement.getBoundingClientRect();
    const scoreRect = document.getElementById('scoreDisplay').getBoundingClientRect();
    token.style.left = `${startRect.left + startRect.width / 2}px`;
    token.style.top = `${startRect.top + startRect.height / 2}px`;
    const styleSheet = document.styleSheets[0];
    const keyframes = `@keyframes flyToScore {
        0% { opacity: 1; transform: translate(0, 0) scale(1.5); }
        100% { 
            opacity: 0; 
            transform: translate(calc(${scoreRect.left}px - ${startRect.left}px - 10px), calc(${scoreRect.top}px - ${startRect.top}px)) scale(0.5); 
        }
    }`;
    for(let i=0; i<styleSheet.cssRules.length; i++){
        if(styleSheet.cssRules[i] && styleSheet.cssRules[i].name === 'flyToScore'){
            styleSheet.deleteRule(i);
            break;
        }
    }
    styleSheet.insertRule(keyframes, styleSheet.cssRules.length);
    token.style.animation = `flyToScore 1s ease-in-out forwards`;
    setTimeout(() => token.remove(), 1000);
}
</script>
</body>
</html>
