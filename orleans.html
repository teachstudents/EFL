<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Orleans ‚Äì A City of Music, Culture, and Resilience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @keyframes mardiGras {
            0% { background-color: #581c87; } /* purple-900 */
            25% { background-color: #166534; } /* green-800 */
            50% { background-color: #f59e0b; } /* amber-500 */
            75% { background-color: #166534; } /* green-800 */
            100% { background-color: #581c87; } /* purple-900 */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            animation: mardiGras 240s linear infinite;
            padding-top: 85px; /* Adjusted padding for progress bar */
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
            border: none;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px -1px rgba(0,0,0,0.2), 0 1px 2px -2px rgba(0,0,0,0.1), inset 0 -2px 0 0 rgba(0,0,0,0.2);
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 44px; padding: 0 4px;
            border: 2px dashed #9ca3af; border-radius: 8px; margin: 0 4px;
            vertical-align: middle; background-color: #f3f4f6;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 8px;
            background-color: white; user-select: none;
        }
        .word-bank-word.selected { outline: 2px solid #6366f1; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; }
        .gap.correct .word-bank-word { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .gap.incorrect .word-bank-word { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Feedback Message & Badge Notification */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #fde047, #f97316); }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 20px; } to { opacity: 0; bottom: 0; } }

        /* Certificate Canvas */
        #completion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* Progress Bar */
        #progress-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 8px; width: 100%; margin-top: 8px; }
        #progress-bar { height: 100%; width: 0%; background-color: #a855f7; transition: width 0.5s ease-out; }
        
        /* Vocab Game Timer */
        #vocab-game-timer-bar { height: 6px; background-color: #a855f7; transition: width 0.1s linear; }
        
        /* Shake Animation for incorrect answers */
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        .explanation-text {
            margin-top: 12px;
            padding: 10px;
            background-color: #f3f4f6;
            border-left: 4px solid #f59e0b;
            font-size: 0.9em;
            color: #4b5563;
            border-radius: 4px;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #certificate-to-print, #certificate-to-print * { visibility: visible; }
            #certificate-to-print { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="antialiased text-gray-800 text-lg">
    <canvas id="background-canvas"></canvas>
    <div id="reward-animation-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]"></div>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-md mx-auto bg-white/90 backdrop-blur-sm shadow-lg rounded-full p-2">
            <div class="flex justify-center items-center gap-2">
                <button onclick="goBack()" class="nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="font-bold text-base text-purple-600 px-3 whitespace-nowrap">Points üé∑: <span id="score-display">0</span></div>
                <button onclick="navigateTo('main-menu')" class="nav-button bg-gray-800 text-white font-bold p-2 rounded-full hover:bg-gray-900">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                </button>
                <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-full hover:bg-gray-200" title="Toggle Sound">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
                </button>
                <button onclick="goNext()" class="nav-button bg-purple-600 hover:bg-purple-700 text-white font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
        </div>
    </header>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <section id="page-title-screen" class="page active text-center bg-white rounded-2xl shadow-lg p-8">
            <div class="h-full flex flex-col justify-center items-center">
                <h1 id="main-title" class="text-5xl md:text-6xl font-bold text-slate-800 mb-4"></h1>
                <p id="main-subtitle" class="text-xl md:text-2xl text-gray-600 mb-8"></p>
                <div id="main-svg-container" class="rounded-lg mb-8 w-full max-w-lg mx-auto"></div>
                <button onclick="startApp()" class="action-button bg-purple-600 text-white font-bold py-3 px-8 rounded-full text-2xl hover:bg-purple-700">START LESSON</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION (NEW ORLEANS, USA) ---
        // ===================================================================================
        const lessonData = {
            title: "New Orleans",
            subtitle: "A City of Music, Culture, and Resilience <span aria-hidden='true'>üé∑üé≠üêä</span>",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-tps', text: '0. Think-Pair-Share <span aria-hidden="true">üß†</span>', color: 'green', target: 'tps-start' },
                { id: 'menu-goals', text: '1. Learning Goals <span aria-hidden="true">üéØ</span>', color: 'teal', target: 'learning-goals' },
                { id: 'menu-warmup', text: '2. Warm-Up & Vocab <span aria-hidden="true">üìö</span>', color: 'sky', target: 'warm-up' },
                { id: 'menu-vocab-game', text: 'Vocab Game <span aria-hidden="true">üéÆ</span>', color: 'sky', target: 'vocab-game'},
                { id: 'menu-reading', text: '3. Reading & Comprehension <span aria-hidden="true">üìñ</span>', color: 'blue', target: 'reading-main' },
                { id: 'menu-convo', text: '4. Conversation Practice <span aria-hidden="true">üó£Ô∏è</span>', color: 'indigo', target: 'conversation-practice' },
                { id: 'menu-lecture-environment', text: '5. Listening: Environmental Challenges <span aria-hidden="true">üå™Ô∏è</span>', color: 'amber', target: 'lecture-environment-pre' },
                { id: 'menu-discussion', text: '6. Listening: Classroom Discussion <span aria-hidden="true">üí¨</span>', color: 'lime', target: 'discussion-pre' },
                { id: 'menu-thinking', text: '7. Thinking & Exam Prep <span aria-hidden="true">üìù</span>', color: 'purple', target: 'thinking-prompts' },
                { id: 'menu-final', text: '8. Final Project <span aria-hidden="true">‚úçÔ∏è</span>', color: 'violet', target: 'final-project-hub' },
            ],
            vocabulary: [
                { word: 'Jazz', def: 'A style of music that originated in New Orleans.', sentence: 'Jazz music can be heard all over the streets of New Orleans.' },
                { word: 'Creole', def: 'A cultural blend of French, African, and Spanish influences.', sentence: 'Creole cuisine is famous for its rich flavors and unique spices.' },
                { word: 'Mardi Gras', def: 'A festival celebrated with parades, music, and costumes.', sentence: 'During Mardi Gras, the city is filled with color and excitement.' },
                { word: 'Resilience', def: 'The ability to recover from difficulties.', sentence: 'The people of New Orleans showed incredible resilience after the hurricane.' },
                { word: 'Hurricane', def: 'A powerful storm with strong winds and heavy rain.', sentence: 'Hurricane Katrina was a devastating event in the city\'s history.' }
            ],
            pages: [
                // 0. Think Pair Share
                { id: 'tps-start', type: 'simple', content: { title: 'Activity: Think-Pair-Share <span aria-hidden="true">üß†</span>', text: 'Let\'s explore cultural traditions.' } },
                { id: 'tps-think', type: 'timer', content: { title: '1. Think <span aria-hidden="true">ü§î</span>', text: 'Think about a cultural tradition or festival in your hometown. What does it celebrate? How does it bring people together?', duration: 120, timerId: 'timer-think' } },
                { id: 'tps-pair', type: 'timer', content: { title: '2. Pair <span aria-hidden="true">üë•</span>', text: 'With a partner, discuss how your local tradition compares to a big, famous festival like Mardi Gras in New Orleans.', duration: 180, timerId: 'timer-pair' } },
                { id: 'tps-share', type: 'timer', content: { title: '3. Share <span aria-hidden="true">üó£Ô∏è</span>', text: 'Let\'s share our ideas. How do festivals and traditions shape the identity of a city?', duration: 300, timerId: 'timer-share' } },
                
                // 1. Learning Goals
                { id: 'learning-goals', type: 'html-content', content: { title: 'Learning Goals <span aria-hidden="true">üéØ</span>', html: `
                                        <div class="text-left space-y-4">
                                            <p><strong class="text-teal-600">Learning Intention:</strong> We are learning about New Orleans to understand how culture and history influence a city's identity and how its community responds to challenges.</p>
                                            <hr class="my-4">
                                            <h3 class="text-2xl font-bold text-teal-600 mb-3">Success Criteria</h3>
                                            <ul class="list-disc list-inside space-y-2 text-xl">
                                                <li>I can describe the key musical, cultural, and historical features of New Orleans.</li>
                                                <li>I can compare life in New Orleans with my own hometown, using specific examples.</li>
                                                <li>I can analyze how cultural diversity contributes to a community's resilience.</li>
                                            </ul>
                                        </div>` } },
                
                // 2. Warm-Up & Vocab
                { id: 'warm-up', type: 'html-content', content: { title: 'Background-Building Questions <span aria-hidden="true">üìö</span>', html: `
                                        <ol class="list-decimal list-inside space-y-4 text-xl text-left">
                                            <li>What kind of music do you think of when you hear the name "New Orleans"? üé∫</li>
                                            <li>Have you ever been to a big festival or parade? What was it like?</li>
                                            <li>What do you think helps a community stay strong and recover after a difficult event?</li>
                                            <li>What is "Creole" food? Have you ever tried any? üç≤</li>
                                        </ol>` } },
                { id: 'vocab-start', type: 'simple', content: { title: 'Unit Vocabulary <span aria-hidden="true">üìö</span>', text: 'Let\'s learn the key terms for this unit. Click the "Next" arrow to cycle through the words.' } },
                { id: 'vocab-game', type: 'vocab-game', content: { title: 'Vocabulary Review Game <span aria-hidden="true">üéÆ</span>'} },
                
                // 3. Reading & Comprehension
                { id: 'reading-main', type: 'html-content', content: { title: 'Reading: New Orleans ‚Äì A City of Culture and Strength <span aria-hidden="true">üìñ</span>', html: `
                                        <div class="space-y-6 text-left">
                                            <div class="bg-purple-50 p-4 rounded-lg">
                                                <h4 class="font-bold text-xl text-purple-800">Location and History üó∫Ô∏è</h4>
                                                <p>New Orleans is located in Louisiana, USA, near the mouth of the Mississippi River. Founded by the French in 1718, its history is a rich blend of French, African, Spanish, and Caribbean cultures, creating a unique identity found nowhere else.</p>
                                            </div>
                                            <div class="bg-green-50 p-4 rounded-lg">
                                                <h4 class="font-bold text-xl text-green-800">Music and Festivals üé∂</h4>
                                                <p>New Orleans is celebrated as the birthplace of <strong>Jazz</strong>. The city‚Äôs heart beats to a rhythm of music, which can be heard pouring from clubs, street corners, and parades. The most famous celebration is <strong>Mardi Gras</strong>, an annual festival of colorful parades, elaborate costumes, and non-stop music.</p>
                                            </div>
                                            <div class="bg-amber-50 p-4 rounded-lg">
                                                <h4 class="font-bold text-xl text-amber-800">Food and Culture üç≤</h4>
                                                <p><strong>Creole</strong> and Cajun cuisines are famous worldwide. Dishes like gumbo and jambalaya tell the story of the city's multicultural roots, blending European, African, and local flavors into something truly special.</p>
                                            </div>
                                             <div class="bg-red-50 p-4 rounded-lg">
                                                <h4 class="font-bold text-xl text-red-800">Resilience and Community üå™Ô∏è</h4>
                                                <p>In 2005, a powerful <strong>hurricane</strong> named Katrina brought major devastation to the city. In the face of this tragedy, the people of New Orleans showed incredible <strong>resilience</strong>. They rebuilt their city with strength, creativity, and a deep reliance on community. Art, music, and cultural traditions played key roles in healing and recovery.</p>
                                            </div>
                                             <div class="bg-sky-50 p-4 rounded-lg">
                                                <h4 class="font-bold text-xl text-sky-800">Education and Identity üßë‚Äçüè´</h4>
                                                <p>Schools in New Orleans often teach students about their city‚Äôs unique history and culture. Students learn to value diversity and are encouraged to express themselves through music and art, ensuring the city's vibrant identity continues for generations to come.</p>
                                            </div>
                                        </div>` } },
                { id: 'reading-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap-Fill', sentences: [] } },
                { id: 'reading-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False', questions: [] } },
                { id: 'reading-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [] } },
                
                // 4. Conversation Practice
                { id: 'conversation-practice', type: 'dialogue', content: { title: 'Conversation Practice <span aria-hidden="true">üó£Ô∏è</span>', dialogue: "A: Have you ever heard of New Orleans?\n\nB: Yes! It‚Äôs famous for jazz music and Mardi Gras, right? üé∑üé≠\n\nA: Exactly. The music there is amazing.\n\nB: I heard they had a big hurricane a while ago.\n\nA: Yes, Hurricane Katrina. It was devastating, but the people showed incredible resilience and rebuilt their city.\n\nB: That‚Äôs so inspiring. I‚Äôd love to visit someday and hear live jazz in the French Quarter.\n\nA: Me too! And we have to try some real gumbo! üç≤" } },

                // 5. Listening: Environmental Challenges
                { id: 'lecture-environment-pre', type: 'html-content', content: { title: 'Pre-Listening: Environmental Challenges <span aria-hidden="true">üå™Ô∏è</span>', html: `<div class="text-left space-y-4 text-xl"><p>Before listening to the lecture, consider these questions:</p><ol class="list-decimal list-inside pl-4 space-y-2"><li>Why might a city built near a large river and the ocean be at risk?</li><li>What does the word "resilience" mean to you in the context of a community?</li></ol></div>`}},
                { id: 'lecture-environment-main', type: 'dialogue', content: { title: 'Listening: Environmental Challenges', dialogue: "Professor: Good morning, class. Today, we're going to focus on a city we've touched upon briefly, New Orleans. While it's celebrated for its vibrant culture and history, it also faces significant environmental challenges. Today we'll explore one major problem: its vulnerability to hurricanes and the impacts of climate change. So to begin, based on what we know about New Orleans' geography, why is it particularly vulnerable to hurricanes and flooding? What geographical features make it susceptible, Leo?\n\nLeo: Well, Dr. Reed, it's uh, really low down, isn't it? Like, below sea level in some parts. And it's uh, right by the coast near the Gulf of Mexico where hurricanes come from.\n\nProfessor: Excellent points, Leo. New Orleans' low elevation, with much of the city built on drained swampland and actually below sea level, makes it highly susceptible to flooding. Its location on the Gulf Coast puts it directly in the path of hurricanes. In addition to this, Sofia, what role do the surrounding natural landscapes play in its vulnerability? Think about the Mississippi River Delta and the wetlands.\n\nSofia: Um, aren't the swamps and wetlands supposed to, like, protect the city, like act as a buffer? But maybe they're disappearing?\n\nProfessor: You're touching on a critical issue, Sofia. Historically, the extensive wetlands and barrier islands of the Mississippi River Delta provided a natural buffer against storm surges from hurricanes. However, due to factors like subsidence, the sinking of land, erosion, and the channeling of the Mississippi River, these protective wetlands are rapidly disappearing. This loss leaves New Orleans more exposed. We cannot discuss this vulnerability without mentioning Hurricane Katrina in 2005. What were some of the major consequences of Hurricane Katrina for New Orleans, Leo?\n\nLeo: Oh, that was uh, really bad, right? The levees broke and uh, most of the city flooded, and lots of people lost their homes and had to leave.\n\nProfessor: Tragically, yes, Leo. The failure of the levee system was a catastrophic event, leading to widespread and prolonged flooding of about 80% of the city. The human cost was immense, with significant loss of life and the displacement of hundreds of thousands of residents. The economic and social impacts were devastating and long-lasting. Looking ahead, how does climate change exacerbate New Orleans' vulnerability to hurricanes and flooding? What are the connections, Sofia?\n\nSofia: Um, climate change is making the sea level rise, right? So that makes the flooding worse. And maybe it makes hurricanes stronger?\n\nProfessor: You're exactly right, Sofia. Rising sea levels, a direct consequence of climate change, mean that storm surges from hurricanes can reach higher and push further inland. Additionally, warmer ocean waters can fuel more intense hurricanes, increasing the threat to coastal cities like New Orleans. So, New Orleans faces a complex and ongoing challenge: its geographical vulnerability, the loss of natural protections, and the intensifying effects of climate change. The city and its residents have demonstrated incredible resilience, but addressing these issues requires significant effort. For our enduring understanding question today, considering the significant environmental challenges facing New Orleans, particularly its vulnerability to hurricanes, flooding, and the impacts of climate change, what virtues or values do you believe are most essential for the residents and leadership of New Orleans in facing and adapting to these ongoing threats? What can we learn from their situation about community, resilience, and planning for the future in the face of environmental challenges? Leo?\n\nLeo: I guess resilience is a big one like you said, bouncing back after something like Katrina. And community spirit, helping each other out when things are bad, and maybe a determination to rebuild and protect their city.\n\nSofia: And I think, um, maybe adaptability, like finding new ways to live with the risks. And, um, foresight, planning for future storms and sea level rise. And, um, hope, not giving up on their city.\n\nProfessor: Excellent and very insightful points, both of you. Resilience in the face of repeated disasters, a strong sense of community and mutual support, determination to protect their unique heritage and home, adaptability in developing new strategies for living with environmental risks, foresight in planning and investing in infrastructure and restoration, and unwavering hope for the future of their city. These virtues and values are clearly essential for New Orleans. Their situation teaches us profound lessons about the importance of community cohesion, resilience, proactive adaptation, and long-term planning when facing significant environmental challenges, lessons that are increasingly relevant for coastal communities worldwide. Thank you both, Sofia and Leo, for your thoughtful contributions today, and thank you all for joining us for this discussion on the environmental challenges facing New Orleans." }},
                { id: 'lecture-environment-quiz-mcq', type: 'quiz-mcq', content: { title: 'Environmental Challenges Quiz (MCQ)', questions: [] } },
                { id: 'lecture-environment-quiz-tfng', type: 'quiz-tfng', content: { title: 'Environmental Challenges Quiz (TFNG)', questions: [] } },
                { id: 'lecture-environment-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Environmental Challenges Quiz (Gap Fill)', sentences: [] } },
                
                // 6. Listening: Classroom Discussion
                { id: 'discussion-pre', type: 'html-content', content: { title: 'Pre-Listening: Classroom Discussion <span aria-hidden="true">üí¨</span>', html: `<div class="text-left space-y-4 text-xl"><p>Before listening, consider:</p><ol class="list-decimal list-inside pl-4 space-y-2"><li>What makes a place feel "authentic"?</li><li>How can music and food tell the story of a city's history?</li></ol></div>`}},
                { id: 'discussion-main', type: 'dialogue', content: { title: 'Listening: Classroom Discussion', dialogue: "Professor: Alright class, welcome back. Today, we're going to explore a city unlike any other: New Orleans, Louisiana. Known as the 'Big Easy', it's a place steeped in music, culture, and a remarkable history of resilience. To kick us off, Emily, coming from Australia, what were your initial impressions or anything that stood out to you about New Orleans?\n\nEmily: Thanks, professor. I guess what struck me first was the incredible mix of cultures. It seems like it's got French, Spanish, African, and American influences all blended together, which sounds really unique.\n\nProfessor: That's a great observation, Emily. That blend of influences is really at the heart of New Orleans. Oliver, from the UK, what aspects of its culture or perhaps its reputation for music resonate with you?\n\nOliver: Hello, professor. I've always associated New Orleans with jazz music. It seems like that's a massive part of its identity. I'm keen to learn more about how that musical heritage developed.\n\nProfessor: Absolutely, Oliver. New Orleans is the birthplace of jazz, and music is woven into the fabric of daily life there, from the streets to the clubs. Beyond the music, what about its unique culture and traditions? Emily, what did you find interesting?\n\nEmily: I was really interested in the festivals, especially Mardi Gras. It looks like such a huge, colorful celebration. And the food! I've heard so much about Creole and Cajun food, I'd love to try it.\n\nProfessor: Mardi Gras is certainly iconic, Emily. It's a massive celebration of life and culture. And the food, New Orleans cuisine is legendary, a delicious mix of Creole and Cajun influences. Oliver, the city also has a deep and complex history, including its resilience in the face of challenges. What did you learn about that?\n\nOliver: Yes, professor. I read about Hurricane Katrina and the flooding. It sounded absolutely horrific, but also about how the community really came together to help each other and rebuild. The resilience of the people seems incredible.\n\nProfessor: You've highlighted a pivotal moment, Oliver. Hurricane Katrina was devastating, but the spirit of the people and their determination to rebuild is truly inspiring. It's a testament to the city's resilience. While New Orleans has overcome much, it still faces challenges. Emily, what are some of the ongoing issues?\n\nEmily: I think one of the biggest challenges I read about is the environmental threat, particularly coastal erosion. Being below sea level in many parts makes it really vulnerable. And I guess like many popular tourist cities, balancing that with local life must be hard.\n\nProfessor: Those are significant points, Emily. Coastal erosion is a serious environmental threat, and addressing economic disparities and crime are crucial for the city's future. Oliver, what about the challenge of preserving its unique cultural authenticity amidst growing tourism?\n\nOliver: I agree with Emily. Tourism is obviously important, but how do they keep the French Quarter and other historic areas from just becoming, I don't know, a theme park? Preserving the real culture must be a constant effort.\n\nProfessor: That's a vital balance to strike, Oliver. Tourism is economically important, but it needs to be managed in a way that respects and supports the local culture, not dilutes it. So, in conclusion, New Orleans is a city of vibrant contradictions, a place that has faced immense hardship but continues to celebrate life through its music, food, and unique cultural traditions. Its resilience is as much a part of its identity as its festive spirit. Thank you both for sharing your insights into this extraordinary city." }},
                { id: 'discussion-quiz-mcq', type: 'quiz-mcq', content: { title: 'Discussion Quiz (MCQ)', questions: [] } },
                { id: 'discussion-quiz-tfng', type: 'quiz-tfng', content: { title: 'Discussion Quiz (TFNG)', questions: [] } },
                { id: 'discussion-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Discussion Quiz (Gap Fill)', sentences: [] } },
                
                // 7. Thinking & Exam Prep
                { id: 'thinking-prompts', type: 'html-content', content: { title: 'Thinking & Exam Prep <span aria-hidden="true">üìù</span>', html: `
                                        <div class="text-left space-y-8">
                                            <div>
                                                <h3 class="text-2xl font-bold text-purple-600 mb-3">Higher-Order Thinking Questions</h3>
                                                <ul class="list-disc list-inside space-y-2 text-lg">
                                                    <li><b>Analyze:</b> How does New Orleans‚Äôs history of cultural blending influence its music and food today?</li>
                                                    <li><b>Evaluate:</b> In your opinion, is cultural diversity a strength or a challenge for a city like New Orleans, especially during times of crisis?</li>
                                                    <li><b>Create:</b> Design a small cultural event for your own school that celebrates your local identity, inspired by New Orleans's festivals. What would it include?</li>
                                                </ul>
                                            </div>
                                             <div>
                                                <h3 class="text-2xl font-bold text-purple-600 mb-3">IELTS & TOEFL Practice</h3>
                                                <p class="mb-2"><strong>IELTS Part 2:</strong> Talk about a cultural festival you have attended or know about.</p>
                                                <p><strong>TOEFL Speaking:</strong> What role does music play in shaping the identity of a city or country? Use specific examples.</p>
                                            </div>
                                        </div>` } },

                // 8. Final Project
                { id: 'final-project-hub', type: 'html-content', content: { title: 'Final Project Hub <span aria-hidden="true">‚úçÔ∏è</span>', html: `
                                        <div class="bg-white rounded-2xl shadow-xl p-8 text-left">
                                        <h2 class="text-3xl font-bold text-violet-600 mb-4">GRASPS Task: A Tale of Two Cities üé≠</h2>
                                        <div class="space-y-3 text-lg">
                                            <p><strong class="font-semibold text-violet-700">Goal:</strong> To create a multimedia presentation comparing the culture of New Orleans with your own hometown.</p>
                                            <p><strong class="font-semibold text-violet-700">Role:</strong> You are a cultural ambassador preparing a presentation for an international student festival.</p>
                                            <p><strong class="font-semibold text-violet-700">Audience:</strong> A diverse group of students from around the world.</p>
                                            <p><strong class="font-semibold text-violet-700">Situation:</strong> You need to create a presentation that explains what makes New Orleans unique while also showing how its core elements of music, food, and community compare to your own local culture.</p>
                                            <p><strong class="font-semibold text-violet-700">Product:</strong> A 5-slide multimedia presentation that compares 1) Music, 2) Food, and 3) A major festival or community tradition between New Orleans and your hometown.</p>
                                            <p><strong class="font-semibold text-violet-700">Standards:</strong> Your presentation should be visually creative, use clear examples, and offer a thoughtful reflection on how different cultures build community.</p>
                                        </div>
                                        </div>` } },
                { id: 'writing-task', type: 'writing-task', content: { 
                    title: 'Project Writing Activity <span aria-hidden="true">‚úçÔ∏è</span>', 
                    prompt: 'For your presentation, write a paragraph (200-250 words) comparing a major festival in New Orleans (like Mardi Gras) with a cultural tradition in your hometown. How do both events bring people together and express the identity of the community?', 
                    starters: [
                        "New Orleans is world-famous for its Mardi Gras celebration, which is...",
                        "In my hometown, we have a tradition called..., which is similar because...",
                        "While Mardi Gras involves massive parades and costumes, our tradition focuses on...",
                        "Both celebrations, however, show the importance of..."
                    ],
                    wordBank: ['celebration', 'community', 'Creole', 'culture', 'diversity', 'festival', 'heritage', 'history', 'jazz', 'Mardi Gras', 'music', 'parade', 'resilience', 'tradition']
                } },
                { id: 'self-assessment', type: 'html-content', content: { title: 'Self-Assessment <span aria-hidden="true">üßë‚Äçüè´</span>', html: `
                                        <div class="text-left">
                                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Metacognitive Self-Assessments</h3>
                                            <ol class="list-decimal list-inside space-y-4 text-xl">
                                                <li>What was the most interesting connection I found between New Orleans's history and its culture today?</li>
                                                <li>How did learning about New Orleans's resilience after Hurricane Katrina change my understanding of community strength?</li>
                                            </ol>
                                        </div>` } },
                { id: 'certificate', type: 'certificate', content: { title: 'Module Complete! <span aria-hidden="true">üéâ</span>', text: 'You have successfully completed the "A City of Music, Culture, and Resilience" module.', certificateTitle: 'Certificate of Cultural Exploration' } }
            ]
        };
        // --- END OF LESSON CONTENT CONFIGURATION ---
        // ===================================================================================

        class SpeechService {
             constructor() {
                 this.synth = window.speechSynthesis;
                 this.isInitialized = false;
                 this.isTtsEnabled = true;
                 this.voices = {};
                 this.speechRate = 0.85;
                 this.isDialoguePlaying = false;
                 this.keepAliveInterval = null;
             }

             _startKeepAlive() {
                if (this.keepAliveInterval) {
                    clearInterval(this.keepAliveInterval);
                }
                this.keepAliveInterval = setInterval(() => {
                    if (this.synth && !this.synth.speaking) {
                        this.synth.pause();
                        this.synth.resume();
                    }
                }, 12000); 
            }
    
            _stopKeepAlive() {
                if (this.keepAliveInterval) {
                    clearInterval(this.keepAliveInterval);
                    this.keepAliveInterval = null;
                }
            }
             
             async _setupVoices() {
                 const voicesPromise = new Promise(resolve => { if (this.synth.getVoices().length) return resolve(this.synth.getVoices()); this.synth.onvoiceschanged = () => resolve(this.synth.getVoices()); });
                 const availableVoices = await voicesPromise;
                 if (!availableVoices.length) { console.warn("No speech synthesis voices available."); return; }
                 const speakerToVoiceMap = {
                    'a': ['Microsoft Emma Online (Natural) - English (United States)', 'Microsoft Ava Online (Natural) - English (United States)'],
                    'b': ['Microsoft Brian Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)'],
                    'professor': ['Microsoft Brian Online (Natural) - English (United States)', 'Google US English'],
                    'emily': ['Microsoft Emma Online (Natural) - English (United States)', 'Google US English'],
                    'oliver': ['Microsoft Andrew Online (Natural) - English (United States)', 'Google US English'],
                 };
                 for (const speaker in speakerToVoiceMap) {
                     const voicePriorityList = speakerToVoiceMap[speaker];
                     let chosenVoice = null;
                     for (const voiceName of voicePriorityList) {
                         const foundVoice = availableVoices.find(v => v.name === voiceName);
                         if (foundVoice) { chosenVoice = foundVoice; break; }
                     }
                     if (chosenVoice) { this.voices[speaker] = chosenVoice; } else { console.warn(`Could not find specified voices for speaker: "${speaker}"`); }
                 }
                 this.voices['default'] = availableVoices.find(v => v.name === 'Microsoft Ava Online (Natural) - English (United States)') || availableVoices.find(v => v.lang === 'en-US');
             }

             async init() {
                 if (this.isInitialized) return;
                 try {
                     const warmUp = new SpeechSynthesisUtterance(' ');
                     warmUp.volume = 0;
                     this.synth.speak(warmUp);
                     this.synth.cancel(); 
                     await this._setupVoices();
                     this.isInitialized = true;
                     this._startKeepAlive();
                 } catch (e) {
                     console.error("Speech synthesis setup failed:", e);
                 }
             }
             
             _cleanTextForSpeech(text) { const tempDiv = document.createElement('div'); const textWithoutSpans = text.replace(/<span aria-hidden="true">.*?<\/span>/g, ' '); tempDiv.innerHTML = textWithoutSpans; let cleanText = tempDiv.textContent || tempDiv.innerText || ''; cleanText = cleanText.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, ''); return cleanText; }
             
             async speak(text, { onEndCallback = null, voiceKey = 'default' } = {}) { 
                if (!this.isInitialized || !this.isTtsEnabled || !text) { 
                    if (onEndCallback) onEndCallback(); 
                    return; 
                } 
                if (this.synth.speaking) { 
                    this.synth.cancel(); 
                    await new Promise(resolve => setTimeout(resolve, 100)); 
                } 
                const cleanText = this._cleanTextForSpeech(text); 
                if (!cleanText.trim()) { 
                    if (onEndCallback) onEndCallback(); 
                    return; 
                } 
                const utter = new SpeechSynthesisUtterance(cleanText); 
                utter.voice = this.voices[voiceKey] || this.voices['default']; 
                utter.rate = this.speechRate; 
                utter.onend = () => {
                    if (onEndCallback) onEndCallback();
                };
                utter.onerror = (e) => { 
                    console.warn('SpeechSynthesisUtterance.onerror. Trying to recover.', e); 
                    try { this.synth.cancel(); } catch (cancelError) { /* ignore */ }
                    if (onEndCallback) {
                        setTimeout(onEndCallback, 100);
                    }
                }; 
                try { 
                    this.synth.speak(utter); 
                } catch (e) { 
                    console.error("Error calling synth.speak:", e); 
                    if (onEndCallback) onEndCallback(); 
                } 
            }
            
             async speakDialogue(text) { if (!this.isInitialized || !this.isTtsEnabled || !text || this.isDialoguePlaying) return; this.cancel(); this.isDialoguePlaying = true; const lines = text.split('\n').filter(line => line.trim() !== '' && line.includes(':')); const queue = lines.map(line => { const [speaker, ...parts] = line.split(':'); const dialogue = parts.join(':').trim(); const cleanDialogue = this._cleanTextForSpeech(dialogue); const voiceKey = speaker.toLowerCase().replace(/dr\. |professor /g, '').trim(); return { text: cleanDialogue, voiceKey: voiceKey }; }).filter(item => item.text); if (queue.length === 0) { this.isDialoguePlaying = false; return; } const playNext = () => { if (queue.length > 0 && this.isTtsEnabled) { const item = queue.shift(); const utter = new SpeechSynthesisUtterance(item.text); utter.voice = this.voices[item.voiceKey] || this.voices['default']; utter.rate = this.speechRate; utter.onend = playNext; utter.onerror = (e) => { console.warn('A speech synthesis error occurred, attempting to recover.', e.error); try { this.synth.cancel(); } catch (cancelError) { console.error("Error while cancelling synth:", cancelError); } setTimeout(playNext, 250); }; try { this.synth.speak(utter); } catch(e) { console.error("Error in synth.speak:", e); setTimeout(playNext, 250); } } else { this.isDialoguePlaying = false; } }; playNext(); }
             
             cancel() { if (this.synth) { this.isDialoguePlaying = false; this.synth.cancel(); } }
             
             toggleTTS(forceState) { this.isTtsEnabled = forceState === undefined ? !this.isTtsEnabled : forceState; if (!this.isTtsEnabled) { this.cancel(); } return this.isTtsEnabled; }
        }

        // --- Global App State and Functions ---
        const speechService = new SpeechService();
        let score = 0, currentPage = lessonData.startPageId, timerInterval;
        const pageHistory = [lessonData.startPageId];
        let pageSequence = [];
        let completedSections = new Set();
        let vocabGameTimer;
        let selectedWord = { element: null, text: '' };

        // --- Sound and Reward Effects ---
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();
        const noiseSynth = new Tone.NoiseSynth().toDestination();
        
        function playCorrectSound() {
            if (!speechService.isTtsEnabled) return;
            try {
                const now = Tone.now();
                synth.triggerAttackRelease(["C5", "E5", "G5"], "8n", now);
            } catch(e) {
                console.warn("Tone.js sound failed to play:", e);
            }
        }
        
        function playIncorrectSound() {
            if (!speechService.isTtsEnabled) return;
            try {
                noiseSynth.triggerAttackRelease("4n");
            } catch(e) {
                console.warn("Tone.js sound failed to play:", e);
            }
        }

        function triggerRewardAnimation() {
            const container = document.getElementById('reward-animation-container');
            if (!container) return;
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                const colors = ['#a855f7', '#16a34a', '#facc15', '#eab308'];
                confetti.style.position = 'absolute';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * -50 - 50}px`;
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = confetti.style.width;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.opacity = '1';
                
                container.appendChild(confetti);

                const animation = confetti.animate([
                    { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
                    { transform: `translateY(120vh) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                ], {
                    duration: Math.random() * 3000 + 4000,
                    easing: 'ease-out',
                    iterations: 1
                });

                animation.onfinish = () => {
                    confetti.remove();
                };
            }
        }

        // --- Progress and Completion Logic ---
        const pageToMenuMap = {};
        function buildPageToMenuMap() {
            lessonData.mainMenu.forEach(menuItem => {
                let queue = [menuItem.target];
                let visited = new Set(queue);
                while (queue.length > 0) {
                    const pageId = queue.shift();
                    pageToMenuMap[pageId] = menuItem.id;
                    const pageDef = lessonData.pages.find(p => p.id === pageId);
                    if (pageDef && pageDef.type.startsWith('quiz')) {
                        const nextQuizPage = getNextQuizPage(pageId);
                        if (nextQuizPage && !visited.has(nextQuizPage) && lessonData.pages.some(p => p.id === nextQuizPage)) {
                            queue.push(nextQuizPage);
                            visited.add(nextQuizPage);
                        }
                    }
                }
            });
            // Manual mapping for vocab game
            pageToMenuMap['vocab-game'] = 'menu-vocab-game';
        }

        function getNextQuizPage(pageId) {
            const sequence = ['mcq','tfng', 'gap-fill'];
            const parts = pageId.split('-quiz-');
            if (parts.length < 2) return null;
            const prefix = parts[0];
            const type = parts[1];
            const currentIndex = sequence.indexOf(type);
            if (currentIndex > -1 && currentIndex < sequence.length - 1) {
                return `${prefix}-quiz-${sequence[currentIndex + 1]}`;
            }
            return null;
        }

        function updateProgressBar() {
            const progress = (completedSections.size / lessonData.mainMenu.length) * 100;
            const bar = document.getElementById('progress-bar');
            if (bar) bar.style.width = `${progress}%`;
        }

        function updateMenuCompletionState() {
            const menuContainer = document.getElementById('page-main-menu');
            if (!menuContainer) return;
            lessonData.mainMenu.forEach(item => {
                const button = menuContainer.querySelector(`#menu-btn-${item.id}`);
                if (button && completedSections.has(item.id)) {
                    if (!button.innerHTML.includes('‚úì')) {
                        button.innerHTML += ' <span class="text-green-300">‚úì</span>';
                    }
                }
            });
        }

        function markSectionAsComplete(pageId) {
            const menuId = pageToMenuMap[pageId];
            if (menuId && !completedSections.has(menuId)) {
                completedSections.add(menuId);
                updateProgressBar();
            }
        }
        
        function checkQuizPageCompletion(pageId) {
            const pageElement = document.getElementById(`page-${pageId}`);
            if (!pageElement) return false;

            if (pageId.includes('gap-fill')) {
                const gaps = pageElement.querySelectorAll('.gap');
                return gaps.length > 0 && Array.from(gaps).every(g => g.classList.contains('correct'));
            } else {
                const questions = pageElement.querySelectorAll('.question-group');
                return questions.length > 0 && Array.from(questions).every(q => q.querySelector('button:disabled'));
            }
        }


        // --- App Navigation ---
        window.toggleTTS = (button) => {
            const isNowEnabled = speechService.toggleTTS();
            const iconPath = isNowEnabled 
                ? "M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"
                : "M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z M17 14l-4-4m0 4l4-4";
            button.querySelector('svg').classList.toggle('text-gray-600', isNowEnabled);
            button.querySelector('svg').classList.toggle('text-gray-400', !isNowEnabled);
            button.querySelector('path').setAttribute('d', iconPath);

            if (isNowEnabled) {
                const pageData = lessonData.pages.find(p => p.id === currentPage);
                const targetPage = document.getElementById(`page-${currentPage}`);
                if (pageData && pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else if (targetPage) {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    if (readableContent) speechService.speak(readableContent.innerText);
                    else if (titleElement) speechService.speak(titleElement.innerText);
                }
            }
        };

        window.startApp = async function() {
            await speechService.init(); 
            try { await Tone.start(); } catch (e) { console.error(e); }
            navigateTo(lessonData.homePageId);
        }
        
        function startTimer(duration, display, onComplete) {
            let timer = duration;
            const update = () => { display.textContent = `${String(Math.floor(timer/60)).padStart(2,'0')}:${String(timer%60).padStart(2,'0')}`; };
            update();
            timerInterval = setInterval(() => { timer--; update(); if (timer < 0) { clearInterval(timerInterval); if (onComplete) onComplete(); } }, 1000);
        }

        window.navigateTo = (pageId) => {
            const previousPageId = currentPage;
            
            // Mark completion if leaving a quiz page and it's fully answered
            if (previousPageId.includes('-quiz-')) {
                if (checkQuizPageCompletion(previousPageId)) {
                    markSectionAsComplete(previousPageId);
                }
            }
            
            const targetPage = document.getElementById(`page-${pageId}`);
            if (!targetPage) return console.warn('navigateTo: no page found for id', pageId);
            if (pageId === currentPage) return;
            
            clearInterval(timerInterval);
            clearTimeout(vocabGameTimer);
            speechService.cancel();

            // Mark simple pages as complete on navigation
            const previousPageDef = lessonData.pages.find(p => p.id === previousPageId);
            if (previousPageDef && !previousPageDef.type.startsWith('quiz') && previousPageId !== 'vocab-game') {
                 markSectionAsComplete(previousPageId);
            }

            document.getElementById(`page-${currentPage}`)?.classList.remove('active');
            targetPage.classList.add('active');
            currentPage = pageId;
            if (pageHistory[pageHistory.length - 1] !== currentPage) pageHistory.push(currentPage);
            
            const pageData = lessonData.pages.find(p => p.id === pageId);
            if (pageData) {
                if (pageData.type === 'timer') {
                    const timerEl = document.getElementById(pageData.content.timerId);
                    if (timerEl) startTimer(pageData.content.duration, timerEl, goNext);
                } else if (pageData.type === 'vocab-game') {
                    startVocabGame();
                }
                
                if (pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    let contentToSpeak = readableContent ? readableContent.innerText : (titleElement ? titleElement.innerText : '');
                    let voice = 'default';
                    if (pageId.startsWith('vocab-') || pageId === 'reading-main') {
                       voice = 'oliver'; // Andrew voice
                       if (pageId === 'reading-main') {
                           contentToSpeak = Array.from(targetPage.querySelectorAll('h4, p')).map(el => el.innerText).join(' ');
                       }
                    }
                    speechService.speak(contentToSpeak, { voiceKey: voice });
                }
            } else if (pageId === lessonData.homePageId) {
                speechService.speak(targetPage.querySelector('h2').innerText);
                updateMenuCompletionState();
            }
            updateNavButtons();
            window.scrollTo(0, 0);
        }

        window.goNext = () => { const currentIndex = pageSequence.indexOf(currentPage); if (currentIndex > -1 && currentIndex < pageSequence.length - 1) navigateTo(pageSequence[currentIndex + 1]); }
        window.goBack = () => { if (pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); } }

        function updateNavButtons() {
            const nav = document.getElementById('nav-header');
            if (!nav) return;
            nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
            const backBtn = nav.querySelector('button:first-child');
            backBtn.disabled = pageHistory.length <= 1;
            backBtn.classList.toggle('opacity-50', backBtn.disabled);
            const nextBtn = nav.querySelector('button:last-child');
            const currentIndex = pageSequence.indexOf(currentPage);
            const isLast = currentIndex >= pageSequence.length - 1;
            nextBtn.disabled = isLast || currentPage === lessonData.homePageId;
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }
        
        function showFeedbackMessage(isCorrect) {
            const correctFeedback = ["That's right!", "Excellent!", "Perfect!", "Great job!"];
            const incorrectFeedback = ["Not quite.", "Keep trying!", "Almost there."];
            const message = isCorrect ? correctFeedback[Math.floor(Math.random() * correctFeedback.length)] : incorrectFeedback[Math.floor(Math.random() * incorrectFeedback.length)];
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `feedback-toast ${isCorrect ? 'correct' : 'encouraging'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function updateScore(points) { score += points; document.getElementById('score-display').textContent = score; }

        function checkCompletionAndMark() {
            if(checkQuizPageCompletion(currentPage)) {
                markSectionAsComplete(currentPage);
            }
        }

        window.checkTfngAnswer = function(clickedButton, chosenAnswer, correctAnswer) {
            const buttonContainer = clickedButton.parentElement;
            Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
            const isCorrect = chosenAnswer === correctAnswer;
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                updateScore(10);
                playCorrectSound();
                triggerRewardAnimation();
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-green-500');
            } else {
                playIncorrectSound();
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-red-600');
                const correctBtn = Array.from(buttonContainer.children).find(btn => btn.textContent === correctAnswer.charAt(0));
                if (correctBtn) correctBtn.className = correctBtn.className.replace(/bg-\w+-500/, 'bg-green-500');
            }
            setTimeout(checkCompletionAndMark, 100);
        }
        
        window.checkMcqAnswer = function(button, isCorrect) {
            const questionGroup = button.closest('.question-group');
            questionGroup.querySelectorAll('.quiz-option').forEach(opt => opt.disabled = true);
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                updateScore(10);
                playCorrectSound();
                triggerRewardAnimation();
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'border-green-600', 'text-white');
            } else {
                playIncorrectSound();
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'border-red-600', 'text-white', 'shake');
                const correctButton = questionGroup.querySelector(".quiz-option[data-correct='true']");
                if (correctButton) {
                    correctButton.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    correctButton.classList.add('bg-green-500', 'border-green-600', 'text-white');
                }
            }
            setTimeout(checkCompletionAndMark, 100);
        }

        function initGapFill(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return;
            const gaps = page.querySelectorAll('.gap');
            const words = page.querySelectorAll('.word-bank-word');
            const wordBank = page.querySelector('.word-bank-container');

            words.forEach(word => {
                word.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', word.dataset.word); });
                word.addEventListener('click', handleWordClick);
            });
            gaps.forEach(gap => {
                gap.addEventListener('dragover', e => e.preventDefault());
                gap.addEventListener('drop', e => handleDrop(e, gap));
                gap.addEventListener('click', handleGapClick);
            });

            function handleWordClick(e) {
                const clickedWord = e.currentTarget;
                if (clickedWord.parentElement.classList.contains('gap')) { 
                    wordBank.appendChild(clickedWord); 
                    clickedWord.parentElement.classList.remove('correct', 'incorrect');
                    return; 
                }
                if (selectedWord.element) selectedWord.element.classList.remove('selected');
                if (selectedWord.element === clickedWord) { selectedWord = { element: null, text: '' }; } 
                else { selectedWord = { element: clickedWord, text: clickedWord.dataset.word }; clickedWord.classList.add('selected'); }
            }
            function handleGapClick(e) {
                const clickedGap = e.currentTarget;
                if(clickedGap.children.length > 0) {
                     wordBank.appendChild(clickedGap.children[0]);
                     clickedGap.classList.remove('correct', 'incorrect');
                }
                if (!selectedWord.element) return;
                clickedGap.appendChild(selectedWord.element);
                checkGap(clickedGap);
                selectedWord.element.classList.remove('selected');
                selectedWord = { element: null, text: '' };
            }
            function handleDrop(e, gap) {
                e.preventDefault();
                if (gap.children.length > 0) return;
                const wordText = e.dataTransfer.getData('text/plain');
                const wordElement = page.querySelector(`.word-bank-word[data-word="${wordText}"]`);
                if (wordElement) { gap.appendChild(wordElement); checkGap(gap); }
            }
            function checkGap(gap) {
                const word = gap.querySelector('.word-bank-word');
                const isCorrect = word && word.dataset.word.toLowerCase() === gap.dataset.answer.toLowerCase();
                gap.classList.toggle('correct', isCorrect);
                gap.classList.toggle('incorrect', !isCorrect);
                if (isCorrect) { 
                    updateScore(10); 
                    playCorrectSound();
                    triggerRewardAnimation();
                    showFeedbackMessage(true); 
                } else { 
                    playIncorrectSound();
                    showFeedbackMessage(false); 
                }
                setTimeout(checkCompletionAndMark, 100);
            }
        }

        // --- Vocab Game Logic ---
        let vocabGameQuestions = [];
        let vocabGameCurrentIndex = 0;
        let vocabGameScore = 0;
        const ROUND_TIME = 10000; // 10 seconds

        function startVocabGame() {
            vocabGameQuestions = [...lessonData.vocabulary].sort(() => 0.5 - Math.random());
            vocabGameCurrentIndex = 0;
            vocabGameScore = 0;
            document.getElementById('vocab-game-score').textContent = '0';
            nextVocabGameRound();
        }

        function nextVocabGameRound() {
            if (vocabGameCurrentIndex >= vocabGameQuestions.length) {
                endVocabGame();
                return;
            }
            
            const question = vocabGameQuestions[vocabGameCurrentIndex];
            document.getElementById('vocab-game-definition').textContent = question.def;
            
            const options = [question.word];
            const wrongAnswers = lessonData.vocabulary.filter(v => v.word !== question.word);
            while (options.length < 4 && wrongAnswers.length > 0) {
                const randomWrong = wrongAnswers.splice(Math.floor(Math.random() * wrongAnswers.length), 1)[0];
                options.push(randomWrong.word);
            }
            
            const optionsContainer = document.getElementById('vocab-game-options');
            optionsContainer.innerHTML = '';
            options.sort(() => 0.5 - Math.random()).forEach(opt => {
                const button = document.createElement('button');
                button.className = 'quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200';
                button.textContent = opt;
                button.onclick = () => checkVocabGameAnswer(button, opt === question.word);
                optionsContainer.appendChild(button);
            });

            startRoundTimer();
        }
        
        function startRoundTimer() {
            clearTimeout(vocabGameTimer);
            const timerBar = document.getElementById('vocab-game-timer-bar');
            timerBar.style.transition = 'none';
            timerBar.style.width = '100%';
            
            setTimeout(() => {
                timerBar.style.transition = `width ${ROUND_TIME / 1000}s linear`;
                timerBar.style.width = '0%';
            }, 100);

            vocabGameTimer = setTimeout(() => {
                showFeedbackMessage(false);
                playIncorrectSound();
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, ROUND_TIME);
        }

        function checkVocabGameAnswer(button, isCorrect) {
            clearTimeout(vocabGameTimer);
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                vocabGameScore++;
                updateScore(5);
                playCorrectSound();
                triggerRewardAnimation();
                document.getElementById('vocab-game-score').textContent = vocabGameScore;
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'text-white');
            } else {
                playIncorrectSound();
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'text-white', 'shake');
            }
            
            const optionsContainer = document.getElementById('vocab-game-options');
            optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

            setTimeout(() => {
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, 1500);
        }

        function endVocabGame() {
            document.getElementById('vocab-game-definition').textContent = `Game Over! You scored ${vocabGameScore} out of ${vocabGameQuestions.length}.`;
            document.getElementById('vocab-game-options').innerHTML = `<button onclick="startVocabGame()" class="action-button bg-blue-500 text-white font-bold p-3 rounded-lg">Play Again</button>`;
            markSectionAsComplete('vocab-game');
        }


        function createPageElement(id, content) {
            const section = document.createElement('section');
            section.id = `page-${id}`;
            section.className = 'page';
            section.innerHTML = content;
            document.getElementById('dynamic-pages-container').appendChild(section);
        }
        
        function populateAllQuizzes() {
            // Reading Quizzes
            const readingGapFill = lessonData.pages.find(p => p.id === 'reading-quiz-gap-fill');
             if(readingGapFill) readingGapFill.content.sentences = [
                { text: ["New Orleans is located in", ", USA."], answer: "Louisiana" },
                { text: ["The city is famous for", "music."], answer: "jazz" },
                { text: ["Mardi Gras is a", "with parades and costumes."], answer: "festival" },
                { text: ["Hurricane", "hit New Orleans in 2005."], answer: "Katrina" },
                { text: ["Creole cuisine includes dishes like gumbo and", "."], answer: "jambalaya" }
             ];
            const readingTfng = lessonData.pages.find(p => p.id === 'reading-quiz-tfng');
            if(readingTfng) readingTfng.content.questions = [ 
                { statement: 'New Orleans is in California.', correctAnswer: 'False' },
                { statement: 'Jazz music started in New Orleans.', correctAnswer: 'True' },
                { statement: 'Mardi Gras is a quiet holiday.', correctAnswer: 'False' },
                { statement: 'Hurricane Katrina happened in 2005.', correctAnswer: 'True' },
                { statement: 'Creole food is only eaten in France.', correctAnswer: 'False' }
            ];
            const readingMcq = lessonData.pages.find(p => p.id === 'reading-quiz-mcq');
            if(readingMcq) readingMcq.content.questions = [ 
                { question: 'What type of music is New Orleans known for?', options: ['Rock', 'Jazz', 'Classical', 'Pop'], correctAnswer: 'Jazz' },
                { question: 'What is Mardi Gras?', options: ['A food dish', 'A music style', 'A festival', 'A hurricane'], correctAnswer: 'A festival' },
                { question: 'What is gumbo?', options: ['A type of dance', 'A traditional dish', 'A musical instrument', 'A parade costume'], correctAnswer: 'A traditional dish' },
                { question: 'What helped New Orleans recover after Hurricane Katrina?', options: ['Technology', 'Culture and community', 'Silence', 'Isolation'], correctAnswer: 'Culture and community' },
                { question: 'What does ‚Äúresilience‚Äù mean?', options: ['Giving up', 'Being strong after difficulty', 'Celebrating', 'Cooking food'], correctAnswer: 'Being strong after difficulty' }
            ];

            // Classroom Discussion Quizzes
            const discussionMcq = lessonData.pages.find(p => p.id === 'discussion-quiz-mcq');
            if(discussionMcq) discussionMcq.content.questions = [
                { question: "What is Emily's initial impression of New Orleans's culture?", options: ["It is very similar to Australian culture.", "It is a unique blend of many different influences.", "It is mainly influenced by Spanish traditions.", "It seems very modern and not very historical."], correctAnswer: "It is a unique blend of many different influences." },
                { question: "What specific aspect of New Orleans is Oliver most interested in?", options: ["Its modern architecture", "Its economic history", "The development of its jazz music heritage", "Its famous universities"], correctAnswer: "The development of its jazz music heritage" },
                { question: "Besides music, what other cultural element of New Orleans interests Emily?", options: ["The local sports teams", "The city's political history", "The Mardi Gras festival and Creole food", "The contemporary art scene"], correctAnswer: "The Mardi Gras festival and Creole food" },
                { question: "What major event does Oliver refer to as an example of the city's resilience?", options: ["The founding of the city in 1718", "The Louisiana Purchase", "Hurricane Katrina and the subsequent rebuilding", "The first Mardi Gras parade"], correctAnswer: "Hurricane Katrina and the subsequent rebuilding" },
                { question: "What is one of the ongoing challenges for New Orleans that Oliver mentions in relation to tourism?", options: ["There are not enough hotels for visitors.", "The food is too spicy for tourists.", "It is difficult to attract tourists in the summer.", "Preserving the city's authentic culture from becoming a 'theme park'."], correctAnswer: "Preserving the city's authentic culture from becoming a 'theme park'." }
            ];
            const discussionTfng = lessonData.pages.find(p => p.id === 'discussion-quiz-tfng');
            if(discussionTfng) discussionTfng.content.questions = [
                { statement: "The professor refers to New Orleans by the nickname 'The Big Apple'.", correctAnswer: "False" },
                { statement: "Oliver is from Australia and Emily is from the UK.", correctAnswer: "False" },
                { statement: "According to the discussion, jazz music is only played inside clubs in New Orleans.", correctAnswer: "False" },
                { statement: "Emily brings up the environmental threat of coastal erosion as a challenge for the city.", correctAnswer: "True" },
                { statement: "The professor suggests that tourism should be stopped to protect the city's culture.", correctAnswer: "False" }
            ];
            const discussionGap = lessonData.pages.find(p => p.id === 'discussion-quiz-gap-fill');
            if(discussionGap) discussionGap.content.sentences = [
                { text: ["The professor states that music is", "into the fabric of daily life in New Orleans."], answer: "woven" },
                { text: ["Emily notes the blend of French, Spanish, African, and American", "to be unique."], answer: "influences" },
                { text: ["The city's ability to rebuild after the hurricane is a testament to its", "."], answer: "resilience" },
                { text: ["Oliver worries about historic areas like the French Quarter becoming a", "."], answer: "theme park" },
                { text: ["The professor concludes that New Orleans is a city of vibrant", "."], answer: "contradictions" }
            ];
            
            // Environmental Challenges Lecture Quizzes
            const lectureEnvMcq = lessonData.pages.find(p => p.id === 'lecture-environment-quiz-mcq');
            if(lectureEnvMcq) lectureEnvMcq.content.questions = [
                { question: "What is a primary reason for New Orleans's vulnerability to flooding?", options: ["It is surrounded by mountains.", "It has a very dry climate.", "Much of the city is below sea level.", "It is located far from any large bodies of water."], correctAnswer: "Much of the city is below sea level." },
                { question: "What natural feature historically protected New Orleans from hurricane storm surges?", options: ["The Rocky Mountains", "Extensive wetlands and barrier islands", "Dense forests", "A deep ocean trench"], correctAnswer: "Extensive wetlands and barrier islands" },
                { question: "What was a major consequence of Hurricane Katrina in 2005?", options: ["A major earthquake", "A record-breaking heatwave", "The failure of the levee system and widespread flooding", "The complete relocation of the city"], correctAnswer: "The failure of the levee system and widespread flooding" },
                { question: "How does climate change increase the threat to New Orleans?", options: ["It causes more frequent earthquakes.", "It leads to colder winters that freeze the river.", "It causes rising sea levels and potentially more intense hurricanes.", "It reduces the amount of rainfall in the region."], correctAnswer: "It causes rising sea levels and potentially more intense hurricanes." },
                { question: "What virtue does Sofia suggest is needed for planning for the future in New Orleans?", options: ["Patience", "Courage", "Foresight", "Creativity"], correctAnswer: "Foresight" }
            ];
            const lectureEnvTfng = lessonData.pages.find(p => p.id === 'lecture-environment-quiz-tfng');
            if(lectureEnvTfng) lectureEnvTfng.content.questions = [
                { statement: "New Orleans is located far from the Gulf of Mexico.", correctAnswer: "False" },
                { statement: "The wetlands that protect New Orleans are growing larger and stronger.", correctAnswer: "False" },
                { statement: "Hurricane Katrina caused about 80% of the city to flood.", correctAnswer: "True" },
                { statement: "Warmer ocean waters can fuel more intense hurricanes.", correctAnswer: "True" },
                { statement: "The professor states that the people of New Orleans have shown little resilience.", correctAnswer: "False" }
            ];
            const lectureEnvGapFill = lessonData.pages.find(p => p.id === 'lecture-environment-quiz-gap-fill');
            if(lectureEnvGapFill) lectureEnvGapFill.content.sentences = [
                { text: ["Much of the city is built on drained", "land."], answer: "swamp" },
                { text: ["The sinking of land is a phenomenon known as", "."], answer: "subsidence" },
                { text: ["The human cost of Hurricane Katrina was", ", with significant loss of life."], answer: "immense" },
                { text: ["Rising sea levels are a direct", "of climate change."], answer: "consequence" },
                { text: ["The discussion concludes that", "and proactive adaptation are essential for the city's future."], answer: "resilience" }
            ];
        }

        function initializeLesson() {
            document.getElementById('main-title').innerHTML = lessonData.title;
            document.getElementById('main-subtitle').innerHTML = lessonData.subtitle;
            document.getElementById('main-svg-container').innerHTML = `<svg viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="grad-nola" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#581c87;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#166534;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect width="600" height="300" fill="url(#grad-nola)"/>
                <g transform="translate(300, 150) scale(1.5)" fill="rgba(255,255,255,0.1)">
                    <path d="M-50,20 C-50,-20 50,-20 50,20 L55,50 L-55,50 Z" />
                    <rect x="-5" y="-60" width="10" height="80" />
                    <circle cx="0" cy="-60" r="10" />
                    <path d="M-80,-40 Q-40,-50 0,-40 T 80,-40" stroke="rgba(255,255,255,0.2)" stroke-width="5" fill="none"/>
                </g>
                <text x="50%" y="40%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="48" fill="#fefce8" font-weight="bold">The Big Easy</text>
            </svg>`;

            populateAllQuizzes();
            buildPageToMenuMap();

            const menuButtons = lessonData.mainMenu.map(item => {
                const colors = { green: 'bg-green-500 border-green-700', blue: 'bg-blue-500 border-blue-700', sky: 'bg-sky-500 border-sky-700', amber: 'bg-amber-500 border-amber-700', rose: 'bg-rose-500 border-rose-700', violet: 'bg-violet-500 border-violet-700', teal: 'bg-teal-500 border-teal-700', orange: 'bg-orange-500 border-orange-700', indigo: 'bg-indigo-500 border-indigo-700', lime: 'bg-lime-500 border-lime-700', emerald: 'bg-emerald-500 border-emerald-700', red: 'bg-red-500 border-red-700', purple: 'bg-purple-500 border-purple-700' };
                return `<button id="menu-btn-${item.id}" onclick="navigateTo('${item.target}')" class="btn-animated-3d ${colors[item.color] || colors['green']} text-white font-bold text-xl p-4 rounded-xl">${item.text}</button>`;
            }).join('');
            createPageElement(lessonData.homePageId, `<div class="bg-white rounded-2xl shadow-lg p-8"><h2 class="text-4xl font-bold text-center text-slate-800 mb-8">Main Menu</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${menuButtons}</div></div>`);
            
            const pageOrderMap = { 
                'warm-up': ['vocab-start'], 
                'vocab-start': lessonData.vocabulary.map((v, i) => `vocab-${i}`), 
                'reading-main': ['reading-quiz-gap-fill', 'reading-quiz-tfng', 'reading-quiz-mcq'],
                'lecture-environment-pre': ['lecture-environment-main', 'lecture-environment-quiz-mcq', 'lecture-environment-quiz-tfng', 'lecture-environment-quiz-gap-fill'],
                'discussion-pre': ['discussion-main', 'discussion-quiz-mcq', 'discussion-quiz-tfng', 'discussion-quiz-gap-fill'],
                'final-project-hub': ['writing-task', 'self-assessment', 'certificate'] 
            };
            let flatPageList = [lessonData.startPageId];
            lessonData.mainMenu.forEach(item => {
                let queue = [item.target];
                let visited = new Set();
                while(queue.length > 0) {
                    let current = queue.shift();
                    if (visited.has(current)) continue;
                    visited.add(current);
                    flatPageList.push(current);
                    if (pageOrderMap[current]) {
                        queue.push(...pageOrderMap[current]);
                    }
                }
            });
            pageSequence = [...new Set(flatPageList)];

            lessonData.vocabulary.forEach((v, i) => {
                createPageElement(`vocab-${i}`, `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h3 class="text-2xl font-bold text-sky-600 mb-2">Vocabulary ${i + 1} / ${lessonData.vocabulary.length}</h3><div class="my-8"><h2 class="text-5xl font-bold text-gray-800 mb-4">${v.word}</h2><p class="text-2xl text-gray-600 mb-4">${v.def}</p><p class="text-xl text-gray-500 italic">"${v.sentence}"</p></div></div></div>`);
            });

            lessonData.pages.forEach(page => {
                let pageHTML = '';
                switch (page.type) {
                    case 'simple': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-gray-800 mb-6">${page.content.title}</h2><p class="text-xl text-gray-600 mb-8">${page.content.text}</p></div></div>`; break;
                    case 'timer': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-left pt-16"><div class="w-full flex justify-between items-center mb-4"><h2 class="text-2xl md:text-3xl font-bold text-blue-700">${page.content.title}</h2><div id="${page.content.timerId}" class="text-3xl md:text-4xl font-bold text-gray-700 ml-4"></div></div><div class="readable-content"><p class="text-lg md:text-xl text-gray-600 mt-8">${page.content.text}</p></div></div>`; break;
                    case 'dialogue':
                    case 'html-content':
                        const contentHTML = page.type === 'html-content' ? page.content.html : (page.content.dialogue || '').split('\n').map(line => `<p class="mb-2">${line.replace(/([^:]+):/, '<strong class="font-semibold text-purple-700">$1:</strong>')}</p>`).join('');
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-slate-800 mb-6">${page.content.title}</h2><div class="readable-content text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg max-h-[70vh] overflow-y-auto">${contentHTML}</div></div>`;
                        break;
                    case 'vocab-game':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-sky-600 mb-4">${page.content.title}</h2><div class="text-center mb-4 text-lg">Score: <span id="vocab-game-score" class="font-bold">0</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mb-4"><div id="vocab-game-timer-bar" class="bg-blue-600 h-2.5 rounded-full"></div></div><div id="vocab-game-definition" class="text-center text-2xl font-semibold my-6 min-h-[6rem]"></div><div id="vocab-game-options" class="grid grid-cols-2 gap-4"></div></div>`;
                        break;
                    case 'writing-task':
                        const startersHTML = page.content.starters.map(s => `<li class="text-gray-500">${s}</li>`).join('');
                        const wordBankHTML = page.content.wordBank ? `<div class="mt-6"><h4 class="font-bold text-lg text-violet-600">Word Bank:</h4><div class="flex flex-wrap gap-2 mt-2 p-4 bg-gray-100 rounded-lg">${page.content.wordBank.map(w => `<span class="bg-white px-2 py-1 rounded-md shadow-sm text-gray-700">${w}</span>`).join('')}</div></div>` : '';
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-center text-violet-700 mb-6">${page.content.title}</h2><div class="text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg"><h3 class="font-bold text-xl text-violet-600">Prompt:</h3><p>${page.content.prompt}</p><h3 class="font-bold text-xl text-violet-600 mt-4">Sentence Starters:</h3><ul class="list-disc list-inside ml-4">${startersHTML}</ul>${wordBankHTML}</div></div><div class="text-center mt-6"><button onclick="goNext()" class="action-button bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-xl hover:bg-blue-700">Continue</button></div></div>`;
                        break;
                    case 'certificate':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16 relative overflow-hidden"><canvas id="completion-canvas"></canvas><div class="relative z-10"><div class="readable-content"><h2 class="text-4xl font-bold text-amber-600 mb-4">${page.content.title}</h2><p class="text-xl text-gray-600 mb-6">${page.content.text}</p></div><div id="certificate-to-print" class="bg-purple-50 border-4 border-dashed border-purple-300 rounded-lg p-8 max-w-2xl mx-auto"><div class="flex justify-center mb-4"><span class="text-6xl"><span aria-hidden="true">üé∑</span></span></div><h3 class="text-3xl font-bold text-slate-800">${page.content.certificateTitle}</h3><p class="mt-4 text-lg">This certificate is awarded to</p><p id="certificate-name" class="text-2xl font-bold text-purple-600 my-2 border-b-2 border-gray-400 pb-2">[Enter Your Name Here]</p><p class="mt-4 text-lg">for successfully completing this lesson.</p><p class="mt-6 text-md"><strong>Final Score:</strong> <span id="certificate-score" class="font-bold"></span> points</p><p class="text-sm mt-1"><strong>Date of Completion:</strong> <span id="certificate-date"></span></p></div><div id="cert-controls" class="mt-6"><div id="cert-initial-controls"><input type="text" id="name-input-cert" placeholder="Enter your name for the certificate" class="text-center p-2 border rounded-lg w-full max-w-md"><button onclick="generateCertificate()" class="action-button bg-purple-600 text-white font-bold py-2 px-6 rounded-full hover:bg-purple-700">Generate Certificate</button></div><div id="cert-generated-controls" class="hidden mt-4 flex flex-wrap justify-center gap-4"><button onclick="downloadCertificateAsImage()" class="action-button bg-purple-600 text-white font-bold py-2 px-4 rounded-full text-sm">Download Image</button></div></div></div></div>`;
                        break;
                    case 'quiz-tfng':
                    case 'quiz-mcq':
                    case 'quiz-gap-fill':
                        let questionsHTML = '';
                        if (page.type === 'quiz-tfng' && page.content.questions) {
                            questionsHTML = page.content.questions.map((q, i) => `<div class="question-group flex items-center gap-4 p-4 rounded-lg bg-gray-100"><div class="flex-shrink-0 flex gap-2">${['True', 'False', 'Not Given'].map(l => `<button onclick="checkTfngAnswer(this, '${l}', '${q.correctAnswer}')" class="tfng-button bg-${l==='True'?'blue':l==='False'?'red':'gray'}-500 text-white font-bold w-12 h-10 rounded-full">${l.charAt(0)}</button>`).join('')}</div><p>${i + 1}. ${q.statement}</p></div>`).join('');
                        } else if (page.type === 'quiz-mcq' && page.content.questions) {
                            questionsHTML = page.content.questions.map((q, i) => `<div class="question-group ${i > 0 ? 'border-t pt-6 mt-6' : ''}"><p class="font-semibold mb-2">${i + 1}. ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-2">${q.options.map(o => `<button onclick="checkMcqAnswer(this, '${o.replace(/'/g, "\\'")}' === '${q.correctAnswer.replace(/'/g, "\\'")}')" data-correct="${o === q.correctAnswer}" class="quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200">${o}</button>`).join('')}</div></div>`).join('');
                        } else if (page.type === 'quiz-gap-fill' && page.content.sentences) {
                            const words = page.content.sentences.map(s => s.answer).sort(() => Math.random() - 0.5);
                            questionsHTML = `<div class="gap-fill-container">${page.content.sentences.map((s, i) => `<p class="text-lg mb-4">${i + 1}. ${s.text[0]} <span class="gap" data-answer="${s.answer}"></span> ${s.text[1]}</p>`).join('')}</div><div class="word-bank-container mt-8 p-4 bg-gray-100 rounded-lg flex flex-wrap gap-4 justify-center">${words.map(w => `<div class="word-bank-word" draggable="true" data-word="${w}">${w}</div>`).join('')}</div>`;
                        }
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h3 class="text-3xl font-bold text-rose-600 mb-6 text-center">${page.content.title}</h3><div class="space-y-6">${questionsHTML}</div></div>`;
                        break;
                }
                if (pageHTML) {
                    createPageElement(page.id, pageHTML);
                    if (page.type === 'quiz-gap-fill') initGapFill(`page-${page.id}`);
                }
            });
            updateNavButtons();
        }

        function generateCertificate() {
            const name = document.getElementById('name-input-cert').value || 'Dedicated Student';
            document.getElementById('certificate-name').textContent = name;
            document.getElementById('certificate-score').textContent = score;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
            document.getElementById('cert-initial-controls').classList.add('hidden');
            document.getElementById('cert-generated-controls').classList.remove('hidden');

            const canvas = document.getElementById('completion-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            let particles = [];
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 5 + 2,
                    color: ['#a855f7', '#16a34a', '#facc15', '#eab308'][Math.floor(Math.random() * 4)],
                    speed: Math.random() * 2 + 1
                });
            }

            function drawConfetti() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.y += p.speed;
                    if (p.y > canvas.height) {
                        p.y = -p.radius;
                        p.x = Math.random() * canvas.width;
                    }
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                });
                requestAnimationFrame(drawConfetti);
            }
            drawConfetti();
        }

        function downloadCertificateAsImage() {
            html2canvas(document.querySelector("#certificate-to-print")).then(canvas => {
                const link = document.createElement('a');
                link.download = 'New_Orleans_Certificate.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            initializeLesson();
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            let particles = [];
            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                particles.forEach((p, i) => {
                    p.y -= p.speed;
                    if (p.y < -p.radius) {
                        particles.splice(i, 1);
                    }
                    bgCtx.globalAlpha = p.opacity;
                    bgCtx.font = `${p.radius}px serif`;
                    bgCtx.fillText(p.char, p.x, p.y);
                });
                if (Math.random() > 0.95) {
                    const chars = ['‚ô™', '‚ô´', 'üé∫', 'üé∑', 'üé≠'];
                    particles.push({ 
                        x: Math.random() * bgCanvas.width, 
                        y: bgCanvas.height + 20, 
                        radius: Math.random() * 20 + 10, 
                        speed: Math.random() * 1 + 0.5, 
                        char: chars[Math.floor(Math.random() * chars.length)],
                        opacity: Math.random() * 0.5 + 0.1
                    });
                }
                requestAnimationFrame(animateBackground);
            }
            window.addEventListener('resize', () => { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; });
            animateBackground();
        });
    </script>
</body>
</html>

