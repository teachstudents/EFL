<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Classroom Quiz Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            animation: backgroundShift 30s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0% { background: linear-gradient(45deg, #556cd6 0%, #5a3f8f 100%); }
            25% { background: linear-gradient(45deg, #e080e8 0%, #e04560 100%); }
            50% { background: linear-gradient(45deg, #2f8ed6 0%, #008fbf 100%); }
            75% { background: linear-gradient(45deg, #2fa15f 0%, #1f8f8f 100%); }
            100% { background: linear-gradient(45deg, #556cd6 0%, #5a3f8f 100%); }
        }

        .laser-beam {
            position: absolute;
            width: 4px;
            height: 200px;
            background: linear-gradient(to bottom, transparent, #00ffff, transparent);
            animation: laserMove 3s linear infinite;
            opacity: 0.7;
        }

        @keyframes laserMove {
            0% { transform: translateX(-100px) translateY(-100px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(calc(100vw + 100px)) translateY(100vh); opacity: 0; }
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 15px;
            position: relative;
            z-index: 10;
            justify-content: space-between;
        }

        .bottom-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 15px;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .progress-section {
            flex: 1;
            margin: 0 15px;
        }

        .progress-bar {
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb);
            border-radius: 15px;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-emoji {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            animation: bounce 0.5s ease-in-out infinite alternate;
        }

        @keyframes bounce {
            0% { transform: translateY(-50%) scale(1); }
            100% { transform: translateY(-50%) scale(1.2); }
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            background: linear-gradient(145deg, #d64545, #a83232);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .players-section {
            display: none;
        }

        .player-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
        }

        .player-name {
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            line-height: 1.2;
        }

        .player-score {
            font-size: 14px;
            font-weight: 600;
            color: #ffd700;
            text-align: center;
            margin-top: 2px;
        }

        .question-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .question-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .streak-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, #FFD700, #FFA000);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
            animation: streakGlow 1s ease-in-out infinite alternate;
            border: 2px solid #FFF;
        }

        @keyframes streakGlow {
            0% { box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3); }
            100% { box-shadow: 0 5px 15px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.5); }
        }

        .game-area {
            display: flex;
            flex: 1;
            gap: 15px;
            align-items: flex-start;
            margin-top: 20px;
            justify-content: center;
        }

        .choices-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            max-width: 33%;
        }

        .choice-button {
            background: linear-gradient(145deg, #4a5fd1, #5a3f8f);
            border: none;
            border-radius: 12px;
            padding: 5px 5px;
            font-size: 22px; /* Increased font size */
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0px #3a4a9f; /* Arcade style button */
            position: relative;
            overflow: hidden;
            min-height: 50px; /* Reduced height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-break: break-word;
            line-height: 1.1;
        }

        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0px #3a4a9f;
            filter: brightness(1.1);
        }

        .choice-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0px #3a4a9f;
        }

        .choice-button.correct {
            animation: correctAnswer 4s ease-in-out;
            background: linear-gradient(145deg, #2fa15f, #1f8f8f);
            box-shadow: 0 4px 0px #1a7a4f;
        }

        .choice-button.incorrect {
            animation: incorrectAnswer 2s ease-in-out;
            background: linear-gradient(145deg, #d64545, #a83232);
            box-shadow: 0 4px 0px #8f2222;
        }

        /* ... Animations (correctAnswer, incorrectAnswer, sparkles, etc.) unchanged ... */
        @keyframes correctAnswer {
            0% { transform: scale(1); }
            10% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes incorrectAnswer {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .sparkle { position: absolute; width: 10px; height: 10px; background: #ffd700; border-radius: 50%; animation: sparkle 1s ease-out forwards; pointer-events: none; }
        @keyframes sparkle { 0% { opacity: 1; transform: scale(0); } 50% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0); } }
        .token { position: absolute; width: 20px; height: 20px; background: linear-gradient(45deg, #ffd700, #ffed4e); border-radius: 50%; border: 2px solid #ff6b6b; font-size: 12px; font-weight: bold; color: #333; display: flex; align-items: center; justify-content: center; animation: tokenFly 2s ease-out forwards; pointer-events: none; z-index: 1000; }
        @keyframes tokenFly { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.5); } }
        
        .leaderboard, .learning-phase, .name-shuffle {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.98); padding: 40px; border-radius: 30px; text-align: center; font-size: 24px; color: #333; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); z-index: 1000; display: none;
        }
        .name-shuffle { width: 80%; max-width: 800px; }
        .shuffle-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 30px; min-height: 200px; align-items: center; }
        .shuffle-name { padding: 10px 15px; background: linear-gradient(145deg, #667eea, #764ba2); color: white; border-radius: 10px; font-size: 16px; font-weight: 600; transition: all 0.3s ease; }
        .shuffle-name.selected { background: linear-gradient(145deg, #43e97b, #38f9d7); transform: scale(1.2); box-shadow: 0 0 20px #43e97b; }
        .selected-players { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .selected-player { background: linear-gradient(145deg, #f093fb, #f5576c); color: white; padding: 15px; border-radius: 15px; font-size: 18px; font-weight: 700; }

        .round-info-display {
            color: white; font-size: 18px; font-weight: 600; background: rgba(255, 255, 255, 0.2); padding: 8px 16px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.3); text-align: center; white-space: nowrap;
        }

        .main-menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .menu-container { background: rgba(255, 255, 255, 0.95); padding: 60px; border-radius: 30px; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .menu-title { font-size: 48px; font-weight: 700; color: #333; margin-bottom: 20px; }
        .grade-buttons { display: flex; gap: 20px; justify-content: center; }
        .grade-btn { background: linear-gradient(145deg, #4a5fd1, #5a3f8f); border: none; border-radius: 20px; padding: 20px 40px; font-size: 24px; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .grade-btn:hover { transform: translateY(-5px); }

        .fireworks, .winner-firework, .celebration-burst { pointer-events: none; position: absolute; }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div class="main-menu" id="mainMenu">
        <div class="menu-container">
            <h1 class="menu-title">üçî Food Ordering Quiz</h1>
            <h2 class="menu-subtitle">Select Your Grade</h2>
            <div class="grade-buttons">
                <button class="grade-btn" onclick="selectGrade(10)">Grade 10</button>
                <button class="grade-btn" onclick="selectGrade(11)">Grade 11</button>
                <button class="grade-btn" onclick="selectGrade(12)">Grade 12</button>
            </div>
        </div>
    </div>

    <div class="game-container" id="gameContainer" style="display: none;">
        <!-- Streak Indicator -->
        <div class="streak-indicator" id="streakIndicator">
            üî• Streak: <span id="streakCount">0</span>
        </div>

        <!-- Question Section (Hidden) -->
        <div class="question-section" style="display: none;">
            <div class="question-title" id="questionTitle"></div>
        </div>

        <!-- Game Area (Answer Buttons & Players) -->
        <div class="game-area">
            <div class="choices-column">
                <button class="choice-button" onclick="selectAnswer(0)">Pizza</button>
                <button class="choice-button" onclick="selectAnswer(1)">Burger</button>
                <button class="choice-button" onclick="selectAnswer(2)">Salad</button>
                <button class="choice-button" onclick="selectAnswer(3)">Sushi</button>
                <div class="player-container">
                    <div class="player-name" id="player1">Player 1</div>
                    <div class="player-score" id="score1">0 points</div>
                </div>
            </div>

            <div class="choices-column">
                <button class="choice-button" onclick="selectAnswer(4)">Pasta</button>
                <button class="choice-button" onclick="selectAnswer(5)">Tacos</button>
                <button class="choice-button" onclick="selectAnswer(6)">Steak</button>
                <button class="choice-button" onclick="selectAnswer(7)">Soup</button>
                <div class="player-container">
                    <div class="player-name" id="player2">Player 2</div>
                    <div class="player-score" id="score2">0 points</div>
                </div>
            </div>

            <div class="choices-column">
                <button class="choice-button" onclick="selectAnswer(8)">Rice</button>
                <button class="choice-button" onclick="selectAnswer(9)">Fish</button>
                <button class="choice-button" onclick="selectAnswer(10)">Cake</button>
                <button class="choice-button" onclick="selectAnswer(11)">Pie</button>
                <div class="player-container">
                    <div class="player-name" id="player3">Player 3</div>
                    <div class="player-score" id="score3">0 points</div>
                </div>
            </div>
        </div>

        <!-- Bottom Controls (Timer, Menu, Round) -->
        <div class="bottom-section">
            <div class="control-buttons">
                <button class="control-btn" onclick="backToMenu()">üè† Menu</button>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">
                        <div class="progress-emoji" id="progressEmoji">üçΩÔ∏è</div>
                    </div>
                </div>
            </div>
            <div class="round-info-display">
                <span id="roundDisplay">Round 1 of 8</span> | Q: <span id="currentQuestion">1</span>/10
            </div>
        </div>
    </div>

    <!-- Overlays -->
    <div class="leaderboard" id="leaderboard">
        <h2>üèÜ Round Complete! üèÜ</h2>
        <div id="leaderboardContent"></div>
        <div id="globalLeaderboardContent" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
            <h3>üåü Global Leaderboard üåü</h3>
            <div id="globalScores"></div>
        </div>
        <div style="margin-top: 20px; font-size: 16px; color: #666;">Next round starting automatically in 5 seconds...</div>
    </div>

    <div class="learning-phase" id="learningPhase">
        <div id="learningContent"></div>
    </div>

    <div class="name-shuffle" id="nameShuffle">
        <h2 class="shuffle-title">Selecting Players...</h2>
        <div class="shuffle-container" id="shuffleContainer"></div>
        <div class="selected-players" id="selectedPlayers"></div>
    </div>

    <script>
        // ========================================
        // üìö STUDENT NAMES
        // ========================================
        const studentsByGrade = {
            10: [
                "ÂÜØÂ•ïÂ∞ò / FENG, YICHEN", "ÈªÑËã•Ê∂µ / HUANG, RUOHAN", "Êùé‰∏∞Â±π / LI, FENGYI", 
                "ÊùéÈπèÊΩû / LI, PENGLU", "Ê¢ÅÈî¶Â§© / LING, JINTIAN", "ÂàòÊôØÊâ¨ / LIU, JINGYANG",
                "Èæô‰øäÂøó / LONG, JUNZHI", "È©¨Ëµ´ / MA, HE", "ËÅÇÊ∫™Â∫∑ / NIE, XIKANG",
                "Â∫û‰∫ëËîö / PANG, YUNWEI", "Êõ≤ÂÆ∂Áëû / QU, JIARUI", "Â≠ôËØóÁ´• / SUN, SHITONG",
                "ÁéãÂ≠êË®Ä / WANG, ZIYAN", "Êù®Êô¥Áè∫ / YANG, QINGJUN", "Âº†ÂÆ∏ÊÅ∫ / ZHANG, CHENKAI",
                "ËµµÊµ©Êñá / ZHAO, HAOWEN", "ËµµÊµ©Áê≥"
            ],
            11: [
                "Êü¥ÂçìÁë∂ / Iris", "Êùé‰πãÁî® / Max", "Êûó‰∫ëÊõ¶ / Cathy",
                "ÂàòÁèÇÂê´ / Sandy", "È™ÜÊ¢¶‰πî / Vicky", "ÂÆãÊòäËΩ© / Jim",
                "ÂêëÂÆ∂ÊÖï / Jackie", "ÂæêÂòâÁÅè / Jay", "Êù®È¶•ÂÆÅ / Grace",
                "Âº†‰∏éÂçì / Emily", "ËµµÂçÉÊ¢¶ / Rhea"
            ],
            12: [
                "ÂÆâÊîøËÅø / AN, ZHENGYU", "Ëî°Â≠êÂ¢® / CAI, ZIMO", "ÂàòÈïáÊ¶ï / LIU, ZHENRONG",
                "È©¨Áü•Ë°å / MA, ZHIXING", "ÈÇ±Â§© / QIU, TIAN", "ÁõõÊÄùËØ≠ / SHENG, SIYU",
                "ÂîêÂèØÁõà / TANG, KEYING", "Áî∞Â≠êÂá° / TIAN, ZIFAN", "Ë∞¢ÊñØÈ£û / XIE, SIFEI",
                "Êù®Âä†È∫í / YANG, JIAQI", "Âº†Á®ãÁöì / ZHANG, CHENGHAO", "ËµµÊô®ËææÈë´ / ZHAO, CHENDAXIN",
                "Âë®ÈÄ∏Âá° / ZHOU, YIFAN"
            ]
        };

        // ========================================
        // üéØ QUESTION DATABASE
        // ========================================
        
        // EASY QUESTIONS (Direct Orders)
        const easyFoodItems = [
            { id: "pizza", display: "Pizza", spoken: "Pizza", category: "main_dish" },
            { id: "burger", display: "Burger", spoken: "Burger", category: "fast_food" },
            { id: "salad", display: "Salad", spoken: "Salad", category: "starter" },
            { id: "sushi", display: "Sushi", spoken: "Sushi", category: "main_dish" },
            { id: "pasta", display: "Pasta", spoken: "Pasta", category: "main_dish" },
            { id: "tacos", display: "Tacos", spoken: "Tacos", category: "fast_food" },
            { id: "ice_cream", display: "Ice Cream", spoken: "Ice Cream", category: "dessert" },
            { id: "orange_juice", display: "Orange Juice", spoken: "Orange Juice", category: "drink" },
            { id: "sandwich", display: "Sandwich", spoken: "Sandwich", category: "fast_food" },
            { id: "fries", display: "French Fries", spoken: "French Fries", category: "fast_food" },
            { id: "apple_pie", display: "Apple Pie", spoken: "Apple Pie", category: "dessert" },
            { id: "water", display: "Water", spoken: "Water", category: "drink" },
            { id: "bread", display: "Bread", spoken: "Bread", category: "starter" },
            { id: "chicken_soup", display: "Chicken Soup", spoken: "Chicken Soup", category: "starter" },
            { id: "hot_dog", display: "Hot Dog", spoken: "Hot Dog", category: "fast_food" }
        ];

        // MEDIUM QUESTIONS (Dietary, Price, Preference)
        const mediumFoodItems = [
            { id: "cheeseburger", display: "Cheeseburger", spoken: "Cheeseburger", category: "fast_food" },
            { id: "caesar_salad", display: "Caesar Salad", spoken: "Caesar Salad", category: "starter" },
            { id: "spicy_tuna", display: "Spicy Tuna Roll", spoken: "Spicy Tuna Roll", category: "main_dish" },
            { id: "carbonara", display: "Spaghetti Carbonara", spoken: "Spaghetti Carbonara", category: "main_dish" },
            { id: "steak", display: "Grilled Steak", spoken: "Grilled Steak", category: "main_dish" },
            { id: "fish_chips", display: "Fish and Chips", spoken: "Fish and Chips", category: "main_dish" },
            { id: "greek_salad", display: "Greek Salad", spoken: "Greek Salad", category: "starter" },
            { id: "lemonade", display: "Fresh Lemonade", spoken: "Fresh Lemonade", category: "drink" },
            { id: "iced_tea", display: "Iced Tea", spoken: "Iced Tea", category: "drink" },
            { id: "bolognese", display: "Spaghetti Bolognese", spoken: "Spaghetti Bolognese", category: "main_dish" },
            { id: "mushroom_risotto", display: "Mushroom Risotto", spoken: "Mushroom Risotto", category: "main_dish" },
            { id: "tomato_soup", display: "Tomato Soup", spoken: "Tomato Soup", category: "starter" },
            { id: "salmon", display: "Grilled Salmon", spoken: "Grilled Salmon", category: "main_dish" },
            { id: "veggie_wrap", display: "Veggie Wrap", spoken: "Veggie Wrap", category: "fast_food" },
            { id: "chocolate_cake", display: "Chocolate Cake", spoken: "Chocolate Cake", category: "dessert" }
        ];

        // HARD QUESTIONS (Complex Reasoning & Allergies)
        const hardFoodItems = [
            { id: "double_bacon", display: "Double Bacon Burger", spoken: "Double Bacon Burger", category: "fast_food" },
            { id: "lobster_bisque", display: "Lobster Bisque", spoken: "Lobster Bisque", category: "starter" },
            { id: "dragon_roll", display: "Dragon Roll", spoken: "Dragon Roll", category: "main_dish" },
            { id: "veg_lasagna", display: "Vegetarian Lasagna", spoken: "Vegetarian Lasagna", category: "main_dish" },
            { id: "surf_turf", display: "Surf and Turf", spoken: "Surf and Turf", category: "main_dish" },
            { id: "chicken_parm", display: "Chicken Parmesan", spoken: "Chicken Parmesan", category: "main_dish" },
            { id: "beef_wellington", display: "Beef Wellington", spoken: "Beef Wellington", category: "main_dish" },
            { id: "pad_thai", display: "Pad Thai", spoken: "Pad Thai", category: "main_dish" },
            { id: "truffle_pasta", display: "Truffle Pasta", spoken: "Truffle Pasta", category: "main_dish" },
            { id: "sashimi_platter", display: "Sashimi Platter", spoken: "Sashimi Platter", category: "main_dish" },
            { id: "gluten_free_pizza", display: "Gluten-Free Pizza", spoken: "Gluten-Free Pizza", category: "main_dish" },
            { id: "earl_grey", display: "Earl Grey Tea", spoken: "Earl Grey Tea", category: "drink" },
            { id: "wagyu_burger", display: "Wagyu Beef Burger", spoken: "Wagyu Beef Burger", category: "fast_food" },
            { id: "lobster_thermidor", display: "Lobster Thermidor", spoken: "Lobster Thermidor", category: "main_dish" },
            { id: "sparkling_water", display: "Sparkling Water", spoken: "Sparkling Water", category: "drink" }
        ];

        // ========================================
        // üìù CONVERSATION TEMPLATES
        // ========================================
        
        const conversationTemplates = {
            easy: {
                food: [
                    "I'm absolutely starving. I'll have the {item}, please.",
                    "For my main course, I've decided on the {item}.",
                    "The {item} looks delicious. I'll take that one.",
                    "Just a {item} for me, please.",
                    "I'm in the mood for something tasty. I'll get the {item}."
                ],
                drink: [
                    "I'm thirsty. I'll have a {item}.",
                    "Could I get a glass of {item}, please?",
                    "Just a {item} for me to drink."
                ]
            },
            medium: {
                food: [
                    "I was going to get the {distractor1}, but it's too expensive. I'll have the {item} instead.",
                    "I usually order the {distractor1}, but today I feel like having the {item}.",
                    "Can I have the {distractor1}? Oh, it's spicy? Never mind, I'll take the {item}.",
                    "I wanted the {distractor1}, but my friend recommended the {item}, so I'll try that."
                ],
                drink: [
                    "I asked for a {distractor1}, but you brought me a {item}. That's fine, I'll drink it.",
                    "Do you have {distractor1}? No? Okay, just a {item} then.",
                    "I usually drink {distractor1}, but it's too sweet for me today. I'll have a {item}."
                ]
            },
            hard: {
                food: [
                    "I looked at the {distractor1}, but it has peanuts and I'm allergic. I'll have the {item}.",
                    "I really wanted the {distractor1}, but I'm lactose intolerant. So I guess I have to order the {item}.",
                    "The {distractor1} contains gluten, which I can't eat. The {distractor2} is sold out. So I'll just have the {item}.",
                    "My doctor told me to avoid red meat, so the {distractor1} is out. I'll stick with the {item}."
                ],
                drink: [
                    "I'd love a {distractor1}, but the machine is broken. And no {distractor2} either? Fine, give me a {item}.",
                    "I tried to order the {distractor1}, but it has too much caffeine. I'll take the {item} instead.",
                    "If the {distractor1} is fresh, I'll take it. It's bottled? I don't want it then. Just give me a {item}."
                ]
            }
        };

        // ======= STATE =======
        let currentGrade = null;
        let studentNames = [];
        let totalRounds = 8;
        let currentRound = 1;
        let currentQuestion = 1;
        let currentPlayers = [];
        let usedPlayers = [];
        let playerScores = {};
        let globalLeaderboard = {};
        let playerStreaks = {};
        let timeLeft = 15;
        let gameActive = false;
        let currentQuestionData = null;
        let questionInterval = null;
        let timers = new Set();
        let cachedVoices = [];
        let voicesReady = false;

        // ======= HELPERS =======
        function clearTimer(ref) {
          if (!ref) return;
          if (ref._type === 'interval') clearInterval(ref.id);
          else clearTimeout(ref.id);
          timers.delete(ref);
        }

        function makeInterval(fn, ms) {
          const id = setInterval(fn, ms);
          const ref = { id, _type: 'interval' };
          timers.add(ref);
          return ref;
        }

        function makeTimeout(fn, ms) {
          const id = setTimeout(fn, ms);
          const ref = { id, _type: 'timeout' };
          timers.add(ref);
          return ref;
        }

        function stopAllSpeech() {
          if ('speechSynthesis' in window) {
            speechSynthesis.cancel();
          }
        }

        function ensureVoicesReady() {
          return new Promise(resolve => {
            if (voicesReady) return resolve(cachedVoices);
            const load = () => {
              cachedVoices = speechSynthesis.getVoices();
              if (cachedVoices && cachedVoices.length > 0) {
                voicesReady = true;
                resolve(cachedVoices);
              }
            };
            const existing = speechSynthesis.getVoices();
            if (existing && existing.length > 0) {
              cachedVoices = existing;
              voicesReady = true;
              resolve(cachedVoices);
            } else {
              window.speechSynthesis.onvoiceschanged = () => load();
              try {
                const u = new SpeechSynthesisUtterance('');
                speechSynthesis.speak(u);
                speechSynthesis.cancel();
              } catch {}
              makeTimeout(load, 1000);
            }
          });
        }

        function speakOnce(text, { lang = 'en-US', rate = 0.85, pitch = 1 } = {}) {
            return new Promise(async (resolve) => {
                if (!('speechSynthesis' in window) || !text) {
                    return resolve();
                }
                await ensureVoicesReady();
                stopAllSpeech(); 
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.rate = rate;
                u.pitch = pitch;
                if (cachedVoices.length > 0) {
                    let selectedVoice;
                    if (lang === 'zh-CN') {
                        selectedVoice = cachedVoices.find(v => v.name.includes('Xiaoxiao')) || cachedVoices.find(v => v.lang === 'zh-CN');
                    } else {
                        selectedVoice = cachedVoices.find(v => v.name.includes('Andrew') && v.lang.startsWith('en')) ||
                                        cachedVoices.find(v => v.name === 'Microsoft Andrew Online (Natural) - English (United States)') ||
                                        cachedVoices.find(v => v.lang.startsWith('en'));
                    }
                    if (selectedVoice) u.voice = selectedVoice;
                }
                u.onend = () => resolve();
                u.onerror = () => resolve();
                speechSynthesis.speak(u);
            });
        }
        
        function speak(text) { return speakOnce(text, { lang: 'en-US', rate: 0.85, pitch: 1 }); }
        function speakChinese(text) { return speakOnce(text, { lang: 'zh-CN', rate: 0.8, pitch: 1 }); }

        function playAudio() {
            if (!currentQuestionData) return Promise.resolve();
            return speakOnce(currentQuestionData.script);
        }

        // ======= GAME LOGIC =======
        function startTimer() {
            const progressFill = document.getElementById('progressFill');
            const progressEmoji = document.getElementById('progressEmoji');
            if (questionInterval) clearTimer(questionInterval);

            timeLeft = 15;
            progressFill.style.width = '100%';
            progressEmoji.textContent = 'üçΩÔ∏è';

            questionInterval = makeInterval(() => {
                timeLeft--;
                const percentage = (timeLeft / 15) * 100;
                progressFill.style.width = percentage + '%';
                if (timeLeft <= 5 && timeLeft > 0) { playTickSound(); }
                if (timeLeft <= 0) {
                    clearTimer(questionInterval);
                    questionInterval = null;
                    stopAllSpeech();
                    playBuzzerSound();
                    timeUp();
                }
            }, 1000);
        }

        async function startNewQuestion() {
            if (currentQuestion > 10) {
                endRound();
                return;
            }
            stopAllSpeech();
            if (questionInterval) clearTimer(questionInterval);

            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => {
                button.disabled = false;
                button.classList.remove('correct', 'incorrect');
            });

            gameActive = true;
            timeLeft = 15;
            currentQuestionData = generateQuestion();
            document.getElementById('currentQuestion').textContent = currentQuestion;
            document.getElementById('progressFill').style.width = '100%';
            updateStreakDisplay();
            startTimer();
            
            if (gameActive) await playAudio();
        }

        function generateQuestion() {
            let difficulty, itemPool;
            
            // Difficulty progression
            if (currentQuestion === 1) {
                difficulty = 'easy';
                itemPool = easyFoodItems;
            } else if (currentQuestion <= 5) {
                difficulty = 'medium';
                itemPool = mediumFoodItems;
            } else {
                difficulty = 'hard';
                itemPool = hardFoodItems;
            }
            
            const correctItem = itemPool[Math.floor(Math.random() * itemPool.length)];
            
            // Distractor Logic: Restrict to same category type (Drink vs Food)
            const isDrink = correctItem.category === 'drink';
            const allItems = [...easyFoodItems, ...mediumFoodItems, ...hardFoodItems];
            
            const distractorPool = allItems.filter(item => {
                const itemIsDrink = item.category === 'drink';
                return item.id !== correctItem.id && itemIsDrink === isDrink;
            });

            const distractorItems = distractorPool
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);

            const choices = [correctItem, ...distractorItems];
            const templateType = isDrink ? 'drink' : 'food';
            const templates = conversationTemplates[difficulty][templateType];
            let script = templates[Math.floor(Math.random() * templates.length)];
            
            // Replace placeholders
            script = script.replace(/{item}/g, correctItem.spoken);
            if (distractorItems[0]) script = script.replace(/{distractor1}/g, distractorItems[0].spoken);
            if (distractorItems[1]) script = script.replace(/{distractor2}/g, distractorItems[1].spoken);

            // Shuffle choices for buttons
            const p1Choices = [...choices].sort(() => Math.random() - 0.5);
            const p2Choices = [...choices].sort(() => Math.random() - 0.5);
            const p3Choices = [...choices].sort(() => Math.random() - 0.5);
            
            const buttons = document.querySelectorAll('.choice-button');
            p1Choices.forEach((c, i) => { buttons[i].textContent = c.display; });
            p2Choices.forEach((c, i) => { buttons[i+4].textContent = c.display; });
            p3Choices.forEach((c, i) => { buttons[i+8].textContent = c.display; });

            return {
                script,
                correctItem,
                player1Choices: p1Choices,
                player2Choices: p2Choices,
                player3Choices: p3Choices
            };
        }

        async function selectAnswer(choiceIndex) {
            if (!gameActive || !currentQuestionData) return;
            
            gameActive = false;
            if (questionInterval) clearTimer(questionInterval);
            stopAllSpeech();

            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => button.disabled = true);

            let answeringPlayer, selectedChoice;
            
            if (choiceIndex < 4) { answeringPlayer = currentPlayers[0]; selectedChoice = currentQuestionData.player1Choices[choiceIndex]; }
            else if (choiceIndex < 8) { answeringPlayer = currentPlayers[1]; selectedChoice = currentQuestionData.player2Choices[choiceIndex-4]; }
            else { answeringPlayer = currentPlayers[2]; selectedChoice = currentQuestionData.player3Choices[choiceIndex-8]; }
            
            const isCorrect = selectedChoice.id === currentQuestionData.correctItem.id;
            
            buttons.forEach((button, index) => {
                if (button.textContent === currentQuestionData.correctItem.display) {
                    button.classList.add('correct');
                    createFireworks(button);
                    createSparkles(button);
                } else if (index === choiceIndex) {
                    button.classList.add('incorrect');
                    createShakeEffect(button);
                }
            });
            
            if (!playerStreaks[answeringPlayer]) playerStreaks[answeringPlayer] = 0;
            
            if (isCorrect) {
                playerStreaks[answeringPlayer]++;
                let points = 10 + (playerStreaks[answeringPlayer] >= 3 ? Math.min(playerStreaks[answeringPlayer]*2, 20) : 0);
                playerScores[answeringPlayer] += points;
                playCorrectSound();
                currentPlayers.forEach(p => { if (p !== answeringPlayer) playerStreaks[p] = 0; });
                
                let msg = `Correct!`;
                if (playerStreaks[answeringPlayer] > 2) msg += ` ${playerStreaks[answeringPlayer]} streak!`;
                await speak(msg);
                await speakChinese(`${answeringPlayer.split(' / ')[0]}ÔºåÁ≠îÂØπ‰∫ÜÔºÅÂä†${points}ÂàÜÔºÅ`);
                createFlyingTokens(buttons[choiceIndex], getPlayerScoreElement(answeringPlayer), `+${points}`);
                if (playerStreaks[answeringPlayer] > 2) createStreakEffects(buttons[choiceIndex]);
            } else {
                playerStreaks[answeringPlayer] = 0;
                playerScores[answeringPlayer] -= 5;
                currentPlayers.forEach(p => {
                    if (p !== answeringPlayer) {
                        playerScores[p] += 5;
                        createFlyingTokens(buttons[choiceIndex], getPlayerScoreElement(p), '+5');
                    }
                });
                playWrongSound();
                await speak(`Incorrect.`);
                await speakChinese(`${answeringPlayer.split(' / ')[0]}ÔºåÁ≠îÈîô‰∫Ü„ÄÇÂáè‰∫îÂàÜ„ÄÇ`);
                createFlyingTokens(buttons[choiceIndex], getPlayerScoreElement(answeringPlayer), '-5');
            }
            
            updatePlayerDisplay();
            updateStreakDisplay();
            
            makeTimeout(() => {
                currentQuestion++;
                startNewQuestion();
            }, 2000);
        }

        async function timeUp() {
            gameActive = false;
            stopAllSpeech();
            currentPlayers.forEach(p => playerStreaks[p] = 0);
            
            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => {
                if (button.textContent === currentQuestionData.correctItem.display) {
                    button.classList.add('correct');
                    createSparkles(button);
                }
                button.disabled = true;
            });

            await speakChinese(`Êó∂Èó¥Âà∞ÔºÅÊ≠£Á°ÆÁ≠îÊ°àÊòØ${currentQuestionData.correctItem.display}`);
            updatePlayerDisplay();
            updateStreakDisplay();
            makeTimeout(() => { currentQuestion++; startNewQuestion(); }, 2000);
        }

        // ... (Rest of logic: endRound, nextRound, selectPlayers, animations, sounds are identical to previous version) ...
        // Re-pasting core animation/flow logic for completeness
        
        async function endRound() {
            stopAllSpeech();
            const leaderboard = document.getElementById('leaderboard');
            const content = document.getElementById('leaderboardContent');
            const globalContent = document.getElementById('globalScores');
            
            currentPlayers.forEach(player => {
                if (!globalLeaderboard[player]) globalLeaderboard[player] = 0;
                globalLeaderboard[player] += playerScores[player];
            });
            
            const sortedPlayers = [...currentPlayers].sort((a, b) => playerScores[b] - playerScores[a]);
            let leaderboardHTML = '<h3>Round Scores:</h3>';
            sortedPlayers.forEach((player, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                leaderboardHTML += `<div style="margin: 10px 0; font-size: 20px;">${medal} ${player.split(' / ')[0]}: ${playerScores[player]}</div>`;
            });
            
            const globalSorted = Object.entries(globalLeaderboard).sort(([,a], [,b]) => b - a).slice(0, 10);
            let globalHTML = '';
            globalSorted.forEach(([player, score], index) => {
                const medal = index === 0 ? 'üëë' : index === 1 ? 'ü•á' : index === 2 ? 'ü•à' : '‚≠ê';
                globalHTML += `<div style="margin: 5px 0; font-size: 16px;">${medal} ${player.split(' / ')[0]}: ${score}</div>`;
            });
            
            content.innerHTML = leaderboardHTML;
            globalContent.innerHTML = globalHTML;
            leaderboard.style.display = 'block';
            createWinnerFireworks();

            const winner = sortedPlayers[0];
            if (currentRound < totalRounds) {
                await speak(`Round winner is ${winner.split(' / ')[1]}!`);
                await speakChinese(`ÊÅ≠Âñú${winner.split(' / ')[0]}ÔºÅÊú¨ËΩÆËé∑ËÉúÔºÅ`);
                makeTimeout(() => { nextRound(); }, 5000);
            } else {
                const champion = globalSorted[0];
                await speak(`Game Over! Champion is ${champion[0].split(' / ')[1]}!`);
                await speakChinese(`ÊÄªÂÜ†ÂÜõÊòØ... ${champion[0].split(' / ')[0]}ÔºÅ`);
                makeTimeout(() => { backToMenu(); }, 8000);
            }
        }

        function nextRound() {
            stopAllSpeech();
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('streakIndicator').style.display = 'none';
            currentRound++;
            if (currentRound > totalRounds) { backToMenu(); return; }
            currentQuestion = 1;
            document.getElementById('roundDisplay').textContent = `Round ${currentRound} of ${totalRounds}`;
            Object.keys(playerScores).forEach(p => playerScores[p] = 0);
            Object.keys(playerStreaks).forEach(p => playerStreaks[p] = 0);
            if (currentRound === totalRounds) startFinalRound(); else selectNewPlayers();
        }

        function startFinalRound() {
            const shuffleDiv = document.getElementById('nameShuffle');
            shuffleDiv.querySelector('.shuffle-title').innerHTML = 'üèÜ FINAL ROUND! üèÜ';
            document.getElementById('shuffleContainer').innerHTML = '<div style="font-size: 24px; color: #666;">Top Players!</div>';
            const selectedPlayersDiv = document.getElementById('selectedPlayers');
            selectedPlayersDiv.innerHTML = '';

            let topPlayers = Object.entries(globalLeaderboard).sort(([, a], [, b]) => b - a).map(([player]) => player).slice(0, 3);
            if (topPlayers.length < 3) {
                const avail = studentNames.filter(n => !topPlayers.includes(n));
                while(topPlayers.length < 3 && avail.length > 0) topPlayers.push(avail.splice(Math.floor(Math.random()*avail.length), 1)[0]);
            }
            currentPlayers = topPlayers;
            currentPlayers.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'selected-player';
                d.textContent = `P${i+1}: ${p.split(' / ')[0]}`;
                selectedPlayersDiv.appendChild(d);
            });
            shuffleDiv.style.display = 'block';
            makeTimeout(() => showPlayerCountdown(true), 4000);
        }

        function selectNewPlayers() {
            showNameShuffle();
            if (usedPlayers.length >= studentNames.length) usedPlayers = [];
            const avail = studentNames.filter(n => !usedPlayers.includes(n));
            const container = document.getElementById('shuffleContainer');
            container.innerHTML = '';
            document.getElementById('selectedPlayers').innerHTML = '';
            
            avail.forEach((n, i) => {
                setTimeout(() => {
                    const d = document.createElement('div');
                    d.className = 'shuffle-name';
                    d.textContent = n.split(' / ')[0];
                    container.appendChild(d);
                }, i*50);
            });
            setTimeout(() => selectPlayersSequentially(avail, 0), avail.length*50 + 1000);
        }

        function selectPlayersSequentially(avail, idx) {
            if (idx >= 3) { setTimeout(() => showPlayerCountdown(), 1000); return; }
            const container = document.getElementById('shuffleContainer');
            const names = Array.from(container.querySelectorAll('.shuffle-name'));
            let count = 0;
            const int = setInterval(async () => {
                names.forEach(e => e.classList.remove('selected'));
                const remaining = Array.from(container.querySelectorAll('.shuffle-name'));
                if (remaining.length === 0) { clearInterval(int); return; }
                const rand = Math.floor(Math.random()*remaining.length);
                remaining[rand].classList.add('selected');
                count++;
                if (count > 10) {
                    clearInterval(int);
                    const selIdx = Math.floor(Math.random()*avail.length);
                    const p = avail.splice(selIdx, 1)[0];
                    currentPlayers.push(p);
                    usedPlayers.push(p);
                    
                    names.forEach(e => { if(e.textContent === p.split(' / ')[0]) e.remove(); });
                    const d = document.createElement('div');
                    d.className = 'selected-player';
                    d.textContent = p.split(' / ')[0];
                    document.getElementById('selectedPlayers').appendChild(d);
                    playCorrectSound();
                    await speakChinese(p.split(' / ')[0]);
                    setTimeout(() => selectPlayersSequentially(avail, idx+1), 500);
                }
            }, 100);
        }

        function showNameShuffle() { document.getElementById('nameShuffle').style.display = 'block'; currentPlayers = []; playShuffleSound(); }
        function showPlayerCountdown(final=false) {
            const div = document.getElementById('nameShuffle');
            if (!final) div.querySelector('.shuffle-container').innerHTML = '';
            let c = 5;
            const t = div.querySelector('.shuffle-title');
            t.textContent = `Starting in ${c}...`;
            const i = setInterval(() => {
                c--;
                t.textContent = `Starting in ${c}...`;
                if (c<=0) {
                    clearInterval(i);
                    currentPlayers.forEach(p => playerScores[p]=0);
                    updatePlayerDisplay();
                    div.style.display='none';
                    startNewQuestion();
                }
            }, 1000);
        }

        function updatePlayerDisplay() {
            document.getElementById('player1').textContent = currentPlayers[0]?.split(' / ')[0] || 'P1';
            document.getElementById('score1').textContent = (playerScores[currentPlayers[0]]||0) + ' pts';
            document.getElementById('player2').textContent = currentPlayers[1]?.split(' / ')[0] || 'P2';
            document.getElementById('score2').textContent = (playerScores[currentPlayers[1]]||0) + ' pts';
            document.getElementById('player3').textContent = currentPlayers[2]?.split(' / ')[0] || 'P3';
            document.getElementById('score3').textContent = (playerScores[currentPlayers[2]]||0) + ' pts';
        }

        function updateStreakDisplay() {
            let max = 0;
            currentPlayers.forEach(p => { if (playerStreaks[p]>max) max = playerStreaks[p]; });
            const s = document.getElementById('streakIndicator');
            if (max > 0) { s.style.display='block'; document.getElementById('streakCount').textContent=max; }
            else s.style.display='none';
        }

        function backToMenu() {
            stopAllSpeech();
            if(questionInterval) clearTimer(questionInterval);
            gameActive = false; currentRound = 1; currentQuestion = 1;
            currentPlayers = []; usedPlayers = []; playerScores = {}; playerStreaks = {}; globalLeaderboard = {};
            ['leaderboard', 'learningPhase', 'nameShuffle', 'gameContainer', 'streakIndicator'].forEach(id => document.getElementById(id).style.display = 'none');
            document.getElementById('mainMenu').style.display = 'flex';
        }

        function selectGrade(g) {
            currentGrade = g;
            studentNames = studentsByGrade[g];
            totalRounds = g === 10 ? 6 : 5;
            document.getElementById('roundDisplay').textContent = `Round 1 of ${totalRounds}`;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            selectNewPlayers();
        }

        // Effects
        function createFireworks(b) {
            const r = b.getBoundingClientRect();
            for(let i=0;i<15;i++) {
                setTimeout(()=>{
                    const f = document.createElement('div'); f.className='fireworks';
                    f.style.left = r.left + r.width/2 + 'px'; f.style.top = r.top + r.height/2 + 'px';
                    document.body.appendChild(f); setTimeout(()=>f.remove(), 2000);
                }, i*100);
            }
        }
        function createSparkles(b) {
            const r = b.getBoundingClientRect();
            for(let i=0;i<10;i++) {
                setTimeout(()=>{
                    const s = document.createElement('div'); s.className='sparkle';
                    s.style.left = r.left + Math.random()*r.width + 'px';
                    s.style.top = r.top + Math.random()*r.height + 'px';
                    document.body.appendChild(s); setTimeout(()=>s.remove(), 1000);
                }, i*50);
            }
        }
        function createShakeEffect(b) {
            for(let i=0;i<5;i++) {
                setTimeout(()=>{
                    const x = document.createElement('div'); x.innerHTML='‚ùå'; x.style.position='absolute';
                    x.style.left = b.getBoundingClientRect().left + 20 + 'px';
                    x.style.top = b.getBoundingClientRect().top + 'px';
                    x.style.zIndex=1001; x.style.animation='fadeOut 1s forwards';
                    document.body.appendChild(x); setTimeout(()=>x.remove(), 1000);
                }, i*100);
            }
        }
        function createFlyingTokens(from, to, txt) {
            if(!from||!to)return;
            const f = from.getBoundingClientRect(); const t = to.getBoundingClientRect();
            for(let i=0;i<5;i++){
                setTimeout(()=>{
                    const tk = document.createElement('div'); tk.className='token'; tk.textContent=txt;
                    tk.style.left=f.left+f.width/2+'px'; tk.style.top=f.top+f.height/2+'px';
                    document.body.appendChild(tk);
                    setTimeout(()=>{
                        tk.style.transition='all 1s ease';
                        tk.style.left=t.left+t.width/2+'px'; tk.style.top=t.top+t.height/2+'px';
                        tk.style.opacity=0;
                    }, 50);
                    setTimeout(()=>tk.remove(), 1100);
                }, i*100);
            }
        }
        function createStreakEffects(b) { createFireworks(b); }
        function createWinnerFireworks() {
            for(let i=0;i<30;i++) {
                setTimeout(()=>{
                    const f = document.createElement('div'); f.className='winner-firework';
                    f.style.left=Math.random()*window.innerWidth+'px'; f.style.top=Math.random()*window.innerHeight+'px';
                    document.body.appendChild(f); setTimeout(()=>f.remove(), 3000);
                }, i*100);
            }
        }
        function getPlayerScoreElement(p) {
            const idx = currentPlayers.indexOf(p);
            if(idx===0) return document.getElementById('score1');
            if(idx===1) return document.getElementById('score2');
            if(idx===2) return document.getElementById('score3');
        }

        // Sound functions (placeholders for simplicity, ensure AudioContext is created on interaction if strict browser policy)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        function playTickSound() {
            const a = new AudioContext(); const o = a.createOscillator(); const g = a.createGain();
            o.connect(g); g.connect(a.destination); o.frequency.value=800; g.gain.value=0.1;
            o.start(); o.stop(a.currentTime+0.1);
        }
        function playBuzzerSound() {
            const a = new AudioContext(); const o = a.createOscillator(); const g = a.createGain();
            o.connect(g); g.connect(a.destination); o.frequency.value=200; g.gain.value=0.3;
            o.start(); o.stop(a.currentTime+0.5);
        }
        function playCorrectSound() {
            const a = new AudioContext(); 
            [523, 659, 784, 1047].forEach((f,i)=>{
                setTimeout(()=>{
                    const o = a.createOscillator(); const g = a.createGain();
                    o.connect(g); g.connect(a.destination); o.frequency.value=f; g.gain.value=0.1;
                    o.start(); o.stop(a.currentTime+0.2);
                }, i*100);
            });
        }
        function playWrongSound() {
            const a = new AudioContext(); const o = a.createOscillator(); const g = a.createGain();
            o.connect(g); g.connect(a.destination); o.frequency.value=150; g.gain.value=0.2;
            o.start(); o.stop(a.currentTime+0.4);
        }
        function playShuffleSound() {
            const a = new AudioContext();
            for(let i=0;i<5;i++){
                setTimeout(()=>{
                    const o=a.createOscillator(); const g=a.createGain();
                    o.connect(g); g.connect(a.destination); o.frequency.value=400+Math.random()*200; g.gain.value=0.05;
                    o.start(); o.stop(a.currentTime+0.1);
                }, i*100);
            }
        }

        window.addEventListener('load', () => {
            setTimeout(initGame, 1000);
            ensureVoicesReady();
        });
        
        function initGame() {
            // BG effects
            setInterval(()=>{
                const l = document.createElement('div'); l.className='laser-beam';
                l.style.left=Math.random()*window.innerWidth+'px';
                document.body.appendChild(l); setTimeout(()=>l.remove(), 3000);
            }, 2000);
        }
    </script>
</body>
</html>
