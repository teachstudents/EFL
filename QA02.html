<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Joel's Speaking Practice 02</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            position: relative;
        }
        /* Snowfall effect */
        .snowflake {
            color: #fff;
            font-size: 1em;
            font-family: Arial, sans-serif;
            text-shadow: 0 0 5px #000;
            position: fixed;
            top: -10%;
            z-index: 0;
            user-select: none;
            animation: snowfall linear infinite;
        }

        @keyframes snowfall {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(105vh) rotate(360deg); opacity: 0; }
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        audio::-webkit-media-controls-panel {
            padding: 5px;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display {
            margin: 0 2px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Make sure app content is above the snow */
        #app-container {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center p-2 sm:p-4">
    
    <div id="snow-container"></div>

    <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 fixed top-4 right-4 z-50">
        <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
        <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707-.707a1 1 0 01-1.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707z"></path></svg>
    </button>

    <div id="app-container" class="w-full max-w-xl mx-auto text-center h-full">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center">
            <div id="name-entry-container">
                <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">Joel's Speaking Practice 02</h1>
                <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 text-center text-lg text-gray-900 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                <button id="start-with-name-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">Start</button>
            </div>
            <div id="topic-selection-container" class="hidden">
                 <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">Hello, <span id="user-name-display"></span>!</h1>
                 <div id="instructions" class="text-sm text-gray-600 dark:text-gray-400 mb-4 text-left space-y-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                      <p><i class="fas fa-bullhorn mr-2 text-indigo-500"></i>Try to speak until the time runs out. You can use the sentence starters and word bank for help.</p>
                      <p><i class="fas fa-download mr-2 text-blue-500"></i>After recording, download your answer and upload it. If the upload doesn't work, save the downloaded files.</p>
                      <p><i class="fas fa-award mr-2 text-yellow-500"></i>You must complete all 9 topics to get the Certificate of Completion as proof you finished the homework.</p>
                 </div>
                <div id="topic-selection" class="grid grid-cols-3 gap-4">
                    <!-- Topic buttons will be injected here -->
                </div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden bg-white dark:bg-gray-800 rounded-2xl shadow-lg app-shell p-3 sm:p-4">
            <header class="flex-shrink-0">
                <div class="flex justify-between items-center mb-1">
                    <button id="back-to-topics-btn" class="text-indigo-500 hover:text-indigo-700"><i class="fas fa-arrow-left mr-2"></i>Topics</button>
                </div>
                <!-- Timer Display -->
                <div class="relative w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-2 flex-shrink-0">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200 dark:text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="timer-progress" class="timer-circle text-indigo-500" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-2xl font-bold"></div>
                </div>
                <p id="phase-indicator" class="font-semibold text-indigo-500 dark:text-indigo-400 mb-2 text-base flex-shrink-0"></p>

                <!-- Question Display -->
                <div id="question-container" class="min-h-[50px] flex items-center justify-center mb-2">
                    <h2 id="question-text" class="text-base sm:text-lg font-semibold leading-relaxed text-left w-full"></h2>
                </div>
                
                <div id="error-message-box" class="hidden text-red-500 bg-red-100 dark:bg-red-900/50 p-2 rounded-lg text-sm mb-2"></div>

                <!-- Recording Action Buttons -->
                <div id="recording-actions-container" class="flex flex-col items-center justify-center mb-2">
                    <!-- Initial Record Button -->
                    <button id="record-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md transition-transform transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <!-- Stop Button -->
                    <button id="stop-record-btn" class="hidden bg-gray-700 hover:bg-gray-800 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md flex items-center justify-center">
                        <i class="fas fa-stop"></i>
                    </button>
                    <!-- Post-Recording Controls -->
                    <div id="post-recording-actions" class="hidden w-full flex-col items-center justify-center space-y-2 mt-2">
                        <audio id="audio-player" controls class="w-full max-w-xs"></audio>
                        <div class="flex flex-col gap-3 w-full max-w-xs">
                          <!-- Smart Download button -->
                          <button id="download-btn"
                                  class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md transition-all duration-200 ease-in-out hover:shadow-lg hover:shadow-blue-500/50 focus:ring-2 focus:ring-blue-400 focus:outline-none active:scale-95 flex items-center justify-center">
                            <i class="fas fa-download mr-1"></i>Download Recording / Open Folder
                          </button>
                        
                          <!-- Upload button -->
                          <a id="sharepoint-upload-link"
                             href="https://xichengacademy-my.sharepoint.com/:f:/g/personal/joelmitchell_xichengacademy_cn/EjxMFg8-baNEo5uuWUBc4EoBzn1DVWJ1Ym_NFx6hPlJ0dQ"
                             target="_blank"
                             rel="noopener noreferrer"
                             class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md transition-all duration-200 ease-in-out hover:shadow-lg hover:shadow-green-500/50 focus:ring-2 focus:ring-green-400 focus:outline-none active:scale-95 flex items-center justify-center">
                            <i class="fas fa-upload mr-1"></i>Upload to Folder
                          </a>
                        </div>
                    </div>
                </div>
                 <div id="recording-status" class="hidden items-center justify-center text-red-500 font-semibold mb-1">
                      <div class="w-2 h-2 bg-red-500 rounded-full mr-2 recording-indicator"></div>
                      Recording...
                 </div>
            </header>
            
            <main class="flex-grow flex flex-col overflow-y-auto min-h-0 space-y-2 pt-2">
                 <!-- Sentence Starters -->
                <div id="starters-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Sentence Starters</h3>
                    <div id="starters-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Word Bank -->
                <div id="word-bank-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Word Bank</h3>
                    <div id="word-bank-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Sample Answers Display -->
                <div id="samples-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center flex-shrink-0">Sample Responses</h3>
                    <ul id="samples-list" class="space-y-2 list-disc list-inside bg-indigo-900/70 dark:bg-indigo-900/90 p-3 rounded-lg max-h-28 sm:max-h-32 overflow-y-auto">
                    </ul>
                </div>
            </main>

            <footer class="flex-shrink-0 mt-2">
                <!-- Next Button -->
                <div id="controls-container">
                     <button id="next-btn" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg text-lg shadow-md">Next</button>
                </div>
            </footer>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center">
            <div id="certificate-to-download" class="w-full bg-gray-50 dark:bg-gray-700 p-8 rounded-lg border-4 border-yellow-400 dark:border-yellow-500 text-center">
                <i class="fas fa-award text-6xl text-yellow-500 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Certificate of Completion</h1>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">This certificate is awarded to</p>
                <p id="certificate-name" class="text-4xl font-bold my-4 text-indigo-600 dark:text-indigo-400"></p>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">for successfully completing all 9 speaking practice topics.</p>
                <p class="text-sm mt-6 text-gray-500 dark:text-gray-400">Issued on: <span id="certificate-date"></span></p>
            </div>
            <button id="download-certificate-btn" class="mt-6 w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">
                <i class="fas fa-download mr-2"></i>Download Certificate
            </button>
             <button id="back-to-main-menu-btn" class="mt-3 text-sm text-indigo-500 hover:underline">Back to Main Menu</button>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA: Questions and Sample Answers for Part 02 ---
        const practiceData = {
            "University Life": [
                { 
                    question: "What are you most excited or nervous about when you think about attending a German university?", 
                    starters: ["I'm most excited about...", "What makes me a bit nervous is...", "I'm looking forward to...", "On one hand, I'm excited for..., but on the other hand..."], 
                    wordBank: ["independence", "new environment", "lecture halls", "seminars", "research", "international students", "language barrier", "challenging", "academic rigor"], 
                    samples: [
                        "I'm most excited about the academic freedom because I will get to choose my own courses and focus on subjects I'm truly passionate about, like robotics.",
                        "What makes me a bit nervous is the language barrier, because even if I pass the language exams, speaking in a real university seminar will be very challenging at first.",
                        "I am really looking forward to meeting people from all over the world, because a German university has many international students and I want to learn about their cultures."
                    ] 
                },
                { 
                    question: "How do you think the teaching style in Germany will be different from your high school in Beijing?", 
                    starters: ["I believe the teaching style will be more...", "Compared to my high school, I expect...", "One major difference might be...", "I've heard that German professors encourage..."], 
                    wordBank: ["independent study", "interactive", "less homework", "more reading", "critical thinking", "self-discipline", "theoretical", "practical application", "student-led"], 
                    samples: [
                        "I believe the teaching style will be more focused on independent study, because in my high school we are guided a lot by teachers, but in Germany I'll have to manage my own learning.",
                        "Compared to my high school, I expect there will be less regular homework but more emphasis on final exams, which means I need a lot of self-discipline.",
                        "I've heard that German professors encourage more critical thinking and discussion in seminars, because they want students to question ideas, not just memorize them."
                    ] 
                }
            ],
            "German Culture": [
                { 
                    question: "Besides punctuality, what other German cultural trait have you heard about and what do you think of it?", 
                    starters: ["Another trait I've heard about is...", "I'm curious about the German emphasis on...", "I find it interesting that...", "I think I will appreciate..."], 
                    wordBank: ["directness", "efficiency", "rule-following", "recycling (Mülltrennung)", "privacy", "formality (Sie/du)", "work-life balance", "respectful", "organized"], 
                    samples: [
                        "I've heard about the German habit of separating trash, called Mülltrennung, and I think it's great because it shows a strong respect for the environment.",
                        "Another trait is their directness in communication. I think it will be helpful because it avoids misunderstandings, even if it feels a little blunt at first.",
                        "I find their strong sense of privacy interesting because in China we are often more open in groups, but I think I'll appreciate the personal space in Germany."
                    ] 
                },
                { 
                    question: "Are there any German holidays or traditions, like Oktoberfest or Christmas markets, that you are curious to experience?", 
                    starters: ["I would love to experience...", "I'm really curious about...", "I've seen pictures of... and I want to...", "It would be amazing to see..."], 
                    wordBank: ["Christmas markets (Weihnachtsmärkte)", "Oktoberfest", "Carnival (Karneval)", "Easter", "New Year's Eve (Silvester)", "traditions", "atmosphere", "celebration", "local culture"], 
                    samples: [
                        "I would love to experience the Christmas markets because they look so magical in the pictures, with all the lights, food, and handmade crafts.",
                        "I am really curious about Carnival in cities like Cologne, because the tradition of dressing up in costumes and having big parades seems very fun and energetic.",
                        "While Oktoberfest is famous, I am more interested in experiencing a German New Year's Eve, because I have heard they have huge fireworks displays."
                    ] 
                }
            ],
            "Making Friends": [
                { 
                    question: "How do you plan to meet new people and make friends in Germany, both German and international students?", 
                    starters: ["My plan is to join...", "I think a good way to meet people is...", "I will try to be more...", "I hope to connect with people by..."], 
                    wordBank: ["university clubs (Hochschulgruppen)", "sports teams", "language tandem", "student events", "classmates", "shared interests", "open-minded", "approachable", "socialize"], 
                    samples: [
                        "My plan is to join a university sports club, maybe for basketball, because it's a great way to meet people who share the same interests.",
                        "I think a good way to meet German students is to find a language tandem partner, because we can help each other with language skills and also become friends.",
                        "I will try to be more open and proactive in class, for example, by suggesting a study group, because it is an easy way to get to know my classmates."
                    ] 
                },
                 { 
                    question: "What qualities do you look for in a good friend?", 
                    starters: ["For me, a good friend is someone who is...", "The most important quality in a friend is...", "I value friends who are...", "I think it's important that a friend is..."], 
                    wordBank: ["trustworthy", "supportive", "honest", "good listener", "sense of humor", "reliable", "kind", "common interests", "understanding"], 
                    samples: [
                        "For me, a good friend is someone who is trustworthy, because it's important to know you can share your secrets and feelings with them without worry.",
                        "I value friends who are supportive, because when you are living abroad, you will face challenges, and having someone who encourages you is very important.",
                        "The most important quality is a good sense of humor, because I love to laugh and I think sharing funny moments is a great way to build a strong connection."
                    ] 
                }
            ],
            "Part-time Jobs": [
                { 
                    question: "Have you considered getting a part-time job (HiWi or Minijob) while studying? What kind of job would you be interested in?", 
                    starters: ["Yes, I have thought about it because...", "I'm interested in finding a job as a...", "A 'HiWi' job at the university seems ideal because...", "I think a job in a... would be good experience."], 
                    wordBank: ["HiWi (research assistant)", "Minijob", "waiter/waitress", "tutor", "practical experience", "earn money", "improve German", "flexible hours", "relevant to my studies"], 
                    samples: [
                        "Yes, I would like a 'HiWi' job at my university because it would be directly related to my engineering studies and would be great practical experience.",
                        "I think working in a café or restaurant would be a good minijob because it would force me to practice my German with customers every day.",
                        "I'm interested in being a tutor for younger students, for example in mathematics, because I am good at the subject and I enjoy helping others learn."
                    ] 
                },
                { 
                    question: "What skills do you have that would be useful for a part-time job?", 
                    starters: ["One skill I have is...", "I am quite good at...", "I believe my ability to... would be useful.", "In my previous experiences, I have learned to..."], 
                    wordBank: ["organized", "responsible", "programming languages", "communication skills", "patient", "quick learner", "teamwork", "problem-solving", "language skills (Chinese/English)"], 
                    samples: [
                        "I am very patient and organized, which I think would be very useful for a job as a research assistant or 'HiWi' because that work requires attention to detail.",
                        "My language skills would be an asset, because I can speak Chinese and English fluently, which might be helpful in a shop or cafe in a tourist area.",
                        "I am a quick learner, especially with software. For example, I taught myself how to use Photoshop, so I could easily adapt to new systems in an office job."
                    ] 
                }
            ],
            "Transportation": [
                { 
                    question: "How do you plan to get around in your new German city?", 
                    starters: ["I plan to rely mostly on...", "I think buying a... would be a good idea because...", "I will probably use the...", "My main mode of transport will be..."], 
                    wordBank: ["public transport (ÖPNV)", "bicycle (Fahrrad)", "semester ticket", "train (Zug)", "bus", "tram (Straßenbahn)", "environmentally friendly", "convenient", "affordable"], 
                    samples: [
                        "I plan to buy a used bicycle because I've heard it's a very common and cheap way for students to get to university and explore the city.",
                        "I will definitely use the public transport system because the university provides a semester ticket that allows for unlimited travel in the local area.",
                        "I think I will mostly use the tram and bus, because the system in Germany is very efficient and it will be a good way to discover different parts of the city."
                    ] 
                },
                { 
                    question: "Describe a time you used public transportation in a big city, like Beijing.", 
                    starters: ["I remember one time when...", "The Beijing subway is...", "Once, I had to take a bus to...", "A typical experience on public transport for me is..."], 
                    wordBank: ["crowded", "efficient", "subway", "bus", "rush hour", "commute", "navigation app", "transfer lines", "packed", "convenient"], 
                    samples: [
                        "The Beijing subway during rush hour is an unforgettable experience because it's so crowded that you don't need to hold on, the people around you hold you up.",
                        "I remember one time I used a navigation app to take the bus to a museum, and it was very convenient because the app told me exactly when the bus would arrive.",
                        "I often take the subway to go to the city center, and it is very efficient. For example, you can get from the west side to the east side in under an hour, which is impossible by car."
                    ] 
                }
            ],
            "Daily Life": [
                { 
                    question: "German stores are usually closed on Sundays. How do you think you will adapt to this?", 
                    starters: ["I will have to plan my...", "I think I will adapt by...", "It will be different from China because...", "I'll need to remember to..."], 
                    wordBank: ["plan ahead", "grocery shopping", "get used to it", "weekly schedule", "Saturday", "relaxing Sunday", "culture shock", "prepare", "organize"], 
                    samples: [
                        "I will have to plan my grocery shopping carefully, because I need to make sure I buy everything I need for the weekend on Saturday.",
                        "I think I will adapt by treating Sunday as a real day for rest, for example, I can use it to study, meet friends in a park, or just relax at home.",
                        "It will be a big change because in Beijing, stores are open every day. I'll need to get used to organizing my week differently."
                    ] 
                },
                { 
                    question: "What is one household chore you are good at, and one you need to improve on before living alone?", 
                    starters: ["I'm quite good at... because...", "One thing I need to get better at is...", "I don't mind doing..., but I dislike...", "I have experience with..."], 
                    wordBank: ["cooking", "cleaning", "doing laundry", "washing dishes", "organized", "messy", "improve", "practice", "independent", "responsible"], 
                    samples: [
                        "I'm quite good at keeping my room organized because I like everything to be in its place, which helps me focus when I study.",
                        "One thing I really need to improve on is cooking, because right now I only know how to make instant noodles and I want to eat healthier food.",
                        "I am good at washing dishes because I find it relaxing, but I need to get better at doing laundry because I always forget to separate the colors."
                    ] 
                }
            ],
            "German Food": [
                { 
                    question: "Besides sausages and beer, what other German foods are you interested in trying?", 
                    starters: ["I would love to try...", "I've heard that... is really good.", "I'm curious about a dish called...", "I'm looking forward to trying some German..."], 
                    wordBank: ["Schnitzel", "Spätzle", "Pretzels (Brezeln)", "Black Forest Cake (Schwarzwälder Kirschtorte)", "Döner Kebab", "pastries", "bakeries (Bäckerei)", "regional dishes"], 
                    samples: [
                        "I would love to try Schnitzel because it looks like a very crispy and satisfying meal, especially with potatoes on the side.",
                        "I've heard that German bakeries are amazing, so I want to try all the different kinds of bread and pastries, like Pretzels.",
                        "I am curious to try Döner Kebab, because even though it's originally Turkish, I hear it's one of the most popular street foods in Germany."
                    ] 
                },
                { 
                    question: "What Chinese dish will you miss the most, and will you try to cook it yourself in Germany?", 
                    starters: ["The dish I will miss the most is definitely...", "I think it will be hard to find authentic...", "I will definitely try to learn how to cook... because...", "My favorite food from home is..."], 
                    wordBank: ["Hotpot (Feuertopf)", "dumplings (Jiaozi)", "Kung Pao Chicken", "Mapo Tofu", "miss the taste", "authentic ingredients", "learn the recipe", "hometown flavor", "share with friends"], 
                    samples: [
                        "The dish I will miss the most is hotpot, because it's not just food, it's a social event with family and friends that I will miss dearly.",
                        "I will definitely try to learn how to make dumplings, or Jiaozi, from my mom before I leave because they are my favorite comfort food.",
                        "I think I will really miss authentic Mapo Tofu, and I will try to cook it because I can probably find the special Sichuan peppercorns in an Asian supermarket."
                    ] 
                }
            ],
            "Future Career": [
                { 
                    question: "What kind of company or industry would you like to work in after you graduate from university in Germany?", 
                    starters: ["I hope to work for a... company.", "My goal is to get a job in the... industry.", "I'm particularly interested in working at...", "I would like to be a..."], 
                    wordBank: ["automotive industry", "tech company", "research and development", "engineering firm", "renewable energy", "multinational corporation", "start-up", "innovative"], 
                    samples: [
                        "I hope to work for a German automotive company like BMW or Mercedes-Benz, because that is the main reason I want to study automotive engineering.",
                        "My goal is to get a job in the renewable energy sector because I believe it is a very important industry for the future of our planet.",
                        "I would like to work in a research and development department, because I enjoy solving complex problems and creating new technologies."
                    ] 
                },
                { 
                    question: "Why is getting international experience in Germany important for your future career goals?", 
                    starters: ["International experience is crucial because...", "Working in Germany will give me...", "It's important for my career because it will show...", "This experience will help me to..."], 
                    wordBank: ["global perspective", "cross-cultural communication", "language skills", "competitive advantage", "networking", "adaptability", "broader mindset", "valuable skills"], 
                    samples: [
                        "International experience is crucial because it gives you a global perspective, which is very valuable in today's interconnected world.",
                        "It's important for my career because it will show future employers that I am adaptable and can work in a multicultural environment.",
                        "Working in Germany will improve my language and cross-cultural communication skills, because I will have to collaborate with people from many different backgrounds."
                    ] 
                }
            ],
            "Personal Growth": [
                { 
                    question: "What is a personal goal, not related to academics, that you want to achieve while living in Germany?", 
                    starters: ["A personal goal of mine is to learn...", "I want to challenge myself to...", "Besides my studies, I hope to...", "I want to take the opportunity to..."], 
                    wordBank: ["learn an instrument", "travel around Europe", "become more confident", "join a hiking club", "learn photography", "personal hobby", "new skill", "step out of my comfort zone"], 
                    samples: [
                        "A personal goal is to learn how to ski, because Germany has beautiful mountains and it's a popular sport that I've never had the chance to try.",
                        "I want to take the opportunity to travel to at least five other European countries because Germany's central location makes it very easy to explore.",
                        "Besides my studies, I hope to become more confident in speaking up and sharing my own ideas, because I am sometimes a bit shy in groups."
                    ] 
                },
                { 
                    question: "How do you think living abroad by yourself will help you become more independent?", 
                    starters: ["Living alone will force me to...", "I will have to learn how to...", "It will help me become more independent by...", "I believe I will grow as a person because..."], 
                    wordBank: ["self-reliant", "problem-solving", "manage my own finances", "make decisions", "responsible", "mature", "handle challenges", "cook for myself", "resilience"], 
                    samples: [
                        "Living alone will force me to manage my own finances, because I will have a budget and I must be responsible for paying rent and buying food.",
                        "I will have to learn how to solve problems on my own, for example, if something in my apartment breaks, because my parents won't be there to help.",
                        "I believe I will grow as a person because making all my own daily decisions, from what to eat to how to schedule my day, will make me much more self-reliant."
                    ] 
                }
            ]
        };

        // --- DOM Elements ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const welcomeScreen = document.getElementById('welcome-screen');
        const practiceScreen = document.getElementById('practice-screen');
        const nameEntryContainer = document.getElementById('name-entry-container');
        const nameInput = document.getElementById('name-input');
        const startWithNameBtn = document.getElementById('start-with-name-btn');
        const topicSelectionContainer = document.getElementById('topic-selection-container');
        const userNameDisplay = document.getElementById('user-name-display');
        const topicSelection = document.getElementById('topic-selection');
        const nextBtn = document.getElementById('next-btn');
        const backToTopicsBtn = document.getElementById('back-to-topics-btn');
        
        const timerDisplay = document.getElementById('timer-display');
        const timerProgress = document.getElementById('timer-progress');
        const phaseIndicator = document.getElementById('phase-indicator');
        
        const questionContainer = document.getElementById('question-container');
        const questionText = document.getElementById('question-text');
        const samplesContainer = document.getElementById('samples-container');
        const samplesList = document.getElementById('samples-list');
        const startersContainer = document.getElementById('starters-container');
        const startersList = document.getElementById('starters-list');
        const wordBankContainer = document.getElementById('word-bank-container');
        const wordBankList = document.getElementById('word-bank-list');
        const errorMessagebox = document.getElementById('error-message-box');

        const recordBtn = document.getElementById('record-btn');
        const stopRecordBtn = document.getElementById('stop-record-btn');
        const audioPlayer = document.getElementById('audio-player');
        const recordingStatus = document.getElementById('recording-status');
        const postRecordingActions = document.getElementById('post-recording-actions');
        const downloadBtn = document.getElementById('download-btn');
        
        // Certificate UI
        const certificateScreen = document.getElementById('certificate-screen');
        const downloadCertificateBtn = document.getElementById('download-certificate-btn');
        const backToMainMenuBtn = document.getElementById('back-to-main-menu-btn');


        // --- State Variables ---
        let userName = '';
        let currentQuestionIndex = 0;
        let currentQuestions = [];
        let timerInterval;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;
        let completedTopics = {};
        let speechRecognition;
        let finalTranscript = '';

        const FULL_DASH_ARRAY = 283;
        const DEFAULT_RESPONSE_TIME = 60;
        const READ_TIME = 60;

        // --- Text-to-Speech ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;
        let ttsInitialized = false;

        function initializeTTS() {
            return new Promise((resolve) => {
                if (!synth) {
                    ttsInitialized = true;
                    return resolve();
                }

                const setBestVoice = () => {
                    const voices = synth.getVoices();
                    if (voices.length === 0) return;
                    
                    const scoreVoice = (voice) => {
                        let score = 0;
                        const name = voice.name.toLowerCase();
                        if (name.includes('natural')) score += 5;
                        if (name.includes('brian') || name.includes('emma')) score += 4;
                        if (name.includes('microsoft')) score += 3;
                        if (name.includes('google')) score += 2;
                        if (voice.localService) score += 1;
                        return score;
                    };

                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    if (englishVoices.length > 0) {
                        englishVoices.sort((a, b) => scoreVoice(b) - scoreVoice(a));
                        preferredVoice = englishVoices[0];
                    }
                    
                    ttsInitialized = true;
                    resolve();
                };

                if (synth.getVoices().length > 0) {
                    setBestVoice();
                } else {
                    synth.onvoiceschanged = setBestVoice;
                }
            });
        }

        function speak(text, isFeedback = false) {
            if (!ttsInitialized) return;
            try {
                if (synth.speaking) synth.cancel();
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.onerror = (event) => console.error('SpeechSynthesisUtterance.onerror', event);
                if (preferredVoice) utterThis.voice = preferredVoice;
                utterThis.pitch = 1;  
                utterThis.rate = 0.85; // Slow down speech as requested
                synth.speak(utterThis);
            } catch (e) {
                console.error("Speech synthesis failed:", e);
            }
        }

        // --- Local Storage ---
        function loadProgress() {
            const savedCompletedTopics = localStorage.getItem('languagePracticeCompletedTopics');
            if (savedCompletedTopics) {
                try {
                    const parsed = JSON.parse(savedCompletedTopics);
                    // Basic validation to ensure it's an object
                    if (typeof parsed === 'object' && parsed !== null) {
                        completedTopics = parsed;
                    } else {
                         completedTopics = {};
                    }
                } catch (e) {
                    console.error("Failed to parse saved progress:", e);
                    completedTopics = {}; // Reset progress if data is corrupt
                }
            }
            const savedName = localStorage.getItem('languagePracticeUserName');
            if (savedName) {
                 userName = savedName;
                 nameInput.value = userName;
            }
        }

        function saveProgress() {
            localStorage.setItem('languagePracticeCompletedTopics', JSON.stringify(completedTopics));
            if(userName) localStorage.setItem('languagePracticeUserName', userName);
        }

        // --- UI Initialization ---
        function initializeTopics() {
            topicSelection.innerHTML = '';
            for (const topic in practiceData) {
                const button = document.createElement('button');
                
                let checkmark = '';
                if (completedTopics && completedTopics[topic]) {
                    checkmark = `<i class="fas fa-check-circle text-green-500 ml-2"></i>`;
                    button.className = "w-full bg-green-100 dark:bg-green-900/50 p-2 rounded-lg shadow-md hover:bg-green-200 dark:hover:bg-green-800/60 transition-colors flex items-center justify-center";
                } else {
                    button.className = "w-full bg-white dark:bg-gray-700 p-2 rounded-lg shadow-md hover:bg-indigo-100 dark:hover:bg-indigo-800 transition-all transform hover:scale-105 flex items-center justify-center";
                }

                button.innerHTML = `<span class="text-sm font-semibold">${topic}</span> ${checkmark}`;
                button.dataset.topic = topic;
                button.addEventListener('click', () => startPractice(topic));
                topicSelection.appendChild(button);
            }
        }

        // --- Core App Logic ---
        function startPractice(topic) {
            currentQuestions = practiceData[topic];
            currentQuestions.topicName = topic;
            currentQuestionIndex = 0;
            welcomeScreen.classList.add('hidden');
            practiceScreen.classList.remove('hidden');
            certificateScreen.classList.add('hidden');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                phaseIndicator.textContent = "Topic Complete!";
                questionText.textContent = "You've finished this topic. Well done!";
                completedTopics[currentQuestions.topicName] = true;
                saveProgress();
                checkAllTopicsCompleted();
                resetRecordingUI();
                nextBtn.classList.add('hidden');
                speak("You've completed this topic! Well done.");
                return;
            }

            const item = currentQuestions[currentQuestionIndex];
            resetUIForNewQuestion();
            
            let fullQuestion = (item.intro ? item.intro + " " : "") + item.question;
            questionText.textContent = fullQuestion;
            questionText.classList.add('fade-in');
            setTimeout(() => questionText.classList.remove('fade-in'), 500);

            speak(fullQuestion);
            
            // Populate Sentence Starters
            if (item.starters && item.starters.length > 0) {
                startersList.innerHTML = '';
                item.starters.forEach(starter => {
                    const button = document.createElement('button');
                    button.className = 'bg-indigo-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-indigo-600 dark:text-white cursor-default';
                    button.textContent = starter;
                    startersList.appendChild(button);
                });
                startersContainer.classList.remove('hidden');
            }

            // Populate Word Bank
            if (item.wordBank && item.wordBank.length > 0) {
                wordBankList.innerHTML = '';
                item.wordBank.forEach(word => {
                    const button = document.createElement('button');
                    button.className = 'bg-green-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-green-600 dark:text-white cursor-default';
                    button.textContent = word;
                    wordBankList.appendChild(button);
                });
                wordBankContainer.classList.remove('hidden');
            }

            const responseTime = item.timer || DEFAULT_RESPONSE_TIME;
            phaseIndicator.textContent = `Prepare & Record (Question ${currentQuestionIndex + 1} of ${currentQuestions.length})`;
            startTimer(responseTime, showSampleAnswersAndStartReadTimer);
        }

        function showSampleAnswersAndStartReadTimer() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
            
            phaseIndicator.textContent = "Review";
            recordBtn.disabled = true;
            recordBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const item = currentQuestions[currentQuestionIndex];
            if (item.samples && item.samples.length > 0) {
                samplesList.innerHTML = '';
                item.samples.forEach(sample => {
                    const li = document.createElement('li');
                    li.textContent = sample;
                    // Changed to white text as requested
                    li.className = 'text-white text-sm sm:text-base';
                    samplesList.appendChild(li);
                });
                samplesContainer.classList.remove('hidden');
            }


            startTimer(READ_TIME, () => {
                phaseIndicator.textContent = "Time's up!";
                nextBtn.classList.remove('hidden');
            });
        }
        
        // --- Certificate Logic ---
        function checkAllTopicsCompleted() {
            const totalTopics = Object.keys(practiceData).length;
            const completedCount = Object.keys(completedTopics).length;
            if (completedCount === totalTopics) {
                showCertificate();
            }
        }
        
        function showCertificate() {
            practiceScreen.classList.add('hidden');
            welcomeScreen.classList.add('hidden');
            certificateScreen.classList.remove('hidden');
            document.getElementById('certificate-name').textContent = userName;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
        }
        
        function showErrorMessage(message) {
            errorMessagebox.textContent = message;
            errorMessagebox.classList.remove('hidden');
            setTimeout(() => {
                errorMessagebox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        // --- Recording & Transcription Logic ---
        async function startRecording() {
            if (!window.MediaRecorder) {
                showErrorMessage("Audio recording is not supported on this browser.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const isEdge = window.navigator.userAgent.includes("Edg");
                let options = {};
                if (!isEdge) {
                    const mimeTypes = ['audio/webm;codecs=opus', 'audio/ogg;codecs=opus', 'audio/webm', 'audio/ogg'];
                    const supportedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
                    if (supportedType) options.mimeType = supportedType;
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.start();
                startTranscription();

                recordBtn.classList.add('hidden');
                stopRecordBtn.classList.remove('hidden');
                recordingStatus.classList.remove('hidden');

                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    recordedBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedBlob);
                    audioPlayer.src = audioUrl;
                    postRecordingActions.classList.remove('hidden');
                    recordingStatus.classList.add('hidden');
                    stopRecordBtn.classList.add('hidden');
                    recordBtn.classList.add('hidden');
                });
            } catch (err) {
                console.error("Error starting recording:", err);
                showErrorMessage("Could not start audio recording. Please grant microphone permission.");
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
            if (speechRecognition) {
                speechRecognition.stop();
            }
        }

        function startTranscription() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("Speech recognition not supported.");
                return;
            }

            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';
            finalTranscript = '';

            speechRecognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
            };
            
            speechRecognition.onerror = (event) => {
                 console.error('Speech recognition error detected: ' + event.error);
            }

            speechRecognition.start();
        }

        // --- Timer Functions ---
        function startTimer(duration, onEndCallback) {
            let timeLeft = duration;
            clearInterval(timerInterval);
            updateTimerDisplay(timeLeft, duration);

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft, duration);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if(onEndCallback) onEndCallback();
                }
            }, 1000);
        }

        function updateTimerDisplay(timeLeft, totalDuration) {
            const minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            if (seconds < 10) seconds = `0${seconds}`;
            timerDisplay.textContent = `${minutes}:${seconds}`;
            
            const fraction = timeLeft / totalDuration;
            const offset = fraction * FULL_DASH_ARRAY;
            timerProgress.style.strokeDashoffset = FULL_DASH_ARRAY - offset;
        }

        // --- UI Helper Functions ---
        function resetUIForNewQuestion() {
            samplesContainer.classList.add('hidden');
            startersContainer.classList.add('hidden');
            wordBankContainer.classList.add('hidden');
            nextBtn.classList.add('hidden');
            errorMessagebox.classList.add('hidden');
            recordBtn.disabled = false;
            recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            resetRecordingUI();
        }

        function resetRecordingUI() {
            recordBtn.classList.remove('hidden');
            stopRecordBtn.classList.add('hidden');
            recordingStatus.classList.add('hidden');
            postRecordingActions.classList.add('hidden');
            audioPlayer.src = '';
            audioChunks = [];
            recordedBlob = null;
            finalTranscript = '';
        }

        // --- Theme Toggle Logic ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        };
        
        // --- Snowfall Logic ---
        function createSnow() {
            const snowContainer = document.getElementById('snow-container');
            const snowflakeCount = 50;
            for (let i = 0; i < snowflakeCount; i++) {
                let snowflake = document.createElement('div');
                snowflake.innerHTML = '❄';
                snowflake.classList.add('snowflake');
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.animationDuration = Math.random() * 5 + 5 + 's'; // 5-10 seconds
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                snowflake.style.fontSize = Math.random() * 1.5 + 0.5 + 'em';
                snowflake.style.opacity = Math.random();
                snowContainer.appendChild(snowflake);
            }
        }


        // --- Event Listeners ---
        startWithNameBtn.addEventListener('click', () => {
            userName = nameInput.value.trim();
            if (userName) {
                saveProgress();
                nameEntryContainer.classList.add('hidden');
                userNameDisplay.textContent = userName;
                topicSelectionContainer.classList.remove('hidden');
            } else {
                // Using a custom message box instead of alert()
                const nameError = document.createElement('div');
                nameError.textContent = "Please enter your name.";
                nameError.className = "text-red-500 text-sm mt-2";
                startWithNameBtn.insertAdjacentElement('afterend', nameError);
                setTimeout(() => nameError.remove(), 2000);
            }
        });

        recordBtn.addEventListener('click', startRecording);
        stopRecordBtn.addEventListener('click', stopRecording);
        
        downloadCertificateBtn.addEventListener('click', () => {
            const certificateNode = document.getElementById('certificate-to-download');
            html2canvas(certificateNode, { scale: 2 }).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = `Certificate_of_Completion_${userName.replace(/\s+/g, '_')}.png`;
                a.click();
            });
        });

        backToMainMenuBtn.addEventListener('click', () => {
            certificateScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            initializeTopics();
        });

        downloadBtn.addEventListener('click', () => {
            if (recordedBlob) {
                const topicName = currentQuestions.topicName.replace(/\s+/g, '_');
                const sanitizedUserName = userName.replace(/\s+/g, '_');
                const fileName = `${sanitizedUserName}_${topicName}_Q${currentQuestionIndex + 1}.webm`;
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = URL.createObjectURL(recordedBlob);
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // Visual feedback
                const originalText = downloadBtn.innerHTML;
                downloadBtn.innerHTML = `<i class="fas fa-check mr-1"></i>Downloaded!`;
                downloadBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                downloadBtn.classList.add('bg-green-600');
                setTimeout(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.classList.remove('bg-green-600');
                    downloadBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
            }
        });

        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            showQuestion();
        });

        backToTopicsBtn.addEventListener('click', () => {
            practiceScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            clearInterval(timerInterval);
            initializeTopics();
        });
        
        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
            applyTheme(isDark ? 'dark' : 'light');
        });

        // --- Initial Load ---
        async function main() {
            // Set initial theme
            const savedTheme = localStorage.getItem('color-theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                // If no theme saved, use system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    applyTheme('dark');
                } else {
                    applyTheme('light');
                }
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !SpeechRecognition) {
                recordBtn.disabled = true;
                recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                recordBtn.title = "Audio recording or recognition is not supported on this browser.";
            }
            if (!window.speechSynthesis) {
                 console.warn("Text-to-speech is not supported on this browser.");
            }
            
            await initializeTTS().catch(err => console.error(err));
            
            createSnow();
            loadProgress();
            initializeTopics();
        }
        
        main();
    });
    </script>
</body>
</html>
