<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Classroom Quiz Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            animation: backgroundShift 30s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0% { background: linear-gradient(45deg, #556cd6 0%, #5a3f8f 100%); }
            25% { background: linear-gradient(45deg, #e080e8 0%, #e04560 100%); }
            50% { background: linear-gradient(45deg, #2f8ed6 0%, #008fbf 100%); }
            75% { background: linear-gradient(45deg, #2fa15f 0%, #1f8f8f 100%); }
            100% { background: linear-gradient(45deg, #556cd6 0%, #5a3f8f 100%); }
        }

        .laser-beam {
            position: absolute;
            width: 4px;
            height: 200px;
            background: linear-gradient(to bottom, transparent, #00ffff, transparent);
            animation: laserMove 3s linear infinite;
            opacity: 0.7;
        }

        @keyframes laserMove {
            0% { transform: translateX(-100px) translateY(-100px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(calc(100vw + 100px)) translateY(100vh); opacity: 0; }
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .top-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .progress-section {
            flex: 1;
            margin: 0 20px;
        }

        .progress-bar {
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            overflow: hidden;
            position: relative;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb);
            border-radius: 25px;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-emoji {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            animation: bounce 0.5s ease-in-out infinite alternate;
        }

        @keyframes bounce {
            0% { transform: translateY(-50%) scale(1); }
            100% { transform: translateY(-50%) scale(1.2); }
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            background: linear-gradient(145deg, #d64545, #a83232);
            border: none;
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .players-section {
            display: none;
        }

        .player-name {
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            color: white;
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .player-score {
            font-size: 16px;
            font-weight: 600;
            color: #ffd700;
            margin-top: 5px;
        }

        .question-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .question-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .question-instruction {
            font-size: 20px;
            color: #666;
            margin-bottom: 20px;
        }

        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .audio-btn {
            background: linear-gradient(145deg, #2f8ed6, #008fbf);
            border: none;
            border-radius: 15px;
            padding: 15px 25px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .audio-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .audio-btn:disabled {
            background: linear-gradient(145deg, #ccc, #999);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .streak-indicator {
            position: absolute;
            top: 130px;
            right: 20px;
            background: linear-gradient(145deg, #FFD700, #FFA000);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
            animation: streakGlow 1s ease-in-out infinite alternate;
        }

        @keyframes streakGlow {
            0% { box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3); }
            100% { box-shadow: 0 5px 15px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.5); }
        }

        .game-area {
            display: flex;
            flex: 1;
            gap: 20px;
            align-items: stretch;
        }

        .choices-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
        }

        .choice-button {
            background: linear-gradient(145deg, #4a5fd1, #5a3f8f);
            border: none;
            border-radius: 15px;
            padding: 20px;
            font-size: 20px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .choice-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
        }

        .choice-button:active {
            transform: translateY(-1px) scale(0.98);
        }

        .choice-button.correct {
            animation: correctAnswer 4s ease-in-out;
            background: linear-gradient(145deg, #2fa15f, #1f8f8f);
        }

        .choice-button.incorrect {
            animation: incorrectAnswer 2s ease-in-out;
            background: linear-gradient(145deg, #d64545, #a83232);
        }

        @keyframes correctAnswer {
            0% { 
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                transform: scale(1);
            }
            10% { 
                box-shadow: 0 0 60px #ffd700, 0 0 120px #ffd700;
                transform: scale(1.15) rotate(5deg);
            }
            20% { 
                box-shadow: 0 0 80px #ff69b4, 0 0 140px #ff69b4;
                transform: scale(1.2) rotate(-3deg);
            }
            30% { 
                box-shadow: 0 0 100px #00ffff, 0 0 160px #00ffff;
                transform: scale(1.1) rotate(2deg);
            }
            40% { 
                box-shadow: 0 0 90px #ff4757, 0 0 150px #ff4757;
                transform: scale(1.18) rotate(-4deg);
            }
            50% { 
                box-shadow: 0 0 110px #7bed9f, 0 0 170px #7bed9f;
                transform: scale(1.25) rotate(1deg);
            }
            60% { 
                box-shadow: 0 0 80px #ffd700, 0 0 130px #ffd700;
                transform: scale(1.1) rotate(-2deg);
            }
            70% { 
                box-shadow: 0 0 70px #ff69b4, 0 0 120px #ff69b4;
                transform: scale(1.15) rotate(3deg);
            }
            80% { 
                box-shadow: 0 0 60px #00ffff, 0 0 110px #00ffff;
                transform: scale(1.05) rotate(-1deg);
            }
            90% { 
                box-shadow: 0 0 40px #43e97b, 0 0 80px #43e97b;
                transform: scale(1.08);
            }
            100% { 
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                transform: scale(1);
            }
        }

        @keyframes incorrectAnswer {
            0% { 
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                transform: scale(1);
            }
            15% { 
                box-shadow: 0 0 40px #ff4757, 0 0 80px #ff4757;
                transform: scale(0.95) rotate(-5deg);
            }
            30% { 
                box-shadow: 0 0 60px #ff6b6b, 0 0 100px #ff6b6b;
                transform: scale(0.9) rotate(5deg);
            }
            45% { 
                box-shadow: 0 0 50px #ee5a52, 0 0 90px #ee5a52;
                transform: scale(0.95) rotate(-3deg);
            }
            60% { 
                box-shadow: 0 0 40px #ff4757, 0 0 70px #ff4757;
                transform: scale(0.92) rotate(2deg);
            }
            75% { 
                box-shadow: 0 0 30px #ff6b6b, 0 0 60px #ff6b6b;
                transform: scale(0.96) rotate(-1deg);
            }
            100% { 
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                transform: scale(1);
                opacity: 0.7;
            }
        }

        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            animation: sparkle 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes sparkle {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(0) rotate(360deg);
            }
        }

        .glitter {
            position: absolute;
            width: 8px;
            height: 8px;
            background: linear-gradient(45deg, #ff69b4, #00ffff, #ffd700, #ff4757);
            border-radius: 50%;
            animation: glitterFloat 2s ease-out forwards;
            pointer-events: none;
        }

        @keyframes glitterFloat {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg);
            }
            25% {
                opacity: 1;
                transform: scale(1.5) rotate(90deg);
            }
            50% {
                opacity: 0.8;
                transform: scale(1) rotate(180deg);
            }
            75% {
                opacity: 0.6;
                transform: scale(1.2) rotate(270deg);
            }
            100% {
                opacity: 0;
                transform: scale(0) rotate(360deg);
            }
        }

        .token {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border-radius: 50%;
            border: 2px solid #ff6b6b;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: tokenFly 2s ease-out forwards;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes tokenFly {
            0% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.3) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) rotate(360deg);
            }
        }

        .leaderboard {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            font-size: 24px;
            color: #333;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        .learning-phase {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 60px;
            border-radius: 30px;
            text-align: center;
            font-size: 48px;
            color: #333;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        .name-shuffle {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 60px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            width: 80%;
            max-width: 800px;
        }

        .shuffle-title {
            font-size: 36px;
            font-weight: 700;
            color: #333;
            margin-bottom: 30px;
        }

        .shuffle-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            min-height: 200px;
            align-items: center;
        }

        .shuffle-name {
            padding: 15px 20px;
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            animation: nameFloat 0.8s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        @keyframes nameFloat {
            0% { transform: translateY(0px) rotate(0deg) scale(1); }
            50% { transform: translateY(-15px) rotate(5deg) scale(1.05); }
            100% { transform: translateY(0px) rotate(0deg) scale(1); }
        }

        .shuffle-name.selected {
            background: linear-gradient(145deg, #43e97b, #38f9d7);
            animation: selectedPulse 1s ease-in-out infinite;
            transform: scale(1.2);
        }

        @keyframes selectedPulse {
            0% { box-shadow: 0 0 20px #43e97b; }
            50% { box-shadow: 0 0 40px #43e97b, 0 0 60px #38f9d7; }
            100% { box-shadow: 0 0 20px #43e97b; }
        }

        .selected-players {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .selected-player {
            background: linear-gradient(145deg, #f093fb, #f5576c);
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 20px;
            font-weight: 700;
            animation: finalSelection 2s ease-in-out infinite;
        }

        @keyframes finalSelection {
            0% { transform: scale(1); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
            50% { transform: scale(1.1); box-shadow: 0 10px 30px rgba(240, 147, 251, 0.5); }
            100% { transform: scale(1); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        }

        .round-info-display {
            color: white;
            font-size: 20px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            white-space: nowrap;
        }

        .fireworks {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ffd700;
            border-radius: 50%;
            animation: firework 2s ease-out forwards;
            pointer-events: none;
        }

        @keyframes firework {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(3);
                background: #ff69b4;
            }
            100% {
                opacity: 0;
                transform: scale(0);
                background: #00ffff;
            }
        }

        .floating-emoji {
            position: absolute;
            font-size: 24px;
            animation: floatEmoji 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 5;
            opacity: 0.8;
        }

        @keyframes floatEmoji {
            0% {
                transform: translateY(100vh) rotate(0deg) scale(0.8);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) rotate(360deg) scale(1.2);
                opacity: 0;
            }
        }

        .winner-firework {
            position: absolute;
            width: 8px;
            height: 8px;
            background: linear-gradient(45deg, #ffd700, #ff69b4, #00ffff, #ff4757);
            border-radius: 50%;
            animation: winnerFirework 3s ease-out forwards;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes winnerFirework {
            0% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
                box-shadow: 0 0 20px #ffd700;
            }
            25% {
                opacity: 1;
                transform: scale(4) rotate(90deg);
                box-shadow: 0 0 40px #ff69b4;
            }
            50% {
                opacity: 1;
                transform: scale(6) rotate(180deg);
                box-shadow: 0 0 60px #00ffff;
            }
            75% {
                opacity: 0.8;
                transform: scale(8) rotate(270deg);
                box-shadow: 0 0 80px #ff4757;
            }
            100% {
                opacity: 0;
                transform: scale(0) rotate(360deg);
                box-shadow: 0 0 100px #ffd700;
            }
        }

        .celebration-burst {
            position: absolute;
            font-size: 48px;
            animation: celebrationBurst 2s ease-out forwards;
            pointer-events: none;
            z-index: 1001;
        }

        @keyframes celebrationBurst {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.5) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) rotate(360deg);
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) rotate(360deg);
            }
        }

        .main-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .menu-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 60px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: menuFloat 3s ease-in-out infinite alternate;
        }

        @keyframes menuFloat {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-10px); }
        }

        .menu-title {
            font-size: 48px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .menu-subtitle {
            font-size: 28px;
            font-weight: 600;
            color: #666;
            margin-bottom: 40px;
        }

        .grade-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .grade-btn {
            background: linear-gradient(145deg, #4a5fd1, #5a3f8f);
            border: none;
            border-radius: 20px;
            padding: 25px 40px;
            font-size: 24px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .grade-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            background: linear-gradient(145deg, #5a6fe8, #6b4fa5);
        }

        .grade-btn:active {
            transform: translateY(-2px) scale(0.98);
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div class="main-menu" id="mainMenu">
        <div class="menu-container">
            <h1 class="menu-title">🎧 English Listening Quiz</h1>
            <h2 class="menu-subtitle">Select Your Grade</h2>
            <div class="grade-buttons">
                <button class="grade-btn" onclick="selectGrade(10)">Grade 10</button>
                <button class="grade-btn" onclick="selectGrade(11)">Grade 11</button>
                <button class="grade-btn" onclick="selectGrade(12)">Grade 12</button>
            </div>
        </div>
    </div>

    <div class="game-container" id="gameContainer" style="display: none;">
        <!-- Streak Indicator -->
        <div class="streak-indicator" id="streakIndicator">
            🔥 Streak: <span id="streakCount">0</span>
        </div>

        <div class="top-section">
            <div class="control-buttons">
                <button class="control-btn" onclick="backToMenu()">🏠 Menu</button>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">
                        <div class="progress-emoji" id="progressEmoji">⏰</div>
                    </div>
                </div>
            </div>
            <div class="round-info-display">
                R: <span id="currentRound">1</span>/8 | Q: <span id="currentQuestion">1</span>/10
            </div>
        </div>

        <div class="question-section" style="display: none;">
            <div class="question-title" id="questionTitle"></div>
        </div>

        <div class="game-area">
            <div class="choices-column">
                <div class="player-name" id="player1">
                    Player 1
                    <div class="player-score" id="score1">0 points</div>
                </div>
                <button class="choice-button" onclick="selectAnswer(0)">2:15 PM</button>
                <button class="choice-button" onclick="selectAnswer(1)">2:45 PM</button>
                <button class="choice-button" onclick="selectAnswer(2)">3:10 PM</button>
                <button class="choice-button" onclick="selectAnswer(3)">3:50 PM</button>
            </div>

            <div class="choices-column">
                <div class="player-name" id="player2">
                    Player 2
                    <div class="player-score" id="score2">0 points</div>
                </div>
                <button class="choice-button" onclick="selectAnswer(4)">4:15 PM</button>
                <button class="choice-button" onclick="selectAnswer(5)">4:45 PM</button>
                <button class="choice-button" onclick="selectAnswer(6)">5:10 PM</button>
                <button class="choice-button" onclick="selectAnswer(7)">5:50 PM</button>
            </div>

            <div class="choices-column">
                <div class="player-name" id="player3">
                    Player 3
                    <div class="player-score" id="score3">0 points</div>
                </div>
                <button class="choice-button" onclick="selectAnswer(8)">6:15 PM</button>
                <button class="choice-button" onclick="selectAnswer(9)">6:45 PM</button>
                <button class="choice-button" onclick="selectAnswer(10)">7:10 PM</button>
                <button class="choice-button" onclick="selectAnswer(11)">7:50 PM</button>
            </div>
        </div>
    </div>

    <div class="leaderboard" id="leaderboard">
        <h2>🏆 Round Complete! 🏆</h2>
        <div id="leaderboardContent"></div>
        <div id="globalLeaderboardContent" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
            <h3>🌟 Global Leaderboard 🌟</h3>
            <div id="globalScores"></div>
        </div>
        <div style="margin-top: 20px; font-size: 16px; color: #666;">Next round starting automatically in 5 seconds...</div>
    </div>

    <div class="learning-phase" id="learningPhase">
        <div id="learningContent"></div>
    </div>

    <div class="name-shuffle" id="nameShuffle">
        <h2 class="shuffle-title">Selecting Players...</h2>
        <div class="shuffle-container" id="shuffleContainer"></div>
        <div class="selected-players" id="selectedPlayers"></div>
    </div>

    <script>
        // ========================================
        // 📚 STUDENT NAMES SECTION - DRAG & DROP TO REPLACE
        // ========================================
        const studentsByGrade = {
            10: [
                "冯奕尘 / FENG, YICHEN", "黄若涵 / HUANG, RUOHAN", "李丰屹 / LI, FENGYI", 
                "李鹏潞 / LI, PENGLU", "梁锦天 / LING, JINTIAN", "刘景扬 / LIU, JINGYANG",
                "龙俊志 / LONG, JUNZHI", "马赫 / MA, HE", "聂溪康 / NIE, XIKANG",
                "庞云蔚 / PANG, YUNWEI", "曲家瑞 / QU, JIARUI", "孙诗童 / SUN, SHITONG",
                "王子言 / WANG, ZIYAN", "杨晴珺 / YANG, QINGJUN", "张宸恺 / ZHANG, CHENKAI",
                "赵浩文 / ZHAO, HAOWEN", "徐浚洹 / JUN, HUANXU"
                // ADD NEW GRADE 10 STUDENTS HERE - FORMAT: "中文名 / ENGLISH NAME"
            ],
            11: [
                "陈峻弘 / CHEN, JUNHONG", "韩睿雄 / HAN, RUIXIONG", "何怡敏 / HE, YIMIN",
                "康艺芸 / KANG, YIYUN", "李雨霏 / LI, YUFEI", "李沾衣 / LI, ZHANYI",
                "刘圃言 / LIU, PUYAN", "庞泽霖 / PANG, ZELIN", "王梓晗 / WANG, ZIHAN",
                "尹九思 / YIN, JIUSI", "游项雯 / YOU, XIANGWEN", "于浚哲 / YU, JUNZHE",
                "臧姝婷 / ZANG, SHUTING", "张澜馨 / ZHANG, LANXIN"
                // ADD NEW GRADE 11 STUDENTS HERE - FORMAT: "中文名 / ENGLISH NAME"
            ],
            12: [
                "安政聿 / AN, ZHENGYU", "蔡子墨 / CAI, ZIMO", "刘镇榕 / LIU, ZHENRONG",
                "马知行 / MA, ZHIXING", "邱天 / QIU, TIAN", "盛思语 / SHENG, SIYU",
                "唐可盈 / TANG, KEYING", "田子凡 / TIAN, ZIFAN", "谢斯飞 / XIE, SIFEI",
                "杨加麒 / YANG, JIAQI", "张程皓 / ZHANG, CHENGHAO", "赵晨达鑫 / ZHAO, CHENDAXIN",
                "周逸凡 / ZHOU, YIFAN"
                // ADD NEW GRADE 12 STUDENTS HERE - FORMAT: "中文名 / ENGLISH NAME"
            ]
        };

        // ========================================
        // 🎯 QUESTION DATABASE - DRAG & DROP TO REPLACE
        // ========================================
        
        // EASY QUESTIONS (Questions 1-3) - Simple times, clear contexts
        const easyTimeExpressions = [
            { 
                time: "9:00 AM", 
                display: "9:00 AM",
                color: "#4CAF50",
                spoken: "nine o'clock", 
                alternatives: ["nine", "nine sharp"],
                category: "daily_routine"
            },
            { 
                time: "12:00 PM", 
                display: "12:00 PM",
                color: "#FF9800",
                spoken: "twelve noon", 
                alternatives: ["midday", "twelve o'clock"],
                category: "daily_routine"
            },
            { 
                time: "6:00 PM", 
                display: "6:00 PM",
                color: "#9C27B0",
                spoken: "six o'clock", 
                alternatives: ["six", "six sharp"],
                category: "daily_routine"
            },
            { 
                time: "8:30 AM", 
                display: "8:30 AM",
                color: "#2196F3",
                spoken: "half past eight", 
                alternatives: ["eight thirty", "thirty past eight"],
                category: "schedule"
            },
            { 
                time: "1:30 PM", 
                display: "1:30 PM",
                color: "#FF5722",
                spoken: "half past one", 
                alternatives: ["one thirty", "thirty past one"],
                category: "appointment"
            },
            { 
                time: "7:30 PM", 
                display: "7:30 PM",
                color: "#795548",
                spoken: "half past seven", 
                alternatives: ["seven thirty", "thirty past seven"],
                category: "daily_routine"
            }
        ];

        // MEDIUM QUESTIONS (Questions 4-7) - Quarter hours and specific minutes
        const mediumTimeExpressions = [
            { 
                time: "2:15 PM", 
                display: "2:15 PM",
                color: "#E91E63",
                spoken: "quarter past two", 
                alternatives: ["two fifteen", "fifteen past two"],
                category: "appointment"
            },
            { 
                time: "4:45 PM", 
                display: "4:45 PM",
                color: "#673AB7",
                spoken: "quarter to five", 
                alternatives: ["four forty-five", "fifteen to five"],
                category: "schedule"
            },
            { 
                time: "10:15 AM", 
                display: "10:15 AM",
                color: "#009688",
                spoken: "quarter past ten", 
                alternatives: ["ten fifteen", "fifteen past ten"],
                category: "daily_routine"
            },
            { 
                time: "3:45 PM", 
                display: "3:45 PM",
                color: "#FF6B35",
                spoken: "quarter to four", 
                alternatives: ["three forty-five", "fifteen to four"],
                category: "appointment"
            },
            { 
                time: "11:20 AM", 
                display: "11:20 AM",
                color: "#8BC34A",
                spoken: "twenty past eleven", 
                alternatives: ["eleven twenty", "twenty after eleven"],
                category: "schedule"
            },
            { 
                time: "5:40 PM", 
                display: "5:40 PM",
                color: "#FFC107",
                spoken: "twenty to six", 
                alternatives: ["five forty", "twenty before six"],
                category: "daily_routine"
            }
        ];

        // HARD QUESTIONS (Questions 8-10) - Complex times and tricky contexts
        const hardTimeExpressions = [
            { 
                time: "3:07 AM", 
                display: "3:07 AM",
                color: "#607D8B",
                spoken: "seven minutes past three", 
                alternatives: ["three oh seven", "seven after three"],
                category: "appointment"
            },
            { 
                time: "11:53 PM", 
                display: "11:53 PM",
                color: "#9E9E9E",
                spoken: "seven minutes to twelve", 
                alternatives: ["eleven fifty-three", "seven before midnight"],
                category: "schedule"
            },
            { 
                time: "6:22 AM", 
                display: "6:22 AM",
                color: "#FF4081",
                spoken: "twenty-two minutes past six", 
                alternatives: ["six twenty-two", "twenty-two after six"],
                category: "daily_routine"
            },
            { 
                time: "9:38 PM", 
                display: "9:38 PM",
                color: "#536DFE",
                spoken: "twenty-two minutes to ten", 
                alternatives: ["nine thirty-eight", "twenty-two before ten"],
                category: "appointment"
            },
            { 
                time: "4:13 PM", 
                display: "4:13 PM",
                color: "#1DE9B6",
                spoken: "thirteen minutes past four", 
                alternatives: ["four thirteen", "thirteen after four"],
                category: "schedule"
            },
            { 
                time: "8:47 AM", 
                display: "8:47 AM",
                color: "#FF6D00",
                spoken: "thirteen minutes to nine", 
                alternatives: ["eight forty-seven", "thirteen before nine"],
                category: "daily_routine"
            }
        ];

        // ========================================
        // 📝 CONVERSATION TEMPLATES - DRAG & DROP TO REPLACE
        // ========================================
        
        const conversationTemplates = {
            // EASY CONVERSATIONS - Simple, direct
            easy: {
                daily_routine: [
                    "I wake up at {time} every morning. My alarm goes off at {time} sharp.",
                    "Breakfast is served at {time}. The dining hall opens at {time}.",
                    "School starts at {time}. Don't be late! Classes begin at {time}.",
                    "I go to bed at {time}. Lights out at {time} every night."
                ],
                schedule: [
                    "The meeting is at {time}. Please arrive by {time}.",
                    "The bus leaves at {time}. Departure time is {time}.",
                    "The movie starts at {time}. Show time is {time}.",
                    "The store opens at {time}. Opening time is {time}."
                ],
                appointment: [
                    "Your appointment is at {time}. See you at {time}.",
                    "The doctor will see you at {time}. Your slot is {time}.",
                    "Let's meet at {time}. I'll be there at {time}.",
                    "The interview is scheduled for {time}. Please come at {time}."
                ]
            },
            
            // MEDIUM CONVERSATIONS - More context, some distractors
            medium: {
                appointment: [
                    "Can we meet at {distractor1}? Actually, I have a conflict. How about {time}? Yes, {time} works perfectly!",
                    "I thought our appointment was at {distractor1}, but I checked my calendar and it's actually {time}. So {time} it is!",
                    "The original time was {distractor1}, but we moved it to {time}. The new time is {time}."
                ],
                schedule: [
                    "The train usually leaves at {distractor1}, but today it departs at {time}. Make sure you're there by {time}.",
                    "Class was supposed to start at {distractor1}, but it's been changed to {time}. New start time is {time}.",
                    "The event begins at {time}. Not {distractor1} like last week, but {time} today."
                ],
                daily_routine: [
                    "I used to have lunch at {distractor1}, but now I eat at {time}. My new lunch time is {time}.",
                    "The gym closes at {distractor1} on weekdays, but today it closes at {time}. So we need to finish by {time}.",
                    "My work schedule changed from {distractor1} to {time}. I now start at {time}."
                ]
            },
            
            // HARD CONVERSATIONS - Complex contexts, multiple distractors
            hard: {
                appointment: [
                    "The appointment was moved from {distractor1} to {distractor2}, then finally to {time}. So the confirmed time is {time}.",
                    "I suggested {distractor1}, but that doesn't work. Then we tried {distractor2}, but that's also busy. Let's do {time} instead. {time} is perfect.",
                    "Originally it was {distractor1}, then we changed it to {distractor2}, but now it's definitely {time}. Final time: {time}."
                ],
                schedule: [
                    "The conference call was at {distractor1} yesterday, {distractor2} last week, but today it's at {time}. Today's time is {time}.",
                    "Flight departures: Gate A at {distractor1}, Gate B at {distractor2}, but our Gate C flight leaves at {time}. Our departure is {time}.",
                    "Morning shift starts at {distractor1}, afternoon at {distractor2}, but night shift begins at {time}. Night shift time: {time}."
                ],
                daily_routine: [
                    "Breakfast is from {distractor1} to {distractor2}, but today it starts early at {time}. Today's breakfast time: {time}.",
                    "The library opens at {distractor1} on weekdays, {distractor2} on weekends, but today it opens at {time}. Today's opening: {time}.",
                    "Regular hours are {distractor1} to {distractor2}, but today we're open from {time}. Today we start at {time}."
                ]
            }
        };

        // ======= STATE =======
        let currentGrade = null;
        let studentNames = [];
        let currentRound = 1;
        let currentQuestion = 1;
        let currentPlayers = [];
        let usedPlayers = [];
        let playerScores = {};
        let globalLeaderboard = {};
        let playerStreaks = {};
        let timeLeft = 15;
        let gameActive = false;
        let currentQuestionData = null;
        let questionInterval = null;
        let timers = new Set();
        let cachedVoices = [];
        let voicesReady = false;
        let currentVoiceIndex = 0;

        const voiceNames = [
          'Microsoft Ava Online (Natural) - English (United States)',
          'Microsoft Brian Online (Natural) - English (United States)',
          'Microsoft William Online (Natural) - English (United States)',
          'Microsoft Andrew Online (Natural) - English (United States)',
          'Microsoft Emma Online (Natural) - English (United States)'
        ];

        // ======= TIMER & SPEECH HELPERS (FIXED) =======
        function clearTimer(ref) {
          if (!ref) return;
          if (ref._type === 'interval') clearInterval(ref.id);
          else clearTimeout(ref.id);
          timers.delete(ref);
        }

        function makeInterval(fn, ms) {
          const id = setInterval(fn, ms);
          const ref = { id, _type: 'interval' };
          timers.add(ref);
          return ref;
        }

        function makeTimeout(fn, ms) {
          const id = setTimeout(fn, ms);
          const ref = { id, _type: 'timeout' };
          timers.add(ref);
          return ref;
        }

        function stopAllSpeech() {
          if ('speechSynthesis' in window) {
            speechSynthesis.cancel();
          }
        }

        function ensureVoicesReady() {
          return new Promise(resolve => {
            if (voicesReady) return resolve(cachedVoices);

            const load = () => {
              cachedVoices = speechSynthesis.getVoices();
              if (cachedVoices && cachedVoices.length > 0) {
                voicesReady = true;
                resolve(cachedVoices);
              }
            };
            
            const existing = speechSynthesis.getVoices();
            if (existing && existing.length > 0) {
              cachedVoices = existing;
              voicesReady = true;
              resolve(cachedVoices);
            } else {
              window.speechSynthesis.onvoiceschanged = () => load();
              // A trick to trigger voice loading on some browsers
              try {
                const u = new SpeechSynthesisUtterance('');
                speechSynthesis.speak(u);
                speechSynthesis.cancel();
              } catch {}
              makeTimeout(load, 1000); // Failsafe
            }
          });
        }

        function speakOnce(text, { lang = 'en-US', rate = 0.85, pitch = 1, voicePref = null } = {}) {
            return new Promise(async (resolve) => {
                if (!('speechSynthesis' in window) || !text) {
                    console.warn("Speech synthesis not supported or text is empty.");
                    return resolve();
                }

                await ensureVoicesReady();
                stopAllSpeech(); 
                
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.rate = rate;
                u.pitch = pitch;

                if (cachedVoices.length > 0) {
                    let selectedVoice;
                    if (lang === 'zh-CN') {
                        selectedVoice = cachedVoices.find(v => v.lang === 'zh-CN');
                    } else {
                         selectedVoice = cachedVoices.find(v =>
                            v.name === voiceNames[currentVoiceIndex] ||
                            v.name.includes('Ava') ||
                            v.name.includes('Brian') ||
                            v.name.includes('William') ||
                            v.name.includes('Andrew') ||
                            v.name.includes('Emma')
                        ) || cachedVoices.find(v => v.lang.startsWith('en')) || cachedVoices[0];
                    }
                    if (selectedVoice) u.voice = selectedVoice;
                }
                
                u.onend = () => resolve();
                u.onerror = (e) => {
                    console.error("SpeechSynthesis Error:", e);
                    resolve(); // Resolve anyway to not block the game
                };
                
                speechSynthesis.speak(u);
                if (lang.startsWith('en')) {
                    currentVoiceIndex = (currentVoiceIndex + 1) % voiceNames.length;
                }
            });
        }
        
        function speak(text) { return speakOnce(text, { lang: 'en-US', rate: 0.85, pitch: 1 }); }
        function speakChinese(text) { return speakOnce(text, { lang: 'zh-CN', rate: 0.8, pitch: 1 }); }

        function playAudio() {
            if (!currentQuestionData) return Promise.resolve();
            return speakOnce(currentQuestionData.script);
        }

        // ======= TIMER (FIXED) =======
        function startTimer() {
            const progressFill = document.getElementById('progressFill');
            const progressEmoji = document.getElementById('progressEmoji');
            if (questionInterval) clearTimer(questionInterval);

            timeLeft = 15;
            progressFill.style.width = '100%';
            progressEmoji.textContent = '⏰';

            questionInterval = makeInterval(() => {
                timeLeft--;
                const percentage = (timeLeft / 15) * 100;
                progressFill.style.width = percentage + '%';

                if (timeLeft > 10) progressEmoji.textContent = '⏰';
                else if (timeLeft > 5) progressEmoji.textContent = '⚠️';
                else progressEmoji.textContent = '🚨';

                if (timeLeft <= 5 && timeLeft > 0) { playTickSound(); }

                if (timeLeft <= 0) {
                    clearTimer(questionInterval);
                    questionInterval = null;
                    stopAllSpeech();
                    playBuzzerSound();
                    timeUp();
                }
            }, 1000);
        }

        // ======= GAME FLOW (FIXED) =======
        async function startNewQuestion() {
            if (currentQuestion > 10) {
                endRound();
                return;
            }

            stopAllSpeech();
            if (questionInterval) {
                clearTimer(questionInterval);
                questionInterval = null;
            }

            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => {
                button.disabled = false;
                button.classList.remove('correct', 'incorrect');
                button.style.opacity = '1';
            });

            gameActive = true;
            timeLeft = 15;
            currentQuestionData = generateQuestion();
            document.getElementById('currentQuestion').textContent = currentQuestion;
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressEmoji').textContent = '⏰';

            updateStreakDisplay();
            startTimer();
            
            // Only play audio if the timer is still running
            if (gameActive) {
                await playAudio();
            }
        }

        async function selectAnswer(choiceIndex) {
            if (!gameActive || !currentQuestionData) return;
            
            gameActive = false;
            if (questionInterval) {
                clearTimer(questionInterval);
                questionInterval = null;
            }
            stopAllSpeech();

            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => button.disabled = true);

            // --- [Start of Original Logic] ---
            let answeringPlayer;
            let selectedChoice;
            
            if (choiceIndex >= 0 && choiceIndex <= 3) {
                answeringPlayer = currentPlayers[0];
                selectedChoice = currentQuestionData.player1Choices[choiceIndex];
            } else if (choiceIndex >= 4 && choiceIndex <= 7) {
                answeringPlayer = currentPlayers[1];
                selectedChoice = currentQuestionData.player2Choices[choiceIndex - 4];
            } else {
                answeringPlayer = currentPlayers[2];
                selectedChoice = currentQuestionData.player3Choices[choiceIndex - 8];
            }
            
            const isCorrect = selectedChoice.time === currentQuestionData.correctTime.time;
            
            buttons.forEach((button, index) => {
                const buttonText = button.querySelector('span') ? button.querySelector('span').textContent : button.textContent;
                if (buttonText === currentQuestionData.correctTime.display) {
                    button.classList.add('correct');
                    createFireworks(button);
                    createSparkles(button);
                } else if (index === choiceIndex) {
                    button.classList.add('incorrect');
                    createShakeEffect(button);
                }
            });
            
            if (!playerStreaks[answeringPlayer]) {
                playerStreaks[answeringPlayer] = 0;
            }
            
            if (isCorrect) {
                playerStreaks[answeringPlayer]++;
                let points = 10;
                let streakBonus = 0;
                if (playerStreaks[answeringPlayer] >= 3) {
                    streakBonus = Math.min(playerStreaks[answeringPlayer] * 2, 20);
                    points += streakBonus;
                }
                playerScores[answeringPlayer] += points;
                playCorrectSound();
                currentPlayers.forEach(player => {
                    if (player !== answeringPlayer) playerStreaks[player] = 0;
                });
                
                let announcement = `Excellent! Correct answer!`;
                if (streakBonus > 0) announcement += ` ${playerStreaks[answeringPlayer]} in a row! Streak bonus: ${streakBonus} points!`;
                await speak(announcement);
                
                let chineseAnnouncement = `${answeringPlayer.split(' / ')[0]}，答对了！加${points}分！`;
                if (streakBonus > 0) chineseAnnouncement += `连续${playerStreaks[answeringPlayer]}题正确！奖励${streakBonus}分！`;
                await speakChinese(chineseAnnouncement);

                createFlyingTokens(buttons[choiceIndex], getPlayerScoreElement(answeringPlayer), `+${points}`);
                if (streakBonus > 0) createStreakEffects(buttons[choiceIndex]);
            } else {
                playerStreaks[answeringPlayer] = 0;
                playerScores[answeringPlayer] -= 5;
                currentPlayers.forEach(player => {
                    if (player !== answeringPlayer) {
                        playerScores[player] += 5;
                        createFlyingTokens(buttons[choiceIndex], getPlayerScoreElement(player), '+5');
                    }
                });
                playWrongSound();
                
                await speak(`Sorry, that's incorrect.`);
                await speakChinese(`${answeringPlayer.split(' / ')[0]}，答错了。减五分，其他人加五分。`);
                 
                createFlyingTokens(buttons[choiceIndex], getPlayerScoreElement(answeringPlayer), '-5');
            }
            
            updatePlayerDisplay();
            updateStreakDisplay();
            // --- [End of Original Logic] ---
            
            makeTimeout(() => {
                currentQuestion++;
                startNewQuestion();
            }, 2000);
        }

        async function timeUp() {
            gameActive = false;
            if (!currentQuestionData) return;
            stopAllSpeech();

            // Reset all players' streaks on timeout
            currentPlayers.forEach(player => {
                playerStreaks[player] = 0;
            });
            
            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach((button) => {
                const buttonText = button.querySelector('span') ? button.querySelector('span').textContent : button.textContent;
                if (buttonText === currentQuestionData.correctTime.display) {
                    button.classList.add('correct');
                    createSparkles(button);
                }
                button.disabled = true;
            });

            await speakChinese(`时间到！正确答案是${currentQuestionData.correctTime.display}`);
            
            updatePlayerDisplay();
            updateStreakDisplay();

            makeTimeout(() => {
                currentQuestion++;
                startNewQuestion();
            }, 2000);
        }

        async function endRound() {
            stopAllSpeech();
            // --- [Original Logic for leaderboard] ---
            const leaderboard = document.getElementById('leaderboard');
            const content = document.getElementById('leaderboardContent');
            const globalContent = document.getElementById('globalScores');
            
            currentPlayers.forEach(player => {
                if (!globalLeaderboard[player]) globalLeaderboard[player] = 0;
                globalLeaderboard[player] += playerScores[player];
            });
            
            const sortedPlayers = [...currentPlayers].sort((a, b) => playerScores[b] - playerScores[a]);
            
            let leaderboardHTML = '<h3>Round Scores:</h3>';
            sortedPlayers.forEach((player, index) => {
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : '🥉';
                leaderboardHTML += `<div style="margin: 10px 0; font-size: 20px;">${medal} ${player.split(' / ')[0]}: ${playerScores[player]} points</div>`;
            });
            
            const globalSorted = Object.entries(globalLeaderboard).sort(([,a], [,b]) => b - a).slice(0, 10);
            
            let globalHTML = '';
            globalSorted.forEach(([player, score], index) => {
                const medal = index === 0 ? '👑' : index === 1 ? '🥇' : index === 2 ? '🥈' : index === 3 ? '🥉' : '⭐';
                globalHTML += `<div style="margin: 5px 0; font-size: 16px;">${medal} ${player.split(' / ')[0]}: ${score} total points</div>`;
            });
            
            content.innerHTML = leaderboardHTML;
            globalContent.innerHTML = globalHTML;
            leaderboard.style.display = 'block';
            
            const winner = sortedPlayers[0];
            const winnerChinese = winner.split(' / ')[0];
            const winnerScore = playerScores[winner];
            
            createWinnerFireworks();

            await speak(`Congratulations! Round winner!`);
            await speakChinese(`恭喜${winnerChinese}！本轮获胜！得分${winnerScore}分！`);
            // --- [End of Original Logic] ---
            
            makeTimeout(() => { nextRound(); }, 2000);
        }

        function nextRound() {
            stopAllSpeech();
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('streakIndicator').style.display = 'none';

            currentRound++;
            currentQuestion = 1;
            document.getElementById('currentRound').textContent = currentRound;

            Object.keys(playerScores).forEach(player => { playerScores[player] = 0; });
            Object.keys(playerStreaks).forEach(player => { playerStreaks[player] = 0; });

            selectNewPlayers();
        }

        // ======= ALL YOUR EXISTING EFFECTS, ANIMATIONS, AND OTHER FUNCTIONS ARE PRESERVED BELOW =======
        function initGame() {
            createLaserBeams();
            createFloatingEmojis();
        }

        function createFloatingEmojis() {
            const emojis = ['🎵', '🎶', '🎧', '🎤', '⭐', '✨', '🌟', '💫', '🎯', '🏆', '🎊', '🎉', '🔥', '💎', '🌈', '🎭', '🎪', '🎨', '🎲', '🎸', '🎺', '🎻', '🥇', '🏅', '👑', '💝', '🎁', '🌸', '🌺', '🌻', '🦋', '🐝', '🌙', '☀️', '⚡', '🔮'];
            
            setInterval(() => {
                const emoji = document.createElement('div');
                emoji.className = 'floating-emoji';
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emoji.style.left = Math.random() * window.innerWidth + 'px';
                emoji.style.animationDelay = Math.random() * 2 + 's';
                emoji.style.animationDuration = (6 + Math.random() * 4) + 's';
                document.body.appendChild(emoji);

                setTimeout(() => {
                    emoji.remove();
                }, 10000);
            }, 800);
        }
        // Grade selection
        function selectGrade(grade) {
            currentGrade = grade;
            studentNames = studentsByGrade[grade];
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            selectNewPlayers();
        }

        // Back to menu
        function backToMenu() {
            stopAllSpeech();
            if(questionInterval) clearTimer(questionInterval);
            
            gameActive = false;
            currentRound = 1;
            currentQuestion = 1;
            currentPlayers = [];
            usedPlayers = [];
            playerScores = {};
            playerStreaks = {};
            
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('learningPhase').style.display = 'none';
            document.getElementById('nameShuffle').style.display = 'none';
            document.getElementById('streakIndicator').style.display = 'none';
            
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
        }

        function createLaserBeams() {
            setInterval(() => {
                const laser = document.createElement('div');
                laser.className = 'laser-beam';
                laser.style.left = Math.random() * window.innerWidth + 'px';
                laser.style.top = Math.random() * window.innerHeight + 'px';
                laser.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(laser);

                setTimeout(() => {
                    laser.remove();
                }, 3000);
            }, 1000);
        }

        function generateQuestion() {
            let difficulty, timePool, templatePool;
            
            if (currentQuestion <= 3) {
                difficulty = 'easy';
                timePool = easyTimeExpressions;
                templatePool = conversationTemplates.easy;
            } else if (currentQuestion <= 7) {
                difficulty = 'medium';
                timePool = mediumTimeExpressions;
                templatePool = conversationTemplates.medium;
            } else {
                difficulty = 'hard';
                timePool = hardTimeExpressions;
                templatePool = conversationTemplates.hard;
            }
            
            const correctTime = timePool[Math.floor(Math.random() * timePool.length)];
            
            // Get all possible times for distractors (from all pools)
            const allTimes = [...easyTimeExpressions, ...mediumTimeExpressions, ...hardTimeExpressions];
            const distractorTimes = allTimes.filter(t => t.time !== correctTime.time)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);

            const choices = [correctTime, ...distractorTimes];
            
            const categoryTemplates = templatePool[correctTime.category];
            const template = categoryTemplates[Math.floor(Math.random() * categoryTemplates.length)];
            
            let script = template;
            
            if (difficulty === 'easy') {
                script = script.replace(/{time}/g, correctTime.spoken);
            } else if (difficulty === 'medium') {
                script = script.replace(/{time}/g, correctTime.spoken)
                             .replace(/{distractor1}/g, distractorTimes[0].spoken);
            } else { // hard
                script = script.replace(/{time}/g, correctTime.spoken)
                             .replace(/{distractor1}/g, distractorTimes[0].spoken)
                             .replace(/{distractor2}/g, distractorTimes[1].spoken);
            }
            
            const player1Choices = [...choices].sort(() => Math.random() - 0.5);
            const player2Choices = [...choices].sort(() => Math.random() - 0.5);
            const player3Choices = [...choices].sort(() => Math.random() - 0.5);
            
            const buttons = document.querySelectorAll('.choice-button');
            
            player1Choices.forEach((choice, index) => {
                buttons[index].innerHTML = `<span style="color: white; font-weight: bold; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">${choice.display}</span>`;
                buttons[index].classList.remove('correct', 'incorrect');
                buttons[index].disabled = false;
                buttons[index].style.opacity = '1';
            });
            
            player2Choices.forEach((choice, index) => {
                buttons[index + 4].innerHTML = `<span style="color: white; font-weight: bold; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">${choice.display}</span>`;
                buttons[index + 4].classList.remove('correct', 'incorrect');
                buttons[index + 4].disabled = false;
                buttons[index + 4].style.opacity = '1';
            });
            
            player3Choices.forEach((choice, index) => {
                buttons[index + 8].innerHTML = `<span style="color: white; font-weight: bold; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">${choice.display}</span>`;
                buttons[index + 8].classList.remove('correct', 'incorrect');
                buttons[index + 8].disabled = false;
                buttons[index + 8].style.opacity = '1';
            });

            return {
                script: script,
                correctTime: correctTime,
                difficulty: difficulty,
                player1Choices: player1Choices,
                player2Choices: player2Choices,
                player3Choices: player3Choices
            };
        }

        // Select new players with dynamic animation
        function selectNewPlayers() {
            showNameShuffle();
            
            if (usedPlayers.length >= studentNames.length) {
                usedPlayers = [];
            }

            const availablePlayers = studentNames.filter(name => !usedPlayers.includes(name));
            const shuffleContainer = document.getElementById('shuffleContainer');
            const selectedPlayersDiv = document.getElementById('selectedPlayers');
            
            shuffleContainer.innerHTML = '';
            selectedPlayersDiv.innerHTML = '';
            
            availablePlayers.forEach((name, index) => {
                setTimeout(() => {
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'shuffle-name';
                    nameDiv.textContent = name.split(' / ')[0];
                    nameDiv.style.animationDelay = (index * 0.1) + 's';
                    shuffleContainer.appendChild(nameDiv);
                }, index * 100);
            });
            
            setTimeout(() => {
                selectPlayersSequentially(availablePlayers, 0);
            }, availablePlayers.length * 100 + 1000);
        }

        async function selectPlayersSequentially(availablePlayers, playerIndex) {
            if (playerIndex >= 3) {
                setTimeout(() => {
                    showPlayerCountdown();
                }, 2000);
                return;
            }

            const shuffleContainer = document.getElementById('shuffleContainer');
            const selectedPlayersDiv = document.getElementById('selectedPlayers');
            const nameElements = Array.from(shuffleContainer.querySelectorAll('.shuffle-name'));
            
            let highlightCount = 0;
            const highlightInterval = setInterval(async () => {
                nameElements.forEach(el => el.classList.remove('selected'));
                
                const availableNameElements = Array.from(shuffleContainer.querySelectorAll('.shuffle-name'));
                if (availableNameElements.length === 0) {
                    clearInterval(highlightInterval);
                    return;
                }

                const randomIndex = Math.floor(Math.random() * availableNameElements.length);
                if (availableNameElements[randomIndex]) {
                    availableNameElements[randomIndex].classList.add('selected');
                }
                
                highlightCount++;
                if (highlightCount > 8) {
                    clearInterval(highlightInterval);
                    
                    const selectedIndex = Math.floor(Math.random() * availablePlayers.length);
                    const selectedPlayer = availablePlayers.splice(selectedIndex, 1)[0];
                    currentPlayers.push(selectedPlayer);
                    usedPlayers.push(selectedPlayer);
                    
                    nameElements.forEach(el => {
                        if (el.textContent === selectedPlayer.split(' / ')[0]) {
                            el.remove();
                        }
                    });
                    
                    const selectedDiv = document.createElement('div');
                    selectedDiv.className = 'selected-player';
                    selectedDiv.textContent = `Player ${playerIndex + 1}: ${selectedPlayer.split(' / ')[0]}`;
                    selectedPlayersDiv.appendChild(selectedDiv);
                    
                    playCorrectSound();
                    
                    await speakChinese(selectedPlayer.split(' / ')[0]);
                    
                    setTimeout(() => {
                        selectPlayersSequentially(availablePlayers, playerIndex + 1);
                    }, 1000);
                }
            }, 200);
        }

        function showNameShuffle() {
            const shuffleDiv = document.getElementById('nameShuffle');
            shuffleDiv.style.display = 'block';
            currentPlayers = [];
            playShuffleSound();
        }

        function hideNameShuffle() {
            document.getElementById('nameShuffle').style.display = 'none';
        }

        function showPlayerCountdown() {
            const shuffleDiv = document.getElementById('nameShuffle');
            const titleDiv = shuffleDiv.querySelector('.shuffle-title');
            const containerDiv = shuffleDiv.querySelector('.shuffle-container');
            
            containerDiv.innerHTML = '';
            
            let countdown = 10;
            titleDiv.textContent = `Get Ready! Game starts in ${countdown} seconds`;
            
            const countdownInterval = setInterval(() => {
                countdown--;
                titleDiv.textContent = `Get Ready! Game starts in ${countdown} seconds`;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    
                    currentPlayers.forEach(player => {
                        playerScores[player] = 0;
                    });

                    updatePlayerDisplay();
                    hideNameShuffle();
                    showLearningPhase();
                }
            }, 1000);
        }

        function showLearningPhase() {
            setTimeout(() => {
                startNewQuestion();
            }, 500);
        }

        function updatePlayerDisplay() {
            const player1Name = currentPlayers[0] ? currentPlayers[0].split(' / ')[0] : 'Player 1';
            const player2Name = currentPlayers[1] ? currentPlayers[1].split(' / ')[0] : 'Player 2';
            const player3Name = currentPlayers[2] ? currentPlayers[2].split(' / ')[0] : 'Player 3';
            
            const player1FullName = currentPlayers[0] || 'Player 1';
            const player2FullName = currentPlayers[1] || 'Player 2';
            const player3FullName = currentPlayers[2] || 'Player 3';
            
            const score1 = playerScores[player1FullName] || 0;
            const score2 = playerScores[player2FullName] || 0;
            const score3 = playerScores[player3FullName] || 0;
            
            const maxScore = Math.max(score1, score2, score3);
            const trophy1 = score1 === maxScore && score1 > 0 ? ' 🏆' : '';
            const trophy2 = score2 === maxScore && score2 > 0 ? ' 🏆' : '';
            const trophy3 = score3 === maxScore && score3 > 0 ? ' 🏆' : '';
            
            document.getElementById('player1').innerHTML = `${player1Name}${trophy1}<div class="player-score" id="score1">${score1} points</div>`;
            document.getElementById('player2').innerHTML = `${player2Name}${trophy2}<div class="player-score" id="score2">${score2} points</div>`;
            document.getElementById('player3').innerHTML = `${player3Name}${trophy3}<div class="player-score" id="score3">${score3} points</div>`;
        }

        function updateStreakDisplay() {
            const streakIndicator = document.getElementById('streakIndicator');
            const streakCount = document.getElementById('streakCount');
            
            let maxStreak = 0;
            currentPlayers.forEach(player => {
                const streak = playerStreaks[player] || 0;
                if (streak > maxStreak) maxStreak = streak;
            });
            
            if (maxStreak > 0) {
                streakIndicator.style.display = 'block';
                streakCount.textContent = maxStreak;
            } else {
                streakIndicator.style.display = 'none';
            }
        }
        
        function createStreakEffects(button) {
            const rect = button.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const fireEmojis = ['🔥', '⚡', '💥', '✨', '🌟'];
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const fire = document.createElement('div');
                    fire.className = 'celebration-burst';
                    fire.textContent = fireEmojis[Math.floor(Math.random() * fireEmojis.length)];
                    fire.style.left = centerX + (Math.random() - 0.5) * 300 + 'px';
                    fire.style.top = centerY + (Math.random() - 0.5) * 300 + 'px';
                    fire.style.fontSize = '36px';
                    document.body.appendChild(fire);

                    setTimeout(() => fire.remove(), 2000);
                }, i * 100);
            }
        }

        function createFireworks(button) {
            const rect = button.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'fireworks';
                    firework.style.left = centerX + (Math.random() - 0.5) * 200 + 'px';
                    firework.style.top = centerY + (Math.random() - 0.5) * 200 + 'px';
                    document.body.appendChild(firework);

                    setTimeout(() => firework.remove(), 2000);
                }, i * 100);
            }
        }

        function createWinnerFireworks() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'winner-firework';
                    firework.style.left = Math.random() * window.innerWidth + 'px';
                    firework.style.top = Math.random() * window.innerHeight + 'px';
                    document.body.appendChild(firework);

                    setTimeout(() => firework.remove(), 3000);
                }, i * 100);
            }

            const celebrationEmojis = ['🎉', '🎊', '🏆', '👑', '🥇', '⭐', '✨', '🌟', '💫', '🔥'];
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const burst = document.createElement('div');
                    burst.className = 'celebration-burst';
                    burst.textContent = celebrationEmojis[Math.floor(Math.random() * celebrationEmojis.length)];
                    burst.style.left = Math.random() * window.innerWidth + 'px';
                    burst.style.top = Math.random() * window.innerHeight + 'px';
                    document.body.appendChild(burst);

                    setTimeout(() => burst.remove(), 2000);
                }, i * 150);
            }
        }

        function createSparkles(button) {
            const rect = button.getBoundingClientRect();

            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.style.left = rect.left + Math.random() * rect.width + 'px';
                    sparkle.style.top = rect.top + Math.random() * rect.height + 'px';
                    document.body.appendChild(sparkle);

                    setTimeout(() => sparkle.remove(), 1000);
                }, i * 50);
            }
            
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const glitter = document.createElement('div');
                    glitter.className = 'glitter';
                    glitter.style.left = rect.left + Math.random() * rect.width + 'px';
                    glitter.style.top = rect.top + Math.random() * rect.height + 'px';
                    document.body.appendChild(glitter);

                    setTimeout(() => glitter.remove(), 2000);
                }, i * 30);
            }
        }

        function getPlayerScoreElement(playerName) {
            const playerIndex = currentPlayers.indexOf(playerName);
            if (playerIndex === 0) return document.getElementById('score1');
            if (playerIndex === 1) return document.getElementById('score2');
            if (playerIndex === 2) return document.getElementById('score3');
            return null;
        }

        function createFlyingTokens(fromElement, toElement, points) {
            if (!fromElement || !toElement) return;
            
            const fromRect = fromElement.getBoundingClientRect();
            const toRect = toElement.getBoundingClientRect();
            
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const token = document.createElement('div');
                    token.className = 'token';
                    token.textContent = points;
                    token.style.left = fromRect.left + fromRect.width / 2 + 'px';
                    token.style.top = fromRect.top + fromRect.height / 2 + 'px';
                    
                    document.body.appendChild(token);
                    
                    setTimeout(() => {
                        token.style.transition = 'all 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                        token.style.left = toRect.left + toRect.width / 2 + 'px';
                        token.style.top = toRect.top + toRect.height / 2 + 'px';
                        token.style.transform = 'scale(0.5)';
                        token.style.opacity = '0';
                    }, 50);

                    setTimeout(() => token.remove(), 1600);
                }, i * 100);
            }
        }

        function createShakeEffect(button) {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const xMark = document.createElement('div');
                    xMark.innerHTML = '❌';
                    xMark.style.position = 'absolute';
                    xMark.style.left = button.getBoundingClientRect().left + Math.random() * button.getBoundingClientRect().width + 'px';
                    xMark.style.top = button.getBoundingClientRect().top + Math.random() * button.getBoundingClientRect().height + 'px';
                    xMark.style.fontSize = '24px';
                    xMark.style.zIndex = '1001';
                    xMark.style.pointerEvents = 'none';
                    xMark.style.animation = 'fadeOut 1.5s ease-out forwards';
                    document.body.appendChild(xMark);

                    setTimeout(() => xMark.remove(), 1500);
                }, i * 100);
            }
        }

        // Sound effects
        function playTickSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function playBuzzerSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 1);
        }

        function playCorrectSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const notes = [523, 659, 784, 1047]; // C, E, G, C
            notes.forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }, index * 150);
            });
        }

        function playWrongSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function playShuffleSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(400 + Math.random() * 400, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                }, i * 100);
            }
        }

        // Initialize game when page loads
        window.addEventListener('load', () => {
            setTimeout(initGame, 1000);
            ensureVoicesReady(); // Pre-load voices
        });
    </script>
</body>
</html>
