<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IELTS Pro: Extreme Adaptations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700;900&display=swap');

        /* --- CORE LAYOUT --- */
        body {
            font-family: 'Noto Sans', sans-serif;
            background-color: #ecfccb; /* Light Lime/Nature tint */
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        #app-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            position: relative;
            padding: 1.5rem;
        }

        /* --- UI COMPONENTS --- */
        .btn-3d {
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0px 4px 0px 0px rgba(0,0,0,0.15);
            transform: translateY(0);
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0px 0px 0px 0px rgba(0,0,0,0);
        }
        
        .fade-in { animation: fadeUp 0.3s ease-out forwards; width: 100%; height: 100%; display: flex; flex-direction: column; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }

        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Shimmer Effect */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .shimmer-effect {
            background: linear-gradient(90deg, #bbf7d0 25%, #86efac 50%, #bbf7d0 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite linear;
            border-color: #16a34a !important;
            color: #14532d !important;
        }

        /* --- SPECIFIC ELEMENTS --- */
        .vocab-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
            border: 2px solid #d9f99d;
        }

        /* Fixed Width Gap */
        .gap-slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 11rem; 
            border-bottom: 3px solid #65a30d; /* Lime green */
            padding: 0 2px;
            margin: 0 4px;
            color: #3f6212;
            font-weight: 700;
            background: #ecfccb;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            height: 1.4em;
            vertical-align: bottom;
            text-align: center;
            transition: all 0.2s;
            font-size: 1.25rem; 
        }
        .gap-slot.filled { background: #fff; border-bottom: 3px solid #65a30d; }
        .gap-slot.wrong { animation: shake 0.4s; background: #fecaca !important; border-color: #dc2626 !important; }

        /* Highlight Word */
        .highlight-word {
            transition: background-color 0.1s, color 0.1s;
            border-radius: 4px;
            padding: 0 2px;
        }
        .highlight-word.active {
            background-color: #a3e635; 
            color: #1a2e05;
            font-weight: 700;
        }

        /* MCQ Large Format */
        .mcq-option-large {
            font-size: 1.35rem; 
            padding: 1rem;
            border: 3px solid #ecfccb;
            border-radius: 1rem;
            transition: all 0.2s;
            text-align: left;
            background: white;
            height: 100%;
            display: flex;
            align-items: center;
            width: 100%;
        }
        .mcq-option-large:hover { border-color: #84cc16; background: #f7fee7; }
        .mcq-option-large.correct { background-color: #bbf7d0; border-color: #16a34a; }
        .mcq-option-large.wrong { background-color: #fecaca; border-color: #dc2626; }

        .word-bank-item {
            font-size: 1.1rem; 
            padding: 0.5rem 1rem; 
        }
        .word-bank-item.selected {
            background-color: #65a30d;
            color: white;
            border-color: #3f6212;
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .word-bank-item.used {
            opacity: 0.3;
            pointer-events: none;
            filter: grayscale(100%);
            transform: scale(0.95);
        }

        #praise-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            pointer-events: none;
            display: none;
        }
        #praise-text {
            font-size: 6rem;
            font-weight: 900;
            color: #4d7c0f;
            text-shadow: 0 4px 0 white, 0 8px 10px rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.95);
            padding: 2rem 4rem;
            border-radius: 2rem;
            border: 6px solid #4d7c0f;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }

    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-slate-900 text-white p-3 shadow-lg z-20 flex-none h-18">
        <div class="max-w-7xl mx-auto flex justify-between items-center h-full w-full px-2">
            
            <div class="flex gap-4 items-center">
                <button onclick="resetProgress()" class="text-slate-400 hover:text-white transition" title="New Session">
                    <i class="fas fa-redo text-2xl"></i>
                </button>
                <div class="h-6 w-px bg-slate-700"></div>
                <button onclick="toggleAudio()" id="audio-btn" class="text-lime-400 hover:text-lime-300 transition" title="Toggle Auto-Play">
                    <i class="fas fa-volume-up text-2xl"></i>
                </button>
            </div>

            <div class="flex flex-col items-center flex-1 mx-4">
                <div class="w-full max-w-sm h-3 bg-slate-700 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-lime-500 w-0 transition-all duration-500"></div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div id="header-actions"></div>
                <div class="bg-slate-800 px-3 py-1 rounded-lg text-xl font-mono border border-slate-600 min-w-[60px] text-center">
                    <span id="score-val" class="text-lime-400 font-bold">0</span>
                </div>
                
                <button id="prev-btn" class="bg-slate-700 hover:bg-slate-600 text-white w-12 h-10 rounded-lg flex items-center justify-center disabled:opacity-30 transition btn-3d">
                    <i class="fas fa-chevron-left text-lg"></i>
                </button>
                <button id="next-btn" class="bg-lime-600 hover:bg-lime-500 text-white px-5 h-10 rounded-lg font-bold flex items-center gap-2 btn-3d text-base transition shadow-lime-900/50">
                    NEXT <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </header>

    <div id="praise-overlay" class="pop-in">
        <div id="praise-text">Correct!</div>
    </div>

    <main id="app-content" class="bg-slate-50 relative w-full h-full">
        <!-- Injected here -->
    </main>

    <script>
        /* --- STATE --- */
        const defaultState = { page: 0, score: 0, audioEnabled: true };
        let state = JSON.parse(localStorage.getItem('ielts_adapt_v3')) || defaultState;

        function saveState() { localStorage.setItem('ielts_adapt_v3', JSON.stringify(state)); }
        function resetProgress() { if(confirm("Start a New Session?")) { state = { ...defaultState }; saveState(); location.reload(); } }
        function startUnit() { state.page = 1; saveState(); render(); }
        
        function toggleAudio() { 
            state.audioEnabled = !state.audioEnabled; 
            saveState(); 
            updateAudioIcon(); 
            stopAudio(); 
        }
        
        function updateAudioIcon() {
            const btn = document.getElementById('audio-btn');
            if(btn) btn.innerHTML = state.audioEnabled ? '<i class="fas fa-volume-up text-2xl"></i>' : '<i class="fas fa-volume-mute text-2xl text-gray-500"></i>';
        }

        /* --- DATA: EXTREME ADAPTATIONS --- */
        const vocabulary = [
            { word: "Vertebrae", emoji: "ü¶¥", def: "The small bones forming the backbone.", sent: "Giraffes have the same number of neck vertebrae as humans.", persona: "Andrew" },
            { word: "Prehensile", emoji: "üêí", def: "Capable of grasping or holding.", sent: "The chameleon has a prehensile tail for climbing.", persona: "Emma" },
            { word: "Bioluminescence", emoji: "üí°", def: "Light produced by a living organism.", sent: "Anglerfish use bioluminescence to attract prey.", persona: "Brian" },
            { word: "Camouflage", emoji: "ü¶é", def: "Blending in with the environment.", sent: "Chameleons use color for mood, not just camouflage.", persona: "Ava" },
            { word: "Lure", emoji: "üé£", def: "Something used to attract animals.", sent: "The glowing lure hangs in front of the fish's mouth.", persona: "Andrew" },
            { word: "Valve", emoji: "‚ù§Ô∏è", def: "A flap that controls blood flow.", sent: "Valves in the giraffe's neck stop blood rushing to the brain.", persona: "Emma" },
            { word: "Browsing", emoji: "üåø", def: "Feeding on high leaves and shoots.", sent: "Giraffes are adapted for browsing tall acacia trees.", persona: "Brian" },
            { word: "Pigment", emoji: "üé®", def: "A natural coloring matter.", sent: "Special pigment cells allow skin color changes.", persona: "Ava" },
            { word: "Pressure", emoji: "ü©∏", def: "The force of blood in the veins.", sent: "Giraffes have extremely high blood pressure.", persona: "Andrew" },
            { word: "Habitat", emoji: "üè†", def: "The natural home of an animal.", sent: "The deep sea is a dark and cold habitat.", persona: "Emma" }
        ];

        const lectures = {
            1: {
                text: "The giraffe is a marvel of engineering. Its neck can be two meters long, yet it has only seven vertebrae, just like us. To pump blood up that high, its heart is huge. But the real problem is drinking. When a giraffe lowers its head, gravity should rush blood to the brain and kill it. To prevent this, they have special one-way valves in their neck arteries and a sponge-like network of vessels at the base of the brain to slow the flow.",
                gaps: {
                    parts: ["A giraffe's neck has seven [1], the same as humans. To drink safely, it uses one-way [2] in the arteries. This prevents high blood [3] from damaging the brain."],
                    ans: ["vertebrae", "valves", "pressure"],
                    bank: ["vertebrae", "valves", "pressure", "bones", "muscles", "water"] 
                }
            },
            2: {
                text: "Chameleons are famous for changing color, but it's not usually for camouflage. They mostly change color to regulate body temperature or show emotion. A dark color absorbs heat, while a light color reflects it. Another unique feature is their eyes. Their eyes move independently, allowing them to look forward and backward at the same time. This gives them a full 360-degree view of their surroundings to spot predators and prey.",
                mcq: [
                    { q: "Why do chameleons primarily change color?", opts: ["To hide from prey", "Temperature and mood", "To look like leaves", "To scare birds"], ans: 1 },
                    { q: "What is unique about their eyes?", opts: ["They glow in the dark", "They move independently", "They possess x-ray vision", "They are very large"], ans: 1 },
                    { q: "A dark color helps the chameleon to...", opts: ["Cool down", "Absorb heat", "Sleep better", "Attract mates"], ans: 1 }
                ]
            },
            3: {
                text: "In the pitch-black depths of the ocean lives the Anglerfish. The female has a modified spine that sticks out of her head like a fishing pole. At the tip is a glowing ball of light, created by bioluminescent bacteria. In the darkness, other fish see this light and think it is food. When they get close, the Anglerfish snaps its huge jaws shut. The male is tiny and his only job is to find a female and attach to her forever.",
                mcq: [
                    { q: "What creates the light on the Anglerfish?", opts: ["A battery", "Bioluminescent bacteria", "Reflected sunlight", "A chemical reaction"], ans: 1 },
                    { q: "What acts as the 'fishing pole'?", opts: ["A modified spine", "A long whisker", "A piece of coral", "Her tail"], ans: 0 },
                    { q: "What is the function of the glowing light?", opts: ["To see where it is going", "To attract prey", "To scare sharks", "To communicate"], ans: 1 }
                ]
            }
        };

        /* --- AUDIO SYSTEM --- */
        let voices = [];
        const synth = window.speechSynthesis;

        function loadVoices() { voices = synth.getVoices(); }
        synth.onvoiceschanged = loadVoices;
        setTimeout(loadVoices, 500);

        function speak(text, highlightCallback) {
            if(!state.audioEnabled) return;
            synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 0.85; 
            const brian = voices.find(v => v.name.includes("Brian"));
            if (brian) u.voice = brian;
            else {
                const fallback = voices.find(v => v.name.includes("Microsoft") && v.lang.includes("en")) || voices.find(v => v.lang.includes("en"));
                if(fallback) u.voice = fallback;
            }
            if (highlightCallback) {
                u.onboundary = (event) => { if (event.name === 'word') highlightCallback(event.charIndex); };
            }
            synth.speak(u);
        }
        function stopAudio() { synth.cancel(); }

        /* --- ROUTER --- */
        const container = document.getElementById('app-content');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const scoreDisplay = document.getElementById('score-val');
        const progressEl = document.getElementById('progress-bar');
        const headerActions = document.getElementById('header-actions');
        const praiseOverlay = document.getElementById('praise-overlay');

        function render() {
            container.innerHTML = '';
            headerActions.innerHTML = ''; 
            praiseOverlay.style.display = 'none';
            stopAudio();
            scoreDisplay.textContent = state.score;
            updateAudioIcon();
            
            const totalPages = 24; 
            const pct = (state.page / totalPages) * 100;
            progressEl.style.width = `${pct}%`;

            prevBtn.disabled = state.page === 0;
            prevBtn.onclick = () => { if(state.page > 0) { state.page--; saveState(); render(); }};
            nextBtn.onclick = () => { if(state.page < totalPages) { state.page++; saveState(); render(); }};

            if(state.page === 0) renderHome();
            else if(state.page === 1) renderWarmup();
            else if(state.page === 2) renderWarmupAnswer();
            else if(state.page >= 3 && state.page <= 12) renderVocab(state.page - 3);
            else if(state.page === 13) renderScriptView(1, "ü¶í The Giraffe");
            else if(state.page === 14) renderGapFill(1);
            else if(state.page === 15) renderScriptView(2, "ü¶é The Chameleon");
            else if(state.page === 16) renderMCQSingle(2, 0);
            else if(state.page === 17) renderMCQSingle(2, 1);
            else if(state.page === 18) renderMCQSingle(2, 2);
            else if(state.page === 19) renderScriptView(3, "üé£ The Anglerfish");
            else if(state.page === 20) renderMCQSingle(3, 0);
            else if(state.page === 21) renderMCQSingle(3, 1);
            else if(state.page === 22) renderMCQSingle(3, 2);
            else if(state.page === 23) renderFinish();
        }

        /* --- VIEWS --- */
        function renderHome() {
            container.innerHTML = `
                <div class="fade-in items-center justify-center text-center flex-1">
                    <div class="w-32 h-32 bg-lime-100 rounded-full flex items-center justify-center mb-6 shadow-inner mx-auto">
                        <i class="fas fa-paw text-6xl text-lime-600"></i>
                    </div>
                    <h1 class="text-5xl font-black text-slate-800 mb-4 tracking-tight">Extreme Adaptations üß¨</h1>
                    <p class="text-2xl text-slate-500 mb-8 font-light">IELTS Academic Listening</p>
                    <button onclick="startUnit()" class="bg-lime-600 text-white px-12 py-5 rounded-2xl text-xl font-bold shadow-xl hover:bg-lime-700 btn-3d transition">
                        START üöÄ
                    </button>
                </div>
            `;
            nextBtn.style.visibility = 'hidden';
            prevBtn.style.visibility = 'hidden';
        }

        function renderWarmup() {
            nextBtn.style.visibility = 'visible';
            prevBtn.style.visibility = 'visible';
            container.innerHTML = `
                <div class="fade-in items-center justify-center flex-1 w-full p-4">
                    <div class="bg-white rounded-[2rem] shadow-xl p-8 border-t-[8px] border-lime-500 w-full text-center max-w-4xl">
                        <h2 class="text-xl font-bold mb-6 text-lime-800 uppercase tracking-widest">Speaking Warm Up üó£Ô∏è</h2>
                        <p class="text-5xl font-bold text-slate-800 mb-8 leading-tight">
                            "Why do giraffes have blue tongues? ü¶í"
                        </p>
                        <div class="flex justify-center gap-6">
                            <button onclick="timer(60)" class="bg-slate-50 border-2 border-slate-200 hover:border-lime-400 px-8 py-4 rounded-2xl text-xl font-bold transition flex flex-col items-center min-w-[160px]">
                                <i class="fas fa-brain mb-2 text-3xl text-lime-600"></i> Think
                            </button>
                            <button onclick="timer(120)" class="bg-slate-50 border-2 border-slate-200 hover:border-blue-400 px-8 py-4 rounded-2xl text-xl font-bold transition flex flex-col items-center min-w-[160px]">
                                <i class="fas fa-comments mb-2 text-3xl text-blue-600"></i> Pair
                            </button>
                        </div>
                        <div id="timer-display" class="text-center text-6xl font-mono font-bold text-slate-700 mt-8">00:00</div>
                    </div>
                </div>
            `;
        }

        function renderWarmupAnswer() {
            container.innerHTML = `
                <div class="fade-in items-center justify-center flex-1 w-full p-4">
                    <div class="bg-indigo-900 rounded-[2rem] shadow-xl p-10 w-full text-center text-white relative overflow-hidden max-w-4xl">
                        <h2 class="text-2xl font-bold mb-6 text-indigo-300 uppercase tracking-widest">The Reason üí°</h2>
                        <p class="text-4xl font-bold mb-6 leading-snug">
                            "It acts like natural <span class="text-yellow-400">sunscreen</span> to prevent sunburn while eating!"
                        </p>
                    </div>
                </div>
            `;
        }

        function timer(sec) {
            let t = sec;
            const el = document.getElementById('timer-display');
            clearInterval(window.timerInt);
            window.timerInt = setInterval(() => {
                const m = Math.floor(t/60);
                const s = t%60;
                el.textContent = `${m}:${s<10?'0'+s:s}`;
                if(t<=0) { clearInterval(window.timerInt); el.textContent = "DONE"; el.classList.add('shake'); }
                t--;
            }, 1000);
        }

        function renderVocab(idx) {
            const v = vocabulary[idx];
            container.innerHTML = `
                <div class="fade-in h-full p-4 justify-start">
                    <div class="vocab-card w-full max-w-6xl bg-white flex flex-col p-12 relative overflow-hidden h-full items-start text-left">
                        <div class="flex-1 flex flex-col justify-start gap-8 pt-4 w-full">
                            <div>
                                <span class="block text-lime-600 text-lg font-bold tracking-widest mb-2">WORD ${idx+1}/10</span>
                                <h2 class="text-5xl font-black text-slate-800">${v.emoji} ${v.word.toLowerCase()}</h2>
                            </div>
                            <p class="text-5xl text-gray-700 leading-snug font-light">${v.def}</p>
                            <div class="border-l-[8px] border-lime-500 pl-8">
                                <p class="text-4xl text-lime-900 italic font-medium leading-relaxed">"${v.sent}"</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            if(state.audioEnabled) {
                const textToSpeak = `${v.word}. ${v.def}. ${v.sent}`;
                setTimeout(() => speak(textToSpeak), 500);
            }
        }

        function renderScriptView(lecId, titleText) {
            const l = lectures[lecId];
            const words = l.text.split(' ');
            const playBtn = document.createElement('button');
            playBtn.className = "bg-lime-500 hover:bg-lime-400 text-white w-10 h-10 rounded-full flex items-center justify-center transition shadow-lg";
            playBtn.innerHTML = '<i class="fas fa-stop"></i>';
            playBtn.onclick = stopAudio;
            headerActions.appendChild(playBtn);

            container.innerHTML = `
                <div class="fade-in h-full p-4 flex flex-col items-center justify-center">
                    <div class="bg-white rounded-[2rem] shadow-xl p-8 w-full max-w-6xl h-full flex flex-col border border-slate-200">
                        <h2 class="text-2xl text-lime-700 font-bold mb-4">${titleText}</h2>
                        <div id="script-container" class="text-2xl leading-relaxed font-bold text-gray-800 flex-1 flex flex-wrap content-start justify-start text-left gap-x-2 gap-y-2 overflow-y-auto">
                            ${words.map((w, i) => `<span class="highlight-word">${w} </span>`).join('')}
                        </div>
                    </div>
                </div>
            `;

            if(state.audioEnabled) {
                setTimeout(() => {
                    speak(l.text, (charIdx) => {
                        let runningTotal = 0;
                        const spans = document.querySelectorAll('.highlight-word');
                        spans.forEach(s => s.classList.remove('active'));
                        for(let i=0; i<spans.length; i++) {
                            const span = spans[i];
                            const len = span.innerText.length;
                            if (charIdx >= runningTotal && charIdx < runningTotal + len) {
                                span.classList.add('active');
                                span.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
                                break;
                            }
                            runningTotal += len;
                        }
                    });
                }, 500);
            }
        }

        let selectedGapWord = null;
        function renderGapFill(lecId) {
            const l = lectures[lecId];
            const parts = l.gaps.parts[0].split(/(\[\d\])/);
            const bank = [...l.gaps.bank].sort(() => 0.5 - Math.random());
            selectedGapWord = null;

            container.innerHTML = `
                <div class="fade-in items-center justify-center h-full p-2">
                    <div class="bg-white rounded-[2rem] shadow-lg p-8 w-full max-w-6xl flex flex-col h-full border border-slate-200">
                        <div class="bg-slate-50 p-8 rounded-2xl text-2xl leading-loose text-gray-800 mb-4 flex-1 flex flex-wrap content-start items-center border border-slate-200 font-medium text-left">
                            <div class="text-left w-full">
                                ${parts.map(p => p.match(/\[\d\]/) ? `<span class="gap-slot" id="gap-${p.replace(/\D/g,'')}" onclick="handleGapClick(this, ${lecId}, ${parseInt(p.replace(/\D/g,''))-1})"></span>` : p).join('')}
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3 justify-center mb-4 bg-slate-100 p-4 rounded-xl min-h-[80px] items-center">
                            ${bank.map(w => `<button class="word-bank-item bg-white border border-slate-300 px-4 py-2 rounded-lg shadow-sm font-bold text-lg hover:bg-lime-50 hover:border-lime-400 transition" onclick="selectBankWord(this, '${w}')">${w}</button>`).join('')}
                        </div>
                        <p class="text-center text-slate-400 text-sm">Select a word, then tap a blank space.</p>
                    </div>
                </div>
            `;
        }

        function selectBankWord(btn, word) {
            const isSelected = btn.classList.contains('selected');
            document.querySelectorAll('.word-bank-item').forEach(b => b.classList.remove('selected'));
            if (!isSelected) {
                btn.classList.add('selected');
                selectedGapWord = { word: word, el: btn };
                playSound('click');
            } else { selectedGapWord = null; }
        }

        function handleGapClick(gapEl, lecId, ansIndex) {
            if (!selectedGapWord || gapEl.classList.contains('filled')) return;
            const correctWord = lectures[lecId].gaps.ans[ansIndex];
            if (selectedGapWord.word === correctWord) {
                gapEl.textContent = selectedGapWord.word;
                gapEl.classList.add('filled', 'shimmer-effect');
                selectedGapWord.el.classList.add('used');
                selectedGapWord.el.classList.remove('selected');
                selectedGapWord = null;
                playSound('correct');
                const totalGaps = lectures[lecId].gaps.ans.length;
                const filledGaps = document.querySelectorAll('.gap-slot.filled').length;
                if(filledGaps === totalGaps) {
                    state.score += 20; saveState();
                    scoreDisplay.textContent = state.score;
                    showPraise("Perfect! üéâ");
                    triggerConfetti();
                }
            } else {
                gapEl.classList.add('wrong'); playSound('wrong');
                setTimeout(() => gapEl.classList.remove('wrong'), 500);
            }
        }

        function renderMCQSingle(lecId, qIdx) {
            const q = lectures[lecId].mcq[qIdx];
            container.innerHTML = `
                <div class="fade-in items-center justify-center h-full p-4">
                    <div class="bg-white rounded-[2rem] shadow-xl p-8 w-full max-w-6xl h-full flex flex-col border border-slate-200">
                        <div class="mb-6 text-left w-full">
                            <p class="font-bold text-gray-800 text-4xl leading-tight text-left">${q.q}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-6 flex-1 content-center">
                            ${q.opts.map((o, oi) => `
                                <button id="opt-${oi}" onclick="checkMCQSingle(${oi}, ${q.ans})" class="mcq-option-large w-full flex items-center justify-start">
                                    <div class="w-12 h-12 rounded-full bg-slate-100 text-slate-500 font-bold flex items-center justify-center mr-6 text-xl border border-slate-300 shrink-0">
                                        ${String.fromCharCode(65+oi)}
                                    </div>
                                    <span class="font-medium text-slate-700 text-left">${o}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function checkMCQSingle(optIdx, correctIdx) {
            const btn = document.getElementById(`opt-${optIdx}`);
            const allOpts = document.querySelectorAll('.mcq-option-large');
            if(optIdx === correctIdx) {
                btn.classList.add('correct');
                state.score += 10;
                allOpts.forEach(b => b.disabled = true);
                showPraise("Correct! üåü");
                triggerConfetti();
            } else { btn.classList.add('wrong'); btn.classList.add('shake'); }
            scoreDisplay.textContent = state.score; saveState();
        }

        function showPraise(text) {
            const overlay = document.getElementById('praise-overlay');
            const txt = document.getElementById('praise-text');
            txt.textContent = text;
            overlay.style.display = 'block';
            setTimeout(() => { overlay.style.display = 'none'; }, 2000);
        }

        function renderFinish() {
             container.innerHTML = `
                <div class="fade-in items-center justify-center flex-1 text-center p-4">
                    <div class="bg-white p-16 rounded-[3rem] shadow-2xl max-w-2xl w-full">
                        <div class="text-8xl mb-6">üèÜ</div>
                        <h2 class="text-5xl font-black text-slate-800 mb-4">Complete!</h2>
                        <div class="my-8 py-6 bg-slate-50 rounded-3xl border-2 border-slate-100">
                            <span class="text-7xl font-black text-lime-600">${state.score}</span>
                        </div>
                        <button onclick="resetProgress()" class="bg-slate-800 text-white px-8 py-4 rounded-xl font-bold text-xl hover:bg-slate-700 transition w-full shadow-lg">
                            New Session üîÑ
                        </button>
                    </div>
                </div>
            `;
        }
        
        function triggerConfetti() {
            const colors = ['#84cc16', '#3b82f6', '#f59e0b', '#ec4899'];
            for(let i=0; i<15; i++) {
                const c = document.createElement('div');
                c.style.cssText = `position:fixed;width:15px;height:15px;background:${colors[Math.floor(Math.random()*colors.length)]};top:-10px;left:${Math.random()*100}vw;pointer-events:none;z-index:99;border-radius:4px;`;
                document.body.appendChild(c);
                c.animate([{transform:`translate(0,0) rotate(0)`}, {transform:`translate(${Math.random()*200-100}px, 100vh) rotate(720deg)`}], {duration: 1500+Math.random()*1500});
                setTimeout(()=>c.remove(), 3000);
            }
        }

        function playSound(type) {
            if(!state.audioEnabled) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            if(type==='click') { o.type='triangle'; o.frequency.value=600; g.gain.value=0.1; o.start(); o.stop(ctx.currentTime+0.05); } 
            else if(type==='correct') { o.type='sine'; o.frequency.setValueAtTime(500, ctx.currentTime); o.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime+0.1); g.gain.linearRampToValueAtTime(0, ctx.currentTime+0.3); o.start(); o.stop(ctx.currentTime+0.3); } 
            else { o.type='sawtooth'; o.frequency.value=150; g.gain.linearRampToValueAtTime(0, ctx.currentTime+0.3); o.start(); o.stop(ctx.currentTime+0.3); }
        }

        if(state.page === 0) renderHome(); else render();
        scoreDisplay.textContent = state.score;
        updateAudioIcon();
    </script>
</body>
</html>
