<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit 1: Amazing Animals & Biomimicry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Nature/Ocean Theme Colors */
        @keyframes natureColors {
            0% { background-color: #0f766e; } /* teal-700 */
            25% { background-color: #0e7490; } /* cyan-700 */
            50% { background-color: #0369a1; } /* sky-700 */
            75% { background-color: #0e7490; } /* cyan-700 */
            100% { background-color: #0f766e; } /* teal-700 */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            animation: natureColors 120s linear infinite;
            padding-top: 85px; 
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
            border: none;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px -1px rgba(0,0,0,0.2), 0 1px 2px -2px rgba(0,0,0,0.1), inset 0 -2px 0 0 rgba(0,0,0,0.2);
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 44px; padding: 0 4px;
            border: 2px dashed #9ca3af; border-radius: 8px; margin: 0 4px;
            vertical-align: middle; background-color: #f3f4f6;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 8px;
            background-color: white; user-select: none;
        }
        .word-bank-word.selected { outline: 2px solid #6366f1; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; }
        .gap.correct .word-bank-word { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .gap.incorrect .word-bank-word { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Feedback Message & Badge Notification */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #14b8a6, #0ea5e9); animation-duration: 4.5s; }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 20px; } to { opacity: 0; bottom: 0; } }

        /* Certificate Canvas */
        #completion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* Progress Bar */
        #progress-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 8px; width: 100%; margin-top: 8px; }
        #progress-bar { height: 100%; width: 0%; background-color: #2dd4bf; transition: width 0.5s ease-out; }
        
        /* Vocab Game Timer */
        #vocab-game-timer-bar { height: 6px; background-color: #2dd4bf; transition: width 0.1s linear; }
        
        /* Shake Animation for incorrect answers */
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        /* Helper class for word banks */
        .word-bank { margin-top: 1.5rem; }
        .word-bank h4 { font-weight: 700; font-size: 1.125rem; color: #0f766e; }
        .word-bank-pills { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; padding: 1rem; background-color: #f0fdfa; border-radius: 0.5rem; }
        .word-bank-pills span { background-color: #ffffff; border: 1px solid #99f6e4; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; color: #115e59; }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #certificate-to-print, #certificate-to-print * { visibility: visible; }
            #certificate-to-print { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; border: 10px solid #0f766e; background: #fff; }
        }
    
        /* --- Reward Animation Styles --- */
        .particle { position: fixed; pointer-events: none; z-index: 9999; will-change: transform, opacity; opacity: 1; transition: opacity 0.5s ease-out; }
        .particle.glitter { width: 10px; height: 10px; border-radius: 50%; background: #fde047; box-shadow: 0 0 5px #fde047, 0 0 10px #fde047, 0 0 15px #fff; }
        .particle.glitter.alt { background: #2dd4bf; box-shadow: 0 0 5px #2dd4bf, 0 0 10px #fff, 0 0 15px #0f766e; }
        .particle.chocolate { font-size: 32px; }
    </style>
</head>
<body class="antialiased text-gray-800 text-lg">
    <canvas id="background-canvas"></canvas>
    <!-- This container is for the reward animations -->
    <div id="reward-animation-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]"></div>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-md mx-auto bg-white/90 backdrop-blur-sm shadow-lg rounded-full p-2">
            <div class="flex justify-center items-center gap-2">
                <button onclick="goBack()" class="nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="font-bold text-base text-teal-600 px-3 whitespace-nowrap">Points üåø: <span id="score-display">0</span></div>
                <button onclick="navigateTo('main-menu')" class="nav-button bg-gray-800 text-white font-bold p-2 rounded-full hover:bg-gray-900">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4h.01M5 19h14"></path></svg>
                </button>
                <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-full hover:bg-gray-200" title="Toggle Sound">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
                </button>
                <button onclick="goNext()" class="nav-button bg-teal-600 hover:bg-teal-700 text-white font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
        </div>
    </header>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <section id="page-title-screen" class="page active text-center bg-white rounded-2xl shadow-lg p-8">
            <div class="h-full flex flex-col justify-center items-center">
                <h1 id="main-title" class="text-5xl md:text-6xl font-bold text-slate-800 mb-4"></h1>
                <p id="main-subtitle" class="text-xl md:text-2xl text-gray-600 mb-8"></p>
                <div id="main-svg-container" class="rounded-lg mb-8 w-full max-w-lg mx-auto"></div>
                <button onclick="startApp()" class="action-button bg-teal-600 text-white font-bold py-3 px-8 rounded-full text-2xl hover:bg-teal-700">START UNIT 1</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION (UNIT 1: AMAZING ANIMALS) ---
        // ===================================================================================
        const lessonData = {
            title: "Unit 1: Amazing Animals",
            subtitle: "Nature's Engineers: Biomimicry <span aria-hidden='true'>üê¨</span>",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-plan', text: 'Teacher Resource: Unit Plan <span aria-hidden="true">üìã</span>', color: 'purple', target: 'unit-plan' },
                
                // PHASE 1: RESEARCH (The Input)
                { id: 'menu-hook', text: 'Lesson 1: The Hook (Warm-Up) <span aria-hidden="true">üåä</span>', color: 'green', target: 'tps-start' },
                { id: 'menu-reading1', text: 'Lesson 2: Data Source A (Dolphin) <span aria-hidden="true">üê¨</span>', color: 'blue', target: 'reading-main' },
                { id: 'menu-reading2', text: 'Lesson 3: Data Source B (Octopus) <span aria-hidden="true">üêô</span>', color: 'indigo', target: 'lecture-uni' },
                { id: 'menu-video', text: 'Lesson 4: Data Source C (Chameleon) <span aria-hidden="true">ü¶é</span>', color: 'lime', target: 'podcast-convo' },
                
                // PHASE 2: ACQUISITION (The Tools)
                { id: 'menu-vocab', text: 'Lesson 5: Vocabulary (The Tools) <span aria-hidden="true">üìö</span>', color: 'sky', target: 'vocab-start' },
                { id: 'menu-vocab-game', text: 'Lesson 6: Tool Practice (Game) <span aria-hidden="true">üéÆ</span>', color: 'sky', target: 'vocab-game'},
                
                // PHASE 3: DEVELOPMENT (The Process)
                { id: 'menu-bio', text: 'Lesson 7: Biomimicry Case Studies <span aria-hidden="true">üöÖ</span>', color: 'amber', target: 'biomimicry-1' },
                { id: 'menu-project', text: 'Lesson 8: Project Ideation (Bug List) <span aria-hidden="true">üìù</span>', color: 'orange', target: 'podcast-futures' },
                { id: 'menu-compare', text: 'Lesson 9: Comparative Analysis <span aria-hidden="true">‚öñÔ∏è</span>', color: 'rose', target: 'debate-planning' },
                
                // PHASE 4: PRODUCTION (The Launch)
                { id: 'menu-ethics', text: 'Lesson 10: Ethical Dilemma <span aria-hidden="true">‚ö†Ô∏è</span>', color: 'red', target: 'dilemma-ethics' },
                { id: 'menu-final', text: 'Lesson 11: Final Pitch & Launch <span aria-hidden="true">üé§</span>', color: 'violet', target: 'final-project-hub' },
            ],
            vocabulary: [
                { word: 'Intelligent', def: 'Able to learn and understand things easily.', sentence: 'Dolphins are highly intelligent animals that can solve problems.' },
                { word: 'Communicate', def: 'To share information with others.', sentence: 'Whales communicate with each other using loud songs.' },
                { word: 'Method', def: 'A particular way of doing something.', sentence: 'The octopus uses a clever method to open the jar.' },
                { word: 'Assist', def: 'To help someone.', sentence: 'The dolphins assist the fishermen by driving fish into the nets.' },
                { word: 'Advantage', def: 'Something that helps you succeed or is good for you.', sentence: 'Camouflage gives the hunter a huge advantage.' },
                { word: 'Creature', def: 'A living animal.', sentence: 'The deep ocean is full of strange and wonderful creatures.' },
                { word: 'Ability', def: 'The power or skill to do something.', sentence: 'Birds have the unique ability to fly.' },
                { word: 'Appearance', def: 'The way something looks.', sentence: 'The chameleon changed its appearance to match the leaf.' },
                { word: 'Survive', def: 'To stay alive, especially in difficult conditions.', sentence: 'Animals need food and water to survive in the desert.' },
                { word: 'Develop', def: 'To grow or change into something more advanced.', sentence: 'Scientists developed a new train based on a bird\'s beak.' }
            ],
            pages: [
                // Teacher Resource: Unit Plan
                { id: 'unit-plan', type: 'html-content', content: { title: 'Teacher Unit Plan <span aria-hidden="true">üìã</span>', html: `
                    <div class="text-left space-y-6 text-base md:text-lg bg-gray-50 p-6 rounded-lg max-h-[60vh] overflow-y-auto">
                        <div class="border-b border-gray-300 pb-4">
                            <h3 class="text-2xl font-bold text-teal-800">UNIT 1: NATURE‚ÄôS BLUEPRINT (AMAZING ANIMALS)</h3>
                            <p><strong>Grade Level:</strong> 8 | <strong>Proficiency:</strong> CEFR A2/B1 | <strong>Duration:</strong> 2 Weeks</p>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-teal-700">THE STRATEGY: Research $\\rightarrow$ Development</h4>
                            <p class="mb-2">In this PBL unit, the reading text is not "the story at the end"; it is the <strong>Source Material</strong> students need to build their project. Vocabulary words are the <strong>Bricks</strong>.</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                                    <h5 class="font-bold text-blue-600">Phase 1: Research (Input)</h5>
                                    <p class="text-sm">Readings & Videos. Students gather data on echolocation and camouflage *before* they can mimic it.</p>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                                    <h5 class="font-bold text-sky-600">Phase 2: Acquisition (Tools)</h5>
                                    <p class="text-sm">Vocabulary & Grammar. Students need words like "method" and "advantage" to write professional scripts.</p>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                                    <h5 class="font-bold text-amber-600">Phase 3: Development (Process)</h5>
                                    <p class="text-sm">Biomimicry & Prototyping. Applying the science (Phase 1) and words (Phase 2) to create a visual prototype.</p>
                                </div>
                                <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                                    <h5 class="font-bold text-violet-600">Phase 4: Production (Output)</h5>
                                    <p class="text-sm">The Pitch. The "Final Exam" is a presentation proving mastery of content and language.</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-bold text-teal-700 mt-4">LEARNING OBJECTIVES</h4>
                            <ul class="list-disc list-inside mt-2">
                                <li><strong>Reading:</strong> Skim for proper nouns; Scan for "Wh-" details; Infer meaning of "assist".</li>
                                <li><strong>Vocabulary:</strong> Match 10 target words; Use 4+ words in final output.</li>
                                <li><strong>Grammar:</strong> Construct "Subject + uses + [Noun] + to + [Verb]" sentences.</li>
                                <li><strong>Speaking:</strong> Deliver a 1-minute persuasive pitch with clear pronunciation.</li>
                            </ul>
                        </div>
                    </div>
                ` } },

                // LESSON 1: The Hook
                { id: 'tps-start', type: 'simple', content: { title: 'Lesson 1: The Hook <span aria-hidden="true">üåä</span>', text: 'Let\'s start by seeing with new eyes.' } },
                { id: 'tps-think', type: 'timer', content: { title: '1. Perceive <span aria-hidden="true">ü§î</span>', text: 'Look at a dolphin fin and a surfboard fin. Don\'t just say "it\'s a dolphin." Describe the SHAPE and the METHOD of movement. You have 60 seconds.', duration: 60, timerId: 'tps-timer-1' } },
                { id: 'learning-goals', type: 'html-content', content: { title: 'Mission Objectives <span aria-hidden="true">üéØ</span>', html: `
                                <div class="text-left space-y-4">
                                    <p class="text-lg">You are acting as <strong>Engineers</strong>. To build your invention, you first need to study the science.</p>
                                    <h3 class="text-xl font-bold text-teal-600">Phase 1: Research Goals</h3>
                                    <ul class="list-disc list-inside space-y-2">
                                        <li>Gather data on how dolphins use <strong>teamwork</strong>.</li>
                                        <li>Analyze how octopuses use <strong>camouflage</strong>.</li>
                                        <li>Identify the biological <strong>methods</strong> used by chameleons.</li>
                                    </ul>
                                </div>` } },

                // LESSON 2: Reading 1A
                { id: 'reading-main', type: 'html-content', content: { title: 'Research Source A: The Dolphin <span aria-hidden="true">üê¨</span>', html: `
                                <div class="space-y-6 text-left">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h4 class="font-bold text-xl text-blue-800">More Than Just Fish</h4>
                                        <p>Dolphins are not fish; they are mammals. They are famous for being <strong>intelligent</strong> and social. Scientists have found that dolphins <strong>communicate</strong> with each other using unique whistles. It is like they have their own names! They also show complex <strong>feelings</strong> and play games, like catching seaweed with their friends.</p>
                                    </div>
                                    <div class="bg-teal-50 p-4 rounded-lg">
                                        <h4 class="font-bold text-xl text-teal-800">Teamwork in Brazil</h4>
                                        <p>In Laguna, Brazil, a group of bottlenose dolphins has a special relationship with local fishermen. The water is very muddy, so the men cannot see the fish. The dolphins work as a team to drive the fish towards the shore. Then, they give a signal‚Äîa slap on the water. This tells the men to throw their nets. The dolphins <strong>assist</strong> the men, and in return, they eat the fish that escape the nets. This cooperation gives both the men and the dolphins a huge <strong>advantage</strong>.</p>
                                    </div>
                                </div>` } },
                { id: 'reading-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Data Check: Gap Fill', sentences: [] } },
                { id: 'reading-quiz-tfng', type: 'quiz-tfng', content: { title: 'Data Check: True/False', questions: [] } },
                
                // LESSON 3: Reading 1B
                { id: 'lecture-uni', type: 'dialogue', content: { title: 'Research Source B: The Octopus <span aria-hidden="true">üêô</span>', dialogue: `Professor: Today we shift from social intelligence to solitary intelligence. Let's look at the octopus. Unlike the dolphin, the octopus lives alone. It is an invertebrate, meaning it has no bones. This allows it to squeeze its body into tiny spaces to <strong>hide</strong> from predators.

Professor: But its most amazing ability is camouflage. An octopus can change its color, pattern, and even the texture of its skin in milliseconds. It does this to blend in with rocks or coral. It uses its <strong>appearance</strong> to survive.

Professor: Octopuses are also problem solvers. In labs, they have learned to open jars to get food inside. In the wild, they use coconut shells as mobile homes. They are truly the engineers of the ocean floor, <strong>developing</strong> complex ways to stay safe.` } },
                { id: 'lecture-uni-quiz-mcq', type: 'quiz-mcq', content: { title: 'Data Check: MCQ', questions: [] } },
                { id: 'lecture-uni-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Data Check: Gap Fill', sentences: [], wordBank: [] } },
                
                // LESSON 4: Video Data
                { id: 'podcast-convo', type: 'dialogue', content: { title: 'Research Source C: Chameleons <span aria-hidden="true">ü¶é</span>', dialogue: `Host 1: We just watched the video about Chameleons. I always thought they changed color to hide, like the octopus.

Host 2: That's a common myth! The video explained that while they can blend in, they mostly change color to regulate their temperature or to communicate their mood.

Host 1: Right! If they are cold, they turn dark to absorb heat. If they are angry or trying to attract a mate, they turn bright colors.

Host 2: It's amazing. They have special skin cells called chromatophores. They expand or contract these cells to mix colors, kind of like paint.

Host 1: So, the Octopus changes to hide (survival), but the Chameleon changes to talk (communication). Both are using the same biological mechanism but for different reasons. Nature is incredible.` } },
                { id: 'podcast-convo-quiz-mcq', type: 'quiz-mcq', content: { title: 'Data Check: MCQ', questions: [] } },

                // LESSON 5: Vocabulary (The Tools)
                { id: 'vocab-start', type: 'simple', content: { title: 'Lesson 5: Acquiring Tools <span aria-hidden="true">üìö</span>', text: 'You have the data. Now you need the professional words ("Bricks") to describe it. Click "Next" to build your toolkit.' } },
                
                // LESSON 6: Vocab Game
                { id: 'vocab-game', type: 'vocab-game', content: { title: 'Lesson 6: Tool Practice <span aria-hidden="true">üéÆ</span>'} },

                // LESSON 7: Biomimicry (Development)
                { id: 'biomimicry-1', type: 'html-content', content: { title: 'Lesson 7: Nature\'s Blueprints <span aria-hidden="true">üöÖ</span>', html: `
                    <div class="text-left space-y-6">
                        <div class="bg-amber-50 p-4 rounded-lg border-l-4 border-amber-500">
                            <h3 class="text-xl font-bold text-amber-800">What is Biomimicry?</h3>
                            <p>Biomimicry is the practice of learning from and mimicking the strategies found in nature to solve human design challenges.</p>
                        </div>

                        <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm">
                            <h4 class="font-bold text-lg text-teal-700 mb-2">Case Study 1: The "Sticky" Seed</h4>
                            <p class="text-sm text-gray-600 mb-2"><strong>Nature:</strong> Burdock Burr | <strong>Engineering:</strong> Velcro</p>
                            <p class="mb-2"><strong>The Story:</strong> In 1941, engineer George de Mestral noticed sticky burrs on his dog's fur after a hike.</p>
                            <p class="mb-2"><strong>The Mechanism:</strong> Under a microscope, he saw hundreds of tiny hooks that caught onto loops in fabric. He copied this to create the "hook-and-loop" fastener.</p>
                            <p><strong>Impact:</strong> Replaced zippers in space suits (NASA) and sneakers.</p>
                        </div>
                    </div>
                ` } },
                { id: 'biomimicry-2', type: 'html-content', content: { title: 'Case Study 2: The Silent Train <span aria-hidden="true">üöÖ</span>', html: `
                    <div class="text-left space-y-6">
                        <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm">
                            <h4 class="font-bold text-lg text-teal-700 mb-2">Case Study 2: The Silent Train</h4>
                            <p class="text-sm text-gray-600 mb-2"><strong>Nature:</strong> Kingfisher Bird | <strong>Engineering:</strong> Bullet Train</p>
                            <p class="mb-2"><strong>The Problem:</strong> Japan's high-speed trains made a loud "sonic boom" when exiting tunnels due to air pressure.</p>
                            <p class="mb-2"><strong>The Solution:</strong> Engineer Eiji Nakatsu mimicked the Kingfisher's beak, which dives into water without a splash.</p>
                            <p><strong>The Engineering:</strong> Nakatsu‚Äôs team redesigned the nose of the 500 Series train to mimic the Kingfisher‚Äôs beak‚Äîa sharp, wedge-like shape that gradually increases in diameter.</p>
                            <p><strong>Results:</strong> 10% faster, 15% less electricity, and the noise was eliminated.</p>
                        </div>
                    </div>
                ` } },
                { id: 'lecture-expert-quiz-tfng', type: 'quiz-tfng', content: { title: 'Analysis Check: True/False', questions: [] } },
                { id: 'lecture-expert-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Analysis Check: Gap Fill', sentences: [], wordBank: [] } },

                // LESSON 8: Project Launch
                { id: 'podcast-futures', type: 'html-content', content: { title: 'Lesson 8: The Bug List <span aria-hidden="true">üìù</span>', html: `
                                <div class="text-left space-y-4">
                                    <h3 class="text-2xl font-bold text-orange-600 mb-3">Your Mission: Invention</h3>
                                    <p>Designers start with a problem. We call this a <strong>Bug List</strong>‚Äîthings that "bug" or annoy you in daily life.</p>
                                    <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500">
                                        <p class="font-bold">Examples:</p>
                                        <ul class="list-disc list-inside">
                                            <li>"I hate waking up in the morning."</li>
                                            <li>"My backpack is too heavy."</li>
                                            <li>"I lose my friends in the crowded mall."</li>
                                        </ul>
                                    </div>
                                    <p><strong>Step 1:</strong> List 3 problems.</p>
                                    <p><strong>Step 2:</strong> Choose an animal superpower (Dolphin teamwork, Octopus hiding, Chameleon color change) that could solve it.</p>
                                    <p><em>Example: "I lose my friends" + "Dolphin Whistle" = A phone app that emits a special signal to find friends without wifi.</em></p>
                                </div>` } },

                // LESSON 9: Comparison
                { id: 'debate-planning', type: 'dialogue', content: { title: 'Lesson 9: Compare Strategies <span aria-hidden="true">‚öñÔ∏è</span>', dialogue: `Teacher: Let's compare our two main animals. Jane, tell me about the Dolphin.

Jane: The dolphin is a social mammal. Its main survival strategy is teamwork and communication. It relies on others.

Teacher: Jack, what about the Octopus?

Jack: The octopus is the opposite. It is a solitary invertebrate. It relies on itself. Its strategy is camouflage and using tools.

Teacher: Which strategy is better?

Jane: Teamwork is better because you can catch more fish and stay safe from sharks.

Jack: But if you are alone and can hide perfectly, you don't need help. Being quiet is safer than being loud.

Teacher: Excellent points. For your inventions, think: Do you want a device that connects people (Dolphin) or one that protects/hides people (Octopus)?` } },
                { id: 'debate-planning-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comparison Quiz', questions: [] } },

                // LESSON 10: Ethics
                { id: 'dilemma-ethics', type: 'dialogue', content: { title: 'Lesson 10: Ethical Dilemma <span aria-hidden="true">‚ö†Ô∏è</span>', dialogue: `Guide: In Laguna, the dolphins help the fishermen. But imagine this scenario. One year, the dolphins stop coming. The fishermen catch very few fish. Their families are hungry.

Guide: Suddenly, the dolphins return, but they don't help. They just play near the nets. The fishermen have a choice. Do they throw the nets anyway, risking hurting the dolphins to feed their families? Or do they wait and go hungry?

Jane: They should wait. The dolphins are intelligent partners. If you hurt them, they will never help again. It's a long-term loss.

Jack: But their families are hungry today. Survival is the most important instinct. I think they might try to catch fish, even if the dolphins are in the way.` } },
                { id: 'dilemma-ethics-quiz-mcq', type: 'quiz-mcq', content: { title: 'Dilemma Quiz (MCQ)', questions: [] } },

                // LESSON 11: Final Project
                { id: 'final-project-hub', type: 'html-content', content: { title: 'Lesson 11: The Launch <span aria-hidden="true">‚úçÔ∏è</span>', html: `
                                <div class="bg-white rounded-2xl shadow-xl p-8 text-left">
                                <h2 class="text-3xl font-bold text-violet-600 mb-4">GRASPS Task: The Biomimicry Pitch</h2>
                                <div class="space-y-3 text-lg">
                                    <p><strong class="font-semibold text-violet-700">Goal:</strong> Pitch a new invention inspired by nature.</p>
                                    <p><strong class="font-semibold text-violet-700">Role:</strong> You are an Inventor.</p>
                                    <p><strong class="font-semibold text-violet-700">Audience:</strong> Investors (your classmates).</p>
                                    <p><strong class="font-semibold text-violet-700">Situation:</strong> You need funding to build your "Nature-Inspired Solution."</p>
                                    <p><strong class="font-semibold text-violet-700">Product:</strong> A 1-minute speech and a generated image of your product.</p>
                                </div>
                                <div class="mt-8 bg-violet-50 p-6 rounded-lg border border-violet-200">
                                    <h3 class="text-2xl font-bold text-violet-700 mb-3">Student Project Scaffold: The "Bio-Hacker" One-Pager</h3>
                                    <ul class="list-decimal list-inside space-y-3 text-lg">
                                        <li><strong>My Human Problem:</strong> (e.g., "I constantly drop my phone.")</li>
                                        <li><strong>My Animal Mentor:</strong> (e.g., "The Gecko.")</li>
                                        <li><strong>The Biological Mechanism:</strong> (e.g., "Tiny hairs on feet for molecular grip.")</li>
                                        <li><strong>My Invention:</strong> (e.g., "The Gecko-Grip Phone Case.")</li>
                                        <li><strong>Vocabulary Usage:</strong> "This case gives users an <em>advantage</em> because it mimics the creature's <em>ability</em> to hold on."</li>
                                    </ul>
                                </div>
                                <div class="mt-8">
                                    <h3 class="text-2xl font-bold text-violet-600 mb-3">My Invention Idea <span aria-hidden="true">üí°</span></h3>
                                    <textarea id="field-notes" class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="My Problem: ... \nMy Animal Inspiration: ... \nMy Invention Name: ..."></textarea>
                                </div>
                                </div>` } },
                { id: 'writing-task', type: 'writing-task', content: { 
                    title: 'The Pitch Script <span aria-hidden="true">üé§</span>', 
                    prompt: 'Write your 1-minute pitch. Use the grammar structure: "My invention uses [noun] to [verb]." Include at least 2 key vocabulary words (e.g., advantage, assist, method).',
                    starters: [
                        "Hello investors, my name is...",
                        "Have you ever had the problem of...",
                        "My solution is inspired by the incredible...",
                        "This invention gives you the advantage of..."
                    ],
                    wordBank: ['intelligent', 'assist', 'method', 'advantage', 'camouflage', 'survive', 'develop', 'appearance']
                } },
                { id: 'self-assessment', type: 'html-content', content: { title: 'Self-Assessment <span aria-hidden="true">üßë‚Äçüè´</span>', html: `
                                <div class="text-left">
                                    <h3 class="text-2xl font-bold text-purple-600 mb-3">Metacognitive Self-Assessment</h3>
                                    <ol class="list-decimal list-inside space-y-4 text-xl">
                                        <li>"Which animal is the best engineer: Dolphin, Octopus, or Kingfisher? Why?"</li>
                                        <li>"How did learning about nature change how I look at design problems?"</li>
                                        <li>"Thinking about the Chameleon, how is its use of color change different from the Octopus? Which one would you rather have as a superpower?"</li>
                                    </ol>
                                </div>` } },
                { id: 'certificate', type: 'certificate', content: { title: 'Unit Complete! <span aria-hidden="true">üéâ</span>', text: 'You have successfully completed "Amazing Animals".' } }
            ]
        };
        // --- END OF LESSON CONTENT CONFIGURATION ---
        // ===================================================================================

        class SpeechService {
             constructor() { this.synth = window.speechSynthesis; this.isInitialized = false; this.isTtsEnabled = true; this.voices = {}; this.speechRate = 0.85; this.isDialoguePlaying = false; }
             async _setupVoices() {
                 const voicesPromise = new Promise(resolve => { if (this.synth.getVoices().length) return resolve(this.synth.getVoices()); this.synth.onvoiceschanged = () => resolve(this.synth.getVoices()); });
                 const availableVoices = await voicesPromise;
                 if (!availableVoices.length) { console.warn("No speech synthesis voices available."); return; }
                 
                 const speakerToVoiceMap = {
                     'teacher': ['Microsoft Emma Online (Natural) - English (United States)'],
                     'professor': ['Microsoft Brian Online (Natural) - English (United States)'],
                     'host 1': ['Microsoft Emma Online (Natural) - English (United States)'],
                     'host 2': ['Microsoft Andrew Online (Natural) - English (United States)'],
                     'engineer': ['Microsoft Ava Online (Natural) - English (United States)'],
                     'student': ['Microsoft Andrew Online (Natural) - English (United States)'],
                     'jane': ['Microsoft Emma Online (Natural) - English (United States)'],
                     'jack': ['Microsoft Brian Online (Natural) - English (United States)'],
                     'guide': ['Microsoft Brian Online (Natural) - English (United States)']
                 };
                 for (const speaker in speakerToVoiceMap) {
                     const voicePriorityList = speakerToVoiceMap[speaker];
                     let chosenVoice = null;
                     for (const voiceName of voicePriorityList) {
                         const foundVoice = availableVoices.find(v => v.name === voiceName);
                         if (foundVoice) { chosenVoice = foundVoice; break; }
                     }
                     if (chosenVoice) { this.voices[speaker] = chosenVoice; }
                 }
                 this.voices['default'] = availableVoices.find(v => v.name === 'Microsoft Ava Online (Natural) - English (United States)') || availableVoices.find(v => v.lang === 'en-US') || availableVoices[0];
             }
             async init() { if (this.isInitialized) return; try { const warmUp = new SpeechSynthesisUtterance(' '); warmUp.volume = 0; this.synth.speak(warmUp); this.synth.cancel(); await this._setupVoices(); this.isInitialized = true; } catch (e) { console.error("Speech init failed", e); } }
             _cleanTextForSpeech(text) { const tempDiv = document.createElement('div'); const textWithoutSpans = text.replace(/<span aria-hidden="true">.*?<\/span>/g, ' '); tempDiv.innerHTML = textWithoutSpans; return tempDiv.innerText || tempDiv.textContent || ''; }
             async speak(text, { onEndCallback = null } = {}) { if (!this.isInitialized || !this.isTtsEnabled || !text) { if (onEndCallback) onEndCallback(); return; } if (this.synth.speaking) { this.cancel(); } const utterance = new SpeechSynthesisUtterance(this._cleanTextForSpeech(text)); utterance.voice = this.voices['default']; utterance.rate = this.speechRate; if (onEndCallback) utterance.onend = onEndCallback; this.synth.speak(utterance); }
             async speakDialogue(text) { if (!this.isInitialized || !this.isTtsEnabled || !text || this.isDialoguePlaying) return; this.cancel(); this.isDialoguePlaying = true; const lines = text.split('\n\n'); const speakLine = (index) => { if (index >= lines.length || !this.isDialoguePlaying) { this.isDialoguePlaying = false; return; } const line = lines[index]; const [speaker, ...rest] = line.split(': '); const lineText = rest.join(': '); const utterance = new SpeechSynthesisUtterance(this._cleanTextForSpeech(lineText || speaker)); utterance.voice = this.voices[speaker.trim().toLowerCase()] || this.voices['default']; utterance.rate = this.speechRate; utterance.onend = () => speakLine(index + 1); this.synth.speak(utterance); }; speakLine(0); }
             cancel() { if (this.synth) { this.isDialoguePlaying = false; this.synth.cancel(); } }
             toggleTTS(forceState) { this.isTtsEnabled = forceState === undefined ? !this.isTtsEnabled : forceState; if (!this.isTtsEnabled) { this.cancel(); } return this.isTtsEnabled; }
         }

        // --- Global App State and Functions ---
        const speechService = new SpeechService();
        let score = 0, currentPage = lessonData.startPageId, timerInterval;
        const pageHistory = [lessonData.startPageId];
        let pageSequence = [];
        let completedSections = new Set();
        let vocabGameTimer;
        
        // --- Reward Animation Globals ---
        let particles = [];
        let rewardAfHandle = null;

        function spawnRewardAnimation(x, y) {
            const numParticles = 40; 
            const container = document.getElementById('reward-animation-container');
            if (!container) return;
            
            for (let i = 0; i < numParticles; i++) {
                const el = document.createElement('div');
                el.classList.add('particle');
                
                let type;
                if (Math.random() < 0.15) { 
                    type = 'chocolate';
                    el.classList.add('chocolate');
                    el.textContent = 'üåø'; // Leaf for points
                } else {
                    type = 'glitter';
                    el.classList.add('glitter');
                    if (Math.random() < 0.5) el.classList.add('alt'); 
                }

                // Use viewport coordinates
                const particle = {
                    el: el,
                    x: x, 
                    y: y, 
                    vx: (Math.random() - 0.5) * 12, 
                    vy: (Math.random() * -10) - 5, 
                    life: 60 + Math.random() * 60, 
                    gravity: 0.2,
                    friction: 0.98,
                    type: type
                };

                particles.push(particle);
                container.appendChild(el);
            }

            if (!rewardAfHandle) {
                rewardAfHandle = requestAnimationFrame(animateParticles);
            }
        }

        function animateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.vx *= p.friction; p.vy += p.gravity; p.x += p.vx; p.y += p.vy; p.life--;

                if (p.life <= 0) {
                    p.el.remove(); particles.splice(i, 1);
                } else {
                    if (p.life < 20) p.el.style.opacity = p.life / 20;
                    if (p.type === 'chocolate') p.el.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${p.x}deg)`;
                    else p.el.style.transform = `translate(${p.x}px, ${p.y}px)`;
                }
            }
            if (particles.length > 0) rewardAfHandle = requestAnimationFrame(animateParticles);
            else rewardAfHandle = null; 
        }

        // --- Sound Effect Helpers ---
        function playCorrectSound() { if (typeof Tone !== 'undefined') { try { const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease("C5", "8n"); } catch (e) { console.error("Tone.js sound failed:", e); } } }
        function playIncorrectSound() { if (typeof Tone !== 'undefined') { try { const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease("C3", "8n"); } catch (e) { console.error("Tone.js sound failed:", e); } } }


        // --- Progress and Completion Logic ---
        const pageToMenuMap = {};
        function buildPageToMenuMap() {
            lessonData.mainMenu.forEach(menuItem => {
                let queue = [menuItem.target];
                let visited = new Set(queue);
                while (queue.length > 0) {
                    const pageId = queue.shift();
                    pageToMenuMap[pageId] = menuItem.id;
                    const pageDef = lessonData.pages.find(p => p.id === pageId);
                    if (pageDef && pageDef.type.startsWith('quiz')) {
                        const nextQuizPage = getNextQuizPage(pageId);
                        if (nextQuizPage && !visited.has(nextQuizPage)) {
                            queue.push(nextQuizPage);
                            visited.add(nextQuizPage);
                        }
                    }
                }
            });
            pageToMenuMap['vocab-game'] = 'menu-vocab-game';
        }

        function getNextQuizPage(pageId) {
            const sequence = ['mcq', 'tfng', 'gap-fill'];
            const parts = pageId.split('-quiz-');
            if (parts.length < 2) return null;
            const prefix = parts[0];
            const type = parts[1];
            const currentIndex = sequence.indexOf(type);
            if (currentIndex > -1 && currentIndex < sequence.length - 1) {
                const nextPageId = `${prefix}-quiz-${sequence[currentIndex + 1]}`;
                if (lessonData.pages.find(p => p.id === nextPageId)) return nextPageId;
            }
            return null;
        }

        function updateProgressBar() {
            const progress = (completedSections.size / lessonData.mainMenu.length) * 100;
            const bar = document.getElementById('progress-bar');
            if (bar) bar.style.width = `${progress}%`;
        }

        function updateMenuCompletionState() {
            const menuContainer = document.getElementById('page-main-menu');
            if (!menuContainer) return;
            lessonData.mainMenu.forEach(item => {
                const button = menuContainer.querySelector(`#menu-btn-${item.id}`);
                if (button && completedSections.has(item.id)) {
                    if (!button.innerHTML.includes('‚úì')) button.innerHTML += ' <span class="text-green-300">‚úì</span>';
                }
            });
        }

        function markSectionAsComplete(pageId) {
            const menuId = pageToMenuMap[pageId];
            if (menuId && !completedSections.has(menuId)) {
                completedSections.add(menuId);
                updateProgressBar();
            }
        }
        
        function checkQuizPageCompletion(pageId) {
            const pageElement = document.getElementById(`page-${pageId}`);
            if (!pageElement) return false;
            if (pageId.includes('gap-fill')) {
                const gaps = pageElement.querySelectorAll('.gap');
                return gaps.length > 0 && Array.from(gaps).every(g => g.classList.contains('correct'));
            } else {
                const questions = pageElement.querySelectorAll('.question-group');
                return questions.length > 0 && Array.from(questions).every(q => q.querySelector('button:disabled'));
            }
        }


        // --- App Navigation ---
        window.toggleTTS = (button) => {
            const isNowEnabled = speechService.toggleTTS();
            const iconPath = isNowEnabled 
                ? "M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"
                : "M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z M17 14l-4-4m0 4l4-4";
            button.querySelector('svg').classList.toggle('text-gray-600', isNowEnabled);
            button.querySelector('svg').classList.toggle('text-gray-400', !isNowEnabled);
            button.querySelector('path').setAttribute('d', iconPath);

            if (isNowEnabled) {
                const pageData = lessonData.pages.find(p => p.id === currentPage);
                const targetPage = document.getElementById(`page-${currentPage}`);
                if (pageData && pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else if (targetPage) {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    if (readableContent) speechService.speak(readableContent.innerText);
                    else if (titleElement) speechService.speak(titleElement.innerText);
                }
            }
        };

        window.startApp = async function() {
            await speechService.init(); 
            try { await Tone.start(); } catch (e) { console.error(e); }
            navigateTo(lessonData.homePageId);
        }
        
        function startTimer(duration, display, onComplete) {
            let timer = duration;
            const update = () => { display.textContent = `${String(Math.floor(timer/60)).padStart(2,'0')}:${String(timer%60).padStart(2,'0')}`; };
            update();
            timerInterval = setInterval(() => { timer--; update(); if (timer < 0) { clearInterval(timerInterval); if (onComplete) onComplete(); } }, 1000);
        }

        window.navigateTo = (pageId) => {
            const previousPageId = currentPage;
            
            // Mark completion if leaving a quiz page and it's fully answered
            if (previousPageId.includes('-quiz-')) {
                if (checkQuizPageCompletion(previousPageId)) markSectionAsComplete(previousPageId);
            }
            
            const targetPage = document.getElementById(`page-${pageId}`);
            if (!targetPage) return console.warn('navigateTo: no page found for id', pageId);
            if (pageId === currentPage) return;
            
            clearInterval(timerInterval);
            clearTimeout(vocabGameTimer);
            speechService.cancel();

            const previousPageDef = lessonData.pages.find(p => p.id === previousPageId);
            if (previousPageDef && !previousPageDef.type.startsWith('quiz') && previousPageId !== 'vocab-game') {
                 markSectionAsComplete(previousPageId);
            }

            document.getElementById(`page-${currentPage}`)?.classList.remove('active');
            targetPage.classList.add('active');
            currentPage = pageId;
            if (pageHistory[pageHistory.length - 1] !== currentPage) pageHistory.push(currentPage);
            
            const pageData = lessonData.pages.find(p => p.id === pageId);
            if (pageData) {
                if (pageData.type === 'timer') {
                    const timerEl = document.getElementById(pageData.content.timerId);
                    if (timerEl) startTimer(pageData.content.duration, timerEl, goNext);
                } else if (pageData.type === 'vocab-game') {
                    startVocabGame();
                } else if (pageId === 'certificate') {
                    startConfetti();
                    showBadgeToast('üéâ Module Complete! Well done! üéâ');
                }
                
                if (pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    const contentToSpeak = readableContent ? readableContent.innerText : (titleElement ? titleElement.innerText : '');
                    speechService.speak(contentToSpeak);
                }
            } else if (pageId === lessonData.homePageId) {
                speechService.speak(targetPage.querySelector('h2').innerText);
                updateMenuCompletionState();
            }
            updateNavButtons();
            window.scrollTo(0, 0);
        }

        window.goNext = () => { const currentIndex = pageSequence.indexOf(currentPage); if (currentIndex > -1 && currentIndex < pageSequence.length - 1) navigateTo(pageSequence[currentIndex + 1]); }
        window.goBack = () => { if (pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); } }

        function updateNavButtons() {
            const nav = document.getElementById('nav-header');
            if (!nav) return;
            nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
            const backBtn = nav.querySelector('button:first-child');
            backBtn.disabled = pageHistory.length <= 1;
            backBtn.classList.toggle('opacity-50', backBtn.disabled);
            const nextBtn = nav.querySelector('button:last-child');
            const currentIndex = pageSequence.indexOf(currentPage);
            const isLast = currentIndex >= pageSequence.length - 1;
            nextBtn.disabled = isLast || currentPage === lessonData.homePageId;
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }
        
        function showFeedbackMessage(isCorrect) {
            const correctFeedback = ["That's right!", "Excellent!", "Perfect!", "Great job!"];
            const incorrectFeedback = ["Not quite.", "Keep trying!", "Almost there."];
            const message = isCorrect ? correctFeedback[Math.floor(Math.random() * correctFeedback.length)] : incorrectFeedback[Math.floor(Math.random() * incorrectFeedback.length)];
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `feedback-toast ${isCorrect ? 'correct' : 'encouraging'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showBadgeToast(message) {
            const toast = document.createElement('div');
            toast.innerHTML = message;
            toast.className = 'badge-toast';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000); 
        }

        function updateScore(points) { score += points; document.getElementById('score-display').textContent = score; }

        function checkCompletionAndMark() {
            if(checkQuizPageCompletion(currentPage)) markSectionAsComplete(currentPage);
        }

        window.checkTfngAnswer = function(clickedButton, chosenAnswer, correctAnswer) {
            const buttonContainer = clickedButton.parentElement;
            Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
            const isCorrect = chosenAnswer === correctAnswer;
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                playCorrectSound();
                updateScore(10);
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-green-500');
                const rect = clickedButton.getBoundingClientRect();
                spawnRewardAnimation(rect.left + rect.width / 2, rect.top + rect.height / 2);
            } else {
                playIncorrectSound();
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-red-600');
                const correctBtn = Array.from(buttonContainer.children).find(btn => btn.textContent === correctAnswer.charAt(0));
                if (correctBtn) correctBtn.className = correctBtn.className.replace(/bg-\w+-500/, 'bg-green-500');
            }
            setTimeout(checkCompletionAndMark, 100);
        }
        
        window.checkMcqAnswer = function(button, isCorrect) {
            const questionGroup = button.closest('.question-group');
            questionGroup.querySelectorAll('.quiz-option').forEach(opt => opt.disabled = true);
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                playCorrectSound();
                updateScore(10);
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'border-green-600', 'text-white');
                const rect = button.getBoundingClientRect();
                spawnRewardAnimation(rect.left + rect.width / 2, rect.top + rect.height / 2);
            } else {
                playIncorrectSound();
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'border-red-600', 'text-white', 'shake');
                const correctButton = questionGroup.querySelector(".quiz-option[data-correct='true']");
                if (correctButton) {
                    correctButton.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    correctButton.classList.add('bg-green-500', 'border-green-600', 'text-white');
                }
            }
            setTimeout(checkCompletionAndMark, 100);
        }

        function initGapFill(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return;
            
            let selectedWord = { element: null, text: '' }; 

            const gaps = page.querySelectorAll('.gap');
            const words = page.querySelectorAll('.word-bank-word');
            const wordBank = page.querySelector('.word-bank-container');

            words.forEach(word => {
                word.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', word.dataset.word); });
                word.addEventListener('click', handleWordClick);
            });
            gaps.forEach(gap => {
                gap.addEventListener('dragover', e => e.preventDefault());
                gap.addEventListener('drop', e => handleDrop(e, gap));
                gap.addEventListener('click', handleGapClick);
            });

            function handleWordClick(e) {
                const clickedWord = e.currentTarget;
                if (clickedWord.parentElement.classList.contains('gap')) { wordBank.appendChild(clickedWord); return; }
                if (selectedWord.element) selectedWord.element.classList.remove('selected');
                if (selectedWord.element === clickedWord) { selectedWord = { element: null, text: '' }; } 
                else { selectedWord = { element: clickedWord, text: clickedWord.dataset.word }; clickedWord.classList.add('selected'); }
            }
            function handleGapClick(e) {
                const clickedGap = e.currentTarget;
                if (!selectedWord.element || clickedGap.children.length > 0) return;
                clickedGap.appendChild(selectedWord.element);
                checkGap(clickedGap);
                selectedWord.element.classList.remove('selected');
                selectedWord = { element: null, text: '' };
            }
            function handleDrop(e, gap) {
                e.preventDefault();
                if (gap.children.length > 0) return;
                const wordText = e.dataTransfer.getData('text/plain');
                const wordElement = page.querySelector(`.word-bank-word[data-word="${wordText}"]`);
                if (wordElement) { gap.appendChild(wordElement); checkGap(gap); }
            }
            function checkGap(gap) {
                const word = gap.querySelector('.word-bank-word');
                const isCorrect = word && word.dataset.word.toLowerCase() === gap.dataset.answer.toLowerCase();
                gap.classList.toggle('correct', isCorrect);
                gap.classList.toggle('incorrect', !isCorrect);
                if (isCorrect) { 
                    playCorrectSound();
                    updateScore(10); 
                    showFeedbackMessage(true); 
                    const rect = gap.getBoundingClientRect();
                    spawnRewardAnimation(rect.left + rect.width / 2, rect.top + rect.height / 2);
                } else { 
                    playIncorrectSound();
                    showFeedbackMessage(false); 
                }
                setTimeout(checkCompletionAndMark, 100);
            }
        }

        // --- Vocab Game Logic ---
        let vocabGameQuestions = [];
        let vocabGameCurrentIndex = 0;
        let vocabGameScore = 0;
        const ROUND_TIME = 10000;

        function startVocabGame() {
            vocabGameQuestions = [...lessonData.vocabulary].sort(() => 0.5 - Math.random());
            vocabGameCurrentIndex = 0;
            vocabGameScore = 0;
            document.getElementById('vocab-game-score').textContent = '0';
            nextVocabGameRound();
        }

        function nextVocabGameRound() {
            if (vocabGameCurrentIndex >= vocabGameQuestions.length) {
                endVocabGame();
                return;
            }
            
            const question = vocabGameQuestions[vocabGameCurrentIndex];
            document.getElementById('vocab-game-definition').textContent = question.def;
            
            const options = [question.word];
            const wrongAnswers = lessonData.vocabulary.filter(v => v.word !== question.word);
            while (options.length < 4 && wrongAnswers.length > 0) {
                const randomWrong = wrongAnswers.splice(Math.floor(Math.random() * wrongAnswers.length), 1)[0];
                options.push(randomWrong.word);
            }
            
            const optionsContainer = document.getElementById('vocab-game-options');
            optionsContainer.innerHTML = '';
            options.sort(() => 0.5 - Math.random()).forEach(opt => {
                const button = document.createElement('button');
                button.className = 'quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200';
                button.textContent = opt;
                button.onclick = () => checkVocabGameAnswer(button, opt === question.word);
                optionsContainer.appendChild(button);
            });

            startRoundTimer();
        }
        
        function startRoundTimer() {
            clearTimeout(vocabGameTimer);
            const timerBar = document.getElementById('vocab-game-timer-bar');
            timerBar.style.transition = 'none';
            timerBar.style.width = '100%';
            
            setTimeout(() => {
                timerBar.style.transition = `width ${ROUND_TIME / 1000}s linear`;
                timerBar.style.width = '0%';
            }, 100);

            vocabGameTimer = setTimeout(() => {
                showFeedbackMessage(false);
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, ROUND_TIME);
        }

        function checkVocabGameAnswer(button, isCorrect) {
            clearTimeout(vocabGameTimer);
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                playCorrectSound();
                vocabGameScore++;
                updateScore(5);
                document.getElementById('vocab-game-score').textContent = vocabGameScore;
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'text-white');
                const rect = button.getBoundingClientRect();
                spawnRewardAnimation(rect.left + rect.width / 2, rect.top + rect.height / 2);
            } else {
                playIncorrectSound();
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'text-white', 'shake');
            }
            
            const optionsContainer = document.getElementById('vocab-game-options');
            optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

            setTimeout(() => {
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, 1500);
        }

        function endVocabGame() {
            document.getElementById('vocab-game-definition').textContent = `Game Over! You scored ${vocabGameScore} out of ${vocabGameQuestions.length}.`;
            document.getElementById('vocab-game-options').innerHTML = `<button onclick="startVocabGame()" class="action-button bg-blue-500 text-white font-bold p-3 rounded-lg">Play Again</button>`;
            markSectionAsComplete('vocab-game');
        }

        window.printCertificate = function() { window.print(); }
        
        window.downloadCertificate = function() {
            const certElement = document.getElementById('certificate-to-print');
            if (!certElement) { console.error('Certificate element not found'); return; }
            certElement.classList.add('shadow-2xl', 'border-2', 'border-yellow-500');
            html2canvas(certElement, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = 'AmazingAnimals_Certificate.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                certElement.classList.remove('shadow-2xl', 'border-2', 'border-yellow-500');
            }).catch(err => {
                console.error('Failed to download certificate:', err);
                certElement.classList.remove('shadow-2xl', 'border-2', 'border-yellow-500');
            });
        }

        function startConfetti() {
            const canvas = document.getElementById('completion-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            if (canvas.parentElement) {
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
            } else {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            let confetti = [];
            const colors = ['#fde047', '#f97316', '#38bdf8', '#22c55e', '#6366f1'];
            
            for (let i = 0; i < 100; i++) {
                confetti.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height, 
                    size: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * 2 * Math.PI,
                });
            }
            
            let animationFrameId;
            function drawConfetti() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                confetti.forEach((p, i) => {
                    p.y += p.speed;
                    p.x += Math.sin(p.angle);
                    p.angle += 0.05;
                    
                    if (p.y > canvas.height) confetti.splice(i, 1);
                    
                    ctx.save();
                    ctx.fillStyle = p.color;
                    ctx.translate(p.x + p.size / 2, p.y + p.size / 2);
                    ctx.rotate(p.angle);
                    ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                    ctx.restore();
                });
                
                if (confetti.length > 0) animationFrameId = requestAnimationFrame(drawConfetti);
                else { ctx.clearRect(0, 0, canvas.width, canvas.height); cancelAnimationFrame(animationFrameId); }
            }
            drawConfetti();
        }


        function createPageElement(id, content) {
            const section = document.createElement('section');
            section.id = `page-${id}`;
            section.className = 'page';
            section.innerHTML = content;
            document.getElementById('dynamic-pages-container').appendChild(section);
        }
        
        function populateAllQuizzes() {
            // 3. Reading 1A: Dolphins
            const readingGapFill = lessonData.pages.find(p => p.id === 'reading-quiz-gap-fill');
            if (readingGapFill) {
                readingGapFill.content.sentences = [
                    { text: ['Dolphins use whistles to', 'with each other.'], answer: 'communicate' },
                    { text: ['In Brazil, dolphins', 'the fishermen by driving fish to shore.'], answer: 'assist' },
                    { text: ['Working together gives the dolphins and men an', '.'], answer: 'advantage' },
                    { text: ['Dolphins are', 'animals that can learn complex tasks.'], answer: 'intelligent' },
                    { text: ['Catching seaweed is a game that shows dolphins have', '.'], answer: 'feelings' }
                ];
                readingGapFill.content.wordBank = ['communicate', 'assist', 'advantage', 'intelligent', 'feelings'];
            }
            const readingTfng = lessonData.pages.find(p => p.id === 'reading-quiz-tfng');
            if(readingTfng) readingTfng.content.questions = [
                { statement: 'Dolphins are a type of fish.', correctAnswer: 'False' },
                { statement: 'The dolphins in Brazil teach their babies how to help the fishermen.', correctAnswer: 'True' }, 
                { statement: 'The water in Laguna is very clear.', correctAnswer: 'False' },
                { statement: 'Dolphins signal the fishermen by jumping high in the air.', correctAnswer: 'False' }
            ];

            // 4. Reading 1B: Octopus (Lecture)
            const lectureMcq = lessonData.pages.find(p => p.id === 'lecture-uni-quiz-mcq');
            if(lectureMcq) lectureMcq.content.questions = [
                { question: 'Why can an octopus squeeze into tiny spaces?', options: ['It is very small.', 'It has no bones.', 'It is slippery.', 'It eats small food.'], correctAnswer: 'It has no bones.' },
                { question: 'How does an octopus use camouflage?', options: ['It hides behind rocks.', 'It changes its color and pattern.', 'It releases ink.', 'It swims very fast.'], correctAnswer: 'It changes its color and pattern.' },
                { question: 'What tool does the octopus use in the wild?', options: ['A hammer.', 'A coconut shell.', 'A fishing net.', 'A jar.'], correctAnswer: 'A coconut shell.' },
                { question: 'What word describes an animal that lives alone?', options: ['Social.', 'Friendly.', 'Solitary.', 'Invertebrate.'], correctAnswer: 'Solitary.' },
                { question: 'The professor calls octopuses the "________ of the ocean floor".', options: ['Kings', 'Engineers', 'Monsters', 'Ghosts'], correctAnswer: 'Engineers' }
            ];
            const lectureGap = lessonData.pages.find(p => p.id === 'lecture-uni-quiz-gap-fill');
            if(lectureGap) {
                lectureGap.content.sentences = [
                    { text: ['The octopus is a solitary', 'that lives alone.'], answer: 'creature' },
                    { text: ['It changes its', 'to match the rocks and coral.'], answer: 'appearance' },
                    { text: ['Camouflage helps the octopus to', 'from predators.'], answer: 'hide' },
                    { text: ['The octopus has the', 'to solve complex problems.'], answer: 'ability' },
                    { text: ['It can change the', 'of its skin to look bumpy or smooth.'], answer: 'pattern' }
                ];
                lectureGap.content.wordBank = ['creature', 'appearance', 'hide', 'ability', 'pattern'];
            }
            
            // 5. Video: Chameleons
            const convoMcq = lessonData.pages.find(p => p.id === 'podcast-convo-quiz-mcq');
            if(convoMcq) convoMcq.content.questions = [
                { question: 'What is the common myth about chameleons?', options: ['They cannot see well.', 'They only eat flies.', 'They change color mainly to hide.', 'They are dangerous.'], correctAnswer: 'They change color mainly to hide.' },
                { question: 'What is the REAL reason chameleons change color?', options: ['To hide.', 'To regulate temperature and show mood.', 'To scare birds.', 'To sleep.'], correctAnswer: 'To regulate temperature and show mood.' },
                { question: 'What happens if a chameleon is cold?', options: ['It turns white.', 'It turns dark to absorb heat.', 'It sleeps.', 'It runs away.'], correctAnswer: 'It turns dark to absorb heat.' },
                { question: 'What are the special skin cells called?', options: ['Chromatophores.', 'Pixels.', 'Scales.', 'Prisms.'], correctAnswer: 'Chromatophores.' },
                { question: 'How is the chameleon different from the octopus?', options: ['It is not intelligent.', 'It uses color for communication, not just hiding.', 'It lives in the water.', 'It has bones.'], correctAnswer: 'It uses color for communication, not just hiding.' }
            ];

            // 6. Biomimicry Case Studies
            const expertTfng = lessonData.pages.find(p => p.id === 'lecture-expert-quiz-tfng');
            if(expertTfng) expertTfng.content.questions = [
                { statement: 'Biomimicry means copying nature to solve human problems.', correctAnswer: 'True' },
                { statement: 'Velcro was inspired by a spider web.', correctAnswer: 'False' },
                { statement: 'The engineer found burrs on his dog\'s fur.', correctAnswer: 'True' },
                { statement: 'The bullet train was redesigned to look like a shark.', correctAnswer: 'False' },
                { statement: 'The new train design made it quieter and faster.', correctAnswer: 'True' }
            ];
            const expertGap = lessonData.pages.find(p => p.id === 'lecture-expert-quiz-gap-fill');
            if(expertGap) {
                expertGap.content.sentences = [
                    { text: ['Biomimicry is a', 'of learning from nature.'], answer: 'method' },
                    { text: ['The engineer saw how burrs stuck to fur and', 'Velcro.'], answer: 'developed' },
                    { text: ['The Kingfisher\'s beak helps it dive without making a', '.'], answer: 'splash' },
                    { text: ['The train\'s new shape reduced the', 'problem in tunnels.'], answer: 'noise' },
                    { text: ['Nature provides the blueprint for us to', 'new technology.'], answer: 'create' }
                ];
                expertGap.content.wordBank = ['method', 'developed', 'splash', 'noise', 'create'];
            }

            // 8. Comparative Analysis
            const debateMcq = lessonData.pages.find(p => p.id === 'debate-planning-quiz-mcq');
            if(debateMcq) debateMcq.content.questions = [
                { question: 'What is the main difference between the dolphin and the octopus?', options: ['One swims, one walks.', 'One is social, one is solitary.', 'One eats fish, one eats plants.', 'One is smart, one is not.'], correctAnswer: 'One is social, one is solitary.' },
                { question: 'What is the dolphin\'s main survival strategy?', options: ['Hiding.', 'Teamwork and communication.', 'Changing color.', 'Flying.'], correctAnswer: 'Teamwork and communication.' },
                { question: 'What is the octopus\'s main survival strategy?', options: ['Making loud noises.', 'Camouflage and hiding.', 'Swimming in groups.', 'Asking for help.'], correctAnswer: 'Camouflage and hiding.' },
                { question: 'Which animal is an "invertebrate"?', options: ['Dolphin.', 'Octopus.', 'Human.', 'Dog.'], correctAnswer: 'Octopus.' },
                { question: 'If you want to invent a "Social Network" app, which animal is the best inspiration?', options: ['Octopus.', 'Dolphin.', 'Rock.', 'Shark.'], correctAnswer: 'Dolphin.' }
            ];

            // 9. Ethics Dilemma
            const dilemmaMcq = lessonData.pages.find(p => p.id === 'dilemma-ethics-quiz-mcq');
            if(dilemmaMcq) dilemmaMcq.content.questions = [ 
                { question: 'What is the problem in the scenario?', options: ['The dolphins are attacking the boat.', 'The dolphins are present but not helping.', 'The nets are broken.', 'The fish are poisonous.'], correctAnswer: 'The dolphins are present but not helping.' }, 
                { question: 'What is Student 1\'s argument?', options: ['Catch the fish anyway.', 'Wait, because hurting the relationship is a long-term loss.', 'Feed the dolphins.', 'Go home.'], correctAnswer: 'Wait, because hurting the relationship is a long-term loss.' } 
            ];
        }

        function initializeLesson() {
            document.getElementById('main-title').innerHTML = lessonData.title;
            document.getElementById('main-subtitle').innerHTML = lessonData.subtitle;
            document.getElementById('main-svg-container').innerHTML = `<svg viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#0f766e;stop-opacity:1" /><stop offset="100%" style="stop-color:#0ea5e9;stop-opacity:1" /></linearGradient><filter id="shadow" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur in="SourceAlpha" stdDeviation="3"/><feOffset dx="2" dy="2" result="offsetblur"/><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><path d="M100,250 C120,180 180,150 220,160 S300,200 340,180 S400,100 450,120 S550,200 500,250 Z" fill="#22c55e" filter="url(#shadow)" /><path d="M50,150 Q100,100 150,150 T250,150 T350,150 Q400,100 450,150 T550,150" stroke="url(#grad1)" stroke-width="8" fill="none" stroke-linecap="round" opacity="0.8" /><text x="250" y="200" font-size="80" font-family="Inter, sans-serif">üê¨</text></svg>`;

            populateAllQuizzes();
            buildPageToMenuMap();

            const menuButtons = lessonData.mainMenu.map(item => {
                const colors = { green: 'bg-green-500 border-green-700', blue: 'bg-blue-500 border-blue-700', sky: 'bg-sky-500 border-sky-700', amber: 'bg-amber-500 border-amber-700', rose: 'bg-rose-500 border-rose-700', indigo: 'bg-indigo-500 border-indigo-700', purple: 'bg-purple-500 border-purple-700', violet: 'bg-violet-500 border-violet-700', red: 'bg-red-500 border-red-700', orange: 'bg-orange-500 border-orange-700', lime: 'bg-lime-500 border-lime-700', emerald: 'bg-emerald-500 border-emerald-700', teal: 'bg-teal-500 border-teal-700' };
                return `<button id="menu-btn-${item.id}" onclick="navigateTo('${item.target}')" class="btn-animated-3d ${colors[item.color] || colors['green']} text-white font-bold text-xl p-4 rounded-lg w-full text-left">${item.text}</button>`;
            }).join('');
            createPageElement(lessonData.homePageId, `<div class="bg-white rounded-2xl shadow-lg p-8"><h2 class="text-4xl font-bold text-center text-slate-800 mb-8">Main Menu</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${menuButtons}</div></div>`);
            
            const pageOrderMap = {
                'tps-start': ['tps-think'], 'tps-think': ['tps-pair'], 'tps-pair': ['tps-share'],
                'tps-share': ['learning-goals'],
                'learning-goals': ['reading-main'],
                'reading-main': ['reading-quiz-gap-fill'], 'reading-quiz-gap-fill': ['reading-quiz-tfng'], 'reading-quiz-tfng': ['lecture-uni'],
                'lecture-uni': ['lecture-uni-quiz-mcq'], 'lecture-uni-quiz-mcq': ['lecture-uni-quiz-gap-fill'], 'lecture-uni-quiz-gap-fill': ['podcast-convo'],
                'podcast-convo': ['podcast-convo-quiz-mcq'], 'podcast-convo-quiz-mcq': ['vocab-start'],
                'vocab-start': [...lessonData.vocabulary.map((v, i) => `vocab-${i}`), 'vocab-game'],
                'vocab-game': ['biomimicry-1'],
                'biomimicry-1': ['biomimicry-2'],
                'biomimicry-2': ['lecture-expert-quiz-tfng'], 'lecture-expert-quiz-tfng': ['lecture-expert-quiz-gap-fill'], 'lecture-expert-quiz-gap-fill': ['podcast-futures'],
                'podcast-futures': ['debate-planning'],
                'debate-planning': ['debate-planning-quiz-mcq'], 'debate-planning-quiz-mcq': ['dilemma-ethics'],
                'dilemma-ethics': ['dilemma-ethics-quiz-mcq'], 'dilemma-ethics-quiz-mcq': ['final-project-hub'],
                'final-project-hub': ['writing-task'],
                'writing-task': ['self-assessment'], 'self-assessment': ['certificate']
            };

            let flatPageList = [lessonData.startPageId];
            lessonData.mainMenu.forEach(item => {
                let queue = [item.target];
                let visited = new Set();
                while(queue.length > 0) {
                    let current = queue.shift();
                    if (visited.has(current)) continue;
                    const pageExists = lessonData.pages.find(p => p.id === current) || lessonData.vocabulary.find((v,i) => `vocab-${i}` === current) || current === 'vocab-game';
                    if (!pageExists || flatPageList.includes(current)) continue;
                    visited.add(current);
                    flatPageList.push(current);
                    if (pageOrderMap[current]) queue.push(...pageOrderMap[current]);
                }
            });
            pageSequence = [...new Set(flatPageList)];

            lessonData.vocabulary.forEach((v, i) => {
                createPageElement(`vocab-${i}`, `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h3 class="text-2xl font-bold text-sky-600 mb-2">Vocabulary</h3><h2 class="text-5xl font-bold text-gray-800 mb-4">${v.word}</h2><p class="text-2xl text-gray-600 mb-6">${v.def}</p><p class="text-xl text-gray-500 italic">e.g. "${v.sentence}"</p></div></div>`);
            });

            lessonData.pages.forEach(page => {
                let pageHTML = '';
                switch (page.type) {
                    case 'simple': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-gray-800 mb-6">${page.content.title}</h2><p class="text-2xl text-gray-600">${page.content.text}</p></div></div>`; break;
                    case 'timer': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-left pt-16"><div class="w-full flex justify-between items-center mb-4"><h2 class="text-2xl md:text-3xl font-bold text-gray-800">${page.content.title}</h2><span id="${page.content.timerId}" class="text-3xl font-bold text-blue-600 bg-blue-100 px-4 py-2 rounded-lg">00:00</span></div><div class="readable-content"><p class="text-xl text-gray-600">${page.content.text}</p></div></div>`; break;
                    case 'dialogue':
                    case 'html-content':
                        const contentHTML = page.type === 'html-content' ? page.content.html : 
                            (page.content.dialogue || '').split('\n\n').map(line => {
                                if (line.startsWith('Professor: ') || line.startsWith('Guide: ') || line.startsWith('Teacher: ')) {
                                    return `<p class="mb-4">${line.substring(line.indexOf(': ') + 2)}</p>`;
                                }
                                return `<p class="mb-4">${line.replace(/([^:]+):/, '<strong class="font-bold text-indigo-700">$1:</strong>')}</p>`;
                            }).join('');
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-slate-800 mb-6">${page.content.title}</h2><div class="readable-content text-xl max-w-2xl mx-auto">${contentHTML}</div></div>`;
                        break;
                    case 'vocab-game':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-sky-600 mb-4">${page.content.title}</h2><div class="text-center mb-4 text-2xl font-bold">Score: <span id="vocab-game-score" class="text-blue-600">0</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mb-4"><div id="vocab-game-timer-bar" class="bg-blue-600 h-2.5 rounded-full"></div></div><div class="bg-gray-50 p-6 rounded-lg min-h-[120px] flex items-center justify-center mb-6"><p id="vocab-game-definition" class="text-2xl text-center font-medium"></p></div><div id="vocab-game-options" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>`;
                        break;
                    case 'writing-task':
                        const startersHTML = page.content.starters.map(s => `<li class="text-gray-500">${s}</li>`).join('');
                        const wordBankHTML = page.content.wordBank ? `<div class="word-bank"><h4 class="text-violet-600">Word Bank:</h4><div class="word-bank-pills">${page.content.wordBank.map(w => `<span>${w}</span>`).join('')}</div></div>` : '';
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-center text-violet-700 mb-6">${page.content.title}</h2><div class="text-left max-w-2xl mx-auto"><p class="text-xl text-gray-700 mb-4">${page.content.prompt}</p><ul class="list-disc list-inside mb-4 text-lg space-y-1">${startersHTML}</ul>${wordBankHTML}</div></div></div>`;
                        break;
                    case 'certificate':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16 relative overflow-hidden"><canvas id="completion-canvas"></canvas><div class="relative z-10"><div class="readable-content"><h2 class="text-5xl font-bold text-amber-500 mb-4">${page.content.title}</h2><p class="text-2xl text-gray-600 mb-8">${page.content.text}</p></div><div id="certificate-to-print" class="max-w-xl mx-auto bg-white p-8 rounded-lg border-4 border-dashed border-teal-700 text-left"><h3 class="text-3xl font-bold text-teal-800 text-center mb-4">Certificate of Completion</h3><p class="text-xl mb-4">This certifies that</p><div class="w-full bg-gray-200 h-px mb-4"></div><p class="text-xl mb-4">has successfully completed the module</p><p class="text-2xl font-bold text-teal-700 text-center mb-6">Unit 1: Amazing Animals</p><p class="text-lg">Congratulations! <span aria-hidden="true">üê¨</span></p></div><div class="flex justify-center gap-4 mt-8"><button onclick="downloadCertificate()" class="action-button bg-teal-600 text-white font-bold py-2 px-6 rounded-full text-lg hover:bg-teal-700">Download</button><button onclick="printCertificate()" class="action-button bg-gray-600 text-white font-bold py-2 px-6 rounded-full text-lg hover:bg-gray-700">Print</button></div></div></div>`;
                        break;
                    case 'quiz-tfng':
                    case 'quiz-mcq':
                    case 'quiz-gap-fill':
                        let questionsHTML = '';
                        if (page.type === 'quiz-tfng' && page.content.questions) {
                            // Updated to exclude Not Given button
                            questionsHTML = page.content.questions.map((q, i) => `<div class="question-group flex flex-col sm:flex-row items-center gap-4 p-4 rounded-lg bg-gray-50 border border-gray-200"><p class="font-semibold flex-1 text-left">${i + 1}. ${q.statement}</p><div class="flex-shrink-0 flex gap-2">${['True', 'False'].map(a => `<button onclick="checkTfngAnswer(this, '${a}', '${q.correctAnswer}')" class="tfng-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-full">${a.charAt(0)}</button>`).join('')}</div></div>`).join('');
                        } else if (page.type === 'quiz-mcq' && page.content.questions) {
                            questionsHTML = page.content.questions.map((q, i) => `<div class="question-group ${i > 0 ? 'border-t border-gray-200 pt-6 mt-6' : ''}"><p class="font-semibold mb-4 text-left">${i + 1}. ${q.question}</p><div class="space-y-3">${q.options.map(opt => `<button onclick="checkMcqAnswer(this, ${opt === q.correctAnswer})" data-correct="${opt === q.correctAnswer}" class="quiz-option p-3 rounded-lg text-left w-full bg-gray-100 hover:bg-gray-200 border border-gray-200">${opt}</button>`).join('')}</div></div>`).join('');
                        } else if (page.type === 'quiz-gap-fill' && page.content.sentences) {
                            const words = page.content.wordBank 
                                ? [...page.content.wordBank].sort(() => Math.random() - 0.5)
                                : page.content.sentences.map(s => s.answer).sort(() => Math.random() - 0.5);
                            questionsHTML = `<div class="gap-fill-container text-left">${page.content.sentences.map((s, i) => `<p class="text-xl mb-6">${i + 1}. ${s.text[0]} <span class="gap" data-answer="${s.answer}"></span> ${s.text[1] || ''}</p>`).join('')}</div><div class="word-bank-container flex flex-wrap justify-center gap-3 p-4 mt-6 bg-gray-100 rounded-lg">${words.map(w => `<div class="word-bank-word" draggable="true" data-word="${w}">${w}</div>`).join('')}</div>`;
                        }
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h3 class="text-3xl font-bold text-rose-600 mb-6 text-center">${page.content.title}</h3><div class="space-y-6">${questionsHTML}</div></div>`;
                        break;
                }
                if (pageHTML) {
                    createPageElement(page.id, pageHTML);
                    if (page.type === 'quiz-gap-fill') initGapFill(`page-${page.id}`);
                    if (page.id === 'final-project-hub') {
                        const fieldNotes = document.getElementById('field-notes');
                        if (fieldNotes) {
                            fieldNotes.value = localStorage.getItem('unit1BiomimicryNotes') || '';
                            fieldNotes.addEventListener('input', (e) => localStorage.setItem('unit1BiomimicryNotes', e.target.value));
                        }
                    }
                }
            });
            updateNavButtons();
        }
        
        // ----------------------------
        // Initialization and background particle animation
        // ----------------------------
        document.addEventListener('DOMContentLoaded', () => {
            initializeLesson();
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            let particles = [];
            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                particles.forEach((p, i) => {
                    p.y -= p.speed;
                    if (p.y < -p.radius) particles.splice(i, 1);
                    bgCtx.beginPath();
                    bgCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    bgCtx.fillStyle = p.color;
                    bgCtx.fill();
                });
                if (Math.random() > 0.95 && particles.length < 50) {
                    particles.push({ 
                        x: Math.random() * bgCanvas.width, 
                        y: bgCanvas.height + 20, 
                        radius: Math.random() * 8 + 2, 
                        speed: Math.random() * 1 + 0.5, 
                        color: `rgba(255, 255, 255, ${Math.random() * 0.2 + 0.1})`
                    });
                }
                requestAnimationFrame(animateBackground);
            }
            window.addEventListener('resize', () => { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; });
            animateBackground();
        });
    </script>
</body>
</html>
