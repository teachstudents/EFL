<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greening the Skyline: Urban Rooftop Gardens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @keyframes slowColorChange {
            0% { background-color: #047857; } /* Emerald */
            25% { background-color: #065f46; } /* Dark Green */
            50% { background-color: #166534; } /* Mid Green */
            75% { background-color: #065f46; } /* Dark Green */
            100% { background-color: #047857; } /* Emerald */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            animation: slowColorChange 240s linear infinite;
            padding-top: 70px; /* Add padding to prevent nav overlap */
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
            border: none;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px -1px rgba(0,0,0,0.2), 0 1px 2px -2px rgba(0,0,0,0.1), inset 0 -2px 0 0 rgba(0,0,0,0.2);
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 44px; padding: 0 4px;
            border: 2px dashed #9ca3af; border-radius: 8px; margin: 0 4px;
            vertical-align: middle; background-color: #f3f4f6;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 8px;
            background-color: white; user-select: none;
        }
        .word-bank-word.selected { outline: 2px solid #6366f1; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; }
        .gap.correct .word-bank-word { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .gap.incorrect .word-bank-word { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Feedback Message & Badge Notification */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #fde047, #f97316); }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 20px; } to { opacity: 0; bottom: 0; } }

        /* Certificate Canvas */
        #completion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* Final Project Hub Styles */
        .phase-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .phase-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .keyword-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .keyword-item:hover {
            transform: scale(1.02);
            background-color: #f0f9ff;
        }
        .rooftop-animation {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .building-svg {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        /* --- Reward Animation Styles --- */
        #nav-header .score-display.hit {
            transform: scale(1.2);
            transition: transform 0.1s ease-out;
        }

        .coin, .token, .gem, .star {
            position: absolute;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            will-change: transform, opacity;
            border-radius: 50%;
        }
        .coin {
            width: 30px; height: 30px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border: 3px solid #ffb700;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #b8860b;
        }
        .token {
            width: 25px; height: 25px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: 2px solid #ff5252;
        }
        .gem {
            width: 22px; height: 22px;
            background: linear-gradient(45deg, #9c27b0, #e91e63);
            transform: rotate(45deg);
            border-radius: 4px;
        }
        .star {
            width: 25px; height: 25px;
            background: #ffd700;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            border-radius: 0;
        }
        .sparkle {
            position: absolute;
            width: 8px; height: 8px;
            background: #ffd700;
            border-radius: 50%;
            animation: sparkle 0.8s ease-out forwards;
        }

        .fly-straight { animation: flyStraight 1s ease-out forwards; }
        .fly-arc { animation: flyArc 1.2s ease-out forwards; }
        .fly-bounce { animation: flyBounce 1.5s ease-out forwards; }
        .fly-spiral { animation: flySpiral 1.8s ease-out forwards; }
        .fly-magnetic { animation: flyMagnetic 1.3s ease-out forwards; }

        @keyframes flyStraight {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--end-x), var(--end-y)) scale(0.3); opacity: 0; }
        }
        @keyframes flyArc {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            50% { transform: translate(calc(var(--end-x) * 0.5), calc(var(--end-y) * 0.3 - 50px)) scale(0.8); }
            100% { transform: translate(var(--end-x), var(--end-y)) scale(0.3); opacity: 0; }
        }
        @keyframes flyBounce {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            25% { transform: translate(calc(var(--end-x) * 0.25), calc(var(--end-y) * 0.25 - 30px)) scale(1.1); }
            50% { transform: translate(calc(var(--end-x) * 0.5), calc(var(--end-y) * 0.5)) scale(0.9); }
            75% { transform: translate(calc(var(--end-x) * 0.75), calc(var(--end-y) * 0.75 - 25px)) scale(1.05); }
            100% { transform: translate(var(--end-x), var(--end-y)) scale(0.3); opacity: 0; }
        }
        @keyframes flySpiral {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translate(var(--end-x), var(--end-y)) rotate(720deg) scale(0.3); opacity: 0; }
        }
        @keyframes flyMagnetic {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            70% { transform: translate(calc(var(--end-x) * 0.8), calc(var(--end-y) * 0.8)) scale(0.6); }
            85% { transform: translate(calc(var(--end-x) * 1.1), calc(var(--end-y) * 1.1)) scale(0.4); }
            100% { transform: translate(var(--end-x), var(--end-y)) scale(0.3); opacity: 0; }
        }
        @keyframes sparkle {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }
        /* --- End Reward Styles --- */

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #certificate-to-print, #certificate-to-print * { visibility: visible; }
            #certificate-to-print { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="antialiased text-gray-800 text-lg">
    <canvas id="background-canvas"></canvas>
    <div id="reward-animation-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]"></div>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-sm mx-auto p-1.5 flex justify-center items-center gap-2 bg-white/90 backdrop-blur-sm shadow-lg rounded-full">
            <button onclick="goBack()" class="nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div class="font-bold text-base text-green-600 px-3">Score: <span id="score-display">0</span></div>
            <button onclick="navigateTo('main-menu')" class="nav-button bg-gray-800 text-white font-bold p-2 rounded-full hover:bg-gray-900">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            </button>
            <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-full hover:bg-gray-200" title="Toggle Sound">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
            </button>
            <button onclick="goNext()" class="nav-button bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </header>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <section id="page-title-screen" class="page active text-center bg-white rounded-2xl shadow-lg p-8">
            <div class="h-full flex flex-col justify-center items-center">
                <h1 id="main-title" class="text-5xl md:text-6xl font-bold text-green-800 mb-4"></h1>
                <p id="main-subtitle" class="text-xl md:text-2xl text-gray-600 mb-8"></p>
                <div id="main-svg-container" class="rounded-lg shadow-md mb-8 w-full max-w-lg mx-auto"></div>
                <button onclick="startApp()" class="action-button bg-green-600 text-white font-bold py-3 px-8 rounded-full text-2xl hover:bg-green-700">START LESSON</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <!-- Keyword Modal -->
    <div id="keywordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <p id="modalContent" class="text-gray-700 leading-relaxed"></p>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION ---
        // ===================================================================================
        const lessonData = {
            title: "Greening the Skyline",
            subtitle: "A Guide to Urban Rooftop Gardens <span aria-hidden='true'>üåø</span>",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-tps', text: '0. Think-Pair-Share <span aria-hidden="true">üß†</span>', color: 'green', target: 'tps-start' },
                { id: 'menu-goals', text: '1. Learning Goals <span aria-hidden="true">üéØ</span>', color: 'teal', target: 'learning-goals' },
                { id: 'menu-warmup', text: '2. Warm-Up & Vocab <span aria-hidden="true">üìö</span>', color: 'sky', target: 'warm-up' },
                { id: 'menu-reading', text: '3. Reading & Comprehension <span aria-hidden="true">üìñ</span>', color: 'blue', target: 'reading-main' },
                { id: 'menu-convo', text: '4. Conversation Practice <span aria-hidden="true">üó£Ô∏è</span>', color: 'indigo', target: 'conversation-practice' },
                { id: 'menu-lecture1', text: '5. Listening: Lecture <span aria-hidden="true">üßë‚Äçüè´</span>', color: 'amber', target: 'lecture-uni' },
                { id: 'menu-lecture2', text: '6. Listening: Expert Talk <span aria-hidden="true">üéôÔ∏è</span>', color: 'orange', target: 'lecture-expert' },
                { id: 'menu-podcast1', text: '7. Listening: Podcast <span aria-hidden="true">üéß</span>', color: 'lime', target: 'podcast-convo' },
                { id: 'menu-podcast2', text: '8. Listening: Urban Futures <span aria-hidden="true">üèôÔ∏è</span>', color: 'emerald', target: 'podcast-futures' },
                { id: 'menu-debate', text: '9. Discussion: City Debate <span aria-hidden="true">ü§î</span>', color: 'rose', target: 'debate-planning' },
                { id: 'menu-dilemma', text: '10. Bonus: Ethical Dilemma <span aria-hidden="true">‚ö†Ô∏è</span>', color: 'red', target: 'dilemma-ethics' },
                { id: 'menu-thinking', text: '11. Thinking & Exam Prep <span aria-hidden="true">üìù</span>', color: 'purple', target: 'thinking-prompts' },
                { id: 'menu-final', text: '12. Final Project <span aria-hidden="true">‚úçÔ∏è</span>', color: 'violet', target: 'final-project-hub' },
            ],
            badges: {
                'STREAK_5': { name: 'Hot Streak', icon: '<span aria-hidden="true">üî•</span>', description: '5 correct answers in a row' },
                'PERFECT_LEVEL': { name: 'Flawless', icon: '<span aria-hidden="true">üíé</span>', description: 'Complete a level with no mistakes' },
                'GAME_COMPLETE': { name: 'Urban Gardener', icon: '<span aria-hidden="true">üèÜ</span>', description: 'Complete all challenges' },
            },
            vocabulary: [
                { word: 'Urban', def: 'Relating to a city or town.', sentence: 'Traffic is a major problem in many urban areas.' },
                { word: 'Sustainability', def: 'Meeting our own needs without compromising the ability of future generations to meet their own needs.', sentence: 'Using solar power is a key part of environmental sustainability.' },
                { word: 'Biodiversity', def: 'The variety of plant and animal life in a particular habitat.', sentence: 'A rooftop garden can increase local biodiversity by attracting bees and birds. <span aria-hidden="true">üêùü¶ãü¶ú</span>' },
                { word: 'Insulation', def: 'Material used to stop heat, sound, or electricity from escaping or entering.', sentence: 'The layer of soil provides natural insulation, keeping the building cooler.' },
                { word: 'Irrigation', def: 'The supply of water to land or crops to help growth.', sentence: 'A drip irrigation system <span aria-hidden="true">üöø</span> saves water by delivering it directly to the plant‚Äôs roots.' },
                { word: 'Harvest', def: 'The process or period of gathering in crops.', sentence: 'The students were excited to harvest the tomatoes <span aria-hidden="true">üçÖ</span> they had grown.' },
                { word: 'Photosynthesis', def: 'The process by which green plants use sunlight to make food from carbon dioxide and water.', sentence: 'Through photosynthesis, plants <span aria-hidden="true">üåø</span> absorb CO2 and release oxygen.' },
                { word: 'Heat Island', def: 'An urban area that is significantly warmer than its surrounding rural areas.', sentence: 'Green roofs help reduce the urban heat island effect.' },
                { word: 'Compost', def: 'Decayed organic material used as a plant fertilizer.', sentence: 'We use food scraps from the cafeteria to make compost for the garden.' },
                { word: 'Ecosystem', def: 'A biological community of interacting organisms and their physical environment.', sentence: 'A rooftop garden creates a small ecosystem in the middle of the city.' }
            ],
            pages: [
                // Think Pair Share
                { id: 'tps-start', type: 'simple', content: { title: 'Activity: Think-Pair-Share <span aria-hidden="true">üß†</span>', text: 'Let\'s brainstorm about our local environment and food sources.' } },
                { id: 'tps-think', type: 'timer', content: { title: '1. Think <span aria-hidden="true">ü§î</span>', text: 'Look at the city you live in. What unused spaces do you see (e.g., tops of buildings, empty lots)?', duration: 120, timerId: 'timer-think' } },
                { id: 'tps-pair', type: 'timer', content: { title: '2. Pair <span aria-hidden="true">üë•</span>', text: 'Pair with a colleague. Discuss: Where does the food you eat every day come from? How far does it travel to get to you? <span aria-hidden="true">üçé</span>', duration: 180, timerId: 'timer-pair' } },
                { id: 'tps-share', type: 'timer', content: { title: '3. Share <span aria-hidden="true">üó£Ô∏è</span>', text: 'Let\'s share some ideas. Have you ever grown a plant? <span aria-hidden="true">üå±</span> What did it need to survive and grow?', duration: 300, timerId: 'timer-share' } },
                
                // STAGE 1 & 2
                { id: 'learning-goals', type: 'html-content', content: { title: 'Stage 1: Desired Results <span aria-hidden="true">üéØ</span>', html: `
                                        <p><strong class="text-rose-600">Topic:</strong> Urban Rooftop Gardens <span aria-hidden="true">ü™¥</span></p>
                                        <p><strong class="text-rose-600">Theme:</strong> Sustainable Urban Futures</p>
                                        <p><strong class="text-rose-600">Essential Question:</strong> How can we transform unused urban spaces to create a healthier, more sustainable future for city dwellers?</p>
                                        <p><strong class="text-rose-600">Learning Intention:</strong> We are learning to analyze how rooftop gardens can solve urban challenges and to communicate a proposal for a sustainable project.</p>
                                        <hr class="my-4">
                                        <h3 class="text-2xl font-bold text-rose-600 mb-3">Success Criteria</h3>
                                        <ul class="list-disc list-inside space-y-2 text-xl">
                                            <li>I can explain at least three benefits of rooftop gardens using key vocabulary.</li>
                                            <li>I can collaborate with a team to design a basic rooftop garden plan. <span aria-hidden="true">üßë‚Äçüåæ</span></li>
                                            <li>I can write a persuasive paragraph supporting the creation of a rooftop garden.</li>
                                        </ul>` } },
                
                // STAGE 3 - W, H, E
                { id: 'warm-up', type: 'html-content', content: { title: 'Hook & Engage: Warm-Up', html: `
                                        <h3 class="text-2xl font-bold text-sky-600 mb-3">Background-Building Questions</h3>
                                        <ol class="list-decimal list-inside space-y-4 text-xl">
                                            <li>Look at the city you live in. What unused spaces do you see (e.g., tops of buildings, empty lots)?</li>
                                            <li>Where does the food you eat every day come from? How far does it travel to get to you? <span aria-hidden="true">üçì</span></li>
                                            <li>Have you ever grown a plant? <span aria-hidden="true">üå∏</span> What did it need to survive and grow?</li>
                                        </ol>` } },
                { id: 'vocab-start', type: 'simple', content: { title: 'Unit Vocabulary <span aria-hidden="true">üìö</span>', text: 'Let\'s learn the key terms for this unit. Click "Next" in the header to cycle through the words.' } },
                { id: 'vocab-match', type: 'quiz-mcq', content: { title: 'Vocabulary Practice: Matching', questions: [] } },
                { id: 'reading-main', type: 'html-content', content: { title: 'Reading: Tiered Texts <span aria-hidden="true">üìñ</span>', html: `
                                        <div class="mb-8">
                                            <h3 class="text-2xl font-bold text-blue-600 mb-3">Pre-Reading Questions</h3>
                                            <ol class="list-decimal list-inside space-y-2 text-xl">
                                                <li>Based on the keywords, what do you think are the main benefits of rooftop gardens?</li>
                                                <li>What challenges might someone face when trying to start a garden on a roof? <span aria-hidden="true">‚õèÔ∏è</span></li>
                                                <li>How might a rooftop garden in Shanghai be different from one in Berlin?</li>
                                            </ol>
                                        </div>
                                        <div class="space-y-6">
                                            <div class="bg-green-50 p-4 rounded-lg">
                                                <h4 class="font-bold text-xl text-green-800">Text 1: Green Roofs in the City</h4>
                                                <p>Cities have many buildings. The tops of these buildings are called roofs. Most roofs are empty. But we can put gardens on them! These are called rooftop gardens. <span aria-hidden="true">üå≥</span> Rooftop gardens are good for many reasons. They give us fresh food like vegetables <span aria-hidden="true">ü•ï</span> and fruits. <span aria-hidden="true">üçé</span> This is healthy. The plants on the roof also make the building cool in the summer. This saves energy. Birds and bees <span aria-hidden="true">üêù</span> like the flowers, <span aria-hidden="true">üåª</span> which is good for nature. A rooftop garden is a beautiful, green space in a busy city.</p>
                                            </div>
                                            <div class="bg-yellow-50 p-4 rounded-lg">
                                                <h4 class="font-bold text-xl text-yellow-800">Text 2: Greening Our Cities: The Power of Rooftop Gardens</h4>
                                                <p>What can we do with the empty, flat roofs on top of city buildings? One innovative solution is to turn them into rooftop gardens. These gardens are more than just beautiful spaces; they offer real solutions to urban problems. First, they help fight the ‚Äúurban heat island‚Äù effect. Cities are often hotter than the countryside because materials like concrete absorb a lot of heat. The soil and plants <span aria-hidden="true">ü™¥</span> in a rooftop garden provide natural insulation, which helps to cool the building below. This means less need for air conditioning, which saves energy. Second, these gardens can improve food security. They allow communities to grow their own fresh produce, from tomatoes <span aria-hidden="true">üçÖ</span> to herbs. This reduces the distance food has to travel, making our food system more sustainable. Finally, they create small ecosystems, increasing urban biodiversity by providing a home for bees, butterflies, and birds. <span aria-hidden="true">ü¶ã</span></p>
                                            </div>
                                            <div class="bg-red-50 p-4 rounded-lg">
                                                <h4 class="font-bold text-xl text-red-800">Text 3: Greening the Skyline: Rooftop Gardens as Sustainable Urban Infrastructure</h4>
                                                <p>As the world becomes increasingly urbanized, cities face pressing challenges such as climate change, food insecurity, and loss of biodiversity. An innovative and effective response to these issues is the implementation of rooftop gardens, which transform unused roof space into productive and living ecosystems. One of the most significant environmental benefits of rooftop gardens is their ability to mitigate the urban heat island effect. A green roof, with its layers of soil and vegetation, absorbs heat and uses solar energy for photosynthesis. Furthermore, the process of evapotranspiration actively cools the air. The soil also provides excellent insulation for the building itself, reducing the energy required for air conditioning in summer and heating in winter. Rooftop farms can be a vital source of fresh, locally-grown produce. This reduces ‚Äúfood miles‚Äù‚Äîthe distance food is transported from farm to consumer‚Äîwhich in turn lowers carbon emissions. They create habitats for pollinators like bees and butterflies, which are essential for the wider ecosystem. Of course, creating a rooftop garden is not without its challenges. The building‚Äôs structure must be able to support the weight of soil, water, and plants. An effective irrigation system is essential, and it should be water-efficient. However, with careful planning and engineering, these challenges can be overcome.</p>
                                            </div>
                                        </div>` } },
                { id: 'reading-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap Fill', sentences: [] } },
                { id: 'reading-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False', questions: [] } },
                { id: 'reading-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [] } },
                { id: 'conversation-practice', type: 'dialogue', content: { title: 'Interactive Conversation Practice <span aria-hidden="true">üó£Ô∏è</span>', dialogue: "Li: Hey, Maria. That article on rooftop gardens was interesting. What do you think about the idea?\n\nMaria: I think it‚Äôs fantastic. It seems to me that it solves so many problems at once. Like the heat island effect.\n\nLi: I agree. And I was surprised by how much they can cool a building. On the other hand, it must be difficult to set one up.\n\nMaria: That‚Äôs a good point. The article mentioned the weight of the soil. You‚Äôd need an engineer to check the building first.\n\nLi: Exactly. But in my opinion, the benefits are worth the effort. Imagine having fresh vegetables ü•¨ grown right at our school.\n\nMaria: I see what you mean. We could use the food in the cafeteria. What about the water? How would we manage the irrigation? üöø\n\nLi: That‚Äôs something to consider. Maybe we could collect rainwater. That would make it even more sustainable.\n\nMaria: I totally agree. It would be a great project for our school." } },
                
                // LISTENING ACTIVITIES
                { id: 'lecture-uni', type: 'dialogue', content: { title: 'Listening: University Lecture <span aria-hidden="true">üßë‚Äçüè´</span>', dialogue: "Professor: Welcome class. Today, we're going to explore a truly innovative approach to urban sustainability. Rooftop gardens as sustainable infrastructure. In this lecture, we'll cover the definition and benefits of rooftop gardens, their role in managing storm water and mitigating the urban heat island effect, their potential for urban agriculture and biodiversity. And finally, we'll discuss some implementation challenges and future prospects. I'm joined today by two of our bright students, Sarah and David, who have been researching this topic. Sarah, David, thanks for being here.\n\nSarah: Thank you, professor. It's great to be here.\n\nDavid: Thanks for having us, professor. We're looking forward to discussing this.\n\nProfessor: Excellent. Let's dive right in. Sarah, could you start by defining what a rooftop garden is and briefly touch upon some of its key benefits?\n\nSarah: Sure, professor. A rooftop garden, often called a green roof, is essentially a layer of vegetation planted over a waterproofing membrane on the top of a building. The benefits are quite numerous. They can improve air quality, provide insulation, increase building lifespan, and create usable green space in dense urban areas.\n\nProfessor: That's a good summary, Sarah. David, building on that, how do rooftop gardens specifically contribute to stormwater management in cities. This is a significant challenge, isn't it?\n\nDavid: It really is, professor. Rooftop gardens act like sponges during rainfall. The soil and vegetation layers absorb and retain a large amount of water, significantly reducing the volume and rate of runoff into drainage systems. This helps prevent localized flooding and reduces the burden on urban infrastructure.\n\nProfessor: That's a crucial point for urban resilience. And David, you mentioned the urban heat island effect earlier. How do rooftop gardens help with that?\n\nDavid: The urban heat island effect is where cities are significantly warmer than surrounding rural areas due to heat absorbed by buildings and pavement. Rooftop gardens counter this by absorbing heat through their vegetation and providing evaporative cooling, which lowers ambient temperatures in the surrounding area.\n\nProfessor: Right, the evapotranspiration process acts like a natural air conditioner. It's quite effective. Now, Sarah, we often hear about the potential for urban agriculture. How can rooftop gardens contribute to that?\n\nSarah: Professor, rooftop gardens offer valuable space for growing food in the city. This can range from small scale vegetable patches for residents to larger commercial rooftop farms. It helps improve access to fresh, healthy food and reduces transportation costs and emissions, like David mentioned earlier about food miles.\n\nProfessor: Reducing food miles is indeed a key benefit. And David, what about the impact on urban biodiversity?\n\nDavid: Rooftop gardens can create important new habitats for urban wildlife, professor, especially for insects like bees and butterflies, which are crucial pollinators. Even small rooftop spaces can act as stepping stones, connecting larger green areas and supporting urban ecosystems.\n\nProfessor: So, they're not just aesthetic. They provide tangible ecological benefits. We've covered a lot of the advantages. Sarah, what do you see as some of the main challenges in implementing rooftop garden projects.\n\nSarah: One of the biggest challenges is the structural capacity of existing buildings, professor. Not all roofs can support the weight of soil and vegetation. Cost is also a factor for installation, and ensuring proper waterproofing and drainage is critical to prevent leaks.\n\nProfessor: Those are certainly important considerations. David, do you have any thoughts on overcoming these challenges or future trends in rooftop garden technology.\n\nDavid: Yes, professor. There's ongoing research into lightweight growing mediums and modular systems that can make installation easier and reduce structural load. Also, advancements in irrigation technology like smart irrigation systems can help manage water usage more efficiently. Policy incentives and building code updates are also crucial for wider adoption.\n\nProfessor: Excellent points, David. It seems like a field with a lot of innovation happening. To wrap up our lecture today, let's quickly review the key takeaways. We discussed how rooftop gardens offer multiple environmental and social benefits from stormwater management and urban cooling to supporting urban agriculture and biodiversity. While challenges like structural capacity and cost exist, ongoing technological advancements and supportive policies are paving the way for their wider implementation as a vital part of sustainable urban infrastructure. Thank you Sarah and David for your valuable contributions today.\n\nSarah: Thank you, professor.\n\nDavid: Thanks, professor. It was very informative." } },
                { id: 'lecture-uni-quiz-mcq', type: 'quiz-mcq', content: { title: 'Lecture Quiz (MCQ)', questions: [] } },
                { id: 'lecture-uni-quiz-tfng', type: 'quiz-tfng', content: { title: 'Lecture Quiz (TFNG)', questions: [] } },
                { id: 'lecture-uni-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Lecture Quiz (Gap Fill)', sentences: [] } },
                { id: 'lecture-expert', type: 'dialogue', content: { title: 'Listening: Expert Talk <span aria-hidden="true">üéôÔ∏è</span>', dialogue: "Alex: Hello, I'm Alex, an urban planning expert from New York. Today I'll be discussing the growing importance of rooftop gardens in urban environments, focusing on their environmental benefits. Rooftop gardens offer a crucial way to combat the urban heat island effect. By covering dark, heat-absorbing rooftops with vegetation, they can significantly lower surface temperatures, reducing the need for air conditioning and lowering energy consumption. Studies have shown that green roofs can be 30 to 40 degrees Fahrenheit cooler than conventional roofs in the summer. Furthermore, they play a vital role in stormwater management. The vegetation and soil absorb rainwater, reducing runoff and minimizing the burden on urban drainage systems, which is particularly important in preventing flooding during heavy rainfall events. This also helps filter pollutants from rainwater, improving the quality of water entering our waterways. In addition to these direct environmental impacts, rooftop gardens contribute to improved air quality by absorbing pollutants and producing oxygen, making our cities healthier places to live.\n\nSarah: Thank you, Alex. I'm Sarah, an environmental consultant from London, and I'll be focusing on the social and economic benefits of rooftop gardens. Beyond the environmental advantages, rooftop gardens create valuable green spaces in dense urban areas, providing residents with access to nature and opportunities for recreation and relaxation. These spaces can enhance mental well-being and build a stronger sense of community, especially when used as communal gardens or gathering spots. Economically, rooftop gardens can increase property values and extend the lifespan of a roof by protecting it from UV radiation and extreme weather. There are also opportunities for urban agriculture, allowing local food production, which reduces transportation costs and provides fresh produce to city dwellers. Some businesses and institutions are also finding innovative ways to use rooftop gardens for employee well-being, or as unique event spaces, adding further economic and social value to urban buildings. Overall, rooftop gardens are a multifaceted solution contributing to more sustainable, resilient, and livable cities." } },
                { id: 'lecture-expert-quiz-mcq', type: 'quiz-mcq', content: { title: 'Expert Talk Quiz (MCQ)', questions: [] } },
                { id: 'lecture-expert-quiz-tfng', type: 'quiz-tfng', content: { title: 'Expert Talk Quiz (TFNG)', questions: [] } },
                { id: 'lecture-expert-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Expert Talk Quiz (Gap Fill)', sentences: [] } },
                { id: 'podcast-convo', type: 'dialogue', content: { title: 'Listening: Podcast Conversation <span aria-hidden="true">üéß</span>', dialogue: "Alex: Hello, I'm Alex, an urban planning expert from New York. Today we're discussing a key question: How can rooftop gardens contribute to urban sustainability and resilience? Rooftop gardens are becoming increasingly popular in urban areas, aren't they? For example, in 2022, New York City saw a 15% increase in new rooftop garden installations.\n\nSarah: Hi, Alex, I'm Sarah, an environmental consultant from London. Absolutely. They offer a fantastic way to bring greenery into concrete jungles and provide numerous benefits. Studies show they can reduce building cooling costs by up to 25%.\n\nChris: G‚ÄôDay, I'm Chris, a landscape architect from Sydney. Couldn't agree more, Sarah. They help with insulation, reduce stormwater runoff, and create valuable green spaces. A typical green roof can absorb about 70% of rainwater runoff.\n\nAlex: That's a great point, Chris. And think about the potential for growing your own food right in the city. Some rooftop farms in Chicago are producing over 10,000 pounds of produce annually.\n\nSarah: Exactly, Alex, that's a massive advantage‚Äîproviding fresh produce and reducing food miles. Plus, they contribute to biodiversity. One study in London identified over 20 species of birds on a single rooftop garden.\n\nChris: Spot on, Sarah. Plus, they can be a haven for urban wildlife, attracting bees and birds. Did you know a square meter of a green roof can support dozens of insect species?\n\nAlex: The economic benefits are clear, with increased property values and reduced energy consumption.\n\nChris: Couldn't have said it better myself, Alex. They truly contribute to a healthier and more sustainable urban environment. The city of Toronto has mandated green roofs on new buildings over a certain size since 2009.\n\nSarah: Absolutely. Definitely something more cities globally should be investing in. The number of green roofs has more than doubled in the last decade.\n\nAlex: To summarize our conversation, rooftop gardens offer multifaceted benefits for urban environments‚Äîfrom reducing energy costs and managing stormwater to promoting biodiversity and urban farming. Their increasing adoption globally highlights their crucial role in building more sustainable and resilient cities for the future. Thanks for joining the discussion." } },
                { id: 'podcast-convo-quiz-mcq', type: 'quiz-mcq', content: { title: 'Podcast Quiz (MCQ)', questions: [] } },
                { id: 'podcast-convo-quiz-tfng', type: 'quiz-tfng', content: { title: 'Podcast Quiz (TFNG)', questions: [] } },
                { id: 'podcast-convo-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Podcast Quiz (Gap Fill)', sentences: [] } },
                { id: 'podcast-futures', type: 'dialogue', content: { title: 'Listening: Urban Futures Podcast <span aria-hidden="true">üèôÔ∏è</span>', dialogue: "Dr. Sharma: Welcome to Urban Futures, the podcast exploring innovative solutions for sustainable cities. Today, we're talking about a truly green idea, rooftop gardens as sustainable infrastructure. I'm your host, Dr. Anya Sharma. Joining me are two experts in urban planning and environmental science. First from London, UK, we have Mr. James Sterling, an urban ecologist.\n\nMr. Sterling: Hello Anya. It's a pleasure to be here. The potential of rooftop spaces is incredibly exciting.\n\nDr. Sharma: And joining us from Sydney, Australia, Dr. Ben Carter, a sustainable development consultant.\n\nDr. Carter: Good to be here Anya and James. I'm eager to discuss how these gardens can tackle pressing urban challenges.\n\nDr. Sharma: Great to have you both. James, how do rooftop gardens help combat the urban heat island effect?\n\nMr. Sterling: That's a significant benefit Anya. The vegetation and soil layers absorb heat and use sunlight for photosynthesis, which cools the air through evapotranspiration. It's a natural air conditioner for the city.\n\nDr. Sharma: That's fascinating. Ben, beyond cooling, what role can rooftop farms play in urban food security?\n\nDr. Carter: They can be vital, James. By growing food locally, we drastically reduce food miles, cutting down on transportation emissions and providing residents with fresh produce right in their neighborhoods. It connects people to their food source.\n\nDr. Sharma: Reducing food miles is so important. James, what about the environmental benefits in terms of biodiversity?\n\nMr. Sterling: Absolutely crucial, Anya. Rooftop gardens create much needed habitats for pollinators like bees and butterflies in urban environments. These small ecosystems are essential for the health of the wider urban environment.\n\nDr. Sharma: It seems there are numerous benefits. What are some of the key challenges in implementing these projects, Ben?\n\nDr. Carter: Well, there are engineering considerations like structural integrity and drainage. Also, access to water and the initial cost of installation can be hurdles. We need smart design and supportive policies.\n\nDr. Sharma: Those are important points. Despite the challenges, what makes you both optimistic about the future of rooftop gardens in our cities?\n\nMr. Sterling: I'm optimistic because the benefits are so clear and tangible. As cities look for sustainable solutions, rooftop gardens offer a visually appealing and effective way to green our urban spaces and improve quality of life.\n\nDr. Carter: And the growing public interest and technological advancements in lightweight growing mediums and irrigation systems make it increasingly feasible. We're seeing more and more innovative projects emerge globally.\n\nDr. Sharma: It's inspiring to see this potential being realized. In conclusion, rooftop gardens offer a multifaceted approach to building more sustainable and resilient cities. Thank you both, Mr. James Sterling and Dr. Ben Carter for this insightful discussion on urban futures." } },
                { id: 'podcast-futures-quiz-mcq', type: 'quiz-mcq', content: { title: 'Urban Futures Quiz (MCQ)', questions: [] } },
                { id: 'podcast-futures-quiz-tfng', type: 'quiz-tfng', content: { title: 'Urban Futures Quiz (TFNG)', questions: [] } },
                { id: 'podcast-futures-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Urban Futures Quiz (Gap Fill)', sentences: [] } },
                { id: 'debate-planning', type: 'dialogue', content: { title: 'Discussion: City Planning Debate <span aria-hidden="true">ü§î</span>', dialogue: "Daniel: So um, so uh jumpin' into this city planning thing. This budget scenario? It's uh pretty tricky, right? Like Option A, the big rooftop farm, or Option B, the five community gardens.\n\nElizabeth: Indeed, a complex choice. I suppose, thinking about it, in my opinion, the best course of action is to fund the rooftop farm. My main reason for this is, well, the sheer scale of the environmental impact. It's quantifiable, you see. Significant carbon footprint reduction.\n\nLachlan: Yeah, I see your point, Elizabeth, but I have a different perspective. I believe we should choose the community gardens. This is justified because, from my perspective, the most ethical choice is supporting those lower-income neighborhoods directly. They are, really need that green space and connection.\n\nDaniel: Hm, I understand why you say that, Lachlan. The community aspect is huge. But um, while it is true that the community gardens provide social value, I still believe that the rooftop farm's environmental benefits are, are more critical right now. The evidence suggests that climate action at scale is, is urgent.\n\nElizabeth: Precisely, Daniel. And could you please explain what you mean by social capital, Lachlan? I'm not sure I fully understand the, the tangible benefit there.\n\nLachlan: Right. Well it's about building connections, you know, people working together, sharing knowledge, creating a sense of, of belonging. It's not just about the food, though that's vital. Furthermore, we must consider the impact on mental health and well-being in those areas.\n\nDaniel: That's a great point, Lachlan. I'd also like to add that community gardens can lead to uh increased food literacy. People learn about growing food, healthy eating.\n\nElizabeth: True, true. On the one hand, the community benefits are compelling. But on the other hand, the rooftop farm's ability to produce food for thousands, that addresses a different, perhaps larger scale of food insecurity across the city. What would happen if we didn't pursue that large-scale production?\n\nLachlan: Yeah, I, I see what you mean, Elizabeth. It's a bit of a balancing act, isn't it? Immediate local impact versus broader city-wide benefits. It seems to me that the only real option is, well, it's not easy.\n\nDaniel: Absolutely. I mean, we need both, really. But with the budget, it's one or the other. I respectfully disagree that the community gardens are the only real option though. The environmental return on investment for the rooftop farm is, is pretty clear.\n\nElizabeth: Perhaps a phased approach is the way to go, as Dr. Chen suggested previously. Though, of course, we don't have Dr. Chen here today. But you know, that idea of starting with one and then, then moving to the other.\n\nLachlan: Yeah, that makes sense. Little by little I reckon. Start with the gardens, build that community base, then maybe a smaller-scale urban farm elsewhere.\n\nDaniel: That's a possibility. We'd need to weigh the pros and cons carefully for a phased approach too, budget overruns and all that.\n\nElizabeth: Indeed. It's a complex issue with, with no easy answers." } },
                { id: 'debate-planning-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Debate Quiz (Gap Fill)', sentences: [] } },
                { id: 'debate-planning-quiz-mcq', type: 'quiz-mcq', content: { title: 'Debate Quiz (MCQ)', questions: [] } },
                { id: 'debate-planning-quiz-tfng', type: 'quiz-tfng', content: { title: 'Debate Quiz (TFNG)', questions: [] } },
                { id: 'dilemma-ethics', type: 'dialogue', content: { title: 'Bonus: Ethical Dilemma <span aria-hidden="true">‚ö†Ô∏è</span>', dialogue: "Daniel: So, um, so, uh, moving on to another scenario about the factory chemical leak. This is, this is a really heavy one. Divert to the river and harm the village or let it flood and kill the workers and lose the technology.\n\nElizabeth: Indeed, a truly terrible dilemma. As the manager in this situation, I suppose, thinking about it, in my opinion, the best course of action is to divert the chemical into the river.\n\nLachlan: Yeah, I see your point, Elizabeth, about saving the workers and the technology, but I have a different perspective. I believe we should choose to let it flood the factory. This is justified because, from my perspective, the most ethical choice is not directly causing harm to an innocent, unsuspecting community downstream.\n\nDaniel: Hmm, I understand why you say that, Lachlan. The principle of not directly causing harm is huge. But um, while it is true that diverting harms the village, I still believe that saving five lives in your immediate vicinity is, are more critical right now. The evidence suggests that in crisis situations, prioritizing immediate lives is often the instinctive and, arguably, the most defensible action.\n\nElizabeth: Precisely, Daniel. And could you please explain what you mean by most ethical, Lachlan? I'm not sure I fully understand the, the moral calculation that leads to sacrificing your own workers.\n\nLachlan: Right. Well, it's about consequences, you know, and who bears them. People in the village haven't consented to any risk from our factory. Furthermore, we must consider the long-term health impacts on generations in that village if the river is poisoned. It's not just about the immediate deaths in the factory.\n\nDaniel: That's a great point, Lachlan. I'd also like to add that the world-changing technology is a factor. While not as important as lives, losing it means potentially losing future benefits for many more people.\n\nElizabeth: True, true. On the one hand, the principle of not directly harming the village is compelling. But on the other hand, the certainty of five deaths versus the potential, perhaps mitigated, harm to the village. What would happen if we could somehow warn the village downstream?\n\nLachlan: Yeah, I, I see what you mean, Elizabeth. It's a bit of a balancing act, isn't it? Immediate, certain deaths versus potential, widespread harm. It seems to me that the only real option is, well, it's not easy to choose who lives and who dies.\n\nDaniel: Absolutely. I mean, in a perfect world, there'd be a third option. But with these two stark choices, I respectfully disagree that the only real option is sacrificing the workers though. The responsibility for the leak lies with the factory, but the immediate duty is to save those you can.\n\nElizabeth: Perhaps a utilitarian approach is the way to go, maximizing the number of lives saved, as Dr. Chen suggested previously. Though, of course, we don't have Dr. Chen here today. But you know that idea of choosing the option with the least overall harm.\n\nLachlan: Yeah, that makes sense from a numbers perspective. But little by little I reckon ethical decisions aren't always about the numbers. Sometimes it's about the nature of the act itself. Is directly poisoning a community ever the best course of action?" } },
                { id: 'dilemma-ethics-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Dilemma Quiz (Gap Fill)', sentences: [] } },
                { id: 'dilemma-ethics-quiz-mcq', type: 'quiz-mcq', content: { title: 'Dilemma Quiz (MCQ)', questions: [] } },
                { id: 'dilemma-ethics-quiz-tfng', type: 'quiz-tfng', content: { title: 'Dilemma Quiz (TFNG)', questions: [] } },

                // STAGE 3 - R, E, T, O
                { id: 'thinking-prompts', type: 'html-content', content: { title: 'Rethink, Revise, Reflect <span aria-hidden="true">üìù</span>', html: `
                                        <div class="mb-6">
                                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Harkness Discussion Prompt</h3>
                                            <p class="text-xl italic">‚ÄúTo what extent are rooftop gardens a realistic solution for a densely populated city like Shanghai or Beijing versus a city like Freiburg in Germany?‚Äù</p>
                                        </div>
                                        <div>
                                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Higher-Order Thinking Questions</h3>
                                            <ul class="list-disc list-inside space-y-2 text-lg">
                                                <li><b>Remembering:</b> What are two benefits of rooftop gardens mentioned in the text?</li>
                                                <li><b>Understanding:</b> Explain in your own words how a green roof cools a building.</li>
                                                <li><b>Applying:</b> How could you apply the principles of a rooftop garden to a smaller space, like a balcony?</li>
                                                <li><b>Analyzing:</b> Compare and contrast the challenges of starting a rooftop garden in a hot, dry climate versus a cold, wet climate.</li>
                                                <li><b>Evaluating:</b> Do you think the benefits of rooftop gardens outweigh the costs and challenges? Justify your answer.</li>
                                                <li><b>Creating:</b> Design a simple infographic to persuade your neighbors to start a community rooftop garden.</li>
                                            </ul>
                                        </div>` } },
                { id: 'exam-practice', type: 'html-content', content: { title: 'Connections to IELTS & TOEFL', html: `
                                        <div class="space-y-6">
                                            <div>
                                                <h3 class="text-2xl font-bold text-purple-600 mb-3">IELTS Speaking Practice</h3>
                                                <p><b>Part 1:</b> Do you like gardening? Why or why not? Are there many parks or green spaces in your hometown?</p>
                                                <p><b>Part 2 (Cue Card):</b> Describe an environmentally friendly project you would like to be a part of. You should say: what the project is, how you learned about it, what it does to help the environment, and explain why you think it is important.</p>
                                                <p><b>Part 3:</b> What are the biggest environmental problems facing cities today? Whose responsibility is it to protect the environment: governments or individuals?</p>
                                            </div>
                                            <div>
                                                <h3 class="text-2xl font-bold text-purple-600 mb-3">TOFL Independent Speaking</h3>
                                                <p>Do you agree or disagree with the following statement? ‚ÄúIt is more important for a city to have modern buildings than to have green spaces.‚Äù Use specific reasons and examples to support your answer.</p>
                                            </div>
                                        </div>` } },
                { id: 'final-project-hub', type: 'html-content', content: { title: 'Final Project Hub <span aria-hidden="true">‚úçÔ∏è</span>', html: `
                                        <div class="bg-gradient-to-br from-green-50 to-blue-50">
                                            <header class="bg-white shadow-lg border-b-4 border-green-500">
                                                <div class="max-w-7xl mx-auto px-6 py-8">
                                                    <div class="flex items-center justify-between">
                                                        <div>
                                                            <h1 class="text-4xl font-bold text-gray-800 mb-2"><span aria-hidden="true">üè¢üå±</span> Greening the Skyline</h1>
                                                            <p class="text-xl text-gray-600">Final Project Guide</p>
                                                        </div>
                                                        <div class="rooftop-animation">
                                                            <svg class="building-svg w-24 h-24" viewBox="0 0 100 100" fill="none"><rect x="20" y="40" width="60" height="50" fill="#4a5568" stroke="#2d3748" stroke-width="2"/><rect x="25" y="45" width="8" height="8" fill="#ffd700"/><rect x="37" y="45" width="8" height="8" fill="#ffd700"/><rect x="49" y="45" width="8" height="8" fill="#ffd700"/><rect x="61" y="45" width="8" height="8" fill="#ffd700"/><rect x="25" y="57" width="8" height="8" fill="#ffd700"/><rect x="37" y="57" width="8" height="8" fill="#ffd700"/><rect x="49" y="57" width="8" height="8" fill="#ffd700"/><rect x="61" y="57" width="8" height="8" fill="#ffd700"/><rect x="22" y="35" width="56" height="8" fill="#22c55e" rx="2"/><circle cx="30" cy="39" r="2" fill="#ef4444"/><circle cx="40" cy="37" r="1.5" fill="#f59e0b"/><circle cx="50" cy="39" r="2" fill="#ef4444"/><circle cx="60" cy="37" r="1.5" fill="#f59e0b"/><circle cx="70" cy="39" r="2" fill="#ef4444"/></svg>
                                                        </div>
                                                    </div>
                                                </div>
                                            </header>
                                            <section class="max-w-7xl mx-auto px-6 py-12">
                                                <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">üéØ</span> Big Ideas & Understanding</h2>
                                                    <div class="grid md:grid-cols-2 gap-8"><div class="bg-gradient-to-r from-green-100 to-blue-100 p-6 rounded-xl"><h3 class="text-xl font-semibold text-gray-800 mb-4"><span aria-hidden="true">üåç</span> Enduring Understanding</h3><p class="text-gray-700 leading-relaxed">Nature's processes can provide sustainable design solutions for urban challenges, and planning requires a multidisciplinary approach.</p></div><div class="bg-gradient-to-r from-blue-100 to-purple-100 p-6 rounded-xl"><h3 class="text-xl font-semibold text-gray-800 mb-4"><span aria-hidden="true">üí°</span> Big Idea</h3><p class="text-gray-700 leading-relaxed">Greening our cities is a powerful way to solve environmental problems and build a better future.</p></div></div>
                                                </div>
                                                <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">üéì</span> Transferable KSA Skills</h2>
                                                    <div class="grid md:grid-cols-3 gap-6"><div class="text-center p-6 bg-red-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">üß†</span></div><h3 class="text-xl font-semibold text-red-700 mb-3">Knowledge</h3><p class="text-gray-700 text-sm">Urban ecology, sustainability principles, design thinking, project management, botany & engineering vocabulary</p></div><div class="text-center p-6 bg-blue-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">üõ†Ô∏è</span></div><h3 class="text-xl font-semibold text-blue-700 mb-3">Skills</h3><p class="text-gray-700 text-sm">Collaborative problem-solving, critical analysis, persuasive communication, research, technical design</p></div><div class="text-center p-6 bg-green-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">‚ù§Ô∏è</span></div><h3 class="text-xl font-semibold text-green-700 mb-3">Attitudes</h3><p class="text-gray-700 text-sm">Environmental stewardship, curiosity, responsibility, confidence to advocate for creative solutions</p></div></div>
                                                </div>
                                                <div class="mb-12">
                                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">üöÄ</span> Project-Based Learning Journey</h2>
                                                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6"><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(1)"><div class="text-4xl mb-4"><span aria-hidden="true">üîç</span></div><h3 class="text-xl font-bold mb-2">Phase 1</h3><p class="text-sm opacity-90">Identifying Problems & Initial Inquiry</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(2)"><div class="text-4xl mb-4"><span aria-hidden="true">üìö</span></div><h3 class="text-xl font-bold mb-2">Phase 2</h3><p class="text-sm opacity-90">Researching Solutions & Concepts</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(3)"><div class="text-4xl mb-4"><span aria-hidden="true">üìê</span></div><h3 class="text-xl font-bold mb-2">Phase 3</h3><p class="text-sm opacity-90">Planning & Design</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(4)"><div class="text-4xl mb-4"><span aria-hidden="true">üìä</span></div><h3 class="text-xl font-bold mb-2">Phase 4</h3><p class="text-sm opacity-90">Evaluation & Communication</p></div></div>
                                                </div>
                                                <div id="phaseContent" class="bg-white rounded-2xl shadow-xl p-8"></div>
                                            </section>
                                        </div>` } },
                { id: 'writing-task', type: 'writing-task', content: { 
                    title: 'Writing Activity <span aria-hidden="true">‚úçÔ∏è</span>', 
                    prompt: 'Your city council is considering a new policy to encourage the development of rooftop gardens. Write a letter to the council to express your support for this policy. Explain why rooftop gardens are important for the city‚Äôs future, mentioning at least three key benefits. (200-250 words)', 
                    starters: ['To whom it may concern, I am writing to express my strong support for...', 'One of the most significant benefits is...', 'Furthermore, rooftop gardens can enhance...', 'In conclusion, I urge you to approve this policy...'],
                    wordBank: ['agriculture', 'benefit', 'biodiversity', 'challenge', 'climate', 'community', 'compost', 'conservation', 'ecosystem', 'energy', 'environment', 'food', 'future', 'green', 'harvest', 'health', 'heat island', 'infrastructure', 'innovation', 'insulation', 'irrigation', 'local', 'pollution', 'sustainability', 'urban']
                } },
                { id: 'self-assessment', type: 'html-content', content: { title: 'Self-Assessment & Rubric <span aria-hidden="true">üßë‚Äçüè´</span>', html: `
                                        <div class="mb-8">
                                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Metacognitive Self-Assessment</h3>
                                            <ol class="list-decimal list-inside space-y-4 text-xl">
                                                <li>‚ÄúWhat was the most challenging part of this lesson for me, and what strategy did I use to overcome it?‚Äù</li>
                                                <li>‚ÄúHow confident do I feel now about explaining the benefits of urban gardens in English? (Scale of 1-5). What do I need to practice more?</li>
                                            </ol>
                                        </div>
                                        <div>
                                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Final Project Rubric (KASE-C)</h3>
                                            <div class="overflow-x-auto">
                                                <table class="w-full text-left border-collapse">
                                                    <thead>
                                                        <tr class="bg-purple-50">
                                                            <th class="border-b-2 p-2 w-1/4">Criterion</th>
                                                            <th class="border-b-2 p-2">5 - Exemplary</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr><td class="border-b p-2 font-semibold">K ‚Äì Knowledge</td><td class="border-b p-2">The proposal demonstrates deep, comprehensive knowledge of urban agriculture, sustainability principles, and the specific needs of the chosen location.</td></tr>
                                                        <tr><td class="border-b p-2 font-semibold">A ‚Äì Analysis</td><td class="border-b p-2">The proposal expertly analyzes the school's physical space (sunlight, water access, structural load considerations) and social environment, providing a sophisticated justification for the garden's design and location.</td></tr>
                                                        <tr><td class="border-b p-2 font-semibold">S ‚Äì Structure</td><td class="border-b p-2">The proposal and presentation are exceptionally well-structured, logically weaving together the garden design, its benefits, the budget, and the maintenance plan.</td></tr>
                                                        <tr><td class="border-b p-2 font-semibold">E ‚Äì Evidence</td><td class="border-b p-2">The design choices are supported by strong, relevant evidence from research on rooftop gardens, local climate data, and a clear understanding of basic horticulture.</td></tr>
                                                        <tr><td class="border-b p-2 font-semibold">C ‚Äì Clarity</td><td class="border-b p-2">The language is exceptionally clear, precise, and persuasive. The project's vision and its benefits are communicated in an engaging way.</td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>` } },
                { id: 'certificate', type: 'certificate', content: { title: 'Module Complete! <span aria-hidden="true">üéâ</span>', text: 'You have successfully completed the "Greening the Skyline" module.', certificateTitle: 'Certificate of Completion' } }
            ]
        };
        // --- END OF LESSON CONTENT CONFIGURATION ---
        // ===================================================================================

       /**
        * SpeechService v6.2 (Bug Fixed & Tiered Fallbacks)
        * Correctly separates the asynchronous voice setup from the synchronous constructor.
        * Assigns specific, high-quality multilingual online voices directly to characters by name,
        * with a tiered fallback system to select the next best voice if a primary one is unavailable.
        */
        class SpeechService {
            constructor() {
                this.synth = window.speechSynthesis;
                this.isInitialized = false;
                this.isTtsEnabled = true;
                this.voices = {};
                this.speechRate = 0.85;
                this.isDialoguePlaying = false; 
            }

            async _setupVoices() {
                const voicesPromise = new Promise(resolve => {
                    if (this.synth.getVoices().length) return resolve(this.synth.getVoices());
                    this.synth.onvoiceschanged = () => resolve(this.synth.getVoices());
                });

                const availableVoices = await voicesPromise;
                if (!availableVoices.length) {
                    console.warn("No speech synthesis voices available.");
                    return;
                }

                const speakerToVoiceMap = {
                    'li': ['Microsoft Molly Online (Natural) - English (United States)', 'Microsoft Molly Online (Natural) - English (United States)'],
                    'maria': ['Microsoft Aria Online (Natural) - English (United States)', 'Microsoft Emma Online (Natural) - English (United States)'],
                    'sarah': ['Microsoft Emma Online (Natural) - English (United States)', 'Microsoft Molly Online (Natural) - English (United States)', 'Microsoft Molly Online (Natural) - English (United States)'],
                    'elizabeth': ['Microsoft Ava Online (Natural) - English (United States)', 'Microsoft Emma Online (Natural) - English (United States)'],
                    'dr. sharma': ['Microsoft Shimmer Online (Natural) - English (United States)', 'Microsoft Fable Online (Natural) - English (United States)', 'Microsoft Emma Online (Natural) - English (United States)'],
                    'anya': ['Microsoft Shimmer Online (Natural) - English (United States)', 'Microsoft Fable Online (Natural) - English (United States)', 'Microsoft Emma Online (Natural) - English (United States)'],
                    'daniel': ['Microsoft Brian Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)', 'Microsoft William Online (Natural) - English (United States)'],
                    'lachlan': ['Microsoft Davis Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)', 'Microsoft William Online (Natural) - English (United States)'],
                    'professor': ['Microsoft Guy Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)', 'Microsoft William Online (Natural) - English (United States)'],
                    'alex': ['Microsoft Onyx Online (Natural) - English (United States)', 'Microsoft Alloy Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)', 'Microsoft William Online (Natural) - English (United States)'],
                    'chris': ['Microsoft Alloy Online (Natural) - English (United States)', 'Microsoft Onyx Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)', 'Microsoft William Online (Natural) - English (United States)'],
                    'david': ['Microsoft Davis Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)', 'Microsoft William Online (Natural) - English (United States)'],
                    'dr. carter': ['Microsoft Brian Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)', 'Microsoft William Online (Natural) - English (United States)'],
                    'ben': ['Microsoft Brian Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)', 'Microsoft William Online (Natural) - English (United States)'],
                    'mr. sterling': ['Microsoft Guy Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)', 'Microsoft William Online (Natural) - English (United States)'],
                    'james': ['Microsoft Guy Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)', 'Microsoft William Online (Natural) - English (United States)'],
                };

                for (const speaker in speakerToVoiceMap) {
                    const voicePriorityList = speakerToVoiceMap[speaker];
                    let chosenVoice = null;
                    for (const voiceName of voicePriorityList) {
                        const foundVoice = availableVoices.find(v => v.name === voiceName);
                        if (foundVoice) {
                            chosenVoice = foundVoice;
                            break; 
                        }
                    }
                    if (chosenVoice) {
                        this.voices[speaker] = chosenVoice;
                    } else {
                        console.warn(`Could not find any specified voices for speaker: "${speaker}"`);
                    }
                }

                this.voices['default'] = 
                    availableVoices.find(v => v.name === 'Microsoft Ava Online (Natural) - English (United States)') || 
                    availableVoices.find(v => v.name === 'Siri') ||
                    availableVoices.find(v => v.lang === 'en-US');
            }
            
            async init() {
                if (this.isInitialized) return;
                try {
                    const warmUp = new SpeechSynthesisUtterance(' ');
                    warmUp.volume = 0;
                    this.synth.speak(warmUp);
                    this.synth.cancel();
                    await this._setupVoices();
                    this.isInitialized = true;
                } catch (e) {
                    console.error("Speech synthesis setup failed:", e);
                }
            }
            
            _cleanTextForSpeech(text) {
                const tempDiv = document.createElement('div');
                const textWithoutSpans = text.replace(/<span aria-hidden="true">.*?<\/span>/g, ' ');
                tempDiv.innerHTML = textWithoutSpans;
                let cleanText = tempDiv.textContent || tempDiv.innerText || '';
                cleanText = cleanText.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, '');
                return cleanText;
            }

            async speak(text, { onEndCallback = null } = {}) {
                if (!this.isInitialized || !this.isTtsEnabled || !text) {
                    if (onEndCallback) onEndCallback();
                    return;
                }

                if (this.synth.speaking) {
                    this.synth.cancel();
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                const cleanText = this._cleanTextForSpeech(text);
                if (!cleanText.trim()) {
                    if (onEndCallback) onEndCallback();
                    return;
                }

                const utter = new SpeechSynthesisUtterance(cleanText);
                utter.voice = this.voices['default'];
                utter.rate = this.speechRate;
                if (onEndCallback) utter.onend = onEndCallback;
                utter.onerror = (e) => {
                    console.error('SpeechSynthesisUtterance.onerror', e);
                    if (onEndCallback) onEndCallback(); 
                };
                
                try {
                    this.synth.speak(utter);
                } catch (e) {
                    console.error("Error calling synth.speak:", e);
                    if (onEndCallback) onEndCallback();
                }
            }
            
            async speakDialogue(text) {
                if (!this.isInitialized || !this.isTtsEnabled || !text || this.isDialoguePlaying) return;
                
                this.cancel(); 
                this.isDialoguePlaying = true;

                const lines = text.split('\n').filter(line => line.trim() !== '' && line.includes(':'));
                const queue = lines.map(line => {
                    const [speaker, ...parts] = line.split(':');
                    const dialogue = parts.join(':').trim();
                    const cleanDialogue = this._cleanTextForSpeech(dialogue);
                    const voiceKey = speaker.toLowerCase().replace(/dr\. |mr\. /g, '').trim();
                    return { text: cleanDialogue, voiceKey: voiceKey };
                }).filter(item => item.text);

                if (queue.length === 0) {
                    this.isDialoguePlaying = false;
                    return;
                }

                const playNext = () => {
                    if (queue.length > 0 && this.isTtsEnabled) {
                        const item = queue.shift();
                        const utter = new SpeechSynthesisUtterance(item.text);
                        utter.voice = this.voices[item.voiceKey] || this.voices['default'];
                        utter.rate = this.speechRate;
                        utter.onend = playNext;
                        utter.onerror = (e) => {
                            console.error('Speech synthesis error in dialogue:', e);
                            playNext(); 
                        };
                        this.synth.speak(utter);
                    } else {
                        this.isDialoguePlaying = false;
                    }
                };
                playNext();
            }
            
            cancel() {
                if (this.synth) {
                    this.isDialoguePlaying = false;
                    this.synth.cancel(); 
                }
            }
            
            toggleTTS(forceState) {
                this.isTtsEnabled = forceState === undefined ? !this.isTtsEnabled : forceState;
                if (!this.isTtsEnabled) {
                    this.cancel();
                }
                return this.isTtsEnabled;
            }
        }


        // --- Sound Engine (Tone.js) ---
        const coinSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 } }).toDestination();
        const collectSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.2, sustain: 0.1, release: 0.1 } }).toDestination();
        collectSynth.volume.value = -6;
        const sparkleSynth = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.05, sustain: 0, release: 0.1 } }).toDestination();
        sparkleSynth.volume.value = -12;
        const burstSynth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0 } }).toDestination();
        burstSynth.volume.value = -10;
        let feedbackSynth;

        // --- Global App State and Functions ---
        const speechService = new SpeechService();
        let score = 0, currentPage = lessonData.startPageId, timerInterval;
        const pageHistory = [lessonData.startPageId];
        let pageSequence = [];
        let earnedBadges = [];
        let selectedWord = { element: null, text: '' };

        window.toggleTTS = (button) => {
            const isNowEnabled = speechService.toggleTTS();
            const iconPath = isNowEnabled 
                ? "M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"
                : "M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z M17 14l-4-4m0 4l4-4";
            button.querySelector('svg').classList.toggle('text-gray-600', isNowEnabled);
            button.querySelector('svg').classList.toggle('text-gray-400', !isNowEnabled);
            button.querySelector('path').setAttribute('d', iconPath);

            if (isNowEnabled) {
                const pageData = lessonData.pages.find(p => p.id === currentPage);
                const targetPage = document.getElementById(`page-${currentPage}`);
                if (pageData && pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else if (targetPage) {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    if (readableContent) speechService.speak(readableContent.innerText);
                    else if (titleElement) speechService.speak(titleElement.innerText);
                }
            }
        };

        window.startApp = async function() {
            await speechService.init(); 
            try { 
                await Tone.start(); 
                feedbackSynth = new Tone.PolySynth(Tone.Synth).toDestination(); 
            } catch (e) { console.error(e); }
            navigateTo(lessonData.homePageId);
        }

        const playSound = (correct) => {
            if (feedbackSynth) feedbackSynth.triggerAttackRelease(correct ? ["C5", "E5", "G5"] : "A2", "8n", Tone.now());
        }
        
        function startTimer(duration, display, onComplete) {
            let timer = duration;
            const update = () => { display.textContent = `${String(Math.floor(timer/60)).padStart(2,'0')}:${String(timer%60).padStart(2,'0')}`; };
            update();
            timerInterval = setInterval(() => { timer--; update(); if (timer < 0) { clearInterval(timerInterval); if (onComplete) onComplete(); } }, 1000);
        }

        window.navigateTo = (pageId) => {
            const targetPage = document.getElementById(`page-${pageId}`);
            if (!targetPage) {
                if (pageId === lessonData.homePageId) {
                   // This is the main menu, which is valid but doesn't have a `pages` entry
                } else {
                    return console.warn('navigateTo: no page found for id', pageId);
                }
            }
            if (pageId === currentPage) return;
            
            clearInterval(timerInterval);
            speechService.cancel();

            document.getElementById(`page-${currentPage}`)?.classList.remove('active');
            targetPage.classList.add('active');
            currentPage = pageId;
            if (pageHistory[pageHistory.length - 1] !== currentPage) pageHistory.push(currentPage);
            
            const pageData = lessonData.pages.find(p => p.id === pageId);

            if (pageData) {
                if (pageData.type === 'timer') {
                    const timerEl = document.getElementById(pageData.content.timerId);
                    if (timerEl) startTimer(pageData.content.duration, timerEl, goNext);
                }
                
                if (pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else if (pageData.type === 'certificate') {
                    runCompletionAnimation();
                    const readableContent = targetPage.querySelector('.readable-content');
                    if (readableContent) speechService.speak(readableContent.innerText);
                } else {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    if (readableContent) {
                        speechService.speak(readableContent.innerText);
                    } else if (titleElement) {
                        speechService.speak(titleElement.innerText);
                    }
                }
            } else if (pageId === lessonData.homePageId) {
                 const titleElement = targetPage.querySelector('h2, h3');
                 if (titleElement) {
                   speechService.speak(titleElement.innerText);
                 }
            }

            updateNavButtons();
            window.scrollTo(0, 0);
        }

        window.goNext = () => {
            const currentIndex = pageSequence.indexOf(currentPage);
            if (currentIndex > -1 && currentIndex < pageSequence.length - 1) navigateTo(pageSequence[currentIndex + 1]);
        }
        window.goBack = () => {
            if (pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); }
        }

        function updateNavButtons() {
            const nav = document.getElementById('nav-header');
            if (!nav) return;
            nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
            const backBtn = nav.querySelector('button:first-child');
            backBtn.disabled = pageHistory.length <= 1;
            backBtn.classList.toggle('opacity-50', backBtn.disabled);
            const nextBtn = nav.querySelector('button:last-child');
            const currentIndex = pageSequence.indexOf(currentPage);
            const isLast = currentIndex >= pageSequence.length - 1;
            nextBtn.disabled = isLast || currentPage === lessonData.homePageId;
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }
        
        function showFeedbackMessage(isCorrect) {
            const correctFeedback = ["That's right!", "You got it!", "Excellent!", "Perfect!", "Great job!", "You're on fire!"];
            const incorrectFeedback = ["Not quite!", "Give it another look!", "Keep trying!", "Don't give up!", "You'll get the next one!"];
            const message = isCorrect ? correctFeedback[Math.floor(Math.random() * correctFeedback.length)] : incorrectFeedback[Math.floor(Math.random() * incorrectFeedback.length)];
            
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `feedback-toast ${isCorrect ? 'correct' : 'encouraging'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function updateScore(points) {
            score += points;
            document.getElementById('score-display').textContent = score;
        }

        function triggerRandomReward() {
            const funRewards = [1, 2, 3, 4, 7];
            const randomType = funRewards[Math.floor(Math.random() * funRewards.length)];
            triggerReward(randomType);
        }

        window.checkTfngAnswer = function(clickedButton, chosenAnswer, correctAnswer) {
            const buttonContainer = clickedButton.parentElement;
            Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
            const isCorrect = chosenAnswer === correctAnswer;
            showFeedbackMessage(isCorrect);
            
            const feedbackIcon = document.createElement('span');
            feedbackIcon.className = `ml-2 text-xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'}`;
            feedbackIcon.textContent = isCorrect ? '‚úì' : '‚úó';
            clickedButton.closest('.question-group').appendChild(feedbackIcon);

            if (isCorrect) {
                playSound(true);
                triggerRandomReward();
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-green-500');
                updateScore(10);
            } else {
                playSound(false);
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-red-600');
                const correctBtn = Array.from(buttonContainer.children).find(btn => btn.textContent === correctAnswer.charAt(0));
                if (correctBtn) correctBtn.className = correctBtn.className.replace(/bg-\w+-500/, 'bg-green-500');
            }
        }
        
        window.checkMcqAnswer = function(button, isCorrect) {
            const questionGroup = button.closest('.question-group');
            questionGroup.querySelectorAll('.quiz-option').forEach(opt => opt.disabled = true);
            showFeedbackMessage(isCorrect);

            const feedbackIcon = document.createElement('span');
            feedbackIcon.className = `ml-2 text-xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'}`;
            feedbackIcon.textContent = isCorrect ? '‚úì' : '‚úó';
            button.appendChild(feedbackIcon);

            if (isCorrect) {
                playSound(true);
                triggerRandomReward();
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'border-green-600', 'text-white');
                updateScore(10);
            } else {
                playSound(false);
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'border-red-600', 'text-white');
                const correctButton = questionGroup.querySelector(".quiz-option[data-correct='true']");
                if (correctButton) {
                    correctButton.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    correctButton.classList.add('bg-green-500', 'border-green-600', 'text-white');
                }
            }
        }

        function initGapFill(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return;
            const gaps = page.querySelectorAll('.gap');
            const words = page.querySelectorAll('.word-bank-word');
            const wordBank = page.querySelector('.word-bank-container');

            words.forEach(word => {
                word.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', word.dataset.word); setTimeout(() => word.classList.add('opacity-50'), 0); });
                word.addEventListener('dragend', () => word.classList.remove('opacity-50'));
                word.addEventListener('click', handleWordClick);
            });

            gaps.forEach(gap => {
                gap.addEventListener('dragover', e => e.preventDefault());
                gap.addEventListener('drop', e => handleDrop(e, gap));
                gap.addEventListener('click', handleGapClick);
            });

            function handleWordClick(e) {
                const clickedWord = e.currentTarget;
                if (clickedWord.parentElement.classList.contains('gap')) {
                    clickedWord.parentElement.classList.remove('correct', 'incorrect');
                    wordBank.appendChild(clickedWord);
                    return;
                }
                if (selectedWord.element) selectedWord.element.classList.remove('selected');
                if (selectedWord.element === clickedWord) {
                    selectedWord = { element: null, text: '' };
                } else {
                    selectedWord = { element: clickedWord, text: clickedWord.dataset.word };
                    clickedWord.classList.add('selected');
                }
            }

            function handleGapClick(e) {
                const clickedGap = e.currentTarget;
                if (!selectedWord.element || clickedGap.children.length > 0) return;
                const wordElement = selectedWord.element;
                clickedGap.appendChild(wordElement);
                wordElement.classList.remove('selected');
                checkGap(clickedGap);
                selectedWord = { element: null, text: '' };
            }

            function handleDrop(e, gap) {
                e.preventDefault();
                if (gap.children.length > 0) return;
                const wordText = e.dataTransfer.getData('text/plain');
                const wordElement = page.querySelector(`.word-bank-word[data-word="${wordText}"]`);
                if (wordElement) {
                    gap.appendChild(wordElement);
                    checkGap(gap);
                }
            }

            function checkGap(gap) {
                const word = gap.querySelector('.word-bank-word');
                const isCorrect = word && word.dataset.word === gap.dataset.answer;
                gap.classList.remove('correct', 'incorrect');
                gap.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (isCorrect) {
                    playSound(true);
                    triggerRandomReward();
                    updateScore(10);
                    showFeedbackMessage(true);
                    word.draggable = false;
                } else {
                    playSound(false);
                    showFeedbackMessage(false);
                }
            }
        }
        
        window.generateCertificate = function() {
            const name = document.getElementById('name-input-cert').value || "Dedicated Learner";
            document.getElementById('certificate-name').textContent = name;
            document.getElementById('certificate-score').textContent = score;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
            document.getElementById('cert-initial-controls').classList.add('hidden');
            document.getElementById('cert-generated-controls').classList.remove('hidden');
        }

        window.downloadCertificateAsImage = function() {
            const certElement = document.getElementById('certificate-to-print');
            html2canvas(certElement, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'rooftop-gardens-certificate.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }
        
        function runCompletionAnimation() {
            const canvas = document.getElementById('completion-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
            let fireworks = [], confetti = [];

            function Firework(sx, sy, tx, ty) { this.x = sx; this.y = sy; this.sx = sx; this.sy = sy; this.tx = tx; this.ty = ty; this.distanceToTarget = Math.sqrt(Math.pow(tx - sx, 2) + Math.pow(ty - sy, 2)); this.distanceTraveled = 0; this.angle = Math.atan2(ty - sy, tx - sx); this.speed = 2; this.acceleration = 1.05; this.brightness = Math.random() * 50 + 50; this.targetRadius = 1; this.particles = []; }
            Firework.prototype.update = function(index) { this.speed *= this.acceleration; let vx = Math.cos(this.angle) * this.speed; let vy = Math.sin(this.angle) * this.speed; this.distanceTraveled = Math.sqrt(Math.pow(this.x - this.sx, 2) + Math.pow(this.y - this.sy, 2)); if (this.distanceTraveled >= this.distanceToTarget) { for(let i = 0; i < 30; i++) { this.particles.push(new Particle(this.tx, this.ty)); } fireworks.splice(index, 1); } else { this.x += vx; this.y += vy; } }
            Firework.prototype.draw = function() { ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x - Math.cos(this.angle) * 10, this.y - Math.sin(this.angle) * 10); ctx.strokeStyle = `hsl(${Math.random() * 360}, 100%, ${this.brightness}%)`; ctx.stroke(); }
            function Particle(x, y) { this.x = x; this.y = y; this.angle = Math.random() * Math.PI * 2; this.speed = Math.random() * 10; this.friction = 0.95; this.gravity = 1; this.hue = Math.random() * 360; this.brightness = Math.random() * 50 + 50; this.alpha = 1; this.decay = Math.random() * 0.03 + 0.015; }
            Particle.prototype.update = function(index) { this.speed *= this.friction; this.x += Math.cos(this.angle) * this.speed; this.y += Math.sin(this.angle) * this.speed + this.gravity; this.alpha -= this.decay; if (this.alpha <= this.decay) this.particles.splice(index, 1); }
            Particle.prototype.draw = function() { ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); ctx.fillStyle = `hsla(${this.hue}, 100%, ${this.brightness}%, ${this.alpha})`; ctx.fill(); }
            function Confetti() { this.x = Math.random() * canvas.width; this.y = -20; this.w = 10; this.h = 20; this.speed = Math.random() * 3 + 2; this.gravity = 0.5; this.angle = 0; this.rotation = Math.random() * 0.1 - 0.05; this.color = `hsl(${Math.random() * 360}, 100%, 50%)`; }
            Confetti.prototype.update = function(index) { this.y += this.speed; this.speed += this.gravity; this.angle += this.rotation; if (this.y > canvas.height) confetti.splice(index, 1); }
            Confetti.prototype.draw = function() { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle); ctx.fillStyle = this.color; ctx.fillRect(-this.w / 2, -this.h / 2, this.w, this.h); ctx.restore(); }

            let animationRunning = true;
            function animate() { if (!animationRunning) return; ctx.globalCompositeOperation = 'destination-out'; ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.globalCompositeOperation = 'lighter'; fireworks.forEach((f, i) => { f.draw(); f.update(i); f.particles.forEach((p, j) => { p.draw(); p.update(j); }); }); confetti.forEach((c, i) => { c.draw(); c.update(i); }); requestAnimationFrame(animate); }
            
            const interval = setInterval(() => { fireworks.push(new Firework(canvas.width / 2, canvas.height, Math.random() * canvas.width, Math.random() * canvas.height / 2)); for(let i = 0; i < 10; i++) confetti.push(new Confetti()); }, 800);

            setTimeout(() => { clearInterval(interval); setTimeout(() => animationRunning = false, 5000); }, 5000);

            animate();
        }

        // --- Reward Animation Engine ---
        function createRewardElement(type = 'coin') {
            const animationContainer = document.getElementById('reward-animation-container');
            const element = document.createElement('div');
            element.className = type;
            if (type === 'coin') element.textContent = 'C';
            element.style.left = `${Math.random() * 80 + 10}%`;
            element.style.top = `${Math.random() * 40 + 30}%`; // Start lower on the screen
            animationContainer.appendChild(element);
            return element;
        }

        function animateToScore(element, animationType = 'fly-straight', duration = 1200) {
            const scoreElement = document.getElementById('score-display');
            if (!scoreElement) {
                element.remove();
                return;
            }
            const scoreRect = scoreElement.getBoundingClientRect();
            const elementRect = element.getBoundingClientRect();
            
            const deltaX = scoreRect.left - elementRect.left + (scoreRect.width / 2) - (elementRect.width / 2);
            const deltaY = scoreRect.top - elementRect.top + (scoreRect.height / 2) - (elementRect.height / 2);
            
            element.style.setProperty('--end-x', `${deltaX}px`);
            element.style.setProperty('--end-y', `${deltaY}px`);
            element.classList.add(animationType);
            
            setTimeout(() => {
                element.remove();
                collectSynth.triggerAttackRelease(['C5', 'E5', 'G5'], '8n', Tone.now());
                scoreElement.classList.add('hit');
                setTimeout(() => scoreElement.classList.remove('hit'), 200);
            }, duration);
        }
        
        function createSparkle(x, y) {
            const animationContainer = document.getElementById('reward-animation-container');
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.style.left = `${x}px`;
            sparkle.style.top = `${y}px`;
            animationContainer.appendChild(sparkle);
            sparkleSynth.triggerAttackRelease('C7', '32n');
            setTimeout(() => sparkle.remove(), 800);
        }

        function triggerReward(type) {
            switch(type) {
                case 1: // Flying Coins
                    for (let i = 0; i < 5; i++) setTimeout(() => { const c = createRewardElement('coin'); coinSynth.triggerAttackRelease(`C${5+i}`, '16n'); animateToScore(c, 'fly-straight', 1000); }, i * 100);
                    break;
                case 2: // Bouncing Tokens
                    for (let i = 0; i < 4; i++) setTimeout(() => { const t = createRewardElement('token'); coinSynth.triggerAttackRelease('G4', '16n'); animateToScore(t, 'fly-bounce', 1500); }, i * 150);
                    break;
                case 3: // Spiral Gems
                    for (let i = 0; i < 6; i++) setTimeout(() => { const g = createRewardElement('gem'); coinSynth.triggerAttackRelease(`E${4+i}`, '8n'); animateToScore(g, 'fly-spiral', 1800); }, i * 120);
                    break;
                case 4: // Magnetic Stars
                    for (let i = 0; i < 4; i++) setTimeout(() => { const s = createRewardElement('star'); coinSynth.triggerAttackRelease('A5', '8n'); animateToScore(s, 'fly-magnetic', 1300); }, i * 200);
                    break;
                case 7: // Sparkle Trail
                    for (let i = 0; i < 4; i++) {
                        setTimeout(() => {
                            const coin = createRewardElement('coin');
                             coinSynth.triggerAttackRelease(`D${5+i}`, '16n');
                            animateToScore(coin, 'fly-arc', 1200);
                            let sparkleInterval = setInterval(() => {
                                const rect = coin.getBoundingClientRect();
                                if (rect.width > 0) createSparkle(rect.left, rect.top);
                            }, 80);
                            setTimeout(() => clearInterval(sparkleInterval), 1100);
                        }, i * 200);
                    }
                    break;
            }
        }
        // --- End of Reward Animation Engine ---

        function createPageElement(id, content) {
            const section = document.createElement('section');
            section.id = `page-${id}`;
            section.className = 'page';
            section.innerHTML = content;
            document.getElementById('dynamic-pages-container').appendChild(section);
        }
        
        function populateQuizzes() {
            // Vocab Match Quiz
            const vocabMatchPage = lessonData.pages.find(p => p.id === 'vocab-match');
            vocabMatchPage.content.questions = lessonData.vocabulary.map((v, i) => {
                const otherDefs = lessonData.vocabulary.filter((_, idx) => idx !== i).map(item => item.def);
                const options = [v.def, ...otherDefs.sort(() => 0.5 - Math.random()).slice(0, 3)].sort(() => 0.5 - Math.random());
                return { question: `What is the definition of "${v.word}"?`, options: options, correctAnswer: v.def };
            });

            // Reading Comprehension Quizzes
            lessonData.pages.find(p => p.id === 'reading-quiz-gap-fill').content.sentences = [
                { text: ['The soil and plants on a green roof provide natural', 'for the building below.'], answer: 'insulation' }, { text: ['By growing food locally, we can create a more', 'food system.'], answer: 'sustainable' }, { text: ['An efficient', 'system is needed to make sure the plants get enough water.'], answer: 'irrigation' }, { text: ['Rooftop gardens can help lower the temperature in cities, combating the urban', 'effect.'], answer: 'heat island' }, { text: ['Plants use sunlight to create food through a process called', '.'], answer: 'photosynthesis' }
            ];
            lessonData.pages.find(p => p.id === 'reading-quiz-tfng').content.questions = [
                { statement: 'Rooftop gardens make cities hotter.', correctAnswer: 'False' }, { statement: 'Growing food on roofs increases the distance food has to travel.', correctAnswer: 'False' }, { statement: 'A building needs to be strong enough to hold a rooftop garden.', correctAnswer: 'True' }, { statement: 'Green roofs can attract wildlife like bees and birds.', correctAnswer: 'True' }, { statement: 'Rooftop gardens require no water.', correctAnswer: 'False' },
            ];
            lessonData.pages.find(p => p.id === 'reading-quiz-mcq').content.questions = [
                 { question: 'What is the main topic of the advanced reading text?', options: ['The history of gardening.', 'The challenges of living in a city.', 'The benefits and challenges of rooftop gardens.', 'How to build a rooftop garden.'], correctAnswer: 'The benefits and challenges of rooftop gardens.' }, { question: 'The ‚Äúurban heat island effect‚Äù means that...', options: ['Cities have many beautiful islands.', 'Cities are much warmer than nearby rural areas.', 'Cities are much colder than nearby rural areas.', 'It is easier to grow tropical plants in cities.'], correctAnswer: 'Cities are much warmer than nearby rural areas.' }, { question: 'According to the text, how do rooftop gardens improve sustainability?', options: ['By using more electricity.', 'By reducing the need for heating and cooling.', 'By making buildings taller.', 'By creating more traffic.'], correctAnswer: 'By reducing the need for heating and cooling.' }, { question: 'Which of the following is NOT a benefit of rooftop gardens mentioned in the text?', options: ['Providing natural insulation.', 'Increasing urban biodiversity.', 'Producing fresh, local food.', 'Increasing the city‚Äôs population.'], correctAnswer: 'Increasing the city‚Äôs population.' }, { question: 'What is a major challenge when creating a rooftop garden?', options: ['Finding enough sunlight.', 'Ensuring the roof can support the weight.', 'Finding colorful plants.', 'Keeping the garden a secret.'], correctAnswer: 'Ensuring the roof can support the weight.' },
            ];
            
            // Listening Quizzes
            lessonData.pages.find(p => p.id === 'lecture-uni-quiz-mcq').content.questions = [
                { question: 'What is another name for a rooftop garden?', options: ['A green roof', 'A sky park', 'A building top', 'A waterproof membrane'], correctAnswer: 'A green roof' }, { question: 'How do rooftop gardens help with stormwater?', options: ['They create more rain', 'Act like sponges', 'They block the drains', 'They purify the water'], correctAnswer: 'Act like sponges' }, { question: 'What is a major challenge?', options: ['Too much sunlight', 'Lack of seeds', 'Structural capacity', 'Finding gardeners'], correctAnswer: 'Structural capacity' }, { question: 'What process cools the air like a natural AC?', options: ['Photosynthesis', 'Evapotranspiration', 'Insulation', 'Runoff'], correctAnswer: 'Evapotranspiration' }, { question: 'What is a key benefit of urban agriculture on rooftops?', options: ['It uses more pesticides', 'It increases food miles', 'It reduces food miles', 'It requires more space'], correctAnswer: 'It reduces food miles' }
            ];
            lessonData.pages.find(p => p.id === 'lecture-uni-quiz-tfng').content.questions = [
                { statement: "David defines what a green roof is.", correctAnswer: 'False' }, { statement: "Rooftop gardens can increase a building's lifespan.", correctAnswer: 'True' }, { statement: "The professor states that bees are not important for urban ecosystems.", correctAnswer: 'False' }, { statement: "Lightweight growing mediums are a potential solution to structural challenges.", correctAnswer: 'True' }, { statement: "The lecture only focuses on the benefits, not the challenges.", correctAnswer: 'False' }
            ];
            lessonData.pages.find(p => p.id === 'lecture-uni-quiz-gap-fill').content.sentences = [
                { text: ['A green roof is a layer of vegetation planted over a waterproofing', '.'], answer: 'membrane' }, { text: ['Rooftop gardens act like', 'during rainfall.'], answer: 'sponges' }, { text: ['The', 'effect is where cities are warmer than rural areas.'], answer: 'urban heat island' }, { text: ['Rooftop gardens create new', 'for urban wildlife.'], answer: 'habitats' }, { text: ['Policy incentives and building code', 'are crucial for wider adoption.'], answer: 'updates' }
            ];

            lessonData.pages.find(p => p.id === 'lecture-expert-quiz-mcq').content.questions = [
                { question: 'Alex says green roofs can be how much cooler than conventional roofs?', options: ['5‚Äì10¬∞F', '10‚Äì20¬∞F', '30‚Äì40¬∞F', '50‚Äì60¬∞F'], correctAnswer: '30‚Äì40¬∞F' }, { question: 'What is a key role of rooftop gardens in water management?', options: ['Creating more rain', 'Filtering pollutants', 'Blocking pipes', 'Increasing pollution'], correctAnswer: 'Filtering pollutants' }, { question: 'Sarah mentions that rooftop gardens can enhance what social aspect?', options: ['Traffic flow', 'Internet speed', 'Mental well-being', 'Noise levels'], correctAnswer: 'Mental well-being' }, { question: 'How do green roofs economically benefit a building\'s structure?', options: ['They weaken it', 'They extend its lifespan', 'They make it cheaper', 'They have no effect'], correctAnswer: 'They extend its lifespan' }, { question: 'What innovative use for rooftop gardens does Sarah mention?', options: ['Parking lots', 'Swimming pools', 'Event spaces', 'Landing pads'], correctAnswer: 'Event spaces' }
            ];
            lessonData.pages.find(p => p.id === 'lecture-expert-quiz-tfng').content.questions = [
                { statement: "Alex is an environmental consultant from London.", correctAnswer: 'False' }, { statement: "Rooftop gardens can improve air quality by producing oxygen.", correctAnswer: 'True' }, { statement: "Sarah argues that rooftop gardens decrease property values.", correctAnswer: 'False' }, { statement: "The talk concludes that rooftop gardens are a multifaceted solution.", correctAnswer: 'True' }, { statement: "Alex focuses only on the social benefits.", correctAnswer: 'False' }
            ];
            lessonData.pages.find(p => p.id === 'lecture-expert-quiz-gap-fill').content.sentences = [
                { text: ['Rooftop gardens offer a crucial way to combat the urban', 'effect.'], answer: 'heat island' }, { text: ['They play a vital role in', 'management by absorbing rainwater.'], answer: 'stormwater' }, { text: ['These spaces can build a stronger sense of', '.'], answer: 'community' }, { text: ['Economically, rooftop gardens can increase property', '.'], answer: 'values' }, { text: ['Local food production reduces', 'costs.'], answer: 'transportation' }
            ];

            lessonData.pages.find(p => p.id === 'podcast-convo-quiz-mcq').content.questions = [
                { question: 'What increase in rooftop gardens did NYC see in 2022?', options: ['5%', '10%', '15%', '20%'], correctAnswer: '15%' }, { question: 'How much can green roofs reduce building cooling costs, according to Sarah?', options: ['Up to 10%', 'Up to 15%', 'Up to 25%', 'Up to 50%'], correctAnswer: 'Up to 25%' }, { question: 'A typical green roof can absorb what percentage of rainwater runoff?', options: ['30%', '50%', '70%', '90%'], correctAnswer: '70%' }, { question: 'Some Chicago rooftop farms produce how much produce annually?', options: ['Over 1,000 pounds', 'Over 5,000 pounds', 'Over 10,000 pounds', 'Over 20,000 pounds'], correctAnswer: 'Over 10,000 pounds' }, { question: 'Since what year has Toronto mandated green roofs on new large buildings?', options: ['2005', '2009', '2012', '2015'], correctAnswer: '2009' }
            ];
             lessonData.pages.find(p => p.id === 'podcast-convo-quiz-tfng').content.questions = [
                { statement: "Chris is a landscape architect from London.", correctAnswer: 'False' }, { statement: "The podcast states that green roofs have no impact on biodiversity.", correctAnswer: 'False' }, { statement: "According to the speakers, the number of green roofs has doubled in the last decade.", correctAnswer: 'True' }, { statement: "Alex believes rooftop gardens have no economic benefits.", correctAnswer: 'False' }, { statement: "The podcast concludes that rooftop gardens are not a good investment for cities.", correctAnswer: 'False' }
            ];
            lessonData.pages.find(p => p.id === 'podcast-convo-quiz-gap-fill').content.sentences = [
                { text: ['Sarah is an environmental', 'from London.'], answer: 'consultant' }, { text: ['They help with', ', reduce stormwater runoff, and create valuable green spaces.'], answer: 'insulation' }, { text: ['Providing fresh produce reduces food', '.'], answer: 'miles' }, { text: ['A square meter of a green roof can support dozens of', 'species.'], answer: 'insect' }, { text: ['The city of Toronto has', 'green roofs on new buildings over a certain size.'], answer: 'mandated' }
            ];

            lessonData.pages.find(p => p.id === 'podcast-futures-quiz-mcq').content.questions = [
                { question: 'What process cools the air, acting as a "natural air conditioner"?', options: ['Photosynthesis', 'Evapotranspiration', 'Insulation', 'Biodiversity'], correctAnswer: 'Evapotranspiration' }, { question: 'What is a key challenge mentioned by Dr. Carter?', options: ['Too much rain', 'Structural integrity', 'Lack of sunlight', 'Finding enough bees'], correctAnswer: 'Structural integrity' }, { question: 'What makes the experts optimistic about the future of rooftop gardens?', options: ['New laws banning concrete roofs', 'Growing public interest and technological advancements', 'A decrease in city populations', 'The high cost of food'], correctAnswer: 'Growing public interest and technological advancements' }, { question: 'Dr. Carter is a sustainable development consultant from where?', options: ['London', 'New York', 'Sydney', 'Toronto'], correctAnswer: 'Sydney' }, { question: 'What crucial habitats do rooftop gardens create, according to Mr. Sterling?', options: ['Habitats for fish', 'Habitats for large mammals', 'Habitats for pollinators', 'Habitats for desert animals'], correctAnswer: 'Habitats for pollinators' }
            ];
            lessonData.pages.find(p => p.id === 'podcast-futures-quiz-tfng').content.questions = [
                { statement: "Dr. Anya Sharma is the host of the podcast.", correctAnswer: 'True' }, { statement: "Dr. Ben Carter is an urban ecologist from London.", correctAnswer: 'False' }, { statement: "The podcast suggests that rooftop gardens have no challenges.", correctAnswer: 'False' }, { statement: "The experts are optimistic about the future of rooftop gardens.", correctAnswer: 'True' }, { statement: "The podcast concludes that rooftop gardens are only for aesthetic purposes.", correctAnswer: 'False' }
            ];
            lessonData.pages.find(p => p.id === 'podcast-futures-quiz-gap-fill').content.sentences = [
                { text: ['The podcast is called Urban', '.'], answer: 'Futures' }, { text: ['By growing food locally, we drastically reduce food', '.'], answer: 'miles' }, { text: ['Engineering considerations include structural', 'and drainage.'], answer: 'integrity' }, { text: ['The initial', 'of installation can be a hurdle.'], answer: 'cost' }, { text: ['Growing public interest and', 'advancements make it increasingly feasible.'], answer: 'technological' }
            ];

            lessonData.pages.find(p => p.id === 'debate-planning-quiz-gap-fill').content.sentences = [
                { text: ['Elizabeth says the rooftop farm would reduce the', 'footprint.'], answer: 'carbon' }, { text: ['Lachlan supports the community gardens because they help', 'neighborhoods.'], answer: 'lower-income' }, { text: ['Elizabeth asks Lachlan to explain the term', 'capital.'], answer: 'social' }, { text: ['The debate is a balancing act between immediate local impact versus broader', 'benefits.'], answer: 'city-wide' }, { text: ['Daniel mentions the environmental return on', 'for the rooftop farm is clear.'], answer: 'investment' }
            ];
            lessonData.pages.find(p => p.id === 'debate-planning-quiz-mcq').content.questions = [
                { question: 'What is the main reason Elizabeth supports the rooftop farm?', options: ['Its large-scale environmental impact', 'It is cheaper to build', 'It is better for social capital', 'It provides more jobs'], correctAnswer: 'Its large-scale environmental impact' }, { question: 'Lachlan believes the community gardens are the most ethical choice because they support what group?', options: ['Wealthy neighborhoods', 'Lower-income neighborhoods', 'Suburban areas', 'Tourists'], correctAnswer: 'Lower-income neighborhoods' }, { question: 'What concept does Lachlan explain as "building connections" and a "sense of belonging"?', options: ['Carbon footprint', 'Social capital', 'Food literacy', 'Return on investment'], correctAnswer: 'Social capital' }, { question: 'What alternative does Elizabeth suggest?', options: ['Cancel both projects', 'Build both at the same time', 'A phased approach', 'Ask the mayor to decide'], correctAnswer: 'A phased approach' }, { question: 'What does the group ultimately agree on?', options: ['The rooftop farm is best', 'The community gardens are best', "It's a complex issue with no easy answers", 'They need more data'], correctAnswer: "It's a complex issue with no easy answers" }
            ];
            lessonData.pages.find(p => p.id === 'debate-planning-quiz-tfng').content.questions = [
                { statement: "The debate is about choosing between a new library and a new park.", correctAnswer: 'False' }, { statement: "Daniel agrees with Lachlan that social value is important but prioritizes environmental benefits.", correctAnswer: 'True' }, { statement: "Lachlan argues that the rooftop farm is better for mental health.", correctAnswer: 'False' }, { statement: "The group decides definitively to fund the community gardens first.", correctAnswer: 'False' }, { statement: "Dr. Chen is a participant in the debate.", correctAnswer: 'False' }
            ];

            lessonData.pages.find(p => p.id === 'dilemma-ethics-quiz-gap-fill').content.sentences = [
                { text: ['The dilemma is about a factory', 'leak.'], answer: 'chemical' }, { text: ['Lachlan argues that the village has not', 'to any risk.'], answer: 'consented' }, { text: ['Elizabeth suggests a', 'approach, focusing on maximizing lives saved.'], answer: 'utilitarian' }, { text: ['Daniel says in crisis situations, prioritizing', 'lives is most defensible.'], answer: 'immediate' }, { text: ['Lachlan questions if directly', 'a community is ever the best course of action.'], answer: 'poisoning' }
            ];
            lessonData.pages.find(p => p.id === 'dilemma-ethics-quiz-mcq').content.questions = [
                { question: 'What is Elizabeth\'s initial proposed course of action?', options: ['Flood the factory', 'Divert the chemical into the river', 'Evacuate the workers', 'Do nothing'], correctAnswer: 'Divert the chemical into the river' }, { question: 'What is Lachlan\'s primary ethical concern with diverting the chemical?', options: ['The cost of cleanup', 'Harming an innocent community', 'Losing the technology', 'The factory\'s reputation'], correctAnswer: 'Harming an innocent community' }, { question: 'What analogy does Daniel use to justify his position?', options: ['A sinking ship', 'A fire rescue', 'A medical emergency', 'A flood evacuation'], correctAnswer: 'A fire rescue' }, { question: 'What framework does Elizabeth suggest might be useful?', options: ['A legal framework', 'A utilitarian approach', 'A historical precedent', 'A financial model'], correctAnswer: 'A utilitarian approach' }, { question: 'What does the group agree on at the end of the discussion?', options: ['The factory should be shut down', 'There is no easy answer', 'The village must be evacuated', 'The technology should be saved'], correctAnswer: 'There is no easy answer' }
            ];
            lessonData.pages.find(p => p.id === 'dilemma-ethics-quiz-tfng').content.questions = [
                { statement: "Daniel believes saving the workers is the most defensible action.", correctAnswer: 'True' }, { statement: "Elizabeth says the technology is more important than human lives.", correctAnswer: 'False' }, { statement: "Lachlan believes poisoning the river is never ethically acceptable.", correctAnswer: 'True' }, { statement: "The group decides to divert the chemicals into the river.", correctAnswer: 'False' }, { statement: "The potential loss of 'world-changing technology' is mentioned as a factor.", correctAnswer: 'True' }
            ];
        }

        function initializeLesson() {
            document.getElementById('main-title').innerHTML = lessonData.title;
            document.getElementById('main-subtitle').innerHTML = lessonData.subtitle;
            document.getElementById('main-svg-container').innerHTML = `<svg viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:rgb(16, 185, 129);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(250, 204, 21);stop-opacity:1" /></linearGradient></defs><rect width="600" height="300" fill="#f0fdf4"/><path d="M50,250 C150,150 250,150 300,200 S400,250 550,180" stroke="url(#grad1)" stroke-width="5" fill="none" stroke-linecap="round"/><path d="M20,180 Q100,100 250,180 T 480,180" stroke="#a7f3d0" stroke-width="10" fill="none" stroke-linecap="round"/><text x="50%" y="35%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="48" fill="#065f46" font-weight="bold">Greening the Skyline</text></svg>`;

            populateQuizzes();

            const menuButtons = lessonData.mainMenu.map(item => {
                const colors = { green: 'bg-green-500 border-green-700', blue: 'bg-blue-500 border-blue-700', sky: 'bg-sky-500 border-sky-700', amber: 'bg-amber-500 border-amber-700', rose: 'bg-rose-500 border-rose-700', violet: 'bg-violet-500 border-violet-700', teal: 'bg-teal-500 border-teal-700', orange: 'bg-orange-500 border-orange-700', indigo: 'bg-indigo-500 border-indigo-700', lime: 'bg-lime-500 border-lime-700', emerald: 'bg-emerald-500 border-emerald-700', red: 'bg-red-500 border-red-700', purple: 'bg-purple-500 border-purple-700' };
                return `<button onclick="navigateTo('${item.target}')" class="btn-animated-3d ${colors[item.color] || colors['green']} text-white font-bold text-xl p-4 rounded-xl">${item.text}</button>`;
            }).join('');
            createPageElement(lessonData.homePageId, `<div class="bg-white rounded-2xl shadow-lg p-8"><h2 class="text-4xl font-bold text-center text-green-800 mb-8">Main Menu</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4">${menuButtons}</div></div>`);
            
            pageSequence = [lessonData.startPageId, lessonData.homePageId];
            const menuOrder = lessonData.mainMenu.map(item => item.target);
            const pageOrderMap = {
                'tps-start': ['tps-think', 'tps-pair', 'tps-share'],
                'warm-up': ['vocab-start'],
                'vocab-start': lessonData.vocabulary.map((v, i) => `vocab-${i}`),
                'reading-main': ['reading-quiz-gap-fill', 'reading-quiz-tfng', 'reading-quiz-mcq'],
                'lecture-uni': ['lecture-uni-quiz-mcq', 'lecture-uni-quiz-tfng', 'lecture-uni-quiz-gap-fill'],
                'lecture-expert': ['lecture-expert-quiz-mcq', 'lecture-expert-quiz-tfng', 'lecture-expert-quiz-gap-fill'],
                'podcast-convo': ['podcast-convo-quiz-mcq', 'podcast-convo-quiz-tfng', 'podcast-convo-quiz-gap-fill'],
                'podcast-futures': ['podcast-futures-quiz-mcq', 'podcast-futures-quiz-tfng', 'podcast-futures-quiz-gap-fill'],
                'debate-planning': ['debate-planning-quiz-gap-fill', 'debate-planning-quiz-mcq', 'debate-planning-quiz-tfng'],
                'dilemma-ethics': ['dilemma-ethics-quiz-gap-fill', 'dilemma-ethics-quiz-mcq', 'dilemma-ethics-quiz-tfng'],
                'thinking-prompts': ['exam-practice'],
                'final-project-hub': ['writing-task', 'self-assessment', 'certificate']
            };
            menuOrder.forEach(startId => {
                let queue = [startId];
                let visited = new Set([startId]);
                while(queue.length > 0) {
                    let current = queue.shift();
                    if (!pageSequence.includes(current)) {
                        pageSequence.push(current);
                    }
                    if (pageOrderMap[current]) {
                        pageOrderMap[current].forEach(next => {
                            if (!visited.has(next)) {
                                queue.push(next);
                                visited.add(next);
                            }
                        });
                    }
                }
            });

            lessonData.vocabulary.forEach((v, i) => {
                createPageElement(`vocab-${i}`, `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h3 class="text-2xl font-bold text-sky-600 mb-2">Vocabulary ${i + 1} / ${lessonData.vocabulary.length}</h3><div class="my-8"><h2 class="text-5xl font-bold text-gray-800 mb-4">${v.word}</h2><p class="text-2xl text-gray-600 mb-4">${v.def}</p><p class="text-xl text-gray-500 italic">"${v.sentence}"</p></div></div></div>`);
            });

            lessonData.pages.forEach(page => {
                let pageHTML = '';
                switch (page.type) {
                    case 'simple':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-gray-800 mb-6">${page.content.title}</h2><p class="text-xl text-gray-600 mb-8">${page.content.text}</p></div></div>`;
                        break;
                    case 'timer':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col justify-center text-left pt-16"><div class="w-full flex justify-between items-center mb-4"><h2 class="text-2xl md:text-3xl font-bold text-green-700">${page.content.title}</h2><div id="${page.content.timerId}" class="text-3xl md:text-4xl font-bold text-gray-700 ml-4"></div></div><div class="readable-content"><p class="text-lg md:text-xl text-gray-600 mt-8">${page.content.text}</p></div></div>`;
                        break;
                    case 'dialogue':
                    case 'lecture':
                    case 'html-content':
                        const titleColor = { 'dialogue': 'text-orange-700', 'lecture': 'text-amber-700', 'html-content': 'text-rose-700' }[page.type] || 'text-gray-800';
                         const contentHTML = page.type === 'html-content' ? page.content.html : (page.content.dialogue || page.content.text || '').split('\n\n').map(line => {
                             if (page.type === 'dialogue') {
                                 const [speaker, ...rest] = line.split(':');
                                 return `<p><strong class="text-green-700">${speaker}:</strong>${rest.join(':')}</p>`
                             }
                             return `<p>${line}</p>`;
                         }).join('');
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center ${titleColor} mb-6">${page.content.title}</h2><div class="readable-content text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg max-h-[70vh] overflow-y-auto">${contentHTML}</div></div>`;
                        break;
                    case 'quiz-tfng':
                    case 'quiz-mcq':
                    case 'quiz-gap-fill':
                        let questionsHTML = '';
                        if (page.type === 'quiz-tfng') {
                            questionsHTML = page.content.questions.map((q, index) => {
                                const buttonsHTML = ['True', 'False', 'Not Given'].map(label => `<button onclick="checkTfngAnswer(this, '${label}', '${q.correctAnswer}')" class="tfng-button bg-${label === 'True' ? 'blue' : label === 'False' ? 'red' : 'gray'}-500 text-white font-bold w-12 h-10 rounded-full">${label.charAt(0)}</button>`).join('');
                                return `<div class="question-group flex items-center gap-4 p-4 rounded-lg bg-gray-100"><div class="button-container flex-shrink-0 flex gap-2">${buttonsHTML}</div><p>${index + 1}. ${q.statement}</p></div>`;
                            }).join('');
                        } else if (page.type === 'quiz-mcq') {
                            questionsHTML = page.content.questions.map((q, index) => {
                                const optionsHTML = q.options.map(opt => `<button onclick="checkMcqAnswer(this, ${opt === q.correctAnswer})" data-correct="${opt === q.correctAnswer}" class="quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200">${opt}</button>`).join('');
                                return `<div class="question-group ${index > 0 ? 'border-t pt-6' : ''}"><p class="font-semibold mb-2">${index + 1}. ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-2">${optionsHTML}</div></div>`;
                            }).join('');
                        } else if (page.type === 'quiz-gap-fill') {
                            const words = page.content.sentences.map(s => s.answer).sort(() => Math.random() - 0.5);
                            const gapFillHTML = page.content.sentences.map((s, i) => `<p class="text-lg mb-4">${i + 1}. ${s.text[0]} <span class="gap" data-answer="${s.answer}"></span> ${s.text[1]}</p>`).join('');
                            const wordBankHTML = words.map(w => `<div class="word-bank-word" draggable="true" data-word="${w}">${w}</div>`).join('');
                            questionsHTML = `<div class="gap-fill-container">${gapFillHTML}</div><div class="word-bank-container mt-8 p-4 bg-gray-100 rounded-lg flex flex-wrap gap-4 justify-center">${wordBankHTML}</div>`;
                        }
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h3 class="text-3xl font-bold text-pink-600 mb-6 text-center">${page.content.title}</h3><div class="space-y-6">${questionsHTML}</div></div>`;
                        break;
                    case 'writing-task':
                        const startersHTML = page.content.starters.map(s => `<li class="text-gray-500">${s}</li>`).join('');
                        const wordBankHTML = page.content.wordBank ? `<div class="mt-6"><h4 class="font-bold text-lg text-indigo-600">Word Bank:</h4><div class="flex flex-wrap gap-2 mt-2 p-4 bg-gray-100 rounded-lg">${page.content.wordBank.map(w => `<span class="bg-white px-2 py-1 rounded-md shadow-sm text-gray-700">${w}</span>`).join('')}</div></div>` : '';
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-center text-indigo-700 mb-6">${page.content.title}</h2><div class="text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg"><h3 class="font-bold text-xl text-indigo-600">Prompt:</h3><p>${page.content.prompt}</p><h3 class="font-bold text-xl text-indigo-600 mt-4">Sentence Starters:</h3><ul class="list-disc list-inside ml-4">${startersHTML}</ul>${wordBankHTML}</div></div><div class="text-center mt-6"><button onclick="goNext()" class="action-button bg-green-600 text-white font-bold py-3 px-8 rounded-full text-xl hover:bg-green-700">Continue to Final Reflection</button></div></div>`;
                        break;
                    case 'certificate':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16 relative overflow-hidden"><canvas id="completion-canvas"></canvas><div class="relative z-10"><div class="readable-content"><h2 class="text-4xl font-bold text-amber-600 mb-4">${page.content.title}</h2><p class="text-xl text-gray-600 mb-6">${page.content.text}</p></div><div id="certificate-to-print" class="bg-green-50 border-4 border-dashed border-green-300 rounded-lg p-8 max-w-2xl mx-auto"><div class="flex justify-center mb-4"><span class="text-6xl"><span aria-hidden="true">üåø</span></span></div><h3 class="text-3xl font-bold text-green-800">${page.content.certificateTitle}</h3><p class="mt-4 text-lg">This certificate is awarded to</p><p id="certificate-name" class="text-2xl font-bold text-green-600 my-2 border-b-2 border-gray-400 pb-2">[Enter Your Name Here]</p><p class="mt-4 text-lg">for successfully completing this lesson.</p><p class="mt-6 text-md"><strong>Final Score:</strong> <span id="certificate-score" class="font-bold"></span> points</p><p class="text-sm mt-1"><strong>Date of Completion:</strong> <span id="certificate-date"></span></p></div><div id="cert-controls" class="mt-6"><div id="cert-initial-controls"><input type="text" id="name-input-cert" placeholder="Enter your name for the certificate" class="text-center p-2 border rounded-lg w-full max-w-md"><button onclick="generateCertificate()" class="action-button mt-4 bg-green-600 text-white font-bold py-2 px-6 rounded-full hover:bg-green-700">Generate Certificate</button></div><div id="cert-generated-controls" class="hidden mt-4 flex flex-wrap justify-center gap-4"><button onclick="downloadCertificateAsImage()" class="action-button bg-blue-600 text-white font-bold py-2 px-4 rounded-full text-sm">Download Image</button></div></div></div></div>`;
                        break;
                }
                if (pageHTML) {
                    createPageElement(page.id, pageHTML);
                    if (page.type === 'quiz-gap-fill') {
                        initGapFill(`page-${page.id}`);
                    }
                }
            });
            
            updateNavButtons();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeLesson();
            
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            let particles = [];
            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                particles.forEach((p, i) => {
                    p.y -= p.speed;
                    p.x += Math.sin(p.y / 50);
                    if (p.y < -p.radius) particles.splice(i, 1);
                    bgCtx.beginPath();
                    bgCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    bgCtx.globalAlpha = p.opacity;
                    bgCtx.fillStyle = p.color;
                    bgCtx.fill();
                });
                if (Math.random() > 0.97 && particles.length < 100) {
                    particles.push({ x: Math.random() * bgCanvas.width, y: bgCanvas.height + 20, radius: Math.random() * 5 + 2, speed: Math.random() * 2 + 1, color: ['#34d399', '#f59e0b', '#a78bfa'][Math.floor(Math.random() * 3)], opacity: Math.random() * 0.5 + 0.5 });
                }
                requestAnimationFrame(animateBackground);
            }
            window.addEventListener('resize', () => { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; });
            animateBackground();
        });
    </script>
</body>
</html>
