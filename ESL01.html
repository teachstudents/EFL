<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESL Game Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; overflow: hidden; }
        .screen { display: none; }
        .screen.active { display: block; }
        /* Timer Bar */
        #timer-bar-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 12px; width: 100%; }
        #timer-bar { background-color: #34d399; height: 100%; transition: width 0.5s linear; }
        /* Memory Match Styles */
        .memory-card { perspective: 1000px; }
        .memory-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s, opacity 0.5s; transform-style: preserve-3d; }
        .memory-card.flipped .memory-card-inner { transform: rotateY(180deg); }
        .memory-card.matched { pointer-events: none; }
        .memory-card.matched .memory-card-inner { transform: scale(1.1) rotateY(180deg); box-shadow: 0 0 20px rgba(22, 163, 74, 0.7); border: 2px solid #16a34a; border-radius: 0.5rem;}
        .memory-card.disappear .memory-card-inner { opacity: 0; transform: scale(0.5) rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; }
        .card-front { background-color: #2dd4bf; color: white; font-size: 2.5rem; }
        .card-back { background-color: #ffffff; transform: rotateY(180deg); flex-direction: column; padding: 0.25rem; }
        /* Drag & Drop / Tap Styles */
        .draggable-word { touch-action: none; cursor: grab; transition: all 0.2s ease; border: 2px solid transparent; }
        .draggable-word.selected { border-color: #3b82f6; background-color: #dbeafe; transform: scale(1.05); }
        .draggable-word:active { cursor: grabbing; transform: scale(1.1); z-index: 100; }
        .drop-zone { position: relative; transition: all 0.2s ease; }
        .drop-zone.drag-over { transform: scale(1.1); border: 2px dashed #3b82f6; }
        .drop-zone.correct { background-color: #10b981 !important; color: white; }
        .drop-zone.incorrect { animation: shake 0.5s; background-color: #ef4444; }
        /* Game Selection Progress */
        .game-select-btn { position: relative; }
        .completion-check { position: absolute; top: 10px; right: 10px; color: white; background-color: #10b981; border-radius: 50%; width: 30px; height: 30px; display: none; align-items: center; justify-content: center; }
        .completion-check.completed { display: flex; }
        /* General Animation & Effects */
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .pop-in { animation: pop 0.3s ease-out forwards; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        @keyframes fly-up { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.5); opacity: 0; } }
        .flying-points { position: absolute; animation: fly-up 1s ease-out forwards; font-weight: bold; color: #16a34a; font-size: 1.5rem; pointer-events: none; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        @keyframes badge-shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .badge-shimmer { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent); background-size: 200% 100%; animation: badge-shimmer 3s infinite; }
    </style>
</head>
<body class="bg-gray-100">

    <canvas id="confetti-canvas"></canvas>

    <div id="app-container" class="w-full max-w-6xl mx-auto p-4">

        <!-- Header with Score, Timer, Badges -->
        <div id="hud" class="hidden sticky top-0 bg-white/80 backdrop-blur-sm z-50 p-4 rounded-b-xl shadow-lg mb-4 flex flex-col gap-3">
            <div class="flex justify-between items-center w-full">
                <button id="back-to-menu" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Topics</button>
                <div class="flex items-center gap-4 md:gap-8 text-lg font-semibold text-gray-700">
                    <div>üèÜ Score: <span id="score-display" class="font-bold text-indigo-600">0</span></div>
                    <div>‚è≥ Time: <span id="timer-display" class="font-bold text-red-600">0</span></div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="tts-toggle" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full"></button>
                    <button id="badges-button" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg">Badges (<span id="badges-count">0</span>)</button>
                </div>
            </div>
            <div id="timer-bar-container"><div id="timer-bar"></div></div>
        </div>

        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active">
            <h1 class="text-4xl font-bold text-center text-indigo-800 mb-2" onclick="speak(this.textContent)">ESL Game Hub</h1>
            <p class="text-center text-gray-600 mb-6" onclick="speak(this.textContent)">Select a topic to start learning!</p>
            <div id="topic-buttons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </div>

        <!-- Game Hub Screen -->
        <div id="game-hub" class="screen">
            <h2 id="topic-title" class="text-3xl font-bold text-center text-indigo-800 mb-6" onclick="speak(this.textContent)"></h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button data-game="memory" class="game-select-btn bg-teal-500 hover:bg-teal-600 text-white p-6 rounded-lg shadow-lg text-center">
                    <div class="completion-check">‚úì</div><div class="text-4xl">üß†</div><h3 class="text-xl font-bold mt-2">Memory Match</h3>
                </button>
                <button data-game="drop" class="game-select-btn bg-sky-500 hover:bg-sky-600 text-white p-6 rounded-lg shadow-lg text-center">
                    <div class="completion-check">‚úì</div><div class="text-4xl">üéØ</div><h3 class="text-xl font-bold mt-2">Emoji Drop</h3>
                </button>
                <button data-game="scramble" class="game-select-btn bg-purple-500 hover:bg-purple-600 text-white p-6 rounded-lg shadow-lg text-center">
                    <div class="completion-check">‚úì</div><div class="text-4xl">‚úçÔ∏è</div><h3 class="text-xl font-bold mt-2">Sentence Scramble</h3>
                </button>
                <button data-game="listen" class="game-select-btn bg-rose-500 hover:bg-rose-600 text-white p-6 rounded-lg shadow-lg text-center">
                    <div class="completion-check">‚úì</div><div class="text-4xl">üéß</div><h3 class="text-xl font-bold mt-2">Listen & Answer</h3>
                </button>
            </div>
             <div id="topic-feedback" class="text-center mt-8"></div>
        </div>

        <!-- Game Screens -->
        <div id="memory-game" class="screen game-screen"></div>
        <div id="drop-game" class="screen game-screen"></div>
        <div id="scramble-game" class="screen game-screen"></div>
        <div id="listen-game" class="screen game-screen"></div>

        <!-- Modals -->
        <div id="completion-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md text-center pop-in">
                <h2 id="completion-title" class="text-4xl font-bold text-green-600 mb-4"></h2>
                <div class="text-lg space-y-2 text-gray-700">
                    <p>Time Bonus: <span id="time-bonus" class="font-bold"></span></p>
                    <p>Points Earned: <span id="points-earned" class="font-bold"></span></p>
                    <hr class="my-4">
                    <p class="text-xl">Total Score: <span id="final-score" class="font-bold text-indigo-600"></span></p>
                </div>
                <button id="next-btn" class="mt-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg">Continue</button>
            </div>
        </div>

        <div id="badges-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl text-center relative">
                <button id="close-modal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                <h2 class="text-3xl font-bold text-amber-600 mb-4">Your Badges</h2>
                <div id="badges-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        // --- AUDIO & SPEECH SYNTHESIS ENGINE ---
        let audioReady = false;
        let toneSynth;
        let isTtsEnabled = true;
        const synthTTS = window.speechSynthesis;
        let naturalVoice = null;

        async function initAudio() {
            if (!audioReady) {
                await Tone.start();
                toneSynth = new Tone.PolySynth(Tone.Synth).toDestination();
                audioReady = true;
                findBestVoice();
            }
        }

        function findBestVoice() {
            const voices = synthTTS.getVoices();
            // User requested Microsoft English Multilingual Online Natural
            naturalVoice = voices.find(v => v.name.includes("Microsoft") && v.name.includes("Natural") && v.lang.startsWith("en")) 
                          || voices.find(v => v.name.includes("Google US English"))
                          || voices.find(v => v.lang.startsWith("en"));
        }

        // Handle async voice loading
        if (synthTTS.onvoiceschanged !== undefined) {
            synthTTS.onvoiceschanged = findBestVoice;
        }
        
        function playSound(type) {
            if (!audioReady) return;
            if (type === 'correct') toneSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n", Tone.now());
            else if (type === 'flip') toneSynth.triggerAttackRelease("A4", "16n", Tone.now());
            else if (type === 'win') toneSynth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n", Tone.now());
        }

        function speak(text, isFeedback = false) {
            if (!isTtsEnabled || !text) return;
            if (synthTTS.speaking) synthTTS.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            if (naturalVoice) utterance.voice = naturalVoice;
            utterance.rate = 0.85; // Slow down speech to 85%
            utterance.pitch = isFeedback ? 1.2 : 1;
            synthTTS.speak(utterance);
        }

        function toggleTTS() {
            isTtsEnabled = !isTtsEnabled;
            const button = document.getElementById('tts-toggle');
            if (!isTtsEnabled) {
                synthTTS.cancel();
                button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14l-4-4m0 4l4-4" /></svg>`;
            } else {
                button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z" /></svg>`;
            }
        }
        
        document.body.addEventListener('click', initAudio, { once: true });
        
        // --- DATA STRUCTURE ---
        const praiseWords = ["Awesome!", "Great job!", "Excellent!", "Well done!", "Perfect!", "Amazing!"];
        const topics = {
            "My Family": { emoji: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶", words: { "grandpa": "üë¥", "grandma": "üëµ", "mum": "üë©", "dad": "üë®", "aunt": "üë©‚Äçü¶±", "uncle": "üë®‚Äçü¶±" }, sentences: ["My grandpa is kind.", "I love my mum.", "My dad is tall.", "My grandma tells stories.", "My aunt is funny.", "My uncle plays games.", "We are a happy family.", "My dad helps me.", "My mum cooks dinner.", "I have a big family."], questions: [{ q: "Who is your father's father?", o: ["grandpa", "uncle", "dad"], a: "grandpa" }, { q: "Who is your mother's sister?", o: ["aunt", "grandma", "mum"], a: "aunt" }] },
            "Countries": { emoji: "üåç", words: { "UK": "üá¨üáß", "Russia": "üá∑üá∫", "Spain": "üá™üá∏", "Poland": "üáµüá±", "Australia": "üá¶üá∫", "USA": "üá∫üá∏" }, sentences: ["I am from Spain.", "Australia is a big country.", "The flag of the UK is red white and blue.", "Russia is very cold.", "Poland has beautiful cities.", "The USA is also called America.", "I want to visit Spain.", "Kangaroos are from Australia.", "The flag of Russia is white blue and red.", "I live in the USA."], questions: [{ q: "Which country has a kangaroo?", o: ["Australia", "Spain", "Russia"], a: "Australia" }, { q: "Which country's flag is red, white, and blue?", o: ["USA", "Poland", "Spain"], a: "USA" }] },
            "Seasons": { emoji: "üå∏‚òÄÔ∏èüçÇ‚ùÑÔ∏è", words: { "spring": "üå∏", "summer": "‚òÄÔ∏è", "autumn": "üçÇ", "winter": "‚ùÑÔ∏è" }, sentences: ["I like summer.", "It is cold in winter.", "Leaves fall in autumn.", "Flowers grow in spring.", "The sun is hot in summer.", "We build snowmen in winter.", "Spring is after winter.", "Autumn is also called fall.", "What is your favorite season?", "There are four seasons."], questions: [{ q: "In which season do you build a snowman?", o: ["winter", "summer", "spring"], a: "winter" }, { q: "In which season do flowers grow?", o: ["spring", "autumn", "winter"], a: "spring" }] },
            "Hobbies": { emoji: "üé®", words: { "garden": "ü™¥", "skateboard": "üõπ", "chess": "‚ôüÔ∏è", "fish": "üé£", "basketball": "üèÄ", "photos": "üì∏", "volleyball": "üèê", "guitar": "üé∏" }, sentences: ["He likes to play chess.", "She can play the guitar.", "My hobby is basketball.", "I like to take photos of animals.", "We play volleyball at the beach.", "Skateboarding is fun.", "I help in the garden.", "Do you like to fish?", "I read a book about fish.", "He plays the guitar well."], questions: [{ q: "What do you use to take photos?", o: ["camera", "guitar", "skateboard"], a: "camera" }, { q: "Which hobby uses a black and white board?", o: ["chess", "basketball", "fishing"], a: "chess" }] },
            "Zoo Animals": { emoji: "ü¶ì", words: { "zebra": "ü¶ì", "monkey": "üêí", "kangaroo": "ü¶ò", "camel": "üê™", "lizard": "ü¶é", "flamingo": "ü¶©", "crocodile": "üêä" }, sentences: ["A monkey eats bananas.", "The zebra is black and white.", "I saw a kangaroo at the zoo.", "A crocodile lives in water.", "The flamingo is pink.", "A camel lives in the desert.", "A lizard can be small.", "The zoo has many animals.", "I like the monkey.", "The crocodile is scary."], questions: [{ q: "Which animal is black and white?", o: ["zebra", "flamingo", "monkey"], a: "zebra" }, { q: "Which animal is pink?", o: ["flamingo", "crocodile", "lizard"], a: "flamingo" }] },
            "Food": { emoji: "üçî", words: { "pasta": "üçù", "bread": "üçû", "cereal": "ü•£", "meat": "ü•©", "melon": "üçà", "cucumber": "ü•í", "onion": "üßÖ", "lemon": "üçã", "potato": "ü•î", "cheese": "üßÄ" }, sentences: ["I eat bread for breakfast.", "Pasta is from Italy.", "A lemon is sour.", "I like cheese on my pasta.", "A potato can be a chip.", "An onion makes me cry.", "A cucumber is green.", "I eat cereal with milk.", "Melon is a sweet fruit.", "We eat meat for dinner."], questions: [{ q: "Which food is yellow and sour?", o: ["lemon", "potato", "onion"], a: "lemon" }, { q: "Which food comes from Italy?", o: ["pasta", "bread", "cereal"], a: "pasta" }] },
            "Transport": { emoji: "üöå", words: { "bus": "üöå", "helicopter": "üöÅ", "motorbike": "üèçÔ∏è", "plane": "‚úàÔ∏è", "taxi": "üöï", "train": "üöÜ", "tram": "üöä" }, sentences: ["I go to school by bus.", "A plane can fly.", "The train is fast.", "A taxi can take you home.", "A helicopter is in the sky.", "A tram runs on tracks.", "My dad has a motorbike.", "The bus is yellow.", "The train goes choo-choo.", "I want to fly in a plane."], questions: [{ q: "Which transport flies in the sky?", o: ["plane", "bus", "train"], a: "plane" }, { q: "Which transport runs on tracks?", o: ["train", "taxi", "motorbike"], a: "train" }] },
            "Feelings": { emoji: "üòä", words: { "angry": "üò†", "scared": "üò®", "funny": "üòÇ", "kind": "ü§ó", "cheerful": "üòÑ", "relaxed": "üòå", "worried": "üòü" }, sentences: ["She is feeling cheerful.", "The movie was funny.", "Don't be scared.", "He is a kind boy.", "I am relaxed on holiday.", "The monster is scary.", "My dad was angry.", "I am worried about the test.", "The clown is funny.", "It is good to be kind."], questions: [{ q: "How do you feel when you see a monster?", o: ["scared", "funny", "relaxed"], a: "scared" }, { q: "How do you feel after a good joke?", o: ["funny", "angry", "worried"], a: "funny" }] },
            "Places in Town": { emoji: "üè¢", words: { "caf√©": "‚òï", "library": "üìö", "museum": "üèõÔ∏è", "playground": "üõù", "shop": "üõçÔ∏è", "cinema": "üé¨", "theatre": "üé≠" }, sentences: ["Let's go to the cinema.", "I read books at the library.", "The playground is fun.", "We can buy clothes at the shop.", "The museum has old things.", "I like to see a play at the theatre.", "We can drink coffee at the caf√©.", "The library is quiet.", "The cinema sells popcorn.", "The shop is open now."], questions: [{ q: "Where do you go to read books?", o: ["library", "cinema", "shop"], a: "library" }, { q: "Where do you go to watch a movie?", o: ["cinema", "museum", "library"], a: "cinema" }] },
            "School Things": { emoji: "üéí", words: { "paint": "üé®", "calculator": "üßÆ", "dictionary": "üìñ", "backpack": "üéí", "apron": "üéΩ", "lunch box": "üç±" }, sentences: ["My backpack is heavy.", "I use a calculator for math.", "What is in your lunch box?", "We use paint in art class.", "I wear an apron to stay clean.", "A dictionary tells you words.", "My books are in my backpack.", "I have a new lunch box.", "The paint is red.", "I need a calculator."], questions: [{ q: "What do you use for math problems?", o: ["calculator", "dictionary", "paint"], a: "calculator" }, { q: "What do you carry your books in?", o: ["backpack", "lunch box", "paintbrush"], a: "backpack" }] },
            "Water Sports": { emoji: "üèä", words: { "swim": "üèä", "dive": "ü§ø", "surf": "üèÑ", "kayak": "üõ∂" }, sentences: ["I can swim in the pool.", "He likes to surf.", "Let's go for a dive.", "A kayak is a small boat.", "The water is cold for a swim.", "She is good at surfing.", "We can see fish when we dive.", "I want to learn to kayak.", "Surfing is on big waves.", "Swimming is good exercise."], questions: [{ q: "What do you do on big waves?", o: ["surf", "swim", "kayak"], a: "surf" }, { q: "What is a small boat for one person?", o: ["kayak", "surfboard", "snorkel"], a: "kayak" }] },
            "Adjectives (people)": { emoji: "üíÅ", words: { "old": "üë¥", "young": "üë∂", "handsome": "ü§µ", "pretty": "üë∞", "short": "üìè", "tall": "ü¶í", "shy": "üòä", "friendly": "ü§ó" }, sentences: ["My teacher is friendly.", "The baby is young.", "He is a tall boy.", "The girl is pretty.", "My grandpa is old.", "The man is handsome.", "I am not short.", "My sister is shy.", "A friendly dog is nice.", "The young cat is playful."], questions: [{ q: "What is the opposite of old?", o: ["young", "tall", "short"], a: "young" }, { q: "What is a word for a nice person?", o: ["friendly", "shy", "handsome"], a: "friendly" }] },
            "Daily Routine": { emoji: "‚è∞", words: { "shower": "üöø", "brush teeth": "ü¶∑", "get dressed": "üëï", "breakfast": "ü•û", "get up": "‚è∞", "catch the bus": "üöå", "walk to school": "üö∂" }, sentences: ["I get up at seven.", "I brush my teeth every day.", "She takes a shower in the morning.", "I eat breakfast with my family.", "I get dressed for school.", "I walk to school with my friends.", "We catch the bus at the corner.", "It is time to get up.", "I brush my teeth after I eat.", "I take a shower at night."], questions: [{ q: "What do you do in the morning?", o: ["get up", "go to sleep", "play games"], a: "get up" }, { q: "What do you do to keep your teeth clean?", o: ["brush teeth", "eat candy", "drink soda"], a: "brush teeth" }] },
            "In the Park": { emoji: "üå≥", words: { "grass": "üåø", "flowers": "üå∏", "bin": "üóëÔ∏è", "trees": "üå≥", "playground": "üõù", "fountain": "‚õ≤" }, sentences: ["The grass is green.", "There are many trees in the park.", "Throw the litter in the bin.", "The flowers are beautiful.", "The fountain has water.", "We play on the playground.", "I like to sit on the grass.", "The trees give shade.", "The bin is for trash.", "The playground has a slide."], questions: [{ q: "What should you put in the bin?", o: ["litter", "flowers", "trees"], a: "litter" }, { q: "What is green and grows on the ground?", o: ["grass", "fountain", "playground"], a: "grass" }] },
            "Verbs": { emoji: "üèÉ", words: { "shout": "üó£Ô∏è", "chase": "üèÉ‚Äç‚ôÇÔ∏è", "catch": "ü•é", "meet": "üëã", "laugh": "üòÇ", "start": "‚ñ∂Ô∏è", "finish": "üèÅ", "love": "‚ù§Ô∏è" }, sentences: ["I love my family.", "Don't shout in the library.", "The game will start soon.", "The dog will chase the ball.", "Can you catch the ball?", "It is nice to meet you.", "The joke makes me laugh.", "We finish school at three.", "I love to play games.", "Let's start the race."], questions: [{ q: "What do you do when a joke is funny?", o: ["laugh", "shout", "chase"], a: "laugh" }, { q: "What is the opposite of finish?", o: ["start", "catch", "meet"], a: "start" }] },
            "Camping": { emoji: "‚õ∫", words: { "tent": "‚õ∫", "sleeping bag": "üõå", "frying pan": "üç≥", "matches": "üî•", "rope": "‚û∞" }, sentences: ["We sleep in a tent.", "It is dark so we need matches.", "The sleeping bag is warm.", "We cook on a frying pan.", "Use a rope to tie the tent.", "Camping is fun in summer.", "The tent keeps us dry.", "My sleeping bag is blue.", "The matches make a fire.", "The rope is long."], questions: [{ q: "What do you sleep in when you go camping?", o: ["tent", "frying pan", "rope"], a: "tent" }, { q: "What do you use to start a fire?", o: ["matches", "sleeping bag", "tent"], a: "matches" }] },
            "Holiday": { emoji: "‚úàÔ∏è", words: { "torch": "üî¶", "suitcase": "üß≥", "sun cream": "üß¥", "towel": "üßñ", "soap": "üßº", "shampoo": "üß¥", "toothbrush": "ü™•" }, sentences: ["Pack your suitcase.", "I need a towel for the beach.", "Don't forget your toothbrush.", "Use a torch when it is dark.", "Use sun cream in the sun.", "I wash my hands with soap.", "I wash my hair with shampoo.", "My suitcase is big.", "The towel is soft.", "My toothbrush is green."], questions: [{ q: "What do you pack your clothes in for a holiday?", o: ["suitcase", "towel", "soap"], a: "suitcase" }, { q: "What do you use to see in the dark?", o: ["torch", "sun cream", "shampoo"], a: "torch" }] },
            // --- 3 NEW TOPICS ---
            "Animal Actions": { emoji: "üêí", words: { "run": "üèÉ", "jump": "ü¶ò", "climb": "üêí", "fly": "üïäÔ∏è", "swim": "üêü", "crawl": "üê¢" }, sentences: ["A monkey can climb trees.", "A fish can swim in water.", "A bird can fly in the sky.", "A turtle can crawl slowly.", "A kangaroo can jump high.", "A lion can run fast.", "I like to jump.", "Can you climb like a monkey?", "Birds fly south in winter.", "Fish swim with their fins."], questions: [{q: "What does a monkey do?", o: ["climb", "fly", "crawl"], a: "climb"}, {q: "What does a bird do?", o: ["fly", "swim", "climb"], a: "fly"}] },
            "Weather": { emoji: "‚òÅÔ∏è", words: { "sunny": "‚òÄÔ∏è", "rainy": "üåßÔ∏è", "snowy": "‚ùÑÔ∏è", "cloudy": "‚òÅÔ∏è", "windy": "üå¨Ô∏è", "stormy": "‚ö°" }, sentences: ["It is sunny today.", "Take an umbrella when it is rainy.", "We wear coats when it is snowy.", "The sky is gray and cloudy.", "Hang on to your hat when it is windy!", "There is thunder when it is stormy.", "I love a sunny day.", "It is snowy in winter.", "Rainy days are for books.", "Can you hear the windy sound?"], questions: [{q: "What do you need when it is rainy?", o: ["umbrella", "sunglasses", "swimsuit"], a: "umbrella"}, {q: "What color is the sky when it is cloudy?", o: ["gray", "blue", "yellow"], a: "gray"}] },
            "Kitchen Things": { emoji: "üç¥", words: { "spoon": "ü•Ñ", "fork": "üç¥", "knife": "üî™", "plate": "üçΩÔ∏è", "cup": "‚òï", "bowl": "ü•£" }, sentences: ["I eat soup with a spoon.", "Use a fork to eat pasta.", "The knife is sharp, be careful.", "Put the cake on a plate.", "I drink milk from a cup.", "Put the cereal in a bowl.", "Wash the plates after dinner.", "I have a blue cup.", "The spoon is small.", "Use a fork and knife."], questions: [{q: "What do you use to eat soup?", o: ["spoon", "fork", "knife"], a: "spoon"}, {q: "What do you put cereal in?", o: ["bowl", "plate", "cup"], a: "bowl"}] }
        };

        // --- GAME STATE ---
        let score = 0;
        let timer;
        let timeLeft = 0;
        let initialTime = 0;
        let currentTopic = null;
        let currentGame = null;
        let badges = new Set();
        let topicScores = {};
        let topicProgress = {};

        // --- DOM ELEMENTS ---
        const screens = document.querySelectorAll('.screen');
        const hud = document.getElementById('hud');
        const scoreDisplay = document.getElementById('score-display');
        const timerDisplay = document.getElementById('timer-display');
        const timerBar = document.getElementById('timer-bar');
        const topicButtonsContainer = document.getElementById('topic-buttons');
        const topicTitle = document.getElementById('topic-title');
        
        // --- INITIALIZATION ---
        function init() {
            loadState();
            generateTopicButtons();
            document.getElementById('back-to-menu').addEventListener('click', showMainMenu);
            document.querySelectorAll('.game-select-btn').forEach(btn => btn.addEventListener('click', startGame));
            document.getElementById('badges-button').addEventListener('click', showBadges);
            document.getElementById('close-modal').addEventListener('click', () => document.getElementById('badges-modal').style.display = 'none');
            document.getElementById('tts-toggle').addEventListener('click', toggleTTS);
            toggleTTS(); toggleTTS(); // Initialize button state
            document.getElementById('next-btn').addEventListener('click', handleCompletionContinue);
            updateBadgesDisplay();
        }

        function generateTopicButtons() {
            topicButtonsContainer.innerHTML = '';
            for (const topicName in topics) {
                const topic = topics[topicName];
                const button = document.createElement('button');
                button.className = 'topic-btn bg-white p-4 rounded-lg shadow-md text-center hover:shadow-xl hover:scale-105 transition-all duration-300';
                button.dataset.topic = topicName;
                button.innerHTML = `
                    <div class="text-4xl">${topic.emoji}</div>
                    <div class="font-semibold mt-2 text-gray-700">${topicName}</div>
                `;
                button.addEventListener('click', () => {
                    speak(topicName);
                    selectTopic(topicName);
                });
                topicButtonsContainer.appendChild(button);
            }
        }

        // --- SCREEN MANAGEMENT ---
        function showScreen(screenId) {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            hud.style.display = (screenId !== 'main-menu') ? 'flex' : 'none';
        }

        function showMainMenu() {
            stopTimer();
            showScreen('main-menu');
        }

        function selectTopic(topicName) {
            currentTopic = topicName;
            topicTitle.textContent = topicName;
            updateTopicFeedback();
            updateGameCompletionChecks();
            showScreen('game-hub');
        }

        function updateGameCompletionChecks() {
            const progress = topicProgress[currentTopic] || new Set();
            document.querySelectorAll('.game-select-btn').forEach(btn => {
                const game = btn.dataset.game;
                const check = btn.querySelector('.completion-check');
                if (progress.has(game)) {
                    check.classList.add('completed');
                } else {
                    check.classList.remove('completed');
                }
            });
        }
        
        // --- GAME LOGIC ---
        function startGame(e) {
            currentGame = e.currentTarget.dataset.game;
            const gameScreen = document.getElementById(`${currentGame}-game`);
            showScreen(`${currentGame}-game`);

            switch (currentGame) {
                case 'memory': setupMemoryGame(gameScreen); startTimer(60); break;
                case 'drop': setupDropGame(gameScreen); startTimer(45); break;
                case 'scramble': setupScrambleGame(gameScreen); startTimer(120); break;
                case 'listen': setupListenGame(gameScreen); startTimer(90); break;
            }
        }
        
        function updateScore(points) {
            score += points;
            scoreDisplay.textContent = score;
        }

        function startTimer(duration) {
            initialTime = duration;
            timeLeft = duration;
            timerDisplay.textContent = timeLeft;
            timerBar.style.width = '100%';
            timer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                timerBar.style.width = `${(timeLeft / initialTime) * 100}%`;
                if (timeLeft <= 0) {
                    stopTimer();
                    endGame(false, 'Time is up!');
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timer);
        }

        function endGame(isWin, message) {
            stopTimer();
            let pointsEarned = isWin ? Math.ceil(timeLeft * 0.1) + 1 : 0;
            updateScore(pointsEarned);
            
            if (isWin) {
                if (!topicProgress[currentTopic]) {
                    topicProgress[currentTopic] = new Set();
                }
                topicProgress[currentTopic].add(currentGame);
                
                const isLevelComplete = topicProgress[currentTopic].size === 4;

                playSound('win');
                speak('You win!');
                showCompletionModal(isLevelComplete, pointsEarned);
                
                const currentTopicScore = (topicScores[currentTopic] || 0) + pointsEarned;
                topicScores[currentTopic] = currentTopicScore;
                if(isLevelComplete && !badges.has(currentTopic)) {
                    badges.add(currentTopic);
                    const badgeMessage = `New Badge Unlocked: ${currentTopic} Master!`;
                    setTimeout(() => { alert(badgeMessage); speak(badgeMessage); }, 1000);
                    updateBadgesDisplay();
                }
            } else {
                speak(message, true);
                setTimeout(() => showScreen('game-hub'), 2000);
            }
            saveState();
            updateTopicFeedback();
        }
        
        // --- MEMORY GAME ---
        function setupMemoryGame(container) {
            const words = topics[currentTopic].words;
            const entries = Object.entries(words).slice(0, 8);
            // Ensure all have pairs
            const items = [...entries, ...entries];
            items.sort(() => Math.random() - 0.5);

            container.innerHTML = `<div class="grid grid-cols-4 gap-2 md:gap-4 max-w-2xl mx-auto"></div>`;
            const grid = container.querySelector('.grid');

            items.forEach(([word, emoji], index) => {
                const card = document.createElement('div');
                card.className = 'memory-card aspect-square';
                card.dataset.word = word;
                card.dataset.index = index;
                card.innerHTML = `
                    <div class="memory-card-inner">
                        <div class="card-face card-front shadow-lg">?</div>
                        <div class="card-face card-back shadow-lg">
                            <div class="text-3xl md:text-5xl">${emoji}</div>
                            <div class="text-xs md:text-sm font-semibold text-center mt-1">${word}</div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            let flippedCards = [];
            let matchedPairs = 0;
            grid.addEventListener('click', e => {
                const card = e.target.closest('.memory-card');
                if (!card || card.classList.contains('flipped') || flippedCards.length >= 2) return;
                
                playSound('flip');
                speak(card.dataset.word);
                card.classList.add('flipped');
                flippedCards.push(card);

                if (flippedCards.length === 2) {
                    if (flippedCards[0].dataset.word === flippedCards[1].dataset.word) {
                        playSound('correct');
                        updateScore(1);
                        showFlyingPoints(flippedCards[0], 1);
                        flippedCards.forEach(c => {
                            c.classList.add('matched');
                            setTimeout(() => c.classList.add('disappear'), 500);
                        });
                        flippedCards = [];
                        matchedPairs++;
                        if (matchedPairs === entries.length) endGame(true, 'You found all matches!');
                    } else {
                        setTimeout(() => {
                            flippedCards.forEach(c => c.classList.remove('flipped'));
                            flippedCards = [];
                        }, 1200);
                    }
                }
            });
        }

        // --- EMOJI DROP GAME (DRAG/DROP + TOUCH TAP) ---
        function showFlyingPoints(targetElement, points) {
            const pointsEl = document.createElement('div');
            pointsEl.className = 'flying-points';
            pointsEl.textContent = `+${points}`;
            targetElement.appendChild(pointsEl);
            setTimeout(() => pointsEl.remove(), 1000);
        }

        function setupDropGame(container) {
             const words = topics[currentTopic].words;
             const wordEntries = Object.entries(words);
             let matchedCount = 0;
             let selectedWord = null;

             container.innerHTML = `
                <p class="text-center text-lg text-gray-600 mb-4" onclick="speak(this.textContent)">Drag or tap the word, then tap the emoji!</p>
                <div id="drop-zone-container" class="grid grid-cols-3 md:grid-cols-4 gap-4 max-w-2xl mx-auto mb-8"></div>
                <div id="drop-word-bank" class="flex flex-wrap gap-3 p-4 bg-gray-200 rounded-lg justify-center"></div>
             `;
             const dropZoneContainer = container.querySelector('#drop-zone-container');
             const wordBank = container.querySelector('#drop-word-bank');

             wordEntries.forEach(([word, emoji]) => {
                // DROP ZONES
                const zone = document.createElement('div');
                zone.className = 'drop-zone bg-sky-200 text-6xl p-6 rounded-lg shadow-md flex items-center justify-center cursor-pointer';
                zone.textContent = emoji;
                zone.dataset.word = word;
                
                const processMatch = (droppedWord) => {
                    if (droppedWord === zone.dataset.word) {
                        playSound('correct');
                        speak("Correct!", true);
                        updateScore(1);
                        showFlyingPoints(zone, 1);
                        zone.classList.add('correct');
                        zone.innerHTML = `<div class="text-lg font-bold">${droppedWord}</div>`;
                        const wordEl = document.getElementById(`word-${droppedWord.replace(/\s/g, '-')}`);
                        if(wordEl) wordEl.style.display = 'none';
                        matchedCount++;
                        if (matchedCount === wordEntries.length) endGame(true, 'Great job!');
                        return true;
                    } else {
                        speak("Incorrect.", true);
                        zone.classList.add('incorrect');
                        setTimeout(() => zone.classList.remove('incorrect'), 500);
                        return false;
                    }
                };

                zone.addEventListener('dragover', e => { e.preventDefault(); e.target.classList.add('drag-over'); });
                zone.addEventListener('dragleave', e => e.target.classList.remove('drag-over'));
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    e.target.classList.remove('drag-over');
                    const droppedWord = e.dataTransfer.getData('text/plain');
                    processMatch(droppedWord);
                });

                zone.addEventListener('click', () => {
                    if (selectedWord) {
                        processMatch(selectedWord.dataset.word);
                        selectedWord.classList.remove('selected');
                        selectedWord = null;
                    }
                });

                dropZoneContainer.appendChild(zone);

                // WORDS
                const wordEl = document.createElement('div');
                wordEl.id = `word-${word.replace(/\s/g, '-')}`;
                wordEl.className = 'draggable-word bg-white text-lg font-bold py-2 px-4 rounded-lg shadow-md cursor-pointer';
                wordEl.textContent = word;
                wordEl.dataset.word = word;
                wordEl.draggable = true;

                wordEl.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', word);
                    selectedWord = null; 
                });

                wordEl.addEventListener('click', () => {
                    if (selectedWord) selectedWord.classList.remove('selected');
                    selectedWord = wordEl;
                    selectedWord.classList.add('selected');
                    speak(word);
                });

                wordBank.appendChild(wordEl);
             });
        }

        // --- SENTENCE SCRAMBLE GAME (WITH HINT FEATURE) ---
        function setupScrambleGame(container) {
            const sentences = topics[currentTopic].sentences;
            let currentSentenceIndex = 0;

            container.innerHTML = `
                <div class="flex justify-center gap-4 items-center mb-4">
                    <div id="scramble-feedback" class="text-xl font-bold h-8"></div>
                    <button id="hear-sentence-hint" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full shadow-lg flex items-center gap-2 px-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z" /></svg>
                        Hear Sentence
                    </button>
                </div>
                <div id="scramble-drop-zone" class="sentence-drop-zone flex flex-wrap gap-2 p-4 bg-purple-200 rounded-lg justify-center mb-6 border-2 border-dashed border-purple-400"></div>
                <div id="scramble-word-bank" class="flex flex-wrap gap-2 p-4 bg-gray-200 rounded-lg justify-center"></div>
            `;
            const dropZone = container.querySelector('#scramble-drop-zone');
            const wordBank = container.querySelector('#scramble-word-bank');
            const feedbackEl = container.querySelector('#scramble-feedback');
            const hintBtn = container.querySelector('#hear-sentence-hint');

            let selectedScrambleWord = null;

            function nextSentence() {
                if (currentSentenceIndex >= sentences.length) {
                    endGame(true, 'You completed all sentences!');
                    return;
                }
                const sentence = sentences[currentSentenceIndex];
                feedbackEl.textContent = `Sentence ${currentSentenceIndex + 1} of ${sentences.length}`;
                
                hintBtn.onclick = () => speak(sentence);

                const words = [...sentence.replace('.', '').split(' '), '.'];
                const shuffledWords = [...words].sort(() => Math.random() - 0.5);

                wordBank.innerHTML = '';
                dropZone.innerHTML = '';
                shuffledWords.forEach((word, index) => {
                    const wordEl = document.createElement('div');
                    wordEl.id = `scramble-word-${index}`;
                    wordEl.className = 'sentence-word bg-white p-2 px-4 rounded shadow font-semibold cursor-pointer';
                    wordEl.textContent = word;
                    wordEl.dataset.word = word;
                    wordEl.draggable = true;

                    const togglePlacement = () => {
                        if (wordEl.parentElement === wordBank) {
                            dropZone.appendChild(wordEl);
                        } else {
                            wordBank.appendChild(wordEl);
                        }
                        checkSentence();
                    };

                    wordEl.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', e.target.id));
                    wordEl.addEventListener('click', togglePlacement);

                    wordBank.appendChild(wordEl);
                });
            }
            
            function checkSentence() {
                const correctSentence = sentences[currentSentenceIndex];
                const wordsInSentence = correctSentence.split(' ');
                const wordsInDropZone = Array.from(dropZone.children);
                if (wordsInDropZone.length !== wordsInSentence.length + 1) return;

                const userAnswer = wordsInDropZone.map(child => child.textContent).join(' ').replace(' .', '.');
                if (userAnswer === correctSentence) {
                    playSound('correct');
                    const praise = praiseWords[Math.floor(Math.random() * praiseWords.length)];
                    feedbackEl.textContent = praise;
                    speak(correctSentence, true); // Automatically speak answer
                    updateScore(2);
                    currentSentenceIndex++;
                    setTimeout(nextSentence, 2000);
                } else {
                    speak('Not quite right, try again!', true);
                    feedbackEl.textContent = "Try again!";
                }
            }

            const dropHandler = e => {
                e.preventDefault();
                const wordId = e.dataTransfer.getData('text/plain');
                const wordEl = document.getElementById(wordId);
                if (wordEl && e.currentTarget.contains(wordEl) === false) {
                    e.currentTarget.appendChild(wordEl);
                    if (e.currentTarget.id === 'scramble-drop-zone') {
                        checkSentence();
                    }
                }
            };
            
            dropZone.addEventListener('dragover', e => e.preventDefault());
            dropZone.addEventListener('drop', dropHandler);
            wordBank.addEventListener('dragover', e => e.preventDefault());
            wordBank.addEventListener('drop', dropHandler);

            nextSentence();
        }

        // --- LISTEN & ANSWER GAME ---
        function setupListenGame(container) {
            const questions = topics[currentTopic].questions;
            if (!questions || questions.length === 0) {
                container.innerHTML = `<p class="text-center text-red-500">No listening questions available for this topic.</p>`;
                setTimeout(showMainMenu, 2000);
                return;
            }
            let currentQuestionIndex = 0;

            container.innerHTML = `
                <div id="listen-feedback" class="text-center text-xl font-bold h-8 mb-4"></div>
                <div class="text-center mb-8">
                    <button id="play-question-btn" class="bg-rose-500 hover:bg-rose-600 text-white p-6 rounded-full shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" /></svg>
                    </button>
                </div>
                <div id="answer-options" class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-3xl mx-auto"></div>
            `;
            
            const feedbackEl = container.querySelector('#listen-feedback');
            const playBtn = container.querySelector('#play-question-btn');
            const optionsContainer = container.querySelector('#answer-options');

            function nextQuestion() {
                if (currentQuestionIndex >= questions.length) {
                    endGame(true, 'You answered all questions!');
                    return;
                }
                feedbackEl.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
                const qData = questions[currentQuestionIndex];
                
                speak(qData.q);
                playBtn.onclick = () => speak(qData.q);
                
                optionsContainer.innerHTML = '';
                const options = [...qData.o].sort(() => Math.random() - 0.5);
                options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'answer-btn bg-white text-lg font-semibold p-4 rounded-lg shadow-md hover:bg-gray-100 transition-colors';
                    btn.textContent = option;
                    btn.onclick = () => {
                        if (option === qData.a) {
                            playSound('correct');
                            speak('Correct!', true);
                            updateScore(2);
                            btn.classList.add('bg-green-500', 'text-white');
                            currentQuestionIndex++;
                            setTimeout(nextQuestion, 1000);
                        } else {
                            speak('Try again.', true);
                            btn.classList.add('bg-red-500', 'text-white');
                            setTimeout(() => btn.classList.remove('bg-red-500', 'text-white'), 500);
                        }
                    };
                    optionsContainer.appendChild(btn);
                });
            }
            
            nextQuestion();
        }

        // --- LEVEL COMPLETE & BADGES ---
        function showCompletionModal(isLevelComplete, points) {
            const modal = document.getElementById('completion-modal');
            document.getElementById('completion-title').textContent = isLevelComplete ? "Level Complete!" : "Game Complete!";
            document.getElementById('time-bonus').textContent = Math.ceil(timeLeft * 0.1);
            document.getElementById('points-earned').textContent = points;
            document.getElementById('final-score').textContent = score;
            modal.dataset.isLevelComplete = isLevelComplete;
            modal.style.display = 'flex';
            if (isLevelComplete) {
                startConfetti();
            }
        }
        
        function handleCompletionContinue() {
            const modal = document.getElementById('completion-modal');
            const isLevelComplete = modal.dataset.isLevelComplete === 'true';
            modal.style.display = 'none';
            stopConfetti();
            if (isLevelComplete) {
                showMainMenu();
            } else {
                showScreen('game-hub');
            }
        }

        function showBadges() {
            const modal = document.getElementById('badges-modal');
            const grid = document.getElementById('badges-grid');
            grid.innerHTML = '';
            for (const topicName in topics) {
                const topic = topics[topicName];
                const hasBadge = badges.has(topicName);
                const badgeEl = document.createElement('div');
                badgeEl.className = `p-2 text-center rounded-lg relative overflow-hidden ${hasBadge ? 'bg-amber-400' : 'bg-gray-200'}`;
                badgeEl.innerHTML = `
                    <div class="text-4xl ${hasBadge ? '' : 'opacity-30'}">${topic.emoji}</div>
                    <div class="text-xs font-semibold mt-1">${topicName}</div>
                    ${hasBadge ? '<div class="absolute inset-0 badge-shimmer"></div>' : ''}
                `;
                grid.appendChild(badgeEl);
            }
            modal.style.display = 'flex';
        }
        
        function updateBadgesDisplay() {
            document.getElementById('badges-count').textContent = badges.size;
        }

        function updateTopicFeedback() {
             const feedbackEl = document.getElementById('topic-feedback');
             const tScore = topicScores[currentTopic] || 0;
             const hasBadge = badges.has(currentTopic);
             feedbackEl.innerHTML = `
                <p class="font-semibold">Topic Score: ${tScore}</p>
                ${hasBadge ? '<p class="text-amber-600 font-bold">üèÖ Badge Earned!</p>' : ''}
             `;
        }

        // --- STATE MANAGEMENT ---
        function saveState() {
            localStorage.setItem('eslGameScore', score);
            localStorage.setItem('eslGameBadges', JSON.stringify(Array.from(badges)));
            localStorage.setItem('eslGameTopicScores', JSON.stringify(topicScores));
            const progressToSave = {};
            for (const key in topicProgress) {
                progressToSave[key] = Array.from(topicProgress[key]);
            }
            localStorage.setItem('eslGameTopicProgress', JSON.stringify(progressToSave));
        }

        function loadState() {
            score = parseInt(localStorage.getItem('eslGameScore')) || 0;
            const savedBadges = JSON.parse(localStorage.getItem('eslGameBadges')) || [];
            badges = new Set(savedBadges);
            topicScores = JSON.parse(localStorage.getItem('eslGameTopicScores')) || {};
            const savedProgress = JSON.parse(localStorage.getItem('eslGameTopicProgress')) || {};
            for (const key in savedProgress) {
                topicProgress[key] = new Set(savedProgress[key]);
            }
            scoreDisplay.textContent = score;
        }
        
        // --- CONFETTI EFFECT ---
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');
        let confettiParticles = [];
        let confettiAnimationId;

        function startConfetti() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
            confettiParticles = [];
            for (let i = 0; i < 100; i++) {
                confettiParticles.push({
                    x: Math.random() * confettiCanvas.width,
                    y: Math.random() * confettiCanvas.height - confettiCanvas.height,
                    size: Math.random() * 5 + 2,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    speed: Math.random() * 3 + 1,
                    angle: Math.random() * Math.PI * 2,
                });
            }
            animateConfetti();
        }

        function animateConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            confettiParticles.forEach(p => {
                p.y += p.speed;
                p.x += Math.sin(p.angle);
                if (p.y > confettiCanvas.height) {
                    p.y = -10;
                    p.x = Math.random() * confettiCanvas.width;
                }
                confettiCtx.fillStyle = p.color;
                confettiCtx.fillRect(p.x, p.y, p.size, p.size * 2);
            });
            confettiAnimationId = requestAnimationFrame(animateConfetti);
        }

        function stopConfetti() {
            cancelAnimationFrame(confettiAnimationId);
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        }

        init();
    </script>
</body>
</html>
