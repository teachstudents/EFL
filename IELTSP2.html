<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Listening Part 1 Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        :root {
            --primary: #D32F2F; /* IELTS Red */
            --secondary: #2C3E50;
            --accent: #F5F5F5;
            --text: #333;
            --correct: #2e7d32;
            --wrong: #c62828;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background-color: var(--primary);
            color: white;
            padding: 0.8rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        h1 { margin: 0; font-size: 1.4rem; }
        
        /* Header Exit Button */
        .btn-exit-header {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 0.4rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: none; /* Hidden on menu */
        }
        .btn-exit-header:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Container */
        main {
            flex: 1;
            padding: 1rem 2rem;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden; /* Prevent double scrollbars */
        }

        /* Menu View */
        #menu-view {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 800px;
            text-align: center;
            overflow-y: auto;
            padding-bottom: 2rem;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            width: 100%;
        }

        .scenario-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.2rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .scenario-btn:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.15);
        }

        .scenario-btn i {
            color: var(--primary);
            font-size: 1.3rem;
        }

        /* Game View */
        #game-view {
            display: none; /* Hidden by default */
            width: 100%;
            height: 100%;
            flex-direction: column;
        }

        /* Questions Layout */
        .questions-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            padding: 0.5rem;
            flex: 1;
        }

        .question-card {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .q-text {
            font-weight: 600;
            margin-bottom: 0.8rem;
            font-size: 1.05rem;
        }

        .options-row {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .option-btn {
            flex: 1;
            padding: 0.6rem;
            border: 2px solid #eee;
            background: #fafafa;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            text-align: center;
            transition: all 0.2s;
            min-width: 100px;
        }

        /* Locked state (during audio) */
        .option-btn.locked {
            cursor: not-allowed;
            opacity: 0.7;
            background: #f0f0f0;
            color: #888;
        }

        /* Active/Selected states */
        .option-btn:not(.locked):hover {
            border-color: #bbb;
            background: #f0f0f0;
        }

        .option-btn.selected {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .option-btn.correct {
            background: var(--correct);
            color: white;
            border-color: var(--correct);
        }

        .option-btn.incorrect {
            background: var(--wrong);
            color: white;
            border-color: var(--wrong);
        }

        .controls {
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            min-height: 50px;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-check { 
            background: var(--primary); 
            color: white; 
            display: none; /* Hidden until audio ends */
        }
        .btn-check:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Modal Overlay for Results */
        #result-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }
        .score-circle {
            width: 80px; height: 80px;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 1rem auto;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .options-row { flex-direction: column; gap: 0.5rem; }
            .option-btn { width: 100%; text-align: left; padding-left: 1rem; }
            .menu-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <h1>IELTS Listening Part 1</h1>
    <button class="btn-exit-header" id="header-exit-btn" onclick="goHome()">Exit Scenario</button>
</header>

<main>
    <!-- MENU VIEW -->
    <div id="menu-view">
        <h2 style="color: var(--secondary); margin-bottom: 1rem;">Select Scenario (Set 2)</h2>
        
        <div class="menu-grid">
            <!-- 1. Restaurant -->
            <div class="scenario-btn" onclick="startScenario(0)">
                <div>Restaurant Booking</div>
                <i class="fas fa-utensils"></i>
            </div>

            <!-- 2. Job Agency -->
            <div class="scenario-btn" onclick="startScenario(1)">
                <div>Job Agency</div>
                <i class="fas fa-briefcase"></i>
            </div>

            <!-- 3. City Tour -->
            <div class="scenario-btn" onclick="startScenario(2)">
                <div>City Tour</div>
                <i class="fas fa-bus"></i>
            </div>

            <!-- 4. Apartment -->
            <div class="scenario-btn" onclick="startScenario(3)">
                <div>Apartment Hunting</div>
                <i class="fas fa-home"></i>
            </div>

            <!-- 5. Repairs -->
            <div class="scenario-btn" onclick="startScenario(4)">
                <div>Laptop Repair</div>
                <i class="fas fa-tools"></i>
            </div>

            <!-- 6. Conference -->
            <div class="scenario-btn" onclick="startScenario(5)">
                <div>Conference Reg</div>
                <i class="fas fa-id-badge"></i>
            </div>

            <!-- 7. Moving -->
            <div class="scenario-btn" onclick="startScenario(6)">
                <div>Moving House</div>
                <i class="fas fa-truck"></i>
            </div>

            <!-- 8. Camping -->
            <div class="scenario-btn" onclick="startScenario(7)">
                <div>Camping Trip</div>
                <i class="fas fa-campground"></i>
            </div>
        </div>
    </div>

    <!-- GAME VIEW -->
    <div id="game-view">
        <div class="questions-container" id="questions-container">
            <!-- Questions injected via JS -->
        </div>

        <div class="controls">
            <button id="submit-btn" class="btn btn-check" onclick="checkAnswers()">Check Answers</button>
            <div id="wait-msg" style="color: #666; font-style: italic;">Audio playing... Answers locked.</div>
        </div>
    </div>
</main>

<!-- RESULTS MODAL -->
<div id="result-modal">
    <div class="modal-content">
        <div class="score-circle" id="final-score">0/5</div>
        <h3>Session Complete</h3>
        <p id="feedback-text">Good effort!</p>
        <button class="btn btn-check" style="display:inline-block;" onclick="closeModal()">Review Answers</button>
        <button class="btn btn-home" style="padding: 0.8rem 1.5rem; border:none; background:#eee; border-radius:6px; cursor:pointer;" onclick="goHome()">Main Menu</button>
    </div>
</div>

<script>
    // --- DATA ---
    const scenarios = [
        // 1. Restaurant Booking
        {
            title: "Restaurant Booking",
            speakers: { female: "Emma", male: "Brian" },
            questions: [
                { q: "1. Day of reservation:", options: ["Friday", "Saturday", "Sunday"], correct: 0 },
                { q: "2. Number of people:", options: ["4", "6", "8"], correct: 2 },
                { q: "3. Time of booking:", options: ["7:00 PM", "7:30 PM", "8:00 PM"], correct: 2 },
                { q: "4. Special request:", options: ["Window seat", "Birthday cake", "Flowers"], correct: 1 },
                { q: "5. Deposit required:", options: ["$10", "$20", "$50"], correct: 1 }
            ],
            script: [
                { s: "F", t: "Good afternoon, The Golden Spoon restaurant." },
                { s: "M", t: "Hi, I'd like to book a table for this weekend." },
                { s: "F", t: "Certainly. For Saturday night?" },
                { s: "M", t: "Saturday is preferred, yes." },
                { s: "F", t: "I'm sorry, Saturday is fully booked for a private event. We have space on Friday or Sunday." },
                { s: "M", t: "Ah, okay. We'll do Friday then." },
                { s: "F", t: "Friday. And for how many people? 6?" },
                { s: "M", t: "It was going to be 6, but my brother and his wife are coming now, so 8." },
                { s: "F", t: "Table for 8. And what time?" },
                { s: "M", t: "Around 7:00?" },
                { s: "F", t: "The earliest large table we have is at 8:00 PM." },
                { s: "M", t: "That's a bit late, but 8:00 is fine." },
                { s: "F", t: "Any special requests? A window seat?" },
                { s: "M", t: "A window seat would be nice, but actually, it's my wife's birthday. Can you organize a cake?" },
                { s: "F", t: "We can do a chocolate cake, yes. We require a deposit for large groups." },
                { s: "M", t: "Is that $10 per person?" },
                { s: "F", t: "No, just a flat fee of $20 total." },
                { s: "M", t: "Perfect." }
            ]
        },
        // 2. Job Agency
        {
            title: "Job Agency",
            speakers: { female: "Ava", male: "Andrew" },
            questions: [
                { q: "1. Job applied for:", options: ["Waiter", "Receptionist", "Driver"], correct: 2 },
                { q: "2. Hourly pay:", options: ["$12", "$15", "$18"], correct: 1 },
                { q: "3. Start date:", options: ["Tomorrow", "Next Week", "Next Month"], correct: 0 },
                { q: "4. Uniform shirt color:", options: ["White", "Black", "Blue"], correct: 0 },
                { q: "5. Document to bring:", options: ["Resume", "Passport", "References"], correct: 1 }
            ],
            script: [
                { s: "F", t: "Sit down please. So you are looking for temporary work?" },
                { s: "M", t: "Yes. I saw an ad for a waiter." },
                { s: "F", t: "The waiter position has just been filled, I'm afraid. We have a vacancy for a receptionist?" },
                { s: "M", t: "I'm not good with computers. Anything else?" },
                { s: "F", t: "We need a delivery driver." },
                { s: "M", t: "I have a license. Driver is good." },
                { s: "F", t: "Great. The pay is usually $12 an hour." },
                { s: "M", t: "That's a bit low." },
                { s: "F", t: "Wait, for drivers it's actually $15 because of the night shifts." },
                { s: "M", t: "Okay, $15 is acceptable. When do I start? Next week?" },
                { s: "F", t: "They need someone urgently. Can you start tomorrow?" },
                { s: "M", t: "Tomorrow? Yes, I can do that." },
                { s: "F", t: "You'll need a uniform. Black trousers and a blue shirt." },
                { s: "M", t: "I only have a white shirt." },
                { s: "F", t: "Actually, white is better for the summer. Wear the white one." },
                { s: "M", t: "And do I need my resume?" },
                { s: "F", t: "I have your resume. Just bring your passport for the ID check." }
            ]
        },
        // 3. City Tour
        {
            title: "City Tour",
            speakers: { female: "Emma", male: "Brian" },
            questions: [
                { q: "1. Type of tour:", options: ["Bus", "Walking", "Boat"], correct: 1 },
                { q: "2. Duration:", options: ["2 hours", "3 hours", "4 hours"], correct: 1 },
                { q: "3. Cost per person:", options: ["$25", "$30", "$40"], correct: 1 },
                { q: "4. Included in price:", options: ["Lunch", "Drink", "Museum Entry"], correct: 1 },
                { q: "5. Meeting point:", options: ["Hotel Lobby", "Train Station", "Central Square"], correct: 1 }
            ],
            script: [
                { s: "M", t: "Hi, I'm interested in seeing the city." },
                { s: "F", t: "We have a great open-top bus tour." },
                { s: "M", t: "I get car sick. Do you have a boat tour?" },
                { s: "F", t: "The river level is too low today. How about a walking tour?" },
                { s: "M", t: "Walking sounds healthy. Let's do that." },
                { s: "F", t: "It usually lasts 2 hours." },
                { s: "M", t: "Is that all? I have the whole afternoon." },
                { s: "F", t: "Well, we have an extended version that is 3 hours. It visits the castle too." },
                { s: "M", t: "3 hours is perfect." },
                { s: "F", t: "That costs $40." },
                { s: "M", t: "I'm a senior citizen." },
                { s: "F", t: "Oh, then it's discounted to $30." },
                { s: "M", t: "Does that include lunch?" },
                { s: "F", t: "No lunch, but you get a free cold drink at the end." },
                { s: "M", t: "Okay. Where do we meet? The hotel lobby?" },
                { s: "F", t: "No, the guide will meet you at the Train Station entrance." }
            ]
        },
        // 4. Apartment Hunting
        {
            title: "Apartment Hunting",
            speakers: { female: "Ava", male: "Andrew" },
            questions: [
                { q: "1. Number of bedrooms:", options: ["1", "2", "3"], correct: 2 },
                { q: "2. Monthly rent:", options: ["$800", "$900", "$1000"], correct: 1 },
                { q: "3. Location preference:", options: ["City Center", "Suburbs", "Near Park"], correct: 2 },
                { q: "4. Utility included:", options: ["Internet", "Water", "Electricity"], correct: 1 },
                { q: "5. Viewing day:", options: ["Tuesday", "Wednesday", "Thursday"], correct: 2 }
            ],
            script: [
                { s: "F", t: "Estate Agents, how can I help?" },
                { s: "M", t: "I'm looking to rent an apartment." },
                { s: "F", t: "Okay. A one-bedroom?" },
                { s: "M", t: "No, I have two children, so I need 3 bedrooms." },
                { s: "F", t: "3 bedrooms. Okay. Our budget range is around $1000." },
                { s: "M", t: "That's my limit, but I'd prefer something cheaper." },
                { s: "F", t: "I have one for $900?" },
                { s: "M", t: "Yes, $900 is good." },
                { s: "F", t: "It's right in the City Center." },
                { s: "M", t: "Too noisy. Do you have anything near the park?" },
                { s: "F", t: "Yes, the $900 one is actually next to the park, not the center. My mistake." },
                { s: "M", t: "Excellent. Are bills included? Internet?" },
                { s: "F", t: "Internet is separate. But the landlord pays for the water." },
                { s: "M", t: "That helps. Can I see it on Tuesday?" },
                { s: "F", t: "The tenant is there Tuesday. Can you make Thursday?" },
                { s: "M", t: "Thursday works for me." }
            ]
        },
        // 5. Laptop Repair
        {
            title: "Laptop Repair",
            speakers: { female: "Emma", male: "Brian" },
            questions: [
                { q: "1. Brand of laptop:", options: ["Dell", "HP", "Apple"], correct: 1 },
                { q: "2. The problem is:", options: ["Broken Screen", "Battery", "Keyboard"], correct: 1 },
                { q: "3. Age of laptop:", options: ["1 year", "2 years", "3 years"], correct: 2 },
                { q: "4. Estimated cost:", options: ["$80", "$100", "$120"], correct: 1 },
                { q: "5. Collection day:", options: ["Wednesday", "Thursday", "Friday"], correct: 2 }
            ],
            script: [
                { s: "F", t: "Tech Repairs. What seems to be the trouble?" },
                { s: "M", t: "My laptop isn't working. It's a Dell." },
                { s: "F", t: "Let me see... looking at the logo, this is an HP model." },
                { s: "M", t: "Oh right, yes, my old one was a Dell. This is an HP." },
                { s: "F", t: "And did you drop it? Is the screen broken?" },
                { s: "M", t: "The screen is fine. It just won't charge. I think it's the battery." },
                { s: "F", t: "Likely the battery. How old is it? 2 years?" },
                { s: "M", t: "I bought it in 2020, so that makes it... 3 years old now." },
                { s: "F", t: "Okay. A new battery is usually $120." },
                { s: "M", t: "That's expensive." },
                { s: "F", t: "We have a compatible version for $100." },
                { s: "M", t: "I'll take the $100 one." },
                { s: "F", t: "It will be ready on Thursday." },
                { s: "M", t: "I'm away Thursday. Can I pick it up Friday?" },
                { s: "F", t: "Friday is fine. We are open until 6." }
            ]
        },
        // 6. Conference Registration
        {
            title: "Conference Reg",
            speakers: { female: "Ava", male: "Andrew" },
            questions: [
                { q: "1. Ticket type:", options: ["One Day", "Two Day", "VIP"], correct: 1 },
                { q: "2. Dietary requirement:", options: ["Meat", "Fish", "Vegetarian"], correct: 2 },
                { q: "3. Workshop choice:", options: ["Marketing", "Sales", "HR"], correct: 2 },
                { q: "4. Payment method:", options: ["Cash", "Card", "Check"], correct: 1 },
                { q: "5. ID required:", options: ["License", "Passport", "Work ID"], correct: 2 }
            ],
            script: [
                { s: "F", t: "Welcome to the Business Expo. Are you registering?" },
                { s: "M", t: "Yes. I'd like a One Day pass." },
                { s: "F", t: "Actually, looking at the schedule, the main speakers are spread over both days." },
                { s: "M", t: "In that case, give me the Two Day pass." },
                { s: "F", t: "Certainly. Lunch is included. Do you eat meat?" },
                { s: "M", t: "I eat fish, but I prefer vegetarian meals at conferences." },
                { s: "F", t: "Okay, I'll mark you as vegetarian. Now, which workshop?" },
                { s: "M", t: "The Marketing one looks good." },
                { s: "F", t: "Sorry, Marketing is full. We have Sales or HR?" },
                { s: "M", t: "I'll do the HR one then." },
                { s: "F", t: "How would you like to pay?" },
                { s: "M", t: "Do you take cash?" },
                { s: "F", t: "Card only I'm afraid." },
                { s: "M", t: "Card is fine." },
                { s: "F", t: "I just need to see your Work ID badge." },
                { s: "M", t: "Here it is." }
            ]
        },
        // 7. Moving House
        {
            title: "Moving House",
            speakers: { female: "Emma", male: "Brian" },
            questions: [
                { q: "1. Moving date:", options: ["1st", "15th", "30th"], correct: 2 },
                { q: "2. Large item to move:", options: ["Piano", "Sofa", "Fridge"], correct: 0 },
                { q: "3. Insurance level:", options: ["Basic", "Silver", "Gold"], correct: 2 },
                { q: "4. Total price:", options: ["$500", "$600", "$700"], correct: 1 },
                { q: "5. Packing service:", options: ["Full", "Partial", "None"], correct: 1 }
            ],
            script: [
                { s: "F", t: "Rapid Movers. When are you looking to move?" },
                { s: "M", t: "Ideally on the 1st of the month." },
                { s: "F", t: "We are fully booked on the 1st. We have the 30th available?" },
                { s: "M", t: "The 30th is actually better, I get the keys then." },
                { s: "F", t: "Do you have any large furniture? A sofa?" },
                { s: "M", t: "Just standard stuff, but I do have a piano." },
                { s: "F", t: "A piano. That requires special handling. I recommend Gold insurance." },
                { s: "M", t: "I usually get Basic." },
                { s: "F", t: "For a piano, you really need Gold." },
                { s: "M", t: "Okay, Gold insurance." },
                { s: "F", t: "That will be $700." },
                { s: "M", t: "Can you do it for $600?" },
                { s: "F", t: "If you do some packing yourself? Partial packing service?" },
                { s: "M", t: "Yes, I can pack the boxes. Partial service for $600." },
                { s: "F", t: "Agreed." }
            ]
        },
        // 8. Camping Trip
        {
            title: "Camping Trip",
            speakers: { female: "Ava", male: "Andrew" },
            questions: [
                { q: "1. Number of nights:", options: ["2", "3", "4"], correct: 1 },
                { q: "2. Tent size:", options: ["Small", "Medium", "Large"], correct: 2 },
                { q: "3. Facility required:", options: ["Pool", "Shop", "Kitchen"], correct: 2 },
                { q: "4. Arrival time:", options: ["2:00 PM", "4:00 PM", "6:00 PM"], correct: 2 },
                { q: "5. Planned activity:", options: ["Hiking", "Fishing", "Kayaking"], correct: 2 }
            ],
            script: [
                { s: "F", t: "Forest Campsite. Do you want to book a pitch?" },
                { s: "M", t: "Yes, for 2 nights please." },
                { s: "F", t: "We have a special offer: pay for 2, get the 3rd night free." },
                { s: "M", t: "Oh, well we might as well stay 3 nights then." },
                { s: "F", t: "Do you have a small tent?" },
                { s: "M", t: "It's a Medium one... actually, I borrowed my friend's Large family tent." },
                { s: "F", t: "Okay, a Large tent requires a bigger pitch near the kitchen." },
                { s: "M", t: "Near the kitchen is good." },
                { s: "F", t: "When will you arrive? Check-in is 2:00 PM." },
                { s: "M", t: "We are driving, so we won't be there until 6:00 PM." },
                { s: "F", t: "6:00 PM is fine. Are you here for the hiking?" },
                { s: "M", t: "My wife likes hiking, but I really want to try kayaking on the lake." },
                { s: "F", t: "Okay, I'll put down kayaking so we reserve a boat for you." }
            ]
        }
    ];

    // --- STATE ---
    let currentScenario = null;
    let selectedAnswers = [];
    let isAudioPlaying = false;
    let synth = window.speechSynthesis;
    let voices = [];

    // --- INITIALIZATION ---
    window.onload = function() {
        // Force voice loading
        voices = synth.getVoices();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }
    };

    function goHome() {
        cancelAudio();
        document.getElementById('game-view').style.display = 'none';
        document.getElementById('menu-view').style.display = 'flex';
        document.getElementById('result-modal').style.display = 'none';
        
        // Header button logic
        document.getElementById('header-exit-btn').style.display = 'none';
    }

    // --- GAME LOGIC ---
    function startScenario(index) {
        currentScenario = scenarios[index];
        selectedAnswers = new Array(5).fill(null);
        
        // UI Setup
        document.getElementById('menu-view').style.display = 'none';
        document.getElementById('game-view').style.display = 'flex';
        document.getElementById('header-exit-btn').style.display = 'block';
        
        // Render Questions
        const qContainer = document.getElementById('questions-container');
        qContainer.innerHTML = '';
        currentScenario.questions.forEach((q, i) => {
            const card = document.createElement('div');
            card.className = 'question-card';
            card.innerHTML = `
                <div class="q-text">${q.q}</div>
                <div class="options-row" id="q${i}-options">
                    ${q.options.map((opt, optIndex) => `
                        <button class="option-btn locked" onclick="selectOption(${i}, ${optIndex})" id="btn-${i}-${optIndex}">
                            ${opt}
                        </button>
                    `).join('')}
                </div>
            `;
            qContainer.appendChild(card);
        });

        // Controls Reset
        document.getElementById('submit-btn').style.display = 'none';
        document.getElementById('wait-msg').style.display = 'block';
        document.getElementById('wait-msg').textContent = "Audio playing... Listen carefully. Answers locked.";

        // Start Audio
        setTimeout(() => playScript(currentScenario.script, currentScenario.speakers), 500);
    }

    function selectOption(qIndex, optIndex) {
        if (isAudioPlaying) return; // Locked during audio

        selectedAnswers[qIndex] = optIndex;
        
        // Visual Update
        const buttons = document.querySelectorAll(`#q${qIndex}-options .option-btn`);
        buttons.forEach((btn, idx) => {
            if (idx === optIndex) btn.classList.add('selected');
            else btn.classList.remove('selected');
        });
    }

    function checkAnswers() {
        let score = 0;
        currentScenario.questions.forEach((q, i) => {
            const userAns = selectedAnswers[i];
            const correctAns = q.correct;
            
            // Score
            if (userAns === correctAns) score++;

            // Visual Feedback
            const buttons = document.querySelectorAll(`#q${i}-options .option-btn`);
            buttons.forEach((btn, idx) => {
                btn.classList.remove('selected');
                if (idx === correctAns) btn.classList.add('correct'); // Show correct (Green)
                if (idx === userAns && idx !== correctAns) btn.classList.add('incorrect'); // Show error (Red)
            });
        });

        // Show Modal
        document.getElementById('final-score').textContent = `${score}/5`;
        document.getElementById('feedback-text').textContent = score === 5 ? "Perfect Score! You avoided all the traps!" : "Review your mistakes. Watch out for distractors!";
        document.getElementById('result-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
    }

    // --- AUDIO SYSTEM ---
    function getVoice(name, gender) {
        // Priority 1: Specific Microsoft Natural Voice requested
        const specific = voices.find(v => v.name.includes("Microsoft " + name) && v.name.includes("Natural"));
        if (specific) return specific;

        // Priority 2: Any Microsoft Voice of that name
        const msName = voices.find(v => v.name.includes("Microsoft " + name));
        if (msName) return msName;

        // Priority 3: Fallback based on gender/locale
        // Basic heuristic for Male vs Female if name match fails
        if (gender === 'F') {
            return voices.find(v => v.name.includes("Female") || v.name.includes("Google US English") || v.name.includes("Samantha"));
        } else {
            return voices.find(v => v.name.includes("Male") || v.name.includes("Google UK English Male") || v.name.includes("Daniel"));
        }
    }

    function cancelAudio() {
        if (synth.speaking) synth.cancel();
        isAudioPlaying = false;
    }

    async function playScript(script, speakers) {
        cancelAudio();
        isAudioPlaying = true;
        
        // Find Voices
        const femaleVoice = getVoice(speakers.female, 'F');
        const maleVoice = getVoice(speakers.male, 'M');

        for (let i = 0; i < script.length; i++) {
            if (!isAudioPlaying) break; // Exit if cancelled

            const line = script[i];
            const utter = new SpeechSynthesisUtterance(line.t);
            
            // Settings
            utter.voice = line.s === 'F' ? femaleVoice : maleVoice;
            utter.rate = 1.0; // Normal Speed
            utter.pitch = 1;

            // Promise wrapper to wait for end
            await new Promise(resolve => {
                utter.onend = resolve;
                utter.onerror = resolve; // Handle errors gracefully
                synth.speak(utter);
            });

            // Small pause between speakers
            await new Promise(r => setTimeout(r, 400));
        }

        // End of Audio
        isAudioPlaying = false;
        document.getElementById('wait-msg').style.display = 'none';
        document.getElementById('submit-btn').style.display = 'inline-block';
        
        // Unlock buttons
        const allBtns = document.querySelectorAll('.option-btn');
        allBtns.forEach(btn => btn.classList.remove('locked'));
    }

</script>

</body>
</html>
