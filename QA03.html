<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Joel's Speaking Practice 03</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            position: relative;
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        audio::-webkit-media-controls-panel {
            padding: 5px;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display {
            margin: 0 2px;
        }
        /* Make sure app content is above the background */
        #app-container {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gradient-to-br dark:from-gray-900 dark:via-indigo-900 dark:to-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center p-2 sm:p-4">
    
    <div id="app-container" class="w-full max-w-xl mx-auto text-center h-full">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-white dark:bg-gray-800 dark:shadow-lg p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center">
            <div id="name-entry-container">
                <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">Joel's Speaking Practice 03</h1>
                <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 text-center text-lg text-gray-900 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                <button id="start-with-name-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">Start</button>
            </div>
            <div id="topic-selection-container" class="hidden">
                 <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">Hello, <span id="user-name-display"></span>!</h1>
                 <div id="instructions" class="text-sm text-gray-600 dark:text-gray-400 mb-4 text-left space-y-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                         <p><i class="fas fa-bullhorn mr-2 text-indigo-500"></i>Try to speak until the time runs out. You can use the sentence starters and word bank for help.</p>
                         <p><i class="fas fa-download mr-2 text-blue-500"></i>After recording, download your answer and upload it. If the upload doesn't work, save the downloaded files.</p>
                         <p><i class="fas fa-award mr-2 text-yellow-500"></i>You must complete all 9 topics to get the Certificate of Completion as proof you finished the homework.</p>
                 </div>
                <div id="topic-selection" class="grid grid-cols-3 gap-4">
                    <!-- Topic buttons will be injected here -->
                </div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden bg-white dark:bg-gray-800 dark:shadow-lg rounded-2xl shadow-lg app-shell p-3 sm:p-4">
            <header class="flex-shrink-0">
                <div class="flex justify-between items-center mb-2">
                    <div class="w-1/3 text-left">
                         <button id="back-to-topics-btn" class="text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-1 px-3 rounded-lg shadow-sm">
                            <i class="fas fa-arrow-left mr-2"></i>Topics
                        </button>
                    </div>
                    <div class="w-1/3 text-center">
                         <button id="samples-btn" class="hidden text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg shadow-md">
                             <i class="fas fa-comment-dots mr-1"></i>Sample Answers
                         </button>
                    </div>
                    <div class="w-1/3 text-right">
                         <button id="next-btn" class="hidden text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-lg shadow-sm disabled:bg-indigo-400 dark:disabled:bg-indigo-800 disabled:cursor-not-allowed">
                            Next<i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
                <!-- Timer Display -->
                <div class="relative w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-2 flex-shrink-0">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200 dark:text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="timer-progress" class="timer-circle text-indigo-500" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-2xl font-bold"></div>
                </div>
                <p id="phase-indicator" class="font-semibold text-indigo-500 dark:text-indigo-400 mb-2 text-base flex-shrink-0"></p>

                <!-- Question Display -->
                <div id="question-container" class="min-h-[50px] flex items-center justify-center mb-2">
                    <h2 id="question-text" class="text-base sm:text-lg font-semibold leading-relaxed text-left w-full"></h2>
                </div>
                
                <div id="error-message-box" class="hidden text-red-500 bg-red-100 dark:bg-red-900/50 p-2 rounded-lg text-sm mb-2"></div>

                <!-- Recording Action Buttons -->
                <div id="recording-actions-container" class="flex flex-col items-center justify-center mb-2">
                    <!-- Initial Record Button -->
                    <button id="record-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md transition-transform transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <!-- Stop Button -->
                    <button id="stop-record-btn" class="hidden bg-gray-700 hover:bg-gray-800 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md flex items-center justify-center">
                        <i class="fas fa-stop"></i>
                    </button>
                    <!-- Post-Recording Controls -->
                    <div id="post-recording-actions" class="hidden w-full flex-col items-center justify-center space-y-2 mt-2">
                        <audio id="audio-player" controls class="w-full max-w-xs"></audio>
                        <div class="flex flex-col gap-3 w-full max-w-xs">
                            <!-- Smart Download button -->
                            <button id="download-btn"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md transition-all duration-200 ease-in-out hover:shadow-lg hover:shadow-blue-500/50 focus:ring-2 focus:ring-blue-400 focus:outline-none active:scale-95 flex items-center justify-center">
                                <i class="fas fa-download mr-1"></i>Download Audio & Text
                            </button>
                            
                            <!-- Upload button -->
                            <a id="sharepoint-upload-link"
                               href="https://xichengacademy-my.sharepoint.com/:f:/g/personal/joelmitchell_xichengacademy_cn/EjxMFg8-baNEo5uuWUBc4EoBzn1DVWJ1Ym_NFx6hPlJ0dQ"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md transition-all duration-200 ease-in-out hover:shadow-lg hover:shadow-green-500/50 focus:ring-2 focus:ring-green-400 focus:outline-none active:scale-95 flex items-center justify-center">
                                <i class="fas fa-upload mr-1"></i>Upload to Folder
                            </a>
                        </div>
                    </div>
                </div>
                 <div id="recording-status" class="hidden items-center justify-center text-red-500 font-semibold mb-1">
                     <div class="w-2 h-2 bg-red-500 rounded-full mr-2 recording-indicator"></div>
                     Recording...
                 </div>
            </header>
            
            <main class="flex-grow flex flex-col overflow-y-auto min-h-0 space-y-2 pt-2">
                 <!-- Sentence Starters -->
                <div id="starters-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Sentence Starters</h3>
                    <div id="starters-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Word Bank -->
                <div id="word-bank-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Word Bank</h3>
                    <div id="word-bank-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Transcription Display -->
                <div id="transcription-container" class="hidden text-left mt-2">
                    <h3 class="text-sm font-bold mb-1 text-center">Your Answer (Live Transcript)</h3>
                    <div id="transcription-output" class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg min-h-[60px] text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></div>
                </div>

                <!-- Sample Answers Display -->
                <div id="samples-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center flex-shrink-0">Sample Responses</h3>
                    <ul id="samples-list" class="space-y-2 list-inside bg-indigo-900/70 dark:bg-indigo-900/90 p-3 rounded-lg max-h-28 sm:max-h-32 overflow-y-auto">
                    </ul>
                </div>
            </main>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center">
            <div id="certificate-to-download" class="w-full bg-gray-50 dark:bg-gray-700 p-8 rounded-lg border-4 border-yellow-400 dark:border-yellow-500 text-center">
                <i class="fas fa-award text-6xl text-yellow-500 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Certificate of Completion</h1>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">This certificate is awarded to</p>
                <p id="certificate-name" class="text-4xl font-bold my-4 text-indigo-600 dark:text-indigo-400"></p>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">for successfully completing all 9 speaking practice topics.</p>
                <p class="text-sm mt-6 text-gray-500 dark:text-gray-400">Issued on: <span id="certificate-date"></span></p>
            </div>
            <button id="download-certificate-btn" class="mt-6 w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">
                <i class="fas fa-download mr-2"></i>Download Certificate
            </button>
             <button id="back-to-main-menu-btn" class="mt-3 text-sm text-indigo-500 hover:underline">Back to Main Menu</button>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 text-center max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Are you sure?</h3>
            <p id="modal-message" class="text-gray-600 dark:text-gray-400 mb-6">Returning to the topic list will stop your current practice.</p>
            <div class="flex justify-center gap-4">
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Yes</button>
                <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white">Cancel</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA: Questions and Sample Answers for Part 03 ---
        const practiceData = {
            "Rooftop Gardens": [
                { 
                    question: "If you could design a rooftop garden for our school, what would you include and why?", 
                    starters: ["In my ideal rooftop garden, I would include...", "I think it's important to have...", "One feature I would add is...", "The main purpose of the garden would be..."], 
                    wordBank: ["vegetable patches", "fruit trees", "relaxation area", "solar panels", "study space", "biodiversity", "urban farming", "sustainable", "community"], 
                    samples: [
                        "I would include comfortable benches and tables to create a quiet study space, because it would be a peaceful place for students to do homework away from noisy classrooms.",
                        "In my design, I would add several vegetable patches where students could learn about urban farming and grow their own food, which could then be used in the school cafeteria.",
                        "I think it's important to have native flowers and plants to attract bees and butterflies, because this would increase biodiversity in our urban environment."
                    ] 
                },
                { 
                    question: "What are the biggest benefits of having more green spaces like rooftop gardens in big cities like Beijing?", 
                    starters: ["One of the main benefits is...", "Green spaces can significantly improve...", "From an environmental perspective...", "For the community, it provides..."], 
                    wordBank: ["air quality", "reduce heat", "mental health", "recreation", "wildlife habitat", "community building", "aesthetic value", "educational", "sustainability"], 
                    samples: [
                        "One of the biggest benefits is the improvement in air quality, because plants absorb carbon dioxide and other pollutants, which is very important in a large city.",
                        "These gardens can significantly reduce the urban heat island effect, as plants cool the surrounding air, making the city more comfortable during hot summers.",
                        "For residents, it provides a valuable space for relaxation and recreation, which can improve mental health by reducing stress and anxiety from busy city life."
                    ] 
                }
            ],
            "Microplastics": [
                { 
                    question: "What is one change you could make in your daily life to reduce your personal use of plastics?", 
                    starters: ["One change I can make is to...", "I could try to avoid buying...", "Instead of using..., I could...", "I plan to be more conscious about..."], 
                    wordBank: ["reusable water bottle", "cloth shopping bags", "avoid single-use plastics", "food containers", "plastic straws", "packaging", "conscious consumer", "sustainable alternatives", "reduce"], 
                    samples: [
                        "One simple change I can make is to always carry a reusable water bottle, so I don't have to buy plastic bottles of water when I'm outside.",
                        "I could try to avoid buying fruits and vegetables that are wrapped in excessive plastic packaging and choose loose ones instead.",
                        "Instead of using disposable plastic food containers for lunch, I could use a stainless steel or glass container which can be washed and reused many times."
                    ] 
                },
                { 
                    question: "Why do you think the problem of microplastic pollution is so difficult to solve?", 
                    starters: ["I think it's difficult because...", "One major challenge is that...", "The problem is widespread due to...", "It's a complex issue involving..."], 
                    wordBank: ["invisible", "widespread", "food chain", "ocean currents", "difficult to filter", "consumer habits", "industrial reliance", "global problem", "long-term effects"], 
                    samples: [
                        "I think it's difficult because microplastics are tiny and almost invisible, making them nearly impossible to clean up from the oceans and soil once they are there.",
                        "One major challenge is our global reliance on plastic for everything from packaging to clothing, so changing this requires huge industrial and economic shifts.",
                        "The problem is so widespread because plastic doesn't biodegrade; it just breaks down into smaller pieces that are then carried everywhere by wind and ocean currents."
                    ] 
                }
            ],
            "Mid-Autumn Festival": [
                { 
                    question: "Besides eating mooncakes, what is your favorite family tradition during the Mid-Autumn Festival?", 
                    starters: ["My favorite tradition is when my family...", "I always look forward to...", "Something special we do is...", "For my family, the festival is a time for..."], 
                    wordBank: ["family reunion", "gazing at the full moon", "lighting lanterns", "telling stories", "sharing a meal", "hometown", "togetherness", "celebration", "tradition"], 
                    samples: [
                        "My favorite tradition is gathering with all my relatives for a big family dinner because it's one of the few times a year we are all together in one place.",
                        "I always look forward to going to a local park with my family to gaze at the full moon, because my grandparents tell us old stories and legends about the moon goddess, Chang'e.",
                        "Something special we do is that each family member writes a wish on a paper lantern and we light them together. It's a beautiful and hopeful moment."
                    ] 
                },
                 { 
                    question: "If you had to explain the meaning of the Mid-Autumn Festival to a foreign friend, what would you say?", 
                    starters: ["I would explain that it's like...", "The most important theme is...", "It's a festival that celebrates...", "I would tell them it's a time when..."], 
                    wordBank: ["harvest moon", "family unity", "gratitude", "reunion", "similar to Thanksgiving", "cultural heritage", "legends", "full moon", "togetherness"], 
                    samples: [
                        "I would explain that it's similar to Thanksgiving in America, because the most important theme is family reunion and being grateful for the harvest and for each other.",
                        "I'd say it's a festival that celebrates the full moon, which symbolizes completeness and unity. It's a time when families get together, no matter how far apart they live.",
                        "I would tell them it's a very old and important part of our culture, based on legends about the moon, and we celebrate it by eating special pastries called mooncakes and enjoying the moonlight."
                    ] 
                }
            ],
            "The Gaokao": [
                { 
                    question: "How do you and your friends deal with the pressure of preparing for the Gaokao?", 
                    starters: ["To deal with the pressure, we...", "One way I relax is by...", "My friends and I support each other by...", "It's very stressful, but we try to..."], 
                    wordBank: ["study groups", "taking breaks", "playing sports", "listening to music", "talking to each other", "immense pressure", "staying positive", "time management", "support system"], 
                    samples: [
                        "To deal with the pressure, my friends and I make sure to take short breaks to play basketball, because physical activity helps us clear our minds.",
                        "We support each other by forming study groups. When someone is feeling stressed, we talk about it and remind each other that we are all in this together.",
                        "It is very stressful, but I try to manage my time carefully. Having a schedule for studying, resting, and hobbies makes the pressure feel more manageable."
                    ] 
                },
                { 
                    question: "Some people say the Gaokao is fair, while others say it's too much pressure. What is your opinion?", 
                    starters: ["In my opinion, the Gaokao is...", "On one hand, I think it's fair because...", "On the other hand, the pressure is...", "I believe it has both pros and cons..."], 
                    wordBank: ["fair system", "equal opportunity", "immense stress", "mental health", "single exam", "defines future", "merit-based", "creativity", "intense competition"], 
                    samples: [
                        "On one hand, I think it's a fair system because it gives every student, regardless of their family background, an equal opportunity to get into a good university.",
                        "On the other hand, the pressure is immense because our entire future feels like it depends on our performance over just two days, which can negatively affect mental health.",
                        "I believe it has both pros and cons. While it is a merit-based way to select students, it puts too much focus on rote memorization instead of fostering creativity and critical thinking."
                    ] 
                }
            ],
            "School-Life Balance": [
                { 
                    question: "What is your favorite activity to do when you take a break from studying?", 
                    starters: ["When I take a break, my favorite thing to do is...", "To relax my mind, I enjoy...", "I find that... helps me recharge.", "My go-to activity is..."], 
                    wordBank: ["reading novels", "playing video games", "going for a walk", "drawing", "practicing an instrument", "extracurriculars", "hobby", "recharge", "unwind"], 
                    samples: [
                        "When I take a break, my favorite thing to do is read a fantasy novel, because it allows me to escape into a different world and forget about schoolwork for a while.",
                        "To relax my mind, I enjoy going for a walk in a nearby park while listening to my favorite podcasts. The fresh air and interesting stories help me feel refreshed.",
                        "I find that playing the guitar helps me recharge. Focusing on the music is a form of meditation for me and it completely takes my mind off the stress of exams."
                    ] 
                },
                { 
                    question: "Do you think schools in China should give students more time for hobbies and extracurricular activities? Why or why not?", 
                    starters: ["Yes, I definitely think schools should because...", "No, I think the current focus is necessary because...", "It's a difficult balance, but I believe...", "More time for hobbies would lead to..."], 
                    wordBank: ["well-rounded development", "creativity", "soft skills", "academic pressure", "competition", "time management", "personal growth", "mental well-being", "holistic education"], 
                    samples: [
                        "Yes, I definitely think schools should give more time for hobbies, because this would lead to more well-rounded development and help students discover their passions outside of academics.",
                        "It's a difficult balance due to the competitive environment, but I believe more free time would improve students' mental well-being and actually make their study time more effective.",
                        "More time for extracurriculars would help students develop important soft skills like teamwork and leadership, which are just as valuable for their future careers as good grades."
                    ] 
                }
            ],
            "Future Majors": [
                { 
                    question: "What subject do you enjoy most in school, and could you see yourself studying it at university?", 
                    starters: ["The subject I enjoy the most is...", "I'm really passionate about... because...", "I could definitely see myself studying...", "I'm considering a major in..."], 
                    wordBank: ["computer science", "engineering", "physics", "economics", "literature", "logical thinking", "problem-solving", "career prospects", "personal interest"], 
                    samples: [
                        "The subject I enjoy the most is physics, because I love understanding how the world works, and I could definitely see myself studying engineering at university.",
                        "I'm really passionate about computer science. I enjoy the logical thinking required for coding, and the career prospects in the tech industry are very strong.",
                        "I'm considering a major in economics because I find it fascinating how global markets work and how decisions by governments can affect our daily lives."
                    ] 
                },
                { 
                    question: "How much do your parents' expectations influence your choice of a future major or career?", 
                    starters: ["My parents' expectations are a big factor because...", "They have some influence, but the final decision is...", "I try to balance their advice with...", "My parents hope that I will..., but I..."], 
                    wordBank: ["parental guidance", "high expectations", "stable career", "financial security", "my own passion", "mutual understanding", "generation gap", "respect their advice", "follow my dreams"], 
                    samples: [
                        "My parents' expectations are a big factor, as they hope I choose a stable career like engineering, but they also encourage me to follow my own interests.",
                        "They have some influence, especially regarding financial security, but they have told me that the final decision is mine as long as I have a clear plan.",
                        "I try to balance their advice with my own passion. We have had many discussions, and we are working towards a mutual understanding about my future."
                    ] 
                }
            ],
            "Digital Life": [
                { 
                    question: "What are the advantages and disadvantages of using social media apps like WeChat and Douyin for students?", 
                    starters: ["One major advantage is...", "On the flip side, a big disadvantage is...", "Social media can be useful for...", "However, it can also be..."], 
                    wordBank: ["staying connected", "information access", "distraction", "cyberbullying", "entertainment", "time-consuming", "social pressure", "learning resource", "communication"], 
                    samples: [
                        "One major advantage of WeChat is that it's an easy way to communicate with classmates for group projects and stay connected with friends.",
                        "On the flip side, a big disadvantage of Douyin is that it can be a huge distraction from studying, as it's very easy to spend hours watching short videos.",
                        "Social media can be a useful learning resource if you follow educational accounts, but it can also create social pressure to present a perfect life online."
                    ] 
                },
                { 
                    question: "How has online learning changed your study habits compared to traditional classroom learning?", 
                    starters: ["Online learning has made me more...", "One big difference is the need for...", "I've had to learn how to...", "Compared to a classroom, online learning requires..."], 
                    wordBank: ["self-disciplined", "flexible schedule", "time management", "technical issues", "less interaction", "independent", "stay focused", "motivation", "digital resources"], 
                    samples: [
                        "Online learning has forced me to become much more self-disciplined, because there is no teacher physically present to make sure I am paying attention.",
                        "A big difference is the need for better time management. With a flexible schedule, it's easy to procrastinate if you don't plan your day carefully.",
                        "Compared to a regular classroom, there is less direct interaction with teachers and classmates, so I've had to be more proactive in asking questions online."
                    ] 
                }
            ],
            "Parental Expectations": [
                { 
                    question: "Describe a time you felt a lot of pressure from your parents about school. How did you handle it?", 
                    starters: ["I remember before a big exam...", "My parents were worried about my grades, and...", "To handle the pressure, I...", "I communicated with them by..."], 
                    wordBank: ["high expectations", "pressure to succeed", "disappointing them", "open communication", "study harder", "felt stressed", "explained my feelings", "find a balance", "their perspective"], 
                    samples: [
                        "I remember before my midterm exams, my parents expected me to get a top rank. I felt very stressed, so I talked to them and explained that their pressure was making it harder for me to focus.",
                        "There was a time my math grade dropped, and my parents were worried. I handled it by creating a detailed study plan and showing it to them to prove I was taking it seriously.",
                        "To handle the pressure, I try to understand their perspective. I know they just want the best for me, so I listen to their advice but also share my own feelings about the stress it causes."
                    ] 
                },
                { 
                    question: "In what ways do you think your life goals are different from what your parents want for you?", 
                    starters: ["My parents value..., whereas I am more interested in...", "One key difference is...", "They hope I have a..., but I dream of...", "Our ideas about success are different because..."], 
                    wordBank: ["stability", "adventure", "job security", "personal fulfillment", "traditional path", "creative field", "entrepreneurship", "generation gap", "different values"], 
                    samples: [
                        "My parents value stability and want me to have a secure job in a big company, whereas I am more interested in the adventure of joining a start-up or even starting my own business.",
                        "One key difference is their focus on financial security. While I agree it's important, I place a higher value on personal fulfillment and enjoying my daily work.",
                        "They hope I will stay in our hometown after university, but I dream of working in a different country for a few years to gain international experience."
                    ] 
                }
            ],
            "Travel & Exploration": [
                { 
                    question: "If you could visit any city in China for a weekend, where would you go and why?", 
                    starters: ["I would love to visit...", "The city I'm most curious about is...", "I would choose... because of its...", "My ideal weekend trip would be to..."], 
                    wordBank: ["historical sites", "natural scenery", "delicious food", "modern architecture", "cultural experience", "vibrant atmosphere", "ancient capital", "landscapes"], 
                    samples: [
                        "I would love to visit Xi'an because I am fascinated by Chinese history, and I want to see the Terracotta Army with my own eyes.",
                        "I would choose Chengdu because of its famous delicious and spicy food, and I've also heard it has a more relaxed and laid-back atmosphere than other big cities.",
                        "My ideal weekend trip would be to Guilin to see the incredible natural scenery. The photos of the limestone karst mountains along the Li River look breathtaking."
                    ] 
                },
                { 
                    question: "What do you think is the most important lesson people learn from traveling to new places?", 
                    starters: ["I believe the most important lesson is...", "Traveling teaches you to be more...", "By experiencing different cultures, people learn...", "One of the greatest benefits is..."], 
                    wordBank: ["open-minded", "adaptable", "cultural understanding", "independence", "new perspectives", "appreciation", "step out of your comfort zone", "resilience", "global citizen"], 
                    samples: [
                        "I believe the most important lesson is becoming more open-minded. When you see that people live differently, you learn to respect and appreciate other cultures.",
                        "Traveling teaches you to be more adaptable and independent, because you often have to solve unexpected problems on your own, like navigating a new city or dealing with language barriers.",
                        "By stepping out of your comfort zone, you gain new perspectives on your own life and a greater appreciation for what you have back home."
                    ] 
                }
            ]
        };

        // --- DOM Elements ---
        const ui = {
            welcomeScreen: document.getElementById('welcome-screen'),
            practiceScreen: document.getElementById('practice-screen'),
            nameEntryContainer: document.getElementById('name-entry-container'),
            nameInput: document.getElementById('name-input'),
            startWithNameBtn: document.getElementById('start-with-name-btn'),
            topicSelectionContainer: document.getElementById('topic-selection-container'),
            userNameDisplay: document.getElementById('user-name-display'),
            topicSelection: document.getElementById('topic-selection'),
            nextBtn: document.getElementById('next-btn'),
            backToTopicsBtn: document.getElementById('back-to-topics-btn'),
            samplesBtn: document.getElementById('samples-btn'),
            timerDisplay: document.getElementById('timer-display'),
            timerProgress: document.getElementById('timer-progress'),
            phaseIndicator: document.getElementById('phase-indicator'),
            questionText: document.getElementById('question-text'),
            samplesContainer: document.getElementById('samples-container'),
            samplesList: document.getElementById('samples-list'),
            startersContainer: document.getElementById('starters-container'),
            startersList: document.getElementById('starters-list'),
            wordBankContainer: document.getElementById('word-bank-container'),
            wordBankList: document.getElementById('word-bank-list'),
            errorMessagebox: document.getElementById('error-message-box'),
            recordBtn: document.getElementById('record-btn'),
            stopRecordBtn: document.getElementById('stop-record-btn'),
            audioPlayer: document.getElementById('audio-player'),
            recordingStatus: document.getElementById('recording-status'),
            postRecordingActions: document.getElementById('post-recording-actions'),
            downloadBtn: document.getElementById('download-btn'),
            transcriptionContainer: document.getElementById('transcription-container'),
            transcriptionOutput: document.getElementById('transcription-output'),
            certificateScreen: document.getElementById('certificate-screen'),
            downloadCertificateBtn: document.getElementById('download-certificate-btn'),
            backToMainMenuBtn: document.getElementById('back-to-main-menu-btn'),
            modal: document.getElementById('confirmation-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn')
        };


        // --- State Variables ---
        let userName = '';
        let currentQuestionIndex = 0;
        let masterQuestionList = [];
        let currentQuestions = []; 
        let timerInterval;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;
        let completedTopics = {};
        let speechRecognition;
        let finalTranscript = '';

        const FULL_DASH_ARRAY = 283;
        const DEFAULT_RESPONSE_TIME = 60;

        // --- Text-to-Speech ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;
        let ttsInitialized = false;

        function initializeTTS() {
            return new Promise((resolve) => {
                if (!synth) {
                    ttsInitialized = true;
                    return resolve();
                }

                const setBestVoice = () => {
                    const voices = synth.getVoices();
                    if (voices.length === 0) return;
                    
                    const scoreVoice = (voice) => {
                        let score = 0;
                        const name = voice.name.toLowerCase();
                        if (name.includes('natural')) score += 5;
                        if (name.includes('brian') || name.includes('emma')) score += 4;
                        if (name.includes('microsoft')) score += 3;
                        if (name.includes('google')) score += 2;
                        if (voice.localService) score += 1;
                        return score;
                    };

                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    if (englishVoices.length > 0) {
                        englishVoices.sort((a, b) => scoreVoice(b) - scoreVoice(a));
                        preferredVoice = englishVoices[0];
                    }
                    
                    ttsInitialized = true;
                    resolve();
                };

                if (synth.getVoices().length > 0) {
                    setBestVoice();
                } else {
                    synth.onvoiceschanged = setBestVoice;
                }
            });
        }

        function speak(text) {
            if (!ttsInitialized || !synth || !text) {
                console.warn("TTS not ready or text is empty.");
                return;
            }

            try {
                if (synth.speaking) {
                    synth.cancel();
                }
                setTimeout(() => {
                    const utterThis = new SpeechSynthesisUtterance(text);
                    utterThis.onerror = (event) => {
                        console.error(`SpeechSynthesisUtterance.onerror: ${event.error}`, { text: text });
                    };
                    if (preferredVoice) {
                        utterThis.voice = preferredVoice;
                    }
                    utterThis.pitch = 1;
                    utterThis.rate = 0.85;
                    synth.speak(utterThis);
                }, 100); 

            } catch (e) {
                console.error("Speech synthesis 'speak' function threw an exception:", e);
            }
        }

        // --- Local Storage ---
        function loadProgress() {
            const savedCompletedTopics = localStorage.getItem('languagePracticeCompletedTopics03');
            if (savedCompletedTopics) {
                try {
                    const parsed = JSON.parse(savedCompletedTopics);
                    if (typeof parsed === 'object' && parsed !== null) {
                        completedTopics = parsed;
                    } else {
                         completedTopics = {};
                    }
                } catch (e) {
                    console.error("Failed to parse saved progress:", e);
                    completedTopics = {};
                }
            }
            const savedName = localStorage.getItem('languagePracticeUserName03');
            if (savedName) {
                 userName = savedName;
                 ui.nameInput.value = userName;
            }
        }

        function saveProgress() {
            localStorage.setItem('languagePracticeCompletedTopics03', JSON.stringify(completedTopics));
            if(userName) localStorage.setItem('languagePracticeUserName03', userName);
        }

        // --- UI Initialization & Data Setup ---
        function initializeTopics() {
            ui.topicSelection.innerHTML = '';
            for (const topic in practiceData) {
                const button = document.createElement('button');
                
                let checkmark = '';
                if (completedTopics && completedTopics[topic]) {
                    checkmark = `<i class="fas fa-check-circle ml-2 text-blue-500"></i>`;
                    button.className = "w-full bg-green-100 dark:bg-green-900/50 p-2 rounded-lg shadow-md hover:bg-green-200 dark:hover:bg-green-800/60 transition-colors flex items-center justify-center";
                } else {
                    button.className = "w-full bg-white dark:bg-gray-700 p-2 rounded-lg shadow-md hover:bg-indigo-100 dark:hover:bg-indigo-800 transition-all transform hover:scale-105 flex items-center justify-center";
                }

                button.innerHTML = `<span class="text-sm font-semibold">${topic}</span> ${checkmark}`;
                button.dataset.topic = topic;
                button.addEventListener('click', () => startPractice(topic));
                ui.topicSelection.appendChild(button);
            }
        }
        
        function createMasterList() {
            masterQuestionList = [];
            for (const topic in practiceData) {
                practiceData[topic].forEach(question => {
                    masterQuestionList.push({ ...question, topicName: topic });
                });
            }
        }

        // --- Core App Logic ---
        function startPractice(topic) {
            const startIndex = masterQuestionList.findIndex(q => q.topicName === topic);
            currentQuestionIndex = (startIndex !== -1) ? startIndex : 0;
            currentQuestions = masterQuestionList;
            
            ui.welcomeScreen.classList.add('hidden');
            ui.practiceScreen.classList.remove('hidden');
            ui.certificateScreen.classList.add('hidden');
            ui.nextBtn.classList.remove('hidden');
            ui.samplesBtn.classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex > 0) {
                const prevQuestion = currentQuestions[currentQuestionIndex - 1];
                const currentQuestion = currentQuestions[currentQuestionIndex];
                if (currentQuestion && prevQuestion.topicName !== currentQuestion.topicName) {
                    if (!completedTopics[prevQuestion.topicName]) {
                        completedTopics[prevQuestion.topicName] = true;
                        saveProgress();
                    }
                }
            }

            if (currentQuestionIndex >= currentQuestions.length) {
                if (currentQuestions.length > 0) {
                    const lastTopicName = currentQuestions[currentQuestions.length - 1].topicName;
                     if (!completedTopics[lastTopicName]) {
                        completedTopics[lastTopicName] = true;
                        saveProgress();
                    }
                }
                ui.phaseIndicator.textContent = "All topics complete!";
                ui.questionText.textContent = "You've finished everything. Fantastic work!";
                speak("You've finished everything. Fantastic work!");
                ui.nextBtn.classList.add('hidden');
                ui.samplesBtn.classList.add('hidden');
                showCertificate();
                return;
            }

            ui.nextBtn.disabled = true;

            const item = currentQuestions[currentQuestionIndex];
            resetUIForNewQuestion();
            
            let fullQuestion = (item.intro ? item.intro + " " : "") + item.question;
            ui.questionText.textContent = fullQuestion;
            ui.questionText.classList.add('fade-in');
            setTimeout(() => ui.questionText.classList.remove('fade-in'), 500);

            speak(fullQuestion);
            
            if (item.starters && item.starters.length > 0) {
                ui.startersList.innerHTML = '';
                item.starters.forEach(starter => {
                    const button = document.createElement('button');
                    button.className = 'bg-indigo-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-indigo-600 dark:text-white cursor-default';
                    button.textContent = starter;
                    ui.startersList.appendChild(button);
                });
                ui.startersContainer.classList.remove('hidden');
            }

            if (item.wordBank && item.wordBank.length > 0) {
                ui.wordBankList.innerHTML = '';
                item.wordBank.forEach(word => {
                    const button = document.createElement('button');
                    button.className = 'bg-green-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-green-600 dark:text-white cursor-default';
                    button.textContent = word;
                    ui.wordBankList.appendChild(button);
                });
                ui.wordBankContainer.classList.remove('hidden');
            }

            ui.phaseIndicator.textContent = `${item.topicName} (Question ${currentQuestionIndex + 1} of ${currentQuestions.length})`;
            
            const responseTime = item.timer || DEFAULT_RESPONSE_TIME;
            startTimer(responseTime, () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                }
                ui.phaseIndicator.textContent = "Time's up! Click Next to continue.";
                ui.recordBtn.disabled = true;
                ui.recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                ui.nextBtn.disabled = false;
            });
        }
        
        function showCertificate() {
            ui.practiceScreen.classList.add('hidden');
            ui.welcomeScreen.classList.add('hidden');
            ui.certificateScreen.classList.remove('hidden');
            document.getElementById('certificate-name').textContent = userName;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
        }
        
        function showErrorMessage(message) {
            ui.errorMessagebox.textContent = message;
            ui.errorMessagebox.classList.remove('hidden');
            setTimeout(() => {
                ui.errorMessagebox.classList.add('hidden');
            }, 5000);
        }

        // --- Recording & Transcription Logic ---
        async function startRecording() {
            if (!window.MediaRecorder) {
                showErrorMessage("Audio recording is not supported on this browser.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const isMobileEdge = /Edg\/\d+.*Android/.test(navigator.userAgent);
                let options = {};
                if (!isMobileEdge) {
                    const mimeTypes = ['audio/webm;codecs=opus', 'audio/ogg;codecs=opus', 'audio/webm', 'audio/ogg'];
                    const supportedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
                    if (supportedType) options.mimeType = supportedType;
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.start();
                startTranscription();

                ui.recordBtn.classList.add('hidden');
                ui.stopRecordBtn.classList.remove('hidden');
                ui.recordingStatus.classList.remove('hidden');
                ui.transcriptionContainer.classList.remove('hidden');

                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    recordedBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedBlob);
                    ui.audioPlayer.src = audioUrl;
                    ui.postRecordingActions.classList.remove('hidden');
                    ui.recordingStatus.classList.add('hidden');
                    ui.stopRecordBtn.classList.add('hidden');
                    ui.recordBtn.classList.add('hidden');
                    ui.nextBtn.disabled = false;
                });
            } catch (err) {
                console.error("Error starting recording:", err);
                showErrorMessage("Could not start audio recording. Please grant microphone permission.");
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
            if (speechRecognition) {
                speechRecognition.stop();
            }
        }

        function startTranscription() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("Speech recognition not supported  skipping setup.");
                ui.transcriptionOutput.textContent = "Speech-to-text is not available on this browser.";
                return;
            }

            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';
            finalTranscript = '';
            ui.transcriptionOutput.textContent = '';


            speechRecognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                ui.transcriptionOutput.innerHTML = `${finalTranscript}<span class="text-gray-400">${interimTranscript}</span>`;

            };
            
            speechRecognition.onerror = (event) => {
                 console.error('Speech recognition error detected: ' + event.error);
            }

            speechRecognition.start();
        }
        
        // --- Confirmation Modal ---
        function showConfirmationModal(title, message, onConfirm) {
            ui.modalTitle.textContent = title;
            ui.modalMessage.textContent = message;
            ui.modal.classList.remove('hidden');

            const confirmHandler = () => {
                onConfirm();
                hide();
            };

            const hide = () => {
                ui.modal.classList.add('hidden');
                ui.modalConfirmBtn.removeEventListener('click', confirmHandler);
                ui.modalCancelBtn.removeEventListener('click', hide);
            };

            ui.modalConfirmBtn.addEventListener('click', confirmHandler);
            ui.modalCancelBtn.addEventListener('click', hide);
        }


        // --- Timer Functions ---
        function startTimer(duration, onEndCallback) {
            let timeLeft = duration;
            clearInterval(timerInterval);
            updateTimerDisplay(timeLeft, duration);

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft, duration);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if(onEndCallback) onEndCallback();
                }
            }, 1000);
        }

        function updateTimerDisplay(timeLeft, totalDuration) {
            const minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            if (seconds < 10) seconds = `0${seconds}`;
            ui.timerDisplay.textContent = `${minutes}:${seconds}`;
            
            const fraction = timeLeft / totalDuration;
            const offset = fraction * FULL_DASH_ARRAY;
            ui.timerProgress.style.strokeDashoffset = FULL_DASH_ARRAY - offset;
        }

        // --- UI Helper Functions ---
        function resetUIForNewQuestion() {
            ui.samplesContainer.classList.add('hidden');
            ui.startersContainer.classList.add('hidden');
            ui.wordBankContainer.classList.add('hidden');
            ui.transcriptionContainer.classList.add('hidden');
            ui.errorMessagebox.classList.add('hidden');
            ui.recordBtn.disabled = false;
            ui.recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            resetRecordingUI();
        }

        function resetRecordingUI() {
            ui.recordBtn.classList.remove('hidden');
            ui.stopRecordBtn.classList.add('hidden');
            ui.recordingStatus.classList.add('hidden');
            ui.postRecordingActions.classList.add('hidden');
            ui.audioPlayer.src = '';
            ui.transcriptionOutput.textContent = '';
            audioChunks = [];
            recordedBlob = null;
            finalTranscript = '';
        }

        // --- Event Listeners ---
        ui.startWithNameBtn.addEventListener('click', () => {
            userName = ui.nameInput.value.trim();
            if (userName) {
                saveProgress();
                ui.nameEntryContainer.classList.add('hidden');
                ui.userNameDisplay.textContent = userName;
                ui.topicSelectionContainer.classList.remove('hidden');
            } else {
                const nameError = document.createElement('div');
                nameError.textContent = "Please enter your name.";
                nameError.className = "text-red-500 text-sm mt-2";
                ui.startWithNameBtn.insertAdjacentElement('afterend', nameError);
                setTimeout(() => nameError.remove(), 2000);
            }
        });

        ui.recordBtn.addEventListener('click', startRecording);
        ui.stopRecordBtn.addEventListener('click', stopRecording);
        
        ui.downloadCertificateBtn.addEventListener('click', () => {
          const certificateNode = document.getElementById('certificate-to-download');
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const newTab = isIOS ? window.open() : null;

          html2canvas(certificateNode, { scale: 2 }).then(canvas => {
            canvas.toBlob(blob => {
              const url = URL.createObjectURL(blob);
              if (isIOS && newTab) {
                newTab.location = url;
              } else {
                const a = document.createElement('a');
                a.href = url;
                a.download = `Certificate_of_Completion_03_${userName.replace(/\s+/g, '_')}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
              }
              URL.revokeObjectURL(url);
            });
          });
        });

        ui.backToMainMenuBtn.addEventListener('click', () => {
            ui.certificateScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            initializeTopics();
        });

        ui.downloadBtn.addEventListener('click', () => {
            let downloaded = false;
            // Download audio
            if (recordedBlob) {
                const topicName = currentQuestions[currentQuestionIndex].topicName.replace(/\s+/g, '_');
                const sanitizedUserName = userName.replace(/\s+/g, '_');
                const fileNameAudio = `P3_${sanitizedUserName}_${topicName}_Q${currentQuestionIndex + 1}.webm`;
                const blobUrl = URL.createObjectURL(recordedBlob);
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                a.download = fileNameAudio;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(blobUrl);
                downloaded = true;
            }

            // Download transcript
            if (finalTranscript) {
                const topicName = currentQuestions[currentQuestionIndex].topicName.replace(/\s+/g, '_');
                const sanitizedUserName = userName.replace(/\s+/g, '_');
                const fileNameTxt = `P3_${sanitizedUserName}_${topicName}_Q${currentQuestionIndex + 1}.txt`;
                const textBlob = new Blob([finalTranscript.trim()], { type: 'text/plain' });
                const textUrl = URL.createObjectURL(textBlob);

                const aTxt = document.createElement('a');
                aTxt.style.display = 'none';
                aTxt.href = textUrl;
                aTxt.download = fileNameTxt;
                document.body.appendChild(aTxt);
                aTxt.click();
                document.body.removeChild(aTxt);
                URL.revokeObjectURL(textUrl);
                downloaded = true;
            }

            if (downloaded) {
                const originalText = ui.downloadBtn.innerHTML;
                ui.downloadBtn.innerHTML = `<i class="fas fa-check mr-1"></i>Downloaded!`;
                ui.downloadBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                ui.downloadBtn.classList.add('bg-green-600');
                setTimeout(() => {
                    ui.downloadBtn.innerHTML = originalText;
                    ui.downloadBtn.classList.remove('bg-green-600');
                    ui.downloadBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
            }
        });

        ui.nextBtn.addEventListener('click', () => {
            ui.nextBtn.disabled = true;
            currentQuestionIndex++;
            showQuestion();
        });

        ui.backToTopicsBtn.addEventListener('click', () => {
            showConfirmationModal(
                'Return to Topics?',
                'Are you sure? This will stop your current practice session and any recording will be lost.',
                () => {
                    ui.practiceScreen.classList.add('hidden');
                    ui.welcomeScreen.classList.remove('hidden');
                    clearInterval(timerInterval);
                    if (synth && synth.speaking) synth.cancel();
                    if (mediaRecorder && mediaRecorder.state === 'recording') stopRecording();
                    initializeTopics();
                }
            );
        });

        ui.samplesBtn.addEventListener('click', () => {
            if (!ui.samplesContainer.classList.contains('hidden')) {
                ui.samplesContainer.classList.add('hidden');
                return;
            }

            const currentTopicName = masterQuestionList[currentQuestionIndex].topicName;
            const questionsForCurrentTopic = practiceData[currentTopicName];

            ui.samplesList.innerHTML = ''; 
            questionsForCurrentTopic.forEach((questionItem, index) => {
                const questionHeader = document.createElement('h4');
                questionHeader.textContent = `Q${index + 1}: ${questionItem.question}`;
                questionHeader.className = 'font-bold text-white text-sm mt-2 first:mt-0';
                ui.samplesList.appendChild(questionHeader);

                if (questionItem.samples && questionItem.samples.length > 0) {
                    questionItem.samples.forEach(sample => {
                        const li = document.createElement('li');
                        li.textContent = `\u2022 ${sample}`;
                        li.className = 'text-white text-sm sm:text-base ml-2';
                        ui.samplesList.appendChild(li);
                    });
                }
            });
            ui.samplesContainer.classList.remove('hidden');
        });
        
        // --- Initial Load ---
        async function main() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !SpeechRecognition) {
                ui.recordBtn.disabled = true;
                ui.recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                ui.recordBtn.title = "Audio recording or recognition is not supported on this browser.";
            }
            if (!window.speechSynthesis) {
                 console.warn("Text-to-speech is not supported on this browser.");
            }
            
            await initializeTTS().catch(err => console.error(err));
            
            createMasterList();
            loadProgress();
            initializeTopics();
        }
        
        main();

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (isIOS) {
            const sharepointLink = document.getElementById('sharepoint-upload-link');
            if (sharepointLink) {
                sharepointLink.removeAttribute('target');
            }
        }
    });
    </script>
</body>
</html>
