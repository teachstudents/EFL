<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>IELTS Speaking Practice (Grade 11 Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            position: relative;
            background-color: #ffffff;
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(147, 51, 234, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); }
        }
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d8b4fe; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9333ea; }

        /* --- iOS Audio Player Patches --- */
        audio::-webkit-media-controls-panel { padding: 5px; }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display { margin: 0 2px; }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            top: 30px;
            transform: translateX(-50%);
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            top: 50px;
        }
        #toast.success {
            background-color: #16a34a; /* Green */
        }
    </style>
</head>
<body class="text-gray-900 flex items-center justify-center p-2 sm:p-4">
    
    <!-- Toast Notification -->
    <div id="toast"><i class="fas fa-check-circle mr-2"></i>File Auto-Downloaded!</div>

    <div id="app-container" class="w-full max-w-xl mx-auto text-center h-full z-10 relative">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-white p-6 sm:p-8 rounded-2xl border-2 border-purple-100 shadow-xl h-full flex flex-col justify-center">
            <div id="name-entry-container">
                <div class="mb-6">
                    <i class="fas fa-graduation-cap text-6xl text-purple-600 mb-2"></i>
                    <h1 class="text-3xl font-bold text-purple-700 mb-2">IELTS Speaking</h1>
                    <p class="text-gray-500">Grade 11 Intensive Practice</p>
                </div>
                <input type="text" id="name-input" placeholder="Enter Your English Name" class="w-full px-4 py-3 border-2 border-gray-200 focus:border-purple-500 rounded-lg mb-4 text-center text-lg text-gray-900 outline-none transition-colors">
                <button id="start-with-name-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md transition-all">Start Practice</button>
            </div>
            <div id="topic-selection-container" class="hidden flex flex-col h-full">
                 <h1 class="text-2xl font-bold text-purple-700 mb-2 flex-shrink-0">Welcome, <span id="user-name-display"></span>!</h1>
                 
                 <div id="instructions" class="text-sm text-gray-700 mb-3 text-left space-y-2 p-3 bg-green-50 border border-green-200 rounded-lg flex-shrink-0">
                      <p><i class="fas fa-clock mr-2 text-purple-500"></i><strong>Part 1:</strong> 45s | <strong>Part 2:</strong> 2m | <strong>Part 3:</strong> 1m</p>
                      <p><i class="fas fa-microphone mr-2 text-purple-500"></i>Recordings <strong>auto-download</strong> on stop.</p>
                      <p><i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Use the <strong>Sample</strong> button if you get stuck.</p>
                 </div>

                <div class="flex-grow overflow-y-auto">
                    <div id="topic-selection" class="grid grid-cols-1 gap-3 pb-4">
                        <!-- Topic buttons injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden bg-white rounded-2xl shadow-xl border border-gray-200 app-shell p-3 sm:p-4 relative">
            <header class="flex-shrink-0 border-b border-gray-100 pb-2">
                <div class="flex justify-between items-center mb-2">
                    <div class="w-1/3 text-left">
                         <button id="back-to-topics-btn" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 font-semibold py-1 px-3 rounded-lg transition-colors">
                             <i class="fas fa-arrow-left mr-2"></i>Exit
                         </button>
                    </div>
                    <div class="w-1/3 text-center">
                         <span id="part-badge" class="text-xs font-bold px-2 py-1 rounded text-white bg-purple-600 uppercase tracking-wide">PART 1</span>
                    </div>
                    <div class="w-1/3 text-right">
                         <button id="next-btn" class="text-sm bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg shadow-sm">
                             Next <i class="fas fa-arrow-right ml-1"></i>
                         </button>
                    </div>
                </div>

                <!-- Timer Display -->
                <div class="relative w-20 h-20 mx-auto mb-1 flex-shrink-0">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-100" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="timer-progress" class="timer-circle text-green-500" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-2xl font-bold text-gray-800"></div>
                    
                    <!-- Pause Button -->
                    <button id="pause-resume-btn" class="hidden absolute bottom-0 right-0 w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-sm shadow-md z-20 hover:bg-gray-300 text-gray-700 transition-colors" title="Pause Timer">
                        <i class="fas fa-pause"></i>
                    </button>
                    
                    <!-- Reset Timer Button -->
                    <button id="reset-timer-btn" class="hidden absolute top-0 right-0 w-6 h-6 bg-red-100 rounded-full flex items-center justify-center text-xs shadow-sm z-20 hover:bg-red-200 text-red-600 transition-colors" title="Reset Timer">
                        <i class="fas fa-redo-alt"></i>
                    </button>
                </div>
            </header>
            
            <main class="flex-grow flex flex-col overflow-y-auto min-h-0 space-y-3 pt-2">
                <!-- Question Display -->
                <div id="question-container" class="flex flex-col items-center justify-center py-2 min-h-[60px]">
                    <h2 id="question-text" class="text-lg sm:text-xl font-medium leading-snug text-gray-900 text-center mb-2"></h2>
                    <!-- Sample Answer Button -->
                    <button id="toggle-sample-btn" class="text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-semibold py-1 px-3 rounded-full border border-yellow-300 shadow-sm transition-colors flex items-center">
                        <i class="fas fa-lightbulb mr-1 text-yellow-600"></i> Show Sample
                    </button>
                </div>

                <!-- Sample Answer Display (Hidden by default) -->
                <div id="sample-display" class="hidden bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-sm text-gray-800 leading-relaxed relative">
                    <button id="speak-sample-btn" class="absolute top-2 right-2 text-yellow-600 hover:text-yellow-800" title="Listen to Sample">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <p id="sample-text"></p>
                </div>

                <div id="error-message-box" class="hidden text-red-600 bg-red-50 p-2 rounded-lg text-sm border border-red-200 font-medium text-center"></div>

                <!-- Recording Controls -->
                <div id="recording-actions-container" class="flex flex-col items-center justify-center">
                    <button id="record-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold w-16 h-16 rounded-full text-2xl shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center focus:ring-4 focus:ring-purple-300">
                        <i class="fas fa-microphone"></i>
                    </button>
                    
                    <button id="stop-record-btn" class="hidden bg-gray-800 hover:bg-gray-900 text-white font-bold w-16 h-16 rounded-full text-2xl shadow-lg flex items-center justify-center recording-indicator">
                        <i class="fas fa-stop"></i>
                    </button>

                    <div id="recording-status" class="hidden mt-2 text-purple-600 font-semibold text-sm animate-pulse">
                        Recording...
                    </div>

                    <!-- Post-Recording Controls -->
                    <div id="post-recording-actions" class="hidden w-full flex-col items-center justify-center space-y-3 mt-2">
                        <div class="text-xs text-green-600 font-bold bg-green-50 px-3 py-1 rounded-full">
                            <i class="fas fa-check mr-1"></i> File Saved to Downloads
                        </div>
                        <audio id="audio-player" controls class="w-full max-w-xs h-10"></audio>
                        <div class="flex gap-2 w-full max-w-xs">
                             <a id="sharepoint-upload-link" href="https://xichengacademy-my.sharepoint.com/:f:/g/personal/joelmitchell_xichengacademy_cn/EjxMFg8-baNEo5uuWUBc4EoBzn1DVWJ1Ym_NFx6hPlJ0dQ" target="_blank" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm shadow-md transition-all flex items-center justify-center">
                                 <i class="fas fa-cloud-upload-alt mr-2"></i>Upload Folder
                            </a>
                        </div>
                        <p class="text-xs text-gray-400">(Check your Downloads folder if it didn't pop up)</p>
                    </div>
                </div>

                <!-- Scaffolding Tools -->
                <div class="space-y-3 pb-4 flex flex-col">
                    
                    <!-- Sentence Patterns (Templates) - Moved to TOP -->
                    <div id="starters-container" class="hidden text-left bg-purple-50 p-3 rounded-xl border border-purple-100 order-1">
                        <h3 class="text-xs font-bold text-purple-800 uppercase tracking-wider mb-2 text-center"><i class="fas fa-layer-group mr-1"></i> Answer Template</h3>
                        <div id="starters-list" class="flex flex-wrap gap-2 justify-center"></div>
                    </div>

                    <!-- Word Bank - Moved BELOW Templates -->
                    <div id="word-bank-container" class="hidden text-left bg-green-50 p-3 rounded-xl border border-green-100 order-2">
                        <h3 class="text-xs font-bold text-green-800 uppercase tracking-wider mb-2 text-center"><i class="fas fa-book mr-1"></i> Vocabulary</h3>
                        <div id="word-bank-list" class="flex flex-wrap gap-2 justify-center"></div>
                    </div>

                </div>
            </main>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-purple-100 h-full flex flex-col justify-center items-center">
            <div id="certificate-to-download" class="w-full bg-white p-8 rounded-lg border-4 border-purple-600 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-4 bg-purple-600"></div>
                <i class="fas fa-medal text-6xl text-yellow-400 mb-4 filter drop-shadow-md"></i>
                <h1 class="text-3xl font-bold text-gray-900 uppercase tracking-widest">Certificate</h1>
                <p class="text-lg mt-2 text-gray-500 uppercase tracking-wide">Of Completion</p>
                <hr class="w-16 mx-auto border-purple-300 my-4">
                <p class="text-md text-gray-600">Proudly awarded to</p>
                <p id="certificate-name" class="text-3xl font-bold my-4 text-purple-700 font-serif italic"></p>
                <p class="text-md text-gray-600">For completing the Grade 11 IELTS Speaking Course</p>
                <p class="text-sm mt-8 text-gray-400">Date: <span id="certificate-date"></span></p>
                <div class="absolute bottom-0 left-0 w-full h-4 bg-purple-600"></div>
            </div>
            <button id="download-certificate-btn" class="mt-8 w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-md transition-all">
                <i class="fas fa-download mr-2"></i>Download Image
            </button>
             <button id="back-to-main-menu-btn" class="mt-4 text-sm text-purple-600 hover:text-purple-800 font-semibold">Back to Menu</button>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 text-center max-w-sm w-full border border-gray-200">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
            </div>
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-2">Are you sure?</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Progress for this week will not be saved.</p>
            <div class="flex justify-center gap-3">
                <button id="modal-cancel-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                <button id="modal-confirm-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Exit</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- IELTS SYLLABUS DATA (Grade 11 China Edition with Samples) ---
        const practiceData = {
            "AI & Technology": [
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Do you use any AI tools in your daily life? Why or why not?", 
                    starters: ["Well, to be honest...", "I use translation apps like Youdao...", "For checking my grammar, I rely on...", "Actually, I try to avoid AI for homework because...", "It helps me scan text efficiently..."], 
                    wordBank: ["translation app", "scan", "efficient", "accuracy", "homework assistant", "improve vocabulary", "check grammar", "time-saving"],
                    sample: "Well, to be honest, I use AI tools quite often, especially dictionary apps like Youdao. They are incredibly efficient for scanning English texts and getting instant translations, which helps me with my reading assignments."
                },
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Is there any technology you find difficult to use?", 
                    starters: ["To put it simply...", "I find complex coding software...", "Setting up a VPN can be...", "Sometimes, specialized editing software is...", "Personally, I struggle with..."], 
                    wordBank: ["complicated", "interface", "firewall", "connection issues", "technical skills", "user-friendly", "frustrating", "software"],
                    sample: "To put it simply, I find video editing software a bit challenging. The interface is often complicated with too many buttons and timelines, so it takes me a long time to learn how to produce a simple video for a school project."
                },
                { 
                    part: 2, 
                    timer: 120, 
                    question: "Describe a piece of technology you use that helps you study or work.", 
                    starters: ["I'd like to talk about my iPad...", "The device I rely on is...", "It is indispensable because...", "I primarily use it for taking notes...", "What makes it special is the 'GoodNotes' app...", "Without it, my backpack would be heavy..."], 
                    wordBank: ["tablet", "stylus", "digital notes", "organize", "portable", "resources", "paperless", "efficiency", "multitasking"],
                    sample: "I'd like to talk about my iPad. It is indispensable because I use it for all my classes. Instead of carrying heavy textbooks, I store everything digitally. I use a stylus to take handwritten notes in apps like GoodNotes, which helps me organize my chemistry and math equations perfectly."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "How do you think AI will change education in Chinese high schools?", 
                    starters: ["That’s an interesting question...", "I believe it will personalize learning...", "It might help teachers grade papers...", "Consequently, students might rely less on...", "Ideally, it would provide customized exercises for Gaokao prep..."], 
                    wordBank: ["Gaokao preparation", "personalized learning", "grading", "efficiency", "reduce workload", "adaptive", "virtual tutor", "fairness"],
                    sample: "That's an interesting question. I believe AI will revolutionize Gaokao preparation. It can analyze a student's weak points and generate customized math or physics problems to solve, which makes studying much more efficient than just doing random past papers."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "Do you think students rely too much on technology these days?", 
                    starters: ["In my opinion...", "Undoubtedly, because...", "On the other hand, it aids learning...", "Many students search for answers online instead of...", "The downside is that we write less by hand...", "We are becoming overly dependent on..."], 
                    wordBank: ["critical thinking", "search engines", "copying", "handwriting", "distraction", "mobile games", "self-discipline", "instant answers"],
                    sample: "In my opinion, yes. Many students instantly search for answers on their phones instead of thinking through difficult math problems themselves. This reliance hinders our critical thinking skills and makes us lazy learners."
                }
            ],
            "The Environment": [
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Are there many wild animals in your city or hometown?", 
                    starters: ["I’ve never thought about that before, but...", "Since I live in a big city like Beijing...", "We mostly see stray cats and...", "In the parks, you can find birds like...", "Sadly, rapid urbanization has..."], 
                    wordBank: ["urbanization", "stray cats", "magpies", "sparrows", "concrete jungle", "parks", "rare", "habitat"],
                    sample: "Since I live in a concrete jungle like Shanghai, we don't see many wild animals. Mostly, I see stray cats in my community and common birds like sparrows or magpies in the school playground."
                },
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Do you take any steps to protect the environment at school?", 
                    starters: ["Another point worth mentioning is...", "I try to sort my trash...", "Our school encourages us to...", "I use a reusable water bottle...", "We have a policy to turn off lights..."], 
                    wordBank: ["garbage sorting", "recycling bins", "conserve energy", "reusable bottle", "plastic waste", "cafeteria", "electricity", "awareness"],
                    sample: "Yes, I try my best. In our classroom, we have strict rules about garbage sorting, so I always separate my paper waste from other trash. Also, I bring a reusable water bottle to school every day to avoid buying plastic bottles."
                },
                { 
                    part: 2, 
                    timer: 120, 
                    question: "Describe an environmental problem in your country.", 
                    starters: ["In addition to that...", "I want to describe air pollution...", "It typically happens in winter...", "The main cause is industrial emissions and...", "It affects our daily life because...", "On smoggy days, we have to wear masks..."], 
                    wordBank: ["smog", "air quality", "PM2.5", "industrial emissions", "vehicle exhaust", "health hazard", "mask", "visibility", "regulations"],
                    sample: "I want to describe air pollution, specifically smog. It used to be a major issue in northern cities during winter due to heating systems and vehicle exhaust. On bad days, the visibility is low, and we can't do outdoor PE classes, which is really frustrating for us students."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "Why do you think some young people are not interested in environmental protection?", 
                    starters: ["It could be because...", "Perhaps they are too busy with...", "They might think it's the government's job...", "The pressure of schoolwork distracts them...", "They lack awareness about..."], 
                    wordBank: ["academic pressure", "convenience", "apathy", "responsibility", "immediate concerns", "long-term", "education", "lifestyle"],
                    sample: "It could be because they are overwhelmed with academic pressure. Grade 11 students are so focused on getting good grades that they feel they don't have the time or energy to worry about sorting trash or volunteering for environmental causes."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "Should the government ban single-use plastics completely?", 
                    starters: ["I strongly believe that...", "Compared to recycling, banning is...", "It might be inconvenient at first...", "From my point of view, it's necessary...", "However, we need alternatives like..."], 
                    wordBank: ["ban", "biodegradable", "alternatives", "pollution", "ocean life", "inconvenience", "habit", "policy"],
                    sample: "I strongly believe that they should. Plastic pollution is ruining our landscapes. Although it might be inconvenient for buying bubble tea or takeout food at first, developing biodegradable alternatives is necessary for the planet's future."
                }
            ],
            "Modern Accommodation": [
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Do you live in a house or an apartment?", 
                    starters: ["Well, to be honest...", "I live in a high-rise apartment...", "My family lives in a gated community...", "It's on the 15th floor...", "It's quite typical for families in my city..."], 
                    wordBank: ["high-rise", "gated community", "elevator", "floor", "balcony", "security", "urban", "neighbors"],
                    sample: "I live in a high-rise apartment complex on the 12th floor. It's quite typical for families in Chinese cities. We have a nice view of the neighborhood, and the community is gated with security guards."
                },
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Which room do you spend the most time in?", 
                    starters: ["What I mean is...", "I spend nearly all my time in my bedroom...", "Since I have so much homework...", "My bedroom doubles as my study...", "I rarely go to the living room because..."], 
                    wordBank: ["bedroom", "study desk", "homework", "privacy", "concentrate", "relax", "bookshelf", "personal space"],
                    sample: "I spend nearly all my time in my bedroom because that's where my desk is. Between homework and online classes, I'm sitting there for hours every evening. It's my personal space where I can concentrate without distractions."
                },
                { 
                    part: 2, 
                    timer: 120, 
                    question: "Describe a house or apartment you would like to live in.", 
                    starters: ["What's more...", "Ideally, I would like to live in a spacious...", "It would be located near a park...", "I dream of having a large balcony...", "The interior would be modern and minimalist...", "I'd love a gaming room..."], 
                    wordBank: ["spacious", "minimalist", "floor-to-ceiling windows", "view", "quiet", "location", "modern", "amenities", "dream home"],
                    sample: "Ideally, I would like to live in a modern apartment with floor-to-ceiling windows overlooking a park. I dream of having a large balcony where I can study outside in the fresh air. The interior would be minimalist, with plenty of space for my books and a gaming setup."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "What are the advantages of living in a school dormitory?", 
                    starters: ["On the one hand...", "It saves a lot of travel time...", "Living with classmates helps build...", "You learn to be independent...", "However, it can be noisy..."], 
                    wordBank: ["independence", "friendship", "commute", "social skills", "noisy", "privacy", "convenient", "self-discipline"],
                    sample: "On the one hand, living in a dormitory saves a huge amount of travel time, which means more sleep. It also helps you build strong friendships with your classmates and teaches you how to live independently away from your parents."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "How have housing designs in China changed over the last 20 years?", 
                    starters: ["Compared to the past...", "Nowadays, buildings are much taller...", "There is more focus on green spaces...", "Apartments are more modern but expensive...", "We use smart home technology now..."], 
                    wordBank: ["skyscrapers", "modern facilities", "greenery", "expensive", "urban planning", "smart home", " elevator", "community"],
                    sample: "Compared to twenty years ago, residential buildings are much taller and denser. Nowadays, new compounds focus more on landscaping and greenery. Also, apartments are designed with modern amenities like floor heating and smart locks, which weren't common before."
                }
            ],
            "Travel & Transport": [
                { 
                    part: 1, 
                    timer: 45, 
                    question: "How do you usually go to school?", 
                    starters: ["To put it simply...", "I usually take the subway...", "My parents drive me...", "I ride a shared bike...", "It takes about 30 minutes by bus...", "I live in the dorms, so I walk..."], 
                    wordBank: ["subway", "rush hour", "convenient", "traffic jam", "electric bike", "parents' car", "dormitory", "commute"],
                    sample: "I usually take the subway. It's very reliable and I don't have to worry about traffic jams during rush hour. It takes me about 40 minutes from my home to the school gate."
                },
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Do you prefer taking the high-speed train or flying?", 
                    starters: ["Compared to flying...", "I prefer the high-speed train...", "Trains are more punctual...", "Flying is faster for long distances...", "The train stations are closer to the city..."], 
                    wordBank: ["high-speed rail", "Gaotie", "punctual", "legroom", "security check", "convenient", "scenery", "expensive"],
                    sample: "I prefer the high-speed train, or Gaotie. It's much more comfortable than flying because there is more legroom and you can use your phone the whole time. Also, train stations are usually in the city, unlike airports which are far away."
                },
                { 
                    part: 2, 
                    timer: 120, 
                    question: "Describe a trip you took during a school holiday.", 
                    starters: ["So, to sum up...", "I went to Chengdu during the summer...", "I traveled with my parents...", "We visited the Panda Base...", "The food was incredibly spicy...", "It was a relief after exams..."], 
                    wordBank: ["summer vacation", "tourist attraction", "local cuisine", "hotpot", "relaxing", "crowded", "memorable", "souvenirs", "scenery"],
                    sample: "I went to Chengdu during the summer vacation with my parents. We visited the Research Base to see the giant pandas, which were adorable. The highlight was definitely the food; we ate authentic hotpot which was incredibly spicy but delicious. It was a great way to relax after my final exams."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "How can the government solve traffic congestion in big cities?", 
                    starters: ["Perhaps it’s due to...", "They could expand the subway lines...", "Limiting car license plates is one way...", "Promoting shared bikes...", "Improving bus lanes might help..."], 
                    wordBank: ["public transport", "license plate restriction", "infrastructure", "congestion", "subway network", "encourage", "rush hour", "traffic lights"],
                    sample: "They could continue expanding the subway network to cover more suburbs. Also, promoting green transport like shared bikes for the 'last mile' helps reduce the number of cars on the road. License plate restrictions are annoying, but they do help reduce traffic."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "Do you think people will travel virtually in the future?", 
                    starters: ["I don’t know much about that, but I imagine...", "VR technology could allow us to...", "It’s not the same as real travel...", "Maybe for education, but not for vacation...", "It might save money..."], 
                    wordBank: ["virtual reality", "VR headset", "immersive", "authentic experience", "smell and taste", "culture", "cost-effective", "education"],
                    sample: "I don't think it will replace real travel. VR technology can show us the sights, but it can't replicate the smell of the air, the taste of local food, or the feeling of meeting new people. It might be good for history class, but not for a holiday."
                }
            ],
            "Education & Work": [
                { 
                    part: 1, 
                    timer: 45, 
                    question: "What is your favorite subject in high school?", 
                    starters: ["Well, to be honest...", "I really enjoy English because...", "Math is challenging but satisfying...", "I prefer Physics as it explains...", "History is fascinating...", "I'm an arts student, so I like..."], 
                    wordBank: ["challenging", "logic", "vocabulary", "formulas", "history", "literature", "science", "humanities"],
                    sample: "I really enjoy English. It gives me access to Western culture, movies, and music. Plus, it's a nice break from all the formulas and calculations I have to do in Math and Physics classes."
                },
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Do you prefer studying in the library or at home?", 
                    starters: ["In other words...", "I prefer the library because...", "It's too noisy at home...", "The atmosphere in the library is...", "I study better in the classroom during evening self-study..."], 
                    wordBank: ["atmosphere", "distractions", "focused", "quiet", "resources", "productive", "self-study", "environment"],
                    sample: "I prefer studying in the school library or during evening self-study. At home, there are too many distractions like my phone or snacks. In the library, everyone else is working hard, which motivates me to focus."
                },
                { 
                    part: 2, 
                    timer: 120, 
                    question: "Describe a future plan you have for your studies.", 
                    starters: ["Overall, I would say...", "I plan to study abroad in...", "My goal is to get into a good university...", "I want to major in Computer Science...", "I am preparing for the IELTS to...", "It has been my dream to..."], 
                    wordBank: ["study abroad", "university", "major", "IELTS score", "ambition", "career path", "application", "scholarship", "dream"],
                    sample: "I plan to study abroad in the UK after I graduate high school. My goal is to major in Computer Science because I'm really interested in AI. Currently, I'm working hard to get a band 7 in IELTS so I can apply to top universities like Manchester or Edinburgh."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "Is the Gaokao the only way to succeed in China?", 
                    starters: ["I strongly believe that...", "It used to be, but now...", "Studying abroad is another option...", "Vocational schools are also important...", "Success can be defined in many ways...", "However, it is still the most fair path..."], 
                    wordBank: ["university entrance exam", "pathway", "vocational skills", "overseas study", "pressure", "opportunity", "success", "alternative"],
                    sample: "It used to be the only way, but now there are alternatives. Many students choose to study abroad or go to vocational colleges to learn specific skills. However, for most families, the Gaokao is still seen as the fairest and most direct path to a stable career."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "Should schools focus more on grades or practical skills?", 
                    starters: ["On the one hand… on the other hand...", "Grades are important for university...", "But skills like cooking and driving...", "We need a balance...", "Currently, there is too much focus on scores..."], 
                    wordBank: ["academic performance", "life skills", "balance", "well-rounded", "pressure", "future career", "independence", "holistic education"],
                    sample: "I think we need a balance. Grades are important for getting into university, but practical skills like cooking, driving, or communication are vital for surviving in the real world. Right now, I think we focus too much on test scores."
                }
            ],
            "Money & Consumerism": [
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Do you use cash or mobile payments?", 
                    starters: ["To put it simply...", "I almost exclusively use WeChat Pay...", "I use Alipay for everything...", "I haven't carried a wallet in years...", "It's just so convenient to scan a QR code..."], 
                    wordBank: ["WeChat Pay", "Alipay", "scan", "QR code", "convenient", "cashless", "wallet", "digital"],
                    sample: "I almost exclusively use WeChat Pay. I haven't carried a physical wallet in years. Whether I'm buying a snack at the school convenience store or paying for a shared bike, scanning a QR code is just so much faster."
                },
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Do you buy things on Taobao or JD?", 
                    starters: ["Compared to...", "I buy all my clothes on Taobao...", "JD is faster for electronics...", "I prefer online shopping because...", "My parents help me buy things..."], 
                    wordBank: ["online shopping", "delivery", "delivery speed", "variety", "price comparison", "livestream sales", "return policy", "convenience"],
                    sample: "I use Taobao for clothes because there's so much variety and it's cheap. But for electronics or books, I prefer JD because the delivery is incredibly fast—sometimes it arrives the same day I order it."
                },
                { 
                    part: 2, 
                    timer: 120, 
                    question: "Describe something special you bought with your own money.", 
                    starters: ["In addition to that...", "I bought a pair of sneakers...", "I saved my Red Envelope money...", "It was a limited edition...", "I felt really proud because...", "I use it for playing basketball..."], 
                    wordBank: ["Red Envelope (Hongbao)", "savings", "limited edition", "reward", "sneakers", "headphones", "proud", "expensive"],
                    sample: "I bought a pair of limited edition basketball sneakers. I saved up my Red Envelope money from Spring Festival for two years to afford them. I felt really proud when I finally bought them, and I only wear them for important matches."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "Do young people spend too much money on brands?", 
                    starters: ["That’s a tough question...", "Some do, to show off...", "Social media influences us...", "They think expensive means better...", "However, many students are frugal...", "It's about peer pressure..."], 
                    wordBank: ["status symbol", "peer pressure", "trends", "materialism", "show off", "quality", "influencers", "social media"],
                    sample: "I think some do, largely due to peer pressure and social media. When they see influencers wearing expensive brands on Douyin, they feel they need them too to fit in. It becomes a status symbol rather than about the quality of the product."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "Is it important to learn how to manage money at a young age?", 
                    starters: ["I strongly believe that...", "Yes, because university life requires...", "We need to learn budgeting...", "Many students run out of money...", "It prevents financial trouble later..."], 
                    wordBank: ["budgeting", "allowance", "financial independence", "saving", "wasteful", "future", "responsibility", "value of money"],
                    sample: "I strongly believe so. When we go to university, we will have to manage our own living expenses. If we don't learn how to budget our allowance now, we might end up spending all our money on games or food in the first week of the month."
                }
            ],
            "Social Media & News": [
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Which social media app do you use the most?", 
                    starters: ["Well, to be honest...", "I use WeChat constantly for...", "I spend too much time on Douyin...", "Bilibili is my favorite for...", "I use Xiaohongshu to find..."], 
                    wordBank: ["WeChat", "Douyin", "Bilibili", "communicate", "scroll", "videos", "addictive", "reviews"],
                    sample: "I use WeChat constantly. It's not just for chatting; I use it to pay for things, look at my friends' Moments, and read articles from official accounts. It's basically essential for daily life in China."
                },
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Do you share photos of your food or life online?", 
                    starters: ["In other words...", "I sometimes post on my Moments...", "Only when I go somewhere special...", "I prefer to keep things private...", "I like getting likes from friends..."], 
                    wordBank: ["Moments (Pengyouquan)", "post", "share", "private", "special occasion", "memories", "likes", "filters"],
                    sample: "I sometimes post on my WeChat Moments, but only when I go somewhere special or eat a really nice meal. I don't post every day because I prefer to keep my daily life private."
                },
                { 
                    part: 2, 
                    timer: 120, 
                    question: "Describe a piece of news you read on social media.", 
                    starters: ["What's more...", "I saw a video on Douyin about...", "It was about the Asian Games...", "I read an article on Weibo...", "It made me feel excited because...", "Everyone in my class was talking about it..."], 
                    wordBank: ["trending topic", "viral", "notification", "official account", "sports event", "achievement", "discussion", "comment section"],
                    sample: "I saw a news video on Douyin about the Asian Games in Hangzhou. It showed the opening ceremony and the digital fireworks. I felt really excited and proud because it looked so high-tech and futuristic, and everyone in my class was talking about it the next day."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "Is social media a reliable source of news?", 
                    starters: ["I’m not entirely sure, but I guess...", "Not always, there are rumors...", "Official accounts are reliable...", "We need to verify information...", "Clickbait is a big problem..."], 
                    wordBank: ["reliable", "fake news", "rumors", "official sources", "clickbait", "verify", "sensational", "trustworthy"],
                    sample: "Not always. While official accounts from news agencies are reliable, there are also a lot of rumors and fake news spread by individuals just to get views. We need to be careful and check if the information comes from a trustworthy source."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "How does social media affect friendships?", 
                    starters: ["Compared to...", "It helps us stay in touch...", "However, it can be superficial...", "We chat online but meet less...", "It allows us to see what friends are doing..."], 
                    wordBank: ["stay in touch", "connection", "superficial", "face-to-face", "distance", "interaction", "bond", "misunderstanding"],
                    sample: "It helps us stay in touch, especially with friends who have moved to different schools. However, chatting on WeChat isn't the same as hanging out in person. sometimes, it can make friendships feel a bit superficial if we never actually meet up."
                }
            ],
            "Celebrations & Culture": [
                { 
                    part: 1, 
                    timer: 45, 
                    question: "What do you usually do during the Spring Festival?", 
                    starters: ["Well, to be honest...", "We have a big family reunion dinner...", "I get Red Envelopes from...", "We watch the CCTV Gala...", "We visit my grandparents in..."], 
                    wordBank: ["reunion dinner", "Red Envelopes", "fireworks", "dumplings", "grandparents", "tradition", "Spring Festival Gala", "visit relatives"],
                    sample: "We always have a huge family reunion dinner at my grandparents' house. We make dumplings together, watch the Spring Festival Gala on TV, and of course, the best part is getting Red Envelopes from my older relatives."
                },
                { 
                    part: 1, 
                    timer: 45, 
                    question: "Do you prefer traditional festivals or Western festivals?", 
                    starters: ["From my point of view...", "I prefer traditional ones because...", "Christmas is fun for shopping...", "Traditional festivals have more meaning...", "I like the food during Chinese festivals..."], 
                    wordBank: ["atmosphere", "cultural heritage", "commercial", "Christmas", "Dragon Boat Festival", "meaningful", "family time", "celebrate"],
                    sample: "I prefer traditional festivals like Mid-Autumn Festival because they are about family and food. Western festivals like Christmas are fun for shopping and hanging out with friends, but they don't have the same deep cultural meaning for me."
                },
                { 
                    part: 2, 
                    timer: 120, 
                    question: "Describe a traditional festival in China.", 
                    starters: ["In addition to that...", "I want to talk about the Dragon Boat Festival...", "It commemorates the poet Qu Yuan...", "We eat Zongzi (sticky rice dumplings)...", "There are dragon boat races...", "It happens in summer..."], 
                    wordBank: ["Dragon Boat Festival", "Zongzi", "Qu Yuan", "races", "commemorate", "sticky rice", "customs", "lunar calendar"],
                    sample: "I want to talk about the Dragon Boat Festival. It usually happens in June. We eat Zongzi, which are sticky rice dumplings wrapped in bamboo leaves, and watch dragon boat races on the river. It commemorates the ancient poet Qu Yuan, so it has a lot of historical significance."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "Why is it important for young people to learn about traditions?", 
                    starters: ["I strongly believe that...", "It connects us to our history...", "Without it, we lose our identity...", "It helps us understand our culture...", "We need to pass them down..."], 
                    wordBank: ["identity", "roots", "heritage", "cultural preservation", "ancestors", "values", "belonging", "history"],
                    sample: "I strongly believe it connects us to our roots. In a rapidly modernizing China, it's easy to forget where we came from. Learning about traditions gives us a sense of cultural identity and ensures these beautiful customs are passed down to the next generation."
                },
                { 
                    part: 3, 
                    timer: 60, 
                    question: "How are weddings in China changing?", 
                    starters: ["Compared to...", "They are becoming more Western...", "People wear white dresses now...", "Some prefer small destination weddings...", "The traditional tea ceremony is still...", "It's very expensive now..."], 
                    wordBank: ["Western-style", "white dress", "tea ceremony", "banquet", "modern", "expensive", "mix of styles", "destination wedding"],
                    sample: "They are becoming a mix of styles. Most brides now wear a white Western dress for the ceremony but change into a red Qipao for the toast. Also, weddings are becoming incredibly expensive and lavish, often held in huge hotel ballrooms."
                }
            ]
        };

        // --- DOM Elements ---
        const ui = {
            welcomeScreen: document.getElementById('welcome-screen'),
            practiceScreen: document.getElementById('practice-screen'),
            nameEntryContainer: document.getElementById('name-entry-container'),
            nameInput: document.getElementById('name-input'),
            startWithNameBtn: document.getElementById('start-with-name-btn'),
            topicSelectionContainer: document.getElementById('topic-selection-container'),
            userNameDisplay: document.getElementById('user-name-display'),
            topicSelection: document.getElementById('topic-selection'),
            nextBtn: document.getElementById('next-btn'),
            backToTopicsBtn: document.getElementById('back-to-topics-btn'),
            timerDisplay: document.getElementById('timer-display'),
            timerProgress: document.getElementById('timer-progress'),
            partBadge: document.getElementById('part-badge'),
            questionText: document.getElementById('question-text'),
            startersContainer: document.getElementById('starters-container'),
            startersList: document.getElementById('starters-list'),
            wordBankContainer: document.getElementById('word-bank-container'),
            wordBankList: document.getElementById('word-bank-list'),
            errorMessagebox: document.getElementById('error-message-box'),
            recordBtn: document.getElementById('record-btn'),
            stopRecordBtn: document.getElementById('stop-record-btn'),
            audioPlayer: document.getElementById('audio-player'),
            recordingStatus: document.getElementById('recording-status'),
            postRecordingActions: document.getElementById('post-recording-actions'),
            certificateScreen: document.getElementById('certificate-screen'),
            downloadCertificateBtn: document.getElementById('download-certificate-btn'),
            backToMainMenuBtn: document.getElementById('back-to-main-menu-btn'),
            modal: document.getElementById('confirmation-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
            pauseResumeBtn: document.getElementById('pause-resume-btn'),
            resetTimerBtn: document.getElementById('reset-timer-btn'),
            toast: document.getElementById('toast'),
            toggleSampleBtn: document.getElementById('toggle-sample-btn'),
            sampleDisplay: document.getElementById('sample-display'),
            sampleText: document.getElementById('sample-text'),
            speakSampleBtn: document.getElementById('speak-sample-btn')
        };

        // --- State Variables ---
        let userName = '';
        let currentTopicName = '';
        let currentQuestionIndex = 0;
        let currentQuestions = []; 
        let timerInterval;
        let isTimerPaused = false;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;
        let completedTopics = {};
        const FULL_DASH_ARRAY = 283;

        // --- Text-to-Speech (Emma Priority) ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;

        function initializeTTS() {
            return new Promise((resolve) => {
                if (!synth) return resolve();

                const setBestVoice = () => {
                    const voices = synth.getVoices();
                    if (voices.length === 0) return;
                    
                    // Priority: Emma (Microsoft) -> Samantha/Siri (Apple) -> Any English
                    let selected = voices.find(v => v.name.includes("Emma"));
                    
                    if (!selected) {
                         // Fallback to Apple Siri/Samantha
                         selected = voices.find(v => v.name.includes("Samantha") || v.name.includes("Siri"));
                    }
                    
                    if (!selected) {
                        // Fallback to Microsoft Edge Online voices if Emma wasn't exact match but available
                        selected = voices.find(v => v.name.includes("Microsoft") && v.lang.startsWith("en"));
                    }

                    if (!selected) {
                         selected = voices.find(v => v.lang.startsWith("en"));
                    }

                    preferredVoice = selected;
                    resolve();
                };

                if (synth.getVoices().length > 0) {
                    setBestVoice();
                } else {
                    synth.onvoiceschanged = setBestVoice;
                }
            });
        }

        function speak(text) {
            if (!synth || !text) return;
            if (synth.speaking) synth.cancel();
            setTimeout(() => {
                const utterThis = new SpeechSynthesisUtterance(text);
                if (preferredVoice) utterThis.voice = preferredVoice;
                // Slow down to 85% as requested
                utterThis.rate = 0.85; 
                synth.speak(utterThis);
            }, 100); 
        }

        // --- Toast Notification ---
        function showToast(message, type = 'success') {
            ui.toast.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
            ui.toast.className = 'show';
            if(type === 'success') ui.toast.classList.add('success');
            
            setTimeout(() => {
                ui.toast.className = ui.toast.className.replace('show', '');
            }, 3000);
        }

        // --- Auto Download Function ---
        function autoDownloadRecording(blob) {
            if (!blob) return;
            const a = document.createElement('a');
            
            // Sanitize filenames
            const safeUser = (userName || "Student").replace(/[^a-z0-9]/gi, '_');
            // Get topic string (now without week numbers)
            const safeTopic = currentTopicName.replace(/\s+/g, '');
            const qNum = currentQuestionIndex + 1;

            const filename = `${safeUser}_${safeTopic}_Q${qNum}.webm`;
            
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Show confirmation
            showToast(`Auto-saved: ${filename}`);
        }

        // --- Local Storage ---
        function loadProgress() {
            const saved = localStorage.getItem('ieltsWeek12to19_progress');
            if (saved) completedTopics = JSON.parse(saved);
            const savedName = localStorage.getItem('ieltsWeek12to19_name');
            if (savedName) {
                 userName = savedName;
                 ui.nameInput.value = userName;
            }
        }

        function saveProgress() {
            localStorage.setItem('ieltsWeek12to19_progress', JSON.stringify(completedTopics));
            if(userName) localStorage.setItem('ieltsWeek12to19_name', userName);
        }

        // --- UI Initialization ---
        function initializeTopics() {
            ui.topicSelection.innerHTML = '';
            for (const topic in practiceData) {
                const button = document.createElement('button');
                const isComplete = completedTopics[topic];
                
                button.className = `w-full p-4 rounded-xl shadow-sm border transition-all duration-200 flex items-center justify-between group ${isComplete ? 'bg-green-50 border-green-200 hover:bg-green-100' : 'bg-white border-gray-200 hover:border-purple-400 hover:shadow-md'}`;
                
                const iconClass = isComplete ? 'fa-check-circle text-green-500' : 'fa-chevron-right text-gray-300 group-hover:text-purple-500';
                
                button.innerHTML = `
                    <div class="text-left">
                        <span class="block text-sm font-bold ${isComplete ? 'text-green-800' : 'text-gray-800'}">${topic}</span>
                        <span class="text-xs text-gray-500">5 Questions • Part 1, 2 & 3</span>
                    </div>
                    <i class="fas ${iconClass} text-lg"></i>
                `;
                button.onclick = () => startPractice(topic);
                ui.topicSelection.appendChild(button);
            }
        }

        // --- Core Logic ---
        function startPractice(topic) {
            currentTopicName = topic;
            currentQuestions = practiceData[topic];
            currentQuestionIndex = 0;
            
            ui.welcomeScreen.classList.add('hidden');
            ui.practiceScreen.classList.remove('hidden');
            ui.nextBtn.classList.remove('hidden');
            
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                // Topic Complete
                completedTopics[currentTopicName] = true;
                saveProgress();
                ui.questionText.textContent = "Topic Complete! Well done.";
                ui.partBadge.textContent = "FINISH";
                ui.nextBtn.classList.add('hidden');
                ui.recordBtn.classList.add('hidden');
                ui.toggleSampleBtn.classList.add('hidden'); // Hide sample button
                showCertificate();
                return;
            }

            const item = currentQuestions[currentQuestionIndex];
            
            // UI Updates
            // ui.nextBtn.disabled = true; // User requested to enable Next button always
            ui.partBadge.textContent = `PART ${item.part}`;
            ui.partBadge.className = `text-xs font-bold px-2 py-1 rounded text-white uppercase tracking-wide ${item.part === 2 ? 'bg-pink-600' : 'bg-purple-600'}`;
            
            resetUIForNewQuestion();

            // Set Question Text & Speak
            ui.questionText.textContent = item.question;
            ui.questionText.classList.add('fade-in');
            setTimeout(() => ui.questionText.classList.remove('fade-in'), 500);
            speak(item.question);

            // Set Sample Text (but keep hidden)
            ui.sampleText.textContent = item.sample || "No sample available for this question.";

            // Inject Starters (Template)
            if (item.starters) {
                ui.startersList.innerHTML = '';
                item.starters.forEach(text => {
                    const btn = document.createElement('div');
                    btn.className = 'bg-white border border-purple-200 text-purple-700 text-xs font-medium px-3 py-1.5 rounded-full shadow-sm';
                    btn.textContent = text + "...";
                    ui.startersList.appendChild(btn);
                });
                ui.startersContainer.classList.remove('hidden');
            }

            // Inject Word Bank
            if (item.wordBank) {
                ui.wordBankList.innerHTML = '';
                item.wordBank.forEach(text => {
                    const btn = document.createElement('div');
                    btn.className = 'bg-white border border-green-200 text-green-700 text-xs font-medium px-3 py-1.5 rounded-full shadow-sm';
                    btn.textContent = text;
                    ui.wordBankList.appendChild(btn);
                });
                ui.wordBankContainer.classList.remove('hidden');
            }

            // Start Timer
            startTimer(item.timer);
        }

        function resetUIForNewQuestion() {
            ui.startersContainer.classList.add('hidden');
            ui.wordBankContainer.classList.add('hidden');
            ui.recordBtn.classList.remove('hidden', 'opacity-50', 'cursor-not-allowed');
            ui.recordBtn.disabled = false;
            ui.stopRecordBtn.classList.add('hidden');
            ui.recordingStatus.classList.add('hidden');
            ui.postRecordingActions.classList.add('hidden');
            ui.audioPlayer.src = '';
            isTimerPaused = false;
            ui.pauseResumeBtn.innerHTML = '<i class="fas fa-pause"></i>';
            ui.pauseResumeBtn.classList.remove('hidden');
            ui.resetTimerBtn.classList.remove('hidden');
            
            // Reset Sample UI
            ui.sampleDisplay.classList.add('hidden');
            ui.toggleSampleBtn.classList.remove('hidden');
            ui.toggleSampleBtn.innerHTML = '<i class="fas fa-lightbulb mr-1 text-yellow-600"></i> Show Sample';
        }

        // --- Timer Logic ---
        function startTimer(duration) {
            let timeLeft = duration;
            clearInterval(timerInterval);
            updateTimerUI(timeLeft, duration);

            timerInterval = setInterval(() => {
                if (!isTimerPaused) {
                    timeLeft--;
                    updateTimerUI(timeLeft, duration);
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        handleTimeUp();
                    }
                }
            }, 1000);
        }

        function resetTimer() {
            const item = currentQuestions[currentQuestionIndex];
            if (item) {
                isTimerPaused = false;
                ui.pauseResumeBtn.innerHTML = '<i class="fas fa-pause"></i>';
                // Re-enable record button if it was disabled by time-up
                if (ui.stopRecordBtn.classList.contains('hidden')) {
                    ui.recordBtn.disabled = false;
                    ui.recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                startTimer(item.timer);
            }
        }

        function updateTimerUI(timeLeft, total) {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            ui.timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            const fraction = timeLeft / total;
            const offset = fraction * FULL_DASH_ARRAY;
            ui.timerProgress.style.strokeDashoffset = FULL_DASH_ARRAY - offset;
            
            // Color change for urgency
            if (fraction < 0.2) ui.timerProgress.classList.replace('text-green-500', 'text-red-500');
            else ui.timerProgress.classList.replace('text-red-500', 'text-green-500');
        }

        function handleTimeUp() {
            if (mediaRecorder && mediaRecorder.state === 'recording') stopRecording();
            ui.recordBtn.disabled = true;
            ui.recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
            // ui.nextBtn.disabled = false; // Always enabled now
            ui.pauseResumeBtn.classList.add('hidden');
            ui.resetTimerBtn.classList.add('hidden');
        }

        function togglePauseTimer() {
            isTimerPaused = !isTimerPaused;
            ui.pauseResumeBtn.innerHTML = isTimerPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
        }

        // --- Recording Logic (Cross-Platform Patch) ---
        async function startRecording() {
            // Clear previous errors
            ui.errorMessagebox.classList.add('hidden');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                ui.errorMessagebox.textContent = "Microphone API not supported in this browser/context. Try Chrome or Safari.";
                ui.errorMessagebox.classList.remove('hidden');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const isMobileEdge = /Edg\/\d+.*Android/.test(navigator.userAgent);
                let options = {};
                
                // Patch: Explicit MIME type check for various devices (iOS, Android, Desktop)
                if (!isMobileEdge) {
                    const mimeTypes = ['audio/webm;codecs=opus', 'audio/ogg;codecs=opus', 'audio/webm', 'audio/ogg', 'audio/mp4'];
                    const supportedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
                    if (supportedType) options.mimeType = supportedType;
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const type = mediaRecorder.mimeType || 'audio/webm';
                    recordedBlob = new Blob(audioChunks, { type: type });
                    const url = URL.createObjectURL(recordedBlob);
                    ui.audioPlayer.src = url;
                    ui.postRecordingActions.classList.remove('hidden');
                    ui.recordingStatus.classList.add('hidden');
                    ui.stopRecordBtn.classList.add('hidden');
                    // ui.nextBtn.disabled = false; // Always enabled
                    
                    // Trigger Auto Download
                    autoDownloadRecording(recordedBlob);
                };

                mediaRecorder.start();
                ui.recordBtn.classList.add('hidden');
                ui.stopRecordBtn.classList.remove('hidden');
                ui.recordingStatus.classList.remove('hidden');

            } catch (err) {
                console.error("Recording Error:", err);
                let msg = `Error accessing microphone: ${err.message}`;
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    msg = "Microphone blocked. Please click the Lock icon 🔒 in your address bar and 'Allow' microphone access.";
                } else if (err.name === 'NotFoundError') {
                    msg = "No microphone found on this device.";
                }
                ui.errorMessagebox.textContent = msg;
                ui.errorMessagebox.classList.remove('hidden');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        // --- Event Listeners ---
        ui.startWithNameBtn.addEventListener('click', () => {
            userName = ui.nameInput.value.trim();
            if (userName) {
                saveProgress();
                ui.nameEntryContainer.classList.add('hidden');
                ui.userNameDisplay.textContent = userName;
                ui.topicSelectionContainer.classList.remove('hidden');
            }
        });

        ui.recordBtn.addEventListener('click', startRecording);
        ui.stopRecordBtn.addEventListener('click', stopRecording);
        ui.pauseResumeBtn.addEventListener('click', togglePauseTimer);
        ui.resetTimerBtn.addEventListener('click', resetTimer);
        
        ui.nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            showQuestion();
        });

        ui.backToTopicsBtn.addEventListener('click', () => {
            ui.modal.classList.remove('hidden');
        });

        ui.toggleSampleBtn.addEventListener('click', () => {
            if (ui.sampleDisplay.classList.contains('hidden')) {
                ui.sampleDisplay.classList.remove('hidden');
                ui.toggleSampleBtn.innerHTML = '<i class="fas fa-eye-slash mr-1 text-yellow-600"></i> Hide Sample';
            } else {
                ui.sampleDisplay.classList.add('hidden');
                ui.toggleSampleBtn.innerHTML = '<i class="fas fa-lightbulb mr-1 text-yellow-600"></i> Show Sample';
            }
        });

        ui.speakSampleBtn.addEventListener('click', () => {
            speak(ui.sampleText.textContent);
        });

        ui.modalCancelBtn.addEventListener('click', () => ui.modal.classList.add('hidden'));
        
        ui.modalConfirmBtn.addEventListener('click', () => {
            ui.modal.classList.add('hidden');
            ui.practiceScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            if(timerInterval) clearInterval(timerInterval);
            if(synth.speaking) synth.cancel();
            initializeTopics();
        });

        // --- Certificate Logic (iOS High-Res Patch) ---
        function showCertificate() {
            ui.practiceScreen.classList.add('hidden');
            ui.certificateScreen.classList.remove('hidden');
            document.getElementById('certificate-name').textContent = userName;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
        }

        ui.downloadCertificateBtn.addEventListener('click', () => {
            const certificateNode = document.getElementById('certificate-to-download');
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            // Patch: Open new tab early for iOS
            const newTab = isIOS ? window.open() : null;

            html2canvas(certificateNode, { scale: 2 }).then(canvas => {
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    if (isIOS && newTab) {
                        newTab.location = url; // Patch: Redirect the pre-opened tab
                    } else {
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Certificate_${userName}_IELTS.png`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    }
                });
            });
        });

        ui.backToMainMenuBtn.addEventListener('click', () => {
            ui.certificateScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            initializeTopics();
        });

        // --- Initialization ---
        loadProgress();
        initializeTTS();
        initializeTopics();

        // --- iOS Sharepoint Link Patch ---
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (isIOS) {
            const sharepointLink = document.getElementById('sharepoint-upload-link');
            if (sharepointLink) {
                sharepointLink.removeAttribute('target');
            }
        }
    });
    </script>
</body>
</html>
