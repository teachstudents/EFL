<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verb Tense Master Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap');
        
        body {
            font-family: 'Comic Neue', cursive;
        }
        
        .verb-button {
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
            box-shadow: 
                20px 20px 60px #bebebe,
                -20px -20px 60px #ffffff,
                inset 0 0 0 #d1d5db;
            border: 2px solid #d1d5db;
            transition: all 0.2s ease;
            transform: translateY(0);
        }
        
        .verb-button:hover {
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            box-shadow: 
                15px 15px 45px #bebebe,
                -15px -15px 45px #ffffff;
            transform: translateY(-2px);
        }
        
        .verb-button:active {
            background: linear-gradient(145deg, #d6d6d6, #f0f0f0);
            box-shadow: 
                inset 8px 8px 16px #bebebe,
                inset -8px -8px 16px #ffffff;
            transform: translateY(2px);
        }
        
        .verb-button.correct {
            background: linear-gradient(145deg, #10b981, #34d399);
            color: white;
            box-shadow: 
                inset 8px 8px 16px #0d9668,
                inset -8px -8px 16px #22c55e;
        }
        
        .verb-button.incorrect {
            background: linear-gradient(145deg, #ef4444, #f87171);
            color: white;
            box-shadow: 
                inset 8px 8px 16px #dc2626,
                inset -8px -8px 16px #fb7185;
        }
        
        @keyframes sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 0.8; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px #10b981; }
            50% { box-shadow: 0 0 20px #10b981, 0 0 30px #10b981; }
        }
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
        @keyframes fireworks {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }
        .sparkle { animation: sparkle 0.6s ease-in-out; }
        .shake { animation: shake 0.5s ease-in-out; }
        .glow { animation: glow 1s ease-in-out; }
        .confetti { animation: confetti 1s ease-out forwards; }
        .fireworks { animation: fireworks 1.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-400 via-pink-400 to-red-400 min-h-screen">
    <!-- Name Input Modal -->
    <div id="nameModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 text-center max-w-md mx-4">
            <div class="text-6xl mb-4">üéÆ</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Welcome to Verb Tense Master!</h2>
            <p class="text-gray-600 mb-6">What's your name?</p>
            <input type="text" id="playerName" placeholder="Enter your name" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-6 text-center font-bold focus:border-blue-500 focus:outline-none">
            <button id="startGame" class="bg-gradient-to-r from-green-400 to-blue-500 text-white px-8 py-4 rounded-full font-bold text-xl hover:from-green-500 hover:to-blue-600 transition-all transform hover:scale-105">
                Start Playing! üöÄ
            </button>
        </div>
    </div>

    <!-- Main Game Container -->
    <div id="gameContainer" class="hidden">
        <!-- Top Bar -->
        <div class="bg-white bg-opacity-90 backdrop-blur-sm shadow-lg p-4 mb-6">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl font-bold text-purple-600" id="playerNameDisplay">Player</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl" id="timerIcon">‚è±Ô∏è</span>
                        <div class="text-lg font-bold text-gray-700">
                            <span id="timeLeft">12:00</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl">ü™ô</span>
                        <span id="tokenCount" class="text-xl font-bold text-yellow-600">0</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl">üî•</span>
                        <span id="streakCount" class="text-lg font-bold text-orange-500">0</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-lg">üåä</span>
                        <span id="waveCount" class="text-lg font-bold text-blue-500">1</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Teacher Controls -->
                    <button id="teacherMode" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full transition-all">
                        üë©‚Äçüè´ Teacher
                    </button>
                    <div class="text-sm text-gray-600">Progress:</div>
                    <div class="w-32 bg-gray-200 rounded-full h-3">
                        <div id="progressBar" class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <span id="questionProgress" class="text-sm font-bold text-gray-700">1/50</span>
                </div>
            </div>
        </div>

        <!-- Teacher Control Panel -->
        <div id="teacherPanel" class="hidden max-w-4xl mx-auto mb-6 bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üë©‚Äçüè´ Teacher Controls</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Tense Mode:</label>
                    <select id="tenseMode" class="w-full p-2 border rounded-lg">
                        <option value="mixed">Mixed Tenses</option>
                        <option value="simple_present">Simple Present Only</option>
                        <option value="present_continuous">Present Continuous Only</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Audio Settings:</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="readAloud" class="mr-2">
                            <span class="text-sm">Read prompts aloud</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="accessibilityMode" class="mr-2">
                            <span class="text-sm">High contrast mode</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Time Settings:</label>
                    <label class="flex items-center">
                        <input type="checkbox" id="timeExtended" class="mr-2">
                        <span class="text-sm">Extended time (+5 min)</span>
                    </label>
                </div>
            </div>
            <button id="applySettings" class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-all">
                Apply Settings
            </button>
        </div>

        <!-- Main Game Area -->
        <div class="max-w-4xl mx-auto px-4">
            <!-- Question Panel -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 mb-8">
                <div class="text-center mb-8">
                    <div id="sentence" class="text-3xl leading-relaxed text-gray-800 mb-6 font-bold">
                        <!-- Sentence will be inserted here -->
                    </div>
                    <div id="hintBubble" class="hidden bg-blue-100 border-l-4 border-blue-500 p-4 rounded-lg text-blue-700 max-w-md mx-auto text-lg">
                        <!-- Hints will appear here -->
                    </div>
                </div>

                <!-- 3D Verb Buttons -->
                <div id="verbOptions" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
                    <!-- Verb buttons will be inserted here -->
                </div>
            </div>


        </div>

        <!-- Celebration Effects -->
        <div id="celebrationContainer" class="fixed inset-0 pointer-events-none z-30">
            <!-- Confetti and fireworks will be added here -->
        </div>
    </div>

    <script>
        class VerbTenseGame {
            constructor() {
                this.currentQuestion = 0;
                this.totalQuestions = 50;
                this.tokens = 0;
                this.streak = 0;
                this.correctAnswers = 0;
                this.timeLeft = 12 * 60; // 12 minutes in seconds
                this.attempts = 0;
                this.audioEnabled = true; // Always enabled
                this.waveCorrect = 0; // Track correct answers in current wave
                this.currentWave = 1;
                this.unlockedStickers = [];
                this.celebrationTheme = 'default';
                this.playerName = '';
                
                // Teacher settings
                this.teacherSettings = {
                    tenseMode: 'mixed', // 'simple_present', 'present_continuous', 'mixed'
                    readAloud: false,
                    timeExtended: false,
                    accessibilityMode: false
                };
                
                this.questions = this.generateQuestions();
                this.initializeGame();
            }

            generateQuestions() {
                const questions = [
                    // Classroom objects with "it" subjects
                    { sentence: "The clock ___ every second.", options: ["ticks", "tick", "is ticking", "are ticking"], correct: "ticks", type: "simple_present", subject: "The clock", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "The bell ___ at 3 PM.", options: ["rings", "ring", "is ringing", "are ringing"], correct: "rings", type: "simple_present", subject: "The bell", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "The computer ___ now.", options: ["is working", "work", "works", "are working"], correct: "is working", type: "present_continuous", subject: "The computer", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Áî®is" },
                    { sentence: "The projector ___ the lesson.", options: ["shows", "show", "is showing", "are showing"], correct: "shows", type: "simple_present", subject: "The projector", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "The whiteboard ___ clean today.", options: ["looks", "look", "is looking", "are looking"], correct: "looks", type: "simple_present", subject: "The whiteboard", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "The pencil sharpener ___ loudly.", options: ["works", "work", "is working", "are working"], correct: "works", type: "simple_present", subject: "The pencil sharpener", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "The fan ___ right now.", options: ["is spinning", "spin", "spins", "are spinning"], correct: "is spinning", type: "present_continuous", subject: "The fan", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Áî®is" },
                    { sentence: "The door ___ when it's windy.", options: ["creaks", "creak", "is creaking", "are creaking"], correct: "creaks", type: "simple_present", subject: "The door", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    
                    // Original questions with mix of subjects
                    { sentence: "I ___ breakfast at 7.", options: ["eat", "eats", "am eating", "is eating"], correct: "eat", type: "simple_present", subject: "I", rule: "Á¨¨‰∏Ä‰∫∫Áß∞IÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "She ___ milk every day.", options: ["drinks", "drink", "are drinking", "drinking"], correct: "drinks", type: "simple_present", subject: "She", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "They ___ soccer after school.", options: ["play", "plays", "is playing", "playing"], correct: "play", type: "simple_present", subject: "They", rule: "Â§çÊï∞‰∏ªËØ≠theyÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "He ___ a sandwich now.", options: ["is eating", "eat", "eats", "are eating"], correct: "is eating", type: "present_continuous", subject: "He", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Áî®is" },
                    { sentence: "We ___ in class right now.", options: ["are sitting", "sits", "sit", "is sitting"], correct: "are sitting", type: "present_continuous", subject: "We", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÂ§çÊï∞‰∏ªËØ≠Áî®are" },
                    { sentence: "You ___ fast.", options: ["run", "runs", "is running", "are running"], correct: "run", type: "simple_present", subject: "You", rule: "Á¨¨‰∫å‰∫∫Áß∞youÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "The cat ___ milk.", options: ["drinks", "drink", "are drinking", "is drink"], correct: "drinks", type: "simple_present", subject: "The cat", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "I ___ my lunch now.", options: ["am eating", "eating", "eats", "is eating"], correct: "am eating", type: "present_continuous", subject: "I", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏Ä‰∫∫Áß∞IÁî®am" },
                    { sentence: "He ___ his homework after dinner.", options: ["does", "do", "is doing", "are doing"], correct: "does", type: "simple_present", subject: "He", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-sÊàñ-es" },
                    { sentence: "They ___ to music now.", options: ["are listening", "is listening", "listens", "listen"], correct: "are listening", type: "present_continuous", subject: "They", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÂ§çÊï∞‰∏ªËØ≠Áî®are" },
                    { sentence: "She ___ to school by bus.", options: ["goes", "go", "is going", "are going"], correct: "goes", type: "simple_present", subject: "She", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-sÊàñ-es" },
                    { sentence: "We ___ apples every day.", options: ["eat", "eats", "are eating", "is eating"], correct: "eat", type: "simple_present", subject: "We", rule: "Â§çÊï∞‰∏ªËØ≠weÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "The teacher ___ the book now.", options: ["is reading", "reads", "read", "are reading"], correct: "is reading", type: "present_continuous", subject: "The teacher", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Áî®is" },
                    { sentence: "You ___ very well.", options: ["read", "reads", "is reading", "are reading"], correct: "read", type: "simple_present", subject: "You", rule: "Á¨¨‰∫å‰∫∫Áß∞youÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "He ___ his pencil.", options: ["sharpens", "sharpen", "is sharpening", "are sharpening"], correct: "sharpens", type: "simple_present", subject: "He", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "I ___ water now.", options: ["am drinking", "drinks", "drink", "is drinking"], correct: "am drinking", type: "present_continuous", subject: "I", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏Ä‰∫∫Áß∞IÁî®am" },
                    { sentence: "They ___ the board.", options: ["clean", "cleans", "is cleaning", "are cleaning"], correct: "clean", type: "simple_present", subject: "They", rule: "Â§çÊï∞‰∏ªËØ≠theyÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "She ___ a picture now.", options: ["is drawing", "draws", "draw", "are drawing"], correct: "is drawing", type: "present_continuous", subject: "She", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Áî®is" },
                    { sentence: "We ___ lunch at noon.", options: ["have", "has", "is having", "are having"], correct: "have", type: "simple_present", subject: "We", rule: "Â§çÊï∞‰∏ªËØ≠weÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "He ___ his hands now.", options: ["is washing", "wash", "washes", "are washing"], correct: "is washing", type: "present_continuous", subject: "He", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Áî®is" },
                    { sentence: "The kids ___ in the playground.", options: ["play", "plays", "is playing", "are playing"], correct: "play", type: "simple_present", subject: "The kids", rule: "Â§çÊï∞‰∏ªËØ≠Âú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "I ___ my name on the paper now.", options: ["am writing", "write", "writes", "is writing"], correct: "am writing", type: "present_continuous", subject: "I", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏Ä‰∫∫Áß∞IÁî®am" },
                    { sentence: "She ___ her bag.", options: ["carries", "carry", "is carrying", "are carrying"], correct: "carries", type: "simple_present", subject: "She", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Ôºå‰ª•ËæÖÈü≥Â≠óÊØç+yÁªìÂ∞æÁöÑÂä®ËØçÂèòy‰∏∫iÂä†es" },
                    { sentence: "We ___ the bell now.", options: ["are hearing", "hear", "hears", "is hearing"], correct: "are hearing", type: "present_continuous", subject: "We", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÂ§çÊï∞‰∏ªËØ≠Áî®are" },
                    { sentence: "You ___ the door.", options: ["open", "opens", "is opening", "are opening"], correct: "open", type: "simple_present", subject: "You", rule: "Á¨¨‰∫å‰∫∫Áß∞youÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "He ___ cereal for breakfast.", options: ["eats", "eat", "is eating", "are eating"], correct: "eats", type: "simple_present", subject: "He", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "They ___ a story now.", options: ["are reading", "read", "reads", "is reading"], correct: "are reading", type: "present_continuous", subject: "They", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÂ§çÊï∞‰∏ªËØ≠Áî®are" },
                    { sentence: "I ___ to the teacher now.", options: ["am talking", "talk", "talks", "is talking"], correct: "am talking", type: "present_continuous", subject: "I", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏Ä‰∫∫Áß∞IÁî®am" },
                    { sentence: "She ___ her shoes.", options: ["ties", "tie", "is tying", "are tying"], correct: "ties", type: "simple_present", subject: "She", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "We ___ the floor now.", options: ["are cleaning", "clean", "cleans", "is cleaning"], correct: "are cleaning", type: "present_continuous", subject: "We", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÂ§çÊï∞‰∏ªËØ≠Áî®are" },
                    { sentence: "He ___ to class on time.", options: ["comes", "come", "is coming", "are coming"], correct: "comes", type: "simple_present", subject: "He", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "You ___ your lunch at 12.", options: ["eat", "eats", "are eating", "is eating"], correct: "eat", type: "simple_present", subject: "You", rule: "Á¨¨‰∫å‰∫∫Áß∞youÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "They ___ the bus now.", options: ["are waiting for", "wait for", "waits for", "is waiting for"], correct: "are waiting for", type: "present_continuous", subject: "They", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÂ§çÊï∞‰∏ªËØ≠Áî®are" },
                    { sentence: "The dog ___ in the yard.", options: ["runs", "run", "is running", "are running"], correct: "runs", type: "simple_present", subject: "The dog", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "I ___ my homework every day.", options: ["do", "does", "am doing", "is doing"], correct: "do", type: "simple_present", subject: "I", rule: "Á¨¨‰∏Ä‰∫∫Áß∞IÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "She ___ TV now.", options: ["is watching", "watch", "watches", "are watching"], correct: "is watching", type: "present_continuous", subject: "She", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Áî®is" },
                    { sentence: "We ___ to the park on Sundays.", options: ["go", "goes", "are going", "is going"], correct: "go", type: "simple_present", subject: "We", rule: "Â§çÊï∞‰∏ªËØ≠weÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "He ___ his bike now.", options: ["is riding", "ride", "rides", "are riding"], correct: "is riding", type: "present_continuous", subject: "He", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Áî®is" },
                    { sentence: "They ___ their room every week.", options: ["clean", "cleans", "are cleaning", "is cleaning"], correct: "clean", type: "simple_present", subject: "They", rule: "Â§çÊï∞‰∏ªËØ≠theyÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "You ___ a book now.", options: ["are reading", "read", "reads", "is reading"], correct: "are reading", type: "present_continuous", subject: "You", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∫å‰∫∫Áß∞youÁî®are" },
                    { sentence: "The bird ___ in the tree.", options: ["sits", "sit", "is sitting", "are sitting"], correct: "sits", type: "simple_present", subject: "The bird", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "I ___ my teeth every morning.", options: ["brush", "brushes", "am brushing", "is brushing"], correct: "brush", type: "simple_present", subject: "I", rule: "Á¨¨‰∏Ä‰∫∫Áß∞IÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "She ___ her hair now.", options: ["is combing", "comb", "combs", "are combing"], correct: "is combing", type: "present_continuous", subject: "She", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Áî®is" },
                    { sentence: "We ___ games after school.", options: ["play", "plays", "are playing", "is playing"], correct: "play", type: "simple_present", subject: "We", rule: "Â§çÊï∞‰∏ªËØ≠weÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "He ___ his dinner now.", options: ["is eating", "eat", "eats", "are eating"], correct: "is eating", type: "present_continuous", subject: "He", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Áî®is" },
                    { sentence: "They ___ to music every day.", options: ["listen", "listens", "are listening", "is listening"], correct: "listen", type: "simple_present", subject: "They", rule: "Â§çÊï∞‰∏ªËØ≠theyÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "You ___ your hands now.", options: ["are washing", "wash", "washes", "is washing"], correct: "are washing", type: "present_continuous", subject: "You", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∫å‰∫∫Áß∞youÁî®are" },
                    { sentence: "The children ___ outside.", options: ["play", "plays", "are playing", "is playing"], correct: "play", type: "simple_present", subject: "The children", rule: "Â§çÊï∞‰∏ªËØ≠Âú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Áî®Âä®ËØçÂéüÂΩ¢" },
                    { sentence: "I ___ a letter now.", options: ["am writing", "write", "writes", "is writing"], correct: "am writing", type: "present_continuous", subject: "I", rule: "Áé∞Âú®ËøõË°åÊó∂Áî®beÂä®ËØçÂä†Âä®ËØçingÂΩ¢ÂºèÔºåÁ¨¨‰∏Ä‰∫∫Áß∞IÁî®am" },
                    { sentence: "She ___ her mother every day.", options: ["helps", "help", "is helping", "are helping"], correct: "helps", type: "simple_present", subject: "She", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    
                    // More classroom objects
                    { sentence: "The window ___ when it rains.", options: ["fogs", "fog", "is fogging", "are fogging"], correct: "fogs", type: "simple_present", subject: "The window", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" },
                    { sentence: "The marker ___ on the board.", options: ["writes", "write", "is writing", "are writing"], correct: "writes", type: "simple_present", subject: "The marker", rule: "Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Ôºàhe/she/itÔºâÂú®‰∏ÄËà¨Áé∞Âú®Êó∂‰∏≠Âä®ËØçË¶ÅÂä†-s" }
                ];
                
                // Filter questions based on teacher settings
                if (this.teacherSettings.tenseMode === 'simple_present') {
                    return this.shuffleArray(questions.filter(q => q.type === 'simple_present'));
                } else if (this.teacherSettings.tenseMode === 'present_continuous') {
                    return this.shuffleArray(questions.filter(q => q.type === 'present_continuous'));
                }
                
                // Shuffle questions for variety
                return this.shuffleArray(questions);
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            initializeGame() {
                this.setupEventListeners();
                this.startTimer();
                this.displayQuestion();
            }

            setupEventListeners() {
                document.getElementById('startGame').addEventListener('click', () => {
                    const nameInput = document.getElementById('playerName');
                    this.playerName = nameInput.value.trim() || 'Player';
                    document.getElementById('playerNameDisplay').textContent = this.playerName;
                    document.getElementById('nameModal').classList.add('hidden');
                    document.getElementById('gameContainer').classList.remove('hidden');
                    this.speak(`Hello ${this.playerName}! Let's start learning verb tenses!`, 'Ava');
                });

                // Allow Enter key to start game
                document.getElementById('playerName').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('startGame').click();
                    }
                });

                // Teacher mode controls
                document.getElementById('teacherMode').addEventListener('click', () => {
                    const panel = document.getElementById('teacherPanel');
                    panel.classList.toggle('hidden');
                });

                document.getElementById('applySettings').addEventListener('click', () => {
                    this.applyTeacherSettings();
                });

                // Keyboard accessibility
                document.addEventListener('keydown', (e) => {
                    if (e.key >= '1' && e.key <= '4') {
                        const buttons = document.querySelectorAll('.verb-button');
                        const index = parseInt(e.key) - 1;
                        if (buttons[index]) {
                            this.checkAnswer(buttons[index].dataset.verb);
                        }
                    }
                });
            }

            applyTeacherSettings() {
                // Update tense mode
                this.teacherSettings.tenseMode = document.getElementById('tenseMode').value;
                this.teacherSettings.readAloud = document.getElementById('readAloud').checked;
                this.teacherSettings.accessibilityMode = document.getElementById('accessibilityMode').checked;
                this.teacherSettings.timeExtended = document.getElementById('timeExtended').checked;

                // Apply accessibility mode
                if (this.teacherSettings.accessibilityMode) {
                    document.body.classList.add('high-contrast');
                    // Add high contrast styles
                    const style = document.createElement('style');
                    style.textContent = `
                        .high-contrast { filter: contrast(150%) brightness(110%); }
                        .high-contrast .verb-button { border: 4px solid #000; }
                    `;
                    document.head.appendChild(style);
                } else {
                    document.body.classList.remove('high-contrast');
                }

                // Apply time extension
                if (this.teacherSettings.timeExtended) {
                    this.timeLeft += 5 * 60; // Add 5 minutes
                }

                // Regenerate questions with new tense filter
                this.questions = this.generateQuestions();
                this.currentQuestion = 0;
                this.displayQuestion();

                // Hide teacher panel
                document.getElementById('teacherPanel').classList.add('hidden');
                
                this.speak("Settings applied successfully!", 'Ava');
            }

            displayQuestion() {
                const question = this.questions[this.currentQuestion];
                const sentenceElement = document.getElementById('sentence');
                
                // Create sentence with blank
                const parts = question.sentence.split('___');
                sentenceElement.innerHTML = `
                    ${parts[0]}
                    <span id="blankSpace" class="inline-block min-w-32 h-12 border-2 border-dashed border-gray-400 rounded-lg bg-gray-50 mx-2 px-4 py-2 text-center">
                        <span class="text-gray-400 text-2xl">?</span>
                    </span>
                    ${parts[1]}
                `;

                // Display verb options as 3D buttons
                this.displayVerbOptions(question.options);
                
                // Update progress and wave
                document.getElementById('questionProgress').textContent = `${this.currentQuestion + 1}/${this.totalQuestions}`;
                document.getElementById('progressBar').style.width = `${((this.currentQuestion) / this.totalQuestions) * 100}%`;
                document.getElementById('waveCount').textContent = this.currentWave;
                
                // Read aloud if enabled
                if (this.teacherSettings.readAloud) {
                    const readText = question.sentence.replace('___', 'blank');
                    setTimeout(() => {
                        this.speak(readText, this.getRandomVoice());
                        setTimeout(() => {
                            this.speak(`The choices are: ${question.options.join(', ')}`, this.getRandomVoice());
                        }, 2000);
                    }, 500);
                }
                
                // Reset attempts
                this.attempts = 0;
                this.hideHint();
            }

            displayVerbOptions(options) {
                const container = document.getElementById('verbOptions');
                container.innerHTML = '';
                
                // Shuffle the options array to randomize positions
                const shuffledOptions = this.shuffleArray([...options]);
                
                shuffledOptions.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'verb-button px-8 py-6 rounded-2xl font-bold text-3xl text-gray-800 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-200';
                    button.textContent = option;
                    button.dataset.verb = option;
                    button.tabIndex = 0;
                    
                    // Add number indicator for keyboard shortcuts
                    const numberBadge = document.createElement('span');
                    numberBadge.className = 'absolute top-2 right-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full';
                    numberBadge.textContent = index + 1;
                    button.style.position = 'relative';
                    button.appendChild(numberBadge);
                    
                    // Add click event
                    button.addEventListener('click', () => {
                        this.checkAnswer(option);
                    });
                    
                    // Add keyboard support
                    button.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.checkAnswer(option);
                        }
                    });
                    
                    container.appendChild(button);
                });
            }

            checkAnswer(selectedVerb) {
                const question = this.questions[this.currentQuestion];
                const blankSpace = document.getElementById('blankSpace');
                const buttons = document.querySelectorAll('.verb-button');
                this.attempts++;
                
                // Disable all buttons temporarily
                buttons.forEach(btn => btn.disabled = true);
                
                if (selectedVerb === question.correct) {
                    // Correct answer
                    blankSpace.innerHTML = `<span class="text-green-600 font-bold text-2xl">${selectedVerb}</span>`;
                    blankSpace.classList.add('glow');
                    
                    // Highlight correct button
                    buttons.forEach(btn => {
                        if (btn.dataset.verb === selectedVerb) {
                            btn.classList.add('correct');
                        }
                    });
                    
                    // Award tokens based on attempts
                    let tokensEarned = 0;
                    if (this.attempts === 1) {
                        tokensEarned = 2; // First try bonus
                        this.createTokenAnimation('+2 ü™ô');
                    } else if (this.attempts <= 3) {
                        tokensEarned = 1;
                        this.createTokenAnimation('+1 ü™ô');
                    }
                    
                    this.tokens += tokensEarned;
                    this.streak++;
                    this.correctAnswers++;
                    this.waveCorrect++;
                    
                    // Check for wave bonus (10 questions per wave)
                    if ((this.currentQuestion + 1) % 10 === 0) {
                        if (this.waveCorrect === 10) {
                            this.tokens += 5; // Wave bonus
                            this.createTokenAnimation('+5 ü™ô WAVE BONUS!');
                            this.speak("Perfect wave! Bonus tokens earned!", 'Ava');
                        }
                        this.waveCorrect = 0;
                        this.currentWave++;
                    }
                    
                    this.updateDisplay();
                    this.showCorrectFeedback();
                    this.checkMilestones();
                    
                    // Move to next question after delay
                    setTimeout(() => {
                        this.nextQuestion();
                    }, 2500);
                    
                } else {
                    // Incorrect answer
                    blankSpace.innerHTML = `<span class="text-red-600 font-bold text-2xl">${selectedVerb}</span>`;
                    blankSpace.classList.add('shake');
                    
                    // Highlight incorrect button
                    buttons.forEach(btn => {
                        if (btn.dataset.verb === selectedVerb) {
                            btn.classList.add('incorrect');
                        }
                        btn.disabled = false; // Re-enable buttons
                    });
                    
                    this.streak = 0;
                    this.showIncorrectFeedback(question);
                    this.showHint();
                    
                    setTimeout(() => {
                        blankSpace.classList.remove('shake');
                        blankSpace.innerHTML = `<span class="text-gray-400 text-2xl">?</span>`;
                        // Remove incorrect styling
                        buttons.forEach(btn => {
                            btn.classList.remove('incorrect');
                        });
                    }, 2000);
                }
            }

            showCorrectFeedback() {
                const messages = ["Great job!", "Nice work!", "Excellent!", "Perfect!", "Well done!"];
                const message = messages[Math.floor(Math.random() * messages.length)];
                this.speak(message, this.getRandomVoice());
                this.playSound('correct');
                this.createSparkles();
            }

            showIncorrectFeedback(question) {
                this.speak("Try again. Look at the subject.", 'Andrew');
                this.playSound('incorrect');
                
                // Explain in Chinese using high-quality TTS
                setTimeout(() => {
                    this.speakChinese(`${question.rule}„ÄÇÊ≠£Á°ÆÁ≠îÊ°àÊòØÔºö${question.correct}`);
                }, 1000);
            }

            showHint() {
                const question = this.questions[this.currentQuestion];
                const hintBubble = document.getElementById('hintBubble');
                let hint = '';
                
                if (this.attempts === 1) {
                    // First miss: Basic rule hint
                    hint = "Check who does the action: he/she/it needs 's'";
                } else if (this.attempts === 2) {
                    // Second miss: Highlight subject and matching tile
                    this.highlightSubjectAndAnswer(question);
                    hint = `Look at "${question.subject}" - what verb form matches?`;
                } else if (this.attempts >= 3) {
                    // Third miss: Show correct answer
                    hint = `The correct answer is "${question.correct}"`;
                    this.showCorrectAnswer(question.correct);
                }
                
                hintBubble.textContent = hint;
                hintBubble.classList.remove('hidden');
            }

            highlightSubjectAndAnswer(question) {
                // Highlight the subject in the sentence
                const sentenceElement = document.getElementById('sentence');
                const highlightedSentence = sentenceElement.innerHTML.replace(
                    question.subject,
                    `<span class="bg-yellow-200 px-2 py-1 rounded font-bold">${question.subject}</span>`
                );
                sentenceElement.innerHTML = highlightedSentence;
                
                // Highlight the correct answer button
                const buttons = document.querySelectorAll('.verb-button');
                buttons.forEach(btn => {
                    if (btn.dataset.verb === question.correct) {
                        btn.style.boxShadow = '0 0 20px #fbbf24, 0 0 40px #fbbf24';
                        btn.style.transform = 'scale(1.05)';
                    }
                });
            }

            showCorrectAnswer(correctAnswer) {
                const blankSpace = document.getElementById('blankSpace');
                blankSpace.innerHTML = `<span class="text-blue-600 font-bold animate-pulse text-2xl">${correctAnswer}</span>`;
                blankSpace.classList.add('bg-blue-100', 'border-blue-400');
            }

            hideHint() {
                document.getElementById('hintBubble').classList.add('hidden');
            }

            checkMilestones() {
                // Check streak milestones with enhanced celebrations
                if (this.streak === 3) {
                    this.createGentleConfetti();
                    this.speak("Streak of three! Keep going!", this.getRandomVoice());
                } else if (this.streak === 5) {
                    this.createGlitterTrail();
                    this.speak("Awesome streak! You're on fire!", this.getRandomVoice());
                } else if (this.streak === 10) {
                    this.createThemedFireworks();
                    this.createExplosionPops();
                    this.speak("Ten in a row! Incredible streak!", this.getRandomVoice());
                }
                
                // Check badge milestones
                this.updateBadges();
                
                // Check wave completion (every 10 questions)
                if ((this.currentQuestion + 1) % 10 === 0) {
                    this.createFireworks();
                    this.createTokenRain();
                    this.speak(`Wave ${this.currentWave} complete!`, this.getRandomVoice());
                }
            }

            getRandomVoice() {
                const voices = ['Ava', 'Emma', 'Brian', 'Andrew'];
                return voices[Math.floor(Math.random() * voices.length)];
            }

            updateBadges() {
                const badges = {
                    starter: { threshold: 10, element: document.querySelector('[data-badge="starter"]') },
                    explorer: { threshold: 25, element: document.querySelector('[data-badge="explorer"]') },
                    master: { threshold: 40, element: document.querySelector('[data-badge="master"]') },
                    fluent: { threshold: 50, element: document.querySelector('[data-badge="fluent"]') }
                };
                
                Object.values(badges).forEach(badge => {
                    if (this.correctAnswers >= badge.threshold) {
                        badge.element.classList.remove('opacity-30');
                        badge.element.classList.add('sparkle');
                    }
                });
            }

            nextQuestion() {
                this.currentQuestion++;
                
                if (this.currentQuestion >= this.totalQuestions) {
                    this.endGame();
                } else {
                    // Reset all visual states for next question
                    this.resetQuestionState();
                    this.displayQuestion();
                }
            }

            resetQuestionState() {
                // Reset blank space
                const blankSpace = document.getElementById('blankSpace');
                blankSpace.classList.remove('glow', 'bg-blue-100', 'border-blue-400');
                
                // Reset buttons
                const buttons = document.querySelectorAll('.verb-button');
                buttons.forEach(btn => {
                    btn.classList.remove('correct', 'incorrect');
                    btn.style.boxShadow = '';
                    btn.style.transform = '';
                    btn.disabled = false;
                });
                
                // Reset hint bubble
                const hintBubble = document.getElementById('hintBubble');
                hintBubble.classList.remove('border-orange-400', 'bg-orange-50');
            }

            endGame() {
                this.createMegaFireworks();
                this.speak(`Congratulations ${this.playerName}! You completed all ${this.totalQuestions} questions and earned ${this.tokens} tokens!`, 'Ava');
                
                // Show final celebration
                setTimeout(() => {
                    alert(`üéâ Game Complete! üéâ\n\nFinal Score for ${this.playerName}:\nü™ô Tokens: ${this.tokens}\n‚úÖ Correct: ${this.correctAnswers}/${this.totalQuestions}\nüî• Best Streak: ${this.streak}`);
                }, 2000);
            }

            updateDisplay() {
                document.getElementById('tokenCount').textContent = this.tokens;
                document.getElementById('streakCount').textContent = this.streak;
            }

            startTimer() {
                const timer = setInterval(() => {
                    this.timeLeft--;
                    const minutes = Math.floor(this.timeLeft / 60);
                    const seconds = this.timeLeft % 60;
                    const timeDisplay = document.getElementById('timeLeft');
                    const timerIcon = document.getElementById('timerIcon');
                    
                    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Timer warning when less than 2 minutes
                    if (this.timeLeft <= 120 && this.timeLeft > 0) {
                        timerIcon.textContent = '‚è∞';
                        timerIcon.classList.add('animate-pulse');
                        timeDisplay.classList.add('text-red-600');
                        
                        // Warning sound at 1 minute
                        if (this.timeLeft === 60) {
                            this.speak("One minute remaining!", 'Ava');
                        }
                    }
                    
                    if (this.timeLeft <= 0) {
                        clearInterval(timer);
                        this.endGame();
                    }
                }, 1000);
            }

            speak(text, voice = 'Ava') {
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Wait for voices to load
                const setVoice = () => {
                    const voices = speechSynthesis.getVoices();
                    
                    // Try to find the high-quality neural voices
                    let selectedVoice = voices.find(v => 
                        v.name.includes(voice) && 
                        (v.name.includes('Neural') || v.name.includes('Premium') || v.name.includes('Enhanced'))
                    );
                    
                    // Fallback to any voice with the name
                    if (!selectedVoice) {
                        selectedVoice = voices.find(v => v.name.includes(voice));
                    }
                    
                    // Final fallback to default voice
                    if (!selectedVoice) {
                        selectedVoice = voices.find(v => v.lang.startsWith('en'));
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }
                    
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.8;
                    speechSynthesis.speak(utterance);
                };
                
                if (speechSynthesis.getVoices().length > 0) {
                    setVoice();
                } else {
                    speechSynthesis.addEventListener('voiceschanged', setVoice, { once: true });
                }
            }

            speakChinese(text) {
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Wait for voices to load
                const setVoice = () => {
                    const voices = speechSynthesis.getVoices();
                    
                    // Try to find high-quality Chinese neural voices
                    let selectedVoice = voices.find(v => 
                        (v.lang.includes('zh') || v.lang.includes('cmn')) && 
                        (v.name.includes('Neural') || v.name.includes('Premium') || v.name.includes('Enhanced'))
                    );
                    
                    // Fallback to any Chinese voice
                    if (!selectedVoice) {
                        selectedVoice = voices.find(v => v.lang.includes('zh') || v.lang.includes('cmn'));
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                        utterance.lang = selectedVoice.lang;
                    } else {
                        utterance.lang = 'zh-CN';
                    }
                    
                    utterance.rate = 0.8;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.8;
                    speechSynthesis.speak(utterance);
                };
                
                if (speechSynthesis.getVoices().length > 0) {
                    setVoice();
                } else {
                    speechSynthesis.addEventListener('voiceschanged', setVoice, { once: true });
                }
            }

            playSound(type) {
                // Create audio context for sound effects
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    if (type === 'correct') {
                        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                    } else {
                        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    }
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    console.log('Audio context not available');
                }
            }

            createSparkles() {
                const container = document.getElementById('celebrationContainer');
                for (let i = 0; i < 5; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'absolute text-2xl sparkle';
                    sparkle.textContent = '‚ú®';
                    sparkle.style.left = Math.random() * 100 + '%';
                    sparkle.style.top = Math.random() * 100 + '%';
                    container.appendChild(sparkle);
                    
                    setTimeout(() => sparkle.remove(), 600);
                }
            }

            createConfetti() {
                const container = document.getElementById('celebrationContainer');
                const colors = ['üéâ', 'üéä', '‚ú®', 'üåü'];
                
                for (let i = 0; i < 10; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'absolute text-xl confetti';
                    confetti.textContent = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '100%';
                    container.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 1000);
                }
            }

            createFireworks() {
                const container = document.getElementById('celebrationContainer');
                for (let i = 0; i < 3; i++) {
                    const firework = document.createElement('div');
                    firework.className = 'absolute text-4xl fireworks';
                    firework.textContent = 'üéÜ';
                    firework.style.left = Math.random() * 80 + 10 + '%';
                    firework.style.top = Math.random() * 50 + 25 + '%';
                    container.appendChild(firework);
                    
                    setTimeout(() => firework.remove(), 1500);
                }
            }

            createTokenRain() {
                const container = document.getElementById('celebrationContainer');
                for (let i = 0; i < 8; i++) {
                    const token = document.createElement('div');
                    token.className = 'absolute text-2xl confetti';
                    token.textContent = 'ü™ô';
                    token.style.left = Math.random() * 100 + '%';
                    token.style.top = '0%';
                    token.style.animationDelay = Math.random() * 0.5 + 's';
                    container.appendChild(token);
                    
                    setTimeout(() => token.remove(), 1000);
                }
            }

            createMegaFireworks() {
                const container = document.getElementById('celebrationContainer');
                const effects = ['üéÜ', 'üéá', '‚ú®', 'üåü', 'üí•'];
                
                for (let i = 0; i < 20; i++) {
                    const effect = document.createElement('div');
                    effect.className = 'absolute text-5xl fireworks';
                    effect.textContent = effects[Math.floor(Math.random() * effects.length)];
                    effect.style.left = Math.random() * 100 + '%';
                    effect.style.top = Math.random() * 100 + '%';
                    effect.style.animationDelay = Math.random() * 2 + 's';
                    container.appendChild(effect);
                    
                    setTimeout(() => effect.remove(), 3000);
                }
            }

            createTokenAnimation(text) {
                const container = document.getElementById('celebrationContainer');
                const tokenAnim = document.createElement('div');
                tokenAnim.className = 'absolute text-2xl font-bold text-yellow-600 animate-bounce';
                tokenAnim.textContent = text;
                tokenAnim.style.left = '50%';
                tokenAnim.style.top = '20%';
                tokenAnim.style.transform = 'translateX(-50%)';
                tokenAnim.style.zIndex = '50';
                container.appendChild(tokenAnim);
                
                setTimeout(() => tokenAnim.remove(), 2000);
            }

            createGentleConfetti() {
                const container = document.getElementById('celebrationContainer');
                const confettiTypes = ['üéâ', 'üéä', '‚ú®'];
                
                for (let i = 0; i < 6; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'absolute text-lg confetti';
                    confetti.textContent = confettiTypes[Math.floor(Math.random() * confettiTypes.length)];
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '100%';
                    confetti.style.animationDelay = Math.random() * 0.3 + 's';
                    container.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 1000);
                }
            }

            createGlitterTrail() {
                const container = document.getElementById('celebrationContainer');
                for (let i = 0; i < 12; i++) {
                    const glitter = document.createElement('div');
                    glitter.className = 'absolute text-xl sparkle';
                    glitter.textContent = '‚ú®';
                    glitter.style.left = Math.random() * 100 + '%';
                    glitter.style.top = Math.random() * 100 + '%';
                    glitter.style.animationDelay = Math.random() * 0.5 + 's';
                    container.appendChild(glitter);
                    
                    setTimeout(() => glitter.remove(), 800);
                }
            }

            createThemedFireworks() {
                const container = document.getElementById('celebrationContainer');
                let effects;
                
                // Use different themes based on celebration theme
                if (this.celebrationTheme === 'rainbow') {
                    effects = ['üåà', 'üéÜ', 'üéá', '‚ú®', 'üåü'];
                } else if (this.celebrationTheme === 'star') {
                    effects = ['‚≠ê', 'üåü', '‚ú®', 'üí´', 'üå†'];
                } else {
                    effects = ['üéÜ', 'üéá', 'üí•', 'üåü', '‚ú®'];
                }
                
                for (let i = 0; i < 8; i++) {
                    const firework = document.createElement('div');
                    firework.className = 'absolute text-4xl fireworks';
                    firework.textContent = effects[Math.floor(Math.random() * effects.length)];
                    firework.style.left = Math.random() * 80 + 10 + '%';
                    firework.style.top = Math.random() * 60 + 20 + '%';
                    firework.style.animationDelay = Math.random() * 1 + 's';
                    container.appendChild(firework);
                    
                    setTimeout(() => firework.remove(), 2000);
                }
            }

            createExplosionPops() {
                const container = document.getElementById('celebrationContainer');
                for (let i = 0; i < 5; i++) {
                    const pop = document.createElement('div');
                    pop.className = 'absolute text-3xl fireworks';
                    pop.textContent = 'üí•';
                    pop.style.left = Math.random() * 100 + '%';
                    pop.style.top = Math.random() * 100 + '%';
                    pop.style.animationDelay = Math.random() * 0.8 + 's';
                    container.appendChild(pop);
                    
                    setTimeout(() => pop.remove(), 1500);
                }
            }
        }

        // Initialize game when page loads
        window.addEventListener('load', () => {
            new VerbTenseGame();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98320bf405f6cf4d',t:'MTc1ODU0NjY3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
