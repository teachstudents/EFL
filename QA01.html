<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Joel's Speaking Practice 01</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            position: relative;
        }
        /* Snowfall effect */
        .snowflake {
            color: #fff;
            font-size: 1em;
            font-family: Arial, sans-serif;
            text-shadow: 0 0 5px #000;
            position: fixed;
            top: -10%;
            z-index: 0;
            user-select: none;
            animation: snowfall linear infinite;
        }

        @keyframes snowfall {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(105vh) rotate(360deg); opacity: 0; }
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        audio::-webkit-media-controls-panel {
            padding: 5px;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display {
            margin: 0 2px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Make sure app content is above the snow */
        #app-container {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center p-2 sm:p-4">
    
    <div id="snow-container"></div>

    <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 fixed top-4 right-4 z-50">
        <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
        <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707-.707a1 1 0 01-1.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707z"></path></svg>
    </button>

    <div id="app-container" class="w-full max-w-xl mx-auto text-center h-full">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center">
            <div id="name-entry-container">
                <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">Joel's Speaking Practice 01</h1>
                <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 text-center text-lg text-gray-900 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                <button id="start-with-name-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">Start</button>
            </div>
            <div id="topic-selection-container" class="hidden">
                 <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">Hello, <span id="user-name-display"></span>!</h1>
                 <div id="instructions" class="text-sm text-gray-600 dark:text-gray-400 mb-4 text-left space-y-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                      <p><i class="fas fa-bullhorn mr-2 text-indigo-500"></i>Try to speak until the time runs out. You can use the sentence starters and word bank for help.</p>
                      <p><i class="fas fa-download mr-2 text-blue-500"></i>After recording, download your answer and upload it. If the upload doesn't work, save the downloaded files.</p>
                      <p><i class="fas fa-award mr-2 text-yellow-500"></i>You must complete all 9 topics to get the Certificate of Completion as proof you finished the homework.</p>
                 </div>
                <div id="topic-selection" class="grid grid-cols-3 gap-4">
                    <!-- Topic buttons will be injected here -->
                </div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden bg-white dark:bg-gray-800 rounded-2xl shadow-lg app-shell p-3 sm:p-4">
            <header class="flex-shrink-0">
                <div class="flex justify-between items-center mb-1">
                    <button id="back-to-topics-btn" class="text-indigo-500 hover:text-indigo-700"><i class="fas fa-arrow-left mr-2"></i>Topics</button>
                </div>
                <!-- Timer Display -->
                <div class="relative w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-2 flex-shrink-0">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200 dark:text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="timer-progress" class="timer-circle text-indigo-500" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-2xl font-bold"></div>
                </div>
                <p id="phase-indicator" class="font-semibold text-indigo-500 dark:text-indigo-400 mb-2 text-base flex-shrink-0"></p>

                <!-- Question Display -->
                <div id="question-container" class="min-h-[50px] flex items-center justify-center mb-2">
                    <h2 id="question-text" class="text-base sm:text-lg font-semibold leading-relaxed text-left w-full"></h2>
                </div>
                
                <div id="error-message-box" class="hidden text-red-500 bg-red-100 dark:bg-red-900/50 p-2 rounded-lg text-sm mb-2"></div>

                <!-- Recording Action Buttons -->
                <div id="recording-actions-container" class="flex flex-col items-center justify-center mb-2">
                    <!-- Initial Record Button -->
                    <button id="record-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md transition-transform transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <!-- Stop Button -->
                    <button id="stop-record-btn" class="hidden bg-gray-700 hover:bg-gray-800 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md flex items-center justify-center">
                        <i class="fas fa-stop"></i>
                    </button>
                    <!-- Post-Recording Controls -->
                    <div id="post-recording-actions" class="hidden w-full flex-col items-center justify-center space-y-2 mt-2">
                        <audio id="audio-player" controls class="w-full max-w-xs"></audio>
                        <div class="flex items-center justify-center space-x-2 w-full max-w-xs">
                          <!-- Smart Download button -->
                          <button id="download-btn"
                                  class="flex-1 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md transition-colors flex items-center justify-center">
                            <i class="fas fa-download mr-1"></i>Download / Open
                          </button>
                        
                          <!-- Upload button -->
                          <a id="sharepoint-upload-link"
                             href="https://xichengacademy-my.sharepoint.com/:f:/g/personal/joelmitchell_xichengacademy_cn/EjxMFg8-baNEo5uuWUBc4EoBzn1DVWJ1Ym_NFx6hPlJ0dQ"
                             target="_blank"
                             rel="noopener noreferrer"
                             class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md flex items-center justify-center">
                            <i class="fas fa-upload mr-1"></i>Upload
                          </a>
                        </div>
                    </div>
                </div>
                 <div id="recording-status" class="hidden items-center justify-center text-red-500 font-semibold mb-1">
                      <div class="w-2 h-2 bg-red-500 rounded-full mr-2 recording-indicator"></div>
                      Recording...
                 </div>
            </header>
            
            <main class="flex-grow flex flex-col overflow-y-auto min-h-0 space-y-2 pt-2">
                 <!-- Sentence Starters -->
                <div id="starters-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Sentence Starters</h3>
                    <div id="starters-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Word Bank -->
                <div id="word-bank-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Word Bank</h3>
                    <div id="word-bank-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Sample Answers Display -->
                <div id="samples-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center flex-shrink-0">Sample Responses</h3>
                    <ul id="samples-list" class="space-y-2 list-disc list-inside bg-indigo-900/70 dark:bg-indigo-900/90 p-3 rounded-lg max-h-28 sm:max-h-32 overflow-y-auto">
                    </ul>
                </div>
            </main>

            <footer class="flex-shrink-0 mt-2">
                <!-- Next Button -->
                <div id="controls-container">
                     <button id="next-btn" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg text-lg shadow-md">Next</button>
                </div>
            </footer>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center">
            <div id="certificate-to-download" class="w-full bg-gray-50 dark:bg-gray-700 p-8 rounded-lg border-4 border-yellow-400 dark:border-yellow-500 text-center">
                <i class="fas fa-award text-6xl text-yellow-500 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Certificate of Completion</h1>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">This certificate is awarded to</p>
                <p id="certificate-name" class="text-4xl font-bold my-4 text-indigo-600 dark:text-indigo-400"></p>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">for successfully completing all 9 speaking practice topics.</p>
                <p class="text-sm mt-6 text-gray-500 dark:text-gray-400">Issued on: <span id="certificate-date"></span></p>
            </div>
            <button id="download-certificate-btn" class="mt-6 w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">
                <i class="fas fa-download mr-2"></i>Download Certificate
            </button>
             <button id="back-to-main-menu-btn" class="mt-3 text-sm text-indigo-500 hover:underline">Back to Main Menu</button>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA: Questions and Sample Answers ---
        const practiceData = {
            "Personal Info": [
                { 
                    question: "Tell me something about your hometown.", 
                    starters: ["My hometown, Beijing, is...", "It's famous for...", "What I like most is...", "One special thing about it is...", "It's a city with...", "If you visit, you should..."], 
                    wordBank: ["capital", "historic", "modern", "megacity", "landmarks", "Forbidden City", "Great Wall", "cuisine", "vibrant", "energetic"], 
                    samples: [
                        "My hometown is Beijing, the capital of China, and it's famous for its long history because you can find ancient sites like the Forbidden City.",
                        "I grew up in Beijing, which is a huge and bustling city. For example, the subway is always crowded with people going to work or visiting landmarks.",
                        "It's a very modern city with many skyscrapers, but it also has a lot of traditional culture. For instance, you can still visit the old hutongs."
                    ] 
                }
            ],
            "Languages": [
                { 
                    question: "What other languages apart from English would you like to learn?", 
                    starters: ["I would love to learn German because...", "I'm really interested in German since...", "Another language I'd like to try is German, as...", "Besides English, I plan to learn German...", "My goal is to become fluent in German...", "I've started learning some basic German..."], 
                    wordBank: ["Germany", "university", "future studies", "engineering", "culture", "opportunity", "efficient", "challenging", "grammar", "der, die, das"], 
                    samples: [
                        "I would love to learn German because I plan to study at a university there, so it will be essential for daily life and making new friends.",
                        "I'm interested in learning German since it will open up more job opportunities for me in Europe, especially in the engineering field.",
                        "I think German would be very useful, and I'm also excited to learn about the culture because I want to understand the local customs and traditions."
                    ] 
                }
            ],
            "Future Studies": [
                { 
                    question: "Why have you decided to study in Germany?", 
                    starters: ["I chose Germany because...", "The main reason I want to study in Germany is...", "Germany is my top choice due to...", "I was attracted to Germany's...", "One of the reasons is the high quality of...", "My decision was based on..."], 
                    wordBank: ["reputation", "education system", "tuition-free", "engineering", "innovation", "research opportunities", "high-quality", "prestigious universities", "culture", "central Europe"], 
                    samples: [
                        "I chose Germany because of its excellent reputation for engineering. For example, universities like RWTH Aachen are world-famous for automotive studies.",
                        "The main reason is that many top public universities in Germany offer free tuition for international students, which makes it a very affordable option for my family.",
                        "Germany is a leader in innovation and technology, which is perfect for my field of interest because I want to be involved in cutting-edge research."
                    ] 
                }
            ],
            "Travel": [
                { 
                    question: "Have you ever traveled to other countries?", 
                    starters: ["Yes, I have been to...", "No, I haven't yet, but I'm excited to...", "I once took a family trip to...", "I've had the chance to visit...", "My first trip abroad was to...", "I'm looking forward to my first trip to..."], 
                    wordBank: ["abroad", "Europe", "Asia", "visited", "trip", "Germany", "experience", "different cultures", "international", "passport"], 
                    samples: [
                        "I haven't had the chance to travel abroad yet, but I'm very excited about moving to Germany because it will be my first time living in a different country.",
                        "Yes, my family and I went to Thailand for a holiday last year. It was a great experience because we tried a lot of different food, like Tom Yum soup.",
                        "I once visited Singapore with my school, which was a great experience because I learned a lot about how different cultures can coexist in one city."
                    ] 
                }
            ],
            "Hobbies": [
                { 
                    question: "What do you enjoy doing in your free time?", 
                    starters: ["In my free time, I really enjoy...", "When I have some spare time, I like to...", "My main hobby is...", "To relax, I usually...", "I'm a big fan of...", "I spend a lot of my free time..."],
                    wordBank: ["gaming", "reading", "calligraphy", "instrument", "badminton", "basketball", "social media", "hanging out", "creative", "relaxing"],
                    samples: [
                        "I really enjoy playing basketball with my friends after school because it's a great way to exercise and work as a team.",
                        "In my free time, I like to practice Chinese calligraphy, which I find very relaxing because it requires a lot of focus and helps me clear my mind.",
                        "I'm a big fan of reading science fiction novels, for example, 'The Three-Body Problem', because they make me think about the future and technology."
                    ] 
                }
            ],
            "Education": [
                { 
                    question: "What is something new you would like to learn for your life abroad?", 
                    starters: ["Before I go abroad, I'd like to learn...", "I think it's important to learn how to...", "One practical skill I want to learn is...", "To prepare for living independently, I want to learn...", "I'm planning to learn...", "It would be useful to know how to..."],
                    wordBank: ["cooking", "budgeting", "time management", "basic repairs", "navigation", "independently", "practical skill", "self-sufficient", "responsible", "prepare"],
                    samples: [
                        "I would love to learn how to cook some simple dishes, like stir-fried tomatoes and eggs, because I don't want to eat instant noodles every day.",
                        "I want to learn how to manage my own budget because living alone means I'll have to be financially responsible for things like rent and food.",
                        "I think it's important to learn better time management skills, for example, using a planner, because I'll need to balance my studies and social life."
                    ] 
                }
            ],
            "Food": [
                {
                    question: "What is a popular dish from your country that you would recommend?",
                    starters: ["A classic dish you have to try is...", "I would definitely recommend...", "One of the most famous dishes is...", "If you visit Beijing, you must eat...", "A personal favorite of mine is...", "You can't talk about Chinese food without mentioning..."],
                    wordBank: ["Peking Duck", "dumplings (jiaozi)", "hotpot", "savory", "crispy", "aromatic", "regional cuisine", "spicy", "authentic", "flavorful"],
                    samples: [
                        "I would definitely recommend trying Peking Duck because it's a famous dish from Beijing with crispy skin and delicious meat, usually served with thin pancakes.",
                        "You have to try jiaozi, or dumplings, because they are a very important food in our culture, especially during Chinese New Year celebrations.",
                        "Hotpot is more than a meal, it's a social event where you cook meat and vegetables together with friends because it's all about sharing and conversation."
                    ]
                }
            ],
            "Friends & Family": [
                {
                    question: "How do you plan to keep in touch with your family and friends when you are in Germany?",
                    starters: ["I'm planning to use...", "I will make sure to schedule...", "Even though we'll be far apart, we can...", "Besides video calls, I will also...", "I think it will be important to...", "To avoid feeling homesick, I will..."],
                    wordBank: ["WeChat", "video calls", "schedule", "time difference", "regularly", "stay connected", "update", "homesick", "support system", "share experiences"],
                    samples: [
                        "I'll use WeChat to have regular video calls with my parents because it's the most convenient app for us to use, for example, every Saturday morning.",
                        "I plan to schedule calls with my friends, because it's important to consider the time difference between China and Germany so we find a time that works for everyone.",
                        "Besides calls, I will share photos of my new life in Germany because it's a good way for them to see what I am doing and feel connected to my experiences."
                    ]
                }
            ],
            "Cultural Differences": [
                {
                    question: "What do you think will be the biggest cultural difference between China and Germany?",
                    starters: ["I expect the biggest difference will be...", "I've heard that German culture is very...", "Compared to China, I think...", "I might need to get used to...", "One thing I'm curious about is...", "I'm preparing myself for..."],
                    wordBank: ["punctuality", "directness", "individualism", "formality", "food culture", "social etiquette", "personal space", "work-life balance", "adapt", "open-minded"],
                    samples: [
                        "I think the biggest cultural difference will be the directness in communication because I've heard Germans are very straightforward, which is different from our more indirect style.",
                        "I expect I will have to get used to the emphasis on punctuality because being on time is extremely important there. For example, trains are almost always on schedule.",
                        "Compared to China, I think the university system will be different because it's more focused on independent study and requires more self-discipline from students."
                    ]
                }
            ]
        };

        // --- DOM Elements ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const welcomeScreen = document.getElementById('welcome-screen');
        const practiceScreen = document.getElementById('practice-screen');
        const nameEntryContainer = document.getElementById('name-entry-container');
        const nameInput = document.getElementById('name-input');
        const startWithNameBtn = document.getElementById('start-with-name-btn');
        const topicSelectionContainer = document.getElementById('topic-selection-container');
        const userNameDisplay = document.getElementById('user-name-display');
        const topicSelection = document.getElementById('topic-selection');
        const nextBtn = document.getElementById('next-btn');
        const backToTopicsBtn = document.getElementById('back-to-topics-btn');
        
        const timerDisplay = document.getElementById('timer-display');
        const timerProgress = document.getElementById('timer-progress');
        const phaseIndicator = document.getElementById('phase-indicator');
        
        const questionContainer = document.getElementById('question-container');
        const questionText = document.getElementById('question-text');
        const samplesContainer = document.getElementById('samples-container');
        const samplesList = document.getElementById('samples-list');
        const startersContainer = document.getElementById('starters-container');
        const startersList = document.getElementById('starters-list');
        const wordBankContainer = document.getElementById('word-bank-container');
        const wordBankList = document.getElementById('word-bank-list');
        const errorMessagebox = document.getElementById('error-message-box');

        const recordBtn = document.getElementById('record-btn');
        const stopRecordBtn = document.getElementById('stop-record-btn');
        const audioPlayer = document.getElementById('audio-player');
        const recordingStatus = document.getElementById('recording-status');
        const postRecordingActions = document.getElementById('post-recording-actions');
        const downloadBtn = document.getElementById('download-btn');
        
        // Certificate UI
        const certificateScreen = document.getElementById('certificate-screen');
        const downloadCertificateBtn = document.getElementById('download-certificate-btn');
        const backToMainMenuBtn = document.getElementById('back-to-main-menu-btn');


        // --- State Variables ---
        let userName = '';
        let currentQuestionIndex = 0;
        let currentQuestions = [];
        let timerInterval;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;
        let completedTopics = {};
        let speechRecognition;
        let finalTranscript = '';

        const FULL_DASH_ARRAY = 283;
        const DEFAULT_RESPONSE_TIME = 60;
        const READ_TIME = 60;

        // --- Text-to-Speech ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;
        let ttsInitialized = false;

        function initializeTTS() {
            return new Promise((resolve) => {
                if (!synth) {
                    ttsInitialized = true;
                    return resolve();
                }

                const setBestVoice = () => {
                    const voices = synth.getVoices();
                    if (voices.length === 0) return;
                    
                    const scoreVoice = (voice) => {
                        let score = 0;
                        const name = voice.name.toLowerCase();
                        if (name.includes('natural')) score += 5;
                        if (name.includes('brian') || name.includes('emma')) score += 4;
                        if (name.includes('microsoft')) score += 3;
                        if (name.includes('google')) score += 2;
                        if (voice.localService) score += 1;
                        return score;
                    };

                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    if (englishVoices.length > 0) {
                        englishVoices.sort((a, b) => scoreVoice(b) - scoreVoice(a));
                        preferredVoice = englishVoices[0];
                    }
                    
                    ttsInitialized = true;
                    resolve();
                };

                if (synth.getVoices().length > 0) {
                    setBestVoice();
                } else {
                    synth.onvoiceschanged = setBestVoice;
                }
            });
        }

        function speak(text, isFeedback = false) {
            if (!ttsInitialized) return;
            try {
                if (synth.speaking) synth.cancel();
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.onerror = (event) => console.error('SpeechSynthesisUtterance.onerror', event);
                if (preferredVoice) utterThis.voice = preferredVoice;
                utterThis.pitch = 1;  
                utterThis.rate = 0.85; // Slow down speech as requested
                synth.speak(utterThis);
            } catch (e) {
                console.error("Speech synthesis failed:", e);
            }
        }

        // --- Local Storage ---
        function loadProgress() {
            const savedCompletedTopics = localStorage.getItem('languagePracticeCompletedTopics');
            if (savedCompletedTopics) {
                try {
                    completedTopics = JSON.parse(savedCompletedTopics);
                } catch (e) {
                    console.error("Failed to parse saved progress:", e);
                    completedTopics = {}; // Reset progress if data is corrupt
                }
            }
            const savedName = localStorage.getItem('languagePracticeUserName');
            if (savedName) {
                 userName = savedName;
                 nameInput.value = userName;
            }
        }

        function saveProgress() {
            localStorage.setItem('languagePracticeCompletedTopics', JSON.stringify(completedTopics));
            if(userName) localStorage.setItem('languagePracticeUserName', userName);
        }

        // --- UI Initialization ---
        function initializeTopics() {
            topicSelection.innerHTML = '';
            for (const topic in practiceData) {
                const button = document.createElement('button');
                
                let checkmark = '';
                if (completedTopics[topic]) {
                    checkmark = `<i class="fas fa-check-circle text-green-500 ml-2"></i>`;
                    button.className = "w-full bg-green-100 dark:bg-green-900/50 p-2 rounded-lg shadow-md hover:bg-green-200 dark:hover:bg-green-800/60 transition-colors flex items-center justify-center";
                } else {
                    button.className = "w-full bg-white dark:bg-gray-700 p-2 rounded-lg shadow-md hover:bg-indigo-100 dark:hover:bg-indigo-800 transition-all transform hover:scale-105 flex items-center justify-center";
                }

                button.innerHTML = `<span class="text-sm font-semibold">${topic}</span> ${checkmark}`;
                button.dataset.topic = topic;
                button.addEventListener('click', () => startPractice(topic));
                topicSelection.appendChild(button);
            }
        }

        // --- Core App Logic ---
        function startPractice(topic) {
            currentQuestions = practiceData[topic];
            currentQuestions.topicName = topic;
            currentQuestionIndex = 0;
            welcomeScreen.classList.add('hidden');
            practiceScreen.classList.remove('hidden');
            certificateScreen.classList.add('hidden');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                phaseIndicator.textContent = "Topic Complete!";
                questionText.textContent = "You've finished this topic. Well done!";
                completedTopics[currentQuestions.topicName] = true;
                saveProgress();
                checkAllTopicsCompleted();
                resetRecordingUI();
                nextBtn.classList.add('hidden');
                speak("You've completed this topic! Well done.");
                return;
            }

            const item = currentQuestions[currentQuestionIndex];
            resetUIForNewQuestion();
            
            let fullQuestion = (item.intro ? item.intro + " " : "") + item.question;
            questionText.textContent = fullQuestion;
            questionText.classList.add('fade-in');
            setTimeout(() => questionText.classList.remove('fade-in'), 500);

            speak(fullQuestion);
            
            // Populate Sentence Starters
            if (item.starters && item.starters.length > 0) {
                startersList.innerHTML = '';
                item.starters.forEach(starter => {
                    const button = document.createElement('button');
                    button.className = 'bg-indigo-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-indigo-600 dark:text-white cursor-default';
                    button.textContent = starter;
                    startersList.appendChild(button);
                });
                startersContainer.classList.remove('hidden');
            }

            // Populate Word Bank
            if (item.wordBank && item.wordBank.length > 0) {
                wordBankList.innerHTML = '';
                item.wordBank.forEach(word => {
                    const button = document.createElement('button');
                    button.className = 'bg-green-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-green-600 dark:text-white cursor-default';
                    button.textContent = word;
                    wordBankList.appendChild(button);
                });
                wordBankContainer.classList.remove('hidden');
            }

            const responseTime = item.timer || DEFAULT_RESPONSE_TIME;
            phaseIndicator.textContent = "Prepare & Record";
            startTimer(responseTime, showSampleAnswersAndStartReadTimer);
        }

        function showSampleAnswersAndStartReadTimer() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
            
            phaseIndicator.textContent = "Review";
            recordBtn.disabled = true;
            recordBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const item = currentQuestions[currentQuestionIndex];
            if (item.samples && item.samples.length > 0) {
                samplesList.innerHTML = '';
                item.samples.forEach(sample => {
                    const li = document.createElement('li');
                    li.textContent = sample;
                    // Changed to white text as requested
                    li.className = 'text-white text-sm sm:text-base';
                    samplesList.appendChild(li);
                });
                samplesContainer.classList.remove('hidden');
            }


            startTimer(READ_TIME, () => {
                phaseIndicator.textContent = "Time's up!";
                nextBtn.classList.remove('hidden');
            });
        }
        
        // --- Certificate Logic ---
        function checkAllTopicsCompleted() {
            const totalTopics = Object.keys(practiceData).length;
            const completedCount = Object.keys(completedTopics).length;
            if (completedCount === totalTopics) {
                showCertificate();
            }
        }
        
        function showCertificate() {
            practiceScreen.classList.add('hidden');
            welcomeScreen.classList.add('hidden');
            certificateScreen.classList.remove('hidden');
            document.getElementById('certificate-name').textContent = userName;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
        }
        
        function showErrorMessage(message) {
            errorMessagebox.textContent = message;
            errorMessagebox.classList.remove('hidden');
            setTimeout(() => {
                errorMessagebox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        // --- Recording & Transcription Logic ---
        async function startRecording() {
            if (!window.MediaRecorder) {
                showErrorMessage("Audio recording is not supported on this browser.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const isEdge = window.navigator.userAgent.includes("Edg");
                let options = {};
                if (!isEdge) {
                    const mimeTypes = ['audio/webm;codecs=opus', 'audio/ogg;codecs=opus', 'audio/webm', 'audio/ogg'];
                    const supportedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
                    if (supportedType) options.mimeType = supportedType;
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.start();
                startTranscription();

                recordBtn.classList.add('hidden');
                stopRecordBtn.classList.remove('hidden');
                recordingStatus.classList.remove('hidden');

                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    recordedBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedBlob);
                    audioPlayer.src = audioUrl;
                    postRecordingActions.classList.remove('hidden');
                    recordingStatus.classList.add('hidden');
                    stopRecordBtn.classList.add('hidden');
                    recordBtn.classList.add('hidden');
                });
            } catch (err) {
                console.error("Error starting recording:", err);
                showErrorMessage("Could not start audio recording. Please grant microphone permission.");
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
            if (speechRecognition) {
                speechRecognition.stop();
            }
        }

        function startTranscription() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("Speech recognition not supported.");
                return;
            }

            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';
            finalTranscript = '';

            speechRecognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
            };
            
            speechRecognition.onerror = (event) => {
                 console.error('Speech recognition error detected: ' + event.error);
            }

            speechRecognition.start();
        }

        // --- Timer Functions ---
        function startTimer(duration, onEndCallback) {
            let timeLeft = duration;
            clearInterval(timerInterval);
            updateTimerDisplay(timeLeft, duration);

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft, duration);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if(onEndCallback) onEndCallback();
                }
            }, 1000);
        }

        function updateTimerDisplay(timeLeft, totalDuration) {
            const minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            if (seconds < 10) seconds = `0${seconds}`;
            timerDisplay.textContent = `${minutes}:${seconds}`;
            
            const fraction = timeLeft / totalDuration;
            const offset = fraction * FULL_DASH_ARRAY;
            timerProgress.style.strokeDashoffset = FULL_DASH_ARRAY - offset;
        }

        // --- UI Helper Functions ---
        function resetUIForNewQuestion() {
            samplesContainer.classList.add('hidden');
            startersContainer.classList.add('hidden');
            wordBankContainer.classList.add('hidden');
            nextBtn.classList.add('hidden');
            errorMessagebox.classList.add('hidden');
            recordBtn.disabled = false;
            recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            resetRecordingUI();
        }

        function resetRecordingUI() {
            recordBtn.classList.remove('hidden');
            stopRecordBtn.classList.add('hidden');
            recordingStatus.classList.add('hidden');
            postRecordingActions.classList.add('hidden');
            audioPlayer.src = '';
            audioChunks = [];
            recordedBlob = null;
            finalTranscript = '';
        }

        // --- Theme Toggle Logic ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        };
        
        // --- Snowfall Logic ---
        function createSnow() {
            const snowContainer = document.getElementById('snow-container');
            const snowflakeCount = 50;
            for (let i = 0; i < snowflakeCount; i++) {
                let snowflake = document.createElement('div');
                snowflake.innerHTML = '❄';
                snowflake.classList.add('snowflake');
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.animationDuration = Math.random() * 5 + 5 + 's'; // 5-10 seconds
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                snowflake.style.fontSize = Math.random() * 1.5 + 0.5 + 'em';
                snowflake.style.opacity = Math.random();
                snowContainer.appendChild(snowflake);
            }
        }


        // --- Event Listeners ---
        startWithNameBtn.addEventListener('click', () => {
            userName = nameInput.value.trim();
            if (userName) {
                saveProgress();
                nameEntryContainer.classList.add('hidden');
                userNameDisplay.textContent = userName;
                topicSelectionContainer.classList.remove('hidden');
            } else {
                // Using a custom message box instead of alert()
                const nameError = document.createElement('div');
                nameError.textContent = "Please enter your name.";
                nameError.className = "text-red-500 text-sm mt-2";
                startWithNameBtn.insertAdjacentElement('afterend', nameError);
                setTimeout(() => nameError.remove(), 2000);
            }
        });

        recordBtn.addEventListener('click', startRecording);
        stopRecordBtn.addEventListener('click', stopRecording);
        
        downloadCertificateBtn.addEventListener('click', () => {
            const certificateNode = document.getElementById('certificate-to-download');
            html2canvas(certificateNode, { scale: 2 }).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = `Certificate_of_Completion_${userName.replace(/\s+/g, '_')}.png`;
                a.click();
            });
        });

        backToMainMenuBtn.addEventListener('click', () => {
            certificateScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            initializeTopics();
        });

        downloadBtn.addEventListener('click', () => {
            if (recordedBlob) {
              const topicName = currentQuestions.topicName.replace(/\s+/g, '_');
              const sanitizedUserName = userName.replace(/\s+/g, '_');
              const fileName = `${sanitizedUserName}_${topicName}_Q${currentQuestionIndex + 1}.webm`;
              const a = document.createElement('a');
              a.style.display = 'none';
              a.href = URL.createObjectURL(recordedBlob);
              a.download = fileName;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
          
              // Visual feedback
              const originalText = downloadBtn.innerHTML;
              downloadBtn.innerHTML = `<i class="fas fa-check mr-1"></i>Downloaded!`;
              downloadBtn.classList.remove('bg-slate-600', 'hover:bg-slate-700');
              downloadBtn.classList.add('bg-emerald-600');
              setTimeout(() => {
                downloadBtn.innerHTML = originalText;
                downloadBtn.classList.remove('bg-emerald-600');
                downloadBtn.classList.add('bg-slate-600', 'hover:bg-slate-700');
              }, 2000);
            } else {
              // No recording — open the SharePoint folder
              window.open(
                'https://xichengacademy-my.sharepoint.com/:f:/g/personal/joelmitchell_xichengacademy_cn/EjxMFg8-baNEo5uuWUBc4EoBzn1DVWJ1Ym_NFx6hPlJ0dQ',
                '_blank'
              );
            }
        });

        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            showQuestion();
        });

        backToTopicsBtn.addEventListener('click', () => {
            practiceScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            clearInterval(timerInterval);
            initializeTopics();
        });
        
        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
            applyTheme(isDark ? 'dark' : 'light');
        });

        // --- Initial Load ---
        async function main() {
            // Set initial theme
            const savedTheme = localStorage.getItem('color-theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                // If no theme saved, use system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    applyTheme('dark');
                } else {
                    applyTheme('light');
                }
            }
            
            // iOS tweak: open SharePoint in same tab
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
                const sharepointLink = document.getElementById('sharepoint-upload-link');
                if (sharepointLink) {
                    sharepointLink.removeAttribute('target');
                }
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !SpeechRecognition) {
                recordBtn.disabled = true;
                recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                recordBtn.title = "Audio recording or recognition is not supported on this browser.";
            }
            if (!window.speechSynthesis) {
                 console.warn("Text-to-speech is not supported on this browser.");
            }
            
            await initializeTTS().catch(err => console.error(err));
            
            createSnow();
            loadProgress();
            initializeTopics();
        }
        
        main();

        // iOS tweak: open SharePoint in same tab
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (isIOS) {
            const sharepointLink = document.getElementById('sharepoint-upload-link');
            if(sharepointLink) {
                sharepointLink.removeAttribute('target');
            }
        }
    });
    </script>
</body>
</html>
