<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troubled Waters: Uranium, Rights & Heritage</title>
    <meta name="description" content="Interactive lesson on Uranium mining in the Grand Canyon for secondary students.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        canyon: {
                            50: '#fdf8f6',
                            100: '#f2e8e5',
                            200: '#eaddd7',
                            300: '#e0cec7',
                            400: '#d2bab0',
                            500: '#a18072',
                            600: '#9a3412', // primary brand
                            700: '#7c2d12',
                            800: '#431407',
                            900: '#2a0a04',
                        }
                    },
                    animation: {
                        'float-up': 'floatUp 15s linear forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        floatUp: {
                            '0%': { transform: 'translateY(100vh) scale(0.8)', opacity: '0' },
                            '10%': { opacity: '0.8' },
                            '90%': { opacity: '0.8' },
                            '100%': { transform: 'translateY(-10vh) scale(1.1)', opacity: '0' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Utilities */
        body {
            background-color: #f5f5f4;
            background-image: linear-gradient(to bottom, #fff7ed, #e7e5e4);
            min-height: 100vh;
        }

        html { scroll-behavior: smooth; }

        /* Focus styles */
        button:focus-visible, a:focus-visible {
            outline: 3px solid #f97316;
            outline-offset: 2px;
        }

        /* Interactive Elements */
        .interactive-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        .interactive-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            background-color: #fffaf0; /* Light orange tint on hover */
        }
        .interactive-card:active {
            transform: scale(0.98);
        }

        /* Gap Fill Styles */
        .gap-slot {
            display: inline-block;
            min-width: 100px;
            border-bottom: 2px solid #9a3412;
            padding: 0 8px;
            color: #9a3412;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        .gap-slot.filled { background-color: #ffedd5; }
        .gap-slot.correct { background-color: #dcfce7; border-color: #16a34a; color: #166534; }
        .gap-slot.incorrect { background-color: #fee2e2; border-color: #dc2626; color: #991b1b; }

        .word-bank-item.selected {
            background-color: #fb923c;
            color: white;
            transform: scale(1.05);
        }

        @media print {
            .no-print { display: none !important; }
            #printable-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
        }
    </style>
</head>
<body class="text-stone-800 antialiased selection:bg-orange-200 selection:text-orange-900">

    <!-- Floating Atmosphere -->
    <div id="atmosphere" class="fixed inset-0 pointer-events-none z-0 overflow-hidden" aria-hidden="true"></div>

    <!-- HEADER NAVIGATION -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-md border-b border-stone-200 shadow-md h-20">
        <div class="max-w-6xl mx-auto px-4 h-full flex items-center justify-between">
            
            <!-- Left: Home & Title -->
            <div class="flex items-center gap-4">
                <button onclick="app.nav.goHome()" class="p-3 rounded-full hover:bg-stone-100 text-canyon-700 transition-colors" aria-label="Home">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </button>
                <div class="hidden sm:block">
                    <h1 class="text-base font-bold text-canyon-800 uppercase tracking-widest">Troubled Waters</h1>
                    <div class="h-1.5 w-32 bg-stone-200 rounded-full mt-1 overflow-hidden">
                        <div id="progress-bar-fill" class="h-full bg-canyon-600 w-0 transition-all duration-500"></div>
                    </div>
                </div>
            </div>

            <!-- Center: Navigation Controls -->
            <div class="flex items-center gap-3">
                <button onclick="app.nav.prev()" id="btn-prev" class="flex items-center gap-2 px-4 py-2 rounded-full font-bold text-stone-600 bg-stone-100 hover:bg-stone-200 disabled:opacity-30 disabled:cursor-not-allowed transition-all">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
                    <span class="hidden md:inline">Back</span>
                </button>
                
                <span id="page-indicator" class="text-sm font-mono text-stone-400 w-16 text-center">1/14</span>

                <button onclick="app.nav.next()" id="btn-next" class="flex items-center gap-2 px-6 py-2 rounded-full font-bold text-white bg-canyon-600 hover:bg-canyon-700 shadow-md hover:shadow-lg disabled:opacity-50 disabled:bg-stone-300 transition-all">
                    <span class="hidden md:inline">Next</span>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
                </button>
            </div>

            <!-- Right: Score -->
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 bg-orange-50 px-4 py-2 rounded-full border border-orange-200 shadow-sm">
                    <span class="text-xl" aria-hidden="true">üåü</span>
                    <span id="score-display" class="font-bold text-orange-800 text-lg tabular-nums">0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="app-container" class="relative z-10 max-w-5xl mx-auto pt-28 pb-12 px-4 md:px-8 min-h-screen flex flex-col items-center justify-start">
        <!-- Injected via JS -->
    </main>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 pointer-events-none flex flex-col items-center gap-2"></div>

    <script>
        const LessonData = {
            menu: [
                { id: 'intro', type: 'cover' },
                { id: 'framework', type: 'text' },
                { id: 'vocab', type: 'vocab-deck' },
                { id: 'reading-1', type: 'article-1' },
                { id: 'quiz-gap', type: 'gap-fill' },
                { id: 'reading-2', type: 'article-2' },
                { id: 'quiz-tf', type: 'quiz-tf' },
                { id: 'quiz-mcq', type: 'quiz-mcq' },
                { id: 'listening-1', type: 'dialogue-1' },
                { id: 'listening-1-quiz', type: 'quiz-mcq-grid' }, 
                { id: 'listening-2', type: 'dialogue-2' },
                { id: 'listening-2-quiz', type: 'quiz-mcq-grid' }, 
                { id: 'roleplay', type: 'activity' },
                { id: 'certificate', type: 'certificate' }
            ],
            content: {
                intro: {
                    title: "Troubled Waters",
                    subtitle: "Uranium, Rights & Heritage",
                    text: "In this unit, we explore the conflict surrounding uranium mining near the Grand Canyon. Tap any text to hear it read aloud.",
                    tags: ["Ethics", "Geology", "Culture"]
                },
                framework: {
                    title: "Core Framework",
                    html: `
                        <div class="grid md:grid-cols-2 gap-6 interactive-card p-6 bg-white rounded-xl border border-stone-200" onclick="app.audio.speak(this.innerText, 'Emma')">
                            <section>
                                <h3 class="text-lg font-bold text-canyon-600 mb-3"><span aria-hidden="true">üéØ</span> Objectives</h3>
                                <ul class="space-y-2 list-disc list-inside">
                                    <li>Explain the significance of the <strong>Grand Canyon</strong>.</li>
                                    <li>Evaluate the risks of <strong>uranium mining</strong>.</li>
                                    <li>Analyze <strong>Indigenous Sovereignty</strong>.</li>
                                </ul>
                            </section>
                            <section>
                                <h3 class="text-lg font-bold text-canyon-600 mb-3"><span aria-hidden="true">ü§î</span> Essential Question</h3>
                                <blockquote class="italic text-stone-600 text-lg border-l-4 border-canyon-300 pl-4">
                                    "How do we balance the need for clean energy with the duty to protect cultural heritage?"
                                </blockquote>
                            </section>
                        </div>
                    `
                },
                vocab: {
                    title: "Key Vocabulary",
                    words: [
                        { w: "Canyon", ipa: "/Ààk√¶nj…ôn/", d: "A deep gorge, typically with a river flowing through it." },
                        { w: "Plateau", ipa: "/pl√¶Ààto ä/", d: "An area of relatively high ground." },
                        { w: "Uranium", ipa: "/j äÀàre…™ni…ôm/", d: "A chemical element used as fuel in nuclear reactors." },
                        { w: "Nuclear", ipa: "/ÀànuÀêkli…ôr/", d: "Relating to the energy released by fusion or fission." },
                        { w: "Tribe", ipa: "/tra…™b/", d: "A social division in a traditional society." },
                        { w: "Ecosystem", ipa: "/ÀàiÀêko äÀås…™st…ôm/", d: "A biological community interacting with its environment." },
                        { w: "Contamination", ipa: "/k…ônÀåt√¶m…™Ààne…™ É…ôn/", d: "The action of making something impure or poisonous." },
                        { w: "Heritage", ipa: "/Ààher…™t…™d í/", d: "Property or traditions that are inherited." },
                        { w: "Extraction", ipa: "/…™kÀàstr√¶k É…ôn/", d: "The action of taking something out, especially with effort." },
                        { w: "Resilience", ipa: "/r…™Ààz…™li…ôns/", d: "The capacity to recover quickly from difficulties." }
                    ]
                },
                'reading-1': {
                    title: "Reading: Troubled Waters",
                    html: `
                        <article class="prose prose-stone max-w-none text-lg leading-relaxed interactive-card p-8 bg-white rounded-xl shadow-sm border border-stone-200" onclick="app.audio.speak(this.innerText, 'Emma')">
                            <h3 class="text-2xl font-bold text-canyon-800 mb-4">The "Swiss Cheese" Risk</h3>
                            <p class="mb-4">Imagine the earth beneath the Grand Canyon not as solid rock, but as a block of <strong>Swiss cheese</strong>‚Äîfull of holes, cracks, and vertical columns. This is the central argument of the Havasupai Tribe against the Pinyon Plain Uranium Mine.</p>
                            
                            <p class="mb-4">The tribe relies on the <strong>Redwall Aquifer</strong>, a deep underground water source. They fear that mining the uranium in the "breccia pipes" (vertical rock columns) will pierce protective layers. If the rock is fractured like Swiss cheese, contaminated water could flow rapidly into their drinking supply.</p>
                            
                            <h3 class="text-2xl font-bold text-canyon-800 mt-8 mb-4">The Clean Energy Paradox</h3>
                            <p>Here lies the global dilemma. To fight climate change, the world needs carbon-free energy like nuclear power, which requires uranium. The mining company argues that extraction here creates energy independence. But the Havasupai ask: <em>"Is it clean energy if it destroys our heritage and poisons our ecosystem?"</em></p>
                        </article>
                    `
                },
                'reading-2': {
                    title: "Deep Dive: The Sacred & The Science",
                    html: `
                        <article class="prose prose-stone max-w-none text-lg leading-relaxed interactive-card p-8 bg-white rounded-xl shadow-sm border border-stone-200" onclick="app.audio.speak(this.innerText, 'Emma')">
                            <p class="mb-4 italic text-canyon-700">"Lightly frosted with snow, the peaks of Red Butte look particularly beautiful today," remarks Dianna Sue White Dove Uqualla, an elder of the Havasupai Tribe.</p>
                            
                            <p class="mb-4">This land is sacred. It was once a hub of ceremony and prayer, but tribal members rarely visit now‚Äînot since the mine started to extract uranium just 10 kilometers away. The tribe calls themselves <em>Havasu Baaja</em>, meaning "people of the blue-green waters." They fear contamination will destroy their only water source.</p>
                            
                            <h3 class="text-xl font-bold text-stone-800 mt-6 mb-2">The Geological Debate</h3>
                            <p class="mb-4">The state granted a permit assuming the rock was "impermeable" (solid). However, scientists like Dr. Laura Crossey argue that fractures connect the upper and lower aquifers. She likens these fractures to "highways" that can move water fast and far. Exploratory drilling may have turned the rock into "Swiss cheese," increasing the risk.</p>
                        </article>
                    `
                },
                'quiz-gap': {
                    title: "Gap Fill Challenge",
                    sentences: [
                        { parts: ["The Grand", "is one of the deepest in the world."], ans: "Canyon" },
                        { parts: ["The Colorado", "is rich in geological history."], ans: "plateau" },
                        { parts: ["Mining can damage the fragile", "."], ans: "ecosystem" },
                        { parts: ["Water", "is a major concern near mines."], ans: "contamination" },
                        { parts: ["The tribe shows", "in protecting their land."], ans: "resilience" }
                    ],
                    bank: ["ecosystem", "Canyon", "resilience", "plateau", "contamination"]
                },
                'quiz-tf': {
                    title: "True or False?",
                    questions: [
                        { q: "Uranium is used as fuel in nuclear reactors.", a: true },
                        { q: "The 'Swiss Cheese' theory says the rock is perfectly solid.", a: false },
                        { q: "The Havasupai Tribe relies on the Redwall Aquifer.", a: true },
                        { q: "Drilling can create 'highways' for water to move fast.", a: true }
                    ]
                },
                'quiz-mcq': {
                    title: "Multiple Choice Check",
                    questions: [
                        { q: "What is a 'breccia pipe'?", options: ["A musical instrument", "A vertical column of broken rock", "A water hose", "A government law"], a: 1 },
                        { q: "What does 'Havasu Baaja' mean?", options: ["People of the blue-green waters", "People of the red rock", "People of the sun", "Miners of the canyon"], a: 0 },
                        { q: "Why is uranium mined?", options: ["To make jewelry", "For nuclear energy fuel", "To build roads", "For farming"], a: 1 },
                        { q: "What is the main aquifer called?", options: ["Redwall Aquifer", "Colorado River", "Blue Spring", "Muddy Creek"], a: 0 }
                    ]
                },
                'listening-1': {
                    title: "Town Hall Hearing",
                    script: [
                        { s: "Henderson", v: "Andrew", t: "Thank you. I want to be clear: clean energy is the future. Our uranium provides carbon-free electricity. The rock is impermeable. There is zero evidence of contamination." },
                        { s: "Elena", v: "Emma", t: "Zero evidence? You speak of models. We speak of history. The 'Swiss Cheese' geology means you cannot guarantee safety. Once the water is poisoned, you cannot fix it." },
                        { s: "Henderson", v: "Andrew", t: "Ms. Elena, that was the past. Modern mining uses state-of-the-art technology. We monitor everything." },
                        { s: "Elena", v: "Emma", t: "Monitoring is just watching a disaster happen. We demand the Precautionary Principle: if it might cause harm, do not do it." }
                    ]
                },
                'listening-1-quiz': {
                    title: "Town Hall Comprehension",
                    questions: [
                        { q: "What is Mr. Henderson's main argument?", options: ["Mining is fun", "Rock is impermeable/safe", "It costs too much", "The tribe agrees"], a: 1 },
                        { q: "What does Elena call 'watching a disaster'?", options: ["Mining", "Monitoring", "Drilling", "Voting"], a: 1 },
                        { q: "What principle does Elena demand?", options: ["Precautionary Principle", "Economic Growth", "Scientific Method", "Legal Action"], a: 0 },
                        { q: "What technology does Henderson mention?", options: ["Solar panels", "Monitoring wells", "Wind turbines", "Drones"], a: 1 }
                    ]
                },
                'listening-2': {
                    title: "Podcast: The Uranium Debate",
                    script: [
                        { s: "Naya", v: "Emma", t: "Thank you, Michael. This is a critical discussion about irreversible harms to our environment." },
                        { s: "Michael", v: "Andrew", t: "Some say mining provides necessary jobs and energy security. What is your concern?" },
                        { s: "Naya", v: "Emma", t: "My main concern is the long-term risk. Radioactive contamination lasts for thousands of years. It's not just about the canyon; it's about the people living there." },
                        { s: "Michael", v: "Andrew", t: "But companies claim it's profitable. Is it?" },
                        { s: "Naya", v: "Emma", t: "It's often a false economy. The cleanup costs usually fall on taxpayers, costing billions. The financial burden outweighs the short-term profit." }
                    ]
                },
                'listening-2-quiz': {
                    title: "Podcast Comprehension",
                    questions: [
                        { q: "What is Naya's main concern?", options: ["Jobs", "Long-term risk", "Energy prices", "Traffic"], a: 1 },
                        { q: "Who usually pays for cleanup?", options: ["The company", "Taxpayers", "The tribe", "No one"], a: 1 },
                        { q: "Naya calls the profit a...", options: ["Great success", "False economy", "Big win", "Small loss"], a: 1 },
                        { q: "How long does contamination last?", options: ["A few days", "Thousands of years", "One month", "100 years"], a: 1 }
                    ]
                },
                roleplay: {
                    title: "Activity: 4 Corners",
                    html: `
                        <div class="interactive-card bg-white p-6 rounded-xl border border-stone-200 shadow-lg" onclick="app.audio.speak(this.innerText, 'Brian')">
                            <p class="mb-4 text-lg">Choose a corner based on who you agree with:</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                                    <span class="font-bold text-blue-800 block">The Tribe</span>
                                    <p class="text-sm">"Water is sacred. Risk is irreversible."</p>
                                </div>
                                <div class="p-4 bg-orange-50 border-l-4 border-orange-500 rounded">
                                    <span class="font-bold text-orange-800 block">The Company</span>
                                    <p class="text-sm">"We need clean energy. We follow the law."</p>
                                </div>
                                <div class="p-4 bg-green-50 border-l-4 border-green-500 rounded">
                                    <span class="font-bold text-green-800 block">Scientists</span>
                                    <p class="text-sm">"Data suggests fractures. We need more tests."</p>
                                </div>
                                <div class="p-4 bg-stone-100 border-l-4 border-stone-500 rounded">
                                    <span class="font-bold text-stone-600 block">Regulators</span>
                                    <p class="text-sm">"The permit is legal. We follow procedure."</p>
                                </div>
                            </div>
                        </div>
                    `
                },
                certificate: {
                    title: "Unit Completed",
                    text: "You have reviewed the evidence. You are now prepared for the final debate."
                }
            }
        };

        const App = {
            state: {
                idx: 0,
                score: 0,
                selectedWord: null
            },

            init() {
                this.render();
                this.bg();
            },

            nav: {
                next() {
                    if (App.state.idx < LessonData.menu.length - 1) {
                        App.state.idx++;
                        App.render();
                    }
                },
                prev() {
                    if (App.state.idx > 0) {
                        App.state.idx--;
                        App.render();
                    }
                },
                goHome() {
                    App.state.idx = 0;
                    App.render();
                }
            },

            audio: {
                synth: window.speechSynthesis,
                
                // Helper to find specific voices
                getVoice(name) {
                    const voices = this.synth.getVoices();
                    const n = name.toLowerCase();
                    
                    // Specific priority for Emma Microsoft Online Natural
                    if (n === 'emma') {
                        const microsoftEmma = voices.find(v => v.name.includes('Emma') && v.name.includes('Online (Natural)'));
                        if (microsoftEmma) return microsoftEmma;
                        return voices.find(v => v.name.includes('Female') || v.name.includes('Google US English'));
                    }

                    // Specific priority for Andrew Microsoft Online Natural
                    if (n === 'andrew') {
                        const microsoftAndrew = voices.find(v => v.name.includes('Andrew') && v.name.includes('Online (Natural)'));
                        if (microsoftAndrew) return microsoftAndrew;
                        return voices.find(v => v.name.includes('Male') && v.lang === 'en-US');
                    }

                    // Updated: Michael/Moderator (Brian) now prioritizes Multilingual Natural
                    if (n === 'brian') {
                        const multiNatural = voices.find(v => v.name.includes('Multilingual') && v.name.includes('Natural') && v.name.includes('Male'));
                        if (multiNatural) return multiNatural;
                        // Fallback to Ryan or just Multilingual if gender not specified in string
                        const ryan = voices.find(v => v.name.includes('Ryan') && v.name.includes('Multilingual'));
                        if (ryan) return ryan;
                        
                        return voices.find(v => v.name.includes('Great Britain') && v.name.includes('Male')) || voices.find(v => v.lang === 'en-GB');
                    }

                    if (n === 'ava') return voices.find(v => v.name.includes('Female') && v.lang === 'en-US' && !v.name.includes('Google'));
                    
                    return voices.find(v => v.lang.startsWith('en')) || voices[0];
                },

                speak(text, voiceName = null) {
                    if (this.synth.speaking) this.synth.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.rate = 0.85; // Slow down
                    if (voiceName) u.voice = this.getVoice(voiceName);
                    this.synth.speak(u);
                },

                playScript(script) {
                    if (this.synth.speaking) this.synth.cancel();
                    
                    let i = 0;
                    const nextLine = () => {
                        if (i >= script.length) return;
                        const line = script[i];
                        const u = new SpeechSynthesisUtterance(line.t);
                        u.rate = 0.85;
                        u.voice = this.getVoice(line.v);
                        
                        // Visual Highlight Logic
                        const bubbles = document.querySelectorAll('.dialogue-bubble');
                        if(bubbles[i]) {
                            bubbles.forEach(b => b.classList.remove('ring-4', 'ring-orange-300'));
                            bubbles[i].classList.add('ring-4', 'ring-orange-300');
                            bubbles[i].scrollIntoView({behavior: "smooth", block: "center"});
                        }

                        u.onend = () => {
                            i++;
                            nextLine();
                        };
                        this.synth.speak(u);
                    };
                    nextLine();
                }
            },

            render() {
                const pid = LessonData.menu[App.state.idx].id;
                const type = LessonData.menu[App.state.idx].type;
                const data = LessonData.content[pid];
                const container = document.getElementById('app-container');

                // Cancel any ongoing speech
                window.speechSynthesis.cancel();

                // Render based on type
                let html = '';

                if (type === 'cover') {
                    html = `
                        <div class="text-center animate-fade-in flex flex-col items-center justify-center h-full pt-10">
                            <div class="text-8xl mb-6">üèúÔ∏è</div>
                            <h1 class="text-5xl font-black text-canyon-800 mb-4">${data.title}</h1>
                            <p class="text-2xl text-canyon-600 font-serif italic mb-8">${data.subtitle}</p>
                            <div class="bg-white p-6 rounded-2xl shadow-lg border border-stone-200 max-w-xl interactive-card" onclick="app.audio.speak(this.innerText, 'Emma')">
                                <p class="text-lg text-stone-600">${data.text}</p>
                            </div>
                            <button onclick="app.nav.next()" class="mt-12 px-10 py-4 bg-canyon-600 text-white text-xl font-bold rounded-full shadow-xl hover:scale-105 transition-transform">Start Lesson</button>
                        </div>
                    `;
                } else if (type === 'text' || type === 'article-1' || type === 'article-2' || type === 'activity') {
                    html = `
                        <div class="w-full animate-fade-in">
                            <h2 class="text-3xl font-bold text-canyon-800 mb-6 text-center">${data.title}</h2>
                            ${data.html}
                        </div>
                    `;
                } else if (type === 'vocab-deck') {
                    html = `
                        <div class="w-full animate-fade-in">
                            <h2 class="text-3xl font-bold text-canyon-800 mb-6 text-center">Vocabulary Deck</h2>
                            <p class="text-center text-stone-500 mb-8">Click a card to hear pronunciation.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${data.words.map(w => `
                                    <div class="interactive-card bg-white p-5 rounded-lg border-l-4 border-canyon-500 shadow-sm" onclick="app.audio.speak('${w.w}. ${w.d}', 'Emma')">
                                        <div class="flex justify-between items-baseline mb-2">
                                            <h3 class="text-xl font-bold text-stone-800">${w.w}</h3>
                                            <span class="font-mono text-sm text-stone-400 bg-stone-100 px-2 rounded">${w.ipa}</span>
                                        </div>
                                        <p class="text-stone-600">${w.d}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (type === 'gap-fill') {
                    html = `
                        <div class="w-full animate-fade-in">
                            <h2 class="text-3xl font-bold text-canyon-800 mb-6 text-center">${data.title}</h2>
                            <div class="bg-white p-8 rounded-xl shadow-lg border border-stone-200">
                                <div class="space-y-6 mb-8 text-lg leading-loose">
                                    ${data.sentences.map((s, i) => `
                                        <div>
                                            ${i+1}. ${s.parts[0]} 
                                            <span class="gap-slot bg-stone-100 rounded" data-ans="${s.ans}" onclick="app.handlers.fillGap(this)">_____</span> 
                                            ${s.parts[1]||''}
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex flex-wrap gap-3 justify-center border-t pt-6">
                                    ${data.bank.map(w => `
                                        <button class="word-bank-item px-4 py-2 bg-stone-100 border border-stone-300 rounded-lg font-bold text-canyon-800 hover:bg-white" onclick="app.handlers.selectWord(this, '${w}')">${w}</button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (type === 'quiz-tf') {
                    html = `
                        <div class="w-full animate-fade-in max-w-3xl mx-auto">
                            <h2 class="text-3xl font-bold text-canyon-800 mb-6 text-center">${data.title}</h2>
                            <div class="space-y-4">
                                ${data.questions.map((q, i) => `
                                    <div class="bg-white p-4 rounded-xl border border-stone-200 shadow-sm flex items-center gap-6 interactive-card" onclick="app.audio.speak('${q.q}', 'Emma')">
                                        <div class="flex flex-col gap-2 shrink-0">
                                            <button onclick="app.handlers.check(this, ${q.a === true})" class="w-12 h-10 border-2 border-stone-300 rounded font-bold text-stone-500 hover:bg-stone-50 hover:border-canyon-400 transition-colors">T</button>
                                            <button onclick="app.handlers.check(this, ${q.a === false})" class="w-12 h-10 border-2 border-stone-300 rounded font-bold text-stone-500 hover:bg-stone-50 hover:border-canyon-400 transition-colors">F</button>
                                        </div>
                                        <p class="font-medium text-lg text-stone-800">${i+1}. ${q.q}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (type === 'quiz-mcq' || type === 'quiz-mcq-grid') {
                    html = `
                        <div class="w-full animate-fade-in max-w-5xl mx-auto">
                            <h2 class="text-3xl font-bold text-canyon-800 mb-6 text-center">${data.title}</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                ${data.questions.map((q, i) => `
                                    <div class="bg-white p-4 rounded-xl border border-stone-200 shadow-md flex flex-col interactive-card" onclick="app.audio.speak('${q.q}', 'Emma')">
                                        <p class="font-bold text-lg mb-2 text-canyon-800 border-b pb-2">${i+1}. ${q.q}</p>
                                        <div class="grid gap-2 mt-auto">
                                            ${q.options.map((opt, idx) => `
                                                <button onclick="app.handlers.check(this, ${idx === q.a})" class="text-left px-4 py-2 border-2 border-stone-100 rounded-lg hover:bg-orange-50 hover:border-orange-200 transition-all text-sm font-medium text-stone-600">${opt}</button>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (type === 'dialogue-1' || type === 'dialogue-2') {
                    html = `
                        <div class="w-full animate-fade-in max-w-3xl mx-auto">
                            <h2 class="text-3xl font-bold text-canyon-800 mb-6 text-center">${data.title}</h2>
                            <div class="space-y-6 pb-8">
                                ${data.script.map(line => `
                                    <div class="dialogue-bubble flex gap-4 ${line.s === 'Moderator' || line.s === 'Michael' ? 'flex-row-reverse' : ''}" onclick="app.audio.speak('${line.t.replace(/'/g, "\\'")}', '${line.v}')">
                                        <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center font-bold text-white shadow-sm ${
                                            line.s.includes('Henderson') ? 'bg-blue-600' : 
                                            line.s.includes('Elena') ? 'bg-amber-600' : 
                                            line.s.includes('Naya') ? 'bg-green-600' : 'bg-stone-400'
                                        }">
                                            ${line.s[0]}
                                        </div>
                                        <div class="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm max-w-[80%] cursor-pointer hover:bg-stone-50 active:scale-95 transition-all">
                                            <p class="text-lg leading-relaxed pointer-events-none">${line.t}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    // Auto-play script on load for dialogues
                    setTimeout(() => app.audio.playScript(data.script), 1000);
                } else if (type === 'certificate') {
                    html = `
                         <div id="printable-area" class="w-full flex flex-col items-center justify-center text-center animate-fade-in pt-10">
                            <div class="bg-white p-12 rounded-xl shadow-2xl border-8 double border-canyon-800 max-w-2xl relative">
                                <div class="absolute top-0 left-0 w-full h-4 bg-canyon-600"></div>
                                <h2 class="text-5xl font-serif font-bold text-canyon-800 mb-4">Certificate of Completion</h2>
                                <p class="text-stone-500 italic mb-8">This certifies that the student has successfully completed</p>
                                <h3 class="text-4xl font-bold text-canyon-600 mb-8 uppercase tracking-widest">Troubled Waters</h3>
                                <div class="w-full h-px bg-stone-300 mb-8"></div>
                                <div class="flex justify-between items-end w-full text-left">
                                    <div>
                                        <p class="text-xs uppercase text-stone-400">Final Score</p>
                                        <p class="text-3xl font-bold text-stone-800">${App.state.score} XP</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="h-10 w-32 border-b-2 border-stone-800 mb-1"></div>
                                        <p class="text-xs uppercase text-stone-400">Instructor Signature</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 flex gap-4 no-print">
                                <button onclick="window.print()" class="px-6 py-3 bg-stone-800 text-white rounded-lg font-bold hover:bg-black">Print Certificate</button>
                                <button onclick="app.nav.goHome()" class="px-6 py-3 bg-stone-200 text-stone-700 rounded-lg font-bold hover:bg-stone-300">Restart Lesson</button>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;
                App.ui.updateProgress();
            },

            bg() {
                // Background atmosphere
                const container = document.getElementById('atmosphere');
                setInterval(() => {
                    const el = document.createElement('div');
                    el.innerText = ['üèúÔ∏è','‚ö°','üíß','‚ò¢Ô∏è'][Math.floor(Math.random()*4)];
                    el.className = 'absolute text-4xl opacity-0 animate-float-up blur-[1px]';
                    el.style.left = Math.random() * 95 + 'vw';
                    container.appendChild(el);
                    setTimeout(() => el.remove(), 15000);
                }, 4000);
            },

            handlers: {
                selectWord(btn, word) {
                    // Deselect others
                    document.querySelectorAll('.word-bank-item').forEach(b => b.classList.remove('selected', 'ring-2', 'ring-orange-500'));
                    btn.classList.add('selected', 'ring-2', 'ring-orange-500');
                    App.state.selectedWord = word;
                    app.audio.speak(word, 'Emma');
                },
                fillGap(slot) {
                    if(!App.state.selectedWord) return;
                    if(slot.classList.contains('correct')) return;

                    if(slot.dataset.ans === App.state.selectedWord) {
                        slot.innerText = App.state.selectedWord;
                        slot.classList.add('correct');
                        slot.classList.remove('gap-slot'); // remove underline style
                        slot.className += " px-2 py-1 rounded bg-green-100 text-green-800 border border-green-300";
                        App.ui.toast("Correct!", "success");
                        App.state.score += 10;
                        document.getElementById('score-display').innerText = App.state.score;
                        
                        // Sound
                        const synth = new Tone.PolySynth().toDestination();
                        synth.triggerAttackRelease(["C5", "E5"], "8n");
                    } else {
                        slot.classList.add('incorrect');
                        setTimeout(() => slot.classList.remove('incorrect'), 500);
                        App.ui.toast("Try again.", "error");
                    }
                },
                check(btn, isCorrect) {
                    if(btn.disabled) return;
                    // Disable siblings
                    Array.from(btn.parentElement.children).forEach(c => {
                        c.disabled = true; 
                        c.classList.add('opacity-50');
                    });
                    btn.classList.remove('opacity-50');
                    
                    if(isCorrect) {
                        btn.classList.add('bg-green-100', 'border-green-500', 'text-green-900', 'font-bold');
                        App.state.score += 10;
                        document.getElementById('score-display').innerText = App.state.score;
                        App.ui.toast("Correct!", "success");
                         const synth = new Tone.PolySynth().toDestination();
                        synth.triggerAttackRelease(["C5", "G5"], "8n");
                    } else {
                        btn.classList.add('bg-red-100', 'border-red-500', 'text-red-900');
                        App.ui.toast("Incorrect", "error");
                    }
                }
            },

            ui: {
                updateProgress() {
                    const total = LessonData.menu.length;
                    const current = App.state.idx + 1;
                    const pct = (current / total) * 100;
                    document.getElementById('progress-bar-fill').style.width = `${pct}%`;
                    document.getElementById('page-indicator').innerText = `${current}/${total}`;
                    
                    document.getElementById('btn-prev').disabled = App.state.idx === 0;
                    const nextBtn = document.getElementById('btn-next');
                    
                    if(current === total) {
                        nextBtn.style.display = 'none';
                    } else {
                        nextBtn.style.display = 'flex';
                    }
                },
                toast(msg, type) {
                    const c = document.getElementById('toast-container');
                    const d = document.createElement('div');
                    const color = type === 'success' ? 'bg-green-600' : 'bg-red-500';
                    d.className = `${color} text-white px-6 py-3 rounded-full shadow-lg font-bold animate-pulse-slow`;
                    d.innerText = msg;
                    c.appendChild(d);
                    setTimeout(() => d.remove(), 2000);
                }
            }
        };

        // Init
        const app = App;
        window.onload = () => {
             // Setup audio unlock
            document.body.addEventListener('click', async () => {
                await Tone.start();
            }, { once: true });
            
            // Wait for voices to load
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = () => {};
            }
            
            app.init();
        };
    </script>
</body>
</html>
