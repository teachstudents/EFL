<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verb Tense Master Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Comic Neue', cursive; }
    .verb-button {
      background: linear-gradient(145deg, #e6e6e6, #ffffff);
      box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff;
      border: 2px solid #d1d5db;
      transition: all 0.18s ease;
    }
    .verb-button:hover { transform: translateY(-3px); box-shadow: 15px 15px 45px #bebebe, -15px -15px 45px #ffffff; }
    .verb-button.correct { background: linear-gradient(145deg,#10b981,#34d399); color: white; box-shadow: inset 8px 8px 16px #0d9668; }
    .verb-button.incorrect { background: linear-gradient(145deg,#ef4444,#f87171); color: white; box-shadow: inset 8px 8px 16px #dc2626; }
    .sparkle { animation: sparkle 0.6s ease-in-out; }
    @keyframes sparkle { 0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:.8} }
    .confetti { animation: confetti 1s ease-out forwards; }
    @keyframes confetti { 0%{transform:translateY(0);opacity:1}100%{transform:translateY(-120px);opacity:0} }
    .glow { box-shadow: 0 0 20px #10b981; }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-400 via-pink-400 to-red-400 min-h-screen">
  <!-- Name Modal -->
  <div id="nameModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 text-center max-w-md mx-4">
      <div class="text-6xl mb-4">🎮</div>
      <h2 class="text-3xl font-bold text-gray-800 mb-4">Welcome to Verb Tense Master!</h2>
      <p class="text-gray-600 mb-6">What's your name?</p>
      <input id="playerName" type="text" placeholder="Enter your name" class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl mb-6 text-center font-bold" />
      <button id="startGame" class="bg-gradient-to-r from-green-400 to-blue-500 text-white px-8 py-4 rounded-full font-bold text-xl">
        Start Playing! 🚀
      </button>
    </div>
  </div>

  <!-- Main Game -->
  <div id="gameContainer" class="hidden max-w-6xl mx-auto pt-8 pb-16">
    <div class="bg-white bg-opacity-90 backdrop-blur-sm shadow-lg p-4 mb-6 rounded-2xl mx-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-6">
          <div>
            <span id="playerNameDisplay" class="text-2xl font-bold text-purple-600">Player</span>
          </div>
          <div class="flex items-center space-x-2">
            <span id="timerIcon" class="text-2xl">⏱️</span>
            <div class="text-lg font-bold text-gray-700"><span id="timeLeft">12:00</span></div>
          </div>
          <div class="flex items-center space-x-2"><span class="text-xl">🪙</span><span id="tokenCount" class="text-xl font-bold text-yellow-600">0</span></div>
          <div class="flex items-center space-x-2"><span class="text-xl">🔥</span><span id="streakCount" class="text-lg font-bold text-orange-500">0</span></div>
          <div class="flex items-center space-x-2"><span class="text-lg">🌊</span><span id="waveCount" class="text-lg font-bold text-blue-500">1</span></div>
        </div>
        <div class="flex items-center space-x-4">
          <button id="teacherMode" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full">👩‍🏫 Teacher</button>
          <div class="text-sm text-gray-600">Progress:</div>
          <div class="w-32 bg-gray-200 rounded-full h-3">
            <div id="progressBar" class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full" style="width:0%"></div>
          </div>
          <span id="questionProgress" class="text-sm font-bold text-gray-700">1/50</span>
        </div>
      </div>
    </div>

    <!-- Teacher Panel -->
    <div id="teacherPanel" class="hidden max-w-4xl mx-auto mb-6 bg-white rounded-2xl shadow-lg p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">👩‍🏫 Teacher Controls</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Tense Mode:</label>
          <select id="tenseMode" class="w-full p-2 border rounded-lg">
            <option value="mixed">Mixed Tenses</option>
            <option value="simple_present">Simple Present Only</option>
            <option value="present_continuous">Present Continuous Only</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Audio Settings:</label>
          <div class="space-y-2">
            <label class="flex items-center"><input type="checkbox" id="readAloud" class="mr-2"> <span class="text-sm">Read prompts aloud</span></label>
            <label class="flex items-center"><input type="checkbox" id="accessibilityMode" class="mr-2"> <span class="text-sm">High contrast mode</span></label>
          </div>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Time Settings:</label>
          <label class="flex items-center"><input type="checkbox" id="timeExtended" class="mr-2"> <span class="text-sm">Extended time (+5 min)</span></label>
        </div>
      </div>
      <button id="applySettings" class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg">Apply Settings</button>
    </div>

    <!-- Question Panel -->
    <div class="max-w-4xl mx-auto px-4">
      <div class="bg-white rounded-2xl shadow-2xl p-8 mb-8">
        <div class="text-center mb-6">
          <div id="sentence" class="text-3xl leading-relaxed text-gray-800 mb-4 font-bold"></div>
          <div id="hintBubble" class="hidden bg-blue-100 border-l-4 border-blue-500 p-4 rounded-lg text-blue-700 max-w-md mx-auto text-lg"></div>
        </div>

        <div id="verbOptions" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6"></div>
      </div>
    </div>
  </div>

  <!-- Celebration Container -->
  <div id="celebrationContainer" class="fixed inset-0 pointer-events-none z-30"></div>

  <script>
    // High‑quality Microsoft voice names in Edge
    const ENGLISH_VOICES = {
      Ava: "Microsoft Ava Online (Natural) - English (United States)",
      Emma: "Microsoft Emma Online (Natural) - English (United States)",
      Brian: "Microsoft Brian Online (Natural) - English (United Kingdom)",
      Andrew: "Microsoft Andrew Online (Natural) - English (United States)"
    };

    const CHINESE_VOICES = {
      Yunxi: "Microsoft Yunxi Online (Natural) - Chinese (Mainland)",
      Xiaoxiao: "Microsoft Xiaoxiao Online (Natural) - Chinese (Mainland)"
    };

    // Game class
    class VerbTenseGame {
      constructor() {
        this.currentQuestion = 0;
        this.totalQuestions = 40;
        this.tokens = 0;
        this.streak = 0;
        this.correctAnswers = 0;
        this.timeLeft = 12 * 60;
        this.attempts = 0;
        this.waveCorrect = 0;
        this.currentWave = 1;
        this.playerName = '';
        this.teacherSettings = { tenseMode: 'mixed', readAloud: false, timeExtended: false, accessibilityMode: false };
        this.questions = this.generateQuestions();
        this.initializeGame();
      }

      generateQuestions() {
        const questions = [
          { sentence: "The clock ___ every second.", options: ["ticks","tick","is ticking","are ticking"], correct: "ticks", type: "simple_present", subject: "The clock", rule: "第三人称单数加s" },
          { sentence: "The bell ___ at 3 PM.", options: ["rings","ring","is ringing","are ringing"], correct: "rings", type: "simple_present", subject: "The bell", rule: "第三人称单数加s" },
          { sentence: "The computer ___ now.", options: ["is working","work","works","are working"], correct: "is working", type: "present_continuous", subject: "The computer", rule: "现在进行时" },
          { sentence: "I ___ breakfast at 7.", options: ["eat","eats","am eating","is eating"], correct: "eat", type: "simple_present", subject: "I", rule: "I 用基础形式" },
          { sentence: "She ___ milk every day.", options: ["drinks","drink","are drinking","drinking"], correct: "drinks", type: "simple_present", subject: "She", rule: "第三人称单数加s" },
          { sentence: "They ___ soccer after school.", options: ["play","plays","is playing","playing"], correct: "play", type: "simple_present", subject: "They", rule: "复数主语用原形" },
          { sentence: "He ___ a sandwich now.", options: ["is eating","eat","eats","are eating"], correct: "is eating", type: "present_continuous", subject: "He", rule: "现在进行时" },
          { sentence: "We ___ in class right now.", options: ["are sitting","sits","sit","is sitting"], correct: "are sitting", type: "present_continuous", subject: "We", rule: "现在进行时" },
          { sentence: "You ___ fast.", options: ["run","runs","is running","are running"], correct: "run", type: "simple_present", subject: "You", rule: "you 用原形" },
          { sentence: "The cat ___ milk.", options: ["drinks","drink","are drinking","is drink"], correct: "drinks", type: "simple_present", subject: "The cat", rule: "第三人称单数加s" },
          { sentence: "I ___ my lunch now.", options: ["am eating","eating","eats","is eating"], correct: "am eating", type: "present_continuous", subject: "I", rule: "现在进行时" },
          { sentence: "He ___ his homework after dinner.", options: ["does","do","is doing","are doing"], correct: "does", type: "simple_present", subject: "He", rule: "第三人称单数加s" },
          { sentence: "They ___ to music now.", options: ["are listening","is listening","listens","listen"], correct: "are listening", type: "present_continuous", subject: "They", rule: "现在进行时" },
          { sentence: "She ___ to school by bus.", options: ["goes","go","is going","are going"], correct: "goes", type: "simple_present", subject: "She", rule: "第三人称单数加s" },
          { sentence: "We ___ apples every day.", options: ["eat","eats","are eating","is eating"], correct: "eat", type: "simple_present", subject: "We", rule: "复数主语用原形" },
          { sentence: "The teacher ___ the book now.", options: ["is reading","reads","read","are reading"], correct: "is reading", type: "present_continuous", subject: "The teacher", rule: "现在进行时" },
          { sentence: "You ___ very well.", options: ["read","reads","is reading","are reading"], correct: "read", type: "simple_present", subject: "You", rule: "you 用原形" },
          { sentence: "He ___ his pencil.", options: ["sharpens","sharpen","is sharpening","are sharpening"], correct: "sharpens", type: "simple_present", subject: "He", rule: "第三人称单数加s" },
          { sentence: "I ___ water now.", options: ["am drinking","drinks","drink","is drinking"], correct: "am drinking", type: "present_continuous", subject: "I", rule: "现在进行时" },
          { sentence: "They ___ the board.", options: ["clean","cleans","is cleaning","are cleaning"], correct: "clean", type: "simple_present", subject: "They", rule: "复数主语用原形" },
          { sentence: "She ___ a picture now.", options: ["is drawing","draws","draw","are drawing"], correct: "is drawing", type: "present_continuous", subject: "She", rule: "现在进行时" },
          { sentence: "We ___ lunch at noon.", options: ["have","has","is having","are having"], correct: "have", type: "simple_present", subject: "We", rule: "复数主语用原形" },
          { sentence: "He ___ his hands now.", options: ["is washing","wash","washes","are washing"], correct: "is washing", type: "present_continuous", subject: "He", rule: "现在进行时" },
          { sentence: "The kids ___ in the playground.", options: ["play","plays","is playing","are playing"], correct: "play", type: "simple_present", subject: "The kids", rule: "复数主语用原形" },
          { sentence: "I ___ my name on the paper now.", options: ["am writing","write","writes","is writing"], correct: "am writing", type: "present_continuous", subject: "I", rule: "现在进行时" },
          { sentence: "She ___ her bag.", options: ["carries","carry","is carrying","are carrying"], correct: "carries", type: "simple_present", subject: "She", rule: "第三人称单数加s" },
          { sentence: "We ___ the bell now.", options: ["are hearing","hear","hears","is hearing"], correct: "are hearing", type: "present_continuous", subject: "We", rule: "现在进行时" },
          { sentence: "You ___ the door.", options: ["open","opens","is opening","are opening"], correct: "open", type: "simple_present", subject: "You", rule: "you 用原形" },
          { sentence: "He ___ cereal for breakfast.", options: ["eats","eat","is eating","are eating"], correct: "eats", type: "simple_present", subject: "He", rule: "第三人称单数加s" },
          { sentence: "They ___ a story now.", options: ["are reading","read","reads","is reading"], correct: "are reading", type: "present_continuous", subject: "They", rule: "现在进行时" },
          { sentence: "I ___ to the teacher now.", options: ["am talking","talk","talks","is talking"], correct: "am talking", type: "present_continuous", subject: "I", rule: "现在进行时" },
          { sentence: "She ___ her shoes.", options: ["ties","tie","is tying","are tying"], correct: "ties", type: "simple_present", subject: "She", rule: "第三人称单数加s" },
          { sentence: "We ___ the floor now.", options: ["are cleaning","clean","cleans","is cleaning"], correct: "are cleaning", type: "present_continuous", subject: "We", rule: "现在进行时" },
          { sentence: "He ___ to class on time.", options: ["comes","come","is coming","are coming"], correct: "comes", type: "simple_present", subject: "He", rule: "第三人称单数加s" },
          { sentence: "You ___ your lunch at 12.", options: ["eat","eats","are eating","is eating"], correct: "eat", type: "simple_present", subject: "You", rule: "you 用原形" },
          { sentence: "They ___ the bus now.", options: ["are waiting for","wait for","waits for","is waiting for"], correct: "are waiting for", type: "present_continuous", subject: "They", rule: "现在进行时" },
          { sentence: "The dog ___ in the yard.", options: ["runs","run","is running","are running"], correct: "runs", type: "simple_present", subject: "The dog", rule: "第三人称单数加s" },
          { sentence: "I ___ my homework every day.", options: ["do","does","am doing","is doing"], correct: "do", type: "simple_present", subject: "I", rule: "I 用原形" },
          { sentence: "She ___ TV now.", options: ["is watching","watch","watches","are watching"], correct: "is watching", type: "present_continuous", subject: "She", rule: "现在进行时" }
        ];

        if (this.teacherSettings.tenseMode === 'simple_present') {
          return this.shuffleArray(questions.filter(q => q.type === 'simple_present'));
        } else if (this.teacherSettings.tenseMode === 'present_continuous') {
          return this.shuffleArray(questions.filter(q => q.type === 'present_continuous'));
        }
        return this.shuffleArray(questions);
      }

      shuffleArray(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      initializeGame() {
        this.setupEventListeners();
        this.startTimer();
        this.displayQuestion();
      }

      setupEventListeners() {
        document.getElementById('startGame').addEventListener('click', () => {
          const nameInput = document.getElementById('playerName');
          this.playerName = (nameInput.value || '').trim() || 'Player';
          document.getElementById('playerNameDisplay').textContent = this.playerName;
          document.getElementById('nameModal').classList.add('hidden');
          document.getElementById('gameContainer').classList.remove('hidden');
          this.speak(`Hello ${this.playerName}! Let's start learning verb tenses!`, 'Ava');
        });

        document.getElementById('playerName').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') document.getElementById('startGame').click();
        });

        document.getElementById('teacherMode').addEventListener('click', () => {
          document.getElementById('teacherPanel').classList.toggle('hidden');
        });

        document.getElementById('applySettings').addEventListener('click', () => {
          this.applyTeacherSettings();
        });

        document.addEventListener('keydown', (e) => {
          if (e.key >= '1' && e.key <= '4') {
            const buttons = document.querySelectorAll('.verb-button');
            const idx = parseInt(e.key) - 1;
            if (buttons[idx]) this.checkAnswer(buttons[idx].dataset.verb);
          }
        });
      }

      applyTeacherSettings() {
        this.teacherSettings.tenseMode = document.getElementById('tenseMode').value;
        this.teacherSettings.readAloud = document.getElementById('readAloud').checked;
        this.teacherSettings.accessibilityMode = document.getElementById('accessibilityMode').checked;
        this.teacherSettings.timeExtended = document.getElementById('timeExtended').checked;

        if (this.teacherSettings.accessibilityMode) {
          document.body.classList.add('high-contrast');
          const style = document.createElement('style');
          style.textContent = `.high-contrast { filter: contrast(150%) brightness(110%); } .high-contrast .verb-button { border: 4px solid #000; }`;
          document.head.appendChild(style);
        } else {
          document.body.classList.remove('high-contrast');
        }

        if (this.teacherSettings.timeExtended) this.timeLeft += 5 * 60;
        this.questions = this.generateQuestions();
        this.currentQuestion = 0;
        this.displayQuestion();
        document.getElementById('teacherPanel').classList.add('hidden');
        this.speak("Settings applied successfully!", 'Ava');
      }

      displayQuestion() {
        const q = this.questions[this.currentQuestion];
        const parts = q.sentence.split('___');
        const sentenceEl = document.getElementById('sentence');
        sentenceEl.innerHTML = `
          ${parts[0]}
          <span id="blankSpace" class="inline-block min-w-32 h-12 border-2 border-dashed border-gray-400 rounded-lg bg-gray-50 mx-2 px-4 py-2 text-center">
            <span class="text-gray-400 text-2xl">?</span>
          </span>
          ${parts[1] || ''}
        `;
        this.displayVerbOptions(q.options);
        document.getElementById('questionProgress').textContent = `${this.currentQuestion + 1}/${this.totalQuestions}`;
        document.getElementById('progressBar').style.width = `${(this.currentQuestion / this.totalQuestions) * 100}%`;
        document.getElementById('waveCount').textContent = this.currentWave;

        if (this.teacherSettings.readAloud) {
          const readText = q.sentence.replace('___', 'blank');
          setTimeout(() => {
            this.speak(readText, this.getRandomVoice());
            setTimeout(() => this.speak(`The choices are: ${q.options.join(', ')}`, this.getRandomVoice()), 1600);
          }, 500);
        }

        this.attempts = 0;
        this.hideHint();
      }

      displayVerbOptions(options) {
        const container = document.getElementById('verbOptions');
        container.innerHTML = '';
        const shuffled = this.shuffleArray(options);
        shuffled.forEach((opt, idx) => {
          const btn = document.createElement('button');
          btn.className = 'verb-button px-8 py-6 rounded-2xl font-bold text-3xl text-gray-800 relative focus:outline-none';
          btn.textContent = opt;
          btn.dataset.verb = opt;
          btn.tabIndex = 0;
          const badge = document.createElement('span');
          badge.className = 'absolute top-2 right-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full';
          badge.textContent = idx + 1;
          btn.appendChild(badge);
          btn.addEventListener('click', () => this.checkAnswer(opt));
          btn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.checkAnswer(opt); } });
          container.appendChild(btn);
        });
      }

      checkAnswer(selectedVerb) {
        const q = this.questions[this.currentQuestion];
        const blank = document.getElementById('blankSpace');
        const buttons = document.querySelectorAll('.verb-button');
        this.attempts++;
        buttons.forEach(b => b.disabled = true);

        if (selectedVerb === q.correct) {
          blank.innerHTML = `<span class="text-green-600 font-bold text-2xl">${selectedVerb}</span>`;
          blank.classList.add('glow');
          buttons.forEach(btn => { if (btn.dataset.verb === selectedVerb) btn.classList.add('correct'); });
          let earned = 0;
          if (this.attempts === 1) { earned = 2; this.createTokenAnimation('+2 🪙'); }
          else if (this.attempts <= 3) { earned = 1; this.createTokenAnimation('+1 🪙'); }
          this.tokens += earned;
          this.streak++; this.correctAnswers++; this.waveCorrect++;
          if ((this.currentQuestion + 1) % 10 === 0) {
            if (this.waveCorrect === 10) { this.tokens += 5; this.createTokenAnimation('+5 🪙 WAVE BONUS!'); this.speak("Perfect wave! Bonus tokens earned!", 'Ava'); }
            this.waveCorrect = 0; this.currentWave++;
          }
          this.updateDisplay();
          this.showCorrectFeedback();
          setTimeout(() => this.nextQuestion(), 1800);
        } else {
          blank.innerHTML = `<span class="text-red-600 font-bold text-2xl">${selectedVerb}</span>`;
          blank.classList.add('shake');
          buttons.forEach(btn => { if (btn.dataset.verb === selectedVerb) btn.classList.add('incorrect'); btn.disabled = false; });
          this.streak = 0;
          this.showIncorrectFeedback(q);
          this.showHint();
          setTimeout(() => {
            blank.classList.remove('shake');
            blank.innerHTML = `<span class="text-gray-400 text-2xl">?</span>`;
            buttons.forEach(btn => btn.classList.remove('incorrect'));
          }, 1800);
        }
      }

      showCorrectFeedback() {
        const messages = ["Great job!", "Nice work!", "Excellent!", "Perfect!", "Well done!"];
        const msg = messages[Math.floor(Math.random() * messages.length)];
        this.speak(msg, this.getRandomVoice());
        this.playSound('correct');
        this.createSparkles();
      }

      showIncorrectFeedback(question) {
        this.speak("Try again. Look at the subject.", 'Andrew');
        this.playSound('incorrect');
        setTimeout(() => { this.speakChinese(`${question.rule}。正确答案是：${question.correct}`); }, 800);
      }

      showHint() {
        const q = this.questions[this.currentQuestion];
        const hintBubble = document.getElementById('hintBubble');
        let hint = '';
        if (this.attempts === 1) hint = "Check who does the action: he/she/it needs 's'";
        else if (this.attempts === 2) { this.highlightSubjectAndAnswer(q); hint = `Look at "${q.subject}" - what verb form matches?`; }
        else { hint = `The correct answer is "${q.correct}"`; this.showCorrectAnswer(q.correct); }
        hintBubble.textContent = hint;
        hintBubble.classList.remove('hidden');
      }

      highlightSubjectAndAnswer(question) {
        const sentenceElement = document.getElementById('sentence');
        sentenceElement.innerHTML = sentenceElement.innerHTML.replace(
          question.subject,
          `<span class="bg-yellow-200 px-2 py-1 rounded font-bold">${question.subject}</span>`
        );
        const buttons = document.querySelectorAll('.verb-button');
        buttons.forEach(btn => { if (btn.dataset.verb === question.correct) { btn.style.boxShadow = '0 0 20px #fbbf24'; btn.style.transform = 'scale(1.05)'; } });
      }

      showCorrectAnswer(correctAnswer) {
        const blank = document.getElementById('blankSpace');
        blank.innerHTML = `<span class="text-blue-600 font-bold animate-pulse text-2xl">${correctAnswer}</span>`;
        blank.classList.add('bg-blue-100', 'border-blue-400');
      }

      hideHint() {
        document.getElementById('hintBubble').classList.add('hidden');
      }

      checkMilestones() {
        if (this.streak === 3) { this.createGentleConfetti(); this.speak("Streak of three! Keep going!", this.getRandomVoice()); }
        if (this.streak === 5) { this.createGlitterTrail(); this.speak("Awesome streak! You're on fire!", this.getRandomVoice()); }
        if (this.streak === 10) { this.createThemedFireworks(); this.speak("Ten in a row! Incredible streak!", this.getRandomVoice()); }
        if ((this.currentQuestion + 1) % 10 === 0) { this.createFireworks(); this.createTokenRain(); this.speak(`Wave ${this.currentWave} complete!`, this.getRandomVoice()); }
      }

      getRandomVoice() {
        const voices = ['Ava','Emma','Brian','Andrew'];
        return voices[Math.floor(Math.random() * voices.length)];
      }

      nextQuestion() {
        this.currentQuestion++;
        if (this.currentQuestion >= this.totalQuestions) this.endGame();
        else {
          this.resetQuestionState();
          this.displayQuestion();
        }
      }

      resetQuestionState() {
        const blank = document.getElementById('blankSpace');
        if (blank) { blank.classList.remove('glow','bg-blue-100','border-blue-400'); blank.innerHTML = `<span class="text-gray-400 text-2xl">?</span>`; }
        const buttons = document.querySelectorAll('.verb-button');
        buttons.forEach(btn => { btn.classList.remove('correct','incorrect'); btn.style.boxShadow=''; btn.style.transform=''; btn.disabled=false; });
        const hintBubble = document.getElementById('hintBubble'); if (hintBubble) hintBubble.classList.add('hidden');
      }

      endGame() {
        this.createMegaFireworks();
        this.speak(`Congratulations ${this.playerName}! You completed all ${this.totalQuestions} questions and earned ${this.tokens} tokens!`, 'Ava');
        setTimeout(() => {
          alert(`🎉 Game Complete! 🎉\n\nFinal Score for ${this.playerName}:\n🪙 Tokens: ${this.tokens}\n✅ Correct: ${this.correctAnswers}/${this.totalQuestions}\n🔥 Best Streak: ${this.streak}`);
          location.reload();
        }, 1600);
      }

      updateDisplay() {
        document.getElementById('tokenCount').textContent = this.tokens;
        document.getElementById('streakCount').textContent = this.streak;
      }

      startTimer() {
        const timer = setInterval(() => {
          this.timeLeft--;
          const minutes = Math.floor(this.timeLeft / 60);
          const seconds = this.timeLeft % 60;
          const timeDisplay = document.getElementById('timeLeft');
          timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2,'0')}`;

          if (this.timeLeft <= 120 && this.timeLeft > 0) {
            document.getElementById('timerIcon').textContent = '⏰';
            timeDisplay.classList.add('text-red-600');
            if (this.timeLeft === 60) this.speak("One minute remaining!", 'Ava');
          }
          if (this.timeLeft <= 0) { clearInterval(timer); this.endGame(); }
        }, 1000);
      }

      // ---- TTS functions (patched to target full Edge Online (Natural) names) ----
      speak(text, voiceKey = 'Ava') {
        const utterance = new SpeechSynthesisUtterance(text);
        const setVoice = () => {
          const voices = speechSynthesis.getVoices();
          let selectedVoice = voices.find(v => v.name === ENGLISH_VOICES[voiceKey]);
          if (!selectedVoice) {
            // fallback to any English voice if exact match not found
            selectedVoice = voices.find(v => v.lang && v.lang.startsWith && v.lang.startsWith('en'));
          }
          if (selectedVoice) utterance.voice = selectedVoice;
          utterance.rate = 0.9;
          utterance.pitch = 1.0;
          utterance.volume = 0.9;
          speechSynthesis.speak(utterance);
        };
        if (speechSynthesis.getVoices().length > 0) setVoice();
        else speechSynthesis.addEventListener('voiceschanged', setVoice, { once: true });
      }

      speakChinese(text, voiceKey = 'Yunxi') {
        const utterance = new SpeechSynthesisUtterance(text);
        const setVoice = () => {
          const voices = speechSynthesis.getVoices();
          let selectedVoice = voices.find(v => v.name === CHINESE_VOICES[voiceKey]);
          if (!selectedVoice) {
            // fallback to any Chinese voice
            selectedVoice = voices.find(v => v.lang && (v.lang.includes('zh') || v.lang.includes('cmn')));
          }
          if (selectedVoice) { utterance.voice = selectedVoice; utterance.lang = selectedVoice.lang; }
          else utterance.lang = 'zh-CN';
          utterance.rate = 0.85;
          utterance.pitch = 1.0;
          utterance.volume = 0.9;
          speechSynthesis.speak(utterance);
        };
        if (speechSynthesis.getVoices().length > 0) setVoice();
        else speechSynthesis.addEventListener('voiceschanged', setVoice, { once: true });
      }

      // ---- Sound and visual effects ----
      playSound(type) {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          if (type === 'correct') {
            osc.frequency.setValueAtTime(523.25, ctx.currentTime);
            osc.frequency.linearRampToValueAtTime(783.99, ctx.currentTime + 0.2);
          } else {
            osc.frequency.setValueAtTime(220, ctx.currentTime);
          }
          gain.gain.setValueAtTime(0.25, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.35);
          osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.35);
        } catch (e) { /* ignore */ }
      }

      createSparkles() {
        const container = document.getElementById('celebrationContainer');
        for (let i = 0; i < 6; i++) {
          const s = document.createElement('div');
          s.className = 'absolute text-2xl sparkle';
          s.textContent = '✨';
          s.style.left = Math.random() * 100 + '%';
          s.style.top = Math.random() * 100 + '%';
          container.appendChild(s);
          setTimeout(() => s.remove(), 700);
        }
      }

      createGentleConfetti() {
        const container = document.getElementById('celebrationContainer');
        const types = ['🎉','🎊','✨'];
        for (let i = 0; i < 8; i++) {
          const c = document.createElement('div');
          c.className = 'absolute text-lg confetti';
          c.textContent = types[Math.floor(Math.random() * types.length)];
          c.style.left = Math.random() * 100 + '%';
          c.style.top = '100%';
          c.style.animationDelay = (Math.random() * 0.4) + 's';
          container.appendChild(c);
          setTimeout(() => c.remove(), 1200);
        }
      }

      createGlitterTrail() { this.createSparkles(); }

      createThemedFireworks() {
        const container = document.getElementById('celebrationContainer');
        const effects = ['🎆','🎇','✨','🌟'];
        for (let i = 0; i < 10; i++) {
          const e = document.createElement('div');
          e.className = 'absolute text-4xl fireworks';
          e.textContent = effects[Math.floor(Math.random() * effects.length)];
          e.style.left = Math.random() * 90 + 5 + '%';
          e.style.top = Math.random() * 80 + '%';
          e.style.animationDelay = Math.random() * 1.5 + 's';
          container.appendChild(e);
          setTimeout(() => e.remove(), 1800);
        }
      }

      createFireworks() { this.createThemedFireworks(); }
      createTokenRain() {
        const container = document.getElementById('celebrationContainer');
        for (let i = 0; i < 10; i++) {
          const t = document.createElement('div');
          t.className = 'absolute text-2xl confetti';
          t.textContent = '🪙';
          t.style.left = Math.random() * 100 + '%';
          t.style.top = '0%';
          t.style.animationDelay = Math.random() * 0.6 + 's';
          container.appendChild(t);
          setTimeout(() => t.remove(), 1200);
        }
      }

      createMegaFireworks() { this.createThemedFireworks(); this.createTokenRain(); }

      createTokenAnimation(text) {
        const c = document.getElementById('celebrationContainer');
        const el = document.createElement('div');
        el.className = 'absolute text-2xl font-bold text-yellow-600';
        el.textContent = text;
        el.style.left = '50%'; el.style.top = '20%'; el.style.transform = 'translateX(-50%)';
        c.appendChild(el);
        setTimeout(() => el.remove(), 1500);
      }
    }

    // Initialize game
    const game = new VerbTenseGame();
  </script>
</body>
</html>