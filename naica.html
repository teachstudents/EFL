<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naica Mine: The Cave of Giant Crystals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @keyframes crystal-bg {
            0% { background-color: #a5f3fc; } /* Light Cyan */
            25% { background-color: #d8b4fe; } /* Light Purple */
            50% { background-color: #f9a8d4; } /* Light Pink */
            75% { background-color: #a78bfa; } /* Violet */
            100% { background-color: #a5f3fc; } /* Light Cyan */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            animation: crystal-bg 240s linear infinite;
            padding-top: 85px; 
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
            border: none;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px -1px rgba(0,0,0,0.2), 0 1px 2px -2px rgba(0,0,0,0.1), inset 0 -2px 0 0 rgba(0,0,0,0.2);
        }
        
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 44px; padding: 0 4px;
            border: 2px dashed #9ca3af; border-radius: 8px; margin: 0 4px;
            vertical-align: middle; background-color: #f3f4f6;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 8px;
            background-color: white; user-select: none;
        }
        .word-bank-word.selected { outline: 2px solid #6366f1; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; }
        .gap.correct .word-bank-word { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .gap.incorrect .word-bank-word { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        .feedback-toast, .badge-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #f59e0b, #fde047); color: #422006;}
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 20px; } to { opacity: 0; bottom: 0; } }

        #completion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        #progress-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 8px; width: 100%; margin-top: 8px; }
        #progress-bar { height: 100%; width: 0%; background-color: #8b5cf6; transition: width 0.5s ease-out; }
        
        #vocab-game-timer-bar { height: 6px; background-color: #8b5cf6; transition: width 0.1s linear; }
        
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        @media print {
            body * { visibility: hidden; }
            #certificate-to-print, #certificate-to-print * { visibility: visible; }
            #certificate-to-print { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="antialiased text-gray-800 text-lg">
    <canvas id="background-canvas"></canvas>
    <div id="reward-animation-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]"></div>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-md mx-auto bg-white/90 backdrop-blur-sm shadow-lg rounded-full p-2">
            <div class="flex justify-center items-center gap-2">
                <button onclick="goBack()" class="nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="font-bold text-base text-violet-500 px-3 whitespace-nowrap">Points ‚ú®: <span id="score-display">0</span></div>
                <button onclick="navigateTo('main-menu')" class="nav-button bg-gray-800 text-white font-bold p-2 rounded-full hover:bg-gray-900">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                </button>
                <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-full hover:bg-gray-200" title="Toggle Sound">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
                </button>
                <button onclick="goNext()" class="nav-button bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
        </div>
    </header>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <section id="page-title-screen" class="page active text-center bg-white rounded-2xl shadow-lg p-8">
            <div class="h-full flex flex-col justify-center items-center">
                <h1 id="main-title" class="text-5xl md:text-6xl font-bold text-slate-800 mb-4"></h1>
                <p id="main-subtitle" class="text-xl md:text-2xl text-gray-600 mb-8"></p>
                <div id="main-svg-container" class="rounded-lg mb-8 w-full max-w-lg mx-auto"></div>
                <button onclick="startApp()" class="action-button bg-violet-500 text-white font-bold py-3 px-8 rounded-full text-2xl hover:bg-violet-600">START LESSON</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION (NAICA MINE) ---
        // ===================================================================================
        const lessonData = {
            title: "The Naica Mine",
            subtitle: "Journey to the Cave of Giant Crystals <span aria-hidden='true'>üíé</span>",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-tps', text: '0. Think-Pair-Share <span aria-hidden="true">üß†</span>', color: 'amber', target: 'tps-start' },
                { id: 'menu-goals', text: '1. Learning Goals <span aria-hidden="true">üéØ</span>', color: 'teal', target: 'learning-goals' },
                { id: 'menu-warmup', text: '2. Warm-Up & Vocab <span aria-hidden="true">üìö</span>', color: 'sky', target: 'warm-up' },
                { id: 'menu-vocab-game', text: 'Vocab Game <span aria-hidden="true">üéÆ</span>', color: 'sky', target: 'vocab-game'},
                { id: 'menu-reading1', text: '3. Reading: Discovery <span aria-hidden="true">‚õèÔ∏è</span>', color: 'green', target: 'reading-discovery', badge: 'badge-discoverer' },
                { id: 'menu-reading2', text: '4. Reading: The Science <span aria-hidden="true">üî¨</span>', color: 'blue', target: 'reading-science', badge: 'badge-geologist' },
                { id: 'menu-deep-dive', text: '4b. Deep Dive <span aria-hidden="true">üåä</span>', color: 'indigo', target: 'deep-dive'},
                { id: 'menu-convo1', text: '5. Listening: A Miner\'s Tale <span aria-hidden="true">üßë‚Äçü§ù‚Äçüßë</span>', color: 'lime', target: 'convo-miners' },
                { id: 'menu-primary-source', text: '5b. Primary Source <span aria-hidden="true">üéôÔ∏è</span>', color: 'emerald', target: 'primary-source' },
                { id: 'menu-podcast1', text: '6. Listening: Science Uncovered <span aria-hidden="true">üéß</span>', color: 'orange', target: 'podcast-experts', badge: 'badge-biologist' },
                { id: 'menu-debate', text: '7. Discussion: To Seal or To Study? <span aria-hidden="true">ü§î</span>', color: 'rose', target: 'debate-ethics', badge: 'badge-ethicist' },
                { id: 'menu-writing', text: '7b. Writing Activity <span aria-hidden="true">üìù</span>', color: 'purple', target: 'writing-activity' },
                { id: 'menu-final', text: '8. Final Projects <span aria-hidden="true">‚úçÔ∏è</span>', color: 'violet', target: 'final-project-hub' },
            ],
            badges: [
                { id: 'badge-discoverer', name: 'Cave Discoverer', emoji: 'üó∫Ô∏è', description: 'Completed the Discovery section.' },
                { id: 'badge-geologist', name: 'Junior Geologist', emoji: 'üî¨', description: 'Completed the Science section.' },
                { id: 'badge-biologist', name: 'Microbe Hunter', emoji: 'ü¶†', description: 'Completed the Science Uncovered section.' },
                { id: 'badge-ethicist', name: 'Cave Ethicist', emoji: '‚öñÔ∏è', description: 'Completed the Discussion section.' },
            ],
            vocabulary: [
                { word: 'Geode', def: 'A small cavity in rock lined with crystals or other mineral matter.', sentence: 'The Cave of Crystals is like a geode big enough for people to walk into.' },
                { word: 'Hydrothermal', def: 'Relating to the action of heated water in the earth\'s crust.', sentence: 'The giant crystals grew from hot, mineral-rich hydrothermal waters.' },
                { word: 'Selenite', def: 'A transparent, crystalline variety of gypsum.', sentence: 'The massive crystals in Naica are made of selenite.' },
                { word: 'Magma Chamber', def: 'A large underground pool of liquid rock found beneath the surface of the Earth.', sentence: 'A magma chamber below the cave kept the water hot for thousands of years.' },
                { word: 'Supersaturated', def: 'A solution that contains more dissolved material than could be dissolved by the solvent under normal circumstances.', sentence: 'The water in the cave was supersaturated with gypsum minerals.' },
                { word: 'Anhydrite', def: 'A mineral which is the anhydrous (waterless) form of calcium sulfate.', sentence: 'At high temperatures, anhydrite dissolved in the water, but as it cooled, it formed gypsum.' },
                { word: 'Extremophile', def: 'An organism that thrives in physically or geochemically extreme conditions.', sentence: 'Scientists discovered extremophile microbes trapped inside the crystals.' },
                { word: 'Geologist', def: 'An expert in or student of geology, the science which deals with the earth\'s physical structure and substance.', sentence: 'A geologist was the first to understand the unique conditions that formed the crystals.' },
                { word: 'Cavern', def: 'A large cave or a large chamber in a cave.', sentence: 'The crystal cavern was accidentally discovered by miners.' },
                { word: 'Acclimatize', def: 'To become accustomed to a new climate or to new conditions.', sentence: 'It is impossible for humans to acclimatize to the intense heat and humidity in the cave.' }
            ],
            pages: [
                { id: 'tps-start', type: 'simple', content: { title: 'Activity: Think-Pair-Share <span aria-hidden="true">üß†</span>', text: 'Let\'s think about what it takes to make something amazing.' } },
                { id: 'tps-think', type: 'timer', content: { title: '1. Think <span aria-hidden="true">ü§î</span>', text: 'Imagine you find a cave filled with crystals as big as trees. What would be your first reaction? What would you want to know about them? What do you think would be the biggest dangers in a place like that?', duration: 120, timerId: 'timer-think' } },
                { id: 'tps-pair', type: 'timer', content: { title: '2. Pair <span aria-hidden="true">üë•</span>', text: 'With a partner, discuss how you think such giant crystals could have formed. What ingredients would you need? Do you think it would happen quickly or take a very long time? Why?', duration: 180, timerId: 'timer-pair' } },
                { id: 'tps-share', type: 'timer', content: { title: '3. Share <span aria-hidden="true">üó£Ô∏è</span>', text: 'As a class, let\'s share some ideas. What does the existence of a place like this tell us about the hidden wonders our planet might still hold?', duration: 300, timerId: 'timer-share' } },

                { id: 'learning-goals', type: 'html-content', content: { title: 'Learning Goals <span aria-hidden="true">üéØ</span>', html: `
                    <div class="text-left space-y-4">
                        <p><strong class="text-teal-600">Learning Intention:</strong> We are learning to explain the geological conditions that created the Naica Cave of Crystals and evaluate the challenges of studying and preserving this unique environment.</p>
                        <hr class="my-4">
                        <h3 class="text-2xl font-bold text-teal-600 mb-3">Success Criteria</h3>
                        <ul class="list-disc list-inside space-y-2 text-xl">
                            <li>I can describe the physical appearance and environment of the Cave of Crystals.</li>
                            <li>I can identify the key ingredients and conditions needed for the giant <strong>selenite</strong> crystals to grow.</li>
                            <li>I can explain why the cave is so dangerous for humans.</li>
                            <li>I can discuss the ethical arguments for and against human access to the cave.</li>
                        </ul>
                    </div>` } },
                
                { id: 'warm-up', type: 'html-content', content: { title: 'Pre-Reading & Pre-Listening <span aria-hidden="true">üìö</span>', html: `
                    <ol class="list-decimal list-inside space-y-6 text-xl text-left">
                        <li>Have you ever seen a crystal or a geode? Describe what it looked like.</li>
                        <li>The lesson is about a cave with crystals as big as telephone poles. Do you think this is real? Why or why not?</li>
                        <li>What are some of the most extreme environments on Earth you can think of (e.g., very hot, very cold, high pressure)?</li>
                        <li>If you were an explorer, would you rather discover a lost city or a natural wonder that no one has ever seen before? Why?</li>
                        <li>When a very special and fragile place is discovered, who should get to decide what happens to it?</li>
                    </ol>` } },
                { id: 'vocab-start', type: 'simple', content: { title: 'Unit Vocabulary <span aria-hidden="true">üìö</span>', text: 'Let\'s learn the key terms for this unit. Click the "Next" arrow to cycle through the words.' } },
                { id: 'vocab-game', type: 'vocab-game', content: { title: 'Vocabulary Review Game <span aria-hidden="true">üéÆ</span>'} },
                
                { id: 'reading-discovery', type: 'html-content', content: { title: 'Reading: The Discovery <span aria-hidden="true">‚õèÔ∏è</span>', html: `
                    <div class="space-y-6 text-left readable-content">
                        <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-purple-500">
                            <h4 class="font-bold text-xl text-gray-800">Level 1: The Main Idea</h4>
                            <p>In the year 2000, two miners were drilling a new tunnel deep inside the Naica Mine in Mexico's Chihuahuan Desert. They were searching for valuable metals like silver, lead, and zinc. By accident, their drill broke through into a hidden cave. When they looked inside, they found a stunning, otherworldly chamber filled with giant, milky-white crystals. Some of these crystals were the largest ever seen on Earth. The cave was also dangerously hot and steamy, a beautiful but deadly environment.</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-purple-600">
                            <h4 class="font-bold text-xl text-gray-900">Level 2: Adding Detail</h4>
                            <p>The discovery was made by brothers Eloy and Javier Delgado at a depth of nearly 300 meters (980 feet). The <strong>cavern</strong> they uncovered, named the Cave of Crystals (Cueva de los Cristales), was unlike anything seen before. It was a <strong>geode</strong> filled with enormous beams of <strong>selenite</strong>, a crystalline form of gypsum. The environment is incredibly hostile; air temperatures hover around 58 ¬∞C (136 ¬∞F) with over 90% humidity. Without specialized cooling suits circulating ice-cold water, an unprotected person would suffer from severe heatstroke and could perish in less than ten minutes. The hot, moist air would cause fluid to condense inside the lungs, making it impossible to breathe.</p>
                        </div>
                        <div class="bg-gray-200 p-4 rounded-lg border-l-4 border-purple-700">
                            <h4 class="font-bold text-xl text-gray-900">Level 3: The Full Picture</h4>
                            <p>The Naica Mine is geologically active, situated on a fault line above a <strong>magma chamber</strong> that has been cooling for millions of years. This geothermal heat is the reason for the cave's extreme conditions. The cave was not an empty void; before its discovery, it was completely flooded with <strong>hydrothermal</strong> waters. For half a million years, this water, kept at a stable temperature and rich in minerals, provided the perfect conditions for the crystals to grow. The mining company's industrial pumps, working constantly to dewater the mine shafts, are what drained the cavern and revealed its treasures. This means the discovery was a temporary event; if the pumps are ever turned off, the cave will flood again, preserving the crystals but hiding them from human eyes once more.</p>
                        </div>
                    </div>` } },
                { id: 'reading-discovery-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [] } },
                { id: 'reading-discovery-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False/Not Given', questions: [] } },
                { id: 'reading-discovery-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap Fill', sentences: [] } },

                { id: 'reading-science', type: 'html-content', content: { title: 'Reading: The Science of Giant Crystals <span aria-hidden="true">üî¨</span>', html: `
                    <div class="space-y-6 text-left readable-content">
                        <div class="bg-sky-50 p-4 rounded-lg">
                            <h4 class="font-bold text-xl text-sky-800">A Perfect Recipe</h4>
                            <p>The giant crystals are a geological masterpiece, formed by a precise and stable recipe over an immense timescale. The cave was filled with hot, mineral-rich water, heated by the <strong>magma chamber</strong> below. This water was a <strong>supersaturated</strong> solution, meaning it held far more dissolved minerals than it normally could, specifically a calcium sulfate mineral called <strong>anhydrite</strong> (CaSO‚ÇÑ). This mineral is stable at temperatures above 58¬∞C.</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-bold text-xl text-blue-800">Slow and Steady Growth</h4>
                            <p>The secret to the crystals' colossal size was stability. For at least 500,000 years, the water temperature remained locked just below 58¬∞C. At this "magic" temperature, the anhydrite mineral was no longer stable and began to dissolve, but the water was still hot enough to be saturated with the components to form gypsum. These components then bonded to form hydrated calcium sulfate (CaSO‚ÇÑ¬∑2H‚ÇÇO), which is the chemical makeup of gypsum and its transparent form, <strong>selenite</strong>. Because this process happened incredibly slowly and without interruption, only a few crystals started to form, and they never stopped growing, reaching lengths of over 11 meters (36 feet).</p>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h4 class="font-bold text-xl text-indigo-800">A Fragile Balance</h4>
                            <p>The draining of the cave by mining pumps stopped the crystal growth instantly. Now exposed to air, the magnificent selenite beams are fragile. Without the buoyant support of water, their own immense weight puts them under stress. More importantly, if the temperature and humidity in the cave were to drop significantly, the crystals could begin to dehydrate and lose their translucent luster, potentially turning white and opaque. This has created a race against time for scientists to study this unique environment before the mine eventually closes and the pumps are shut off, allowing the cave to flood and return to its primordial, crystal-growing state.</p>
                        </div>
                    </div>` } },
                { id: 'reading-science-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [] } },
                { id: 'reading-science-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False/Not Given', questions: [] } },
                { id: 'reading-science-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap Fill', sentences: [] } },

                { id: 'deep-dive', type: 'html-content', content: { title: 'Deep Dive: Cross-Curricular Science <span aria-hidden="true">üåä</span>', html: `
                    <div class="space-y-6 text-left readable-content">
                        <div class="p-4 rounded-lg bg-red-50 border-l-4 border-red-400">
                            <h4 class="font-bold text-xl text-red-800">Biology: Life at the Limit</h4>
                            <p>The discovery of <strong>extremophile</strong> microbes inside the crystals is revolutionary. It shows that life can be preserved in a dormant state for thousands of years in complete isolation. This has huge implications for astrobiology‚Äîif life can survive in sealed crystals on Earth, could it survive in similar conditions on other planets or moons, like Mars or Europa?</p>
                        </div>
                        <div class="p-4 rounded-lg bg-blue-50 border-l-4 border-blue-400">
                            <h4 class="font-bold text-xl text-blue-800">Chemistry: A Supersaturated State</h4>
                            <p>The water in Naica was a perfect example of a <strong>supersaturated</strong> solution. Imagine trying to dissolve sugar in cold tea‚Äîit's hard. But in hot tea, you can dissolve much more. The Naica water was so hot it dissolved huge amounts of anhydrite. As it cooled ever so slightly to the 'magic' temperature, the water couldn't hold all the mineral, so it began to precipitate out, not as a powder, but as perfectly formed selenite crystals.</p>
                        </div>
                        <div class="p-4 rounded-lg bg-yellow-50 border-l-4 border-yellow-400">
                            <h4 class="font-bold text-xl text-yellow-800">Physics: Geothermal Heat Transfer</h4>
                            <p>The cave acted like a perfectly regulated oven. The heat didn't come from the sun but from the Earth itself‚Äîa process called geothermal heat transfer. The <strong>magma chamber</strong> below conducted heat through the rock, warming the water in the cavern. This stable, internal heating system is why the conditions remained perfect for crystal growth for so long, shielded from weather changes on the surface.</p>
                        </div>
                    </div>` } },
                
                { id: 'convo-miners', type: 'dialogue', content: { title: 'Listening: A Miner\'s Tale <span aria-hidden="true">üßë‚Äçü§ù‚Äçüßë</span>', dialogue: "Juan: Do you remember that day, Pedro? The drill just... broke through. We felt a rush of hot, wet air. We thought something had gone wrong with the ventilation.\n\nPedro: I remember. The foreman sent us to check it out. I peeked through the hole we made and I couldn't believe it. I told you it looked like a fairytale, like a giant's treasure. The beams of light from our headlamps just... disappeared into the white. They didn't reflect back.\n\nJuan: It was the humidity. Like breathing in hot soup. And the silence... no sound of machinery, just this... glowing palace. We knew right away it was something special. Not silver, not zinc, but something the world had never seen before." } },
                { id: 'convo-miners-quiz-mcq', type: 'quiz-mcq', content: { title: 'Conversation Quiz (MCQ)', questions: [] } },
                { id: 'convo-miners-quiz-tfng', type: 'quiz-tfng', content: { title: 'Conversation Quiz (TFNG)', questions: [] } },
                { id: 'convo-miners-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Conversation Quiz (Gap Fill)', sentences: [] } },

                { id: 'primary-source', type: 'html-content', content: { title: 'Primary Source Spotlight <span aria-hidden="true">üéôÔ∏è</span>', html: `
                    <div class="space-y-6 text-left readable-content bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-2xl font-bold text-emerald-700">A Scientist's Perspective</h3>
                        <p class="text-lg italic">"The first time you enter the cave, you are overwhelmed by the beauty of this chamber. But at the same time, you have this feeling of the risk... You feel the heat in your throat, you cannot breathe very well, and your body is trying to cool down. You are in a hostile environment, but a magic one. It is a breathtaking experience for anyone."</p>
                        <p class="text-right font-semibold text-gray-700">- Dr. Paolo Forti, Geologist and Naica Explorer</p>
                    </div>` } },
                
                { id: 'podcast-experts', type: 'dialogue', content: { title: 'Listening: Science Uncovered <span aria-hidden="true">üéß</span>', dialogue: "Dr. Eva Rostova: Welcome to 'Deep Dive.' We're joined by geologist Dr. Marcus Thorne and astrobiologist Dr. Kenji Tanaka. Marcus, what makes Naica unique?\n\nDr. Marcus Thorne: Stability, Eva. The key is the stability. You had this geode-like cavern sitting above a cooling magma chamber, keeping the water at a near-constant temperature for half a million years. It created the perfect, undisturbed nursery for those selenite crystals to grow to their colossal size. It's a geological time capsule.\n\nDr. Eva Rostova: And Kenji, you found more than just crystals, correct?\n\nDr. Kenji Tanaka: Absolutely. We took samples from inside tiny fluid pockets within the crystals. In them, we found microbes‚Äîbacteria and archaea‚Äîthat were dormant. We managed to reanimate them in the lab. These are extremophiles that had been trapped, essentially sleeping, for tens of thousands of years. They tell us that even in what seems like a sterile, hellish environment, life can persist in the most remarkable ways." } },
                { id: 'podcast-experts-quiz-mcq', type: 'quiz-mcq', content: { title: 'Podcast Quiz (MCQ)', questions: [] } },
                { id: 'podcast-experts-quiz-tfng', type: 'quiz-tfng', content: { title: 'Podcast Quiz (TFNG)', questions: [] } },
                { id: 'podcast-experts-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Podcast Quiz (Gap Fill)', sentences: [] } },

                { id: 'debate-ethics', type: 'dialogue', content: { title: 'Discussion: To Seal or To Study? <span aria-hidden="true">ü§î</span>', dialogue: "Moderator: Today's question: Now that the Naica mine has flooded, should humanity attempt to re-drain it for science, or leave it sealed forever to preserve it?\n\nDr. Aisha Khan: We must leave it sealed. The cave is a priceless, fragile treasure. Our presence, however careful, is a contamination. The suits we wear, the equipment we bring, the very air we exhale‚Äîit all alters the delicate balance. We studied it for a brief time. Now, we should let it return to its natural state, preserving it for a future generation that might have non-invasive technology to see it without harming it.\n\nDr. Ben Carter: I strongly disagree. Leaving it flooded is a death sentence for scientific knowledge. We barely scratched the surface. We have unanswered questions about the extremophiles, the precise rate of crystal growth, the geology. Draining it, even for short, targeted missions with robotic probes and improved suits, would yield data that could help us understand the limits of life and the history of our planet. Knowledge we gain could be far more valuable than preserving something no one can ever see or learn from again." } },
                { id: 'debate-ethics-quiz-mcq', type: 'quiz-mcq', content: { title: 'Debate Quiz (MCQ)', questions: [] } },
                { id: 'debate-ethics-quiz-tfng', type: 'quiz-tfng', content: { title: 'Debate Quiz (TFNG)', questions: [] } },
                { id: 'debate-ethics-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Debate Quiz (Gap Fill)', sentences: [] } },
                
                { id: 'writing-activity', type: 'html-content', content: { title: 'Writing Activity <span aria-hidden="true">üìù</span>', html: `
                    <div class="bg-white rounded-2xl shadow-xl p-8 text-left">
                        <h2 class="text-3xl font-bold text-purple-600 mb-4">First Contact: A Scientist's Journal</h2>
                        <div class="space-y-3 text-lg readable-content">
                            <p><strong>Your Task:</strong> You are one of the first scientists to enter the Cave of Crystals. Write a 250-word journal entry describing your first ten minutes inside. Focus on the sensory details and your scientific thoughts.</p>
                            <p>In your journal entry, describe:</p>
                            <ul class="list-disc list-inside ml-4">
                                <li>The overwhelming heat and humidity and how your cooling suit is performing.</li>
                                <li>The visual spectacle of the giant <strong>selenite</strong> crystals. Use descriptive language (light, shape, scale).</li>
                                <li>Your immediate scientific questions. What geological or biological mysteries do you want to solve?</li>
                            </ul>
                        </div>
                         <div class="word-bank-container mt-6 p-4 bg-gray-100 rounded-lg flex flex-wrap gap-3 justify-center">
                            <h4 class="w-full text-center font-bold text-gray-700 mb-2">Word Bank</h4>
                            <span class="bg-white p-2 rounded-md shadow-sm">Selenite</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Hydrothermal</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Geology</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Extremophile</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Cavern</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Humidity</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Crystalline</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Geode</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Supersaturated</span>
                        </div>
                        <div class="mt-8">
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">My Field Journal <span aria-hidden="true">üìì</span></h3>
                            <textarea id="journal-entry" class="w-full h-64 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Start writing your 250-word journal entry here..."></textarea>
                        </div>
                    </div>` } },
                { id: 'explorers-log', type: 'summary', content: { title: 'Explorer\'s Log <span aria-hidden="true">üìú</span>', text: 'You\'ve completed your journey into the Naica Mine. Here is a summary of your exploration.' } },
                { id: 'final-project-hub', type: 'html-content', content: { title: 'Final Projects Hub <span aria-hidden="true">‚úçÔ∏è</span>', html: `
                    <div class="bg-white rounded-2xl shadow-xl p-8 text-left space-y-8">
                        <div>
                            <h2 class="text-3xl font-bold text-violet-600 mb-4">Assessment 1: GRASPS Task</h2>
                            <div class="space-y-3 text-lg">
                                <p><strong class="font-semibold text-violet-700">Goal:</strong> To design a compelling and informative museum exhibit about the Naica Cave of Crystals.</p>
                                <p><strong class="font-semibold text-violet-700">Role:</strong> You are a team of exhibit designers at a major science museum.</p>
                                <p><strong class="font-semibold text-violet-700">Audience:</strong> The museum's board of directors, who will approve funding for the new exhibit.</p>
                                <p><strong class="font-semibold text-violet-700">Situation:</strong> The museum wants a new blockbuster exhibit on "Extreme Earth." Your team must pitch an interactive exhibit on Naica that is both scientifically accurate and thrilling for visitors of all ages.</p>
                                <p><strong class="font-semibold text-violet-700">Product:</strong> A digital presentation or physical poster that includes: 1) A catchy title for the exhibit, 2) A floor plan sketch of the exhibit, 3) A description of at least three interactive elements (e.g., a "heat and humidity simulation room," a VR tour, a crystal-growing lab).</p>
                                <p><strong class="font-semibold text-violet-700">Standards:</strong> Your proposal will be judged on its creativity, scientific accuracy, and potential to engage a public audience.</p>
                            </div>
                        </div>
                        <hr>
                        <div>
                            <h2 class="text-3xl font-bold text-violet-600 mb-4">Assessment 2: Problem-Solving Group Project</h2>
                            <div class="space-y-3 text-lg">
                                <p><strong class="font-semibold text-violet-700">Challenge:</strong> The Cave of Crystals is too dangerous for extensive human exploration. Your group is a robotics engineering firm tasked with designing a probe to explore the cave after it has been re-flooded.</p>
                                <p><strong class="font-semibold text-violet-700">Deliverable:</strong> A 10-slide presentation detailing your submersible robotic probe, "CRYSTAL-BOT." The presentation must cover: 1) The probe's design and materials (how will it survive the heat, pressure, and minerals?), 2) The scientific instruments it will carry (what data will it collect?), 3) Its method of propulsion and navigation among the giant crystals, and 4) How it will transmit data back to the surface.</p>
                            </div>
                        </div>
                    </div>` } },
                { id: 'certificate', type: 'certificate', content: { title: 'Module Complete! <span aria-hidden="true">üéâ</span>', text: 'You have successfully completed the "Naica Mine" module.', certificateTitle: 'Certificate of Geological Exploration' } }
            ]
        };
        // --- END OF LESSON CONTENT CONFIGURATION ---
        // ===================================================================================

     class SpeechService {
            constructor() { this.synth = window.speechSynthesis; this.isInitialized = false; this.isTtsEnabled = true; this.voices = {}; this.speechRate = 0.85; this.isDialoguePlaying = false; }
            async _setupVoices() {
                const voicesPromise = new Promise(resolve => { if (this.synth.getVoices().length) return resolve(this.synth.getVoices()); this.synth.onvoiceschanged = () => resolve(this.synth.getVoices()); });
                const availableVoices = await voicesPromise;
                if (!availableVoices.length) { console.warn("No speech synthesis voices available."); return; }
                const speakerToVoiceMap = {
                    'juan': ['Microsoft Andrew Online (Natural) - English (United States)'],
                    'pedro': ['Microsoft Brian Online (Natural) - English (United States)'],
                    'dr. eva rostova': ['Microsoft Ava Online (Natural) - English (United States)'],
                    'dr. marcus thorne': ['Microsoft Brian Online (Natural) - English (United States)'],
                    'dr. kenji tanaka': ['Microsoft Andrew Online (Natural) - English (United States)'],
                    'moderator': ['Microsoft Brian Online (Natural) - English (United States)'],
                    'dr. aisha khan': ['Microsoft Emma Online (Natural) - English (United States)'],
                    'dr. ben carter': ['Microsoft Brian Online (Natural) - English (United States)'],
                    'vocab': ['Microsoft Andrew Online (Natural) - English (United States)'],
                };
                for (const speaker in speakerToVoiceMap) {
                    const voicePriorityList = speakerToVoiceMap[speaker];
                    let chosenVoice = null;
                    for (const voiceName of voicePriorityList) {
                        const foundVoice = availableVoices.find(v => v.name === voiceName);
                        if (foundVoice) { chosenVoice = foundVoice; break; }
                    }
                    if (chosenVoice) { this.voices[speaker] = chosenVoice; } else { console.warn(`Could not find specified voices for speaker: "${speaker}"`); }
                }
                this.voices['default'] = availableVoices.find(v => v.name === 'Microsoft Ava Online (Natural) - English (United States)') || availableVoices.find(v => v.lang.startsWith('en-'));
            }
            async init() { if (this.isInitialized) return; try { const warmUp = new SpeechSynthesisUtterance(' '); warmUp.volume = 0; this.synth.speak(warmUp); this.synth.cancel(); await this._setupVoices(); this.isInitialized = true; } catch (e) { console.error("Speech synthesis setup failed:", e); } }
            _cleanTextForSpeech(text) { const tempDiv = document.createElement('div'); const textWithoutSpans = text.replace(/<span aria-hidden="true">.*?<\/span>/g, ' '); tempDiv.innerHTML = textWithoutSpans; let cleanText = tempDiv.textContent || tempDiv.innerText || ''; cleanText = cleanText.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, ''); return cleanText; }
            async speak(text, { onEndCallback = null, voiceKey = 'default' } = {}) { if (!this.isInitialized || !this.isTtsEnabled || !text) { if (onEndCallback) onEndCallback(); return; } if (this.synth.speaking) { this.synth.cancel(); await new Promise(resolve => setTimeout(resolve, 100)); } const cleanText = this._cleanTextForSpeech(text); if (!cleanText.trim()) { if (onEndCallback) onEndCallback(); return; } const utter = new SpeechSynthesisUtterance(cleanText); utter.voice = this.voices[voiceKey] || this.voices['default']; utter.rate = this.speechRate; if (onEndCallback) utter.onend = onEndCallback; utter.onerror = (e) => { console.error('SpeechSynthesisUtterance.onerror', e); if (onEndCallback) onEndCallback(); }; try { this.synth.speak(utter); } catch (e) { console.error("Error calling synth.speak:", e); if (onEndCallback) onEndCallback(); } }
            async speakDialogue(text) { if (!this.isInitialized || !this.isTtsEnabled || !text || this.isDialoguePlaying) return; this.cancel(); this.isDialoguePlaying = true; const lines = text.split('\n').filter(line => line.trim() !== '' && line.includes(':')); const queue = lines.map(line => { const [speaker, ...parts] = line.split(':'); const dialogue = parts.join(':').trim(); const cleanDialogue = this._cleanTextForSpeech(dialogue); const voiceKey = speaker.toLowerCase().replace(/dr\. |professor /g, '').trim(); return { text: cleanDialogue, voiceKey: voiceKey }; }).filter(item => item.text); if (queue.length === 0) { this.isDialoguePlaying = false; return; } const playNext = () => { if (queue.length > 0 && this.isTtsEnabled) { const item = queue.shift(); const utter = new SpeechSynthesisUtterance(item.text); utter.voice = this.voices[item.voiceKey] || this.voices['default']; utter.rate = this.speechRate; utter.onend = playNext; utter.onerror = (e) => { console.warn('A speech synthesis error occurred, attempting to recover.', e.error); try { this.synth.cancel(); } catch (cancelError) { console.error("Error while cancelling synth:", cancelError); } setTimeout(playNext, 250); }; try { this.synth.speak(utter); } catch(e) { console.error("Error in synth.speak:", e); setTimeout(playNext, 250); } } else { this.isDialoguePlaying = false; } }; playNext(); }
            cancel() { if (this.synth) { this.isDialoguePlaying = false; this.synth.cancel(); } }
            toggleTTS(forceState) { this.isTtsEnabled = forceState === undefined ? !this.isTtsEnabled : forceState; if (!this.isTtsEnabled) { this.cancel(); } return this.isTtsEnabled; }
        }

        const speechService = new SpeechService();
        let score = 0, currentPage = lessonData.startPageId, timerInterval;
        const pageHistory = [lessonData.startPageId];
        let pageSequence = [];
        let completedSections = new Set();
        let earnedBadges = new Set();
        let vocabGameTimer;
        let selectedWord = { element: null, text: '' };
        let correctSoundSynth;

        const pageToMenuMap = {};
        function buildPageToMenuMap() {
            lessonData.mainMenu.forEach(menuItem => {
                let queue = [menuItem.target];
                let visited = new Set(queue);
                while (queue.length > 0) {
                    const pageId = queue.shift();
                    pageToMenuMap[pageId] = menuItem.id;
                    const pageDef = lessonData.pages.find(p => p.id === pageId);
                    if (pageDef && pageDef.type.startsWith('quiz')) {
                        const nextQuizPage = getNextQuizPage(pageId);
                        if (nextQuizPage && !visited.has(nextQuizPage)) {
                            queue.push(nextQuizPage);
                            visited.add(nextQuizPage);
                        }
                    }
                }
            });
            pageToMenuMap['vocab-game'] = 'menu-vocab-game';
        }

        function getNextQuizPage(pageId) {
            const sequence = ['mcq', 'tfng', 'gap-fill'];
            const parts = pageId.split('-quiz-');
            if (parts.length < 2) return null;
            const prefix = parts[0];
            const type = parts[1];
            const currentIndex = sequence.indexOf(type);
            if (currentIndex > -1 && currentIndex < sequence.length - 1) {
                const nextPageId = `${prefix}-quiz-${sequence[currentIndex + 1]}`;
                if (lessonData.pages.some(p => p.id === nextPageId)) { return nextPageId; }
            }
            return null;
        }

        function updateProgressBar() {
            const progress = (completedSections.size / lessonData.mainMenu.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        function updateMenuCompletionState() {
            const menuContainer = document.getElementById('page-main-menu');
            if (!menuContainer) return;
            lessonData.mainMenu.forEach(item => {
                const button = menuContainer.querySelector(`#menu-btn-${item.id}`);
                if (button && completedSections.has(item.id) && !button.innerHTML.includes('‚úì')) {
                    button.innerHTML += ' <span class="text-green-300">‚úì</span>';
                }
            });
        }
        
        function showBadgeToast(badge) {
            const toast = document.createElement('div');
            toast.innerHTML = `üèÖ Badge Unlocked: <strong>${badge.name}</strong>`;
            toast.className = 'badge-toast';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function markSectionAsComplete(pageId) {
            const menuId = pageToMenuMap[pageId];
            if (menuId && !completedSections.has(menuId)) {
                completedSections.add(menuId);
                updateProgressBar();
                const menuItem = lessonData.mainMenu.find(item => item.id === menuId);
                if (menuItem && menuItem.badge) {
                    const badge = lessonData.badges.find(b => b.id === menuItem.badge);
                    if (badge && !earnedBadges.has(badge.id)) {
                        earnedBadges.add(badge.id);
                        showBadgeToast(badge);
                    }
                }
            }
        }
        
        function checkQuizPageCompletion(pageId) {
            const pageElement = document.getElementById(`page-${pageId}`);
            if (!pageElement) return false;
            if (pageId.includes('gap-fill')) {
                const gaps = pageElement.querySelectorAll('.gap');
                return gaps.length > 0 && Array.from(gaps).every(g => g.classList.contains('correct'));
            } else {
                const questions = pageElement.querySelectorAll('.question-group');
                return questions.length > 0 && Array.from(questions).every(q => q.querySelector('button:disabled'));
            }
        }

        window.toggleTTS = (button) => {
            const isNowEnabled = speechService.toggleTTS();
            const iconPath = isNowEnabled 
                ? "M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"
                : "M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z M17 14l-4-4m0 4l4-4";
            button.querySelector('svg').classList.toggle('text-gray-600', isNowEnabled);
            button.querySelector('svg').classList.toggle('text-gray-400', !isNowEnabled);
            button.querySelector('path').setAttribute('d', iconPath);
            if (isNowEnabled) {
                const pageData = lessonData.pages.find(p => p.id === currentPage);
                const targetPage = document.getElementById(`page-${currentPage}`);
                if (pageData && pageData.type === 'dialogue') { speechService.speakDialogue(pageData.content.dialogue); } 
                else if (targetPage) {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    if (readableContent) speechService.speak(readableContent.innerText);
                    else if (titleElement) speechService.speak(titleElement.innerText);
                }
            }
        };

        window.startApp = async function() {
            await speechService.init(); 
            try { await Tone.start(); } catch (e) { console.error(e); }
            navigateTo(lessonData.homePageId);
        }
        
        function startTimer(duration, display, onComplete) {
            let timer = duration;
            const update = () => { display.textContent = `${String(Math.floor(timer/60)).padStart(2,'0')}:${String(timer%60).padStart(2,'0')}`; };
            update();
            timerInterval = setInterval(() => { timer--; update(); if (timer < 0) { clearInterval(timerInterval); if (onComplete) onComplete(); } }, 1000);
        }

        window.navigateTo = (pageId) => {
            const previousPageId = currentPage;
            if (previousPageId.includes('-quiz-') && checkQuizPageCompletion(previousPageId)) {
                const nextQuizPage = getNextQuizPage(previousPageId);
                if (!nextQuizPage) { markSectionAsComplete(previousPageId); }
            }
            const targetPage = document.getElementById(`page-${pageId}`);
            if (!targetPage) return console.warn('navigateTo: no page found for id', pageId);
            if (pageId === currentPage) return;
            
            clearInterval(timerInterval);
            clearTimeout(vocabGameTimer);
            speechService.cancel();

            const previousPageDef = lessonData.pages.find(p => p.id === previousPageId);
            if (previousPageDef && !previousPageDef.type.startsWith('quiz') && previousPageId !== 'vocab-game') {
                 markSectionAsComplete(previousPageId);
            }

            document.getElementById(`page-${currentPage}`)?.classList.remove('active');
            targetPage.classList.add('active');
            currentPage = pageId;
            if (pageHistory[pageHistory.length - 1] !== currentPage) pageHistory.push(currentPage);
            
            const pageData = lessonData.pages.find(p => p.id === pageId);
            if (pageData) {
                if (pageData.type === 'timer') { const timerEl = document.getElementById(pageData.content.timerId); if (timerEl) startTimer(pageData.content.duration, timerEl, goNext); } 
                else if (pageData.type === 'vocab-game') { startVocabGame(); }
                else if (pageData.type === 'summary') {
                    document.getElementById('log-score').textContent = score;
                    const badgesContainer = document.getElementById('log-badges');
                    badgesContainer.innerHTML = '';
                    if (earnedBadges.size === 0) {
                        badgesContainer.innerHTML = '<p class="text-gray-500">No badges earned yet. Complete sections to unlock them!</p>';
                    } else {
                        earnedBadges.forEach(badgeId => {
                            const badge = lessonData.badges.find(b => b.id === badgeId);
                            if(badge) {
                                badgesContainer.innerHTML += `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md flex items-center gap-4"><span class="text-3xl">${badge.emoji}</span><div><p class="font-bold">${badge.name}</p><p class="text-sm">${badge.description}</p></div></div>`;
                            }
                        });
                    }
                }
                
                if (pageId.startsWith('vocab-')) {
                    const vocabIndex = parseInt(pageId.split('-')[1]);
                    const vocabItem = lessonData.vocabulary[vocabIndex];
                    if (vocabItem) {
                        const textToSpeak = `${vocabItem.word}. ${vocabItem.def}. For example: ${vocabItem.sentence}`;
                        speechService.speak(textToSpeak, { voiceKey: 'vocab' });
                    }
                } else if (pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    const contentToSpeak = readableContent ? readableContent.innerText : (titleElement ? titleElement.innerText : '');
                    speechService.speak(contentToSpeak);
                }
            } else if (pageId === lessonData.homePageId) {
                speechService.speak(targetPage.querySelector('h2').innerText);
                updateMenuCompletionState();
            }
            updateNavButtons();
            window.scrollTo(0, 0);
        }

        window.goNext = () => { const currentIndex = pageSequence.indexOf(currentPage); if (currentIndex > -1 && currentIndex < pageSequence.length - 1) navigateTo(pageSequence[currentIndex + 1]); }
        window.goBack = () => { if (pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); } }

        function updateNavButtons() {
            const nav = document.getElementById('nav-header');
            if (!nav) return;
            nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
            const backBtn = nav.querySelector('button:first-child');
            backBtn.disabled = pageHistory.length <= 1;
            backBtn.classList.toggle('opacity-50', backBtn.disabled);
            const nextBtn = nav.querySelector('button:last-child');
            const currentIndex = pageSequence.indexOf(currentPage);
            const isLast = currentIndex >= pageSequence.length - 1;
            nextBtn.disabled = isLast || currentPage === lessonData.homePageId;
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }
        
        function playCorrectSound() {
            if (!correctSoundSynth) {
                correctSoundSynth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 },
                }).toDestination();
            }
            const now = Tone.now();
            correctSoundSynth.triggerAttackRelease("C5", "8n", now);
            correctSoundSynth.triggerAttackRelease("G5", "8n", now + 0.2);
        }

        function triggerConfetti() {
            const container = document.getElementById('reward-animation-container');
            const colors = ['#a5f3fc', '#d8b4fe', '#f9a8d4', '#a78bfa', '#fefce8'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                const size = Math.random() * 8 + 4;
                confetti.style.position = 'absolute';
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.top = `50%`;
                confetti.style.left = `50%`;
                confetti.style.opacity = '1';
                const angle = Math.random() * 360;
                const distance = Math.random() * 150 + 50;
                const animName = `confetti-burst-${i}`;
                const styleSheet = document.createElement("style");
                styleSheet.innerText = `@keyframes ${animName} { 0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); opacity: 1; } 100% { transform: translate(calc(-50% + ${Math.cos(angle * Math.PI / 180) * distance}vw), calc(-50% + ${Math.sin(angle * Math.PI / 180) * distance}vh)) rotate(360deg) scale(0); opacity: 0; } }`;
                document.head.appendChild(styleSheet);
                confetti.style.animation = `${animName} 1.5s ease-out forwards`;
                container.appendChild(confetti);
                setTimeout(() => { confetti.remove(); styleSheet.remove(); }, 1500);
            }
        }


        function showFeedbackMessage(isCorrect, verbalPraise = false) {
            const correctFeedback = ["That's right!", "Excellent!", "Perfect!", "Great job!"];
            const incorrectFeedback = ["Not quite.", "Keep trying!", "Almost there."];
            const message = isCorrect ? correctFeedback[Math.floor(Math.random() * correctFeedback.length)] : incorrectFeedback[Math.floor(Math.random() * incorrectFeedback.length)];
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `feedback-toast ${isCorrect ? 'correct' : 'encouraging'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
            if (isCorrect && verbalPraise) {
                speechService.speak(message);
            }
        }

        function updateScore(points) { score += points; document.getElementById('score-display').textContent = score; }

        function checkCompletionAndMark() {
            const nextQuizPage = getNextQuizPage(currentPage);
             if (!nextQuizPage && checkQuizPageCompletion(currentPage)) {
                 markSectionAsComplete(currentPage);
             }
        }

        function handleCorrectAnswer(button) {
            updateScore(10);
            playCorrectSound();
            triggerConfetti();
            showFeedbackMessage(true, true);
        }

        window.checkTfngAnswer = function(clickedButton, chosenAnswer, correctAnswer) {
            const buttonContainer = clickedButton.parentElement;
            Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
            const isCorrect = chosenAnswer === correctAnswer;
            if (isCorrect) {
                handleCorrectAnswer(clickedButton);
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-green-500');
            } else {
                showFeedbackMessage(false, false);
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-red-600');
                const correctBtn = Array.from(buttonContainer.children).find(btn => btn.textContent === correctAnswer.charAt(0));
                if (correctBtn) correctBtn.className = correctBtn.className.replace(/bg-\w+-500/, 'bg-green-500');
            }
            setTimeout(checkCompletionAndMark, 100);
        }
        
        window.checkMcqAnswer = function(button, isCorrect) {
            const questionGroup = button.closest('.question-group');
            questionGroup.querySelectorAll('.quiz-option').forEach(opt => opt.disabled = true);
            if (isCorrect) {
                handleCorrectAnswer(button);
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'border-green-600', 'text-white');
            } else {
                showFeedbackMessage(false, false);
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'border-red-600', 'text-white', 'shake');
                const correctButton = questionGroup.querySelector(".quiz-option[data-correct='true']");
                if (correctButton) {
                    correctButton.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    correctButton.classList.add('bg-green-500', 'border-green-600', 'text-white');
                }
            }
            setTimeout(checkCompletionAndMark, 100);
        }

        function initGapFill(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return;
            const gaps = page.querySelectorAll('.gap');
            const words = page.querySelectorAll('.word-bank-word');
            const wordBank = page.querySelector('.word-bank-container');

            words.forEach(word => {
                word.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', word.dataset.word); });
                word.addEventListener('click', handleWordClick);
            });
            gaps.forEach(gap => {
                gap.addEventListener('dragover', e => e.preventDefault());
                gap.addEventListener('drop', e => handleDrop(e, gap));
                gap.addEventListener('click', handleGapClick);
            });

            function handleWordClick(e) {
                const clickedWord = e.currentTarget;
                if (clickedWord.parentElement.classList.contains('gap')) { 
                    clickedWord.parentElement.classList.remove('correct', 'incorrect');
                    wordBank.appendChild(clickedWord); 
                    return; 
                }
                if (selectedWord.element) selectedWord.element.classList.remove('selected');
                if (selectedWord.element === clickedWord) { selectedWord = { element: null, text: '' }; } 
                else { selectedWord = { element: clickedWord, text: clickedWord.dataset.word }; clickedWord.classList.add('selected'); }
            }
            function handleGapClick(e) {
                const clickedGap = e.currentTarget;
                if (clickedGap.children.length > 0 && selectedWord.element) { // Swap words
                    const wordInGap = clickedGap.children[0];
                    const originalParent = selectedWord.element.parentElement;
                    originalParent.appendChild(wordInGap);
                    clickedGap.appendChild(selectedWord.element);
                    checkGap(clickedGap);
                } else if (selectedWord.element) { // Place word in empty gap
                    clickedGap.appendChild(selectedWord.element);
                    checkGap(clickedGap);
                } else if (clickedGap.children.length > 0) { // Return word to bank
                    wordBank.appendChild(clickedGap.children[0]);
                    clickedGap.classList.remove('correct', 'incorrect');
                }
                if(selectedWord.element) selectedWord.element.classList.remove('selected');
                selectedWord = { element: null, text: '' };
            }
            function handleDrop(e, gap) {
                e.preventDefault();
                const wordText = e.dataTransfer.getData('text/plain');
                const wordElement = page.querySelector(`.word-bank-word[data-word="${wordText}"]`);
                if (wordElement) { 
                    if (gap.children.length > 0) {
                        wordBank.appendChild(gap.children[0]);
                        gap.classList.remove('correct', 'incorrect');
                    }
                    gap.appendChild(wordElement); 
                    checkGap(gap); 
                }
            }
            function checkGap(gap) {
                const word = gap.querySelector('.word-bank-word');
                const isCorrect = word && word.dataset.word.toLowerCase() === gap.dataset.answer.toLowerCase();
                gap.classList.toggle('correct', isCorrect);
                gap.classList.toggle('incorrect', !isCorrect);
                if (isCorrect) { 
                    handleCorrectAnswer(gap);
                } else { 
                    showFeedbackMessage(false, false); 
                }
                setTimeout(checkCompletionAndMark, 100);
            }
        }

        let vocabGameQuestions = []; let vocabGameCurrentIndex = 0; let vocabGameScore = 0; const ROUND_TIME = 10000;
        function startVocabGame() {
            vocabGameQuestions = [...lessonData.vocabulary].sort(() => 0.5 - Math.random());
            vocabGameCurrentIndex = 0; vocabGameScore = 0;
            document.getElementById('vocab-game-score').textContent = '0';
            nextVocabGameRound();
        }
        function nextVocabGameRound() {
            if (vocabGameCurrentIndex >= vocabGameQuestions.length) { endVocabGame(); return; }
            const question = vocabGameQuestions[vocabGameCurrentIndex];
            document.getElementById('vocab-game-definition').textContent = question.def;
            const options = [question.word];
            const wrongAnswers = lessonData.vocabulary.filter(v => v.word !== question.word);
            while (options.length < 4 && wrongAnswers.length > 0) {
                const randomWrong = wrongAnswers.splice(Math.floor(Math.random() * wrongAnswers.length), 1)[0];
                options.push(randomWrong.word);
            }
            const optionsContainer = document.getElementById('vocab-game-options');
            optionsContainer.innerHTML = '';
            options.sort(() => 0.5 - Math.random()).forEach(opt => {
                const button = document.createElement('button');
                button.className = 'quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200';
                button.textContent = opt;
                button.onclick = () => checkVocabGameAnswer(button, opt === question.word);
                optionsContainer.appendChild(button);
            });
            startRoundTimer();
        }
        function startRoundTimer() {
            clearTimeout(vocabGameTimer);
            const timerBar = document.getElementById('vocab-game-timer-bar');
            timerBar.style.transition = 'none'; timerBar.style.width = '100%';
            setTimeout(() => {
                timerBar.style.transition = `width ${ROUND_TIME / 1000}s linear`;
                timerBar.style.width = '0%';
            }, 100);
            vocabGameTimer = setTimeout(() => {
                showFeedbackMessage(false, false);
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, ROUND_TIME);
        }
        function checkVocabGameAnswer(button, isCorrect) {
            clearTimeout(vocabGameTimer);
            if (isCorrect) {
                handleCorrectAnswer(button);
                vocabGameScore++;
                document.getElementById('vocab-game-score').textContent = vocabGameScore;
                button.classList.add('bg-green-500', 'text-white');
            } else {
                showFeedbackMessage(false, false);
                button.classList.add('bg-red-500', 'text-white', 'shake');
            }
            document.getElementById('vocab-game-options').querySelectorAll('button').forEach(btn => btn.disabled = true);
            setTimeout(() => {
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, 1500);
        }
        function endVocabGame() {
            document.getElementById('vocab-game-definition').textContent = `Game Over! You scored ${vocabGameScore} out of ${vocabGameQuestions.length}.`;
            document.getElementById('vocab-game-options').innerHTML = `<button onclick="startVocabGame()" class="action-button bg-blue-500 text-white font-bold p-3 rounded-lg">Play Again</button>`;
            markSectionAsComplete('vocab-game');
        }

        function createPageElement(id, content) {
            const section = document.createElement('section');
            section.id = `page-${id}`;
            section.className = 'page';
            section.innerHTML = content;
            document.getElementById('dynamic-pages-container').appendChild(section);
        }
        
        function populateAllQuizzes() {
            const quizzes = {
                'reading-discovery': { mcq: [ { question: "In what year was the Cave of Crystals discovered?", options: ["1910", "2000", "1995", "2010"], correctAnswer: "2000" }, { question: "What were the miners originally looking for?", options: ["Gold and diamonds", "Lead, zinc, and silver", "Iron and copper", "Water"], correctAnswer: "Lead, zinc, and silver" }, { question: "What is the main danger to humans inside the cave?", options: ["Lack of oxygen", "Risk of collapse", "Wild animals", "Extreme heat and humidity"], correctAnswer: "Extreme heat and humidity" }, { question: "What needed to happen for the cave to be discovered?", options: ["An earthquake", "The cave had to be drained of water", "A new type of drill was invented", "The magma chamber had to cool"], correctAnswer: "The cave had to be drained of water" }, { question: "The giant crystals are made of what mineral?", options: ["Quartz", "Diamond", "Selenite", "Anhydrite"], correctAnswer: "Selenite" } ], tfng: [ { statement: "The Cave of Crystals was the first crystal cave found in the Naica Mine.", correctAnswer: "False" }, { statement: "The cave is located on the surface, exposed to the sun.", correctAnswer: "False" }, { statement: "A person can comfortably explore the cave for hours without special equipment.", correctAnswer: "False" }, { statement: "The cave's heat comes from a magma chamber below.", correctAnswer: "True" }, { statement: "The miners who found the cave were named Eloy and Javier Delgado.", correctAnswer: "True" } ], gap: [ { text: ["The cave was discovered by miners in", ", Mexico."], answer: "Naica" }, { text: ["The cavern is filled with enormous beams of", "."], answer: "selenite" }, { text: ["The air temperature in the cave can reach 58 degrees", "."], answer: "Celsius" }, { text: ["Without special", "suits, a person can only survive for a few minutes."], answer: "cooling" }, { text: ["The cave was revealed when the mining company's", "drained the water."], answer: "pumps" } ] },
                'reading-science': { mcq: [ { question: "What underground feature kept the cave's water hot?", options: ["An oil deposit", "A river", "A magma chamber", "A fault line"], correctAnswer: "A magma chamber" }, { question: "What was the 'magic' temperature for crystal growth?", options: ["0¬∞C (32¬∞F)", "100¬∞C (212¬∞F)", "58¬∞C (136¬∞F)", "25¬∞C (77¬∞F)"], correctAnswer: "58¬∞C (136¬∞F)" }, { question: "The immense size of the crystals is due to what factor?", options: ["Rapid, sudden growth", "Very high pressure", "Incredibly slow and stable growth", "A lack of water"], correctAnswer: "Incredibly slow and stable growth" }, { question: "What mineral, dissolved in the hot water, transformed into selenite?", options: ["Quartz", "Anhydrite", "Silver", "Calcite"], correctAnswer: "Anhydrite" }, { question: "What happened to the crystals after the cave was drained?", options: ["They started growing faster", "They turned a different color", "They stopped growing", "They melted"], correctAnswer: "They stopped growing" } ], tfng: [ { statement: "The crystals grew over a period of just a few years.", correctAnswer: "False" }, { statement: "The water in the cave was described as 'supersaturated' with minerals.", correctAnswer: "True" }, { statement: "The cave environment was very unstable, with temperatures changing constantly.", correctAnswer: "False" }, { statement: "Exposing the crystals to air has put them at risk.", correctAnswer: "True" }, { statement: "Scientists have already learned everything there is to know about the cave.", correctAnswer: "False" } ], gap: [ { text: ["The cave was filled with hot,", "-rich water."], answer: "mineral" }, { text: ["The water was kept at a stable temperature by a", "chamber."], answer: "magma" }, { text: ["The process of growth was incredibly", "and steady."], answer: "slow" }, { text: ["At the 'magic' temperature, anhydrite transforms into", "."], answer: "gypsum" }, { text: ["If the mining pumps are turned off, the cave will", "again."], answer: "flood" } ] },
                'convo-miners': { mcq: [ { question: "What was the first sign the miners had broken into a new area?", options: ["A loud noise", "A rush of hot, wet air", "A strange smell", "The drill broke"], correctAnswer: "A rush of hot, wet air" }, { question: "What did Pedro compare the cave to?", options: ["A scary monster", "A giant's treasure", "An underground river", "A normal tunnel"], correctAnswer: "A giant's treasure" }, { question: "Why did the light from their headlamps seem to disappear?", options: ["The crystals absorbed the light", "Their batteries were low", "The extreme humidity", "The cave was too big"], correctAnswer: "The extreme humidity" }, { question: "What did Juan compare breathing in the cave to?", options: ["A fresh breeze", "Breathing in hot soup", "Holding his breath", "The air in a freezer"], correctAnswer: "Breathing in hot soup" } ], tfng: [ { statement: "The miners immediately knew they had found silver.", correctAnswer: "False" }, { statement: "Pedro was scared and did not want to look inside.", correctAnswer: "False" }, { statement: "The cave was very noisy inside.", correctAnswer: "False" }, { statement: "The miners recognized the discovery was something unique.", correctAnswer: "True" } ], gap: [ { text: ["The drill's breakthrough caused a rush of hot, wet", "."], answer: "air" }, { text: ["Pedro said it looked like a", ", like a giant's treasure."], answer: "fairytale" }, { text: ["The light from their", "disappeared into the white crystals."], answer: "headlamps" }, { text: ["Juan described the feeling of breathing as being like hot", "."], answer: "soup" } ] },
                'podcast-experts': { mcq: [ { question: "According to Dr. Thorne, what was the absolute key to the crystals' growth?", options: ["Pressure", "Stability", "Darkness", "Acidity"], correctAnswer: "Stability" }, { question: "Dr. Thorne compares the cavern to what kind of geological formation?", options: ["A volcano", "A geode", "A canyon", "A glacier"], correctAnswer: "A geode" }, { question: "Where did Dr. Tanaka's team find the ancient microbes?", options: ["On the surface of the crystals", "In the air of the cave", "In tiny fluid pockets inside the crystals", "In the mine's drainage water"], correctAnswer: "In tiny fluid pockets inside the crystals" }, { question: "What did the scientists manage to do with the dormant microbes?", options: ["Photograph them", "Sequence their DNA", "Reanimate them", "Measure their age"], correctAnswer: "Reanimate them" }, { question: "What is the term for organisms that live in extreme environments?", options: ["Geologists", "Crystallographers", "Extremophiles", "Microbiologists"], correctAnswer: "Extremophiles" } ], tfng: [ { statement: "Dr. Thorne is an astrobiologist.", correctAnswer: "False" }, { statement: "The crystals grew over a period of about 1,000 years.", correctAnswer: "False" }, { statement: "The microbes found were dead and fossilized.", correctAnswer: "False" }, { statement: "The discovery suggests life can persist in very harsh environments.", correctAnswer: "True" }, { statement: "The podcast host's name is Dr. Eva Rostova.", correctAnswer: "True" } ], gap: [ { text: ["Dr. Thorne called the cave a geological time", "."], answer: "capsule" }, { text: ["The cave was a perfect, undisturbed", "for the crystals."], answer: "nursery" }, { text: ["Dr. Tanaka found microbes that were", ", or sleeping."], answer: "dormant" }, { text: ["These microbes are a type of", ", which thrive in harsh conditions."], answer: "extremophile" }, { text: ["The microbes had been trapped for tens of thousands of", "."], answer: "years" } ] },
                'debate-ethics': { mcq: [ { question: "What is Dr. Khan's main argument?", options: ["The cave is too expensive to study.", "We should preserve the cave by leaving it sealed.", "We should send more scientists into the cave.", "We should open the cave to tourists."], correctAnswer: "We should preserve the cave by leaving it sealed." }, { question: "What does Dr. Khan believe human presence does to the cave?", options: ["It helps preserve the crystals.", "It has no effect.", "It contaminates the environment.", "It makes the cave safer."], correctAnswer: "It contaminates the environment." }, { question: "What is Dr. Carter's main argument?", options: ["The cave is not scientifically interesting.", "Leaving the cave flooded prevents us from gaining valuable knowledge.", "Robots are not advanced enough to explore the cave.", "The cave should be mined for its crystals."], correctAnswer: "Leaving the cave flooded prevents us from gaining valuable knowledge." }, { question: "What tool does Dr. Carter suggest using for future exploration?", options: ["Better cooling suits", "Submarines", "Robotic probes", "Advanced drills"], correctAnswer: "Robotic probes" }, { question: "What does Dr. Khan suggest for future viewing of the cave?", options: ["Computer simulations", "Non-invasive technology", "Draining it again in 100 years", "Selling photographs"], correctAnswer: "Non-invasive technology" } ], tfng: [ { statement: "Both doctors agree that the cave is fragile.", correctAnswer: "True" }, { statement: "Dr. Carter believes we have learned everything we can from the cave.", correctAnswer: "False" }, { statement: "Dr. Khan is concerned about human contamination.", correctAnswer: "True" }, { statement: "The debate confirms that the Naica mine is currently drained and open.", correctAnswer: "False" }, { statement: "Dr. Carter thinks the knowledge gained outweighs the risks of contamination.", correctAnswer: "True" } ], gap: [ { text: ["Dr. Khan argues that we should leave the cave", "to preserve it."], answer: "sealed" }, { text: ["She believes that even the air we", "can alter the cave's balance."], answer: "exhale" }, { text: ["Dr. Carter argues that leaving it flooded is a death sentence for scientific", "."], answer: "knowledge" }, { text: ["He suggests using", "probes for future missions."], answer: "robotic" }, { text: ["Dr. Khan hopes future generations may have", "technology to see inside."], answer: "non-invasive" } ] }
            };
            for (const prefix in quizzes) {
                lessonData.pages.find(p => p.id === `${prefix}-quiz-mcq`).content.questions = quizzes[prefix].mcq;
                lessonData.pages.find(p => p.id === `${prefix}-quiz-tfng`).content.questions = quizzes[prefix].tfng;
                lessonData.pages.find(p => p.id === `${prefix}-quiz-gap-fill`).content.sentences = quizzes[prefix].gap;
            }
        }

        function initializeLesson() {
            document.getElementById('main-title').innerHTML = lessonData.title;
            document.getElementById('main-subtitle').innerHTML = lessonData.subtitle;
            document.getElementById('main-svg-container').innerHTML = `<svg viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="crystalGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#e0e7ff"/><stop offset="100%" stop-color="#a78bfa"/></linearGradient><filter id="glow"><feGaussianBlur stdDeviation="3.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><rect width="600" height="300" fill="#1e1b4b"/><g filter="url(#glow)" opacity="0.8"><path d="M100 300 L150 100 L200 300 Z" fill="url(#crystalGrad)"/><path d="M250 300 L280 50 L310 300 Z" fill="url(#crystalGrad)"/><path d="M400 300 L480 80 L560 300 Z" fill="url(#crystalGrad)"/><path d="M50 300 L80 150 L110 300 Z" fill="url(#crystalGrad)"/><path d="M500 300 L520 200 L540 300 Z" fill="url(#crystalGrad)"/></g></svg>`;

            populateAllQuizzes();
            buildPageToMenuMap();

            const menuButtons = lessonData.mainMenu.map(item => {
                const colors = { green: 'bg-green-500 border-green-700', blue: 'bg-blue-500 border-blue-700', sky: 'bg-sky-500 border-sky-700', amber: 'bg-amber-500 border-amber-700', rose: 'bg-rose-500 border-rose-700', violet: 'bg-violet-500 border-violet-700', teal: 'bg-teal-500 border-teal-700', orange: 'bg-orange-500 border-orange-700', indigo: 'bg-indigo-500 border-indigo-700', lime: 'bg-lime-500 border-lime-700', emerald: 'bg-emerald-500 border-emerald-700', red: 'bg-red-500 border-red-700', purple: 'bg-purple-500 border-purple-700' };
                return `<button id="menu-btn-${item.id}" onclick="navigateTo('${item.target}')" class="btn-animated-3d ${colors[item.color] || colors['green']} text-white font-bold text-xl p-4 rounded-xl">${item.text}</button>`;
            }).join('');
            createPageElement(lessonData.homePageId, `<div class="bg-white rounded-2xl shadow-lg p-8"><h2 class="text-4xl font-bold text-center text-slate-800 mb-8">Main Menu</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${menuButtons}</div></div>`);
            
            const pageOrderMap = { 
                'tps-start': ['tps-think', 'tps-pair', 'tps-share'], 'warm-up': ['vocab-start'], 'vocab-start': lessonData.vocabulary.map((v, i) => `vocab-${i}`),
                'reading-discovery': ['reading-discovery-quiz-mcq', 'reading-discovery-quiz-tfng', 'reading-discovery-quiz-gap-fill'], 'reading-science': ['deep-dive', 'reading-science-quiz-mcq', 'reading-science-quiz-tfng', 'reading-science-quiz-gap-fill'],
                'convo-miners': ['primary-source', 'convo-miners-quiz-mcq', 'convo-miners-quiz-tfng', 'convo-miners-quiz-gap-fill'], 'podcast-experts': ['podcast-experts-quiz-mcq', 'podcast-experts-quiz-tfng', 'podcast-experts-quiz-gap-fill'],
                'debate-ethics': ['debate-ethics-quiz-mcq', 'debate-ethics-quiz-tfng', 'debate-ethics-quiz-gap-fill'], 'writing-activity': ['final-project-hub'], 'final-project-hub': ['explorers-log', 'certificate'] 
            };
            let flatPageList = [lessonData.startPageId, lessonData.homePageId];
            lessonData.mainMenu.forEach(item => {
                let queue = [item.target]; let visited = new Set();
                while(queue.length > 0) {
                    let current = queue.shift(); if (visited.has(current)) continue;
                    visited.add(current); flatPageList.push(current);
                    if (current === 'vocab-start') { flatPageList.push(...lessonData.vocabulary.map((v, i) => `vocab-${i}`)); }
                    if (pageOrderMap[current]) { queue.push(...pageOrderMap[current]); }
                }
            });
            pageSequence = [...new Set(flatPageList)];

            lessonData.vocabulary.forEach((v, i) => {
                 createPageElement(`vocab-${i}`, `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h3 class="text-2xl font-bold text-sky-600 mb-2">Vocabulary ${i + 1} / ${lessonData.vocabulary.length}</h3><div class="my-8"><h2 class="text-5xl font-bold text-gray-800 mb-4">${v.word}</h2><p class="text-2xl text-gray-600 mb-4">${v.def}</p><p class="text-xl text-gray-500 italic">"${v.sentence}"</p></div></div></div>`);
            });

            lessonData.pages.forEach(page => {
                let pageHTML = '';
                switch (page.type) {
                    case 'simple': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-gray-800 mb-6">${page.content.title}</h2><p class="text-xl text-gray-600 mb-8">${page.content.text}</p></div></div>`; break;
                    case 'timer': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-left pt-16"><div class="w-full flex justify-between items-center mb-4"><h2 class="text-2xl md:text-3xl font-bold text-blue-700">${page.content.title}</h2><div id="${page.content.timerId}" class="text-3xl md:text-4xl font-bold text-gray-700 ml-4"></div></div><div class="readable-content"><p class="text-lg md:text-xl text-gray-600 mt-8">${page.content.text}</p></div></div>`; break;
                    case 'dialogue': case 'html-content':
                        const contentHTML = page.type === 'html-content' ? page.content.html : (page.content.dialogue || '').split('\n\n').map(line => `<p>${line.replace(/([^:]+):/, '<strong class="font-semibold text-blue-700">$1:</strong>')}</p>`).join('');
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-slate-800 mb-6">${page.content.title}</h2><div class="text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg max-h-[70vh] overflow-y-auto">${contentHTML}</div></div>`;
                        break;
                    case 'summary':
                         pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-slate-800 mb-6">${page.content.title}</h2><p class="text-center text-xl mb-6">${page.content.text}</p><div class="max-w-2xl mx-auto space-y-4"><div class="bg-violet-100 p-4 rounded-lg text-center"><p class="text-lg text-violet-800">Final Score</p><p id="log-score" class="text-4xl font-bold text-violet-600">0</p></div><h3 class="text-2xl font-bold text-center text-slate-700 pt-4">Badges Earned</h3><div id="log-badges" class="space-y-3"></div></div></div>`;
                        break;
                    case 'vocab-game':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-sky-600 mb-4">${page.content.title}</h2><div class="text-center mb-4 text-lg">Score: <span id="vocab-game-score" class="font-bold">0</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mb-4"><div id="vocab-game-timer-bar" class="bg-violet-500 h-2.5 rounded-full"></div></div><div id="vocab-game-definition" class="text-center text-2xl font-semibold my-6 min-h-[6rem]"></div><div id="vocab-game-options" class="grid grid-cols-2 gap-4"></div></div>`;
                        break;
                    case 'certificate':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16 relative overflow-hidden"><canvas id="completion-canvas"></canvas><div class="relative z-10"><div><h2 class="text-4xl font-bold text-amber-600 mb-4">${page.content.title}</h2><p class="text-xl text-gray-600 mb-6">${page.content.text}</p></div><div id="certificate-to-print" class="bg-gray-50 border-4 border-dashed border-gray-300 rounded-lg p-8 max-w-2xl mx-auto"><div class="flex justify-center mb-4"><span class="text-6xl" aria-hidden="true">üíé</span></div><h3 class="text-3xl font-bold text-slate-800">${page.content.certificateTitle}</h3><p class="mt-4 text-lg">This certificate is awarded to</p><p id="certificate-name" class="text-2xl font-bold text-violet-600 my-2 border-b-2 border-gray-400 pb-2">[Enter Your Name Here]</p><p class="mt-4 text-lg">for successfully completing this lesson.</p><p class="mt-6 text-md"><strong>Final Score:</strong> <span id="certificate-score" class="font-bold"></span> points</p><p class="text-sm mt-1"><strong>Date of Completion:</strong> <span id="certificate-date"></span></p></div><div id="cert-controls" class="mt-6"><div id="cert-initial-controls"><input type="text" id="name-input-cert" placeholder="Enter your name for the certificate" class="text-center p-2 border rounded-lg w-full max-w-md"><button onclick="generateCertificate()" class="action-button mt-4 bg-violet-500 text-white font-bold py-2 px-6 rounded-full hover:bg-violet-600">Generate Certificate</button></div><div id="cert-generated-controls" class="hidden mt-4 flex flex-wrap justify-center gap-4"><button onclick="downloadCertificateAsImage()" class="action-button bg-sky-600 text-white font-bold py-2 px-4 rounded-full text-sm">Download Image</button></div></div></div></div>`;
                        break;
                    case 'quiz-tfng': case 'quiz-mcq': case 'quiz-gap-fill':
                        let questionsHTML = '';
                        if (page.type === 'quiz-tfng' && page.content.questions) { questionsHTML = page.content.questions.map((q, i) => `<div class="question-group flex items-center gap-4 p-4 rounded-lg bg-gray-100"><div class="flex-shrink-0 flex gap-2">${['True', 'False', 'Not Given'].map(l => `<button onclick="checkTfngAnswer(this, '${l}', '${q.correctAnswer}')" class="tfng-button bg-${l==='True'?'blue':l==='False'?'red':'gray'}-500 text-white font-bold w-12 h-10 rounded-full">${l.charAt(0)}</button>`).join('')}</div><p>${i + 1}. ${q.statement}</p></div>`).join(''); } 
                        else if (page.type === 'quiz-mcq' && page.content.questions) { questionsHTML = page.content.questions.map((q, i) => `<div class="question-group ${i > 0 ? 'border-t pt-6 mt-6' : ''}"><p class="font-semibold mb-2">${i + 1}. ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-2">${q.options.map(o => `<button onclick="checkMcqAnswer(this, '${o.replace(/'/g, "\\'")}' === '${q.correctAnswer.replace(/'/g, "\\'")}')" data-correct="${o === q.correctAnswer}" class="quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200">${o}</button>`).join('')}</div></div>`).join(''); } 
                        else if (page.type === 'quiz-gap-fill' && page.content.sentences) { const words = page.content.sentences.map(s => s.answer).sort(() => Math.random() - 0.5); questionsHTML = `<div class="gap-fill-container">${page.content.sentences.map((s, i) => `<p class="text-lg mb-4">${i + 1}. ${s.text[0]} <span class="gap" data-answer="${s.answer}"></span> ${s.text[1] || ''}</p>`).join('')}</div><div class="word-bank-container mt-8 p-4 bg-gray-100 rounded-lg flex flex-wrap gap-4 justify-center">${words.map(w => `<div class="word-bank-word" draggable="true" data-word="${w}">${w}</div>`).join('')}</div>`; }
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h3 class="text-3xl font-bold text-rose-600 mb-6 text-center">${page.content.title}</h3><div class="space-y-6">${questionsHTML}</div></div>`;
                        break;
                }
                if (pageHTML) {
                    createPageElement(page.id, pageHTML);
                    if (page.type === 'quiz-gap-fill') initGapFill(`page-${page.id}`);
                }
            });
            updateNavButtons();
        }

        function generateCertificate() {
            const name = document.getElementById('name-input-cert').value || 'An Anonymous Learner';
            document.getElementById('certificate-name').textContent = name;
            document.getElementById('certificate-score').textContent = score;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
            document.getElementById('cert-initial-controls').classList.add('hidden');
            document.getElementById('cert-generated-controls').classList.remove('hidden');
            const canvas = document.getElementById('completion-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth * 2; canvas.height = canvas.offsetHeight * 2;
            let particles = Array.from({length: 50}, () => ({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, radius: Math.random() * 5 + 1, color: ['#a78bfa', '#f9a8d4', '#a5f3fc'][Math.floor(Math.random() * 3)], speed: Math.random() * 2 + 1 }));
            function animateCert() {
                ctx.clearRect(0,0,canvas.width, canvas.height);
                particles.forEach(p => {
                    p.y -= p.speed;
                    if(p.y < 0) { p.y = canvas.height; p.x = Math.random() * canvas.width; }
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2); ctx.fillStyle = p.color; ctx.fill();
                });
                requestAnimationFrame(animateCert);
            }
            animateCert();
        }

        function downloadCertificateAsImage() {
            html2canvas(document.getElementById('certificate-to-print'), { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Naica_Mine_Certificate.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeLesson();
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            let particles = [];
            const styleSheet = document.createElement("style");
            document.head.appendChild(styleSheet);
            
            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                particles.forEach((p, i) => {
                    p.y -= p.speed;
                    if (p.y < -p.radius) particles.splice(i, 1);
                    bgCtx.beginPath(); bgCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); bgCtx.fillStyle = p.color; bgCtx.fill();
                });
                if (Math.random() > 0.95 && particles.length < 50) {
                    particles.push({ x: Math.random() * bgCanvas.width, y: bgCanvas.height + 20, radius: Math.random() * 2 + 1, speed: Math.random() * 0.5 + 0.2, color: `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.1})` });
                }
                requestAnimationFrame(animateBackground);
            }
            window.addEventListener('resize', () => { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; });
            animateBackground();
        });
    </script>
</body>
</html>

