<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IELTS Pro: Galapagos Evolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700;900&display=swap');

        /* --- CORE LAYOUT --- */
        body {
            font-family: 'Noto Sans', sans-serif;
            background-color: #f0f9ff; /* Light Ocean Blue tint for Galapagos theme */
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        #app-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            position: relative;
            padding: 1.5rem;
        }

        /* --- UI COMPONENTS --- */
        .btn-3d {
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0px 4px 0px 0px rgba(0,0,0,0.15);
            transform: translateY(0);
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0px 0px 0px 0px rgba(0,0,0,0);
        }
        
        .fade-in { animation: fadeUp 0.3s ease-out forwards; width: 100%; height: 100%; display: flex; flex-direction: column; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }

        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Shimmer Effect for Correct Answers */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .shimmer-effect {
            background: linear-gradient(90deg, #bbf7d0 25%, #86efac 50%, #bbf7d0 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite linear;
            border-color: #16a34a !important;
            color: #14532d !important;
        }

        /* --- SPECIFIC ELEMENTS --- */
        .vocab-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
            border: 2px solid #e0f2fe;
        }

        /* Fixed Width Gap for Stability */
        .gap-slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 11rem; 
            border-bottom: 3px solid #0284c7; /* Sky blue */
            padding: 0 2px;
            margin: 0 4px;
            color: #0369a1;
            font-weight: 700;
            background: #e0f2fe;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            height: 1.4em;
            vertical-align: bottom;
            text-align: center;
            transition: all 0.2s;
            font-size: 1.25rem; 
        }
        .gap-slot.filled { background: #fff; border-bottom: 3px solid #0284c7; }
        .gap-slot.wrong { animation: shake 0.4s; background: #fecaca !important; border-color: #dc2626 !important; }

        /* Highlight Word */
        .highlight-word {
            transition: background-color 0.1s, color 0.1s;
            border-radius: 4px;
            padding: 0 2px;
        }
        .highlight-word.active {
            background-color: #7dd3fc; 
            color: #0c4a6e;
            font-weight: 700;
        }

        /* MCQ Large Format */
        .mcq-option-large {
            font-size: 1.35rem; 
            padding: 1rem;
            border: 3px solid #e0f2fe;
            border-radius: 1rem;
            transition: all 0.2s;
            text-align: left;
            background: white;
            height: 100%;
            display: flex;
            align-items: center;
            width: 100%;
        }
        .mcq-option-large:hover { border-color: #38bdf8; background: #f0f9ff; }
        .mcq-option-large.correct { background-color: #bbf7d0; border-color: #16a34a; }
        .mcq-option-large.wrong { background-color: #fecaca; border-color: #dc2626; }

        .word-bank-item {
            font-size: 1.1rem; 
            padding: 0.5rem 1rem; 
        }
        .word-bank-item.selected {
            background-color: #0284c7;
            color: white;
            border-color: #0369a1;
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .word-bank-item.used {
            opacity: 0.3;
            pointer-events: none;
            filter: grayscale(100%);
            transform: scale(0.95);
        }

        /* Praise Overlay */
        #praise-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            pointer-events: none;
            display: none;
        }
        #praise-text {
            font-size: 6rem;
            font-weight: 900;
            color: #0284c7;
            text-shadow: 0 4px 0 white, 0 8px 10px rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.95);
            padding: 2rem 4rem;
            border-radius: 2rem;
            border: 6px solid #0284c7;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }

    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-slate-900 text-white p-3 shadow-lg z-20 flex-none h-18">
        <div class="max-w-7xl mx-auto flex justify-between items-center h-full w-full px-2">
            
            <!-- Left: Home/Settings -->
            <div class="flex gap-4 items-center">
                <button onclick="resetProgress()" class="text-slate-400 hover:text-white transition" title="New Session">
                    <i class="fas fa-redo text-2xl"></i>
                </button>
                <div class="h-6 w-px bg-slate-700"></div>
                <button onclick="toggleAudio()" id="audio-btn" class="text-sky-400 hover:text-sky-300 transition" title="Toggle Auto-Play">
                    <i class="fas fa-volume-up text-2xl"></i>
                </button>
            </div>

            <!-- Center: Progress -->
            <div class="flex flex-col items-center flex-1 mx-4">
                <div class="w-full max-w-sm h-3 bg-slate-700 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-sky-500 w-0 transition-all duration-500"></div>
                </div>
            </div>

            <!-- Right: Actions & Nav -->
            <div class="flex items-center gap-3">
                <div id="header-actions"></div>
                <div class="bg-slate-800 px-3 py-1 rounded-lg text-xl font-mono border border-slate-600 min-w-[60px] text-center">
                    <span id="score-val" class="text-sky-400 font-bold">0</span>
                </div>
                
                <button id="prev-btn" class="bg-slate-700 hover:bg-slate-600 text-white w-12 h-10 rounded-lg flex items-center justify-center disabled:opacity-30 transition btn-3d">
                    <i class="fas fa-chevron-left text-lg"></i>
                </button>
                <button id="next-btn" class="bg-sky-600 hover:bg-sky-500 text-white px-5 h-10 rounded-lg font-bold flex items-center gap-2 btn-3d text-base transition shadow-sky-900/50">
                    NEXT <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Praise Overlay -->
    <div id="praise-overlay" class="pop-in">
        <div id="praise-text">Correct!</div>
    </div>

    <!-- Main Content -->
    <main id="app-content" class="bg-slate-50 relative w-full h-full">
        <!-- Injected here -->
    </main>

    <!-- Logic -->
    <script>
        /* --- STATE --- */
        const defaultState = {
            page: 0,
            score: 0,
            audioEnabled: true
        };

        let state = JSON.parse(localStorage.getItem('ielts_galapagos_v2')) || defaultState;

        function saveState() {
            localStorage.setItem('ielts_galapagos_v2', JSON.stringify(state));
        }

        function resetProgress() {
            if(confirm("Start a New Session? This will reset your score.")) {
                state = { ...defaultState, audioEnabled: state.audioEnabled };
                saveState();
                location.reload();
            }
        }
        
        function startUnit() {
            state.page = 1;
            saveState();
            render();
        }

        function toggleAudio() {
            state.audioEnabled = !state.audioEnabled;
            saveState();
            updateAudioIcon();
            stopAudio();
        }

        function updateAudioIcon() {
            const btn = document.getElementById('audio-btn');
            if(btn) {
                btn.innerHTML = state.audioEnabled ? 
                    '<i class="fas fa-volume-up text-2xl"></i>' : 
                    '<i class="fas fa-volume-mute text-2xl text-gray-500"></i>';
            }
        }

        /* --- DATA: GALAPAGOS --- */
        const vocabulary = [
            { word: "Endemic", emoji: "üèùÔ∏è", def: "Found only in one specific area.", sent: "Marine iguanas are endemic to the Galapagos.", persona: "Andrew" },
            { word: "Archipelago", emoji: "üó∫Ô∏è", def: "A group of islands.", sent: "Darwin visited the Galapagos archipelago.", persona: "Emma" },
            { word: "Beak", emoji: "üê¶", def: "The hard mouth of a bird.", sent: "Finches have different beak shapes.", persona: "Brian" },
            { word: "Carapace", emoji: "üê¢", def: "The hard upper shell of a tortoise.", sent: "The saddleback carapace lets the neck stretch.", persona: "Ava" },
            { word: "Algae", emoji: "üåø", def: "Simple plants living in water.", sent: "Iguanas dive to eat green algae.", persona: "Andrew" },
            { word: "Variation", emoji: "üìè", def: "A difference between individuals.", sent: "Variation in beak size helped them survive.", persona: "Emma" },
            { word: "Isolation", emoji: "üèùÔ∏è", def: "Being separated from others.", sent: "Isolation on islands speeds up evolution.", persona: "Brian" },
            { word: "Adaptation", emoji: "üß¨", def: "A change to help survival.", sent: "Swimming is a unique adaptation.", persona: "Ava" },
            { word: "Species", emoji: "ü¶ú", def: "A group of similar organisms.", sent: "There are many species of finches.", persona: "Andrew" },
            { word: "Camouflage", emoji: "ü¶é", def: "Blending into the background.", sent: "Their skin provides camouflage on rocks.", persona: "Emma" }
        ];

        const lectures = {
            1: {
                text: "When Charles Darwin visited the Galapagos, he noticed small birds called finches. Although they looked similar, their beaks were very different. On islands with hard seeds, finches had large, strong beaks to crack them open. On islands with insects, finches had thin, sharp beaks to catch them. Darwin realized these variations allowed them to survive by eating different food. This is a classic example of adaptation through natural selection.",
                gaps: {
                    parts: ["Darwin saw variations in the finches' [1]. Birds eating seeds had strong beaks, while those eating [2] had sharp ones. This helped them survive by [3] selection."],
                    ans: ["beaks", "insects", "natural"],
                    bank: ["beaks", "insects", "natural", "wings", "artificial", "water"] 
                }
            },
            2: {
                text: "The marine iguana is the only lizard in the world that swims in the ocean. They live on harsh volcanic rocks where there is little food. To survive, they evolved to dive into the cold sea to eat green algae off the rocks. However, swimming in saltwater means they swallow too much salt. To fix this, they have special glands in their noses. They literally sneeze out the excess salt, which often lands on their heads, giving them a white 'wig'.",
                mcq: [
                    { q: "What is unique about marine iguanas?", opts: ["They fly", "They swim in the ocean", "They have fur", "They eat insects"], ans: 1 },
                    { q: "What is their main food source?", opts: ["Insects", "Fish", "Algae", "Seeds"], ans: 2 },
                    { q: "Why do they sneeze?", opts: ["To clear dust", "To communicate", "To expel salt", "To scare predators"], ans: 2 }
                ]
            },
            3: {
                text: "Galapagos giant tortoises show how habitat shapes the body. On wet islands with low grass, tortoises have 'dome' shaped shells and short necks because food is on the ground. But on dry islands, food is scarce and grows high on cactus plants. Here, tortoises evolved 'saddleback' shells. The shell curves upward at the front, allowing their long necks to stretch high and reach the cactus pads. The shape of the shell is a direct map of their environment.",
                mcq: [
                    { q: "Why do saddleback tortoises have long necks?", opts: ["To swim better", "To fight rivals", "To reach high food", "To look taller"], ans: 2 },
                    { q: "What determines the shell shape?", opts: ["The environment", "The age", "The gender", "The ocean"], ans: 0 },
                    { q: "Where do dome-shelled tortoises live?", opts: ["Dry islands", "Wet islands", "In the ocean", "In caves"], ans: 1 }
                ]
            }
        };

        /* --- AUDIO SYSTEM --- */
        let voices = [];
        const synth = window.speechSynthesis;

        function loadVoices() { voices = synth.getVoices(); }
        synth.onvoiceschanged = loadVoices;
        setTimeout(loadVoices, 500);

        function speak(text, highlightCallback) {
            if(!state.audioEnabled) return;
            synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 0.85; // Slow down
            
            const brian = voices.find(v => v.name.includes("Brian"));
            if (brian) u.voice = brian;
            else {
                const fallback = voices.find(v => v.name.includes("Microsoft") && v.lang.includes("en")) || voices.find(v => v.lang.includes("en"));
                if(fallback) u.voice = fallback;
            }

            if (highlightCallback) {
                u.onboundary = (event) => {
                    if (event.name === 'word') highlightCallback(event.charIndex);
                };
            }
            synth.speak(u);
        }

        function stopAudio() { synth.cancel(); }

        /* --- ROUTER & RENDERER --- */
        const container = document.getElementById('app-content');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const scoreDisplay = document.getElementById('score-val');
        const progressEl = document.getElementById('progress-bar');
        const headerActions = document.getElementById('header-actions');
        const praiseOverlay = document.getElementById('praise-overlay');

        function render() {
            container.innerHTML = '';
            headerActions.innerHTML = ''; 
            praiseOverlay.style.display = 'none';
            stopAudio();
            scoreDisplay.textContent = state.score;
            updateAudioIcon();
            
            const totalPages = 24; 
            const pct = (state.page / totalPages) * 100;
            progressEl.style.width = `${pct}%`;

            prevBtn.disabled = state.page === 0;
            prevBtn.onclick = () => { if(state.page > 0) { state.page--; saveState(); render(); }};
            nextBtn.onclick = () => { if(state.page < totalPages) { state.page++; saveState(); render(); }};

            // Router
            if(state.page === 0) renderHome();
            else if(state.page === 1) renderWarmup();
            else if(state.page === 2) renderWarmupAnswer();
            else if(state.page >= 3 && state.page <= 12) renderVocab(state.page - 3);
            else if(state.page === 13) renderScriptView(1, "üê¶ Darwin's Finches");
            else if(state.page === 14) renderGapFill(1);
            else if(state.page === 15) renderScriptView(2, "ü¶é Marine Iguanas");
            else if(state.page === 16) renderMCQSingle(2, 0);
            else if(state.page === 17) renderMCQSingle(2, 1);
            else if(state.page === 18) renderMCQSingle(2, 2);
            else if(state.page === 19) renderScriptView(3, "üê¢ Giant Tortoises");
            else if(state.page === 20) renderMCQSingle(3, 0);
            else if(state.page === 21) renderMCQSingle(3, 1);
            else if(state.page === 22) renderMCQSingle(3, 2);
            else if(state.page === 23) renderFinish();
        }

        /* --- VIEWS --- */

        function renderHome() {
            container.innerHTML = `
                <div class="fade-in items-center justify-center text-center flex-1">
                    <div class="w-32 h-32 bg-sky-100 rounded-full flex items-center justify-center mb-6 shadow-inner mx-auto">
                        <i class="fas fa-globe-americas text-5xl text-sky-600"></i>
                    </div>
                    <h1 class="text-5xl font-black text-slate-800 mb-4 tracking-tight">Galapagos Evolution ü¶é</h1>
                    <p class="text-2xl text-slate-500 mb-8 font-light">IELTS Academic Listening</p>
                    <button onclick="startUnit()" class="bg-sky-600 text-white px-12 py-5 rounded-2xl text-xl font-bold shadow-xl hover:bg-sky-700 btn-3d transition">
                        START üöÄ
                    </button>
                </div>
            `;
            nextBtn.style.visibility = 'hidden';
            prevBtn.style.visibility = 'hidden';
        }

        function renderWarmup() {
            nextBtn.style.visibility = 'visible';
            prevBtn.style.visibility = 'visible';
            container.innerHTML = `
                <div class="fade-in items-center justify-center flex-1 w-full p-4">
                    <div class="bg-white rounded-[2rem] shadow-xl p-8 border-t-[8px] border-sky-500 w-full text-center max-w-4xl">
                        <h2 class="text-xl font-bold mb-6 text-sky-800 uppercase tracking-widest">Speaking Warm Up üó£Ô∏è</h2>
                        <p class="text-5xl font-bold text-slate-800 mb-8 leading-tight">
                            "Why do birds on the same island have different beaks? üê¶"
                        </p>
                        <div class="flex justify-center gap-6">
                            <button onclick="timer(60)" class="bg-slate-50 border-2 border-slate-200 hover:border-sky-400 px-8 py-4 rounded-2xl text-xl font-bold transition flex flex-col items-center min-w-[160px]">
                                <i class="fas fa-brain mb-2 text-3xl text-sky-600"></i>
                                Think
                            </button>
                            <button onclick="timer(120)" class="bg-slate-50 border-2 border-slate-200 hover:border-blue-400 px-8 py-4 rounded-2xl text-xl font-bold transition flex flex-col items-center min-w-[160px]">
                                <i class="fas fa-comments mb-2 text-3xl text-blue-600"></i>
                                Pair
                            </button>
                        </div>
                        <div id="timer-display" class="text-center text-6xl font-mono font-bold text-slate-700 mt-8">00:00</div>
                    </div>
                </div>
            `;
        }

        function renderWarmupAnswer() {
            container.innerHTML = `
                <div class="fade-in items-center justify-center flex-1 w-full p-4">
                    <div class="bg-indigo-900 rounded-[2rem] shadow-xl p-10 w-full text-center text-white relative overflow-hidden max-w-4xl">
                        <h2 class="text-2xl font-bold mb-6 text-indigo-300 uppercase tracking-widest">The Reason üí°</h2>
                        <p class="text-4xl font-bold mb-6 leading-snug">
                            "To eat different <span class="text-yellow-400">foods</span> without competing with each other."
                        </p>
                    </div>
                </div>
            `;
        }

        function timer(sec) {
            let t = sec;
            const el = document.getElementById('timer-display');
            clearInterval(window.timerInt);
            window.timerInt = setInterval(() => {
                const m = Math.floor(t/60);
                const s = t%60;
                el.textContent = `${m}:${s<10?'0'+s:s}`;
                if(t<=0) { clearInterval(window.timerInt); el.textContent = "DONE"; el.classList.add('shake'); }
                t--;
            }, 1000);
        }

        function renderVocab(idx) {
            const v = vocabulary[idx];
            container.innerHTML = `
                <div class="fade-in h-full p-4 justify-start">
                    <div class="vocab-card w-full max-w-6xl bg-white flex flex-col p-12 relative overflow-hidden h-full items-start text-left">
                        <div class="flex-1 flex flex-col justify-start gap-8 pt-4 w-full">
                            <div>
                                <span class="block text-sky-600 text-lg font-bold tracking-widest mb-2">WORD ${idx+1}/10</span>
                                <h2 class="text-5xl font-black text-slate-800">${v.emoji} ${v.word.toLowerCase()}</h2>
                            </div>
                            
                            <p class="text-5xl text-gray-700 leading-snug font-light">${v.def}</p>
                            
                            <div class="border-l-[8px] border-sky-500 pl-8">
                                <p class="text-4xl text-sky-900 italic font-medium leading-relaxed">"${v.sent}"</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            if(state.audioEnabled) {
                const textToSpeak = `${v.word}. ${v.def}. ${v.sent}`;
                setTimeout(() => speak(textToSpeak), 500);
            }
        }

        /* --- SCRIPT VIEW --- */
        function renderScriptView(lecId, titleText) {
            const l = lectures[lecId];
            const words = l.text.split(' ');
            
            const playBtn = document.createElement('button');
            playBtn.className = "bg-sky-500 hover:bg-sky-400 text-white w-10 h-10 rounded-full flex items-center justify-center transition shadow-lg";
            playBtn.innerHTML = '<i class="fas fa-stop"></i>';
            playBtn.onclick = stopAudio;
            headerActions.appendChild(playBtn);

            container.innerHTML = `
                <div class="fade-in h-full p-4 flex flex-col items-center justify-center">
                    <div class="bg-white rounded-[2rem] shadow-xl p-8 w-full max-w-6xl h-full flex flex-col border border-slate-200">
                        <h2 class="text-2xl text-sky-700 font-bold mb-4">${titleText}</h2>
                        <div id="script-container" class="text-2xl leading-relaxed font-bold text-gray-800 flex-1 flex flex-wrap content-start justify-start text-left gap-x-2 gap-y-2 overflow-y-auto">
                            ${words.map((w, i) => `<span class="highlight-word">${w} </span>`).join('')}
                        </div>
                    </div>
                </div>
            `;

            if(state.audioEnabled) {
                setTimeout(() => {
                    speak(l.text, (charIdx) => {
                        let runningTotal = 0;
                        const spans = document.querySelectorAll('.highlight-word');
                        spans.forEach(s => s.classList.remove('active'));

                        for(let i=0; i<spans.length; i++) {
                            const span = spans[i];
                            const len = span.innerText.length;
                            if (charIdx >= runningTotal && charIdx < runningTotal + len) {
                                span.classList.add('active');
                                span.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
                                break;
                            }
                            runningTotal += len;
                        }
                    });
                }, 500);
            }
        }

        /* --- GAP FILL --- */
        let selectedGapWord = null;

        function renderGapFill(lecId) {
            const l = lectures[lecId];
            const parts = l.gaps.parts[0].split(/(\[\d\])/);
            const bank = [...l.gaps.bank].sort(() => 0.5 - Math.random());
            selectedGapWord = null;

            container.innerHTML = `
                <div class="fade-in items-center justify-center h-full p-2">
                    <div class="bg-white rounded-[2rem] shadow-lg p-8 w-full max-w-6xl flex flex-col h-full border border-slate-200">
                        
                        <div class="bg-slate-50 p-8 rounded-2xl text-2xl leading-loose text-gray-800 mb-4 flex-1 flex flex-wrap content-start items-center border border-slate-200 font-medium text-left">
                            <div class="text-left w-full">
                                ${parts.map(p => p.match(/\[\d\]/) ? `<span class="gap-slot" id="gap-${p.replace(/\D/g,'')}" onclick="handleGapClick(this, ${lecId}, ${parseInt(p.replace(/\D/g,''))-1})"></span>` : p).join('')}
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-3 justify-center mb-4 bg-slate-100 p-4 rounded-xl min-h-[80px] items-center">
                            ${bank.map(w => `<button class="word-bank-item bg-white border border-slate-300 px-4 py-2 rounded-lg shadow-sm font-bold text-lg hover:bg-sky-50 hover:border-sky-400 transition" onclick="selectBankWord(this, '${w}')">${w}</button>`).join('')}
                        </div>
                        
                        <p class="text-center text-slate-400 text-sm">Select a word, then tap a blank space.</p>
                    </div>
                </div>
            `;
        }

        function selectBankWord(btn, word) {
            const isSelected = btn.classList.contains('selected');
            document.querySelectorAll('.word-bank-item').forEach(b => b.classList.remove('selected'));
            
            if (!isSelected) {
                btn.classList.add('selected');
                selectedGapWord = { word: word, el: btn };
                playSound('click');
            } else {
                selectedGapWord = null;
            }
        }

        function handleGapClick(gapEl, lecId, ansIndex) {
            if (!selectedGapWord || gapEl.classList.contains('filled')) return;

            const correctWord = lectures[lecId].gaps.ans[ansIndex];
            
            if (selectedGapWord.word === correctWord) {
                gapEl.textContent = selectedGapWord.word;
                gapEl.classList.add('filled', 'shimmer-effect');
                selectedGapWord.el.classList.add('used');
                selectedGapWord.el.classList.remove('selected');
                selectedGapWord = null;
                playSound('correct');
                
                const totalGaps = lectures[lecId].gaps.ans.length;
                const filledGaps = document.querySelectorAll('.gap-slot.filled').length;
                if(filledGaps === totalGaps) {
                    state.score += 20;
                    saveState();
                    scoreDisplay.textContent = state.score;
                    showPraise("Perfect! üéâ");
                    triggerConfetti();
                }
            } else {
                gapEl.classList.add('wrong');
                playSound('wrong');
                setTimeout(() => gapEl.classList.remove('wrong'), 500);
            }
        }

        /* --- MCQ SINGLE --- */
        function renderMCQSingle(lecId, qIdx) {
            const q = lectures[lecId].mcq[qIdx];
            
            container.innerHTML = `
                <div class="fade-in items-center justify-center h-full p-4">
                    <div class="bg-white rounded-[2rem] shadow-xl p-8 w-full max-w-6xl h-full flex flex-col border border-slate-200">
                        <div class="mb-6 text-left w-full">
                            <p class="font-bold text-gray-800 text-4xl leading-tight text-left">${q.q}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6 flex-1 content-center">
                            ${q.opts.map((o, oi) => `
                                <button id="opt-${oi}" onclick="checkMCQSingle(${oi}, ${q.ans})" class="mcq-option-large w-full flex items-center justify-start">
                                    <div class="w-12 h-12 rounded-full bg-slate-100 text-slate-500 font-bold flex items-center justify-center mr-6 text-xl border border-slate-300 shrink-0">
                                        ${String.fromCharCode(65+oi)}
                                    </div>
                                    <span class="font-medium text-slate-700 text-left">${o}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function checkMCQSingle(optIdx, correctIdx) {
            const btn = document.getElementById(`opt-${optIdx}`);
            const allOpts = document.querySelectorAll('.mcq-option-large');
            if(optIdx === correctIdx) {
                btn.classList.add('correct');
                state.score += 10;
                allOpts.forEach(b => b.disabled = true);
                showPraise("Correct! üåü");
                triggerConfetti();
            } else {
                btn.classList.add('wrong');
                btn.classList.add('shake');
            }
            scoreDisplay.textContent = state.score;
            saveState();
        }

        function showPraise(text) {
            const overlay = document.getElementById('praise-overlay');
            const txt = document.getElementById('praise-text');
            txt.textContent = text;
            overlay.style.display = 'block';
            setTimeout(() => { overlay.style.display = 'none'; }, 2000);
        }

        function renderFinish() {
             container.innerHTML = `
                <div class="fade-in items-center justify-center flex-1 text-center p-4">
                    <div class="bg-white p-16 rounded-[3rem] shadow-2xl max-w-2xl w-full">
                        <div class="text-8xl mb-6">üèÜ</div>
                        <h2 class="text-5xl font-black text-slate-800 mb-4">Complete!</h2>
                        <div class="my-8 py-6 bg-slate-50 rounded-3xl border-2 border-slate-100">
                            <span class="text-7xl font-black text-sky-600">${state.score}</span>
                        </div>
                        <button onclick="resetProgress()" class="bg-slate-800 text-white px-8 py-4 rounded-xl font-bold text-xl hover:bg-slate-700 transition w-full shadow-lg">
                            New Session üîÑ
                        </button>
                    </div>
                </div>
            `;
        }
        
        function triggerConfetti() {
            const colors = ['#0ea5e9', '#3b82f6', '#f59e0b', '#ec4899'];
            for(let i=0; i<15; i++) {
                const c = document.createElement('div');
                c.style.cssText = `position:fixed;width:15px;height:15px;background:${colors[Math.floor(Math.random()*colors.length)]};top:-10px;left:${Math.random()*100}vw;pointer-events:none;z-index:99;border-radius:4px;`;
                document.body.appendChild(c);
                c.animate([{transform:`translate(0,0) rotate(0)`}, {transform:`translate(${Math.random()*200-100}px, 100vh) rotate(720deg)`}], {duration: 1500+Math.random()*1500});
                setTimeout(()=>c.remove(), 3000);
            }
        }

        function playSound(type) {
            if(!state.audioEnabled) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            if(type==='click') { o.type='triangle'; o.frequency.value=600; g.gain.value=0.1; o.start(); o.stop(ctx.currentTime+0.05); } 
            else if(type==='correct') { o.type='sine'; o.frequency.setValueAtTime(500, ctx.currentTime); o.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime+0.1); g.gain.linearRampToValueAtTime(0, ctx.currentTime+0.3); o.start(); o.stop(ctx.currentTime+0.3); } 
            else { o.type='sawtooth'; o.frequency.value=150; g.gain.linearRampToValueAtTime(0, ctx.currentTime+0.3); o.start(); o.stop(ctx.currentTime+0.3); }
        }

        if(state.page === 0) renderHome(); else render();
        scoreDisplay.textContent = state.score;
        updateAudioIcon();
    </script>
</body>
</html>
