<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßã Beijing Bubble Tea Challenge - Automated Classroom Activity</title>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 25%, #667eea 50%, #764ba2 75%, #f093fb 100%);
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            color: #ffffff;
        }

        /* Enhanced 3D Button Styles */
        .btn-3d {
            background: linear-gradient(145deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            border: none;
            border-radius: 25px;
            padding: 25px 50px;
            font-size: 32px;
            font-weight: 900;
            color: white;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 
                0 15px 35px rgba(0,0,0,0.3),
                0 5px 15px rgba(0,0,0,0.2),
                inset 0 2px 5px rgba(255,255,255,0.3),
                inset 0 -2px 5px rgba(0,0,0,0.2);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin: 20px;
            min-width: 300px;
            text-align: center;
        }

        .btn-3d::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 25px;
            z-index: -1;
        }

        .btn-3d:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.4),
                0 10px 25px rgba(0,0,0,0.3),
                inset 0 2px 8px rgba(255,255,255,0.4),
                inset 0 -2px 8px rgba(0,0,0,0.3);
        }

        .btn-3d:active {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 10px 25px rgba(0,0,0,0.3),
                0 5px 15px rgba(0,0,0,0.2),
                inset 0 2px 5px rgba(255,255,255,0.2),
                inset 0 -2px 5px rgba(0,0,0,0.3);
        }

        .btn-grade10 {
            background: linear-gradient(145deg, #ff6b6b 0%, #ee5a24 50%, #ff3838 100%);
        }

        .btn-grade11 {
            background: linear-gradient(145deg, #26de81 0%, #20bf6b 50%, #0fb9b1 100%);
        }

        .btn-grade12 {
            background: linear-gradient(145deg, #a55eea 0%, #8854d0 50%, #3742fa 100%);
        }

        /* Glowing Background Effect */
        .glow-background {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            z-index: -1;
        }

        .glow-background.active {
            opacity: 1;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { transform: scale(1); opacity: 0.1; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        /* Glitter Effect */
        .glitter-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }

        .glitter {
            position: absolute;
            width: 8px;
            height: 8px;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffffff);
            border-radius: 50%;
            animation: glitterFall 3s linear infinite;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }

        @keyframes glitterFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }

        /* Title Styles */
        .main-title {
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffffff, #ffd700);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin-bottom: 15px;
            line-height: 1.1;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 25px;
        }

        /* Timer Display */
        .timer-display {
            position: fixed;
            top: 30px;
            right: 30px;
            background: linear-gradient(145deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px 30px;
            border-radius: 20px;
            font-size: 36px;
            font-weight: 900;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Phase Display */
        .phase-display {
            position: fixed;
            top: 30px;
            left: 30px;
            background: linear-gradient(145deg, #26de81, #20bf6b);
            color: white;
            padding: 20px 30px;
            border-radius: 20px;
            font-size: 28px;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: rgba(255,255,255,0.95);
            color: #2c3e50;
            border-radius: 20px;
            padding: 25px;
            margin: 15px 0;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            font-size: 18px;
            line-height: 1.4;
            text-align: left;
            max-height: 85vh;
            overflow-y: auto;
        }

        .content-section.active {
            display: block;
            animation: slideIn 0.8s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .content-section h2 {
            font-size: 32px;
            font-weight: 900;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .content-section h3 {
            font-size: 24px;
            font-weight: 700;
            color: #3742fa;
            margin: 20px 0 15px 0;
        }

        /* Team Display */
        .teams-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .team-card {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
        }

        .team-card h4 {
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .team-member {
            font-size: 14px;
            font-weight: 600;
            margin: 5px 0;
            padding: 5px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }

        /* Decision Matrix */
        .decision-matrix {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
            font-size: 16px;
        }

        .matrix-cell {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .matrix-header {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            font-size: 18px;
        }

        .matrix-cooperate {
            background: linear-gradient(145deg, #26de81, #20bf6b);
            color: white;
        }

        .matrix-defect {
            background: linear-gradient(145deg, #ff6b6b, #ee5a24);
            color: white;
        }

        /* Instructions */
        .instruction-box {
            background: linear-gradient(145deg, #ffd700, #ffed4e);
            color: #2c3e50;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 3px solid #f39c12;
        }

        /* Progress Bar */
        .progress-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #26de81, #20bf6b, #0fb9b1);
            width: 0%;
            transition: width 1s ease;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-title { font-size: 60px; }
            .subtitle { font-size: 36px; }
            .btn-3d { font-size: 28px; padding: 20px 40px; }
            .content-section { font-size: 24px; padding: 40px; }
        }

        /* Hide elements initially */
        .hidden {
            display: none !important;
        }

        /* Animated Emojis */
        .animated-emoji {
            display: inline-block;
            animation: emojiJiggle 2s ease-in-out infinite;
        }

        @keyframes emojiJiggle {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-3deg) scale(1.05); }
            75% { transform: rotate(3deg) scale(1.05); }
        }

        /* Sound Effect Display */
        .sound-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .sound-effect.show {
            opacity: 1;
            animation: soundPulse 1s ease-out;
        }

        @keyframes soundPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Countdown Warning */
        .countdown-warning {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px 30px;
            border-radius: 20px;
            font-size: 24px;
            font-weight: 900;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            z-index: 1500;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .countdown-warning.show {
            opacity: 1;
            animation: warningPulse 2s ease-in-out;
        }

        @keyframes warningPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.1); }
        }
    </style>
</head>
<body>
    <!-- Glowing Background -->
    <div class="glow-background" id="glowBackground"></div>
    
    <!-- Glitter Container -->
    <div class="glitter-container" id="glitterContainer"></div>
    
    <!-- Timer Display -->
    <div class="timer-display" id="timerDisplay">20:00</div>
    
    <!-- Phase Timer -->
    <div style="position: fixed; top: 30px; right: 200px; background: linear-gradient(145deg, #a55eea, #8854d0); color: white; padding: 15px 25px; border-radius: 15px; font-size: 24px; font-weight: 700; box-shadow: 0 8px 25px rgba(0,0,0,0.3); z-index: 1000;" id="phaseTimer">00:00</div>
    
    <!-- Phase Display -->
    <div class="phase-display" id="phaseDisplay">Select Grade Level</div>
    
    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <!-- Sound Effect Display -->
    <div class="sound-effect" id="soundEffect">‚è∞</div>
    
    <!-- Countdown Warning -->
    <div class="countdown-warning" id="countdownWarning">‚ö†Ô∏è 30 seconds remaining!</div>

    <div class="main-container">
        <!-- Grade Selection Screen -->
        <div id="gradeSelection" class="content-section active">
            <h1 class="main-title">üßã Beijing Bubble Tea Challenge</h1>
            <h2 class="subtitle">Prisoner's Dilemma Business Ethics Simulation</h2>
            
            <div style="text-align: center; margin: 60px 0;">
                <h3 style="font-size: 42px; color: #2c3e50; margin-bottom: 40px;">Select Your Grade Level</h3>
                
                <button class="btn-3d btn-grade10" onclick="selectGrade(10)">
                    Grade 10 Students
                </button>
                
                <button class="btn-3d btn-grade11" onclick="selectGrade(11)">
                    Grade 11 Students
                </button>
                
                <button class="btn-3d btn-grade12" onclick="selectGrade(12)">
                    Grade 12 Students
                </button>
            </div>
        </div>

        <!-- Team Assignment Screen -->
        <div id="teamAssignment" class="content-section">
            <h2>üé≤ Team Assignments</h2>
            <div id="teamsContainer" class="teams-container">
                <!-- Teams will be populated here -->
            </div>
            <div class="instruction-box">
                <strong>Listen carefully as your team assignments are announced!</strong><br>
                Remember your team name and role for the entire activity.
            </div>
        </div>

        <!-- Group Formation Screen -->
        <div id="groupFormation" class="content-section">
            <h2>üë• Find Your Team!</h2>
            <div class="instruction-box">
                <strong>You have 1 minute to find your teammates and form your bubble tea shop!</strong><br>
                Look for the people listed in your team and gather together.
            </div>
            <div id="formationTeamsDisplay" class="teams-container">
                <!-- Teams for formation will be shown here -->
            </div>
        </div>

        <!-- Introduction Screen -->
        <div id="introduction" class="content-section">
            <h2>üéØ Welcome to Beijing's Business Challenge!</h2>
            <p><strong>You are bubble tea shop owners near Beijing's top universities!</strong></p>
            <p>Beijing's new environmental regulations are forcing a difficult business decision that will test your ethics, strategy, and cooperation skills.</p>
            
            <div class="instruction-box">
                The year is 2024. Beijing has announced new environmental policies requiring businesses to reduce plastic waste by 2025. As competing bubble tea shop owners, you must decide: profit or planet?
            </div>
        </div>

        <!-- Rules Explanation -->
        <div id="rulesExplanation" class="content-section">
            <h2>üìã The Business Dilemma</h2>
            
            <h3>Your Choice Each Round:</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
                <div style="background: linear-gradient(145deg, #26de81, #20bf6b); color: white; padding: 30px; border-radius: 20px; text-align: center;">
                    <h4 style="font-size: 32px; margin-bottom: 20px;">üå± COOPERATE</h4>
                    <p style="font-size: 24px;">Use Eco-Friendly Cups<br>Higher cost but environmentally responsible</p>
                </div>
                <div style="background: linear-gradient(145deg, #ff6b6b, #ee5a24); color: white; padding: 30px; border-radius: 20px; text-align: center;">
                    <h4 style="font-size: 32px; margin-bottom: 20px;">üí∞ DEFECT</h4>
                    <p style="font-size: 24px;">Keep Plastic Cups<br>Lower cost but harmful to environment</p>
                </div>
            </div>

            <div class="decision-matrix">
                <div class="matrix-cell matrix-header">Scenario</div>
                <div class="matrix-cell matrix-header">üå± All Use Eco-Cups</div>
                <div class="matrix-cell matrix-header">üí∞ Mixed Choices</div>
                
                <div class="matrix-cell matrix-header">Market Share</div>
                <div class="matrix-cell matrix-cooperate">Equal 25% each<br>Sustainable market</div>
                <div class="matrix-cell matrix-defect">Plastic users: 40%<br>Eco users: 10%</div>
                
                <div class="matrix-cell matrix-header">Profit per Round</div>
                <div class="matrix-cell matrix-cooperate">¬•30,000 each<br>Premium pricing</div>
                <div class="matrix-cell matrix-defect">Plastic: ¬•50,000<br>Eco: ¬•5,000</div>
            </div>
        </div>

        <!-- Game Rounds -->
        <div id="gameRounds" class="content-section">
            <h2 id="roundTitle">üéÆ Round 1 - Decision Time!</h2>
            <div id="roundContent">
                <div style="background: linear-gradient(145deg, #ffd700, #ffed4e); color: #2c3e50; padding: 20px; border-radius: 15px; margin: 15px 0; font-size: 20px; font-weight: 700; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                    <strong>Teams, discuss your strategy now!</strong><br>
                    Decide: <span class="animated-emoji">üå±</span> Eco-cups or <span class="animated-emoji">üí∞</span> Plastic cups?<br>
                    Your choice affects profits and Beijing's environment!
                </div>
                
                <div class="teams-container" id="gameTeamsDisplay">
                    <!-- Current teams will be shown here -->
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="content-section">
            <h2>üìä Round Results</h2>
            <div id="resultsContent">
                <!-- Results will be populated here -->
            </div>
        </div>

        <!-- Final Results -->
        <div id="finalResults" class="content-section">
            <h2>üèÜ Final Challenge Results</h2>
            <div id="finalResultsContent">
                <!-- Final results will be populated here -->
            </div>
        </div>

        <!-- Debrief Discussion -->
        <div id="debriefDiscussion" class="content-section">
            <h2><span class="animated-emoji">ü§î</span> Reflection & Discussion</h2>
            <div style="font-size: 18px; line-height: 1.5;">
                <h3>Think About These Questions:</h3>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin: 10px 0; padding: 15px; background: linear-gradient(145deg, #a55eea, #8854d0); color: white; border-radius: 12px;">
                        <span class="animated-emoji">üí≠</span> How did your team's strategy change between rounds?
                    </li>
                    <li style="margin: 10px 0; padding: 15px; background: linear-gradient(145deg, #26de81, #20bf6b); color: white; border-radius: 12px;">
                        <span class="animated-emoji">üåç</span> What does this teach us about environmental responsibility?
                    </li>
                    <li style="margin: 10px 0; padding: 15px; background: linear-gradient(145deg, #ff6b6b, #ee5a24); color: white; border-radius: 12px;">
                        <span class="animated-emoji">ü§ù</span> How can businesses cooperate for the greater good?
                    </li>
                    <li style="margin: 10px 0; padding: 15px; background: linear-gradient(145deg, #ffd700, #ffed4e); color: #2c3e50; border-radius: 12px;">
                        <span class="animated-emoji">üèôÔ∏è</span> How does this apply to real Beijing businesses?
                    </li>
                </ul>
            </div>
        </div>

        <!-- Activity Complete -->
        <div id="activityComplete" class="content-section">
            <h2><span class="animated-emoji">üéâ</span> Challenge Complete!</h2>
            <div style="text-align: center; font-size: 20px; line-height: 1.6;">
                <p><strong>Congratulations on completing the Beijing Bubble Tea Challenge!</strong></p>
                <p>You've experienced how individual choices affect collective outcomes.</p>
                <p>Remember: Cooperation often leads to better results for everyone.</p>
                
                <div style="background: linear-gradient(145deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 20px; margin: 20px 0;">
                    <h3 style="font-size: 28px; margin-bottom: 15px;"><span class="animated-emoji">üí°</span> Key Takeaway</h3>
                    <p>Understanding the prisoner's dilemma helps us make better decisions in business, environmental policy, and social cooperation!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Student data by grade (Fixed VonTony issue)
        const studentData = {
            10: ['Dino', 'Tracy', 'Billie', 'Jessie', 'VonTony', 'Tony', 'Jim', 'Andrew', 'Mark', 'Leo', 'Apollo', 'Lion', 'Alex', 'John', 'Jenny', 'Steven', 'Mike'],
            11: ['Schmidt', 'Harry', 'Zara', 'Jill', 'Helen', 'Roselia', 'Peter', 'Dio', 'Henry', 'Derek', 'Clara', 'Alexia', 'Olivia', 'Penny'],
            12: ['Anna', 'Mia', 'Kenn', 'Max', 'Sky', 'Sheng', 'Keying', 'Cen', 'Xifei', 'Jiaqi', 'Zack', 'Azure', 'Joe']
        };

        // Game state
        let currentGrade = null;
        let teams = [];
        let currentPhase = 0;
        let totalTime = 20 * 60; // 20 minutes in seconds
        let remainingTime = totalTime;
        let phaseTimeRemaining = 0;
        let currentRound = 1;
        let timerInterval = null;
        let phaseInterval = null;
        let isActivityRunning = false;

        // Phase configuration (20 minutes total)
        const phases = [
            { name: 'Team Assignment', duration: 2 * 60, tts: 'Welcome to the Beijing Bubble Tea Challenge! Let me announce your team assignments for this business ethics simulation.' },
            { name: 'Group Formation', duration: 1 * 60, tts: 'Now you have 1 minute to find your teammates and form your bubble tea shop teams. Look for your assigned team members and gather together.' },
            { name: 'Introduction', duration: 2 * 60, tts: 'You are bubble tea shop owners near Beijing\'s top universities. Beijing has announced new environmental policies requiring businesses to reduce plastic waste by 2025. As competing shop owners, you must decide: profit or planet?' },
            { name: 'Rules Explanation', duration: 4 * 60, tts: 'Here are the rules of our business simulation. Each round, you choose between eco-friendly cups or plastic cups. If all teams use eco-friendly cups, everyone gets equal market share and 30,000 yuan profit. If some teams use plastic while others use eco-friendly, the plastic users get 50,000 yuan and 40% market share, while eco-friendly users only get 5,000 yuan and 10% market share. Your choices affect both profits and Beijing\'s environment.' },
            { name: 'Round 1', duration: 4 * 60, tts: 'Round 1 begins now! Teams, discuss your strategy. Will you choose eco-friendly cups to help the environment, or plastic cups for potentially higher profits? Remember, your decision affects everyone.' },
            { name: 'Round 2', duration: 4 * 60, tts: 'Round 2 starts now! This is your final decision round. Based on your experience from Round 1, what will your strategy be? Will you cooperate for the greater good or compete for individual advantage?' },
            { name: 'Discussion', duration: 1 * 60, tts: 'Time for reflection! Think about these questions: How did your team\'s strategy evolve? What does this teach us about environmental responsibility in business? How can businesses cooperate for the greater good? How does this apply to real businesses in Beijing and China?' }
        ];

        // TTS Functions
        function speak(text, callback = null) {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Use Microsoft Edge voices only
                const voices = speechSynthesis.getVoices();
                const preferredVoices = ['Ava', 'Brian', 'Emma', 'Andrew'];
                
                let selectedVoice = null;
                for (let preferred of preferredVoices) {
                    selectedVoice = voices.find(voice => 
                        voice.name.includes(preferred) && 
                        voice.name.includes('Microsoft') && 
                        voice.name.includes('Online')
                    );
                    if (selectedVoice) break;
                }
                
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
                
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                utterance.onend = () => {
                    if (callback) callback();
                };
                
                utterance.onerror = () => {
                    if (callback) callback();
                };
                
                speechSynthesis.speak(utterance);
            } else if (callback) {
                callback();
            }
        }

        // Visual Effects
        function createGlitter() {
            const container = document.getElementById('glitterContainer');
            const glitter = document.createElement('div');
            glitter.className = 'glitter';
            glitter.style.left = Math.random() * 100 + '%';
            glitter.style.animationDelay = Math.random() * 1 + 's';
            glitter.style.animationDuration = (1.5 + Math.random() * 1) + 's';
            
            container.appendChild(glitter);
            
            setTimeout(() => {
                if (glitter.parentNode) {
                    glitter.parentNode.removeChild(glitter);
                }
            }, 3000);
        }

        function activateGlowAndGlitter() {
            document.getElementById('glowBackground').classList.add('active');
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => createGlitter(), i * 50);
            }
            
            setTimeout(() => {
                document.getElementById('glowBackground').classList.remove('active');
            }, 2000);
        }

        function showSoundEffect(emoji) {
            const effect = document.getElementById('soundEffect');
            effect.textContent = emoji;
            effect.classList.add('show');
            
            setTimeout(() => {
                effect.classList.remove('show');
            }, 1000);
        }

        function showCountdownWarning() {
            const warning = document.getElementById('countdownWarning');
            warning.classList.add('show');
            showSoundEffect('‚ö†Ô∏è');
            
            setTimeout(() => {
                warning.classList.remove('show');
            }, 2000);
        }

        // Team Management
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function createTeams(grade) {
            const students = shuffleArray(studentData[grade]);
            const teamNames = [
                'üßã Tea Paradise (Ê∏ÖÂçéÂ∫ó)',
                'ü´ß Bubble Dreams (ÂåóÂ§ßÂ∫ó)', 
                '‚è∞ Tea Time (ÂåóÈÇÆÂ∫ó)',
                'üöÄ Boba Express (‰∫∫Â§ßÂ∫ó)'
            ];
            
            const roles = ['CEO', 'Marketing Director', 'Operations Manager', 'Environmental Officer'];
            const totalStudents = students.length;
            
            // Calculate proper team sizes: 4+4+4+5 for 17 students
            const baseTeamSize = Math.floor(totalStudents / 4);
            const extraStudents = totalStudents % 4;
            
            teams = [];
            let studentIndex = 0;
            
            for (let i = 0; i < 4; i++) {
                // First 3 teams get base size, last team gets base + extra
                const teamSize = (i < 3) ? baseTeamSize : baseTeamSize + extraStudents;
                const teamStudents = students.slice(studentIndex, studentIndex + teamSize);
                
                teams.push({
                    name: teamNames[i],
                    members: teamStudents.map((student, index) => ({
                        name: student,
                        role: roles[index % roles.length]
                    }))
                });
                
                studentIndex += teamSize;
            }
            
            return teams;
        }

        function displayTeams() {
            const container = document.getElementById('teamsContainer');
            container.innerHTML = '';
            
            teams.forEach((team, index) => {
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                teamCard.innerHTML = `
                    <h4>${team.name}</h4>
                    ${team.members.map(member => 
                        `<div class="team-member">${member.name} - ${member.role}</div>`
                    ).join('')}
                `;
                container.appendChild(teamCard);
            });
        }

        function displayFormationTeams() {
            const container = document.getElementById('formationTeamsDisplay');
            container.innerHTML = '';
            
            teams.forEach((team, index) => {
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                teamCard.innerHTML = `
                    <h4>${team.name}</h4>
                    <div style="font-size: 16px; margin: 10px 0;">
                        <strong>Find these teammates:</strong><br>
                        ${team.members.map(m => m.name).join(', ')}
                    </div>
                `;
                container.appendChild(teamCard);
            });
        }

        // Grade Selection
        function selectGrade(grade) {
            activateGlowAndGlitter();
            currentGrade = grade;
            
            createTeams(grade);
            
            setTimeout(() => {
                startAutomatedActivity();
            }, 1000);
        }

        // Timer Management
        function updateTimer() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const progress = ((totalTime - remainingTime) / totalTime) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function updatePhaseTimer() {
            const minutes = Math.floor(phaseTimeRemaining / 60);
            const seconds = phaseTimeRemaining % 60;
            document.getElementById('phaseTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                remainingTime--;
                phaseTimeRemaining--;
                updateTimer();
                updatePhaseTimer();
                
                // Warning at 30 seconds
                if (phaseTimeRemaining === 30) {
                    showCountdownWarning();
                }
                
                // Sound effect at 10 seconds
                if (phaseTimeRemaining === 10) {
                    showSoundEffect('üö®');
                }
                
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    completeActivity();
                }
            }, 1000);
        }

        // Phase Management
        function showPhase(phaseIndex) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('phaseDisplay').textContent = phases[phaseIndex].name;
            phaseTimeRemaining = phases[phaseIndex].duration;
            updatePhaseTimer();
            
            switch(phaseIndex) {
                case 0: // Team Assignment
                    displayTeams();
                    document.getElementById('teamAssignment').classList.add('active');
                    speak(phases[phaseIndex].tts + ' ' + getTeamAnnouncementText());
                    break;
                    
                case 1: // Group Formation
                    displayFormationTeams();
                    document.getElementById('groupFormation').classList.add('active');
                    speak(phases[phaseIndex].tts);
                    break;
                    
                case 2: // Introduction
                    document.getElementById('introduction').classList.add('active');
                    speak(phases[phaseIndex].tts);
                    break;
                    
                case 3: // Rules
                    document.getElementById('rulesExplanation').classList.add('active');
                    speak(phases[phaseIndex].tts);
                    break;
                    
                case 4: // Round 1
                    currentRound = 1;
                    document.getElementById('roundTitle').innerHTML = '<span class="animated-emoji">üéÆ</span> Round 1 - Decision Time!';
                    updateGameTeamsDisplay();
                    document.getElementById('gameRounds').classList.add('active');
                    speak(phases[phaseIndex].tts);
                    break;
                    
                case 5: // Round 2
                    currentRound = 2;
                    document.getElementById('roundTitle').innerHTML = '<span class="animated-emoji">üéÆ</span> Round 2 - Final Decision!';
                    updateGameTeamsDisplay();
                    document.getElementById('gameRounds').classList.add('active');
                    speak(phases[phaseIndex].tts);
                    break;
                    
                case 6: // Discussion
                    document.getElementById('debriefDiscussion').classList.add('active');
                    speak(phases[phaseIndex].tts);
                    break;
            }
            
            activateGlowAndGlitter();
        }

        function getTeamAnnouncementText() {
            let announcement = '';
            teams.forEach((team, index) => {
                const shopName = team.name.split(' ')[2] || team.name.split(' ')[1];
                announcement += `Team ${index + 1} is ${shopName}. `;
                announcement += `Members are: ${team.members.map(m => `${m.name} as ${m.role}`).join(', ')}. `;
            });
            return announcement;
        }

        function updateGameTeamsDisplay() {
            const container = document.getElementById('gameTeamsDisplay');
            container.innerHTML = '';
            
            teams.forEach((team, index) => {
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                teamCard.innerHTML = `
                    <h4>${team.name}</h4>
                    <div style="font-size: 18px; margin: 15px 0;">
                        <strong>Strategy Discussion in Progress...</strong>
                    </div>
                    <div style="font-size: 14px;">
                        ${team.members.map(m => m.name).join(', ')}
                    </div>
                `;
                container.appendChild(teamCard);
            });
        }

        // Activity Flow
        function startAutomatedActivity() {
            document.getElementById('gradeSelection').classList.remove('active');
            isActivityRunning = true;
            currentPhase = 0;
            
            startTimer();
            showPhase(0);
            
            let phaseStartTime = Date.now();
            phaseInterval = setInterval(() => {
                const elapsed = (Date.now() - phaseStartTime) / 1000;
                
                if (elapsed >= phases[currentPhase].duration || phaseTimeRemaining <= 0) {
                    currentPhase++;
                    
                    if (currentPhase >= phases.length) {
                        clearInterval(phaseInterval);
                        completeActivity();
                        return;
                    }
                    
                    showPhase(currentPhase);
                    phaseStartTime = Date.now();
                    showSoundEffect('‚ú®');
                }
            }, 1000);
        }

        function completeActivity() {
            clearInterval(timerInterval);
            clearInterval(phaseInterval);
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('activityComplete').classList.add('active');
            
            document.getElementById('timerDisplay').textContent = '00:00';
            document.getElementById('phaseTimer').textContent = '00:00';
            document.getElementById('phaseDisplay').textContent = 'Complete';
            
            setTimeout(() => {
                speak('The Beijing Bubble Tea Challenge is now complete. Thank you for participating in this business ethics simulation! You have experienced how individual choices affect collective outcomes in real business scenarios.');
            }, 1000);
            
            activateGlowAndGlitter();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = () => {
                    console.log('Microsoft voices loaded');
                };
            }
            
            updateTimer();
            updatePhaseTimer();
            
            setTimeout(() => {
                speak('Welcome to the Beijing Bubble Tea Challenge! Please select your grade level to begin the automated 20-minute business ethics simulation.');
            }, 1500);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'985a19f6556af9ea',t:'MTc1ODk2NjY3NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
