<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 11 Unit 1: Sports & Fitness</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Segoe+UI:wght@400;600;700&display=swap');
        
        @keyframes sportFlow {
            0% { background-color: #f0fdf4; } /* green-50 */
            25% { background-color: #ecfccb; } /* lime-100 */
            50% { background-color: #fef9c3; } /* yellow-100 */
            75% { background-color: #dbeafe; } /* blue-100 */
            100% { background-color: #f0fdf4; } /* green-50 */
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            overscroll-behavior: none;
            animation: sportFlow 60s linear infinite;
            padding-top: 85px;
            color: #1e293b;
        }
        h1, h2, h3, h4 {
            font-family: 'Merriweather', serif;
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d, .tier-btn {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06);
            border: none;
            cursor: pointer;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover, .tier-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active, .tier-btn:active {
            transform: translateY(1px);
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 100px; height: 40px; padding: 0 8px;
            border: 2px dashed #94a3b8; border-radius: 6px; margin: 0 4px;
            vertical-align: middle; background-color: #ffffff;
            font-weight: bold; color: #334155;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 9999px;
            background-color: white; user-select: none; border: 1px solid #cbd5e1;
            font-weight: 600; color: #475569;
        }
        .word-bank-word.selected { outline: 2px solid #3b82f6; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; border: none; background: transparent; padding: 0; }
        .gap.correct { background-color: #dcfce7; border-color: #22c55e; color: #15803d; border-style: solid; }
        .gap.incorrect { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; border-style: solid; }

        /* Feedback Toast */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #3b82f6, #8b5cf6); animation-duration: 4.5s; }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 30px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 30px; } to { opacity: 0; bottom: 0; } }

        /* Progress Bar */
        #progress-container { background-color: #e2e8f0; border-radius: 9999px; overflow: hidden; height: 8px; width: 100%; margin-top: 8px; }
        #progress-bar { height: 100%; width: 0%; background-color: #3b82f6; transition: width 0.5s ease-out; }
        
        /* Shake Animation */
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        /* Floating Emoji */
        #emoji-floating-container { position: fixed; inset: 0; pointer-events: none; z-index: 40; }
        .floating-emoji {
            position: absolute; font-size: 28px; will-change: transform, opacity;
            opacity: 0; display: inline-block; animation-name: floatAcross;
            animation-timing-function: linear; animation-iteration-count: 1;
        }
        @keyframes floatAcross {
            0% { transform: translateX(-10vw) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateX(110vw) rotate(20deg); opacity: 0; }
        }

        /* Particles */
        .particle { position: fixed; pointer-events: none; z-index: 9999; opacity: 1; transition: opacity 0.5s ease-out; }
        .particle.glitter { width: 8px; height: 8px; border-radius: 50%; background: #fbbf24; }

        /* Tiered Reading Tabs */
        .tier-btn.active { background-color: #0056b3; color: white; border-color: #0056b3; }
        .tier-btn { background-color: white; color: #64748b; border: 1px solid #cbd5e1; }
        
        /* Dialogue Bubbles */
        .dialogue-bubble { padding: 15px; margin: 10px 0; border-radius: 12px; position: relative; max-width: 90%; }
        .bubble-left { background: #e0f2fe; margin-right: auto; border-bottom-left-radius: 2px; }
        .bubble-right { background: #fef3c7; margin-left: auto; border-bottom-right-radius: 2px; }

    </style>
</head>
<body class="antialiased text-gray-800 text-lg bg-slate-50">
    <canvas id="background-canvas"></canvas>
    <div id="reward-animation-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]"></div>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-md mx-auto bg-white/95 backdrop-blur-sm shadow-md rounded-2xl p-3 border border-slate-200">
            <div class="flex justify-between items-center gap-2">
                <button onclick="goBack()" class="nav-button bg-slate-100 text-slate-600 p-2 rounded-xl hover:bg-slate-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="flex-1 text-center font-bold text-slate-700 whitespace-nowrap"><span id="score-display" class="text-blue-600 text-xl">0</span> XP</div>
                <button onclick="navigateTo('main-menu')" class="nav-button bg-blue-600 text-white p-2 rounded-xl hover:bg-blue-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4h.01M5 19h14"></path></svg>
                </button>
                <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-xl bg-slate-100 hover:bg-slate-200" title="Read Aloud">
                    <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
                </button>
                <button onclick="goNext()" class="nav-button bg-emerald-500 hover:bg-emerald-600 text-white p-2 rounded-xl">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
        </div>
    </header>

    <div id="emoji-floating-container" aria-hidden="true"></div>

    <div id="app-container" class="max-w-3xl mx-auto p-4 sm:p-6 pb-20">
        <section id="page-title-screen" class="page active text-center bg-white rounded-3xl shadow-xl p-8 border border-slate-100">
            <div class="h-full flex flex-col justify-center items-center py-10">
                <div class="text-6xl mb-4">üèÜ</div>
                <h1 id="main-title" class="text-4xl md:text-5xl font-bold text-slate-800 mb-2">Grade 11 Unit 1</h1>
                <h2 class="text-2xl text-blue-600 font-semibold mb-6">Sports & Fitness</h2>
                <p id="main-subtitle" class="text-xl text-gray-500 mb-8 max-w-lg">Explore the world of elite sports, history, and physical limits.</p>
                <button onclick="startApp()" class="action-button bg-blue-600 text-white font-bold py-4 px-10 rounded-full text-xl hover:bg-blue-700 shadow-lg transition-transform transform hover:scale-105">ENTER UNIT</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION: SPORTS & FITNESS ---
        // ===================================================================================
        const lessonData = {
            title: "Unit 1: Sports",
            subtitle: "The World's Game & Olympic Glory ‚öΩ ü•á",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-1a-intro', text: '1A: The World\'s Game (Soccer) <span aria-hidden="true">‚öΩ</span>', color: 'blue', target: '1a-intro' },
                { id: 'menu-1a-vocab', text: '1A: Vocabulary <span aria-hidden="true">üìö</span>', color: 'sky', target: '1a-vocab' },
                { id: 'menu-1a-read', text: '1A: Reading & Comprehension <span aria-hidden="true">üìñ</span>', color: 'indigo', target: '1a-reading' },
                { id: 'menu-1a-quiz', text: '1A: Quiz <span aria-hidden="true">‚úÖ</span>', color: 'violet', target: '1a-comp-mcq' },
                { id: 'menu-1b-intro', text: '1B: Olympic Champion <span aria-hidden="true">ü•á</span>', color: 'amber', target: '1b-intro' },
                { id: 'menu-1b-vocab', text: '1B: Vocabulary <span aria-hidden="true">üß†</span>', color: 'orange', target: '1b-vocab' },
                { id: 'menu-1b-read', text: '1B: Reading & Comprehension <span aria-hidden="true">üèãÔ∏è</span>', color: 'amber', target: '1b-reading' },
                { id: 'menu-1b-quiz', text: '1B: Quiz <span aria-hidden="true">‚úÖ</span>', color: 'red', target: '1b-comp-gap' },
                { id: 'menu-climbing', text: 'Video: Sport Climbing <span aria-hidden="true">üßó</span>', color: 'emerald', target: 'climbing-intro' },
                { id: 'menu-speaking', text: 'Speaking: Interview <span aria-hidden="true">üó£Ô∏è</span>', color: 'pink', target: 'speaking-task' },
                { id: 'menu-final', text: 'Final Plenary <span aria-hidden="true">ü§î</span>', color: 'teal', target: 'final-plenary' },
            ],
            // Global Vocab for reference
            vocabulary: [],
            pages: [
                // --- UNIT 1A: SOCCER ---
                { id: '1a-intro', type: 'simple', content: { title: '1A: The World\'s Game <span aria-hidden="true">‚öΩ</span>', text: 'Soccer (football) is the world\'s most popular sport. We will explore its history, why it is so popular, and the simplicity that makes it universal.' } },
                
                { id: '1a-vocab', type: 'vocab-list', content: { 
                    title: '1A: Vocabulary', 
                    words: [
                        { word: 'Established', def: 'Set up or created (e.g. rules).' },
                        { word: 'Passion', def: 'Strong feeling or emotion.' },
                        { word: 'Victory', def: 'Winning a game or contest.' },
                        { word: 'Defeat', def: 'Losing a game or contest.' },
                        { word: 'Universal', def: 'Relating to all people in the world.' },
                        { word: 'Wealth', def: 'A large amount of money or property.' }
                    ]
                }},

                { id: '1a-reading', type: 'tiered-reading', content: { 
                    title: '1A: The World\'s Game',
                    texts: {
                        'A2': "<h3>Soccer's History (A2)</h3><p>Throughout history, humans have played some kind of kicking game. What the world now calls football began as far back as 2500 B.C.E. with the Chinese game of 'cuju'. However, the modern game started in Britain. In the 1840s, England's Football Association established a set of rules, and the modern game was born.</p><p><strong>Why is it popular?</strong> Maybe it is the camaraderie: the feeling that the team on the field is YOUR team. If they win, it is your victory. Or maybe it is the international quality. Major teams like those in Spain and Brazil have players from many nations.</p><p><strong>Universal Appeal:</strong> Ultimately, it is a simple game. It can be played anywhere with anything - a ball, a can, or even bags tied together. You don't need to be rich to play.</p>",
                        'B1': "<h3>The World's Game (B1)</h3><p>[A] Throughout history, humans have played some kind of kicking game. What the world now calls football - or soccer in the US - began as far back as 2500 B.C.E. with the Chinese game of 'cuju'. However, the sport we know today originated in Britain. In the 1840s, England's Football Association established a set of rules, and the modern game was born. Today, more than 200 million players participate globally.</p><p>[B] So, why is soccer so popular? Maybe it's the game's camaraderie: the feeling that the team on the field is YOUR team; their win is your victory, and their loss is your defeat. Or perhaps it's the promise of great wealth. Many professional players come from poor families but now make millions.</p><p>[C] Ultimately, the main reason for its universal appeal may be this: It's a simple game. It can be played anywhere with anything - a ball, a can, or even bags tied together. And anyone can play it. 'You don't need to be rich... to play soccer,' says historian Peter Alegi. 'You just need a flat space and a ball.'</p>",
                        'B2': "<h3>Global Phenomenon (B2)</h3><p>[A] Throughout history, humans have played some kind of kicking game. What the world now calls football began as far back as 2500 B.C.E. with the Chinese game of 'cuju'. However, the sport we know today originated in Britain. In the 1840s, England's Football Association established a set of rules, and the modern game was born. Today, more than 200 million players all over the globe participate in the game, truly making soccer the world's sport.</p><p>[B] So, why is soccer so popular? Maybe it's the game's camaraderie: the feeling that the team on the field is your team; their win is your victory, and their loss is your defeat. Or maybe it's the game's international quality. In countries like France, England, Spain, and Brazil, major teams have players from many different nations. Or perhaps it's the promise of great wealth. A number of professional soccer players come from poor families and now make millions.</p><p>[C] Soccer is popular for all of these reasons, but ultimately, the main reason for its universal appeal may be this: It's a simple game. It can be played anywhere with anything - a ball, a can, or even some bags tied together. And anyone can play it. 'You don't need to be rich... to play soccer,' says historian Peter Alegi. 'You just need a flat space and a ball. It is a sport that can be played on dirt, on concrete, on sand.'</p>"
                    }
                }},

                { id: '1a-comp-mcq', type: 'quiz-mcq', content: { 
                    title: '1A: Comprehension', 
                    questions: [
                        { question: 'What is the main idea of the reading?', options: ['Soccer is popular for many reasons.', 'Soccer has a long history.', 'Famous players make a lot of money.'], correctAnswer: 'Soccer is popular for many reasons.' },
                        { question: 'In paragraph B, what does "camaraderie" mean?', options: ['Competition', 'Shared feelings', 'Great wealth'], correctAnswer: 'Shared feelings' },
                        { question: 'Which is NOT given as a reason for soccer\'s popularity?', options: ['Its international quality', 'The promise of wealth', 'The expensive equipment'], correctAnswer: 'The expensive equipment' },
                        { question: 'Where did the modern game of soccer originate with established rules?', options: ['China', 'Brazil', 'Britain'], correctAnswer: 'Britain' },
                        { question: 'According to the text, what is the MAIN reason for soccer\'s universal appeal?', options: ['Great wealth', 'It is a simple game', 'Famous players'], correctAnswer: 'It is a simple game' }
                    ]
                }},

                // --- UNIT 1B: OLYMPIC ---
                { id: '1b-intro', type: 'simple', content: { title: '1B: Olympic Champion <span aria-hidden="true">ü•á</span>', text: 'How does someone become an Olympic champion? It takes a mix of biology, environment, and psychology. Let\'s look at muscles!' } },

                { id: '1b-vocab', type: 'vocab-list', content: { 
                    title: '1B: Vocabulary', 
                    words: [
                        { word: 'Biological', def: 'Relating to living things.' },
                        { word: 'Genetic', def: 'Relating to genes or heredity.' },
                        { word: 'Adapt', def: 'To change to fit a new situation.' },
                        { word: 'Required', def: 'Necessary or needed.' },
                        { word: 'Elite', def: 'Belonging to the highest class or best group.' },
                        { word: 'Fatigue', def: 'Extreme tiredness.' }
                    ]
                }},

                { id: '1b-reading', type: 'tiered-reading', content: { 
                    title: '1B: What Makes a Champion?',
                    texts: {
                        'A2': "<h3>Muscles & Genes (A2)</h3><p>How does a person become an Olympic champion? It takes biology, environment, and training.</p><p><strong>Genes:</strong> Perhaps the most important factor is genetic. Elite athletes have different bodies. For example, muscles have fast-twitch and slow-twitch fibers.</p><p><strong>Fast-twitch:</strong> Good for moving quickly. Weightlifters have many of these to lift heavy weights.</p><p><strong>Slow-twitch:</strong> Good for moving for a long time. Marathon runners have up to 90% slow-twitch fibers. They help control tiredness (fatigue).</p>",
                        'B1': "<h3>Biological Factors (B1)</h3><p>[A] How does a person become an Olympic champion? In reality, a combination of biological, environmental, and psychological factors, as well as training, go into making a super athlete.</p><p>[B] Perhaps the most important factor is genetic. Most Olympic competitors are equipped with certain physical characteristics. Take an elite athlete's muscles. There are fast-twitch fibers and slow-twitch fibers. Fast-twitch fibers help us move quickly. Olympic weightlifters have a large number of these. They allow them to lift hundreds of kilos in seconds.</p><p>[C] The legs of an elite marathon runner, on the other hand, might contain up to 90 percent slow-twitch muscle fibers. These generate energy efficiently and enable an athlete to control fatigue and keep moving for a longer period of time.</p>",
                        'B2': "<h3>Physiological Composition (B2)</h3><p>[A] How does a person become an Olympic champion - someone capable of winning the gold? In reality, a combination of biological, environmental, and psychological factors, as well as training and practice, all go into making a super athlete.</p><p>[B] Perhaps the most important factor involved in becoming an elite athlete is genetic. Most Olympic competitors are equipped with certain physical characteristics that differentiate them from the average person. Take an elite athlete's muscles, for example. In most human skeletal muscles, there are fast-twitch fibers and slow-twitch fibers. Fast-twitch fibers help us move quickly. Olympic weightlifters, for example, have a large number of fast-twitch fibers in their muscles - many more than the average person.</p><p>[C] The legs of an elite marathon runner, on the other hand, might contain up to 90 percent slow-twitch muscle fibers. These generate energy efficiently and enable an athlete to control fatigue and keep moving for a longer period of time. When we exercise long or hard, it's common to experience tiredness, muscle pain, and difficulty breathing. These feelings are caused by the build-up of lactic acid in the muscles.</p>"
                    }
                }},

                { id: '1b-comp-gap', type: 'quiz-gap-fill', content: { 
                    title: '1B: Gap Fill', 
                    sentences: [
                        { text: ['Fast-twitch fibers help athletes move', '.'], answer: 'quickly' },
                        { text: ['Marathon runners have more', 'fibers to run for a long time.'], answer: 'slow-twitch' },
                        { text: ['Elite athletes need a combination of biological and', 'factors.'], answer: 'psychological' },
                        { text: ['Slow-twitch fibers help athletes control', '.'], answer: 'fatigue' },
                        { text: ['Many athletes have physical characteristics that', 'them from average people.'], answer: 'differentiate' }
                    ],
                    wordBank: ['quickly', 'slow-twitch', 'psychological', 'fatigue', 'differentiate']
                }},

                // --- VIDEO / LISTENING: SPORT CLIMBING ---
                { id: 'climbing-intro', type: 'simple', content: { title: 'Video: Sport Climbing <span aria-hidden="true">üßó</span>', text: 'Listen to the story of how modern sport climbing began in the Verdon Gorge in France.' } },

                { id: 'climbing-dialogue', type: 'dialogue', content: { 
                    title: 'Origins of Sport Climbing', 
                    dialogue: `Narrator: Sport climbing is more popular than ever before. And its origins can be traced back to the walls of the Verdon Gorge in France 40 years ago.

Emily Harrington: Modern day climbing and mountaineering began in the European Alps. The Verdon Gorge was actually big enough and inspiring enough to become an objective in its own.

Matt Segal: On Verdon! It's pretty good here. It's absolutely an amazing limestone canyon. I would consider it more of, like, the Yosemite Valley of Europe.

Emily Harrington: The early climbers, the early mountaineers in the 1960s actually thought that the Verdon Gorge was impossible to climb. It was too big; it was too blank, and it was too difficult.

Francois Guillot: Our objective was to, in the summer, go in the Alps and do big ascents as alpinists. So, at that time, the Verdon was not even considered as a place climbable. But I decided to have a double-check.

Narrator: Until the early 1980s, the only way to climb Verdon was using anchors along cracks in the rock. The huge blank walls were too challenging. But then new technology introduced a new era in the history of climbing.

Francois Guillot: The concept of hard depends on how strong you are.

Alan Carne: Sport climbing is evolving faster and stronger than it ever has. And it's inspiring to think that it all began almost 40 years ago within the walls of the Verdon Gorge.` 
                }},

                // --- SPEAKING TASK ---
                { id: 'speaking-task', type: 'dialogue', content: { 
                    title: 'Pairwork Interview <span aria-hidden="true">üó£Ô∏è</span>', 
                    dialogue: `Student A: Do you like soccer? Why or why not?

Student B: Yes, I love the camaraderie. What about you? Do you have a favorite sports team?

Student A: I like Manchester United. Are you good at any sports? Which ones are you not good at?

Student B: I am good at running, probably because of my slow-twitch fibers! I'm not good at basketball. What about you?

Student A: I prefer watching. When was the last time you watched a live sports event? What was it?

Student B: I watched the Olympics last year. It was amazing to see the elite athletes. Now, let me ask you: Who is a famous sportsperson you admire?

Student A: I admire Serena Williams because of her mental strength. Do you like watching the Olympic Games?

Student B: I do! My favorite events are the gymnastics. Have you ever taken part in a sports event?

Student A: Yes, I ran a 5k charity race last summer.` 
                }},

                { id: 'final-plenary', type: 'simple', content: { title: 'Plenary <span aria-hidden="true">ü§î</span>', text: '<strong>Think about it:</strong><br>Are you more "fast-twitch" or "slow-twitch"?<br>How does the "camaraderie" of sports affect your life?' } }
            ]
        };
        // --- END CONFIGURATION ---

        // --- SPEECH SERVICE (Configured for Microsoft Natural Voices) ---
        class SpeechService {
             constructor() { this.synth = window.speechSynthesis; this.isInitialized = false; this.isTtsEnabled = true; this.voices = {}; this.speechRate = 0.85; this.isDialoguePlaying = false; }
             
             async _setupVoices() {
                 const voicesPromise = new Promise(resolve => { if (this.synth.getVoices().length) return resolve(this.synth.getVoices()); this.synth.onvoiceschanged = () => resolve(this.synth.getVoices()); });
                 const availableVoices = await voicesPromise;
                 
                 // Strict mapping to requested Microsoft Natural voices
                 const findVoice = (name) => availableVoices.find(v => v.name.includes(name) && v.name.includes('Natural')) || availableVoices.find(v => v.name.includes(name));
                 
                 this.voices = {
                     'narrator': findVoice('Brian') || findVoice('United States') || availableVoices[0],
                     'emily harrington': findVoice('Emma') || findVoice('United States'),
                     'matt segal': findVoice('Andrew') || findVoice('United States'),
                     'francois guillot': findVoice('Brian') || findVoice('United Kingdom'), 
                     'alan carne': findVoice('Andrew') || findVoice('United Kingdom'),
                     'student a': findVoice('Ava') || findVoice('United States'),
                     'student b': findVoice('Andrew') || findVoice('United States'),
                     'default': findVoice('Ava') || availableVoices[0]
                 };
                 console.log("Voices loaded:", this.voices);
             }
             
             async init() { if (this.isInitialized) return; await this._setupVoices(); this.isInitialized = true; }
             
             _cleanTextForSpeech(text) { 
                 const tempDiv = document.createElement('div'); 
                 tempDiv.innerHTML = text.replace(/<span aria-hidden="true">.*?<\/span>/g, ' '); 
                 return tempDiv.innerText || tempDiv.textContent || ''; 
             }
             
             speak(text) { 
                 if (!this.isTtsEnabled || !text) return; 
                 this.cancel(); 
                 const utterance = new SpeechSynthesisUtterance(this._cleanTextForSpeech(text)); 
                 utterance.voice = this.voices['default'];
                 utterance.rate = this.speechRate; 
                 this.synth.speak(utterance); 
             }
             
             speakDialogue(text) { 
                 if (!this.isTtsEnabled || !text) return; 
                 this.cancel(); 
                 const lines = text.split('\n\n'); 
                 const speakLine = (index) => { 
                     if (index >= lines.length) return; 
                     const line = lines[index]; 
                     const [speaker, ...rest] = line.split(': '); 
                     const lineText = rest.join(': '); 
                     
                     const utterance = new SpeechSynthesisUtterance(this._cleanTextForSpeech(lineText || speaker)); 
                     
                     // Lookup voice by speaker name (lowercase)
                     const key = speaker.toLowerCase().trim();
                     utterance.voice = this.voices[key] || this.voices['default']; 
                     utterance.rate = this.speechRate; 
                     utterance.onend = () => speakLine(index + 1); 
                     this.synth.speak(utterance); 
                 }; 
                 speakLine(0); 
             }
             cancel() { this.synth.cancel(); }
             toggleTTS() { this.isTtsEnabled = !this.isTtsEnabled; if(!this.isTtsEnabled) this.cancel(); return this.isTtsEnabled; }
         }

        // --- CORE APP LOGIC ---
        const speechService = new SpeechService();
        let score = 0, currentPage = lessonData.startPageId;
        const pageHistory = [lessonData.startPageId];
        let pageSequence = [];

        function calculateSequence() {
            let seq = [lessonData.startPageId];
            lessonData.mainMenu.forEach(item => {
                if(item.target === '1a-intro') seq.push('1a-intro', '1a-vocab', '1a-reading', '1a-comp-mcq');
                if(item.target === '1b-intro') seq.push('1b-intro', '1b-vocab', '1b-reading', '1b-comp-gap');
                if(item.target === 'climbing-intro') seq.push('climbing-intro', 'climbing-dialogue');
                if(item.target === 'speaking-task') seq.push('speaking-task');
                if(item.target === 'final-plenary') seq.push('final-plenary');
            });
            return [...new Set(seq)];
        }

        window.startApp = async function() {
            await speechService.init();
            try { await Tone.start(); } catch(e){}
            pageSequence = calculateSequence();
            navigateTo(lessonData.homePageId);
        }

        window.navigateTo = (pageId) => {
            const target = document.getElementById(`page-${pageId}`);
            if (!target) return;
            speechService.cancel();
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            target.classList.add('active');
            currentPage = pageId;
            if (pageHistory[pageHistory.length - 1] !== pageId) pageHistory.push(pageId);
            
            const pageDef = lessonData.pages.find(p => p.id === pageId);
            if (pageDef) {
                if (pageDef.type === 'dialogue') speechService.speakDialogue(pageDef.content.dialogue);
                else if (pageDef.type === 'tiered-reading') {
                    const activeTab = target.querySelector('.reading-content:not(.hidden)');
                    if(activeTab) speechService.speak(activeTab.innerText);
                } else {
                    const h2 = target.querySelector('h2');
                    const p = target.querySelector('p');
                    const text = (h2 ? h2.innerText : '') + '. ' + (p ? p.innerText : '');
                    speechService.speak(text);
                }
            }

            const container = document.getElementById('emoji-floating-container');
            container.innerHTML = ''; 
            if (pageId.includes('1a')) spawnEmojis(['‚öΩ','ü•Ö','üëü','üåç']);
            else if (pageId.includes('1b')) spawnEmojis(['ü•á','üèãÔ∏è','üèÉ','üí™']);
            else if (pageId.includes('climbing')) spawnEmojis(['üßó','‚õ∞Ô∏è','ü™¢']);
            else spawnEmojis(['üèÜ','üèÖ','üéì']);

            updateNavButtons();
            updateProgressBar();
            window.scrollTo(0,0);
        }

        window.goBack = () => { if(pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); } }
        window.goNext = () => { 
            const idx = pageSequence.indexOf(currentPage);
            if(idx > -1 && idx < pageSequence.length - 1) navigateTo(pageSequence[idx+1]);
            else navigateTo(lessonData.homePageId);
        }
        window.toggleTTS = (btn) => {
            const enabled = speechService.toggleTTS();
            btn.classList.toggle('bg-blue-100', enabled);
            btn.classList.toggle('bg-gray-200', !enabled);
            if(enabled) navigateTo(currentPage); 
        }

        // --- RENDER FUNCTIONS ---
        function createPageElement(id, html) {
            const sec = document.createElement('section');
            sec.id = `page-${id}`;
            sec.className = 'page';
            sec.innerHTML = html;
            document.getElementById('dynamic-pages-container').appendChild(sec);
        }

        function renderPages() {
            // Render Main Menu
            const menuBtns = lessonData.mainMenu.map(item => `
                <button onclick="navigateTo('${item.target}')" class="btn-animated-3d bg-${item.color}-500 text-white font-bold text-lg p-4 rounded-xl w-full text-left shadow-md hover:bg-${item.color}-600 border-b-4 border-${item.color}-700 active:border-b-0 active:translate-y-1 transition-all">
                    ${item.text}
                </button>
            `).join('');
            createPageElement(lessonData.homePageId, `
                <div class="bg-white rounded-3xl shadow-lg p-8 border border-slate-100">
                    <h2 class="text-3xl font-bold text-center text-slate-800 mb-6">Unit Map</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${menuBtns}</div>
                </div>
            `);

            // Render Lesson Pages
            lessonData.pages.forEach(page => {
                let html = '';
                const wrapper = (content) => `<div class="bg-white rounded-3xl shadow-lg p-6 md:p-8 pt-12 border border-slate-100 relative overflow-hidden">${content}</div>`;
                
                if (page.type === 'simple') {
                    html = wrapper(`<h2 class="text-3xl font-bold text-slate-800 mb-4">${page.content.title}</h2><p class="text-xl text-slate-600 leading-relaxed">${page.content.text}</p>`);
                } else if (page.type === 'vocab-list') {
                    const list = page.content.words.map(w => `<div class="bg-slate-50 p-3 rounded-lg border-l-4 border-blue-500"><strong class="text-blue-700 text-lg block">${w.word}</strong><span class="text-slate-600">${w.def}</span></div>`).join('');
                    html = wrapper(`<h2 class="text-3xl font-bold text-slate-800 mb-6">${page.content.title}</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${list}</div>`);
                } else if (page.type === 'tiered-reading') {
                    html = wrapper(`
                        <h2 class="text-3xl font-bold text-slate-800 mb-4">${page.content.title}</h2>
                        <div class="flex justify-center gap-2 mb-6">
                            ${['A2','B1','B2'].map(lvl => `<button onclick="switchTier('${page.id}', '${lvl}')" class="tier-btn px-4 py-2 rounded-full font-bold ${lvl==='B1'?'active':''} text-sm">${lvl}</button>`).join('')}
                        </div>
                        <div id="content-${page.id}-A2" class="reading-content hidden text-lg leading-relaxed text-slate-700 bg-amber-50 p-4 rounded-xl border-l-4 border-amber-400">${page.content.texts['A2']}</div>
                        <div id="content-${page.id}-B1" class="reading-content text-lg leading-relaxed text-slate-700 bg-blue-50 p-4 rounded-xl border-l-4 border-blue-400">${page.content.texts['B1']}</div>
                        <div id="content-${page.id}-B2" class="reading-content hidden text-lg leading-relaxed text-slate-700 bg-emerald-50 p-4 rounded-xl border-l-4 border-emerald-400">${page.content.texts['B2']}</div>
                    `);
                } else if (page.type === 'dialogue') {
                    const lines = page.content.dialogue.split('\n\n').map(l => {
                        const [speaker, text] = l.split(': ');
                        const isLeft = ['student a', 'narrator', 'emily harrington', 'francois guillot'].includes(speaker.toLowerCase());
                        return `<div class="dialogue-bubble ${isLeft ? 'bubble-left' : 'bubble-right'}"><strong class="text-sm uppercase tracking-wide text-slate-500 mb-1 block">${speaker}</strong><p>${text}</p></div>`;
                    }).join('');
                    html = wrapper(`<h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">${page.content.title}</h2><div class="space-y-4">${lines}</div>`);
                } else if (page.type.includes('quiz')) {
                    let qHtml = '';
                    if (page.type === 'quiz-gap-fill') {
                        const sentences = page.content.sentences.map((s,i) => `<p class="mb-4 text-lg">${i+1}. ${s.text[0]} <span class="gap" data-answer="${s.answer}" ondrop="drop(event)" ondragover="allowDrop(event)"></span> ${s.text[1]||''}</p>`).join('');
                        const words = page.content.wordBank.map(w => `<div class="word-bank-word inline-block m-1" draggable="true" ondragstart="drag(event)" data-word="${w}">${w}</div>`).join('');
                        qHtml = `<div class="gap-fill-container">${sentences}</div><div class="bg-slate-100 p-4 rounded-xl mt-6 flex flex-wrap gap-2 justify-center border border-slate-200">${words}</div>`;
                    } else if (page.type === 'quiz-mcq') {
                        qHtml = page.content.questions.map((q,i) => `
                            <div class="mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <p class="font-bold text-lg mb-3">${i+1}. ${q.question}</p>
                                <div class="grid gap-2">${q.options.map(opt => `<button onclick="checkMCQ(this, ${opt===q.correctAnswer})" class="quiz-option w-full text-left p-3 rounded-lg bg-white border border-slate-200 hover:bg-blue-50">${opt}</button>`).join('')}</div>
                            </div>`).join('');
                    }
                    html = wrapper(`<h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">${page.content.title}</h2>${qHtml}`);
                }
                createPageElement(page.id, html);
            });
        }

        // --- HELPER FUNCTIONS ---
        window.switchTier = (pageId, tier) => {
            const page = document.getElementById(`page-${pageId}`);
            page.querySelectorAll('.reading-content').forEach(d => d.classList.add('hidden'));
            page.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
            page.querySelector(`#content-${pageId}-${tier}`).classList.remove('hidden');
            Array.from(page.querySelectorAll('.tier-btn')).find(b => b.innerText === tier).classList.add('active');
            speechService.speak(page.querySelector(`#content-${pageId}-${tier}`).innerText);
        }

        window.updateProgressBar = () => {
            if(pageSequence.length === 0) return;
            const idx = pageSequence.indexOf(currentPage);
            const pct = ((idx + 1) / pageSequence.length) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;
        }

        window.updateNavButtons = () => {
            const nav = document.getElementById('nav-header');
            if (currentPage === 'title-screen') nav.style.display = 'none';
            else nav.style.display = 'block';
        }

        window.allowDrop = (ev) => ev.preventDefault();
        window.drag = (ev) => ev.dataTransfer.setData("text", ev.target.dataset.word);
        window.drop = (ev) => {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const target = ev.target;
            if(target.classList.contains('gap') && !target.hasChildNodes()) {
                const wordEl = document.querySelector(`.word-bank-word[data-word="${data}"]`);
                target.appendChild(wordEl);
                checkGap(target);
            }
        }
        
        function checkGap(gap) {
            const word = gap.innerText.trim();
            const correct = gap.dataset.answer;
            if(word.toLowerCase() === correct.toLowerCase()) {
                gap.classList.add('correct');
                addPoints(10);
                spawnReward(gap);
                playTone('C5');
            } else {
                gap.classList.add('incorrect');
                playTone('C3');
                setTimeout(() => gap.classList.remove('incorrect'), 1000);
            }
        }

        window.checkMCQ = (btn, isCorrect) => {
            const parent = btn.parentElement;
            Array.from(parent.children).forEach(c => c.disabled = true);
            if(isCorrect) {
                btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                addPoints(10);
                spawnReward(btn);
                playTone('C5');
            } else {
                btn.classList.add('bg-red-100', 'border-red-500', 'shake');
                playTone('C3');
            }
        }

        function addPoints(pts) { score += pts; document.getElementById('score-display').innerText = score; }
        function playTone(note) { try { const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease(note, "8n"); } catch(e){} }

        function spawnReward(el) {
            const rect = el.getBoundingClientRect();
            const container = document.getElementById('reward-animation-container');
            for(let i=0; i<15; i++) {
                const p = document.createElement('div');
                p.className = 'particle glitter';
                p.style.left = (rect.left + rect.width/2) + 'px';
                p.style.top = (rect.top + rect.height/2) + 'px';
                p.style.backgroundColor = ['#fbbf24','#3b82f6','#22c55e'][Math.floor(Math.random()*3)];
                container.appendChild(p);
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 100 + 50;
                p.animate([
                    { transform: `translate(0,0) scale(1)`, opacity: 1 },
                    { transform: `translate(${Math.cos(angle)*velocity}px, ${Math.sin(angle)*velocity}px) scale(0)`, opacity: 0 }
                ], { duration: 800, easing: 'ease-out' }).onfinish = () => p.remove();
            }
        }

        function spawnEmojis(list) {
            const container = document.getElementById('emoji-floating-container');
            for(let i=0; i<6; i++) {
                const el = document.createElement('div');
                el.className = 'floating-emoji';
                el.innerText = list[Math.floor(Math.random()*list.length)];
                el.style.top = Math.random()*80 + 10 + '%';
                el.style.animationDuration = (Math.random()*10 + 10) + 's';
                el.style.animationDelay = (Math.random()*5) + 's';
                container.appendChild(el);
            }
        }

        // Init
        renderPages();
    </script>
</body>
</html>
