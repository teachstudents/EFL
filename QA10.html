<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Joel's Speaking Practice 10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            position: relative;
        }
        /* Snowfall effect */
        .snowflake {
            color: #fff;
            font-size: 1em;
            font-family: Arial, sans-serif;
            text-shadow: 0 0 5px #000;
            position: fixed;
            top: -10%;
            z-index: 0;
            user-select: none;
            animation: snowfall linear infinite;
        }

        @keyframes snowfall {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(105vh) rotate(360deg); opacity: 0; }
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        audio::-webkit-media-controls-panel {
            padding: 5px;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display {
            margin: 0 2px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Make sure app content is above the snow */
        #app-container {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gradient-to-br dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center p-2 sm:p-4">
    
    <div id="snow-container"></div>

    <div id="app-container" class="w-full max-w-xl mx-auto text-center h-full">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-white dark:bg-gray-800 dark:shadow-lg p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center">
            <div id="name-entry-container">
                <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">Joel's Speaking Practice 10</h1>
                <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 text-center text-lg text-gray-900 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                <button id="start-with-name-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">Start</button>
            </div>
            <div id="topic-selection-container" class="hidden">
                 <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">Hello, <span id="user-name-display"></span>!</h1>
                 <div id="instructions" class="text-sm text-gray-600 dark:text-gray-400 mb-4 text-left space-y-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                      <p><i class="fas fa-bullhorn mr-2 text-indigo-500"></i>Try to speak until the time runs out. You can use the sentence starters and word bank for help.</p>
                      <p><i class="fas fa-download mr-2 text-blue-500"></i>After recording, download your answer and upload it. If the upload doesn't work, save the downloaded files.</p>
                      <p><i class="fas fa-award mr-2 text-yellow-500"></i>You must complete all 9 topics to get the Certificate of Completion as proof you finished the homework.</p>
                 </div>
                <div id="topic-selection" class="grid grid-cols-3 gap-4">
                    <!-- Topic buttons will be injected here -->
                </div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden bg-white dark:bg-gray-800 dark:shadow-lg rounded-2xl shadow-lg app-shell p-3 sm:p-4">
            <header class="flex-shrink-0">
                <div class="flex justify-between items-center mb-1">
                    <button id="back-to-topics-btn" class="text-indigo-500 hover:text-indigo-700"><i class="fas fa-arrow-left mr-2"></i>Topics</button>
                </div>
                <!-- Timer Display -->
                <div class="relative w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-2 flex-shrink-0">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200 dark:text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="timer-progress" class="timer-circle text-indigo-500" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-2xl font-bold"></div>
                </div>
                <p id="phase-indicator" class="font-semibold text-indigo-500 dark:text-indigo-400 mb-2 text-base flex-shrink-0"></p>

                <!-- Question Display -->
                <div id="question-container" class="min-h-[50px] flex items-center justify-center mb-2">
                    <h2 id="question-text" class="text-base sm:text-lg font-semibold leading-relaxed text-left w-full"></h2>
                </div>
                
                <div id="error-message-box" class="hidden text-red-500 bg-red-100 dark:bg-red-900/50 p-2 rounded-lg text-sm mb-2"></div>

                <!-- Recording Action Buttons -->
                <div id="recording-actions-container" class="flex flex-col items-center justify-center mb-2">
                    <!-- Initial Record Button -->
                    <button id="record-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md transition-transform transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <!-- Stop Button -->
                    <button id="stop-record-btn" class="hidden bg-gray-700 hover:bg-gray-800 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md flex items-center justify-center">
                        <i class="fas fa-stop"></i>
                    </button>
                    <!-- Post-Recording Controls -->
                    <div id="post-recording-actions" class="hidden w-full flex-col items-center justify-center space-y-2 mt-2">
                        <audio id="audio-player" controls class="w-full max-w-xs"></audio>
                        <div class="flex flex-col gap-3 w-full max-w-xs">
                           <!-- Smart Download button -->
                           <button id="download-btn"
                                   class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md transition-all duration-200 ease-in-out hover:shadow-lg hover:shadow-blue-500/50 focus:ring-2 focus:ring-blue-400 focus:outline-none active:scale-95 flex items-center justify-center">
                               <i class="fas fa-download mr-1"></i>Download Recording / Open Folder
                           </button>
                           
                           <!-- Upload button -->
                           <a id="sharepoint-upload-link"
                                 href="https://xichengacademy-my.sharepoint.com/:f:/g/personal/joelmitchell_xichengacademy_cn/EjxMFg8-baNEo5uuWUBc4EoBzn1DVWJ1Ym_NFx6hPlJ0dQ"
                                 target="_blank"
                                 rel="noopener noreferrer"
                                 class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md transition-all duration-200 ease-in-out hover:shadow-lg hover:shadow-green-500/50 focus:ring-2 focus:ring-green-400 focus:outline-none active:scale-95 flex items-center justify-center">
                               <i class="fas fa-upload mr-1"></i>Upload to Folder
                           </a>
                        </div>
                    </div>
                </div>
                 <div id="recording-status" class="hidden items-center justify-center text-red-500 font-semibold mb-1">
                      <div class="w-2 h-2 bg-red-500 rounded-full mr-2 recording-indicator"></div>
                      Recording...
                 </div>
            </header>
            
            <main class="flex-grow flex flex-col overflow-y-auto min-h-0 space-y-2 pt-2">
                 <!-- Sentence Starters -->
                <div id="starters-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Sentence Starters</h3>
                    <div id="starters-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Word Bank -->
                <div id="word-bank-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Word Bank</h3>
                    <div id="word-bank-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Sample Answers Display -->
                <div id="samples-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center flex-shrink-0">Sample Responses</h3>
                    <ul id="samples-list" class="space-y-2 list-disc list-inside bg-indigo-900/70 dark:bg-indigo-900/90 p-3 rounded-lg max-h-28 sm:max-h-32 overflow-y-auto">
                    </ul>
                </div>
            </main>

            <footer class="flex-shrink-0 mt-2">
                <!-- Next Button -->
                <div id="controls-container">
                     <button id="next-btn" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg text-lg shadow-md">Next</button>
                </div>
            </footer>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center">
            <div id="certificate-to-download" class="w-full bg-gray-50 dark:bg-gray-700 p-8 rounded-lg border-4 border-yellow-400 dark:border-yellow-500 text-center">
                <i class="fas fa-award text-6xl text-yellow-500 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Certificate of Completion</h1>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">This certificate is awarded to</p>
                <p id="certificate-name" class="text-4xl font-bold my-4 text-indigo-600 dark:text-indigo-400"></p>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">for successfully completing all 9 speaking practice topics.</p>
                <p class="text-sm mt-6 text-gray-500 dark:text-gray-400">Issued on: <span id="certificate-date"></span></p>
            </div>
            <button id="download-certificate-btn" class="mt-6 w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">
                <i class="fas fa-download mr-2"></i>Download Certificate
            </button>
             <button id="back-to-main-menu-btn" class="mt-3 text-sm text-indigo-500 hover:underline">Back to Main Menu</button>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA: Questions and Sample Answers for Part 10 ---
        const practiceData = {
            "A Family Tradition": [
                { 
                    question: "Describe a family tradition that is important to you. What does it involve and why do you enjoy it?", 
                    starters: ["Every year, my family always...", "A tradition that means a lot to me is...", "It's a special time because...", "What I love most about it is..."], 
                    wordBank: ["Mid-Autumn Festival", "Spring Festival dinner", "making dumplings (包饺子)", "gathering", "sense of belonging", "reunion", "passing down traditions", "togetherness", "special food"], 
                    samples: [
                        "Every year during the Mid-Autumn Festival, my family gets together to eat mooncakes and look at the full moon. It's a special time because even my relatives who live far away will come back for the reunion.",
                        "A tradition that means a lot to me is making dumplings from scratch for the Spring Festival dinner. Everyone gets involved, from my grandparents to me, and it's a great feeling of togetherness.",
                        "What I love most about our tradition of visiting the temple on the first day of the new year is the sense of belonging and hope it gives me for the year ahead."
                    ] 
                }
            ],
            "Digital Detox": [
                { 
                    question: "Imagine your university has a 'digital detox' week. What challenges would you face and what benefits might you discover?", 
                    starters: ["The biggest challenge for me would be...", "I think I would find it difficult to...", "However, a potential benefit could be...", "I might discover that..."], 
                    wordBank: ["fear of missing out (FOMO)", "habit", "rely on my phone", "boredom", "more focused", "better sleep", "real-life conversations", "less distracted", "mentally refreshing"], 
                    samples: [
                        "The biggest challenge would be the fear of missing out on what my friends are doing. I'm so used to communicating through WeChat, it would be hard not to check it.",
                        "However, a potential benefit is that I might be more focused on my studies and get more reading done without the constant distraction of notifications.",
                        "I might discover that I sleep better and feel more relaxed. It would be a mentally refreshing experience to have more real-life conversations instead of just texting."
                    ] 
                }
            ],
            "Explaining a Game": [
                { 
                    question: "How would you explain the rules of a popular Chinese game (like Mahjong or a specific card game) to a German friend who has never heard of it?", 
                    starters: ["First, you need to understand the goal, which is...", "The basic setup involves...", "On your turn, you can...", "It sounds complicated, but the best way to learn is..."], 
                    wordBank: ["objective", "the rules", "strategy", "tiles/cards", "take turns", "a winning hand", "simple explanation", "let's play a practice round", "fun and social"], 
                    samples: [
                        "To explain Mahjong, I'd start with the main objective: to get a winning hand of tiles, similar to some card games. The best way to learn is just to play a practice round slowly.",
                        "For the card game 'Dou Dizhu', I would explain that two players team up against one 'landlord' player. On your turn, you try to get rid of your cards first by playing stronger hands.",
                        "I'd say, 'It looks more complicated than it is! Let me show you the basic sets you need to collect, and we can play an open-hand game so I can give you advice.'"
                    ] 
                }
            ],
            "A News Story": [
                 { 
                    question: "Think about a recent news story that you found interesting or important. What was it about and why did it catch your attention?", 
                    starters: ["I recently read a story about...", "It was interesting to me because...", "The article was about...", "It made me think about the issue of..."], 
                    wordBank: ["scientific discovery", "environmental issue", "technological advancement", "cultural event", "global news", "impact", "raised awareness", "perspective", "significant"], 
                    samples: [
                        "I read an interesting story about a new breakthrough in battery technology. It caught my attention because it could have a huge positive impact on electric cars and renewable energy.",
                        "I saw a report about a cultural heritage site being restored. It was important to me because it's about preserving our history for future generations to see.",
                        "I followed the news about the latest space mission to Mars. I find space exploration fascinating and it makes me think about humanity's future."
                    ] 
                }
            ],
            "Budgeting Scenario": [
                { 
                    question: "Imagine you receive a birthday gift of 100 euros. Would you save it, spend it on something practical, or use it for a fun experience? Explain your choice.", 
                    starters: ["With 100 euros, I would definitely...", "My first priority would be to...", "I would choose to... because...", "While it's tempting to..., I think it's wiser to..."],
                    wordBank: ["save for a rainy day", "invest in something useful", "a textbook", "a weekend trip", "memories are more valuable", "practical choice", "long-term vs short-term", "treat myself", "balance"],
                    samples: [
                        "I would use the money for a fun experience, like a train ticket to visit a city I haven't seen before. I think memories from an experience are more valuable than a material item.",
                        "I would make a practical choice and buy a good-quality German dictionary or a textbook for my course. It's a boring choice, but it would be a smart investment in my studies.",
                        "I would probably save most of it in my emergency fund, but I might use a small part, maybe 20 euros, to treat myself to a nice meal with a new friend."
                    ] 
                }
            ],
            "Teen Misconceptions": [
                { 
                    question: "What is one common misconception that adults have about teenagers today? Why do you think it's wrong?", 
                    starters: ["A common misconception is that all teenagers are...", "I think this is unfair because...", "In reality, many of us are...", "People might think this because..., but..."],
                    wordBank: ["lazy", "addicted to phones", "don't care about the future", "self-centered", "under a lot of pressure", "passionate about issues", "hard-working", "stereotype", "generalization"],
                    samples: [
                        "A common misconception is that teenagers are lazy. In reality, we are under a lot of academic pressure and have many extracurricular activities, so we are actually very busy and hard-working.",
                        "Many adults think we are addicted to our phones and only care about social media. While we use our phones a lot, we also use them to study, read news, and stay connected with family.",
                        "Some people think teens don't care about important issues. I think that's wrong; many of my friends are very passionate about topics like environmental protection and social justice."
                    ] 
                }
            ],
            "Study Group": [
                {
                    question: "You need to organize a study group for a difficult subject. What steps would you take to make the group effective?",
                    starters: ["First, I would find...", "To make sure we stay on track, I would suggest...", "An effective group needs...", "I would propose that we..."],
                    wordBank: ["motivated students", "set a clear goal", "create an agenda", "assign roles", "stay focused", "respectful discussion", "come prepared", "regular meetings", "collaborate effectively"],
                    samples: [
                        "First, I would try to find a small group of students who are all motivated to do well. Then, I'd suggest we set a clear goal for each study session, like finishing one chapter.",
                        "To keep us on track, I would propose creating a simple agenda for each meeting so we don't waste time and can make sure we cover all the important topics.",
                        "I think it's important that everyone comes prepared. Before we meet, we should all review the material so we can have a productive and respectful discussion."
                    ]
                }
            ],
            "The Perfect Gift": [
                {
                    question: "If you could give any gift in the world to one person, what would it be and why?",
                    starters: ["If I could give one gift, it would be for my...", "I would give them...", "I'd choose this because...", "It's not about the money, but about..."],
                    wordBank: ["a trip around the world", "a house", "good health", "more free time", "an unforgettable experience", "show my appreciation", "make them happy", "meaningful", "thoughtful"],
                    samples: [
                        "I would give my parents the gift of a long, relaxing vacation to anywhere they want to go. They have worked so hard for me, and they deserve a break.",
                        "If I could, I would give my grandmother the gift of perfect health so that she could be active and happy without any worries.",
                        "I would give my best friend a fully-equipped art studio, because she is an incredibly talented artist and I want to support her passion and her dreams."
                    ]
                }
            ],
            "Final Reflection": [
                {
                    question: "As you prepare to leave for Germany, what is the one thing you are most proud of accomplishing in your high school years?",
                    starters: ["Looking back, I am most proud of...", "It wasn't easy, but I'm proud that I...", "The accomplishment that means the most is...", "It's not an award, but rather..."],
                    wordBank: ["improving my grades", "developing a new skill", "becoming more confident", "overcoming a fear", "maintaining good friendships", "personal growth", "dedication", "achievement", "perseverance"],
                    samples: [
                        "I'm most proud of how much I improved my English. I was not confident at first, but I worked very hard, and now I feel ready to study in another language.",
                        "The accomplishment that means the most to me is learning how to manage my time effectively. Balancing the Gaokao preparation with my hobbies was hard, but I did it.",
                        "Looking back, I'm proud of the strong friendships I've built. We supported each other through all the stress of high school, and that's something I'll always cherish."
                    ]
                }
            ]
        };

        // --- DOM Elements ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const practiceScreen = document.getElementById('practice-screen');
        const nameEntryContainer = document.getElementById('name-entry-container');
        const nameInput = document.getElementById('name-input');
        const startWithNameBtn = document.getElementById('start-with-name-btn');
        const topicSelectionContainer = document.getElementById('topic-selection-container');
        const userNameDisplay = document.getElementById('user-name-display');
        const topicSelection = document.getElementById('topic-selection');
        const nextBtn = document.getElementById('next-btn');
        const backToTopicsBtn = document.getElementById('back-to-topics-btn');
        
        const timerDisplay = document.getElementById('timer-display');
        const timerProgress = document.getElementById('timer-progress');
        const phaseIndicator = document.getElementById('phase-indicator');
        
        const questionContainer = document.getElementById('question-container');
        const questionText = document.getElementById('question-text');
        const samplesContainer = document.getElementById('samples-container');
        const samplesList = document.getElementById('samples-list');
        const startersContainer = document.getElementById('starters-container');
        const startersList = document.getElementById('starters-list');
        const wordBankContainer = document.getElementById('word-bank-container');
        const wordBankList = document.getElementById('word-bank-list');
        const errorMessagebox = document.getElementById('error-message-box');

        const recordBtn = document.getElementById('record-btn');
        const stopRecordBtn = document.getElementById('stop-record-btn');
        const audioPlayer = document.getElementById('audio-player');
        const recordingStatus = document.getElementById('recording-status');
        const postRecordingActions = document.getElementById('post-recording-actions');
        const downloadBtn = document.getElementById('download-btn');
        
        // Certificate UI
        const certificateScreen = document.getElementById('certificate-screen');
        const downloadCertificateBtn = document.getElementById('download-certificate-btn');
        const backToMainMenuBtn = document.getElementById('back-to-main-menu-btn');


        // --- State Variables ---
        let userName = '';
        let currentQuestionIndex = 0;
        let currentQuestions = [];
        let timerInterval;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;
        let completedTopics = {};
        let speechRecognition;
        let finalTranscript = '';

        const FULL_DASH_ARRAY = 283;
        const DEFAULT_RESPONSE_TIME = 60;
        const READ_TIME = 60;

        // --- Text-to-Speech ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;
        let ttsInitialized = false;

        function initializeTTS() {
            return new Promise((resolve) => {
                if (!synth) {
                    ttsInitialized = true;
                    return resolve();
                }

                const setBestVoice = () => {
                    const voices = synth.getVoices();
                    if (voices.length === 0) return;
                    
                    const scoreVoice = (voice) => {
                        let score = 0;
                        const name = voice.name.toLowerCase();
                        if (name.includes('natural')) score += 5;
                        if (name.includes('brian') || name.includes('emma')) score += 4;
                        if (name.includes('microsoft')) score += 3;
                        if (name.includes('google')) score += 2;
                        if (voice.localService) score += 1;
                        return score;
                    };

                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    if (englishVoices.length > 0) {
                        englishVoices.sort((a, b) => scoreVoice(b) - scoreVoice(a));
                        preferredVoice = englishVoices[0];
                    }
                    
                    ttsInitialized = true;
                    resolve();
                };

                if (synth.getVoices().length > 0) {
                    setBestVoice();
                } else {
                    synth.onvoiceschanged = setBestVoice;
                }
            });
        }

        function speak(text, isFeedback = false) {
            if (!ttsInitialized) return;
            try {
                if (synth.speaking) synth.cancel();
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.onerror = (event) => console.error('SpeechSynthesisUtterance.onerror', event);
                if (preferredVoice) utterThis.voice = preferredVoice;
                utterThis.pitch = 1;  
                utterThis.rate = 0.85; // Slow down speech as requested
                synth.speak(utterThis);
            } catch (e) {
                console.error("Speech synthesis failed:", e);
            }
        }

        // --- Local Storage ---
        function loadProgress() {
            const savedCompletedTopics = localStorage.getItem('languagePracticeCompletedTopics');
            if (savedCompletedTopics) {
                try {
                    const parsed = JSON.parse(savedCompletedTopics);
                    // Basic validation to ensure it's an object
                    if (typeof parsed === 'object' && parsed !== null) {
                        completedTopics = parsed;
                    } else {
                         completedTopics = {};
                    }
                } catch (e) {
                    console.error("Failed to parse saved progress:", e);
                    completedTopics = {}; // Reset progress if data is corrupt
                }
            }
            const savedName = localStorage.getItem('languagePracticeUserName');
            if (savedName) {
                 userName = savedName;
                 nameInput.value = userName;
            }
        }

        function saveProgress() {
            localStorage.setItem('languagePracticeCompletedTopics', JSON.stringify(completedTopics));
            if(userName) localStorage.setItem('languagePracticeUserName', userName);
        }

        // --- UI Initialization ---
        function initializeTopics() {
            topicSelection.innerHTML = '';
            for (const topic in practiceData) {
                const button = document.createElement('button');
                
                let checkmark = '';
                if (completedTopics && completedTopics[topic]) {
                    checkmark = `<i class="fas fa-check-circle text-green-500 ml-2"></i>`;
                    button.className = "w-full bg-green-100 dark:bg-green-900/50 p-2 rounded-lg shadow-md hover:bg-green-200 dark:hover:bg-green-800/60 transition-colors flex items-center justify-center";
                } else {
                    button.className = "w-full bg-white dark:bg-gray-700 p-2 rounded-lg shadow-md hover:bg-indigo-100 dark:hover:bg-indigo-800 transition-all transform hover:scale-105 flex items-center justify-center";
                }

                button.innerHTML = `<span class="text-sm font-semibold">${topic}</span> ${checkmark}`;
                button.dataset.topic = topic;
                button.addEventListener('click', () => startPractice(topic));
                topicSelection.appendChild(button);
            }
        }

        // --- Core App Logic ---
        function startPractice(topic) {
            currentQuestions = practiceData[topic];
            currentQuestions.topicName = topic;
            currentQuestionIndex = 0;
            welcomeScreen.classList.add('hidden');
            practiceScreen.classList.remove('hidden');
            certificateScreen.classList.add('hidden');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                phaseIndicator.textContent = "Topic Complete!";
                questionText.textContent = "You've finished this topic. Well done!";
                completedTopics[currentQuestions.topicName] = true;
                saveProgress();
                checkAllTopicsCompleted();
                resetRecordingUI();
                nextBtn.classList.add('hidden');
                speak("You've completed this topic! Well done.");
                return;
            }

            const item = currentQuestions[currentQuestionIndex];
            resetUIForNewQuestion();
            
            let fullQuestion = (item.intro ? item.intro + " " : "") + item.question;
            questionText.textContent = fullQuestion;
            questionText.classList.add('fade-in');
            setTimeout(() => questionText.classList.remove('fade-in'), 500);

            speak(fullQuestion);
            
            // Populate Sentence Starters
            if (item.starters && item.starters.length > 0) {
                startersList.innerHTML = '';
                item.starters.forEach(starter => {
                    const button = document.createElement('button');
                    button.className = 'bg-indigo-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-indigo-600 dark:text-white cursor-default';
                    button.textContent = starter;
                    startersList.appendChild(button);
                });
                startersContainer.classList.remove('hidden');
            }

            // Populate Word Bank
            if (item.wordBank && item.wordBank.length > 0) {
                wordBankList.innerHTML = '';
                item.wordBank.forEach(word => {
                    const button = document.createElement('button');
                    button.className = 'bg-green-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-green-600 dark:text-white cursor-default';
                    button.textContent = word;
                    wordBankList.appendChild(button);
                });
                wordBankContainer.classList.remove('hidden');
            }

            const responseTime = item.timer || DEFAULT_RESPONSE_TIME;
            phaseIndicator.textContent = `Prepare & Record (Question ${currentQuestionIndex + 1} of ${currentQuestions.length})`;
            startTimer(responseTime, showSampleAnswersAndStartReadTimer);
        }

        function showSampleAnswersAndStartReadTimer() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
            
            phaseIndicator.textContent = "Review";
            recordBtn.disabled = true;
            recordBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const item = currentQuestions[currentQuestionIndex];
            if (item.samples && item.samples.length > 0) {
                samplesList.innerHTML = '';
                item.samples.forEach(sample => {
                    const li = document.createElement('li');
                    li.textContent = sample;
                    // Changed to white text as requested
                    li.className = 'text-white text-sm sm:text-base';
                    samplesList.appendChild(li);
                });
                samplesContainer.classList.remove('hidden');
            }


            startTimer(READ_TIME, () => {
                phaseIndicator.textContent = "Time's up!";
                nextBtn.classList.remove('hidden');
            });
        }
        
        // --- Certificate Logic ---
        function checkAllTopicsCompleted() {
            const totalTopics = Object.keys(practiceData).length;
            const completedCount = Object.keys(completedTopics).length;
            if (completedCount === totalTopics) {
                showCertificate();
            }
        }
        
        function showCertificate() {
            practiceScreen.classList.add('hidden');
            welcomeScreen.classList.add('hidden');
            certificateScreen.classList.remove('hidden');
            document.getElementById('certificate-name').textContent = userName;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
        }
        
        function showErrorMessage(message) {
            errorMessagebox.textContent = message;
            errorMessagebox.classList.remove('hidden');
            setTimeout(() => {
                errorMessagebox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        // --- Recording & Transcription Logic ---
        async function startRecording() {
            if (!window.MediaRecorder) {
                showErrorMessage("Audio recording is not supported on this browser.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const isMobileEdge = /Edg\/\d+.*Android/.test(navigator.userAgent);
                let options = {};
                if (!isMobileEdge) {
                    const mimeTypes = ['audio/webm;codecs=opus', 'audio/ogg;codecs=opus', 'audio/webm', 'audio/ogg'];
                    const supportedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
                    if (supportedType) options.mimeType = supportedType;
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.start();
                startTranscription();

                recordBtn.classList.add('hidden');
                stopRecordBtn.classList.remove('hidden');
                recordingStatus.classList.remove('hidden');

                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    recordedBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedBlob);
                    audioPlayer.src = audioUrl;
                    postRecordingActions.classList.remove('hidden');
                    recordingStatus.classList.add('hidden');
                    stopRecordBtn.classList.add('hidden');
                    recordBtn.classList.add('hidden');
                });
            } catch (err) {
                console.error("Error starting recording:", err);
                showErrorMessage("Could not start audio recording. Please grant microphone permission.");
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
            if (speechRecognition) {
                speechRecognition.stop();
            }
        }

        function startTranscription() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("Speech recognition not supported — skipping setup.");
                return;
            }

            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';
            finalTranscript = '';

            speechRecognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
            };
            
            speechRecognition.onerror = (event) => {
                 console.error('Speech recognition error detected: ' + event.error);
            }

            speechRecognition.start();
        }

        // --- Timer Functions ---
        function startTimer(duration, onEndCallback) {
            let timeLeft = duration;
            clearInterval(timerInterval);
            updateTimerDisplay(timeLeft, duration);

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft, duration);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if(onEndCallback) onEndCallback();
                }
            }, 1000);
        }

        function updateTimerDisplay(timeLeft, totalDuration) {
            const minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            if (seconds < 10) seconds = `0${seconds}`;
            timerDisplay.textContent = `${minutes}:${seconds}`;
            
            const fraction = timeLeft / totalDuration;
            const offset = fraction * FULL_DASH_ARRAY;
            timerProgress.style.strokeDashoffset = FULL_DASH_ARRAY - offset;
        }

        // --- UI Helper Functions ---
        function resetUIForNewQuestion() {
            samplesContainer.classList.add('hidden');
            startersContainer.classList.add('hidden');
            wordBankContainer.classList.add('hidden');
            nextBtn.classList.add('hidden');
            errorMessagebox.classList.add('hidden');
            recordBtn.disabled = false;
            recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            resetRecordingUI();
        }

        function resetRecordingUI() {
            recordBtn.classList.remove('hidden');
            stopRecordBtn.classList.add('hidden');
            recordingStatus.classList.add('hidden');
            postRecordingActions.classList.add('hidden');
            audioPlayer.src = '';
            audioChunks = [];
            recordedBlob = null;
            finalTranscript = '';
        }

        
        // --- Snowfall Logic ---
        function createSnow() {
            const snowContainer = document.getElementById('snow-container');
            const snowflakeCount = window.innerWidth < 768 ? 15 : 50;
            for (let i = 0; i < snowflakeCount; i++) {
                let snowflake = document.createElement('div');
                snowflake.innerHTML = '❄';
                snowflake.classList.add('snowflake');
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.animationDuration = Math.random() * 5 + 5 + 's'; // 5-10 seconds
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                snowflake.style.fontSize = Math.random() * 1.5 + 0.5 + 'em';
                snowflake.style.opacity = Math.random();
                snowContainer.appendChild(snowflake);
            }
        }


        // --- Event Listeners ---
        startWithNameBtn.addEventListener('click', () => {
            userName = nameInput.value.trim();
            if (userName) {
                saveProgress();
                nameEntryContainer.classList.add('hidden');
                userNameDisplay.textContent = userName;
                topicSelectionContainer.classList.remove('hidden');
            } else {
                // Using a custom message box instead of alert()
                const nameError = document.createElement('div');
                nameError.textContent = "Please enter your name.";
                nameError.className = "text-red-500 text-sm mt-2";
                startWithNameBtn.insertAdjacentElement('afterend', nameError);
                setTimeout(() => nameError.remove(), 2000);
            }
        });

        recordBtn.addEventListener('click', startRecording);
        stopRecordBtn.addEventListener('click', stopRecording);
        
        // --- Certificate Download ---
        downloadCertificateBtn.addEventListener('click', () => {
          const certificateNode = document.getElementById('certificate-to-download');
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const newTab = isIOS ? window.open() : null;

          html2canvas(certificateNode, { scale: 2 }).then(canvas => {
            canvas.toBlob(blob => {
              const url = URL.createObjectURL(blob);
              if (isIOS && newTab) {
                newTab.location = url;
              } else {
                const a = document.createElement('a');
                a.href = url;
                a.download = `Certificate_of_Completion_${userName.replace(/\s+/g, '_')}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
              }
              URL.revokeObjectURL(url);
            });
          });
        });

        backToMainMenuBtn.addEventListener('click', () => {
            certificateScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            initializeTopics();
        });

        // --- Recording Download ---
        downloadBtn.addEventListener('click', () => {
          if (recordedBlob) {
            const topicName = currentQuestions.topicName.replace(/\s+/g, '_');
            const sanitizedUserName = userName.replace(/\s+/g, '_');
            const fileName = `${sanitizedUserName}_${topicName}_Q${currentQuestionIndex + 1}.webm`;
            const blobUrl = URL.createObjectURL(recordedBlob);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            if (isIOS) {
              // Open tab immediately to avoid Safari popup block
              const newTab = window.open();
              if (newTab) newTab.location = blobUrl;
            } else {
              const a = document.createElement('a');
              a.style.display = 'none';
              a.href = blobUrl;
              a.download = fileName;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            }

            // Visual feedback
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = `<i class="fas fa-check mr-1"></i>Downloaded!`;
            downloadBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            downloadBtn.classList.add('bg-green-600');
            setTimeout(() => {
              downloadBtn.innerHTML = originalText;
              downloadBtn.classList.remove('bg-green-600');
              downloadBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }, 2000);

          } else {
            // No recording — open SharePoint folder
            window.open(
              'https://xichengacademy-my.sharepoint.com/:f:/g/personal/joelmitchell_xichengacademy_cn/EjxMFg8-baNEo5uuWUBc4EoBzn1DVWJ1Ym_NFx6hPlJ0dQ',
              '_blank'
            );
          }
        });

        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            showQuestion();
        });

        backToTopicsBtn.addEventListener('click', () => {
            practiceScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            clearInterval(timerInterval);
            initializeTopics();
        });
        
        // --- Initial Load ---
        async function main() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
                const sharepointLink = document.getElementById('sharepoint-upload-link');
                if(sharepointLink) {
                    sharepointLink.removeAttribute('target');
                }
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !SpeechRecognition) {
                recordBtn.disabled = true;
                recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                recordBtn.title = "Audio recording or recognition is not supported on this browser.";
            }
            if (!window.speechSynthesis) {
                 console.warn("Text-to-speech is not supported on this browser.");
            }
            
            await initializeTTS().catch(err => console.error(err));
            
            createSnow();
            loadProgress();
            initializeTopics();
        }
        
        main();

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (isIOS) {
            const sharepointLink = document.getElementById('sharepoint-upload-link');
            if (sharepointLink) {
                sharepointLink.removeAttribute('target');
            }
        }
    });
    </script>
</body>
</html>
