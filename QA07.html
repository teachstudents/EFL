<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Joel's Speaking Practice 07</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            position: relative;
        }
        /* Snowfall effect */
        .snowflake {
            color: #fff;
            font-size: 1em;
            font-family: Arial, sans-serif;
            text-shadow: 0 0 5px #000;
            position: fixed;
            top: -10%;
            z-index: 0;
            user-select: none;
            animation: snowfall linear infinite;
        }

        @keyframes snowfall {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(105vh) rotate(360deg); opacity: 0; }
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        audio::-webkit-media-controls-panel {
            padding: 5px;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display {
            margin: 0 2px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Make sure app content is above the snow */
        #app-container {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center p-2 sm:p-4">
    
    <div id="snow-container"></div>

    <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 fixed top-4 right-4 z-50">
        <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
        <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707-.707a1 1 0 01-1.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707z"></path></svg>
    </button>

    <div id="app-container" class="w-full max-w-xl mx-auto text-center h-full">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center">
            <div id="name-entry-container">
                <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">Joel's Speaking Practice 07</h1>
                <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 text-center text-lg text-gray-900 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                <button id="start-with-name-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">Start</button>
            </div>
            <div id="topic-selection-container" class="hidden">
                 <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">Hello, <span id="user-name-display"></span>!</h1>
                 <div id="instructions" class="text-sm text-gray-600 dark:text-gray-400 mb-4 text-left space-y-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                     <p><i class="fas fa-bullhorn mr-2 text-indigo-500"></i>Try to speak until the time runs out. You can use the sentence starters and word bank for help.</p>
                     <p><i class="fas fa-download mr-2 text-blue-500"></i>After recording, download your answer and upload it. If the upload doesn't work, save the downloaded files.</p>
                     <p><i class="fas fa-award mr-2 text-yellow-500"></i>You must complete all 9 topics to get the Certificate of Completion as proof you finished the homework.</p>
                 </div>
                <div id="topic-selection" class="grid grid-cols-3 gap-4">
                    <!-- Topic buttons will be injected here -->
                </div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden bg-white dark:bg-gray-800 rounded-2xl shadow-lg app-shell p-3 sm:p-4">
            <header class="flex-shrink-0">
                <div class="flex justify-between items-center mb-1">
                    <button id="back-to-topics-btn" class="text-indigo-500 hover:text-indigo-700"><i class="fas fa-arrow-left mr-2"></i>Topics</button>
                </div>
                <!-- Timer Display -->
                <div class="relative w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-2 flex-shrink-0">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200 dark:text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="timer-progress" class="timer-circle text-indigo-500" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-2xl font-bold"></div>
                </div>
                <p id="phase-indicator" class="font-semibold text-indigo-500 dark:text-indigo-400 mb-2 text-base flex-shrink-0"></p>

                <!-- Question Display -->
                <div id="question-container" class="min-h-[50px] flex items-center justify-center mb-2">
                    <h2 id="question-text" class="text-base sm:text-lg font-semibold leading-relaxed text-left w-full"></h2>
                </div>
                
                <div id="error-message-box" class="hidden text-red-500 bg-red-100 dark:bg-red-900/50 p-2 rounded-lg text-sm mb-2"></div>

                <!-- Recording Action Buttons -->
                <div id="recording-actions-container" class="flex flex-col items-center justify-center mb-2">
                    <!-- Initial Record Button -->
                    <button id="record-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md transition-transform transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <!-- Stop Button -->
                    <button id="stop-record-btn" class="hidden bg-gray-700 hover:bg-gray-800 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md flex items-center justify-center">
                        <i class="fas fa-stop"></i>
                    </button>
                    <!-- Post-Recording Controls -->
                    <div id="post-recording-actions" class="hidden w-full flex-col items-center justify-center space-y-2 mt-2">
                        <audio id="audio-player" controls class="w-full max-w-xs"></audio>
                        <div class="flex items-center justify-center space-x-2 w-full max-w-xs">
                             <button id="download-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md transition-colors">
                                 <i class="fas fa-download mr-1"></i>Download
                             </button>
                            <a href="https://xichengacademy-my.sharepoint.com/:f:/g/personal/joelmitchell_xichengacademy_cn/EjxMFg8-baNEo5uuWUBc4EoBzn1DVWJ1Ym_NFx6hPlJ0dQ" target="_blank" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md">
                                 <i class="fas fa-upload mr-1"></i>Upload
                             </a>
                        </div>
                    </div>
                </div>
                 <div id="recording-status" class="hidden items-center justify-center text-red-500 font-semibold mb-1">
                     <div class="w-2 h-2 bg-red-500 rounded-full mr-2 recording-indicator"></div>
                     Recording...
                 </div>
            </header>
            
            <main class="flex-grow flex flex-col overflow-y-auto min-h-0 space-y-2 pt-2">
                 <!-- Sentence Starters -->
                <div id="starters-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Sentence Starters</h3>
                    <div id="starters-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Word Bank -->
                <div id="word-bank-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Word Bank</h3>
                    <div id="word-bank-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Sample Answers Display -->
                <div id="samples-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center flex-shrink-0">Sample Responses</h3>
                    <ul id="samples-list" class="space-y-2 list-disc list-inside bg-indigo-900/70 dark:bg-indigo-900/90 p-3 rounded-lg max-h-28 sm:max-h-32 overflow-y-auto">
                    </ul>
                </div>
            </main>

            <footer class="flex-shrink-0 mt-2">
                <!-- Next Button -->
                <div id="controls-container">
                     <button id="next-btn" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg text-lg shadow-md">Next</button>
                </div>
            </footer>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center">
            <div id="certificate-to-download" class="w-full bg-gray-50 dark:bg-gray-700 p-8 rounded-lg border-4 border-yellow-400 dark:border-yellow-500 text-center">
                <i class="fas fa-award text-6xl text-yellow-500 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Certificate of Completion</h1>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">This certificate is awarded to</p>
                <p id="certificate-name" class="text-4xl font-bold my-4 text-indigo-600 dark:text-indigo-400"></p>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">for successfully completing all 9 speaking practice topics.</p>
                <p class="text-sm mt-6 text-gray-500 dark:text-gray-400">Issued on: <span id="certificate-date"></span></p>
            </div>
            <button id="download-certificate-btn" class="mt-6 w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">
                <i class="fas fa-download mr-2"></i>Download Certificate
            </button>
             <button id="back-to-main-menu-btn" class="mt-3 text-sm text-indigo-500 hover:underline">Back to Main Menu</button>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA: Questions and Sample Answers for Part 07 ---
        const practiceData = {
            "Cities vs. Countryside": [
                {
                    question: "Do you prefer living in a big city or in the countryside? Why?",
                    starters: ["I prefer living in a big city because...", "For me, the countryside is better since...", "I think both have advantages, but I prefer...", "I like the energy of..."],
                    wordBank: ["exciting", "convenient", "peaceful", "quiet", "nature", "amenities", "crowded", "fresh air", "opportunities"],
                    samples: [
                        "I prefer living in a big city like Beijing because there are so many things to do, like visiting museums and going to concerts.",
                        "For me, the countryside is better because it is more peaceful and the air is much cleaner than in a big city.",
                        "I like the convenience of a city. For example, you can get food delivered at any time and public transportation is everywhere."
                    ]
                },
                {
                    question: "What is something you enjoy about nature?",
                    starters: ["I really enjoy...", "Something I love about nature is...", "When I'm in nature, I like to...", "Nature makes me feel..."],
                    wordBank: ["hiking", "mountains", "forests", "ocean", "calm", "fresh air", "beautiful scenery", "relaxing", "animals"],
                    samples: [
                        "I really enjoy hiking in the mountains because the views from the top are always incredible and it's great exercise.",
                        "Something I love about nature is the sound of a forest. It's very calm and helps me to forget about my stress from school.",
                        "When I'm near the ocean, I love watching the sunset. The colors in the sky are so beautiful and it makes me feel very peaceful."
                    ]
                }
            ],
            "Holidays & Vacations": [
                {
                    question: "What is the best vacation you have ever taken?",
                    starters: ["The best vacation I ever had was when...", "I'll never forget my trip to...", "One time, my family and I went to...", "My most memorable trip was..."],
                    wordBank: ["beach", "mountains", "different city", "foreign country", "memorable", "relaxing", "adventure", "family trip", "delicious food"],
                    samples: [
                        "The best vacation I ever took was a trip to the beach in Sanya with my family, because I loved swimming in the ocean and playing in the sand.",
                        "My most memorable trip was when we visited the city of Xi'an. I loved seeing the Terracotta Warriors because it felt like stepping back in time.",
                        "One time, we went on a trip to the mountains. It was great because we went hiking every day and saw some beautiful waterfalls."
                    ]
                },
                {
                    question: "Describe your dream vacation. Where would you go and what would you do?",
                    starters: ["My dream vacation would be a trip to...", "If I could go anywhere, I would go to...", "I would love to... and...", "The perfect vacation for me is..."],
                    wordBank: ["explore", "relax on a beach", "visit historical sites", "try new foods", "adventure", "culture", "scenery", "dream destination"],
                    samples: [
                        "My dream vacation would be a trip to Switzerland, because I want to see the beautiful Alps and go hiking in the mountains.",
                        "If I could go anywhere, I would travel to Egypt because I am fascinated by ancient history and I would love to see the pyramids and the Sphinx.",
                        "The perfect vacation for me would be to visit Japan. I would explore the busy city of Tokyo and also relax in the peaceful temples of Kyoto."
                    ]
                }
            ],
            "Technology Habits": [
                {
                    question: "How much time do you spend on your phone every day? What do you usually do?",
                    starters: ["I probably spend about... hours on my phone.", "I use my phone mostly for...", "To be honest, I spend too much time...", "My main activities on my phone are..."],
                    wordBank: ["social media", "chatting", "playing games", "watching videos", "listening to music", "too much", "a few hours", "useful tool"],
                    samples: [
                        "I probably spend about three hours on my phone each day. I mostly use it for chatting with my friends on WeChat and watching short videos on Douyin.",
                        "I try to limit my phone time, but I use it a lot for school, for example, to look up words in the dictionary or to check homework assignments.",
                        "To be honest, I spend too much time playing games on my phone. It's a fun way to relax, but sometimes I should be studying instead."
                    ]
                },
                {
                    question: "Do you think technology makes people feel more connected or more lonely? Why?",
                    starters: ["I think technology makes people more...", "On one hand, it helps us connect, but on the other hand...", "It can be both, for example...", "In my opinion, it depends on how you use it because..."],
                    wordBank: ["connected", "lonely", "communicate easily", "less face-to-face interaction", "superficial", "stay in touch", "isolating", "balance"],
                    samples: [
                        "I think technology makes people more connected because you can easily talk to friends and family who live far away through video calls.",
                        "On the other hand, it can make people feel more lonely because they spend more time looking at a screen than having real, face-to-face conversations.",
                        "In my opinion, it depends on how you use it. If you use it to organize meeting up with friends, it's good. But if you only interact online, it can be isolating."
                    ]
                }
            ],
            "Early Memories": [
                {
                    question: "What is your earliest memory from when you were a very young child?",
                    starters: ["My earliest memory is...", "I vaguely remember when...", "The first thing I can remember is...", "I think my earliest memory is from when I was..."],
                    wordBank: ["kindergarten", "playing with a toy", "a family event", "a specific feeling", "vague memory", "clear memory", "happy", "funny"],
                    samples: [
                        "My earliest memory is from my first day of kindergarten. I remember crying because I didn't want my mom to leave, but my teacher gave me a toy to play with.",
                        "I have a vague memory of my third birthday party. I remember there was a big cake with candles and all my relatives were singing to me.",
                        "The first thing I can clearly remember is playing with my favorite toy car in our old apartment. I remember the color of the car and the pattern on the floor."
                    ]
                },
                {
                    question: "Describe a happy memory you have with your grandparents.",
                    starters: ["I have a very happy memory of...", "I remember my grandpa used to...", "My grandma and I always...", "One time, my grandparents..."],
                    wordBank: ["telling stories", "cooking together", "playing games", "visiting their home", "patient", "kind", "special treat", "unconditional love"],
                    samples: [
                        "I have a happy memory of my grandmother teaching me how to make dumplings. Her hands moved so fast, and she was very patient with me.",
                        "I remember my grandfather used to take me to the park every afternoon. He would buy me my favorite ice cream and tell me stories about when he was young.",
                        "One time, my grandparents took me to the Beijing Zoo. It was a very special day because it was the first time I saw a real panda."
                    ]
                }
            ],
            "Favorites": [
                {
                    question: "What is your favorite color, and why do you like it?",
                    starters: ["My favorite color is... because...", "I've always liked the color...", "I like... the most since...", "The color I prefer is..."],
                    wordBank: ["blue", "green", "red", "yellow", "calming", "energetic", "bright", "nature", "sky", "passion"],
                    samples: [
                        "My favorite color is blue because it reminds me of the clear sky and the ocean, and it makes me feel calm and peaceful.",
                        "I like the color green the most, because it is the color of nature, like trees and grass, and I find it very relaxing to look at.",
                        "I've always liked the color red because in Chinese culture it symbolizes good luck and happiness. It's also a very bold and energetic color."
                    ]
                },
                {
                    question: "If you had a superpower, what would it be and why?",
                    starters: ["If I had a superpower, I would want to...", "The superpower I would choose is... because...", "I think... would be the most useful power.", "I would love to be able to..."],
                    wordBank: ["fly", "be invisible", "teleport", "read minds", "super strength", "save time", "explore the world", "help people", "fun"],
                    samples: [
                        "If I had a superpower, I would want to be able to fly. It would be amazing to see the world from above the clouds and travel anywhere I want for free.",
                        "The superpower I would choose is teleportation because I could save so much time. For example, I could get to school in an instant and never be late.",
                        "I think being able to speak and understand every language would be the most useful superpower, because I could communicate with anyone in the world."
                    ]
                }
            ],
            "Future & Jobs": [
                {
                    question: "What kind of job do you think you would enjoy in the future?",
                    starters: ["In the future, I think I would enjoy being a...", "I'm interested in a career in...", "A job that seems interesting to me is...", "I'm not sure yet, but I think something related to..."],
                    wordBank: ["engineer", "doctor", "designer", "scientist", "programmer", "helping people", "creative", "problem-solving", "challenging"],
                    samples: [
                        "I think I would enjoy being an engineer because I like understanding how things work and using science to design and build new things.",
                        "I'm interested in a career as a graphic designer because I love drawing and being creative, and I enjoy using computers to make art.",
                        "A job that seems interesting to me is being a doctor, because I want to be able to help people who are sick and make a positive difference in their lives."
                    ]
                },
                {
                    question: "Do you think it's more important to have a job that pays a lot of money or a job that you love?",
                    starters: ["I think it's more important to... because...", "In my opinion, a job you love is better since...", "While money is important, I believe...", "I would rather have a... job."],
                    wordBank: ["job satisfaction", "high salary", "passion", "happiness", "financial security", "stressful", "fulfilling", "balance", "motivation"],
                    samples: [
                        "I think it's more important to have a job that you love, because you spend so much of your life working, and it would be terrible to do something you hate every day.",
                        "While having a high salary is nice, I believe job satisfaction is more important for long-term happiness and motivation.",
                        "In my opinion, the best situation is to find a balance. It's important to earn enough money to live comfortably, but you should also find your work interesting and fulfilling."
                    ]
                }
            ],
            "Helpfulness": [
                {
                    question: "Describe a time you helped someone.",
                    starters: ["I remember one time when...", "Once, I helped my friend to...", "A time I was helpful was when...", "I felt good after I helped..."],
                    wordBank: ["helped a classmate", "helped my parents", "helped an elderly person", "explained something", "carried something heavy", "simple act of kindness", "felt good"],
                    samples: [
                        "I remember one time I helped a classmate who was struggling with a math problem. I explained it to them step-by-step until they understood it.",
                        "Once, I saw an elderly woman carrying heavy bags of groceries, so I offered to help her carry them to her apartment building.",
                        "A time I was helpful was when my mom was very busy cooking for a family dinner, so I helped her by washing all the vegetables and setting the table."
                    ]
                },
                {
                    question: "Why do you think it is important to help others?",
                    starters: ["I think it's important to help others because...", "Helping people is important since...", "It makes the world a better place when...", "When we help others, it..."],
                    wordBank: ["kindness", "community", "empathy", "makes you feel good", "stronger society", "we all need help sometimes", "compassion", "support"],
                    samples: [
                        "I think it's important to help others because it builds a stronger and kinder community. When people help each other, everyone feels more supported.",
                        "Helping people is important because we all need help sometimes. If I help someone today, maybe someone will be there to help me when I need it in the future.",
                        "It's important because even a small act of kindness can make a big difference in someone's day and make them feel happy."
                    ]
                }
            ],
            "Gifts": [
                {
                    question: "What is the best gift you have ever given to someone?",
                    starters: ["The best gift I ever gave was...", "I once gave my... a...", "I was really proud of the gift I gave because...", "I put a lot of thought into..."],
                    wordBank: ["thoughtful", "handmade", "surprise", "perfect gift", "made them happy", "personal", "exactly what they wanted", "special"],
                    samples: [
                        "The best gift I ever gave was a handmade scrapbook for my best friend's birthday. I filled it with photos of us, and she was really happy.",
                        "I once saved up my money to buy my mom a scarf she really wanted. She was so surprised and happy, and that made me feel great.",
                        "I think the best gift I gave was a book to my dad. It was by his favorite author, and it was a special edition. He was very happy because it showed I paid attention to his interests."
                    ]
                },
                {
                    question: "Do you prefer giving gifts or receiving gifts? Why?",
                    starters: ["I prefer giving gifts because...", "I think receiving gifts is better since...", "I enjoy both, but I slightly prefer...", "For me, the best part is..."],
                    wordBank: ["the joy of giving", "seeing someone happy", "thoughtful", "surprise", "generosity", "makes me feel good", "appreciation"],
                    samples: [
                        "I prefer giving gifts because I love the feeling of making someone else happy. Seeing the smile on their face is the best reward.",
                        "I think I prefer giving gifts because I enjoy the process of thinking about the perfect present for someone, which shows how much I care about them.",
                        "Of course, it's nice to receive gifts, but I think giving them is more satisfying. It feels good to be generous and to do something nice for another person."
                    ]
                }
            ],
            "Environment": [
                {
                    question: "What is one thing you do in your daily life to help the environment?",
                    starters: ["One thing I always do is...", "To help the environment, I try to...", "My family and I are careful about...", "A small habit I have is..."],
                    wordBank: ["recycling", "saving water", "turning off lights", "using less plastic", "reusable bag", "public transport", "reduce waste", "small change"],
                    samples: [
                        "One thing I always do is turn off the lights when I leave a room, because it's a very simple way to save electricity.",
                        "To help the environment, my family and I always bring our own reusable bags when we go shopping, so we don't need to use plastic bags.",
                        "I try to save water in my daily life. For example, I turn off the tap when I am brushing my teeth."
                    ]
                },
                {
                    question: "Why do you think it is important for young people to care about the environment?",
                    starters: ["It's important because...", "Young people should care since...", "The future of our planet depends on...", "We need to protect the environment because..."],
                    wordBank: ["our future", "protect the planet", "future generations", "sustainability", "climate change", "responsibility", "consequences", "healthy planet"],
                    samples: [
                        "It's important because this is the planet we will live on in the future. The actions we take now will affect our lives when we are adults.",
                        "Young people should care because we can build good habits, like recycling, from an early age and inspire our parents and others to do the same.",
                        "We need to protect the environment for future generations. If we don't take care of our planet, our children won't have a healthy world to live in."
                    ]
                }
            ]
        };


        // --- DOM Elements ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const welcomeScreen = document.getElementById('welcome-screen');
        const practiceScreen = document.getElementById('practice-screen');
        const nameEntryContainer = document.getElementById('name-entry-container');
        const nameInput = document.getElementById('name-input');
        const startWithNameBtn = document.getElementById('start-with-name-btn');
        const topicSelectionContainer = document.getElementById('topic-selection-container');
        const userNameDisplay = document.getElementById('user-name-display');
        const topicSelection = document.getElementById('topic-selection');
        const nextBtn = document.getElementById('next-btn');
        const backToTopicsBtn = document.getElementById('back-to-topics-btn');
        
        const timerDisplay = document.getElementById('timer-display');
        const timerProgress = document.getElementById('timer-progress');
        const phaseIndicator = document.getElementById('phase-indicator');
        
        const questionContainer = document.getElementById('question-container');
        const questionText = document.getElementById('question-text');
        const samplesContainer = document.getElementById('samples-container');
        const samplesList = document.getElementById('samples-list');
        const startersContainer = document.getElementById('starters-container');
        const startersList = document.getElementById('starters-list');
        const wordBankContainer = document.getElementById('word-bank-container');
        const wordBankList = document.getElementById('word-bank-list');
        const errorMessagebox = document.getElementById('error-message-box');

        const recordBtn = document.getElementById('record-btn');
        const stopRecordBtn = document.getElementById('stop-record-btn');
        const audioPlayer = document.getElementById('audio-player');
        const recordingStatus = document.getElementById('recording-status');
        const postRecordingActions = document.getElementById('post-recording-actions');
        const downloadBtn = document.getElementById('download-btn');
        
        // Certificate UI
        const certificateScreen = document.getElementById('certificate-screen');
        const downloadCertificateBtn = document.getElementById('download-certificate-btn');
        const backToMainMenuBtn = document.getElementById('back-to-main-menu-btn');


        // --- State Variables ---
        let userName = '';
        let currentQuestionIndex = 0;
        let currentQuestions = [];
        let timerInterval;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;
        let completedTopics = {};
        let speechRecognition;
        let finalTranscript = '';

        const FULL_DASH_ARRAY = 283;
        const DEFAULT_RESPONSE_TIME = 60;
        const READ_TIME = 60;

        // --- Text-to-Speech ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;
        let ttsInitialized = false;

        function initializeTTS() {
            return new Promise((resolve) => {
                if (!synth) {
                    ttsInitialized = true;
                    return resolve();
                }

                const setBestVoice = () => {
                    const voices = synth.getVoices();
                    if (voices.length === 0) return;
                    
                    const scoreVoice = (voice) => {
                        let score = 0;
                        const name = voice.name.toLowerCase();
                        if (name.includes('natural')) score += 5;
                        if (name.includes('brian') || name.includes('emma')) score += 4;
                        if (name.includes('microsoft')) score += 3;
                        if (name.includes('google')) score += 2;
                        if (voice.localService) score += 1;
                        return score;
                    };

                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    if (englishVoices.length > 0) {
                        englishVoices.sort((a, b) => scoreVoice(b) - scoreVoice(a));
                        preferredVoice = englishVoices[0];
                    }
                    
                    ttsInitialized = true;
                    resolve();
                };

                if (synth.getVoices().length > 0) {
                    setBestVoice();
                } else {
                    synth.onvoiceschanged = setBestVoice;
                }
            });
        }

        function speak(text, isFeedback = false) {
            if (!ttsInitialized) return;
            try {
                if (synth.speaking) synth.cancel();
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.onerror = (event) => console.error('SpeechSynthesisUtterance.onerror', event);
                if (preferredVoice) utterThis.voice = preferredVoice;
                utterThis.pitch = 1;  
                utterThis.rate = 0.85; // Slow down speech as requested
                synth.speak(utterThis);
            } catch (e) {
                console.error("Speech synthesis failed:", e);
            }
        }

        // --- Local Storage ---
        function loadProgress() {
            const savedCompletedTopics = localStorage.getItem('languagePracticeCompletedTopics');
            if (savedCompletedTopics) {
                try {
                    const parsed = JSON.parse(savedCompletedTopics);
                    // Basic validation to ensure it's an object
                    if (typeof parsed === 'object' && parsed !== null) {
                       completedTopics = parsed;
                    } else {
                        completedTopics = {};
                    }
                } catch (e) {
                    console.error("Failed to parse saved progress:", e);
                    completedTopics = {}; // Reset progress if data is corrupt
                }
            }
            const savedName = localStorage.getItem('languagePracticeUserName');
            if (savedName) {
                 userName = savedName;
                 nameInput.value = userName;
            }
        }

        function saveProgress() {
            localStorage.setItem('languagePracticeCompletedTopics', JSON.stringify(completedTopics));
            if(userName) localStorage.setItem('languagePracticeUserName', userName);
        }

        // --- UI Initialization ---
        function initializeTopics() {
            topicSelection.innerHTML = '';
            for (const topic in practiceData) {
                const button = document.createElement('button');
                
                let checkmark = '';
                if (completedTopics && completedTopics[topic]) {
                    checkmark = `<i class="fas fa-check-circle text-green-500 ml-2"></i>`;
                    button.className = "w-full bg-green-100 dark:bg-green-900/50 p-2 rounded-lg shadow-md hover:bg-green-200 dark:hover:bg-green-800/60 transition-colors flex items-center justify-center";
                } else {
                    button.className = "w-full bg-white dark:bg-gray-700 p-2 rounded-lg shadow-md hover:bg-indigo-100 dark:hover:bg-indigo-800 transition-all transform hover:scale-105 flex items-center justify-center";
                }

                button.innerHTML = `<span class="text-sm font-semibold">${topic}</span> ${checkmark}`;
                button.dataset.topic = topic;
                button.addEventListener('click', () => startPractice(topic));
                topicSelection.appendChild(button);
            }
        }

        // --- Core App Logic ---
        function startPractice(topic) {
            currentQuestions = practiceData[topic];
            currentQuestions.topicName = topic;
            currentQuestionIndex = 0;
            welcomeScreen.classList.add('hidden');
            practiceScreen.classList.remove('hidden');
            certificateScreen.classList.add('hidden');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                phaseIndicator.textContent = "Topic Complete!";
                questionText.textContent = "You've finished this topic. Well done!";
                completedTopics[currentQuestions.topicName] = true;
                saveProgress();
                checkAllTopicsCompleted();
                resetRecordingUI();
                nextBtn.classList.add('hidden');
                speak("You've completed this topic! Well done.");
                return;
            }

            const item = currentQuestions[currentQuestionIndex];
            resetUIForNewQuestion();
            
            let fullQuestion = (item.intro ? item.intro + " " : "") + item.question;
            questionText.textContent = fullQuestion;
            questionText.classList.add('fade-in');
            setTimeout(() => questionText.classList.remove('fade-in'), 500);

            speak(fullQuestion);
            
            // Populate Sentence Starters
            if (item.starters && item.starters.length > 0) {
                startersList.innerHTML = '';
                item.starters.forEach(starter => {
                    const button = document.createElement('button');
                    button.className = 'bg-indigo-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-indigo-600 dark:text-white cursor-default';
                    button.textContent = starter;
                    startersList.appendChild(button);
                });
                startersContainer.classList.remove('hidden');
            }

            // Populate Word Bank
            if (item.wordBank && item.wordBank.length > 0) {
                wordBankList.innerHTML = '';
                item.wordBank.forEach(word => {
                    const button = document.createElement('button');
                    button.className = 'bg-green-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-green-600 dark:text-white cursor-default';
                    button.textContent = word;
                    wordBankList.appendChild(button);
                });
                wordBankContainer.classList.remove('hidden');
            }

            const responseTime = item.timer || DEFAULT_RESPONSE_TIME;
            phaseIndicator.textContent = `Prepare & Record (Question ${currentQuestionIndex + 1} of ${currentQuestions.length})`;
            startTimer(responseTime, showSampleAnswersAndStartReadTimer);
        }

        function showSampleAnswersAndStartReadTimer() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
            
            phaseIndicator.textContent = "Review";
            recordBtn.disabled = true;
            recordBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const item = currentQuestions[currentQuestionIndex];
            if (item.samples && item.samples.length > 0) {
                samplesList.innerHTML = '';
                item.samples.forEach(sample => {
                    const li = document.createElement('li');
                    li.textContent = sample;
                    // Changed to white text as requested
                    li.className = 'text-white text-sm sm:text-base';
                    samplesList.appendChild(li);
                });
                samplesContainer.classList.remove('hidden');
            }


            startTimer(READ_TIME, () => {
                phaseIndicator.textContent = "Time's up!";
                nextBtn.classList.remove('hidden');
            });
        }
        
        // --- Certificate Logic ---
        function checkAllTopicsCompleted() {
            const totalTopics = Object.keys(practiceData).length;
            const completedCount = Object.keys(completedTopics).length;
            if (completedCount === totalTopics) {
                showCertificate();
            }
        }
        
        function showCertificate() {
            practiceScreen.classList.add('hidden');
            welcomeScreen.classList.add('hidden');
            certificateScreen.classList.remove('hidden');
            document.getElementById('certificate-name').textContent = userName;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
        }
        
        function showErrorMessage(message) {
            errorMessagebox.textContent = message;
            errorMessagebox.classList.remove('hidden');
            setTimeout(() => {
                errorMessagebox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        // --- Recording & Transcription Logic ---
        async function startRecording() {
            if (!window.MediaRecorder) {
                showErrorMessage("Audio recording is not supported on this browser.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const isEdge = window.navigator.userAgent.includes("Edg");
                let options = {};
                if (!isEdge) {
                    const mimeTypes = ['audio/webm;codecs=opus', 'audio/ogg;codecs=opus', 'audio/webm', 'audio/ogg'];
                    const supportedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
                    if (supportedType) options.mimeType = supportedType;
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.start();
                startTranscription();

                recordBtn.classList.add('hidden');
                stopRecordBtn.classList.remove('hidden');
                recordingStatus.classList.remove('hidden');

                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    recordedBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedBlob);
                    audioPlayer.src = audioUrl;
                    postRecordingActions.classList.remove('hidden');
                    recordingStatus.classList.add('hidden');
                    stopRecordBtn.classList.add('hidden');
                    recordBtn.classList.add('hidden');
                });
            } catch (err) {
                console.error("Error starting recording:", err);
                showErrorMessage("Could not start audio recording. Please grant microphone permission.");
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
            if (speechRecognition) {
                speechRecognition.stop();
            }
        }

        function startTranscription() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("Speech recognition not supported.");
                return;
            }

            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';
            finalTranscript = '';

            speechRecognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
            };
            
            speechRecognition.onerror = (event) => {
                 console.error('Speech recognition error detected: ' + event.error);
            }

            speechRecognition.start();
        }

        // --- Timer Functions ---
        function startTimer(duration, onEndCallback) {
            let timeLeft = duration;
            clearInterval(timerInterval);
            updateTimerDisplay(timeLeft, duration);

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft, duration);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if(onEndCallback) onEndCallback();
                }
            }, 1000);
        }

        function updateTimerDisplay(timeLeft, totalDuration) {
            const minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            if (seconds < 10) seconds = `0${seconds}`;
            timerDisplay.textContent = `${minutes}:${seconds}`;
            
            const fraction = timeLeft / totalDuration;
            const offset = fraction * FULL_DASH_ARRAY;
            timerProgress.style.strokeDashoffset = FULL_DASH_ARRAY - offset;
        }

        // --- UI Helper Functions ---
        function resetUIForNewQuestion() {
            samplesContainer.classList.add('hidden');
            startersContainer.classList.add('hidden');
            wordBankContainer.classList.add('hidden');
            nextBtn.classList.add('hidden');
            errorMessagebox.classList.add('hidden');
            recordBtn.disabled = false;
            recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            resetRecordingUI();
        }

        function resetRecordingUI() {
            recordBtn.classList.remove('hidden');
            stopRecordBtn.classList.add('hidden');
            recordingStatus.classList.add('hidden');
            postRecordingActions.classList.add('hidden');
            audioPlayer.src = '';
            audioChunks = [];
            recordedBlob = null;
            finalTranscript = '';
        }

        // --- Theme Toggle Logic ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        };
        
        // --- Snowfall Logic ---
        function createSnow() {
            const snowContainer = document.getElementById('snow-container');
            const snowflakeCount = 50;
            for (let i = 0; i < snowflakeCount; i++) {
                let snowflake = document.createElement('div');
                snowflake.innerHTML = '❄';
                snowflake.classList.add('snowflake');
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.animationDuration = Math.random() * 5 + 5 + 's'; // 5-10 seconds
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                snowflake.style.fontSize = Math.random() * 1.5 + 0.5 + 'em';
                snowflake.style.opacity = Math.random();
                snowContainer.appendChild(snowflake);
            }
        }


        // --- Event Listeners ---
        startWithNameBtn.addEventListener('click', () => {
            userName = nameInput.value.trim();
            if (userName) {
                saveProgress();
                nameEntryContainer.classList.add('hidden');
                userNameDisplay.textContent = userName;
                topicSelectionContainer.classList.remove('hidden');
            } else {
                // Using a custom message box instead of alert()
                const nameError = document.createElement('div');
                nameError.textContent = "Please enter your name.";
                nameError.className = "text-red-500 text-sm mt-2";
                startWithNameBtn.insertAdjacentElement('afterend', nameError);
                setTimeout(() => nameError.remove(), 2000);
            }
        });

        recordBtn.addEventListener('click', startRecording);
        stopRecordBtn.addEventListener('click', stopRecording);
        
        downloadCertificateBtn.addEventListener('click', () => {
            const certificateNode = document.getElementById('certificate-to-download');
            html2canvas(certificateNode, { scale: 2 }).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = `Certificate_of_Completion_${userName.replace(/\s+/g, '_')}.png`;
                a.click();
            });
        });

        backToMainMenuBtn.addEventListener('click', () => {
            certificateScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            initializeTopics();
        });

        downloadBtn.addEventListener('click', () => {
            if (recordedBlob) {
                const topicName = currentQuestions.topicName.replace(/\s+/g, '_');
                const sanitizedUserName = userName.replace(/\s+/g, '_');
                const fileName = `${sanitizedUserName}_${topicName}_Q${currentQuestionIndex + 1}.webm`;
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = URL.createObjectURL(recordedBlob);
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // Visual feedback
                const originalText = downloadBtn.innerHTML;
                downloadBtn.innerHTML = `<i class="fas fa-check mr-1"></i>Downloaded!`;
                downloadBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                downloadBtn.classList.add('bg-green-600');
                setTimeout(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.classList.remove('bg-green-600');
                    downloadBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
            }
        });

        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            showQuestion();
        });

        backToTopicsBtn.addEventListener('click', () => {
            practiceScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            clearInterval(timerInterval);
            initializeTopics();
        });
        
        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
            applyTheme(isDark ? 'dark' : 'light');
        });

        // --- Initial Load ---
        async function main() {
            // Set initial theme
            const savedTheme = localStorage.getItem('color-theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                // If no theme saved, use system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    applyTheme('dark');
                } else {
                    applyTheme('light');
                }
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !SpeechRecognition) {
                recordBtn.disabled = true;
                recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                recordBtn.title = "Audio recording or recognition is not supported on this browser.";
            }
            if (!window.speechSynthesis) {
                 console.warn("Text-to-speech is not supported on this browser.");
            }
            
            await initializeTTS().catch(err => console.error(err));
            
            createSnow();
            loadProgress();
            initializeTopics();
        }
        
        main();
    });
    </script>
</body>
</html>
