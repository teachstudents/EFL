<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synonym Galaxy Challenge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --space-dark: #0D0D2B;
            --space-mid: #1D1D4A;
            --space-light: #2C2C6A;
            --primary-glow: #00E5FF;
            --secondary-glow: #FF00FF;
            --glass-bg: rgba(29, 29, 74, 0.85);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background: var(--space-dark);
            color: #E0E0E0;
            overflow: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* --- BACKGROUND EFFECTS --- */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: black;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: move linear infinite;
        }

        @keyframes move {
            from { transform: translateY(0px); }
            to { transform: translateY(-2000px); }
        }

        /* --- LAYOUT --- */
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
            position: relative;
            z-index: 10;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER & PROGRESS (NOW AT BOTTOM) --- */
        .game-progress {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 0 0; /* Rounded top corners */
            padding: 0.5rem 2rem;
            border-top: 2px solid var(--primary-glow);
            box-shadow: 0 -5px 20px rgba(0, 229, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto; /* Pushes to bottom */
            height: 100px;
        }

        .header-team-score {
            text-align: center;
            font-size: 1.5rem;
            color: var(--secondary-glow);
            text-shadow: 0 0 10px var(--secondary-glow);
        }
        
        .header-team-score span {
            font-size: 0.9rem;
            color: #fff;
            display: block;
            margin-bottom: 5px;
        }

        .round-info {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* --- GAMEPLAY AREA --- */
        .game-play {
            display: none;
            flex-grow: 1;
            flex-direction: column;
            justify-content: center; /* Centered vertically */
            padding-bottom: 20px;
            height: calc(100vh - 120px); /* Adjust for footer height */
        }

        .battle-arena {
            display: flex;
            justify-content: center;
            gap: 2rem;
            align-items: stretch;
            height: 100%;
        }

        .versus-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 900;
            color: var(--secondary-glow);
            text-shadow: 0 0 20px var(--secondary-glow);
            width: 60px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.7; transform: scale(1); } }

        /* --- PLAYER CARD --- */
        .player-card {
            flex: 1;
            background: var(--glass-bg);
            border: 2px solid var(--primary-glow);
            border-radius: 20px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .player-card.active-turn {
            box-shadow: 0 0 40px rgba(0, 229, 255, 0.3);
            border-color: #fff;
        }

        /* Top Section: Question & Answers */
        .question-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .target-word-container {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .target-word {
            font-size: clamp(1.5rem, 4vw, 3rem); /* Responsive sizing */
            text-align: center;
            color: #fff;
            text-transform: uppercase;
            text-shadow: 0 0 20px var(--secondary-glow);
            letter-spacing: 2px;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.2;
            width: 100%;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .answer-btn {
            background: linear-gradient(90deg, rgba(0, 229, 255, 0.1), rgba(0, 229, 255, 0.2));
            border: 1px solid var(--primary-glow);
            color: white;
            padding: 1.2rem;
            font-size: 1.4rem;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
            text-transform: capitalize;
            position: relative;
            overflow: hidden;
        }

        .answer-btn:hover {
            background: var(--primary-glow);
            color: black;
            transform: scale(1.02);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .answer-btn.correct { background: #00ff00; color: black; border-color: #00ff00; box-shadow: 0 0 30px #00ff00; }
        .answer-btn.incorrect { background: #ff0000; color: white; border-color: #ff0000; box-shadow: 0 0 30px #ff0000; }
        .answer-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* Bottom Section: Player Info */
        .player-info-footer {
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 1rem;
            margin-top: auto;
        }

        .player-details {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        .player-identity {
            text-align: left;
            flex: 1;
        }

        .player-score-area {
            text-align: right;
            min-width: 100px;
        }

        .player-name-display {
            font-size: 1.2rem;
            color: var(--primary-glow);
            font-weight: bold;
            margin-bottom: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }
        
        .english-name-display {
            font-size: 0.9rem;
            color: #00ff00; /* Light green for contrast */
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 2px;
        }

        .player-stats {
            font-size: 0.9rem;
            color: #aaa;
        }

        .round-score {
            font-size: 2.2rem;
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            line-height: 1;
        }

        /* Timer Bar within Player Card */
        .local-timer-container {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .local-timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            width: 100%;
            transform-origin: left;
            transition: width 0.1s linear;
        }

        /* --- MODES & SETUP --- */
        .centered-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
            z-index: 50;
        }

        .mode-btn {
            background: transparent;
            border: 2px solid var(--primary-glow);
            color: var(--primary-glow);
            padding: 1rem 3rem;
            font-size: 1.5rem;
            margin: 1rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            transition: 0.3s;
            text-shadow: 0 0 5px var(--primary-glow);
            box-shadow: 0 0 10px var(--primary-glow) inset;
        }

        .mode-btn:hover {
            background: var(--primary-glow);
            color: var(--space-dark);
            box-shadow: 0 0 30px var(--primary-glow);
        }

        /* --- CHAMPIONSHIP MODAL --- */
        .championship-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .trophy-icon { font-size: 5rem; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        /* --- EFFECTS --- */
        .particle { position: absolute; pointer-events: none; }
        .correct-reveal-text {
            height: 20px;
            text-align: center;
            color: #00ff00;
            font-size: 0.9rem;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .correct-reveal-text.show { opacity: 1; }

    </style>
</head>
<body>

    <div id="starfield"></div>

    <div class="game-container">
        
        <!-- MAIN MENU -->
        <div id="mainMenu" class="centered-menu">
            <h1 style="font-size: 4rem; margin-bottom: 2rem; color: var(--primary-glow); text-shadow: 0 0 20px var(--primary-glow);">SYNONYM GALAXY</h1>
            <button class="mode-btn" onclick="startGame(10)">Grade 10</button>
            <button class="mode-btn" onclick="startGame(11)">Grade 11</button>
            <button class="mode-btn" onclick="startGame(12)">Grade 12</button>
        </div>

        <!-- TEAM SETUP (Hidden) -->
        <div id="teamSetup" class="centered-menu" style="display:none;">
            <h2 style="font-size: 2.5rem; margin-bottom: 2rem; color: #fff;">GENERATING TEAMS...</h2>
            <div style="display: flex; gap: 2rem; justify-content: center;">
                <div style="background: rgba(0,0,0,0.5); padding: 2rem; border: 1px solid var(--primary-glow); border-radius: 10px;">
                    <h3 id="setupTeam1Name" style="color: var(--primary-glow);">Team 1</h3>
                    <div id="setupTeam1List" style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;"></div>
                </div>
                <div style="background: rgba(0,0,0,0.5); padding: 2rem; border: 1px solid var(--secondary-glow); border-radius: 10px;">
                    <h3 id="setupTeam2Name" style="color: var(--secondary-glow);">Team 2</h3>
                    <div id="setupTeam2List" style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;"></div>
                </div>
            </div>
        </div>

        <!-- NEXT MATCHUP / SELECTION SCREEN -->
        <div id="matchupScreen" class="centered-menu" style="display:none;">
            <h2 style="font-size: 2rem; margin-bottom: 2rem;">NEXT BATTLE</h2>
            <div style="display: flex; gap: 4rem; align-items: center; justify-content: center; margin-bottom: 2rem;">
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; color: var(--primary-glow);" id="matchupTeam1">Team 1</div>
                    <div style="font-size: 2rem; font-weight: bold;" id="matchupPlayer1">Selecting...</div>
                </div>
                <div style="font-size: 3rem; color: #555;">VS</div>
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; color: var(--secondary-glow);" id="matchupTeam2">Team 2</div>
                    <div style="font-size: 2rem; font-weight: bold;" id="matchupPlayer2">Selecting...</div>
                </div>
            </div>
            <div id="countdown" style="font-size: 3rem; color: var(--primary-glow);">5</div>
        </div>

        <!-- GAMEPLAY ARENA -->
        <div id="gamePlay" class="game-play">
            <div class="battle-arena">
                <!-- Player 1 Card -->
                <div class="player-card" id="cardP1">
                    <div class="question-section">
                        <div class="target-word-container">
                             <div class="target-word" id="targetWord1">WORD</div>
                        </div>
                        <div class="answers-grid" id="answers1">
                            <!-- Buttons injected here -->
                        </div>
                        <div class="correct-reveal-text" id="reveal1">Answer</div>
                    </div>
                    <div class="player-info-footer">
                        <div class="player-details">
                            <div class="player-identity">
                                <div class="player-name-display" id="nameP1">Player Name</div>
                                <div class="player-stats">Total Points: <span id="totalPointsP1">0</span></div>
                            </div>
                            <div class="player-score-area">
                                <div class="round-score" id="scoreP1">0</div>
                                <div class="english-name-display" id="engNameP1">Name</div>
                            </div>
                        </div>
                        <div class="local-timer-container">
                            <div class="local-timer-bar" id="timerBar1"></div>
                        </div>
                    </div>
                </div>

                <div class="versus-divider">VS</div>

                <!-- Player 2 Card -->
                <div class="player-card" id="cardP2">
                    <div class="question-section">
                        <div class="target-word-container">
                             <div class="target-word" id="targetWord2">WORD</div>
                        </div>
                        <div class="answers-grid" id="answers2">
                            <!-- Buttons injected here -->
                        </div>
                        <div class="correct-reveal-text" id="reveal2">Answer</div>
                    </div>
                    <div class="player-info-footer">
                        <div class="player-details">
                            <div class="player-identity">
                                <div class="player-name-display" id="nameP2">Player Name</div>
                                <div class="player-stats">Total Points: <span id="totalPointsP2">0</span></div>
                            </div>
                            <div class="player-score-area">
                                <div class="round-score" id="scoreP2">0</div>
                                <div class="english-name-display" id="engNameP2">Name</div>
                            </div>
                        </div>
                        <div class="local-timer-container">
                            <div class="local-timer-bar" id="timerBar2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HEADER (Moved to Bottom) -->
        <div class="game-progress" id="gameHeader" style="display:none;">
            <div class="header-team-score">
                <span id="headerTeam1Name">Team Alpha</span>
                <div id="headerTeam1Score">0</div>
            </div>
            <div class="round-info">
                <div>ROUND <span id="currentRoundDisplay">1</span> / <span id="totalRoundsDisplay">5</span></div>
                <div style="font-size: 0.9rem; color: #888;">Question <span id="currentQuestionNum">1</span>/10</div>
            </div>
            <div class="header-team-score">
                <span id="headerTeam2Name">Team Beta</span>
                <div id="headerTeam2Score">0</div>
            </div>
        </div>

    </div>

    <!-- CHAMPIONSHIP MODAL -->
    <div id="championshipModal" class="championship-modal">
        <div class="trophy-icon">üèÜ</div>
        <h1 style="font-size: 4rem; color: gold; text-shadow: 0 0 20px gold; margin: 1rem;">CHAMPIONSHIP ROUND</h1>
        <h2 style="font-size: 1.5rem; color: #fff; margin-bottom: 2rem;">The Top Players Face Off!</h2>
        <div style="display: flex; gap: 3rem; margin-bottom: 3rem;">
            <div style="text-align: center;">
                <div style="font-size: 1.2rem; color: var(--primary-glow);">TEAM ALPHA CHAMPION</div>
                <div style="font-size: 2.5rem; font-weight: bold;" id="champ1Name">Name</div>
                <div style="color: gold;" id="champ1Score">0 pts</div>
            </div>
             <div style="text-align: center; font-size: 3rem; color: #555; display: flex; align-items:center;">VS</div>
            <div style="text-align: center;">
                <div style="font-size: 1.2rem; color: var(--secondary-glow);">TEAM BETA CHAMPION</div>
                <div style="font-size: 2.5rem; font-weight: bold;" id="champ2Name">Name</div>
                 <div style="color: gold;" id="champ2Score">0 pts</div>
            </div>
        </div>
        <button class="mode-btn" onclick="startChampionshipMatch()">START FINAL BATTLE</button>
    </div>

    <script>
        // --- DATA ---
        const grade10 = ["Dino", "Tracy", "Billie", "Jessie", "Von Tony", "Jim", "Andrew", "Mark", "Leo", "Apollo", "Jenny", "Tony", "Haowlin", "Lion", "Steven", "Mike"];
        const grade11 = ["Grace", "Iris", "Jackie", "Max", "Emily", "Rhea", "Vicky"];
        const grade12 = ["Anna", "Mia", "Kenn", "Max", "Sky", "Sheng", "Keying", "Zifan", "Sifei", "Jiaqi", "Zack", "Azure", "Joe"];
        
        // Dictionary Data Sorted by CEFR
        const words = {
            A1: [
                { word: "happy", synonyms: ["joyful", "cheerful", "glad"] }, { word: "sad", synonyms: ["unhappy", "down", "upset"] },
                { word: "big", synonyms: ["large", "huge", "tall"] }, { word: "small", synonyms: ["little", "tiny", "short"] },
                { word: "fast", synonyms: ["quick", "rapid", "speedy"] }, { word: "slow", synonyms: ["unhurried", "leisurely", "late"] },
                { word: "hot", synonyms: ["warm", "boiling", "sunny"] }, { word: "cold", synonyms: ["cool", "freezing", "chilly"] },
                { word: "good", synonyms: ["nice", "fine", "great"] }, { word: "bad", synonyms: ["terrible", "awful", "evil"] },
                { word: "run", synonyms: ["jog", "sprint", "race"] }, { word: "walk", synonyms: ["hike", "stroll", "march"] }
            ],
            A2: [
                { word: "start", synonyms: ["begin", "open", "launch"] }, { word: "end", synonyms: ["finish", "stop", "close"] },
                { word: "beautiful", synonyms: ["pretty", "lovely", "attractive"] }, { word: "ugly", synonyms: ["unattractive", "messy", "nasty"] },
                { word: "rich", synonyms: ["wealthy", "expensive", "prosperous"] }, { word: "poor", synonyms: ["needy", "broke", "unfortunate"] },
                { word: "give", synonyms: ["offer", "provide", "grant"] }, { word: "take", synonyms: ["get", "grab", "catch"] },
                { word: "buy", synonyms: ["purchase", "pay for", "get"] }, { word: "sell", synonyms: ["trade", "exchange", "deal"] },
                { word: "clever", synonyms: ["smart", "bright", "intelligent"] }, { word: "stupid", synonyms: ["dumb", "silly", "foolish"] }
            ],
            B1: [
                { word: "difficult", synonyms: ["hard", "challenging", "tough"] }, { word: "easy", synonyms: ["simple", "effortless", "basic"] },
                { word: "brave", synonyms: ["courageous", "heroic", "bold"] }, { word: "scared", synonyms: ["afraid", "frightened", "nervous"] },
                { word: "create", synonyms: ["invent", "design", "produce"] }, { word: "destroy", synonyms: ["ruin", "wreck", "smash"] },
                { word: "important", synonyms: ["essential", "crucial", "main"] }, { word: "boring", synonyms: ["dull", "uninteresting", "tiring"] },
                { word: "calm", synonyms: ["relaxed", "peaceful", "quiet"] }, { word: "angry", synonyms: ["mad", "cross", "annoyed"] },
                { word: "strange", synonyms: ["odd", "weird", "unusual"] }, { word: "common", synonyms: ["usual", "normal", "regular"] }
            ],
            B2: [
                { word: "diligent", synonyms: ["hardworking", "studious", "active"] }, { word: "lazy", synonyms: ["inactive", "sluggish", "idle"] },
                { word: "optimistic", synonyms: ["positive", "hopeful", "cheerful"] }, { word: "pessimistic", synonyms: ["negative", "gloomy", "hopeless"] },
                { word: "arrogant", synonyms: ["proud", "vain", "haughty"] }, { word: "humble", synonyms: ["modest", "shy", "meek"] },
                { word: "intricate", synonyms: ["complex", "complicated", "detailed"] }, { word: "simple", synonyms: ["plain", "easy", "basic"] },
                { word: "genuine", synonyms: ["real", "authentic", "true"] }, { word: "fake", synonyms: ["false", "artificial", "imitation"] },
                { word: "admit", synonyms: ["confess", "accept", "acknowledge"] }, { word: "deny", synonyms: ["refuse", "reject", "dispute"] }
            ],
            C1: [
                { word: "ephemeral", synonyms: ["transient", "fleeting", "brief"] }, { word: "ubiquitous", synonyms: ["omnipresent", "pervasive", "universal"] },
                { word: "pragmatic", synonyms: ["practical", "sensible", "realistic"] }, { word: "superfluous", synonyms: ["excessive", "redundant", "extra"] },
                { word: "benevolent", synonyms: ["kind", "generous", "charitable"] }, { word: "malevolent", synonyms: ["wicked", "malicious", "hostile"] },
                { word: "enigmatic", synonyms: ["mysterious", "puzzling", "cryptic"] }, { word: "articulate", synonyms: ["eloquent", "fluent", "clear"] },
                { word: "mundane", synonyms: ["ordinary", "banal", "routine"] }, { word: "meticulous", synonyms: ["thorough", "precise", "exact"] },
                { word: "esoteric", synonyms: ["obscure", "abstruse", "secret"] }, { word: "candid", synonyms: ["frank", "honest", "direct"] }
            ]
        };

        const praisePhrases = ["Excellent!", "Stellar!", "Amazing!", "Perfect!", "Genius!", "Superb!"];
        
        // --- GAME STATE ---
        let state = {
            players: [],
            team1: { name: "", players: [], score: 0 },
            team2: { name: "", players: [], score: 0 },
            playerStats: {}, // { "Name": { score: 0, team: 1/2 } }
            rounds: [],
            currentRoundIdx: 0,
            currentQuestionIdx: 0,
            currentPlayer1: null,
            currentPlayer2: null,
            timer: null,
            isChampionship: false,
            roundResolved: false // To prevent double triggers
        };

        // --- AUDIO ---
        const synth = window.speechSynthesis;
        let voices = [];
        
        function initVoices() {
            voices = synth.getVoices();
        }
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }

        // Helper to extract English name from "Chinese / English"
        function getEnglishName(fullString) {
            if (!fullString) return "";
            if (fullString.includes('/')) {
                // Return the part after the slash, trimmed
                return fullString.split('/')[1].trim();
            }
            return fullString;
        }

        function speak(text, isName = false) {
            if (synth.speaking) synth.cancel();
            
            // If it's a player name, parse it for English only
            const textToSpeak = isName ? getEnglishName(text) : text;
            
            const utter = new SpeechSynthesisUtterance(textToSpeak);
            utter.rate = 0.85; // Slowed down
            
            // Priority: Microsoft Andrew, Microsoft Emma, then generic English
            const andrew = voices.find(v => v.name.includes("Microsoft Andrew Online (Natural)"));
            const emma = voices.find(v => v.name.includes("Microsoft Emma Online (Natural)"));
            const anyNatural = voices.find(v => v.name.includes("Natural") && v.lang.startsWith("en"));
            
            if (andrew) utter.voice = andrew;
            else if (emma) utter.voice = emma;
            else if (anyNatural) utter.voice = anyNatural;
            
            synth.speak(utter);
        }

        function playSound(type) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            }
        }
        
        // --- DIFFICULTY HELPER ---
        function getDistractors(targetLevel, correctWordStr) {
            let pool = [];
            const levels = ['A1', 'A2', 'B1', 'B2', 'C1'];
            let allowedLevels = [];
            
            // Difficulty Logic for Distractors:
            // A1 -> A1, A2
            // A2 -> A1, A2, B1
            // B1 -> A2, B1, B2
            // B2 -> B1, B2, C1
            // C1 -> B2, C1 (Hardest)
            
            if (targetLevel === 'A1') allowedLevels = ['A1', 'A2'];
            else if (targetLevel === 'A2') allowedLevels = ['A1', 'A2', 'B1'];
            else if (targetLevel === 'B1') allowedLevels = ['A2', 'B1', 'B2'];
            else if (targetLevel === 'B2') allowedLevels = ['B1', 'B2', 'C1'];
            else if (targetLevel === 'C1') allowedLevels = ['B2', 'C1'];
            
            allowedLevels.forEach(lvl => {
                 words[lvl].forEach(w => {
                    if(w.word !== correctWordStr) {
                        pool.push(...w.synonyms);
                    }
                });
            });
            
            // Shuffle and return 2 unique
            return [...new Set(pool)].sort(() => 0.5 - Math.random()).slice(0, 2);
        }

        // --- SETUP ---
        function startGame(grade) {
            let pool = [];
            if (grade === 10) pool = [...grade10];
            else if (grade === 11) pool = [...grade11];
            else pool = [...grade12];

            // Initialize State
            state.players = pool.sort(() => 0.5 - Math.random());
            state.playerStats = {};
            state.players.forEach(p => state.playerStats[p] = { score: 0, team: 0 });

            // Split Teams
            const mid = Math.ceil(pool.length / 2);
            state.team1.players = pool.slice(0, mid);
            state.team2.players = pool.slice(mid);
            state.team1.name = "The Void Voyagers";
            state.team2.name = "The Nebula Navigators";
            state.team1.players.forEach(p => state.playerStats[p].team = 1);
            state.team2.players.forEach(p => state.playerStats[p].team = 2);

            // Generate Rounds
            const totalRounds = Math.max(state.team1.players.length, state.team2.players.length);
            state.rounds = [];
            
            for(let i=0; i<totalRounds; i++) {
                // Progressive Difficulty: 2 words from EACH level
                let rA1 = [...words.A1].sort(() => 0.5 - Math.random()).slice(0, 2);
                let rA2 = [...words.A2].sort(() => 0.5 - Math.random()).slice(0, 2);
                let rB1 = [...words.B1].sort(() => 0.5 - Math.random()).slice(0, 2);
                let rB2 = [...words.B2].sort(() => 0.5 - Math.random()).slice(0, 2);
                let rC1 = [...words.C1].sort(() => 0.5 - Math.random()).slice(0, 2);
                
                let rawQuestions = [
                    { data: rA1, level: 'A1' },
                    { data: rA2, level: 'A2' },
                    { data: rB1, level: 'B1' },
                    { data: rB2, level: 'B2' },
                    { data: rC1, level: 'C1' }
                ];
                
                let roundQuestions = [];
                
                rawQuestions.forEach(grp => {
                    grp.data.forEach(q => {
                        const answer = q.synonyms[Math.floor(Math.random() * q.synonyms.length)];
                        const distractors = getDistractors(grp.level, q.word);
                        roundQuestions.push({ word: q.word, answer, distractors, level: grp.level });
                    });
                });

                state.rounds.push(roundQuestions);
            }

            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameHeader').style.display = 'flex';
            document.getElementById('headerTeam1Name').innerText = state.team1.name;
            document.getElementById('headerTeam2Name').innerText = state.team2.name;
            document.getElementById('totalRoundsDisplay').innerText = totalRounds;

            document.getElementById('teamSetup').style.display = 'block';
            document.getElementById('setupTeam1List').innerHTML = state.team1.players.map(p => `<div>${p}</div>`).join('');
            document.getElementById('setupTeam2List').innerHTML = state.team2.players.map(p => `<div>${p}</div>`).join('');
            
            setTimeout(() => {
                document.getElementById('teamSetup').style.display = 'none';
                startRoundSequence();
            }, 3000);
        }

        function startRoundSequence() {
            if (state.currentRoundIdx >= state.rounds.length) {
                checkChampionship();
                return;
            }

            state.currentPlayer1 = state.team1.players[state.currentRoundIdx % state.team1.players.length];
            state.currentPlayer2 = state.team2.players[state.currentRoundIdx % state.team2.players.length];

            document.getElementById('gamePlay').style.display = 'none';
            document.getElementById('matchupScreen').style.display = 'block';
            document.getElementById('matchupPlayer1').innerText = state.currentPlayer1.split('/')[0];
            document.getElementById('matchupPlayer2').innerText = state.currentPlayer2.split('/')[0];
            document.getElementById('matchupTeam1').innerText = state.team1.name;
            document.getElementById('matchupTeam2').innerText = state.team2.name;

            let count = 5;
            const cd = document.getElementById('countdown');
            cd.innerText = count;
            
            speak(state.currentPlayer1, true); // True = isName
            setTimeout(() => speak(state.currentPlayer2, true), 1500);

            const interval = setInterval(() => {
                count--;
                cd.innerText = count;
                if(count <= 0) {
                    clearInterval(interval);
                    document.getElementById('matchupScreen').style.display = 'none';
                    beginGameplay();
                }
            }, 1000);
        }

        function beginGameplay() {
            document.getElementById('gamePlay').style.display = 'flex';
            state.currentQuestionIdx = 0;
            document.getElementById('currentRoundDisplay').innerText = state.isChampionship ? "CHAMPIONSHIP" : state.currentRoundIdx + 1;
            
            document.getElementById('scoreP1').innerText = "0";
            document.getElementById('scoreP2').innerText = "0";
            document.getElementById('nameP1').innerText = state.currentPlayer1.split('/')[0]; // Visual can still show Chinese
            document.getElementById('engNameP1').innerText = getEnglishName(state.currentPlayer1);
            document.getElementById('nameP2').innerText = state.currentPlayer2.split('/')[0];
            document.getElementById('engNameP2').innerText = getEnglishName(state.currentPlayer2);

            document.getElementById('totalPointsP1').innerText = state.playerStats[state.currentPlayer1].score;
            document.getElementById('totalPointsP2').innerText = state.playerStats[state.currentPlayer2].score;

            loadQuestion();
        }

        function loadQuestion() {
            if (state.currentQuestionIdx >= 10) {
                if(state.isChampionship) {
                    endGame();
                    return;
                }
                state.currentRoundIdx++;
                startRoundSequence();
                return;
            }

            state.roundResolved = false;

            let qData;
            if(state.isChampionship) {
                // CHAMPIONSHIP LOGIC: 
                // Always C1 Word.
                // Distractors always from C1 pool (very hard).
                const hQ = words.C1[Math.floor(Math.random() * words.C1.length)];
                const answer = hQ.synonyms[Math.floor(Math.random() * hQ.synonyms.length)];
                
                // Get distractors ONLY from C1 (hardest possible)
                let c1Pool = [];
                words.C1.forEach(w => {
                    if(w.word !== hQ.word) c1Pool.push(...w.synonyms);
                });
                const distractors = c1Pool.sort(()=>0.5-Math.random()).slice(0,2);
                
                qData = { word: hQ.word, answer, distractors };
            } else {
                qData = state.rounds[state.currentRoundIdx][state.currentQuestionIdx];
            }

            document.getElementById('currentQuestionNum').innerText = state.currentQuestionIdx + 1;

            renderPlayerSide(1, qData);
            renderPlayerSide(2, qData);

            speak(qData.word);

            document.getElementById('reveal1').classList.remove('show');
            document.getElementById('reveal2').classList.remove('show');

            startTimer();
        }

        function renderPlayerSide(pNum, qData) {
            document.getElementById(`targetWord${pNum}`).innerText = qData.word;
            document.getElementById(`reveal${pNum}`).innerText = `Answer: ${qData.answer}`;
            
            const btnContainer = document.getElementById(`answers${pNum}`);
            btnContainer.innerHTML = '';
            
            let choices = [qData.answer, ...qData.distractors].sort(() => 0.5 - Math.random());
            
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                // Upper case for championship round
                btn.innerText = state.isChampionship ? choice.toUpperCase() : choice;
                btn.onclick = (e) => handleAnswer(pNum, choice, qData.answer, e.target);
                btnContainer.appendChild(btn);
            });
        }

        function startTimer() {
            let timeLeft = 100;
            const bar1 = document.getElementById('timerBar1');
            const bar2 = document.getElementById('timerBar2');
            
            if (state.timer) clearInterval(state.timer);
            
            state.timer = setInterval(() => {
                if (state.roundResolved) return; 

                timeLeft -= 1; 
                bar1.style.width = timeLeft + "%";
                bar2.style.width = timeLeft + "%";
                
                if (timeLeft <= 0) {
                    clearInterval(state.timer);
                    resolveQuestion(false, 0); // No winner
                }
            }, 100);
        }

        function handleAnswer(pNum, choice, correct, btn) {
            if (state.roundResolved) return; // Prevent late clicks

            const isCorrect = choice === correct;
            
            if (isCorrect) {
                // --- COMPETITIVE LOGIC: FIRST TO CORRECT WINS ---
                state.roundResolved = true; // Lock round immediately
                clearInterval(state.timer);

                btn.classList.add('correct');
                playSound('correct');

                // Award points
                if (pNum === 1) {
                    state.team1.score += 10;
                    state.playerStats[state.currentPlayer1].score += 10;
                    document.getElementById('scoreP1').innerText = parseInt(document.getElementById('scoreP1').innerText) + 10;
                } else {
                    state.team2.score += 10;
                    state.playerStats[state.currentPlayer2].score += 10;
                    document.getElementById('scoreP2').innerText = parseInt(document.getElementById('scoreP2').innerText) + 10;
                }
                
                speak(praisePhrases[Math.floor(Math.random()*praisePhrases.length)]);
                
                // Show other player as wrong (visual feedback they lost the race)
                const otherPNum = pNum === 1 ? 2 : 1;
                disableButtons(otherPNum);
                disableButtons(pNum);

                // Delay slightly then resolve
                setTimeout(() => resolveQuestion(true, pNum), 500);

            } else {
                // Incorrect answer: Just disable this player, let other keep trying (unless timer runs out)
                btn.classList.add('incorrect');
                playSound('incorrect');
                const btns = document.getElementById(`answers${pNum}`).children;
                for(let b of btns) b.disabled = true;
                
                // If both are disabled (both got it wrong), end round
                const p1Disabled = Array.from(document.getElementById('answers1').children).every(b => b.disabled);
                const p2Disabled = Array.from(document.getElementById('answers2').children).every(b => b.disabled);

                if (p1Disabled && p2Disabled) {
                    clearInterval(state.timer);
                    setTimeout(() => resolveQuestion(false, 0), 500);
                }
            }
        }

        function disableButtons(pNum) {
            const btns = document.getElementById(`answers${pNum}`).children;
            for(let b of btns) b.disabled = true;
        }

        function resolveQuestion(hasWinner, winnerNum) {
            // Update Headers
            document.getElementById('headerTeam1Score').innerText = state.team1.score;
            document.getElementById('headerTeam2Score').innerText = state.team2.score;
            
            // Show Correct Answers
            document.getElementById('reveal1').classList.add('show');
            document.getElementById('reveal2').classList.add('show');

            setTimeout(() => {
                state.currentQuestionIdx++;
                loadQuestion();
            }, 2500); // Slightly longer pause to see result
        }

        // --- CHAMPIONSHIP LOGIC ---
        function checkChampionship() {
            if(state.isChampionship) return;

            const t1Sorted = state.team1.players.sort((a,b) => state.playerStats[b].score - state.playerStats[a].score);
            const t2Sorted = state.team2.players.sort((a,b) => state.playerStats[b].score - state.playerStats[a].score);

            const champ1 = t1Sorted[0];
            const champ2 = t2Sorted[0];

            const modal = document.getElementById('championshipModal');
            modal.style.display = 'flex';
            
            document.getElementById('champ1Name').innerText = champ1.split('/')[0];
            document.getElementById('champ1Score').innerText = state.playerStats[champ1].score + " pts";
            
            document.getElementById('champ2Name').innerText = champ2.split('/')[0];
            document.getElementById('champ2Score').innerText = state.playerStats[champ2].score + " pts";

            state.currentPlayer1 = champ1;
            state.currentPlayer2 = champ2;
            state.isChampionship = true;
            
            // Announce Champions
            speak("Championship Round", false);
        }

        function startChampionshipMatch() {
            document.getElementById('championshipModal').style.display = 'none';
            document.getElementById('gamePlay').style.display = 'flex';
            state.currentQuestionIdx = 0;
            document.getElementById('targetWord1').style.color = "gold";
            document.getElementById('targetWord2').style.color = "gold";
            beginGameplay();
        }

        function endGame() {
            const winner = state.team1.score > state.team2.score ? state.team1.name : state.team2.name;
            // Simple overlay for now
            const modal = document.getElementById('championshipModal');
            modal.innerHTML = `
                <h1 style="font-size: 4rem; color: gold;">GAME OVER</h1>
                <h2 style="font-size: 2rem; color: #fff;">${winner} WINS!</h2>
                <button class="mode-btn" onclick="location.reload()">PLAY AGAIN</button>
            `;
            modal.style.display = 'flex';
        }

        // --- STARFIELD ---
        function createStars() {
            const container = document.getElementById('starfield');
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.top = Math.random() * 100 + '%';
                star.style.left = Math.random() * 100 + '%';
                star.style.animationDuration = (Math.random() * 5 + 5) + 's';
                container.appendChild(star);
            }
        }
        createStars();

    </script>
</body>
</html>
