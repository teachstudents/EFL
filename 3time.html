<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Classroom Quiz Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            animation: backgroundShift 30s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0% { background: linear-gradient(45deg, #556cd6 0%, #5a3f8f 100%); }
            25% { background: linear-gradient(45deg, #e080e8 0%, #e04560 100%); }
            50% { background: linear-gradient(45deg, #2f8ed6 0%, #008fbf 100%); }
            75% { background: linear-gradient(45deg, #2fa15f 0%, #1f8f8f 100%); }
            100% { background: linear-gradient(45deg, #556cd6 0%, #5a3f8f 100%); }
        }

        .laser-beam {
            position: absolute;
            width: 4px;
            height: 200px;
            background: linear-gradient(to bottom, transparent, #00ffff, transparent);
            animation: laserMove 3s linear infinite;
            opacity: 0.7;
        }

        @keyframes laserMove {
            0% { transform: translateX(-100px) translateY(-100px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(calc(100vw + 100px)) translateY(100vh); opacity: 0; }
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        /* Layout Change: Controls at bottom now */
        .bottom-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px; /* Spacing from game area */
            gap: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 20px;
        }

        .progress-section {
            flex: 1;
            margin: 0 20px;
        }

        .progress-bar {
            height: 40px; /* Slightly smaller for bottom */
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb);
            border-radius: 20px;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-emoji {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            animation: bounce 0.5s ease-in-out infinite alternate;
        }

        @keyframes bounce {
            0% { transform: translateY(-50%) scale(1); }
            100% { transform: translateY(-50%) scale(1.2); }
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            background: linear-gradient(145deg, #d64545, #a83232);
            border: none;
            border-radius: 15px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .player-name {
            text-align: center;
            font-size: 22px; /* Larger Name */
            font-weight: 700;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-top: 10px; /* Spacing from buttons above */
            width: 100%;
        }

        .player-score {
            font-size: 18px;
            font-weight: 600;
            color: #ffd700;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .question-section {
            /* Hidden by default or specific use */
            display: none; 
        }

        /* Removed global streak indicator */

        .game-area {
            display: flex;
            flex: 1;
            gap: 20px;
            align-items: stretch;
            padding-top: 20px;
        }

        .choices-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            justify-content: flex-start; /* Align items to top */
        }

        .buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1; /* Take up available space */
        }

        .choice-button {
            background: linear-gradient(145deg, #4a5fd1, #5a3f8f);
            border: none;
            border-radius: 12px;
            padding: 10px; /* Reduced padding */
            font-size: 28px; /* Larger Font as requested */
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            min-height: 65px; /* Reduced Height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex: 1; /* Distribute height evenly */
        }

        .choice-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            z-index: 2;
        }

        .choice-button:active {
            transform: translateY(-1px) scale(0.98);
        }

        .choice-button.correct {
            animation: correctAnswer 4s ease-in-out;
            background: linear-gradient(145deg, #2fa15f, #1f8f8f);
        }

        .choice-button.incorrect {
            animation: incorrectAnswer 2s ease-in-out;
            background: linear-gradient(145deg, #d64545, #a83232);
        }

        @keyframes correctAnswer {
            0% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); transform: scale(1); }
            10% { box-shadow: 0 0 60px #ffd700; transform: scale(1.1); }
            100% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); transform: scale(1); }
        }

        @keyframes incorrectAnswer {
            0% { transform: scale(1); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); }
            100% { transform: scale(1); opacity: 0.6; }
        }

        /* --- UI Elements: Sparkles, Leaderboard, etc. --- */
        .sparkle, .glitter, .token, .fireworks, .winner-firework, .celebration-burst { pointer-events: none; }
        .sparkle { position: absolute; width: 10px; height: 10px; background: #ffd700; border-radius: 50%; animation: sparkle 1s ease-out forwards; }
        @keyframes sparkle { 0% { opacity: 1; transform: scale(0); } 100% { opacity: 0; transform: scale(0); } }
        .glitter { position: absolute; width: 8px; height: 8px; background: linear-gradient(45deg, #ff69b4, #00ffff, #ffd700, #ff4757); border-radius: 50%; animation: glitterFloat 2s ease-out forwards; }
        @keyframes glitterFloat { 0% { opacity: 1; transform: scale(0); } 100% { opacity: 0; transform: scale(0); } }
        .token { position: absolute; width: 20px; height: 20px; background: linear-gradient(45deg, #ffd700, #ffed4e); border-radius: 50%; border: 2px solid #ff6b6b; font-size: 12px; font-weight: bold; color: #333; display: flex; align-items: center; justify-content: center; animation: tokenFly 2s ease-out forwards; z-index: 1000; }
        @keyframes tokenFly { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.5); } }

        .leaderboard, .learning-phase, .name-shuffle, .attendance-section {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        .name-shuffle { width: 80%; max-width: 800px; padding: 60px; }
        .attendance-section { width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; }

        .shuffle-title, .attendance-title { font-size: 36px; font-weight: 700; color: #333; margin-bottom: 30px; }
        .shuffle-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 30px; min-height: 200px; align-items: center; }
        .shuffle-name { padding: 15px 20px; background: linear-gradient(145deg, #667eea, #764ba2); color: white; border-radius: 12px; font-size: 18px; font-weight: 600; animation: nameFloat 0.8s ease-in-out infinite; transition: all 0.3s ease; cursor: pointer; }
        @keyframes nameFloat { 0% { transform: translateY(0px) rotate(0deg) scale(1); } 50% { transform: translateY(-15px) rotate(5deg) scale(1.05); } 100% { transform: translateY(0px) rotate(0deg) scale(1); } }
        .shuffle-name.selected { background: linear-gradient(145deg, #43e97b, #38f9d7); animation: selectedPulse 1s ease-in-out infinite; transform: scale(1.2); }
        @keyframes selectedPulse { 0% { box-shadow: 0 0 20px #43e97b; } 50% { box-shadow: 0 0 40px #43e97b, 0 0 60px #38f9d7; } 100% { box-shadow: 0 0 20px #43e97b; } }
        .selected-players { display: flex; justify-content: center; gap: 20px; margin-top: 30px; }
        .selected-player { background: linear-gradient(145deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 15px; font-size: 20px; font-weight: 700; animation: finalSelection 2s ease-in-out infinite; }
        @keyframes finalSelection { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .round-info-display { color: white; font-size: 18px; font-weight: 600; background: rgba(255, 255, 255, 0.2); padding: 10px 20px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.3); text-align: center; white-space: nowrap; }
        
        .fireworks, .winner-firework, .celebration-burst { position: absolute; pointer-events: none; }
        .fireworks { width: 4px; height: 4px; background: #ffd700; border-radius: 50%; animation: firework 2s ease-out forwards; }
        @keyframes firework { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0); background: #00ffff; } }
        .winner-firework { width: 8px; height: 8px; background: linear-gradient(45deg, #ffd700, #ff69b4, #00ffff, #ff4757); border-radius: 50%; animation: winnerFirework 3s ease-out forwards; z-index: 1000; }
        @keyframes winnerFirework { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0); } }
        .celebration-burst { font-size: 48px; animation: celebrationBurst 2s ease-out forwards; z-index: 1001; }
        @keyframes celebrationBurst { 0% { opacity: 1; transform: scale(0); } 100% { opacity: 0; transform: scale(0.5); } }
        .floating-emoji { position: absolute; font-size: 24px; animation: floatEmoji 8s ease-in-out infinite; pointer-events: none; z-index: 5; opacity: 0.8; }
        @keyframes floatEmoji { 0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 10% { opacity: 0.8; } 100% { transform: translateY(-100px) rotate(360deg); opacity: 0; } }

        .main-menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .menu-container { background: rgba(255, 255, 255, 0.95); padding: 60px; border-radius: 30px; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: menuFloat 3s ease-in-out infinite alternate; }
        @keyframes menuFloat { 0% { transform: translateY(0px); } 100% { transform: translateY(-10px); } }
        .menu-title { font-size: 48px; font-weight: 700; color: #333; margin-bottom: 20px; }
        .menu-subtitle { font-size: 28px; font-weight: 600; color: #666; margin-bottom: 40px; }
        .grade-buttons { display: flex; gap: 20px; justify-content: center; }
        .grade-btn { background: linear-gradient(145deg, #4a5fd1, #5a3f8f); border: none; border-radius: 20px; padding: 25px 40px; font-size: 24px; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
        .grade-btn:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4); background: linear-gradient(145deg, #5a6fe8, #6b4fa5); }

        /* Attendance Styles */
        .attendance-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; max-height: 60vh; overflow-y: auto; padding: 10px; }
        .attendance-card { background: #fff; border: 2px solid #ddd; border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        
        /* IMPROVED VISIBILITY FOR PRESENT STUDENTS */
        .attendance-card.present { 
            background: #d1fae5; /* Light green background */
            border-color: #10b981; 
            color: #065f46; /* Dark green text for contrast */
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); 
            font-weight: 600;
        }
        
        .attendance-card.absent { background: #f5f5f5; border-color: #ccc; color: #999; opacity: 0.7; }
        .attendance-card:hover { transform: translateY(-2px); }
        .attendance-status { font-size: 20px; }
        .attendance-actions { display: flex; gap: 15px; justify-content: center; }
        .action-btn { background: #666; color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-size: 16px; transition: background 0.2s; }
        .action-btn:hover { background: #555; }
        .start-game-btn { background: linear-gradient(145deg, #ff6b6b, #ee5253); color: white; border: none; padding: 15px 40px; border-radius: 15px; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(238, 82, 83, 0.3); transition: all 0.3s; }
        .start-game-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(238, 82, 83, 0.4); }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div class="main-menu" id="mainMenu">
        <div class="menu-container">
            <h1 class="menu-title">üéß English Listening Quiz</h1>
            <h2 class="menu-subtitle">Select Your Grade</h2>
            <div class="grade-buttons">
                <button class="grade-btn" onclick="selectGrade(10)">Grade 10</button>
                <button class="grade-btn" onclick="selectGrade(11)">Grade 11</button>
                <button class="grade-btn" onclick="selectGrade(12)">Grade 12</button>
            </div>
        </div>
    </div>

    <!-- Attendance Section -->
    <div class="attendance-section" id="attendanceSection">
        <h2 class="attendance-title">Who is in class today?</h2>
        <div style="margin-bottom: 20px; color: #666;">Click to toggle Absent/Present</div>
        <div class="attendance-grid" id="attendanceGrid"></div>
        <div class="attendance-actions">
            <button class="action-btn" onclick="toggleAllAttendance(true)">Select All</button>
            <button class="action-btn" onclick="toggleAllAttendance(false)">Deselect All</button>
            <button class="start-game-btn" onclick="confirmAttendance()">Start Game ‚ñ∂</button>
        </div>
    </div>

    <div class="game-container" id="gameContainer" style="display: none;">
        <div class="game-area">
            <!-- Player 1 Column -->
            <div class="choices-column">
                <!-- Buttons ON TOP -->
                <div class="buttons-container">
                    <button class="choice-button" onclick="selectAnswer(0)">2:15 PM</button>
                    <button class="choice-button" onclick="selectAnswer(1)">2:45 PM</button>
                    <button class="choice-button" onclick="selectAnswer(2)">3:10 PM</button>
                    <button class="choice-button" onclick="selectAnswer(3)">3:50 PM</button>
                </div>
                <!-- Name BELOW -->
                <div class="player-name" id="player1">
                    Player 1
                    <div class="player-score" id="score1">0 points</div>
                </div>
            </div>

            <!-- Player 2 Column -->
            <div class="choices-column">
                <div class="buttons-container">
                    <button class="choice-button" onclick="selectAnswer(4)">4:15 PM</button>
                    <button class="choice-button" onclick="selectAnswer(5)">4:45 PM</button>
                    <button class="choice-button" onclick="selectAnswer(6)">5:10 PM</button>
                    <button class="choice-button" onclick="selectAnswer(7)">5:50 PM</button>
                </div>
                <div class="player-name" id="player2">
                    Player 2
                    <div class="player-score" id="score2">0 points</div>
                </div>
            </div>

            <!-- Player 3 Column -->
            <div class="choices-column">
                <div class="buttons-container">
                    <button class="choice-button" onclick="selectAnswer(8)">6:15 PM</button>
                    <button class="choice-button" onclick="selectAnswer(9)">6:45 PM</button>
                    <button class="choice-button" onclick="selectAnswer(10)">7:10 PM</button>
                    <button class="choice-button" onclick="selectAnswer(11)">7:50 PM</button>
                </div>
                <div class="player-name" id="player3">
                    Player 3
                    <div class="player-score" id="score3">0 points</div>
                </div>
            </div>
        </div>

        <!-- Bottom Section: Controls and Round Info -->
        <div class="bottom-section">
            <div class="control-buttons">
                <button class="control-btn" onclick="backToMenu()">üè† Menu</button>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">
                        <div class="progress-emoji" id="progressEmoji">‚è∞</div>
                    </div>
                </div>
            </div>
            <div class="round-info-display">
                Round: <span id="currentRound">1</span>/<span id="totalRounds">8</span>
            </div>
        </div>
    </div>

    <div class="leaderboard" id="leaderboard">
        <h2>üèÜ Round Complete! üèÜ</h2>
        <div id="leaderboardContent"></div>
        <div id="globalLeaderboardContent" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
            <h3>üåü Global Leaderboard üåü</h3>
            <div id="globalScores"></div>
        </div>
        <div style="margin-top: 20px; font-size: 16px; color: #666;">Next round starting automatically in 5 seconds...</div>
    </div>

    <div class="learning-phase" id="learningPhase">
        <div id="learningContent"></div>
    </div>

    <div class="name-shuffle" id="nameShuffle">
        <h2 class="shuffle-title">Selecting Players...</h2>
        <div class="shuffle-container" id="shuffleContainer"></div>
        <div class="selected-players" id="selectedPlayers"></div>
    </div>

    <script>
        // ========================================
        // üìö STUDENT NAMES SECTION
        // ========================================
        const studentsByGrade = {
            10: [
                "ÂÜØÂ•ïÂ∞ò / FENG, YICHEN", "ÈªÑËã•Ê∂µ / HUANG, RUOHAN", "Êùé‰∏∞Â±π / LI, FENGYI", 
                "ÊùéÈπèÊΩû / LI, PENGLU", "Ê¢ÅÈî¶Â§© / LING, JINTIAN", "ÂàòÊôØÊâ¨ / LIU, JINGYANG",
                "Èæô‰øäÂøó / LONG, JUNZHI", "È©¨Ëµ´ / MA, HE", "ËÅÇÊ∫™Â∫∑ / NIE, XIKANG",
                "Â∫û‰∫ëËîö / PANG, YUNWEI", "Êõ≤ÂÆ∂Áëû / QU, JIARUI", "Â≠ôËØóÁ´• / SUN, SHITONG",
                "ÁéãÂ≠êË®Ä / WANG, ZIYAN", "Êù®Êô¥Áè∫ / YANG, QINGJUN", "Âº†ÂÆ∏ÊÅ∫ / ZHANG, CHENKAI",
                "ËµµÊµ©Êñá / ZHAO, HAOWEN", "ËµµÊµ©Áê≥"
            ],
            11: [
                "Êü¥ÂçìÁë∂ / Iris", "Êùé‰πãÁî® / Max", "Êûó‰∫ëÊõ¶ / Cathy",
                "ÂàòÁèÇÂê´ / Sandy", "È™ÜÊ¢¶‰πî / Vicky", "ÂÆãÊòäËΩ© / Jim",
                "ÂêëÂÆ∂ÊÖï / Jackie", "ÂæêÂòâÁÅè / Jay", "Êù®È¶•ÂÆÅ / Grace",
                "Âº†‰∏éÂçì / Emily", "ËµµÂçÉÊ¢¶ / Rhea"
            ],
            12: [
                "ÂÆâÊîøËÅø / AN, ZHENGYU", "Ëî°Â≠êÂ¢® / CAI, ZIMO", "ÂàòÈïáÊ¶ï / LIU, ZHENRONG",
                "È©¨Áü•Ë°å / MA, ZHIXING", "ÈÇ±Â§© / QIU, TIAN", "ÁõõÊÄùËØ≠ / SHENG, SIYU",
                "ÂîêÂèØÁõà / TANG, KEYING", "Áî∞Â≠êÂá° / TIAN, ZIFAN", "Ë∞¢ÊñØÈ£û / XIE, SIFEI",
                "Êù®Âä†È∫í / YANG, JIAQI", "Âº†Á®ãÁöì / ZHANG, CHENGHAO", "ËµµÊô®ËææÈë´ / ZHAO, CHENDAXIN",
                "Âë®ÈÄ∏Âá° / ZHOU, YIFAN"
            ]
        };

        // ========================================
        // üéØ QUESTION DATABASE
        // ========================================
        const easyTimeExpressions = [
            { time: "9:00 AM", display: "9:00 AM", color: "#4CAF50", spoken: "nine o'clock", category: "morning_routine" },
            { time: "12:00 PM", display: "12:00 PM", color: "#FF9800", spoken: "twelve noon", category: "schedule" },
            { time: "6:00 PM", display: "6:00 PM", color: "#9C27B0", spoken: "six o'clock", category: "evening_routine" },
            { time: "8:30 AM", display: "8:30 AM", color: "#2196F3", spoken: "half past eight", category: "morning_routine" },
            { time: "1:30 PM", display: "1:30 PM", color: "#FF5722", spoken: "half past one", category: "appointment" },
            { time: "7:30 PM", display: "7:30 PM", color: "#795548", spoken: "half past seven", category: "evening_routine" }
        ];

        const mediumTimeExpressions = [
            { time: "2:15 PM", display: "2:15 PM", color: "#E91E63", spoken: "quarter past two", category: "appointment" },
            { time: "4:45 PM", display: "4:45 PM", color: "#673AB7", spoken: "quarter to five", category: "schedule" },
            { time: "10:15 AM", display: "10:15 AM", color: "#009688", spoken: "quarter past ten", category: "morning_routine" },
            { time: "3:45 PM", display: "3:45 PM", color: "#FF6B35", spoken: "quarter to four", category: "appointment" },
            { time: "11:20 AM", display: "11:20 AM", color: "#8BC34A", spoken: "twenty past eleven", category: "morning_routine" },
            { time: "5:40 PM", display: "5:40 PM", color: "#FFC107", spoken: "twenty to six", category: "evening_routine" }
        ];

        const hardTimeExpressions = [
            { time: "3:07 AM", display: "3:07 AM", color: "#607D8B", spoken: "seven minutes past three in the morning", category: "schedule" },
            { time: "11:53 PM", display: "11:53 PM", color: "#9E9E9E", spoken: "seven minutes to twelve at night", category: "evening_routine" },
            { time: "6:22 AM", display: "6:22 AM", color: "#FF4081", spoken: "twenty-two minutes past six", category: "morning_routine" },
            { time: "9:38 PM", display: "9:38 PM", color: "#536DFE", spoken: "twenty-two minutes to ten", category: "evening_routine" },
            { time: "4:13 PM", display: "4:13 PM", color: "#1DE9B6", spoken: "thirteen minutes past four", category: "schedule" },
            { time: "8:47 AM", display: "8:47 AM", color: "#FF6D00", spoken: "thirteen minutes to nine", category: "morning_routine" }
        ];

        // ========================================
        // üìù CONVERSATION TEMPLATES
        // ========================================
        // New 'champion' level added with 3 distractors/steps logic
        const conversationTemplates = {
            easy: {
                morning_routine: ["I wake up at {time} every morning. My alarm goes off at {time} sharp.", "Breakfast is served at {time}. The dining hall opens at {time}.", "School starts at {time}. Don't be late! Classes begin at {time}."],
                evening_routine: ["I go to bed at {time}. Lights out at {time} every night.", "Dinner is served at {time}. We eat at {time}.", "The night shift starts at {time}. Work begins at {time}."],
                schedule: ["The meeting is at {time}. Please arrive by {time}.", "The bus leaves at {time}. Departure time is {time}.", "The store opens at {time}. Opening time is {time}."],
                appointment: ["Your appointment is at {time}. See you at {time}.", "The doctor will see you at {time}. Your slot is {time}."]
            },
            medium: {
                morning_routine: ["I usually wake up earlier, but today I woke up at {time}. Yes, {time}.", "Morning assembly is usually at 8, but today it is at {time}. Don't miss the {time} start."],
                evening_routine: ["I used to have dinner at {distractor1}, but now I eat at {time}. My new dinner time is {time}.", "The gym closes at {distractor1} on weekdays, but today it closes at {time}. So we need to finish by {time}."],
                schedule: ["The train usually leaves at {distractor1}, but today it departs at {time}. Make sure you're there by {time}.", "Class was supposed to start at {distractor1}, but it's been changed to {time}. New start time is {time}."],
                appointment: ["Can we meet at {distractor1}? Actually, I have a conflict. How about {time}? Yes, {time} works perfectly!", "The original time was {distractor1}, but we moved it to {time}. The new time is {time}."]
            },
            hard: {
                morning_routine: ["Breakfast is from {distractor1} to {distractor2}, but today it starts early at {time}. Today's breakfast time: {time}.", "I ran at {distractor1} yesterday, but today I started my run at {time}. Morning run at {time}."],
                evening_routine: ["The library closes at {distractor1} on weekdays, {distractor2} on weekends, but tonight it closes at {time}. Closing time: {time}.", "My shift ends at {time}. Not {distractor1} or {distractor2}, I work until {time}."],
                schedule: ["The conference call was at {distractor1} yesterday, {distractor2} last week, but today it's at {time}. Today's time is {time}.", "Flight departures: Gate A at {distractor1}, Gate B at {distractor2}, but our flight leaves at {time}. Our departure is {time}."],
                appointment: ["The appointment was moved from {distractor1} to {distractor2}, then finally to {time}. So the confirmed time is {time}.", "I suggested {distractor1}, but that doesn't work. Let's do {time} instead. {time} is perfect."]
            },
            // Champion level: 3 time mentions, requires determining the final choice
            champion: {
                morning_routine: [
                    "My mom wakes up at {distractor1}, my dad at {distractor2}, but I sleep in until {time}. I love waking up at {time}.",
                    "On Mondays I run at {distractor1}, Fridays at {distractor2}, but today is Wednesday so I run at {time}. Today's run is {time}."
                ],
                evening_routine: [
                    "The movie usually plays at {distractor1} or {distractor2}, but tonight the special screening is at {time}. See you at {time}.",
                    "I finish work at {distractor1} on Mondays, {distractor2} on Tuesdays, but today I am working late until {time}. Home by {time}."
                ],
                schedule: [
                    "The early train is at {distractor1}, the express is at {distractor2}, but we are taking the slow train at {time}. See you for the slow train at {time}.",
                    "Class A starts at {distractor1}, Class B is at {distractor2}, but your specific lab session begins at {time}. Don't miss the {time} lab.",
                    "Gate 1 closes at {distractor1}, Gate 2 at {distractor2}, but our Gate 3 doesn't close until {time}. We have until {time}."
                ],
                appointment: [
                    "I first suggested {distractor1}, then you asked for {distractor2}, but the only slot the doctor has is {time}. So we must go at {time}.",
                    "Let's check the calendar. Monday is {distractor1}, Tuesday is {distractor2}, but our meeting is actually on Wednesday at {time}. Wednesday, {time}."
                ]
            }
        };

        // ======= STATE =======
        let currentGrade = null;
        let studentNames = [];
        let presentStudents = [];
        let totalRounds = 8;
        let currentRound = 1;
        let currentQuestion = 1;
        let currentPlayers = [];
        let usedPlayers = [];
        let playerScores = {};
        let globalLeaderboard = {};
        let playerStreaks = {};
        let roundWinners = []; // Track winners of each round for the final
        let timeLeft = 15;
        let gameActive = false;
        let currentQuestionData = null;
        let questionInterval = null;
        let timers = new Set();
        let cachedVoices = [];
        let voicesReady = false;

        // ======= TIMER & SPEECH HELPERS =======
        function clearTimer(ref) {
          if (!ref) return;
          if (ref._type === 'interval') clearInterval(ref.id);
          else clearTimeout(ref.id);
          timers.delete(ref);
        }

        function makeInterval(fn, ms) {
          const id = setInterval(fn, ms);
          const ref = { id, _type: 'interval' };
          timers.add(ref);
          return ref;
        }

        function makeTimeout(fn, ms) {
          const id = setTimeout(fn, ms);
          const ref = { id, _type: 'timeout' };
          timers.add(ref);
          return ref;
        }

        function stopAllSpeech() {
          if ('speechSynthesis' in window) {
            speechSynthesis.cancel();
          }
        }

        function ensureVoicesReady() {
          return new Promise(resolve => {
            if (voicesReady) return resolve(cachedVoices);
            const load = () => {
              cachedVoices = speechSynthesis.getVoices();
              if (cachedVoices && cachedVoices.length > 0) {
                voicesReady = true;
                resolve(cachedVoices);
              }
            };
            const existing = speechSynthesis.getVoices();
            if (existing && existing.length > 0) {
              cachedVoices = existing;
              voicesReady = true;
              resolve(cachedVoices);
            } else {
              window.speechSynthesis.onvoiceschanged = () => load();
              makeTimeout(load, 1000); 
            }
          });
        }

        function speakOnce(text, { lang = 'en-US', rate = 0.85, pitch = 1, voiceName = null } = {}) {
            return new Promise(async (resolve) => {
                if (!('speechSynthesis' in window) || !text) return resolve();
                await ensureVoicesReady();
                stopAllSpeech(); 
                
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.rate = rate;
                u.pitch = pitch;

                if (cachedVoices.length > 0) {
                    let selectedVoice;
                    if (voiceName) selectedVoice = cachedVoices.find(v => v.name.includes(voiceName));
                    if (!selectedVoice) {
                        selectedVoice = cachedVoices.find(v => v.name.includes('Emma') && v.name.includes('Multilingual')) ||
                                        cachedVoices.find(v => v.name.includes('Emma')) || 
                                        cachedVoices.find(v => v.lang.startsWith('en'));
                    }
                    if (selectedVoice) u.voice = selectedVoice;
                }
                u.onend = () => resolve();
                u.onerror = () => resolve();
                speechSynthesis.speak(u);
            });
        }
        
        function speak(text) { return speakOnce(text, { lang: 'en-US', rate: 0.85, pitch: 1 }); }
        function speakEmma(text) { return speakOnce(text, { lang: 'en-US', rate: 0.85, pitch: 1, voiceName: 'Emma' }); }

        function playAudio() {
            if (!currentQuestionData) return Promise.resolve();
            return speakOnce(currentQuestionData.script);
        }

        // ======= ATTENDANCE LOGIC =======
        function showAttendance() {
            const grid = document.getElementById('attendanceGrid');
            grid.innerHTML = '';
            studentNames.forEach((name) => {
                const card = document.createElement('div');
                card.className = 'attendance-card present';
                card.dataset.name = name;
                card.onclick = () => toggleAttendance(card);
                const status = document.createElement('span');
                status.className = 'attendance-status';
                status.textContent = '‚úÖ';
                const label = document.createElement('span');
                label.textContent = name;
                card.appendChild(status);
                card.appendChild(label);
                grid.appendChild(card);
            });
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('attendanceSection').style.display = 'block';
        }

        function toggleAttendance(card) {
            if (card.classList.contains('present')) {
                card.classList.remove('present');
                card.classList.add('absent');
                card.querySelector('.attendance-status').textContent = '‚ùå';
            } else {
                card.classList.remove('absent');
                card.classList.add('present');
                card.querySelector('.attendance-status').textContent = '‚úÖ';
            }
        }

        function toggleAllAttendance(isPresent) {
            const cards = document.querySelectorAll('.attendance-card');
            cards.forEach(card => {
                if (isPresent) {
                    card.classList.remove('absent');
                    card.classList.add('present');
                    card.querySelector('.attendance-status').textContent = '‚úÖ';
                } else {
                    card.classList.remove('present');
                    card.classList.add('absent');
                    card.querySelector('.attendance-status').textContent = '‚ùå';
                }
            });
        }

        function confirmAttendance() {
            presentStudents = [];
            const cards = document.querySelectorAll('.attendance-card.present');
            cards.forEach(card => {
                presentStudents.push(card.dataset.name);
            });
            if (presentStudents.length < 3) {
                alert("Please select at least 3 students to play.");
                return;
            }
            document.getElementById('attendanceSection').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            usedPlayers = [];
            selectNewPlayers();
        }

        // ======= TIMER =======
        function startTimer() {
            const progressFill = document.getElementById('progressFill');
            const progressEmoji = document.getElementById('progressEmoji');
            if (questionInterval) clearTimer(questionInterval);

            timeLeft = 15;
            progressFill.style.width = '100%';
            progressEmoji.textContent = '‚è∞';

            questionInterval = makeInterval(() => {
                timeLeft--;
                const percentage = (timeLeft / 15) * 100;
                progressFill.style.width = percentage + '%';
                if (timeLeft > 10) progressEmoji.textContent = '‚è∞';
                else if (timeLeft > 5) progressEmoji.textContent = '‚ö†Ô∏è';
                else progressEmoji.textContent = 'üö®';
                if (timeLeft <= 5 && timeLeft > 0) { playTickSound(); }
                if (timeLeft <= 0) {
                    clearTimer(questionInterval);
                    questionInterval = null;
                    stopAllSpeech();
                    playBuzzerSound();
                    timeUp();
                }
            }, 1000);
        }

        // ======= GAME FLOW =======
        async function startNewQuestion() {
            if (currentQuestion > 10) {
                endRound();
                return;
            }
            stopAllSpeech();
            if (questionInterval) {
                clearTimer(questionInterval);
                questionInterval = null;
            }
            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => {
                button.disabled = false;
                button.classList.remove('correct', 'incorrect');
                button.style.opacity = '1';
            });
            gameActive = true;
            timeLeft = 15;
            
            // Determine difficulty based on round type
            const isFinalRound = currentRound === totalRounds;
            currentQuestionData = generateQuestion(isFinalRound);
            
            // document.getElementById('currentQuestion').textContent = currentQuestion; 
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressEmoji').textContent = '‚è∞';
            // updateStreakDisplay(); // Removed absolute streak display
            updatePlayerDisplay(); // Ensure badges are up to date
            startTimer();
            if (gameActive) {
                await playAudio();
            }
        }

        async function selectAnswer(choiceIndex) {
            if (!gameActive || !currentQuestionData) return;
            gameActive = false;
            if (questionInterval) {
                clearTimer(questionInterval);
                questionInterval = null;
            }
            stopAllSpeech();
            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => button.disabled = true);

            let answeringPlayer;
            let selectedChoice;
            if (choiceIndex >= 0 && choiceIndex <= 3) {
                answeringPlayer = currentPlayers[0];
                selectedChoice = currentQuestionData.player1Choices[choiceIndex];
            } else if (choiceIndex >= 4 && choiceIndex <= 7) {
                answeringPlayer = currentPlayers[1];
                selectedChoice = currentQuestionData.player2Choices[choiceIndex - 4];
            } else {
                answeringPlayer = currentPlayers[2];
                selectedChoice = currentQuestionData.player3Choices[choiceIndex - 8];
            }
            
            const isCorrect = selectedChoice.time === currentQuestionData.correctTime.time;
            const clickedButton = buttons[choiceIndex];
            
            if (!playerStreaks[answeringPlayer]) playerStreaks[answeringPlayer] = 0;
            const simpleName = answeringPlayer.split(' / ')[1] || answeringPlayer.split(' / ')[0];

            if (isCorrect) {
                playerStreaks[answeringPlayer]++;
                
                // Visual feedback only on the correct button clicked
                clickedButton.classList.add('correct');
                createFireworks(clickedButton);
                createSparkles(clickedButton);

                let points = 10;
                let streakBonus = 0;
                if (playerStreaks[answeringPlayer] >= 3) {
                    streakBonus = Math.min(playerStreaks[answeringPlayer] * 2, 20);
                    points += streakBonus;
                }
                playerScores[answeringPlayer] += points;
                playCorrectSound();
                
                // Reset other players' streaks
                currentPlayers.forEach(player => {
                    if (player !== answeringPlayer) playerStreaks[player] = 0;
                });
                
                let emmaAnnouncement = `${simpleName}, that is correct! Plus ${points} points!`;
                if (streakBonus > 0) emmaAnnouncement += ` ${playerStreaks[answeringPlayer]} in a row! Bonus ${streakBonus}!`;
                await speakEmma(emmaAnnouncement);
                createFlyingTokens(clickedButton, getPlayerScoreElement(answeringPlayer), `+${points}`);
                if (streakBonus > 0) createStreakEffects(clickedButton);
            } else {
                // Visual feedback only on incorrect button clicked
                clickedButton.classList.add('incorrect');
                createShakeEffect(clickedButton);

                playerStreaks[answeringPlayer] = 0;
                playerScores[answeringPlayer] -= 10; // Penalty
                playWrongSound();
                await speakEmma(`${simpleName}, that is incorrect. Minus ten points.`);
                createFlyingTokens(clickedButton, getPlayerScoreElement(answeringPlayer), '-10');
            }
            
            updatePlayerDisplay();
            
            makeTimeout(() => {
                currentQuestion++;
                startNewQuestion();
            }, 2000);
        }

        async function timeUp() {
            gameActive = false;
            if (!currentQuestionData) return;
            stopAllSpeech();
            currentPlayers.forEach(player => { playerStreaks[player] = 0; });
            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach((button) => {
                // In timeUp, we usually show the correct answer
                const buttonText = button.querySelector('span') ? button.querySelector('span').textContent : button.textContent;
                if (buttonText === currentQuestionData.correctTime.display) {
                    button.classList.add('correct');
                    createSparkles(button);
                }
                button.disabled = true;
            });
            await speakEmma(`Time is up! The correct answer is ${currentQuestionData.correctTime.display}`);
            updatePlayerDisplay();
            makeTimeout(() => {
                currentQuestion++;
                startNewQuestion();
            }, 2000);
        }

        async function endRound() {
            stopAllSpeech();
            const leaderboard = document.getElementById('leaderboard');
            const content = document.getElementById('leaderboardContent');
            const globalContent = document.getElementById('globalScores');
            
            currentPlayers.forEach(player => {
                if (!globalLeaderboard[player]) globalLeaderboard[player] = 0;
                globalLeaderboard[player] += playerScores[player];
            });
            
            const sortedPlayers = [...currentPlayers].sort((a, b) => playerScores[b] - playerScores[a]);
            
            // Track Round Winner for Champion Round
            if (sortedPlayers.length > 0) {
                const roundWinner = sortedPlayers[0];
                if (!roundWinners.includes(roundWinner)) {
                    roundWinners.push(roundWinner);
                }
            }

            let leaderboardHTML = '<h3>Round Scores:</h3>';
            sortedPlayers.forEach((player, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                leaderboardHTML += `<div style="margin: 10px 0; font-size: 20px;">${medal} ${player.split(' / ')[0]}: ${playerScores[player]} pts</div>`;
            });
            
            const globalSorted = Object.entries(globalLeaderboard).sort(([,a], [,b]) => b - a).slice(0, 10);
            let globalHTML = '';
            globalSorted.forEach(([player, score], index) => {
                const medal = index === 0 ? 'üëë' : index === 1 ? 'ü•á' : index === 2 ? 'ü•à' : index === 3 ? 'ü•â' : '‚≠ê';
                globalHTML += `<div style="margin: 5px 0; font-size: 16px;">${medal} ${player.split(' / ')[0]}: ${score} total</div>`;
            });
            
            content.innerHTML = leaderboardHTML;
            globalContent.innerHTML = globalHTML;
            leaderboard.style.display = 'block';
            
            const winner = sortedPlayers[0];
            const winnerName = winner.split(' / ')[1] || winner.split(' / ')[0]; 
            createWinnerFireworks();

            if (currentRound < totalRounds) {
                await speakEmma(`Congratulations ${winnerName}! You win this round!`);
                makeTimeout(() => { nextRound(); }, 5000);
            } else {
                const champion = globalSorted[0];
                if (champion) {
                    const championName = champion[0].split(' / ')[1] || champion[0].split(' / ')[0];
                    await speakEmma(`The grand champion is ${championName}!`);
                }
                makeTimeout(() => { backToMenu(); }, 8000);
            }
        }

        function nextRound() {
            stopAllSpeech();
            document.getElementById('leaderboard').style.display = 'none';
            currentRound++;
            if (currentRound > totalRounds) {
                backToMenu();
                return;
            }
            currentQuestion = 1;
            document.getElementById('currentRound').textContent = currentRound;
            Object.keys(playerScores).forEach(player => { playerScores[player] = 0; });
            Object.keys(playerStreaks).forEach(player => { playerStreaks[player] = 0; });

            if (currentRound === totalRounds) {
                startFinalRound();
            } else {
                selectNewPlayers();
            }
        }
        
        function startFinalRound() {
            const shuffleDiv = document.getElementById('nameShuffle');
            const titleDiv = shuffleDiv.querySelector('.shuffle-title');
            const containerDiv = document.getElementById('shuffleContainer');
            const selectedPlayersDiv = document.getElementById('selectedPlayers');
            
            titleDiv.innerHTML = 'üèÜ CHAMPION ROUND! üèÜ';
            containerDiv.innerHTML = '<div style="font-size: 24px; color: #666;">Winners vs Winners!</div>';
            selectedPlayersDiv.innerHTML = '';

            // Use Round Winners first, fill with high scorers if needed
            let finalPlayers = [...roundWinners];
            
            // If we don't have enough unique round winners, fill from global leaderboard
            if (finalPlayers.length < 3) {
                let topGlobal = Object.entries(globalLeaderboard)
                                    .filter(([name]) => presentStudents.includes(name) && !finalPlayers.includes(name))
                                    .sort(([, a], [, b]) => b - a)
                                    .map(([player]) => player);
                
                while(finalPlayers.length < 3 && topGlobal.length > 0) {
                    finalPlayers.push(topGlobal.shift());
                }
            }
            
            // Cap at 3 players
            currentPlayers = finalPlayers.slice(0, 3);

            speak("It is time for the Champion Round! Winners vs Winners!");

            currentPlayers.forEach((player, index) => {
                const selectedDiv = document.createElement('div');
                selectedDiv.className = 'selected-player';
                selectedDiv.textContent = `Player ${index + 1}: ${player.split(' / ')[0]}`;
                selectedPlayersDiv.appendChild(selectedDiv);
            });
            
            shuffleDiv.style.display = 'block';
            makeTimeout(() => {
                showPlayerCountdown(true);
            }, 4000);
        }

        // ======= INITIALIZATION =======
        function initGame() {
            createLaserBeams();
            createFloatingEmojis();
        }

        function createFloatingEmojis() {
            const emojis = ['üéµ', 'üé∂', 'üéß', 'üé§', '‚≠ê', '‚ú®', 'üåü', 'üí´', 'üéØ', 'üèÜ', 'üéä', 'üéâ', 'üî•', 'üíé', 'üåà', 'üé≠', 'üé™', 'üé®', 'üé≤', 'üé∏', 'üé∫', 'üéª', 'ü•á', 'üèÖ', 'üëë', 'üíù', 'üéÅ', 'üå∏', 'üå∫', 'üåª', 'ü¶ã', 'üêù', 'üåô', '‚òÄÔ∏è', '‚ö°', 'üîÆ'];
            setInterval(() => {
                const emoji = document.createElement('div');
                emoji.className = 'floating-emoji';
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emoji.style.left = Math.random() * window.innerWidth + 'px';
                emoji.style.animationDelay = Math.random() * 2 + 's';
                emoji.style.animationDuration = (6 + Math.random() * 4) + 's';
                document.body.appendChild(emoji);
                setTimeout(() => { emoji.remove(); }, 10000);
            }, 800);
        }
        
        function selectGrade(grade) {
            currentGrade = grade;
            studentNames = studentsByGrade[grade];
            totalRounds = (grade === 10) ? 6 : 5;
            document.getElementById('totalRounds').textContent = totalRounds;
            showAttendance();
        }

        function backToMenu() {
            stopAllSpeech();
            if(questionInterval) clearTimer(questionInterval);
            gameActive = false;
            currentRound = 1;
            currentQuestion = 1;
            currentPlayers = [];
            usedPlayers = [];
            playerScores = {};
            playerStreaks = {};
            globalLeaderboard = {};
            roundWinners = [];
            presentStudents = [];
            
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('learningPhase').style.display = 'none';
            document.getElementById('nameShuffle').style.display = 'none';
            // document.getElementById('streakIndicator').style.display = 'none'; // Removed element
            document.getElementById('attendanceSection').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
        }

        function createLaserBeams() {
            setInterval(() => {
                const laser = document.createElement('div');
                laser.className = 'laser-beam';
                laser.style.left = Math.random() * window.innerWidth + 'px';
                laser.style.top = Math.random() * window.innerHeight + 'px';
                laser.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(laser);
                setTimeout(() => { laser.remove(); }, 3000);
            }, 1000);
        }

        function generateQuestion(isFinalRound = false) {
            let difficulty, timePool, templatePool;
            
            // Difficulty logic: 
            // Questions 1-3: Easy
            // Questions 4-7: Medium
            // Questions 8-10 OR Final Round: Champion/Hard
            
            if (isFinalRound) {
                difficulty = 'champion';
                timePool = hardTimeExpressions;
                templatePool = conversationTemplates.champion;
            } else if (currentQuestion <= 3) {
                difficulty = 'easy';
                timePool = easyTimeExpressions;
                templatePool = conversationTemplates.easy;
            } else if (currentQuestion <= 7) {
                difficulty = 'medium';
                timePool = mediumTimeExpressions;
                templatePool = conversationTemplates.medium;
            } else {
                difficulty = 'hard';
                timePool = hardTimeExpressions;
                templatePool = conversationTemplates.hard;
            }
            
            const correctTime = timePool[Math.floor(Math.random() * timePool.length)];
            const allTimes = [...easyTimeExpressions, ...mediumTimeExpressions, ...hardTimeExpressions];
            const distractorTimes = allTimes.filter(t => t.time !== correctTime.time)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);

            const choices = [correctTime, ...distractorTimes];
            const categoryTemplates = templatePool[correctTime.category];
            const template = categoryTemplates[Math.floor(Math.random() * categoryTemplates.length)];
            let script = template;
            
            if (difficulty === 'easy') {
                script = script.replace(/{time}/g, correctTime.spoken);
            } else if (difficulty === 'medium') {
                script = script.replace(/{time}/g, correctTime.spoken).replace(/{distractor1}/g, distractorTimes[0].spoken);
            } else if (difficulty === 'hard') {
                script = script.replace(/{time}/g, correctTime.spoken).replace(/{distractor1}/g, distractorTimes[0].spoken).replace(/{distractor2}/g, distractorTimes[1].spoken);
            } else if (difficulty === 'champion') {
                // Champion Logic: Uses 3 times
                script = script.replace(/{time}/g, correctTime.spoken).replace(/{distractor1}/g, distractorTimes[0].spoken).replace(/{distractor2}/g, distractorTimes[1].spoken);
            }
            
            const player1Choices = [...choices].sort(() => Math.random() - 0.5);
            const player2Choices = [...choices].sort(() => Math.random() - 0.5);
            const player3Choices = [...choices].sort(() => Math.random() - 0.5);
            
            const buttons = document.querySelectorAll('.choice-button');
            
            // Helper to update button UI
            const updateBtn = (btn, choice) => {
                btn.innerHTML = `<span style="color: white; font-weight: bold; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">${choice.display}</span>`;
                btn.classList.remove('correct', 'incorrect');
                btn.disabled = false;
                btn.style.opacity = '1';
            };

            player1Choices.forEach((choice, index) => updateBtn(buttons[index], choice));
            player2Choices.forEach((choice, index) => updateBtn(buttons[index + 4], choice));
            player3Choices.forEach((choice, index) => updateBtn(buttons[index + 8], choice));

            return {
                script: script,
                correctTime: correctTime,
                difficulty: difficulty,
                player1Choices: player1Choices,
                player2Choices: player2Choices,
                player3Choices: player3Choices
            };
        }

        function selectNewPlayers() {
            showNameShuffle();
            if (usedPlayers.length >= presentStudents.length) usedPlayers = [];
            const availablePlayers = presentStudents.filter(name => !usedPlayers.includes(name));
            const shuffleContainer = document.getElementById('shuffleContainer');
            const selectedPlayersDiv = document.getElementById('selectedPlayers');
            
            shuffleContainer.innerHTML = '';
            selectedPlayersDiv.innerHTML = '';
            
            availablePlayers.forEach((name, index) => {
                setTimeout(() => {
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'shuffle-name';
                    nameDiv.dataset.fullName = name;
                    nameDiv.textContent = name.split(' / ')[0];
                    nameDiv.style.animationDelay = (index * 0.1) + 's';
                    shuffleContainer.appendChild(nameDiv);
                }, index * 100);
            });
            
            setTimeout(() => {
                selectPlayersSequentially(availablePlayers, 0);
            }, availablePlayers.length * 100 + 1000);
        }

        async function selectPlayersSequentially(availablePlayers, playerIndex) {
            if (playerIndex >= 3) {
                setTimeout(() => { showPlayerCountdown(); }, 2000);
                return;
            }
            const shuffleContainer = document.getElementById('shuffleContainer');
            const selectedPlayersDiv = document.getElementById('selectedPlayers');
            const nameElements = Array.from(shuffleContainer.querySelectorAll('.shuffle-name'));
            
            let highlightCount = 0;
            const highlightInterval = setInterval(async () => {
                nameElements.forEach(el => el.classList.remove('selected'));
                const availableNameElements = Array.from(shuffleContainer.querySelectorAll('.shuffle-name'));
                if (availableNameElements.length === 0) {
                    clearInterval(highlightInterval);
                    return;
                }
                const randomVisualIndex = Math.floor(Math.random() * availableNameElements.length);
                if (availableNameElements[randomVisualIndex]) {
                    availableNameElements[randomVisualIndex].classList.add('selected');
                }
                highlightCount++;
                if (highlightCount > 8) {
                    clearInterval(highlightInterval);
                    const selectedIndex = Math.floor(Math.random() * availablePlayers.length);
                    const selectedPlayerFullName = availablePlayers.splice(selectedIndex, 1)[0];
                    currentPlayers.push(selectedPlayerFullName);
                    usedPlayers.push(selectedPlayerFullName);
                    
                    let selectedElement = null;
                    nameElements.forEach(el => { if (el.dataset.fullName === selectedPlayerFullName) selectedElement = el; });

                    if (selectedElement) {
                        nameElements.forEach(el => el.classList.remove('selected'));
                        selectedElement.classList.add('selected');
                        
                        setTimeout(async () => {
                            selectedElement.remove();
                            const selectedDiv = document.createElement('div');
                            selectedDiv.className = 'selected-player';
                            selectedDiv.textContent = `Player ${playerIndex + 1}: ${selectedPlayerFullName.split(' / ')[0]}`;
                            selectedPlayersDiv.appendChild(selectedDiv);
                            playCorrectSound();
                            const speakName = selectedPlayerFullName.split(' / ')[1] || selectedPlayerFullName.split(' / ')[0];
                            await speakEmma(speakName);
                            setTimeout(() => { selectPlayersSequentially(availablePlayers, playerIndex + 1); }, 500); 
                        }, 200);
                    }
                }
            }, 200);
        }

        function showNameShuffle() {
            const shuffleDiv = document.getElementById('nameShuffle');
            shuffleDiv.style.display = 'block';
            currentPlayers = [];
            playShuffleSound();
        }

        function hideNameShuffle() { document.getElementById('nameShuffle').style.display = 'none'; }

        function showPlayerCountdown(isFinalRound = false) {
            const shuffleDiv = document.getElementById('nameShuffle');
            const titleDiv = shuffleDiv.querySelector('.shuffle-title');
            const containerDiv = shuffleDiv.querySelector('.shuffle-container');
            if (!isFinalRound) containerDiv.innerHTML = '';
            let countdown = 10;
            const titleText = isFinalRound ? 'Final Round Starts In' : 'Get Ready! Game starts in';
            titleDiv.textContent = `${titleText} ${countdown} seconds`;
            const countdownInterval = makeInterval(() => {
                countdown--;
                titleDiv.textContent = `${titleText} ${countdown} seconds`;
                if (countdown <= 0) {
                    clearTimer(countdownInterval);
                    currentPlayers.forEach(player => { playerScores[player] = 0; });
                    updatePlayerDisplay();
                    hideNameShuffle();
                    showLearningPhase();
                }
            }, 1000);
        }

        function showLearningPhase() { setTimeout(() => { startNewQuestion(); }, 500); }

        function updatePlayerDisplay() {
            const player1Name = currentPlayers[0] ? currentPlayers[0].split(' / ')[0] : 'Player 1';
            const player2Name = currentPlayers[1] ? currentPlayers[1].split(' / ')[0] : 'Player 2';
            const player3Name = currentPlayers[2] ? currentPlayers[2].split(' / ')[0] : 'Player 3';
            const score1 = playerScores[currentPlayers[0]] || 0;
            const score2 = playerScores[currentPlayers[1]] || 0;
            const score3 = playerScores[currentPlayers[2]] || 0;
            
            const maxScore = Math.max(score1, score2, score3);
            const trophy1 = score1 === maxScore && score1 > 0 ? ' üèÜ' : '';
            const trophy2 = score2 === maxScore && score2 > 0 ? ' üèÜ' : '';
            const trophy3 = score3 === maxScore && score3 > 0 ? ' üèÜ' : '';
            
            // Streak display logic inside player scores
            const streak1 = playerStreaks[currentPlayers[0]] > 0 ? `üî• ${playerStreaks[currentPlayers[0]]}` : '';
            const streak2 = playerStreaks[currentPlayers[1]] > 0 ? `üî• ${playerStreaks[currentPlayers[1]]}` : '';
            const streak3 = playerStreaks[currentPlayers[2]] > 0 ? `üî• ${playerStreaks[currentPlayers[2]]}` : '';

            document.getElementById('player1').innerHTML = `${player1Name}${trophy1}<div class="player-score" id="score1">${score1} pts ${streak1}</div>`;
            document.getElementById('player2').innerHTML = `${player2Name}${trophy2}<div class="player-score" id="score2">${score2} pts ${streak2}</div>`;
            document.getElementById('player3').innerHTML = `${player3Name}${trophy3}<div class="player-score" id="score3">${score3} pts ${streak3}</div>`;
        }

        
        function createStreakEffects(button) {
            const rect = button.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const fireEmojis = ['üî•', '‚ö°', 'üí•', '‚ú®', 'üåü'];
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const fire = document.createElement('div');
                    fire.className = 'celebration-burst';
                    fire.textContent = fireEmojis[Math.floor(Math.random() * fireEmojis.length)];
                    fire.style.left = centerX + (Math.random() - 0.5) * 300 + 'px';
                    fire.style.top = centerY + (Math.random() - 0.5) * 300 + 'px';
                    fire.style.fontSize = '36px';
                    document.body.appendChild(fire);
                    setTimeout(() => fire.remove(), 2000);
                }, i * 100);
            }
        }

        function createFireworks(button) {
            const rect = button.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'fireworks';
                    firework.style.left = centerX + (Math.random() - 0.5) * 200 + 'px';
                    firework.style.top = centerY + (Math.random() - 0.5) * 200 + 'px';
                    document.body.appendChild(firework);
                    setTimeout(() => firework.remove(), 2000);
                }, i * 100);
            }
        }

        function createWinnerFireworks() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'winner-firework';
                    firework.style.left = Math.random() * window.innerWidth + 'px';
                    firework.style.top = Math.random() * window.innerHeight + 'px';
                    document.body.appendChild(firework);
                    setTimeout(() => firework.remove(), 3000);
                }, i * 100);
            }
            const celebrationEmojis = ['üéâ', 'üéä', 'üèÜ', 'üëë', 'ü•á', '‚≠ê', '‚ú®', 'üåü', 'üí´', 'üî•'];
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const burst = document.createElement('div');
                    burst.className = 'celebration-burst';
                    burst.textContent = celebrationEmojis[Math.floor(Math.random() * celebrationEmojis.length)];
                    burst.style.left = Math.random() * window.innerWidth + 'px';
                    burst.style.top = Math.random() * window.innerHeight + 'px';
                    document.body.appendChild(burst);
                    setTimeout(() => burst.remove(), 2000);
                }, i * 150);
            }
        }

        function createSparkles(button) {
            const rect = button.getBoundingClientRect();
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.style.left = rect.left + Math.random() * rect.width + 'px';
                    sparkle.style.top = rect.top + Math.random() * rect.height + 'px';
                    document.body.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 1000);
                }, i * 50);
            }
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const glitter = document.createElement('div');
                    glitter.className = 'glitter';
                    glitter.style.left = rect.left + Math.random() * rect.width + 'px';
                    glitter.style.top = rect.top + Math.random() * rect.height + 'px';
                    document.body.appendChild(glitter);
                    setTimeout(() => glitter.remove(), 2000);
                }, i * 30);
            }
        }

        function getPlayerScoreElement(playerName) {
            const playerIndex = currentPlayers.indexOf(playerName);
            if (playerIndex === 0) return document.getElementById('score1');
            if (playerIndex === 1) return document.getElementById('score2');
            if (playerIndex === 2) return document.getElementById('score3');
            return null;
        }

        function createFlyingTokens(fromElement, toElement, points) {
            if (!fromElement || !toElement) return;
            const fromRect = fromElement.getBoundingClientRect();
            const toRect = toElement.getBoundingClientRect();
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const token = document.createElement('div');
                    token.className = 'token';
                    token.textContent = points;
                    token.style.left = fromRect.left + fromRect.width / 2 + 'px';
                    token.style.top = fromRect.top + fromRect.height / 2 + 'px';
                    document.body.appendChild(token);
                    setTimeout(() => {
                        token.style.transition = 'all 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                        token.style.left = toRect.left + toRect.width / 2 + 'px';
                        token.style.top = toRect.top + toRect.height / 2 + 'px';
                        token.style.transform = 'scale(0.5)';
                        token.style.opacity = '0';
                    }, 50);
                    setTimeout(() => token.remove(), 1600);
                }, i * 100);
            }
        }

        function createShakeEffect(button) {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const xMark = document.createElement('div');
                    xMark.innerHTML = '‚ùå';
                    xMark.style.position = 'absolute';
                    xMark.style.left = button.getBoundingClientRect().left + Math.random() * button.getBoundingClientRect().width + 'px';
                    xMark.style.top = button.getBoundingClientRect().top + Math.random() * button.getBoundingClientRect().height + 'px';
                    xMark.style.fontSize = '24px';
                    xMark.style.zIndex = '1001';
                    xMark.style.pointerEvents = 'none';
                    xMark.style.animation = 'fadeOut 1.5s ease-out forwards';
                    document.body.appendChild(xMark);
                    setTimeout(() => xMark.remove(), 1500);
                }, i * 100);
            }
        }

        function playTickSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function playBuzzerSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 1);
        }

        function playCorrectSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const notes = [523, 659, 784, 1047]; // C, E, G, C
            notes.forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }, index * 150);
            });
        }

        function playWrongSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function playShuffleSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.setValueAtTime(400 + Math.random() * 400, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                }, i * 100);
            }
        }

        window.addEventListener('load', () => {
            setTimeout(initGame, 1000);
            ensureVoicesReady();
        });
    </script>
</body>
</html>
