<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Gal√°pagos Islands: A Living Laboratory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @keyframes oceanColors {
            0% { background-color: #0c4a6e; } /* sky-900 */
            25% { background-color: #1e293b; } /* slate-800 */
            50% { background-color: #075985; } /* cyan-800 */
            75% { background-color: #1e293b; } /* slate-800 */
            100% { background-color: #0c4a6e; } /* sky-900 */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            animation: oceanColors 240s linear infinite;
            padding-top: 85px; /* Adjusted padding for progress bar */
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
            border: none;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px -1px rgba(0,0,0,0.2), 0 1px 2px -2px rgba(0,0,0,0.1), inset 0 -2px 0 0 rgba(0,0,0,0.2);
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 44px; padding: 0 4px;
            border: 2px dashed #9ca3af; border-radius: 8px; margin: 0 4px;
            vertical-align: middle; background-color: #f3f4f6;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 8px;
            background-color: white; user-select: none;
        }
        .word-bank-word.selected { outline: 2px solid #6366f1; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; }
        .gap.correct .word-bank-word { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .gap.incorrect .word-bank-word { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Feedback Message & Badge Notification */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #fde047, #f97316); }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 20px; } to { opacity: 0; bottom: 0; } }

        /* Certificate Canvas */
        #completion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* Progress Bar */
        #progress-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 8px; width: 100%; margin-top: 8px; }
        #progress-bar { height: 100%; width: 0%; background-color: #38bdf8; transition: width 0.5s ease-out; }
        
        /* Vocab Game Timer */
        #vocab-game-timer-bar { height: 6px; background-color: #38bdf8; transition: width 0.1s linear; }
        
        /* Shake Animation for incorrect answers */
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        .explanation-text {
            margin-top: 12px;
            padding: 10px;
            background-color: #f3f4f6;
            border-left: 4px solid #f59e0b;
            font-size: 0.9em;
            color: #4b5563;
            border-radius: 4px;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #certificate-to-print, #certificate-to-print * { visibility: visible; }
            #certificate-to-print { position: absolute; left: 0; top: 0; width: 100%; }
        }

        /* Floating Emoji / Moving critters styles */
        #emoji-floating-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 40; /* above content, below nav z-50 */
        }
        .floating-emoji {
            position: absolute;
            font-size: 28px;
            will-change: transform, opacity;
            white-space: nowrap;
            user-select: none;
            opacity: 0;
            display: inline-block;
            text-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        @keyframes floatAcross {
            0% { transform: translateX(-10vw); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateX(110vw); opacity: 0; }
        }
        @keyframes bob {
            0% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }
        @keyframes slowRotate {
            0% { transform: rotate(-6deg); }
            50% { transform: rotate(6deg); }
            100% { transform: rotate(-6deg); }
        }
        .floating-emoji.turtle {
            font-size: 38px;
            animation-name: floatAcross;
            animation-timing-function: linear;
            animation-iteration-count: 1;
        }
        .floating-emoji.turtle .inner { animation: bob 3s ease-in-out infinite; display:inline-block; }
        .floating-emoji.lizard {
            font-size: 34px;
            animation-name: floatAcross;
            animation-timing-function: linear;
            animation-iteration-count: 1;
        }
        .floating-emoji.lizard .inner { animation: slowRotate 4s ease-in-out infinite; display:inline-block; transform-origin: center; }
        /* slightly smaller for scenic emojis */
        .floating-emoji.scenic { font-size: 30px; animation-name: floatAcross; animation-timing-function: linear; animation-iteration-count: 1; }
    </style>
</head>
<body class="antialiased text-gray-800 text-lg">
    <canvas id="background-canvas"></canvas>
    <div id="reward-animation-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]"></div>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-md mx-auto bg-white/90 backdrop-blur-sm shadow-lg rounded-full p-2">
            <div class="flex justify-center items-center gap-2">
                <button onclick="goBack()" class="nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="font-bold text-base text-sky-500 px-3 whitespace-nowrap">Points üß¨: <span id="score-display">0</span></div>
                <button onclick="navigateTo('main-menu')" class="nav-button bg-gray-800 text-white font-bold p-2 rounded-full hover:bg-gray-900">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 [...]
                </button>
                <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-full hover:bg-gray-200" title="Toggle Sound">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 [...]
                </button>
                <button onclick="goNext()" class="nav-button bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
        </div>
    </header>

    <!-- Floating emoji container (scenic icons + moving critters) -->
    <div id="emoji-floating-container" aria-hidden="true"></div>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <section id="page-title-screen" class="page active text-center bg-white rounded-2xl shadow-lg p-8">
            <div class="h-full flex flex-col justify-center items-center">
                <h1 id="main-title" class="text-5xl md:text-6xl font-bold text-slate-800 mb-4"></h1>
                <p id="main-subtitle" class="text-xl md:text-2xl text-gray-600 mb-8"></p>
                <div id="main-svg-container" class="rounded-lg mb-8 w-full max-w-lg mx-auto"></div>
                <button onclick="startApp()" class="action-button bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-2xl hover:bg-blue-700">START LESSON</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION (UNIT 6: GAL√ÅPAGOS ISLANDS) ---
        // ===================================================================================
        const lessonData = {
            title: "The Gal√°pagos Islands",
            subtitle: "A Living Laboratory of Evolution <span aria-hidden='true'>üê¢</span>",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-tps', text: '0. Think-Pair-Share <span aria-hidden="true">üß†</span>', color: 'green', target: 'tps-start' },
                { id: 'menu-goals', text: '1. Learning Goals <span aria-hidden="true">üéØ</span>', color: 'teal', target: 'learning-goals' },
                { id: 'menu-warmup', text: '2. Warm-Up & Vocab <span aria-hidden="true">üìö</span>', color: 'sky', target: 'warm-up' },
                { id: 'menu-vocab-game', text: 'Vocab Game <span aria-hidden="true">üéÆ</span>', color: 'sky', target: 'vocab-game'},
                { id: 'menu-reading', text: '3. Reading & Comprehension <span aria-hidden="true">üìñ</span>', color: 'blue', target: 'reading-main' },
                { id: 'menu-convo', text: '4. Conversation Practice <span aria-hidden="true">üó£Ô∏è</span>', color: 'indigo', target: 'conversation-practice' },
                { id: 'menu-lecture1', text: '5. Listening: Lecture <span aria-hidden="true">üßë‚Äçüè´</span>', color: 'amber', target: 'lecture-uni' },
                { id: 'menu-lecture2', text: '6. Listening: Expert Talk <span aria-hidden="true">üéôÔ∏è</span>', color: 'orange', target: 'lecture-expert' },
                { id: 'menu-podcast1', text: '7. Listening: Podcast <span aria-hidden="true">üéß</span>', color: 'lime', target: 'podcast-convo' },
                { id: 'menu-podcast2', text: '8. Listening: Sustainable Futures <span aria-hidden="true">üèôÔ∏è</span>', color: 'emerald', target: 'podcast-futures' },
                { id: 'menu-debate', text: '9. Discussion: Tourism Debate <span aria-hidden="true">ü§î</span>', color: 'rose', target: 'debate-planning' },
                { id: 'menu-dilemma', text: '10. Bonus: Ethical Dilemma <span aria-hidden="true">‚ö†Ô∏è</span>', color: 'red', target: 'dilemma-ethics' },
                { id: 'menu-thinking', text: '11. Thinking & Exam Prep <span aria-hidden="true">üìù</span>', color: 'purple', target: 'thinking-prompts' },
                { id: 'menu-final', text: '12. Final Project <span aria-hidden="true">‚úçÔ∏è</span>', color: 'violet', target: 'final-project-hub' },
            ],
            vocabulary: [
                { word: 'Evolution', def: 'The process by which living things gradually change over millions of years.', sentence: 'The theory of evolution helps us understand how life on Earth develo[...]
                { word: 'Adaptation', def: 'A change in a plant or animal that makes it better able to live in a particular place.', sentence: 'A giraffe\'s long neck is an adaptation for reaching lea[...]
                { word: 'Endemic', def: 'A plant or animal that is native to a single location and not found anywhere else.', sentence: 'The giant panda is endemic to China.' },
                { word: 'Archipelago', def: 'A large group or chain of islands.', sentence: 'Japan is a large archipelago in East Asia.' },
                { word: 'Marine Iguana', def: 'The world\'s only lizard that swims and feeds in the ocean.', sentence: 'The marine iguana <span aria-hidden="true">ü¶é</span> is a famous endemic anima[...]
                { word: 'Giant Tortoise', def: 'A very large species of tortoise, famous for its long lifespan.', sentence: 'The giant tortoise <span aria-hidden="true">üê¢</span> can live for over 1[...]
                { word: 'Natural Selection', def: 'The process where organisms with favorable traits are more likely to survive and reproduce.', sentence: 'Through natural selection, animals become be[...]
                { word: 'Volcanic', def: 'Relating to or produced by a volcano.', sentence: 'The islands were formed by volcanic activity millions of years ago.' },
                { word: 'Biodiversity Hotspot', def: 'A region with a very high level of biodiversity that is under threat.', sentence: 'The mountains of Southwest China are a major biodiversity hotsp[...]
                { word: 'Invasive Species', def: 'Plants or animals that are not native to an ecosystem and cause harm.', sentence: 'Invasive species are a major threat to the local ecosystem.' }
            ],
            pages: [
                // 0. Think Pair Share
                { id: 'tps-start', type: 'simple', content: { title: 'Activity: Think-Pair-Share <span aria-hidden="true">üß†</span>', text: 'Let\'s explore the idea of adaptation.' } },
                { id: 'tps-think', type: 'timer', content: { title: '1. Think <span aria-hidden="true">ü§î</span>', text: 'Think of an animal perfectly suited for its environment (e.g., a polar bear [...]
                { id: 'tps-pair', type: 'timer', content: { title: '2. Pair <span aria-hidden="true">üë•</span>', text: 'With a partner, discuss how an animal might change over thousands of years if [...]
                { id: 'tps-share', type: 'timer', content: { title: '3. Share <span aria-hidden="true">üó£Ô∏è</span>', text: 'As a class, let\'s discuss the meaning of the word "adaptation." How do l[...]
                
                // 1. Learning Goals
                { id: 'learning-goals', type: 'html-content', content: { title: 'Learning Goals <span aria-hidden="true">üéØ</span>', html: `
                                <div class="text-left space-y-4">
                                    <p><strong class="text-teal-600">Learning Intention:</strong> We are learning to analyze how the unique environment of the Gal√°pagos Islands led to the theory of e[...]
                                    <hr class="my-4">
                                    <h3 class="text-2xl font-bold text-teal-600 mb-3">Success Criteria</h3>
                                    <ul class="list-disc list-inside space-y-2 text-xl">
                                        <li>I can explain the theory of <strong>natural selection</strong> using a Gal√°pagos animal as an example.</li>
                                        <li>I can define <strong>endemic</strong> species and identify at least two from the Gal√°pagos.</li>
                                        <li>I can evaluate the major threats facing the Gal√°pagos <strong>ecosystem</strong>, such as <strong>invasive species</strong> and tourism.</li>
                                    </ul>
                                </div>` } },
                
                // 2. Warm-Up & Vocab
                { id: 'warm-up', type: 'html-content', content: { title: 'Warm-Up Questions <span aria-hidden="true">üìö</span>', html: `
                                <ol class="list-decimal list-inside space-y-4 text-xl text-left">
                                    <li>China is the only place in the world you can find giant pandas in the wild. The Gal√°pagos Islands are the only place you can find marine iguanas. Why do you th[...]
                                    <li>The animals on the Gal√°pagos are famous for having no fear of humans. Why do you think this might be?</li>
                                    <li>A visitor's footprint can damage the fragile environment. What rules do you think should be in place for tourists visiting a special place like this?</li>
                                </ol>` } },
                { id: 'vocab-start', type: 'simple', content: { title: 'Unit Vocabulary <span aria-hidden="true">üìö</span>', text: 'Let\'s learn the key terms for this unit. Click the "Next" arrow t[...]
                { id: 'vocab-game', type: 'vocab-game', content: { title: 'Vocabulary Review Game <span aria-hidden="true">üéÆ</span>'} },
                
                // 3. Reading & Comprehension
                { id: 'reading-main', type: 'html-content', content: { title: 'Reading: The Enchanted Islands <span aria-hidden="true">üìñ</span>', html: `
                                <div class="space-y-6 text-left">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h4 class="font-bold text-xl text-blue-800">Text 1: A Special Group of Islands</h4>
                                        <p>The Gal√°pagos Islands are a special group of islands that belong to Ecuador. They are famous for having many unique animals that are not found anywhere else[...]
                                    </div>
                                    <div class="bg-yellow-50 p-4 rounded-lg">
                                        <h4 class="font-bold text-xl text-yellow-800">Text 2: A World Apart</h4>
                                        <p>The Gal√°pagos are a <strong>volcanic</strong> <strong>archipelago</strong> about 1,000 kilometers from the coast of South America. This isolation is the key[...]
                                    </div>
                                    <div class="bg-red-50 p-4 rounded-lg">
                                        <h4 class="font-bold text-xl text-red-800">Text 3: A Laboratory Under Threat</h4>
                                        <p>The Gal√°pagos Islands are a living laboratory of <strong>evolution</strong> and a famous <strong>biodiversity hotspot</strong>. Darwin‚Äôs theory of <strong[...]
                                    </div>
                                </div>` } },
                { id: 'reading-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap Fill', sentences: [] } },
                { id: 'reading-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False/Not Given', questions: [] } },
                { id: 'reading-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [] } },
                
                // 4. Conversation Practice
                { id: 'conversation-practice', type: 'dialogue', content: { title: 'Conversation Practice <span aria-hidden="true">üó£Ô∏è</span>', dialogue: "Mei: Look over there! It's a blue-footed [...]
                
                // 5. Listening: Lecture
                { id: 'lecture-uni', type: 'dialogue', content: { title: 'Listening: University Lecture <span aria-hidden="true">üßë‚Äçüè´</span>', dialogue: "Professor Wang: Good morning. Today, we[...]
                { id: 'lecture-uni-quiz-mcq', type: 'quiz-mcq', content: { title: 'Lecture Quiz (MCQ)', questions: [] } },
                { id: 'lecture-uni-quiz-tfng', type: 'quiz-tfng', content: { title: 'Lecture Quiz (TFNG)', questions: [] } },
                { id: 'lecture-uni-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Lecture Quiz (Gap Fill)', sentences: [] } },
                
                // 6. Listening: Expert Talk
                { id: 'lecture-expert', type: 'dialogue', content: { title: 'Listening: Expert Talk <span aria-hidden="true">üéôÔ∏è</span>', dialogue: "Host 1: Welcome to 'Science Spotlight'. Today w[...]
                { id: 'lecture-expert-quiz-mcq', type: 'quiz-mcq', content: { title: 'Expert Talk Quiz (MCQ)', questions: [] } },
                { id: 'lecture-expert-quiz-tfng', type: 'quiz-tfng', content: { title: 'Expert Talk Quiz (TFNG)', questions: [] } },
                { id: 'lecture-expert-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Expert Talk Quiz (Gap Fill)', sentences: [] } },

                // 7. Listening: Podcast
                { id: 'podcast-convo', type: 'dialogue', content: { title: 'Listening: Podcast <span aria-hidden="true">üéß</span>', dialogue: "Host 1: Welcome back to 'Planet Wonders'! Today, we're [...]
                { id: 'podcast-convo-quiz-mcq', type: 'quiz-mcq', content: { title: 'Podcast Quiz (MCQ)', questions: [] } },
                { id: 'podcast-convo-quiz-tfng', type: 'quiz-tfng', content: { title: 'Podcast Quiz (TFNG)', questions: [] } },
                { id: 'podcast-convo-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Podcast Quiz (Gap Fill)', sentences: [] } },
                
                // 8. Listening: Sustainable Futures
                { id: 'podcast-futures', type: 'dialogue', content: { title: 'Listening: Sustainable Futures <span aria-hidden="true">üèôÔ∏è</span>', dialogue: "Narrator: The future of the Gal√°pagos[...]
                { id: 'podcast-futures-quiz-mcq', type: 'quiz-mcq', content: { title: 'Podcast Quiz (MCQ)', questions: [] } },
                { id: 'podcast-futures-quiz-tfng', type: 'quiz-tfng', content: { title: 'Podcast Quiz (TFNG)', questions: [] } },
                { id: 'podcast-futures-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Podcast Quiz (Gap Fill)', sentences: [] } },

                // 9. Discussion: Tourism Debate
                { id: 'debate-planning', type: 'dialogue', content: { title: 'Discussion: Tourism Debate <span aria-hidden="true">ü§î</span>', dialogue: "Moderator: Welcome. Today's topic: To truly p[...]
                { id: 'debate-planning-quiz-mcq', type: 'quiz-mcq', content: { title: 'Debate Quiz (MCQ)', questions: [] } },
                { id: 'debate-planning-quiz-tfng', type: 'quiz-tfng', content: { title: 'Debate Quiz (TFNG)', questions: [] } },
                { id: 'debate-planning-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Debate Quiz (Gap Fill)', sentences: [] } },

                // 10. Bonus: Ethical Dilemma
                { id: 'dilemma-ethics', type: 'dialogue', content: { title: 'Bonus: Ethical Dilemma <span aria-hidden="true">‚ö†Ô∏è</span>', dialogue: "Guide: Imagine this situation. While on a tour, [...]
                { id: 'dilemma-ethics-quiz-mcq', type: 'quiz-mcq', content: { title: 'Dilemma Quiz (MCQ)', questions: [] } },
                { id: 'dilemma-ethics-quiz-tfng', type: 'quiz-tfng', content: { title: 'Dilemma Quiz (TFNG)', questions: [] } },
                { id: 'dilemma-ethics-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Dilemma Quiz (Gap Fill)', sentences: [] } },

                // 11. Thinking & Exam Prep
                { id: 'thinking-prompts', type: 'html-content', content: { title: 'Thinking & Exam Prep <span aria-hidden="true">üìù</span>', html: `
                                <div class="text-left">
                                    <h3 class="text-2xl font-bold text-purple-600 mb-3">Higher-Order Thinking Questions</h3>
                                    <ul class="list-disc list-inside space-y-2 text-lg">
                                        <li><b>Analyzing:</b> Compare the threats posed by <strong>invasive species</strong> to the threats posed by tourism. Which do you think is harder to control?</[...]
                                        <li><b>Evaluating:</b> Do you believe Charles Darwin would be pleased or horrified by the state of the Gal√°pagos today? Justify your answer.</li>
                                        <li><b>Creating:</b> Imagine you are creating a new rule for tourists visiting a nature reserve in China. Based on what you learned about the Gal√°pagos, what r[...]
                                    </ul>
                                </div>` } },
                { id: 'exam-practice', type: 'html-content', content: { title: 'IELTS & TOEFL Practice', html: `
                                <div class="space-y-6 text-left">
                                    <div>
                                        <h3 class="text-2xl font-bold text-purple-600 mb-3">IELTS Speaking Practice</h3>
                                        <p><b>Part 2 (Cue Card):</b> Describe a time you saw a rare or interesting animal. You should say: what the animal was, where you saw it, what it was doing, and[...]
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold text-purple-600 mb-3">TOEFL Independent Speaking</h3>
                                        <p>"Protecting endangered animals is the responsibility of the country they live in, not the whole world." Do you agree or disagree?</p>
                                    </div>
                                </div>` } },

                // 12. Final Project
                { id: 'final-project-hub', type: 'html-content', content: { title: 'Final Project Hub <span aria-hidden="true">‚úçÔ∏è</span>', html: `
                                <div class="bg-white rounded-2xl shadow-xl p-8 text-left">
                                <h2 class="text-3xl font-bold text-violet-600 mb-4">GRASPS Task: The Gal√°pagos Guardian Campaign</h2>
                                <div class="space-y-3 text-lg">
                                    <p><strong class="font-semibold text-violet-700">Goal:</strong> To create a new public awareness campaign to educate visitors and combat a specific threat to the is[...]
                                    <p><strong class="font-semibold text-violet-700">Role:</strong> You are a team of conservationists and communication experts from the Charles Darwin Foundation.</p>
                                    <p><strong class="font-semibold text-violet-700">Audience:</strong> Future tourists planning a trip to the Gal√°pagos Islands.</p>
                                    <p><strong class="font-semibold text-violet-700">Situation:</strong> Despite current efforts, threats from human activity persist. Your team must choose ONE specifi[...]
                                    <p><strong class="font-semibold text-violet-700">Product:</strong> A digital campaign toolkit that includes: 1) A slogan and poster, 2) A new visitor pledge to sign[...]
                                    <p><strong class="font-semibold text-violet-700">Standards:</strong> Your campaign will be judged on its clarity, persuasiveness, creativity, and its potential to g[...]
                                </div>
                                <div class="mt-8">
                                    <h3 class="text-2xl font-bold text-violet-600 mb-3">My Field Notes <span aria-hidden="true">üìì</span></h3>
                                    <textarea id="field-notes" class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Jot down your ideas, key vocabula[...]
                                </div>
                                </div>` } },
                { id: 'writing-task', type: 'writing-task', content: { 
                    title: 'Project Writing Activity <span aria-hidden="true">‚úçÔ∏è</span>', 
                    prompt: 'Write a persuasive paragraph (150-200 words) for your "Gal√°pagos Guardian" campaign poster. Explain why protecting the islands from your chosen threat (e.g., invasive spe[...]
                    starters: [
                        "The Gal√°pagos Islands are more than just a place; they are a living treasure...",
                        "One of the greatest dangers facing this unique ecosystem is...",
                        "By taking simple, responsible actions, we can...",
                        "Join us in protecting this irreplaceable laboratory of evolution for future generations..."
                    ],
                    wordBank: ['evolution', 'adaptation', 'endemic', 'ecosystem', 'invasive species', 'conservation', 'biodiversity', 'fragile', 'protect', 'future', 'unique', 'threat', 'responsible']
                } },
                { id: 'self-assessment', type: 'html-content', content: { title: 'Self-Assessment <span aria-hidden="true">üßë‚Äçüè´</span>', html: `
                                <div class="text-left">
                                    <h3 class="text-2xl font-bold text-purple-600 mb-3">Metacognitive Self-Assessment</h3>
                                    <ol class="list-decimal list-inside space-y-4 text-xl">
                                        <li>‚ÄúWhat was the most challenging part of this lesson for me, and what strategy did I use to overcome it?‚Äù</li>
                                        <li>‚ÄúHow confident do I feel now about explaining the concept of evolution using the Gal√°pagos as an example? (Scale of 1-5). What do I need to practice more[...]
                                    </ol>
                                </div>` } },
                { id: 'certificate', type: 'certificate', content: { title: 'Module Complete! <span aria-hidden="true">üéâ</span>', text: 'You have successfully completed the "A Living Laboratory" mo[...]
            ]
        };
        // --- END OF LESSON CONTENT CONFIGURATION ---
        // ===================================================================================

        class SpeechService {
             constructor() { this.synth = window.speechSynthesis; this.isInitialized = false; this.isTtsEnabled = true; this.voices = {}; this.speechRate = 0.85; this.isDialoguePlaying = false; }
             async _setupVoices() {
                 const voicesPromise = new Promise(resolve => { if (this.synth.getVoices().length) return resolve(this.synth.getVoices()); this.synth.onvoiceschanged = () => resolve(this.synth.getVoic[...]
                 const availableVoices = await voicesPromise;
                 if (!availableVoices.length) { console.warn("No speech synthesis voices available."); return; }
                 const speakerToVoiceMap = {
                     'mei': ['Microsoft Emma Online (Natural) - English (United States)', 'Microsoft Ava Online (Natural) - English (United States)'],
                     'leo': ['Microsoft Brian Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)'],
                     'professor wang': ['Microsoft Brian Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)'],
                     'dr. elena cruz': ['Microsoft Ava Online (Natural) - English (United States)', 'Microsoft Emma Online (Natural) - English (United States)'],
                     'host 1': ['Microsoft Emma Online (Natural) - English (United States)'],
                     'host 2': ['Microsoft Andrew Online (Natural) - English (United States)'],
                     'narrator': ['Microsoft Brian Online (Natural) - English (United States)'],
                     'moderator': ['Microsoft Brian Online (Natural) - English (United States)'],
                     'maria': ['Microsoft Ava Online (Natural) - English (United States)'],
                     'carlos': ['Microsoft Andrew Online (Natural) - English (United States)'],
                     'guide': ['Microsoft Andrew Online (Natural) - English (United States)'],
                     'student 1': ['Microsoft Emma Online (Natural) - English (United States)'],
                     'student 2': ['Microsoft Brian Online (Natural) - English (United States)'],
                 };
                 for (const speaker in speakerToVoiceMap) {
                     const voicePriorityList = speakerToVoiceMap[speaker];
                     let chosenVoice = null;
                     for (const voiceName of voicePriorityList) {
                         const foundVoice = availableVoices.find(v => v.name === voiceName);
                         if (foundVoice) { chosenVoice = foundVoice; break; }
                     }
                     if (chosenVoice) { this.voices[speaker] = chosenVoice; } else { console.warn(`Could not find specified voices for speaker: "${speaker}"`); }
                 }
                 this.voices['default'] = availableVoices.find(v => v.name === 'Microsoft Ava Online (Natural) - English (United States)') || availableVoices.find(v => v.lang === 'en-US');
             }
             async init() { if (this.isInitialized) return; try { const warmUp = new SpeechSynthesisUtterance(' '); warmUp.volume = 0; this.synth.speak(warmUp); this.synth.cancel(); await this._setupV[...]
             _cleanTextForSpeech(text) { const tempDiv = document.createElement('div'); const textWithoutSpans = text.replace(/<span aria-hidden="true">.*?<\/span>/g, ' '); tempDiv.innerHTML = textWit[...]
             async speak(text, { onEndCallback = null } = {}) { if (!this.isInitialized || !this.isTtsEnabled || !text) { if (onEndCallback) onEndCallback(); return; } if (this.synth.speaking) { this.[...]
             async speakDialogue(text) { if (!this.isInitialized || !this.isTtsEnabled || !text || this.isDialoguePlaying) return; this.cancel(); this.isDialoguePlaying = true; const lines = text.spli[...]
             cancel() { if (this.synth) { this.isDialoguePlaying = false; this.synth.cancel(); } }
             toggleTTS(forceState) { this.isTtsEnabled = forceState === undefined ? !this.isTtsEnabled : forceState; if (!this.isTtsEnabled) { this.cancel(); } return this.isTtsEnabled; }
         }

        // --- Global App State and Functions ---
        const speechService = new SpeechService();
        let score = 0, currentPage = lessonData.startPageId, timerInterval;
        const pageHistory = [lessonData.startPageId];
        let pageSequence = [];
        let completedSections = new Set();
        let vocabGameTimer;

        // --- Progress and Completion Logic ---
        const pageToMenuMap = {};
        function buildPageToMenuMap() {
            lessonData.mainMenu.forEach(menuItem => {
                let queue = [menuItem.target];
                let visited = new Set(queue);
                while (queue.length > 0) {
                    const pageId = queue.shift();
                    pageToMenuMap[pageId] = menuItem.id;
                    const pageDef = lessonData.pages.find(p => p.id === pageId);
                    if (pageDef && pageDef.type.startsWith('quiz')) {
                        const nextQuizPage = getNextQuizPage(pageId);
                        if (nextQuizPage && !visited.has(nextQuizPage)) {
                            queue.push(nextQuizPage);
                            visited.add(nextQuizPage);
                        }
                    }
                }
            });
            // Manual mapping for vocab game
            pageToMenuMap['vocab-game'] = 'menu-vocab-game';
        }

        function getNextQuizPage(pageId) {
            const sequence = ['mcq', 'tfng', 'gap-fill'];
            const parts = pageId.split('-quiz-');
            if (parts.length < 2) return null;
            const prefix = parts[0];
            const type = parts[1];
            const currentIndex = sequence.indexOf(type);
            if (currentIndex > -1 && currentIndex < sequence.length - 1) {
                return `${prefix}-quiz-${sequence[currentIndex + 1]}`;
            }
            return null;
        }

        function updateProgressBar() {
            const progress = (completedSections.size / lessonData.mainMenu.length) * 100;
            const bar = document.getElementById('progress-bar');
            if (bar) bar.style.width = `${progress}%`;
        }

        function updateMenuCompletionState() {
            const menuContainer = document.getElementById('page-main-menu');
            if (!menuContainer) return;
            lessonData.mainMenu.forEach(item => {
                const button = menuContainer.querySelector(`#menu-btn-${item.id}`);
                if (button && completedSections.has(item.id)) {
                    if (!button.innerHTML.includes('‚úì')) {
                        button.innerHTML += ' <span class="text-green-300">‚úì</span>';
                    }
                }
            });
        }

        function markSectionAsComplete(pageId) {
            const menuId = pageToMenuMap[pageId];
            if (menuId && !completedSections.has(menuId)) {
                completedSections.add(menuId);
                updateProgressBar();
            }
        }
        
        function checkQuizPageCompletion(pageId) {
            const pageElement = document.getElementById(`page-${pageId}`);
            if (!pageElement) return false;

            if (pageId.includes('gap-fill')) {
                const gaps = pageElement.querySelectorAll('.gap');
                return gaps.length > 0 && Array.from(gaps).every(g => g.classList.contains('correct'));
            } else {
                const questions = pageElement.querySelectorAll('.question-group');
                return questions.length > 0 && Array.from(questions).every(q => q.querySelector('button:disabled'));
            }
        }


        // --- App Navigation ---
        window.toggleTTS = (button) => {
            const isNowEnabled = speechService.toggleTTS();
            const iconPath = isNowEnabled 
                ? "M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"
                : "M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z M17 14l-4-4m0 4l4-4";
            button.querySelector('svg').classList.toggle('text-gray-600', isNowEnabled);
            button.querySelector('svg').classList.toggle('text-gray-400', !isNowEnabled);
            button.querySelector('path').setAttribute('d', iconPath);

            if (isNowEnabled) {
                const pageData = lessonData.pages.find(p => p.id === currentPage);
                const targetPage = document.getElementById(`page-${currentPage}`);
                if (pageData && pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else if (targetPage) {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    if (readableContent) speechService.speak(readableContent.innerText);
                    else if (titleElement) speechService.speak(titleElement.innerText);
                }
            }
        };

        window.startApp = async function() {
            await speechService.init(); 
            try { await Tone.start(); } catch (e) { console.error(e); }
            navigateTo(lessonData.homePageId);
        }
        
        function startTimer(duration, display, onComplete) {
            let timer = duration;
            const update = () => { display.textContent = `${String(Math.floor(timer/60)).padStart(2,'0')}:${String(timer%60).padStart(2,'0')}`; };
            update();
            timerInterval = setInterval(() => { timer--; update(); if (timer < 0) { clearInterval(timerInterval); if (onComplete) onComplete(); } }, 1000);
        }

        window.navigateTo = (pageId) => {
            const previousPageId = currentPage;
            
            // Mark completion if leaving a quiz page and it's fully answered
            if (previousPageId.includes('-quiz-')) {
                if (checkQuizPageCompletion(previousPageId)) {
                    markSectionAsComplete(previousPageId);
                }
            }
            
            const targetPage = document.getElementById(`page-${pageId}`);
            if (!targetPage) return console.warn('navigateTo: no page found for id', pageId);
            if (pageId === currentPage) return;
            
            clearInterval(timerInterval);
            clearTimeout(vocabGameTimer);
            speechService.cancel();

            // Mark simple pages as complete on navigation
            const previousPageDef = lessonData.pages.find(p => p.id === previousPageId);
            if (previousPageDef && !previousPageDef.type.startsWith('quiz') && previousPageId !== 'vocab-game') {
                 markSectionAsComplete(previousPageId);
            }

            document.getElementById(`page-${currentPage}`)?.classList.remove('active');
            targetPage.classList.add('active');
            currentPage = pageId;
            if (pageHistory[pageHistory.length - 1] !== currentPage) pageHistory.push(currentPage);
            
            const pageData = lessonData.pages.find(p => p.id === pageId);
            if (pageData) {
                if (pageData.type === 'timer') {
                    const timerEl = document.getElementById(pageData.content.timerId);
                    if (timerEl) startTimer(pageData.content.duration, timerEl, goNext);
                } else if (pageData.type === 'vocab-game') {
                    startVocabGame();
                }
                
                if (pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    const contentToSpeak = readableContent ? readableContent.innerText : (titleElement ? titleElement.innerText : '');
                    speechService.speak(contentToSpeak);
                }
            } else if (pageId === lessonData.homePageId) {
                speechService.speak(targetPage.querySelector('h2').innerText);
                updateMenuCompletionState();
            }
            updateNavButtons();
            window.scrollTo(0, 0);
        }

        window.goNext = () => { const currentIndex = pageSequence.indexOf(currentPage); if (currentIndex > -1 && currentIndex < pageSequence.length - 1) navigateTo(pageSequence[currentIndex + 1]); }
        window.goBack = () => { if (pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); } }

        function updateNavButtons() {
            const nav = document.getElementById('nav-header');
            if (!nav) return;
            nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
            const backBtn = nav.querySelector('button:first-child');
            backBtn.disabled = pageHistory.length <= 1;
            backBtn.classList.toggle('opacity-50', backBtn.disabled);
            const nextBtn = nav.querySelector('button:last-child');
            const currentIndex = pageSequence.indexOf(currentPage);
            const isLast = currentIndex >= pageSequence.length - 1;
            nextBtn.disabled = isLast || currentPage === lessonData.homePageId;
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }
        
        function showFeedbackMessage(isCorrect) {
            const correctFeedback = ["That's right!", "Excellent!", "Perfect!", "Great job!"];
            const incorrectFeedback = ["Not quite.", "Keep trying!", "Almost there."];
            const message = isCorrect ? correctFeedback[Math.floor(Math.random() * correctFeedback.length)] : incorrectFeedback[Math.floor(Math.random() * incorrectFeedback.length)];
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `feedback-toast ${isCorrect ? 'correct' : 'encouraging'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function updateScore(points) { score += points; document.getElementById('score-display').textContent = score; }

        function checkCompletionAndMark() {
            if(checkQuizPageCompletion(currentPage)) {
                markSectionAsComplete(currentPage);
            }
        }

        window.checkTfngAnswer = function(clickedButton, chosenAnswer, correctAnswer) {
            const buttonContainer = clickedButton.parentElement;
            Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
            const isCorrect = chosenAnswer === correctAnswer;
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                updateScore(10);
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-green-500');
            } else {
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-red-600');
                const correctBtn = Array.from(buttonContainer.children).find(btn => btn.textContent === correctAnswer.charAt(0));
                if (correctBtn) correctBtn.className = correctBtn.className.replace(/bg-\w+-500/, 'bg-green-500');
            }
            setTimeout(checkCompletionAndMark, 100);
        }
        
        window.checkMcqAnswer = function(button, isCorrect) {
            const questionGroup = button.closest('.question-group');
            questionGroup.querySelectorAll('.quiz-option').forEach(opt => opt.disabled = true);
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                updateScore(10);
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'border-green-600', 'text-white');
            } else {
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'border-red-600', 'text-white', 'shake');
                const correctButton = questionGroup.querySelector(".quiz-option[data-correct='true']");
                if (correctButton) {
                    correctButton.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    correctButton.classList.add('bg-green-500', 'border-green-600', 'text-white');
                }
            }
            setTimeout(checkCompletionAndMark, 100);
        }

        function initGapFill(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return;
            const gaps = page.querySelectorAll('.gap');
            const words = page.querySelectorAll('.word-bank-word');
            const wordBank = page.querySelector('.word-bank-container');

            words.forEach(word => {
                word.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', word.dataset.word); });
                word.addEventListener('click', handleWordClick);
            });
            gaps.forEach(gap => {
                gap.addEventListener('dragover', e => e.preventDefault());
                gap.addEventListener('drop', e => handleDrop(e, gap));
                gap.addEventListener('click', handleGapClick);
            });

            function handleWordClick(e) {
                const clickedWord = e.currentTarget;
                if (clickedWord.parentElement.classList.contains('gap')) { wordBank.appendChild(clickedWord); return; }
                if (selectedWord.element) selectedWord.element.classList.remove('selected');
                if (selectedWord.element === clickedWord) { selectedWord = { element: null, text: '' }; } 
                else { selectedWord = { element: clickedWord, text: clickedWord.dataset.word }; clickedWord.classList.add('selected'); }
            }
            function handleGapClick(e) {
                const clickedGap = e.currentTarget;
                if (!selectedWord.element || clickedGap.children.length > 0) return;
                clickedGap.appendChild(selectedWord.element);
                checkGap(clickedGap);
                selectedWord.element.classList.remove('selected');
                selectedWord = { element: null, text: '' };
            }
            function handleDrop(e, gap) {
                e.preventDefault();
                if (gap.children.length > 0) return;
                const wordText = e.dataTransfer.getData('text/plain');
                const wordElement = page.querySelector(`.word-bank-word[data-word="${wordText}"]`);
                if (wordElement) { gap.appendChild(wordElement); checkGap(gap); }
            }
            function checkGap(gap) {
                const word = gap.querySelector('.word-bank-word');
                const isCorrect = word && word.dataset.word.toLowerCase() === gap.dataset.answer.toLowerCase();
                gap.classList.toggle('correct', isCorrect);
                gap.classList.toggle('incorrect', !isCorrect);
                if (isCorrect) { updateScore(10); showFeedbackMessage(true); } else { showFeedbackMessage(false); }
                setTimeout(checkCompletionAndMark, 100);
            }
        }

        // --- Vocab Game Logic ---
        let vocabGameQuestions = [];
        let vocabGameCurrentIndex = 0;
        let vocabGameScore = 0;
        const ROUND_TIME = 10000; // 10 seconds

        function startVocabGame() {
            vocabGameQuestions = [...lessonData.vocabulary].sort(() => 0.5 - Math.random());
            vocabGameCurrentIndex = 0;
            vocabGameScore = 0;
            document.getElementById('vocab-game-score').textContent = '0';
            nextVocabGameRound();
        }

        function nextVocabGameRound() {
            if (vocabGameCurrentIndex >= vocabGameQuestions.length) {
                endVocabGame();
                return;
            }
            
            const question = vocabGameQuestions[vocabGameCurrentIndex];
            document.getElementById('vocab-game-definition').textContent = question.def;
            
            const options = [question.word];
            const wrongAnswers = lessonData.vocabulary.filter(v => v.word !== question.word);
            while (options.length < 4) {
                const randomWrong = wrongAnswers.splice(Math.floor(Math.random() * wrongAnswers.length), 1)[0];
                options.push(randomWrong.word);
            }
            
            const optionsContainer = document.getElementById('vocab-game-options');
            optionsContainer.innerHTML = '';
            options.sort(() => 0.5 - Math.random()).forEach(opt => {
                const button = document.createElement('button');
                button.className = 'quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200';
                button.textContent = opt;
                button.onclick = () => checkVocabGameAnswer(button, opt === question.word);
                optionsContainer.appendChild(button);
            });

            startRoundTimer();
        }
        
        function startRoundTimer() {
            clearTimeout(vocabGameTimer);
            const timerBar = document.getElementById('vocab-game-timer-bar');
            timerBar.style.transition = 'none';
            timerBar.style.width = '100%';
            
            setTimeout(() => {
                timerBar.style.transition = `width ${ROUND_TIME / 1000}s linear`;
                timerBar.style.width = '0%';
            }, 100);

            vocabGameTimer = setTimeout(() => {
                showFeedbackMessage(false);
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, ROUND_TIME);
        }

        function checkVocabGameAnswer(button, isCorrect) {
            clearTimeout(vocabGameTimer);
            showFeedbackMessage(isCorrect);
            if (isCorrect) {
                vocabGameScore++;
                updateScore(5);
                document.getElementById('vocab-game-score').textContent = vocabGameScore;
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'text-white');
            } else {
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'text-white', 'shake');
            }
            
            const optionsContainer = document.getElementById('vocab-game-options');
            optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

            setTimeout(() => {
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, 1500);
        }

        function endVocabGame() {
            document.getElementById('vocab-game-definition').textContent = `Game Over! You scored ${vocabGameScore} out of ${vocabGameQuestions.length}.`;
            document.getElementById('vocab-game-options').innerHTML = `<button onclick="startVocabGame()" class="action-button bg-blue-500 text-white font-bold p-3 rounded-lg">Play Again</button>`;
            markSectionAsComplete('vocab-game');
        }


        function createPageElement(id, content) {
            const section = document.createElement('section');
            section.id = `page-${id}`;
            section.className = 'page';
            section.innerHTML = content;
            document.getElementById('dynamic-pages-container').appendChild(section);
        }
        
        function populateAllQuizzes() {
            // Vocab Match
            const vocabMatchPage = lessonData.pages.find(p => p.id === 'vocab-match');
            if(vocabMatchPage) {
                vocabMatchPage.content.questions = lessonData.vocabulary.map((v) => {
                    const otherDefs = lessonData.vocabulary.filter(item => item.word !== v.word).map(item => item.def);
                    const options = [v.def, ...otherDefs.sort(() => 0.5 - Math.random()).slice(0, 3)].sort(() => 0.5 - Math.random());
                    return { question: `What is the definition of "${v.word}"?`, options: options, correctAnswer: v.def };
                });
            }

            // Reading Quizzes
            const readingGapFill = lessonData.pages.find(p => p.id === 'reading-quiz-gap-fill');
            if (readingGapFill) readingGapFill.content.sentences = [ { text: ['The Gal√°pagos Islands are a volcanic', 'made up of many small islands.'], answer: 'archipelago' }, { text: ['A species t[...]
            const readingTfng = lessonData.pages.find(p => p.id === 'reading-quiz-tfng');
            if(readingTfng) readingTfng.content.questions = [ { statement: 'The Gal√°pagos Islands are located in the Atlantic Ocean.', correctAnswer: 'False' }, { statement: 'Charles Darwin was the f[...]
            const readingMcq = lessonData.pages.find(p => p.id === 'reading-quiz-mcq');
            if(readingMcq) readingMcq.content.questions = [ { question: 'What is the main reason the Gal√°pagos Islands have so many unique animals?', options: ['They have a very warm climate.', 'They[...]

            // --- ALL LISTENING QUIZZES ---
            const lectureMcq = lessonData.pages.find(p => p.id === 'lecture-uni-quiz-mcq');
            if(lectureMcq) lectureMcq.content.questions = [ { question: 'What is "adaptive radiation"?', options: ['The evolution of one species into another single species.', 'The rapid evolution of [...]
            const lectureTfng = lessonData.pages.find(p => p.id === 'lecture-uni-quiz-tfng');
            if(lectureTfng) lectureTfng.content.questions = [ { statement: 'The Gal√°pagos archipelago is very old in geological terms.', correctAnswer: 'False' }, { statement: 'The different beak sha[...]
            const lectureGap = lessonData.pages.find(p => p.id === 'lecture-uni-quiz-gap-fill');
            if(lectureGap) lectureGap.content.sentences = [ { text: ['Adaptive radiation happens when an organism enters a new environment with many available', '.'], answer: 'ecological niches' }, { [...]
            const expertMcq = lessonData.pages.find(p => p.id === 'lecture-expert-quiz-mcq');
            if(expertMcq) expertMcq.content.questions = [ { question: 'According to Dr. Cruz, what is the most immediate, destructive threat?', options: ['Oil spills', 'Climate change', 'Invasive spec[...]
            const expertTfng = lessonData.pages.find(p => p.id === 'lecture-expert-quiz-tfng');
            if(expertTfng) expertTfng.content.questions = [ { statement: 'Goats were introduced to the islands by accident.', correctAnswer: 'Not Given' }, { statement: 'The Charles Darwin Foundation [...]
            const expertGap = lessonData.pages.find(p => p.id === 'lecture-expert-quiz-gap-fill');
            if(expertGap) expertGap.content.sentences = [ { text: ['The expert describes the threat of invasive species as quiet and', '.'], answer: 'insidious' }, { text: ['The introduction of new sp[...]
            const convoMcq = lessonData.pages.find(p => p.id === 'podcast-convo-quiz-mcq');
            if(convoMcq) convoMcq.content.questions = [ { question: "Why does the marine iguana sneeze salt?", options: ['To communicate with other iguanas.', 'To clean its nose.', 'To get rid of exce[...]
            const convoTfng = lessonData.pages.find(p => p.id === 'podcast-convo-quiz-tfng');
            if(convoTfng) convoTfng.content.questions = [ { statement: "The podcast's main topic is the giant tortoise.", correctAnswer: 'False' }, { statement: 'Dr. Cruz states that marine iguanas ev[...]
            const convoGap = lessonData.pages.find(p => p.id === 'podcast-convo-quiz-gap-fill');
            if(convoGap) convoGap.content.sentences = [ { text: ['The marine iguana is the only lizard that has adapted to a', 'lifestyle.'], answer: 'marine' }, { text: ['Dr. Cruz says the iguanas ar[...]
            const futuresMcq = lessonData.pages.find(p => p.id === 'podcast-futures-quiz-mcq');
            if(futuresMcq) futuresMcq.content.questions = [ { question: 'What is the tourism model used in the Gal√°pagos called?', options: ['Low-cost, high-volume', 'High-value, low-impact', 'All-in[...]
            const futuresTfng = lessonData.pages.find(p => p.id === 'podcast-futures-quiz-tfng');
            if(futuresTfng) futuresTfng.content.questions = [ { statement: 'The park entrance fee is low to encourage more visitors.', correctAnswer: 'False' }, { statement: 'Money from tourism helps [...]
            const futuresGap = lessonData.pages.find(p => p.id === 'podcast-futures-quiz-gap-fill');
            if(futuresGap) futuresGap.content.sentences = [ { text: ['Visitor numbers to specific islands are', 'daily.'], answer: 'capped' }, { text: ["The goal is to ensure every tourist's financial[...]
            const debateMcq = lessonData.pages.find(p => p.id === 'debate-planning-quiz-mcq');
            if(debateMcq) debateMcq.content.questions = [ { question: "What is Maria's primary argument FOR reducing tourism?", options: ['It is too expensive for tourists.', 'The risk of introducing [...]
            const debateTfng = lessonData.pages.find(p => p.id === 'debate-planning-quiz-tfng');
            if(debateTfng) debateTfng.content.questions = [ { statement: 'Maria believes economic gain is more important than preservation.', correctAnswer: 'False' }, { statement: 'Carlos believes th[...]
            const debateGap = lessonData.pages.find(p => p.id === 'debate-planning-quiz-gap-fill');
            if(debateGap) debateGap.content.sentences = [ { text: ['Maria argues that the', 'of this global treasure is most important.'], answer: 'preservation' }, { text: ['Carlos argues that touris[...]
            const dilemmaMcq = lessonData.pages.find(p => p.id === 'dilemma-ethics-quiz-mcq');
            if(dilemmaMcq) dilemmaMcq.content.questions = [ { question: 'Why is touching the sea lion pup forbidden?', options: ['The pup might bite the tourist.', 'The mother may reject the pup.', 'I[...]
            const dilemmaTfng = lessonData.pages.find(p => p.id === 'dilemma-ethics-quiz-tfng');
            if(dilemmaTfng) dilemmaTfng.content.questions = [ { statement: 'The guide saw the tourist touch the pup.', correctAnswer: 'False' }, { statement: 'Student 1 prioritizes social harmony over[...]
            const dilemmaGap = lessonData.pages.find(p => p.id === 'dilemma-ethics-quiz-gap-fill');
            if(dilemmaGap) dilemmaGap.content.sentences = [ { text: ['The rule against touching is because the mother might', 'the pup.'], answer: 'reject' }, { text: ['Student 1 wants to', 'call out [...]
        }

        function initializeLesson() {
            document.getElementById('main-title').innerHTML = lessonData.title;
            document.getElementById('main-subtitle').innerHTML = lessonData.subtitle;
            document.getElementById('main-svg-container').innerHTML = `<svg viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%[...]

            populateAllQuizzes();
            buildPageToMenuMap();

            const menuButtons = lessonData.mainMenu.map(item => {
                const colors = { green: 'bg-green-500 border-green-700', blue: 'bg-blue-500 border-blue-700', sky: 'bg-sky-500 border-sky-700', amber: 'bg-amber-500 border-amber-700', rose: 'bg-rose-5[...]
                return `<button id="menu-btn-${item.id}" onclick="navigateTo('${item.target}')" class="btn-animated-3d ${colors[item.color] || colors['green']} text-white font-bold text-xl p-4 rounded[...]
            }).join('');
            createPageElement(lessonData.homePageId, `<div class="bg-white rounded-2xl shadow-lg p-8"><h2 class="text-4xl font-bold text-center text-slate-800 mb-8">Main Menu</h2><div class="grid grid[...]
            
            const pageOrderMap = { 'warm-up': ['vocab-start'], 'vocab-start': lessonData.vocabulary.map((v, i) => `vocab-${i}`), 'vocab-match':['reading-main'], 'reading-main': ['reading-quiz-gap-fill[...]
            let flatPageList = [lessonData.startPageId];
            lessonData.mainMenu.forEach(item => {
                let queue = [item.target];
                let visited = new Set();
                while(queue.length > 0) {
                    let current = queue.shift();
                    if (visited.has(current)) continue;
                    visited.add(current);
                    flatPageList.push(current);
                    if (pageOrderMap[current]) {
                        queue.push(...pageOrderMap[current]);
                    }
                }
            });
            pageSequence = [...new Set(flatPageList)];

            lessonData.vocabulary.forEach((v, i) => {
                createPageElement(`vocab-${i}`, `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h3 class="text-2xl font-bold text-sky-600 mb-2">Vocabu[...]
            });

            lessonData.pages.forEach(page => {
                let pageHTML = '';
                switch (page.type) {
                    case 'simple': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-gray-800 mb-6">${page.[...]
                    case 'timer': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-left pt-16"><div class="w-full flex justify-between items-center mb-4"><h2 class="text-2xl md:text-3xl[...]
                    case 'dialogue':
                    case 'html-content':
                        const contentHTML = page.type === 'html-content' ? page.content.html : (page.content.dialogue || '').split('\n\n').map(line => `<p>${line.replace(/([^:]+):/, '<strong class="fo[...]
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-slate-800 mb-6">${page.content.title}</h2><div class="readable-[...]
                        break;
                    case 'vocab-game':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-sky-600 mb-4">${page.content.title}</h2><div class="text-center[...]
                        break;
                    case 'writing-task':
                        const startersHTML = page.content.starters.map(s => `<li class="text-gray-500">${s}</li>`).join('');
                        const wordBankHTML = page.content.wordBank ? `<div class="mt-6"><h4 class="font-bold text-lg text-violet-600">Word Bank:</h4><div class="flex flex-wrap gap-2 mt-2 p-4 bg-gray-1[...]
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-center text-violet-700 mb-6">${page.content.t[...]
                        break;
                    case 'certificate':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16 relative overflow-hidden"><canvas id="completion-canvas"></canvas><div class="relative z-10"><div c[...]
                        break;
                    case 'quiz-tfng':
                    case 'quiz-mcq':
                    case 'quiz-gap-fill':
                        let questionsHTML = '';
                        if (page.type === 'quiz-tfng' && page.content.questions) {
                            questionsHTML = page.content.questions.map((q, i) => `<div class="question-group flex items-center gap-4 p-4 rounded-lg bg-gray-100"><div class="flex-shrink-0 flex gap-2">$[...]
                        } else if (page.type === 'quiz-mcq' && page.content.questions) {
                            questionsHTML = page.content.questions.map((q, i) => `<div class="question-group ${i > 0 ? 'border-t pt-6 mt-6' : ''}"><p class="font-semibold mb-2">${i + 1}. ${q.question}[...]
                        } else if (page.type === 'quiz-gap-fill' && page.content.sentences) {
                            const words = page.content.sentences.map(s => s.answer).sort(() => Math.random() - 0.5);
                            questionsHTML = `<div class="gap-fill-container">${page.content.sentences.map((s, i) => `<p class="text-lg mb-4">${i + 1}. ${s.text[0]} <span class="gap" data-answer="${s.a[...]
                        }
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h3 class="text-3xl font-bold text-rose-600 mb-6 text-center">${page.content.title}</h3><div class="space-y-6"[...]
                        break;
                }
                if (pageHTML) {
                    createPageElement(page.id, pageHTML);
                    if (page.type === 'quiz-gap-fill') initGapFill(`page-${page.id}`);
                }
            });
            updateNavButtons();
        }

        // ----------------------------
        // Floating emoji + moving turtles / lizards logic
        // ----------------------------
        (function setupFloatingEmojis() {
            const container = document.getElementById('emoji-floating-container');
            if (!container) return;
            const palette = ['üá™üá®','üèîÔ∏è','üåã','üèùÔ∏è','üê¢','ü¶é','üçå','ü•≠','üç´','‚òï'];
            const maxOnScreen = 18;
            const spawnIntervalMs = 900;

            function spawnOne() {
                // Keep number limited
                if (container.children.length >= maxOnScreen) return;
                const emoji = palette[Math.floor(Math.random() * palette.length)];
                const el = document.createElement('div');
                el.className = 'floating-emoji ' + (emoji === 'üê¢' ? 'turtle' : (emoji === 'ü¶é' ? 'lizard' : 'scenic'));
                // wrap inner to allow independent bob/rotate
                el.innerHTML = `<span class="inner">${emoji}</span>`;
                // random vertical position (avoid overlapping nav/header)
                const top = Math.random() * 75 + 5; // 5% - 80%
                el.style.top = `${top}%`;
                // start slightly off-left
                el.style.left = `-8vw`;
                // random duration (longer for turtles)
                const base = (emoji === 'üê¢') ? 14000 : (emoji === 'ü¶é') ? 11000 : (8000 + Math.random() * 12000);
                const jitter = Math.random() * 4000 - 2000;
                const duration = Math.max(6000, base + jitter);
                el.style.animationDuration = `${duration}ms`;
                // slight scale variety
                const scale = 0.85 + Math.random() * 0.6;
                el.style.transform = `scale(${scale})`;
                // append and remove when animation ends
                el.addEventListener('animationend', () => {
                    // for some browsers animationend fires once per sub-animation; ensure removal only when offscreen
                    if (container.contains(el)) container.removeChild(el);
                });
                container.appendChild(el);
            }

            // Spawn periodically
            const spawner = setInterval(spawnOne, spawnIntervalMs);

            // Clean up on page unload
            window.addEventListener('beforeunload', () => clearInterval(spawner));

            // Also provide a small function to spawn a burst (useful for rewards)
            window.spawnEmojiBurst = function(count = 6) {
                for (let i = 0; i < count; i++) {
                    setTimeout(spawnOne, i * 120);
                }
            }
        })();

        // ----------------------------
        // Initialization and background particle animation
        // ----------------------------
        document.addEventListener('DOMContentLoaded', () => {
            initializeLesson();
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            let particles = [];
            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                particles.forEach((p, i) => {
                    p.y -= p.speed;
                    if (p.y < -p.radius) particles.splice(i, 1);
                    bgCtx.beginPath();
                    bgCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    bgCtx.fillStyle = p.color;
                    bgCtx.fill();
                });
                if (Math.random() > 0.95 && particles.length < 50) {
                    particles.push({ 
                        x: Math.random() * bgCanvas.width, 
                        y: bgCanvas.height + 20, 
                        radius: Math.random() * 8 + 2, 
                        speed: Math.random() * 1 + 0.5, 
                        color: `rgba(255, 255, 255, ${Math.random() * 0.2 + 0.1})`
                    });
                }
                requestAnimationFrame(animateBackground);
            }
            window.addEventListener('resize', () => { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; });
            animateBackground();
        });
    </script>
</body>
</html>
