<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powering Potential: Renewable Energy and Education</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>💡</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @keyframes slowColorChange {
            0% { background-color: #f59e0b; } /* Amber */
            25% { background-color: #d97706; } /* Darker Amber */
            50% { background-color: #b45309; } /* Even Darker Amber */
            75% { background-color: #d97706; } /* Darker Amber */
            100% { background-color: #f59e0b; } /* Amber */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            animation: slowColorChange 240s linear infinite;
            padding-top: 70px; /* Add padding to prevent nav overlap */
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
            border: none;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px -1px rgba(0,0,0,0.2), 0 1px 2px -2px rgba(0,0,0,0.1), inset 0 -2px 0 0 rgba(0,0,0,0.2);
        }
        
        /* Best Practice: Accessibility improvement for keyboard navigation */
        .action-button:focus-visible, .nav-button:focus-visible, .quiz-option:focus-visible, .tfng-button:focus-visible, .word-bank-word:focus-visible, .btn-animated-3d:focus-visible {
            outline: 3px solid #60a5fa; /* A nice blue outline */
            outline-offset: 2px;
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 44px; padding: 0 4px;
            border: 2px dashed #9ca3af; border-radius: 8px; margin: 0 4px;
            vertical-align: middle; background-color: #f3f4f6;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 8px;
            background-color: white; user-select: none;
        }
        .word-bank-word.selected { outline: 2px solid #6366f1; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; }
        .gap.correct .word-bank-word { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .gap.incorrect .word-bank-word { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Feedback Message & Badge Notification */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #fde047, #f97316); }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 20px; } to { opacity: 0; bottom: 0; } }

        /* Certificate Canvas */
        #completion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* Final Project Hub Styles */
        .phase-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .phase-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .keyword-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .keyword-item:hover {
            transform: scale(1.02);
            background-color: #f0f9ff;
        }
        .rooftop-animation {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .building-svg {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #certificate-to-print, #certificate-to-print * { visibility: visible; }
            #certificate-to-print { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="antialiased text-gray-800 text-lg">
    <canvas id="background-canvas"></canvas>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-sm mx-auto p-1.5 flex justify-center items-center gap-2 bg-white/90 backdrop-blur-sm shadow-lg rounded-full">
            <button onclick="goBack()" class="nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <!-- Best Practice: Accessibility improvement for screen readers -->
            <div class="font-bold text-base text-amber-600 px-3">Score: <span id="score-display" aria-live="polite">0</span></div>
            <button onclick="navigateTo('main-menu')" class="nav-button bg-gray-800 text-white font-bold p-2 rounded-full hover:bg-gray-900">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            </button>
            <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-full hover:bg-gray-200" title="Toggle Sound">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
            </button>
            <button onclick="goNext()" class="nav-button bg-amber-600 hover:bg-amber-700 text-white font-bold p-2 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </header>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <section id="page-title-screen" class="page active text-center bg-white rounded-2xl shadow-lg p-8">
            <div class="h-full flex flex-col justify-center items-center">
                <h1 id="main-title" class="text-5xl md:text-6xl font-bold text-amber-800 mb-4"></h1>
                <p id="main-subtitle" class="text-xl md:text-2xl text-gray-600 mb-8"></p>
                <div id="main-svg-container" class="rounded-lg shadow-md mb-8 w-full max-w-lg mx-auto"></div>
                <button onclick="startApp()" class="action-button bg-amber-600 text-white font-bold py-3 px-8 rounded-full text-2xl hover:bg-amber-700">START LESSON</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <!-- Keyword Modal -->
    <div id="keywordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <p id="modalContent" class="text-gray-700 leading-relaxed"></p>
            </div>
        </div>
    </div>
    
    <!-- 
        Best Practice: AudioWorklet for generating sound effect sequences.
        This runs on a separate audio thread, ensuring smooth, responsive audio 
        without blocking the main UI thread, preventing clicks and lag.
    -->
    <script id="sequence-processor" type="worklet-script">
        class SequenceProcessor extends AudioWorkletProcessor {
            constructor() {
                super();
                this._sequence = [];
                this._currentNoteIndex = 0;
                this._samplesUntilNextStep = 0;
                this._isPlaying = false;

                this.port.onmessage = (event) => {
                    if (event.data.type === 'play') {
                        this._sequence = event.data.sequence;
                        this._currentNoteIndex = 0;
                        this._samplesUntilNextStep = 0;
                        this._isPlaying = true;
                    }
                };
            }

            process(inputs, outputs, parameters) {
                const output = outputs[0];
                const outputChannel = output[0];

                if (!this._isPlaying) {
                    return true;
                }

                for (let i = 0; i < outputChannel.length; i++) {
                    if (this._samplesUntilNextStep <= 0 && this._currentNoteIndex < this._sequence.length) {
                        const note = this._sequence[this._currentNoteIndex];
                        
                        this.port.postMessage({
                            type: 'noteOn',
                            freq: note.freq,
                            dur: note.dur || 0.3,
                            vol: note.vol || 0.5,
                            waveType: note.type || 'sine'
                        });

                        const gap = note.gap || note.dur || 0.3;
                        this._samplesUntilNextStep = gap * sampleRate;
                        this._currentNoteIndex++;
                    }

                    this._samplesUntilNextStep--;
                    outputChannel[i] = 0; // The main thread will generate the actual sound
                }

                if (this._currentNoteIndex >= this._sequence.length && this._samplesUntilNextStep <= - (0.3 * sampleRate) ) {
                    this._isPlaying = false;
                }

                return true;
            }
        }
        registerProcessor('sequence-processor', SequenceProcessor);
    </script>


    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION ---
        // ===================================================================================
        const lessonData = {
            title: "Powering Potential",
            subtitle: "Renewable Energy and Education <span aria-hidden='true'>💡⚡️</span>",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-tps', text: 'Think-Pair-Share <span aria-hidden="true">🧠</span>', color: 'green', target: 'tps-start' },
                { id: 'menu-goals', text: 'Learning Goals <span aria-hidden="true">🎯</span>', color: 'teal', target: 'learning-goals' },
                { id: 'menu-warmup', text: 'Warm-Up & Vocab <span aria-hidden="true">📚</span>', color: 'sky', target: 'warm-up' },
                { id: 'menu-reading', text: 'Reading: Light for Learning <span aria-hidden="true">📖</span>', color: 'blue', target: 'reading-main' },
                { id: 'menu-convo', text: 'Conversation Practice <span aria-hidden="true">🗣️</span>', color: 'indigo', target: 'conversation-practice' },
                { id: 'menu-lecture1', text: 'Listening: The Digital Divide <span aria-hidden="true">💻</span>', color: 'amber', target: 'lecture-digital-divide' },
                { id: 'menu-podcast1', text: 'Listening: A Conversation <span aria-hidden="true">🎧</span>', color: 'lime', target: 'podcast-convo-energy' },
                { id: 'menu-dilemma-solar', text: 'Dilemma: Solar Farm <span aria-hidden="true">🤔</span>', color: 'rose', target: 'dilemma-solar-farm' },
                { id: 'menu-dilemma-wind', text: 'Dilemma: Wind Farm <span aria-hidden="true">⚠️</span>', color: 'red', target: 'dilemma-wind-farm' },
                { id: 'menu-thinking', text: 'Thinking & Exam Prep <span aria-hidden="true">📝</span>', color: 'purple', target: 'thinking-prompts' },
                { id: 'menu-final', text: 'Final Project <span aria-hidden="true">✍️</span>', color: 'violet', target: 'final-project-hub' },
            ],
            badges: {
                'STREAK_5': { name: 'Hot Streak', icon: '🔥', description: '5 correct answers in a row' },
                'PERFECT_LEVEL': { name: 'Flawless', icon: '💎', description: 'Complete a level with no mistakes' },
                'GAME_COMPLETE': { name: 'Energy Expert', icon: '🏆', description: 'Complete all challenges' },
            },
            vocabulary: [
                { word: 'Renewable', def: 'A resource (like wind or sun) that is not depleted when used.', sentence: 'Solar and wind are forms of renewable energy.' },
                { word: 'Solar Panel', def: 'A device that converts light from the sun into electricity.', sentence: 'They installed solar panels on the roof to power the school.' },
                { word: 'Off-grid', def: 'Not connected to the main electricity supply network.', sentence: 'The remote village is completely off-grid.' },
                { word: 'Power Grid', def: 'A network for distributing electricity over a large area.', sentence: 'A storm damaged the power grid, causing a blackout.' },
                { word: 'Energy Equity', def: 'The fair distribution of the benefits of energy production and consumption.', sentence: 'Energy equity means ensuring everyone has access to affordable, clean power.' },
                { word: 'Digital Divide', def: 'The gap between people who have access to modern technology and those who do not.', sentence: 'Lack of electricity in rural areas contributes to the digital divide.' },
                { word: 'Infrastructure', def: 'The basic physical systems of a country, such as energy and transport.', sentence: 'Building new energy infrastructure is expensive.' },
                { word: 'Turbine', def: 'A machine with a rotor, driven by a moving fluid to produce power.', sentence: 'A wind turbine can generate enough electricity for hundreds of homes.' },
                { word: 'Battery', def: 'A device that stores electrical energy.', sentence: 'The solar panels charge a battery during the day to provide light at night.' },
                { word: 'Development', def: 'The process in which a country grows or changes and becomes more advanced.', sentence: 'Access to reliable energy is crucial for economic development.' }
            ],
            pages: [
                 // Think Pair Share
                { id: 'tps-start', type: 'simple', content: { title: 'Activity: Think-Pair-Share <span aria-hidden="true">🧠</span>', text: 'Let\'s brainstorm about our daily electricity use.' } },
                { id: 'tps-think', type: 'timer', content: { title: 'Think <span aria-hidden="true">🤔</span>', text: 'Make a list of all the things you used today that require electricity. What would your day be like without them?', duration: 120, timerId: 'timer-think' } },
                { id: 'tps-pair', type: 'timer', content: { title: 'Pair <span aria-hidden="true">👥</span>', text: 'Pair with a colleague. Discuss: How does the internet help you with your schoolwork? What if you couldn’t access it at home?', duration: 180, timerId: 'timer-pair' } },
                { id: 'tps-share', type: 'timer', content: { title: 'Share <span aria-hidden="true">🗣️</span>', text: 'Let\'s share some ideas. Where does the electricity in your city come from?', duration: 300, timerId: 'timer-share' } },
                
                // STAGE 1 & 2
                { id: 'learning-goals', type: 'html-content', content: { title: 'Stage 1: Desired Results <span aria-hidden="true">🎯</span>', html: `
                        <p><strong class="text-rose-600">Topic:</strong> Renewable Energy and Education Access</p>
                        <p><strong class="text-rose-600">Theme:</strong> Energy Equity and Global Development</p>
                        <p><strong class="text-rose-600">Essential Question:</strong> How can harnessing renewable energy create opportunities and bridge educational gaps in underserved communities?</p>
                        <p><strong class="text-rose-600">Learning Intention:</strong> We are learning to analyze how a lack of electricity creates barriers to education and to design a renewable energy solution to address this challenge.</p>
                        <hr class="my-4">
                        <h3 class="text-2xl font-bold text-rose-600 mb-3">Success Criteria</h3>
                        <ul class="list-disc list-inside space-y-2 text-xl">
                            <li>I can explain how solar or wind energy works using key vocabulary.</li>
                            <li>I can describe two ways reliable electricity can improve a student’s ability to learn.</li>
                            <li>I can contribute to designing a basic plan for a solar-powered community project.</li>
                        </ul>` } },
                
                // STAGE 3 - W, H, E
                { id: 'warm-up', type: 'html-content', content: { title: 'Hook & Engage: Warm-Up', html: `
                        <h3 class="text-2xl font-bold text-sky-600 mb-3">Background-Building Questions</h3>
                        <ol class="list-decimal list-inside space-y-4 text-xl">
                            <li>Make a list of all the things you used today that require electricity. What would your day be like without them?</li>
                            <li>How does the internet help you with your schoolwork? What if you couldn’t access it at home?</li>
                            <li>Where does the electricity in your city come from?</li>
                        </ol>` } },
                { id: 'vocab-start', type: 'simple', content: { title: 'Unit Vocabulary <span aria-hidden="true">📚</span>', text: 'Let\'s learn the key terms for this unit. Click "Next" in the header to cycle through the words.' } },
                { id: 'vocab-match', type: 'quiz-mcq', content: { title: 'Vocabulary Practice: Matching', questions: [] } },
                { id: 'reading-main', type: 'html-content', content: { title: 'Reading: Tiered Texts <span aria-hidden="true">📖</span>', html: `
                        <div class="mb-8">
                            <h3 class="text-2xl font-bold text-blue-600 mb-3">Pre-Reading Questions</h3>
                            <ol class="list-decimal list-inside space-y-2 text-xl">
                                <li>Look at the picture of a solar panel. How do you think it makes electricity?</li>
                                <li>Why is it harder for students to learn if they don’t have electricity at home?</li>
                                <li>What kind of places in the world might be “off-grid”?</li>
                            </ol>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-bold text-xl text-blue-800">Text 1: Light for Learning</h4>
                                <p>In some parts of the world, villages are off-grid. They do not have electricity from the main power grid. When the sun goes down, it is dark. Students cannot read books or do homework. This is a big problem for their education. A good solution is renewable energy. We can use solar panels to catch sunlight and make electricity. This electricity can charge a battery. At night, the battery gives power for lights. With light, students can study for more hours and learn more.</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-bold text-xl text-yellow-800">Text 2: Bridging the Digital Divide with Renewable Energy</h4>
                                <p>For millions of students around the world, learning stops when the sun sets. In many remote communities that are off-grid, a lack of electricity creates a major barrier to education. Without power, students cannot use lights to study in the evening, and they are cut off from the digital world. This gap in access to technology is known as the digital divide. Renewable energy offers a powerful solution. By installing solar panels on a school or community center, we can generate clean, local electricity. This power can be stored in a battery for use at night. This simple infrastructure does more than just power lights. It allows students to use computers, access the internet, and connect with a world of information. This is a key step for educational development and achieving energy equity.</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-bold text-xl text-red-800">Text 3: Powering Potential: How Decentralized Renewables Can Transform Education</h4>
                                <p>Access to reliable electricity is a cornerstone of modern education, yet over 700 million people worldwide live without it. For communities living off-grid, the consequences are profound, creating a stark digital divide and hindering educational development. The reliance on expensive and polluting kerosene lamps for light is not only a health hazard but also provides insufficient illumination for studying. This lack of energy infrastructure perpetuates a cycle of educational disadvantage. The solution lies in decentralized renewable energy systems. Unlike large, centralized power plants, small-scale solar and wind installations can be deployed quickly and affordably in remote locations. A typical system involves photovoltaic solar panels that charge a battery bank during the day, providing consistent power after dark. This technology does more than just illuminate a room; it powers potential. It enables the use of laptops and tablets, facilitates access to online educational resources, and allows schools to function as community hubs for adult learning. By investing in these systems, we address the issue of energy equity and create a sustainable foundation for lifelong learning. The spinning of a wind turbine or the silent work of a solar panel can, in effect, power a child’s future.</p>
                            </div>
                        </div>` } },
                { id: 'reading-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap Fill', sentences: [] } },
                { id: 'reading-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False', questions: [] } },
                { id: 'reading-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [] } },
                { id: 'conversation-practice', type: 'dialogue', content: { title: 'Interactive Conversation Practice <span aria-hidden="true">🗣️</span>', dialogue: "Chen: It’s hard to imagine not having electricity. It makes me think about how much we depend on it for school.\n\nSofia: I completely agree. Without it, we couldn’t use our laptops or even have lights to read at night.\n\nChen: That’s a good point. The idea of a “Solar Study Hub” sounds amazing. From my perspective, it’s a simple but very effective solution.\n\nSofia: I see what you mean, but what about the cost? It must be expensive to install solar panels and batteries.\n\nChen: That’s a valid concern. However, the article mentioned it’s often cheaper than building a huge power grid to reach remote areas. What’s your take on that?\n\nSofia: When you put it that way, it makes sense. It’s a long-term investment in a community’s future.\n\nChen: Precisely. And it gives them energy independence. I believe that’s a really important aspect of development.\n\nSofia: I couldn’t agree more. It empowers people to solve their own problems." } },
                
                // LISTENING ACTIVITIES
                { id: 'lecture-digital-divide', type: 'dialogue', content: { title: 'Listening: The Digital Divide <span aria-hidden="true">💻</span>', dialogue: "Lecturer: Hello everyone and welcome! Today, we're diving into a truly inspiring and vital topic: bridging the digital divide with renewable energy. It's an area that holds immense potential to transform education, particularly in underserved communities. In this session, we will cover: the scale of the digital divide in education, why traditional grid infrastructure isn’t always the answer, how off-grid renewable solutions like solar microgrids can help, and the broader impact on digital literacy and educational equity. The digital divide in education is a stark reality for millions of students worldwide, especially in rural and remote areas. Without reliable electricity, accessing computers, the internet, and modern educational tools is simply impossible. Extending traditional power grids to these locations is often too expensive and logistically difficult. This is where decentralized renewable energy steps in. By generating power locally—often through solar or wind—we can bypass the limitations of centralized grids. This isn’t just about lights. It’s about powering the future of learning. Imagine a school powered by solar panels, equipped with laptops or tablets, connected to the internet via satellite or local networks. Battery storage ensures power is available even after sunset. Reliable energy enables: digital literacy programs, access to online educational resources, use of digital libraries, interactive platforms, and remote tutoring. The possibilities are genuinely exciting. However, challenges remain: initial investment, long-term maintenance, and the need for technical support. We need sustainable models with community training and local ownership. Technology alone isn’t enough—human and logistical planning are essential. To summarize: the digital divide is a major challenge in education, traditional grid expansion isn’t always feasible, decentralized renewable energy offers a reliable solution, it enables digital learning hubs, literacy, and access to resources, and success requires collaboration, training, and local engagement. Bridging the digital divide with renewable energy is not just a technical fix—it’s a pathway to educational equity and empowerment for children around the world." } },
                { id: 'lecture-digital-divide-quiz-mcq', type: 'quiz-mcq', content: { title: 'Digital Divide Quiz (MCQ)', questions: [] } },
                { id: 'lecture-digital-divide-quiz-tfng', type: 'quiz-tfng', content: { title: 'Digital Divide Quiz (TFNG)', questions: [] } },
                { id: 'lecture-digital-divide-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Digital Divide Quiz (Gap Fill)', sentences: [] } },
                { id: 'podcast-convo-energy', type: 'dialogue', content: { title: 'Listening: A Conversation on Energy <span aria-hidden="true">🎧</span>', dialogue: "Alex: Hey everyone, I've been thinking a lot about how decentralized renewable energy could really tackle the digital divide, especially in rural education. It feels like such a powerful solution, doesn't it?\n\nSarah: Oh, absolutely, Alex. It's a concept that really excites me. Imagine bringing reliable power and internet access to communities that have been left behind. It feels like a fundamental step towards educational equity, wouldn't you agree, Chris?\n\nChris: G’Day, Alex and Sarah. Yeah, I see the potential alright. It's fair dinkum that getting power out bush is a ripper idea for schools. But I'm a bit skeptical about how easy it'll be to actually implement and maintain all that tech and infrastructure in remote spots. What about the costs and the technical know-how needed?\n\nAlex: That's a valid concern, Chris, and it's something we absolutely need to address. But think about the alternative. Leaving these kids without the digital tools that are becoming essential for learning. It's heartbreaking to think they might miss out. Surely the long-term benefits outweigh the initial hurdles.\n\nSarah: I agree with Alex there. The social return on investment in education is immense. And frankly, the lack of access feels terribly unfair. We're talking about empowering future generations. Perhaps we need innovative funding models and strong community training programs to overcome those infrastructure and maintenance challenges, don't you think?\n\nChris: Yeah, fair call, Sarah. Community involvement would be crucial no doubt. But setting up solar panels and battery storage is one thing. Ensuring consistent internet connectivity and providing ongoing tech support for teachers and students is another kettle of fish entirely. Are we truly ready for that scale of commitment? Or are we just getting our hopes up?\n\nAlex: It's a huge undertaking, no question. But the stories I've heard about even small pilot programs are incredibly inspiring. Seeing kids light up when they connect to the online world for the first time. It makes you believe it's possible. We can't let the complexity paralyze us, can we? We have to find a way.\n\nSarah: Precisely, Alex. It requires a multifaceted approach—government support, private sector innovation, and passionate local engagement. It won't be easy. But the thought of unlocking educational opportunities for so many children is just too powerful to ignore. It truly feels like a moral imperative.\n\nChris: Righto, I hear you. The potential is massive, especially for breaking down barriers. I'm still a bit worried about the practicalities—dodgy connections, flat batteries, finding folks who know how to fix things. But if we can get the framework right, it could be a real game changer. I sincerely hope we can pull it off—for the kids’ sake." } },
                { id: 'podcast-convo-energy-quiz-mcq', type: 'quiz-mcq', content: { title: 'Energy Conversation Quiz (MCQ)', questions: [] } },
                { id: 'podcast-convo-energy-quiz-tfng', type: 'quiz-tfng', content: { title: 'Energy Conversation Quiz (TFNG)', questions: [] } },
                { id: 'podcast-convo-energy-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Energy Conversation Quiz (Gap Fill)', sentences: [] } },
                { id: 'dilemma-solar-farm', type: 'dialogue', content: { title: 'Dilemma: Solar Farm <span aria-hidden="true">🤔</span>', dialogue: "Sarah: So, um, so uh moving on to another scenario. This one about the massive solar farm, choosing between location A, the sacred ancestral land, or location B, the farmland. This is, this is a really difficult ethical choice.\n\nDavid: Indeed. A classic utilitarian versus deontological conflict in a way. As the person who has to make a recommendation, I suppose, thinking about it, in my opinion, the best course of action is to recommend location B.\n\nEmma: Yeah, I see your point, David, about the larger number of people affected by destroying the farmland, but I have a different perspective. I believe we should choose location A. This is justified because, from my perspective, the most ethical choice is respecting the rights and cultural heritage of the indigenous community. Their connection to that land is irreplaceable.\n\nSarah: Hmm, I understand why you say that, Emma. The cultural significance is immense. But um, while it is true that location A is sacred land, I still believe that the impact on the rural town of 5,000 people is, are more critical right now. The evidence suggests that losing their farmland would be devastating to their livelihoods and community structure.\n\nDavid: Precisely, Sarah. And could you please explain what you mean by irreplaceable, Emma? I'm not sure I fully understand the, the long-term consequence of displacing the indigenous community versus destroying the farmland.\n\nEmma: Right. Well it's about history, you know, and identity. That land holds generations of their stories and traditions. Furthermore, we must consider the principle of not forcibly removing people from their homes and cultural sites. It's not just about the immediate displacement. Think about the stolen generations here in Australia. The trauma of being removed from your land and culture lasts for generations, you know?\n\nSarah: That's a great point, Emma. I'd also like to add that while 5,000 is a larger number, displacing 200 people from their ancestral land seems like a more profound violation of rights than impacting the livelihoods of 5,000 who could potentially adapt or be compensated, though that's not ideal either.\n\nDavid: True, true. On the one hand, the cultural and historical significance of location A is compelling. But on the other hand, the sheer number of people whose lives would be severely impacted by destroying the farmland at location B. What would happen if we explored alternative solar farm technologies or smaller, distributed solar projects that wouldn't require such a massive footprint?\n\nEmma: Yeah, I see what you mean, David. It's a bit of a balancing act, isn't it? The value of cultural heritage versus economic livelihood and population size. It seems to me that the only real option is, well, it's not easy to choose who suffers.\n\nSarah: Absolutely. I mean, ideally there would be a win-win scenario, but with these two stark choices, I respectfully disagree that location A is the only real option though. The responsibility to the larger population in the rural town is also a significant ethical consideration.\n\nDavid: Perhaps a negotiation approach is the way to go. But, you know, that idea of engaging with both communities to find a solution that minimizes harm.\n\nEmma: Yeah, that makes sense. Little by little I reckon. Talk to the indigenous community, talk to the townspeople, see if there's any common ground or alternative solutions.\n\nSarah: That's a possibility. We'd need to weigh the pros and cons carefully for a negotiation process too. It could be time-consuming and might not lead to a viable solution.\n\nDavid: Indeed. It's a complex issue with, with no easy answers in this scenario. A truly unenviable position for the person making the recommendation.\n\nEmma: So uh to review, we've chatted about the sacred land versus farmland dilemma, the value of cultural heritage versus economic livelihood and population size, and the idea of maybe trying a negotiation or alternative technology approach. We also touched on real-world examples, like the stolen generations. Pretty much covered the, uh, the main points, I think." } },
                { id: 'dilemma-solar-farm-quiz-mcq', type: 'quiz-mcq', content: { title: 'Solar Farm Dilemma Quiz (MCQ)', questions: [] } },
                { id: 'dilemma-solar-farm-quiz-tfng', type: 'quiz-tfng', content: { title: 'Solar Farm Dilemma Quiz (TFNG)', questions: [] } },
                { id: 'dilemma-solar-farm-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Solar Farm Dilemma Quiz (Gap Fill)', sentences: [] } },
                { id: 'dilemma-wind-farm', type: 'dialogue', content: { title: 'Dilemma: Wind Farm <span aria-hidden="true">⚠️</span>', dialogue: "Sarah: So, uh moving on to another scenario about the towns needing a new power source and the wind farm. This is, this is another one about cooperation and trust between communities.\n\nDavid: Indeed. A classic collective action problem. As the representative for my town, I suppose, thinking about it, in my opinion, the best course of action is to agree to invest in the wind farm.\n\nEmma: Yeah, I see your point, David, about the clean reliable energy, but I have a different perspective. I believe we should choose not to invest, at least not without a very solid agreement. This is justified because, from my perspective, the most ethical choice is protecting our town's money from being exploited. We don't want to pay for it while they benefit for free.\n\nSarah: Hmm, I understand why you say that, Emma. The risk of the other town not paying their share is real. But um, while it is true that there's a risk of exploitation if only one invests, I still believe that the potential for clean reliable energy and avoiding future pollution and blackouts is, are more critical right now. The evidence suggests that relying on old power sources is becoming increasingly unsustainable.\n\nDavid: Precisely, Sarah. And could you please explain what you mean by a solid agreement, Emma? I'm not sure I fully understand the, the level of guarantee you would need from the other town.\n\nEmma: Right. Well it's about trust, you know, and consequences. If we invest and they don't, our town is out a lot of money and they get free energy. Furthermore, we must consider the impact on our town's finances if we're stuck with the whole bill. It's not just about the energy.\n\nSarah: That's a great point, Emma. I'd also like to add that if neither town invests, both continue to suffer from pollution and blackouts. That's a guaranteed negative outcome.\n\nDavid: True, true. On the one hand, the risk of financial exploitation is compelling. But on the other hand, the certainty of continued pollution and blackouts if neither invests. What would happen if we tried to involve a third-party mediator to oversee the investment and ensure both towns contribute?\n\nEmma: Yeah, I, I see what you mean, David. It's a bit of a balancing act, isn't it? Trust versus the need for clean energy. It seems to me that the only real option is, well, it's not easy to decide without knowing if we can truly rely on the other town.\n\nSarah: Absolutely. I mean, ideally we'd have a strong inter-town relationship already, but in this scenario, we have to make a call based on the potential for cooperation versus the risk of being taken advantage of. I respectfully disagree that the only real option is not investing though. The potential shared benefit is, is pretty clear if both cooperate.\n\nDavid: Perhaps a phased investment approach is the way to go. Start with a smaller initial investment to build trust, as Dr. Chen suggested previously. Though, of course, we don't have Dr. Chen here today. But, you know, that idea of starting small and then, then committing fully.\n\nEmma: Yeah, that makes sense. Little by little I reckon. Put in a bit of money, see if they match it, and if they do, invest the rest.\n\nSarah: That's a possibility. We'd need to weigh the pros and cons carefully for that approach too. What if they just take the initial investment and still don't contribute fully?\n\nDavid: Indeed. It's a complex issue with, with no easy answers in this scenario. A truly unenviable position for the town representatives." } },
                { id: 'dilemma-wind-farm-quiz-mcq', type: 'quiz-mcq', content: { title: 'Wind Farm Dilemma Quiz (MCQ)', questions: [] } },
                { id: 'dilemma-wind-farm-quiz-tfng', type: 'quiz-tfng', content: { title: 'Wind Farm Dilemma Quiz (TFNG)', questions: [] } },
                { id: 'dilemma-wind-farm-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Wind Farm Dilemma Quiz (Gap Fill)', sentences: [] } },

                // STAGE 3 - R, E, T, O
                { id: 'thinking-prompts', type: 'html-content', content: { title: 'Rethink, Revise, Reflect <span aria-hidden="true">📝</span>', html: `
                        <div class="mb-6">
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Harkness Discussion Prompt</h3>
                            <p class="text-xl italic">“Who should be primarily responsible for solving energy inequality: national governments, private companies, or international NGOs? Why?”</p>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Higher-Order Thinking Questions</h3>
                            <ul class="list-disc list-inside space-y-2 text-lg">
                                <li><b>Remembering:</b> What are two types of renewable energy mentioned in the texts?</li>
                                <li><b>Understanding:</b> Explain how a lack of electricity can create a “cycle of educational disadvantage.”</li>
                                <li><b>Applying:</b> If you were to design a solar power system for your own home, what three things would you need to consider?</li>
                                <li><b>Analyzing:</b> Compare the advantages and disadvantages of a large, centralized power grid versus small, decentralized renewable systems for a developing country.</li>
                                <li><b>Evaluating:</b> Make a judgment on whether providing energy or providing teachers is more important for improving education in a remote community. Defend your position.</li>
                                <li><b>Creating:</b> Design a poster for a campaign called “Light Up a Future” to raise money for solar lights for students in off-grid communities.</li>
                            </ul>
                        </div>` } },
                { id: 'exam-practice', type: 'html-content', content: { title: 'Connections to IELTS & TOEFL', html: `
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-2xl font-bold text-purple-600 mb-3">IELTS Speaking Practice</h3>
                                <p><b>Part 1:</b> What technology do you use most often? Is technology important for learning? Do you think access to the internet is a human right?</p>
                                <p><b>Part 2 (Cue Card):</b> Describe an important piece of technology you use regularly. You should say: what it is, what you use it for, how long you have had it, and explain why it is important to you.</p>
                                <p><b>Part 3:</b> How has technology changed education in your country? What are the advantages and disadvantages of online learning? Do you think technology will ever replace teachers?</p>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-purple-600 mb-3">TOEFL Independent Speaking</h3>
                                <p>Do you agree or disagree with the following statement? “Technology has made the world a better place to live.” Use specific reasons and examples to support your answer.</p>
                            </div>
                        </div>` } },
                { id: 'final-project-hub', type: 'html-content', content: { title: 'Final Project Hub <span aria-hidden="true">✍️</span>', html: `
                        <div class="bg-gradient-to-br from-amber-50 to-yellow-50">
                            <header class="bg-white shadow-lg border-b-4 border-amber-500">
                                <div class="max-w-7xl mx-auto px-6 py-8">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h1 class="text-4xl font-bold text-gray-800 mb-2"><span aria-hidden="true">💡⚡️</span> Powering Potential</h1>
                                            <p class="text-xl text-gray-600">Final Project Guide</p>
                                        </div>
                                        <div class="rooftop-animation">
                                            <svg class="w-24 h-24" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M50 10V25M32.5 17.5L40 28.5M17.5 32.5L28.5 40M10 50H25M17.5 67.5L28.5 60M32.5 82.5L40 71.5M50 90V75M67.5 82.5L60 71.5M82.5 67.5L71.5 60M90 50H75M82.5 32.5L71.5 40M67.5 17.5L60 28.5" stroke="#f59e0b" stroke-width="4" stroke-linecap="round"/><circle cx="50" cy="50" r="20" fill="#fbbf24" stroke="#d97706" stroke-width="3"/></svg>
                                        </div>
                                    </div>
                                </div>
                            </header>
                            <section class="max-w-7xl mx-auto px-6 py-12">
                                <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">🎯</span> Big Ideas & Understanding</h2>
                                    <div class="grid md:grid-cols-2 gap-8"><div class="bg-gradient-to-r from-yellow-100 to-orange-100 p-6 rounded-xl"><h3 class="text-xl font-semibold text-gray-800 mb-4"><span aria-hidden="true">🌍</span> Enduring Understanding</h3><p class="text-gray-700 leading-relaxed">Access to energy is fundamental to social and economic development, and sustainable technology can be a powerful tool for promoting equity and opportunity worldwide.</p></div><div class="bg-gradient-to-r from-orange-100 to-red-100 p-6 rounded-xl"><h3 class="text-xl font-semibold text-gray-800 mb-4"><span aria-hidden="true">💡</span> Big Idea</h3><p class="text-gray-700 leading-relaxed">Harnessing renewable energy creates opportunities and bridges educational gaps.</p></div></div>
                                </div>
                                <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">🎓</span> Transferable KSA Skills</h2>
                                    <div class="grid md:grid-cols-3 gap-6"><div class="text-center p-6 bg-red-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">🧠</span></div><h3 class="text-xl font-semibold text-red-700 mb-3">Knowledge</h3><p class="text-gray-700 text-sm">Renewable energy systems, project management, budget planning, principles of electricity</p></div><div class="text-center p-6 bg-blue-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">🛠️</span></div><h3 class="text-xl font-semibold text-blue-700 mb-3">Skills</h3><p class="text-gray-700 text-sm">Collaborative problem-solving, data analysis, persuasive communication, technical design, proposal writing</p></div><div class="text-center p-6 bg-green-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">❤️</span></div><h3 class="text-xl font-semibold text-green-700 mb-3">Attitudes</h3><p class="text-gray-700 text-sm">Global citizenship, empathy, responsibility, confidence to propose innovative solutions</p></div></div>
                                </div>
                                <div class="mb-12">
                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">🚀</span> Project-Based Learning Journey</h2>
                                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6"><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(1)"><div class="text-4xl mb-4"><span aria-hidden="true">🔍</span></div><h3 class="text-xl font-bold mb-2">Phase 1</h3><p class="text-sm opacity-90">Identifying Problems & Initial Inquiry</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(2)"><div class="text-4xl mb-4"><span aria-hidden="true">📚</span></div><h3 class="text-xl font-bold mb-2">Phase 2</h3><p class="text-sm opacity-90">Researching Solutions & Concepts</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(3)"><div class="text-4xl mb-4"><span aria-hidden="true">📐</span></div><h3 class="text-xl font-bold mb-2">Phase 3</h3><p class="text-sm opacity-90">Planning & Design</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(4)"><div class="text-4xl mb-4"><span aria-hidden="true">📊</span></div><h3 class="text-xl font-bold mb-2">Phase 4</h3><p class="text-sm opacity-90">Evaluation & Communication</p></div></div>
                                </div>
                                <div id="phaseContent" class="bg-white rounded-2xl shadow-xl p-8"></div>
                            </section>
                        </div>` } },
                { id: 'writing-task', type: 'writing-task', content: { 
                    title: 'Writing Activity <span aria-hidden="true">✍️</span>', 
                    prompt: 'You are writing an application for a youth grant to fund a renewable energy project at your school. The project could be installing small solar panels to create a phone charging station or creating an “energy-saving awareness” campaign. Persuade the grant committee that your project is important and achievable.', 
                    starters: ['I am writing on behalf of my student group to propose a project called...', 'Our goal is to...', 'We believe this project is vital for our school community because...', 'Currently, our school...', 'The project will involve...', 'The expected impact of this project includes...', 'In conclusion, we are confident that this project is a valuable investment...'],
                    wordBank: ['access', 'advantage', 'battery', 'benefit', 'campaign', 'challenge', 'clean', 'community', 'cost', 'development', 'digital', 'education', 'efficient', 'energy', 'environment', 'equity', 'future', 'grid', 'infrastructure', 'install', 'local', 'power', 'renewable', 'solar', 'sustainable']
                } },
                { id: 'self-assessment', type: 'html-content', content: { title: 'Self-Assessment & Rubric <span aria-hidden="true">🧑‍🏫</span>', html: `
                        <div class="mb-8">
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Metacognitive Self-Assessment</h3>
                            <ol class="list-decimal list-inside space-y-4 text-xl">
                                <li>“What part of this unit’s final project (the GRASPS task) seems most interesting to me? What part seems most challenging?”</li>
                                <li>“After this lesson, I feel more/less confident about my ability to explain technical topics in English because...”</li>
                            </ol>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Final Project Rubric (KASE-C)</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="bg-purple-50">
                                            <th class="border-b-2 p-2 w-1/4">Criterion</th>
                                            <th class="border-b-2 p-2">5 - Exemplary</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="border-b p-2 font-semibold">K – Knowledge</td><td class="border-b p-2">The proposal demonstrates a deep, nuanced understanding of the core issues of energy equity and its impact on education. It expertly analyzes the community’s context and needs.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">A – Analysis</td><td class="border-b p-2">The proposed solution is highly creative, technically sound, and directly addresses the core problem. It demonstrates exceptional critical thinking and a well-justified, sustainable design.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">S – Structure</td><td class="border-b p-2">The presentation is exceptionally clear, engaging, and persuasive. It uses powerful rhetorical strategies and a compelling narrative to connect with the audience and inspire action.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">E – Evidence</td><td class="border-b p-2">The design choices are supported by strong, relevant evidence from case studies of similar energy projects and a clear understanding of renewable technology principles.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">C – Clarity</td><td class="border-b p-2">The language is exceptionally clear, precise, and inspiring. The project's concept and its deeper meaning are communicated in a way that is engaging and persuasive.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>` } },
                { id: 'certificate', type: 'certificate', content: { title: 'Module Complete! <span aria-hidden="true">🎉</span>', text: 'You have successfully completed the "Powering Potential" module.', certificateTitle: 'Certificate of Completion' } }
            ]
        };
        // --- END OF LESSON CONTENT CONFIGURATION ---
        // ===================================================================================

        // --- PROJECT HUB DATA & FUNCTIONS ---
        const phases = {
            1: { title: "Phase 1: Identifying the Problem & Initial Inquiry", icon: "<span aria-hidden='true'>🔍</span>", keywords: { "Energy Poverty": "Many rural communities live in energy poverty, lacking the electricity needed for basic services like healthcare and education.", "Digital Divide": "The digital divide prevents students without internet access from participating in online learning.", "Educational Barriers": "Lack of lighting at night is a significant educational barrier for children in off-grid villages.", "Community Needs": "Before designing the project, the team conducted a survey to understand the community's specific energy needs." } },
            2: { title: "Phase 2: Researching Solutions & Foundational Concepts", icon: "<span aria-hidden='true'>📚</span>", keywords: { "Solar Power": "Solar power is a clean, renewable energy source that is ideal for sunny, remote locations.", "Wind Power": "In areas with consistent wind, wind power can provide a reliable source of electricity.", "Microgrids": "The village developed a solar microgrid to power its school and clinic independently from the national grid.", "Battery Storage": "Battery storage is essential for a solar power system to provide electricity at night or on cloudy days.", "Energy Efficiency": "Using energy-efficient LED lights and appliances reduces the overall power demand of the system.", "Sustainability": "The project's sustainability was ensured by training local technicians to maintain the solar panels." } },
            3: { title: "Phase 3: Planning & Design", icon: "<span aria-hidden='true'>📐</span>", keywords: { "System Sizing": "System sizing is a critical step to ensure the solar panels and batteries are large enough to meet the community's power needs.", "Budgeting": "The project budgeting included the cost of panels, batteries, wiring, and installation.", "Technical Specifications": "The engineers reviewed the technical specifications of the water pump to ensure it was compatible with the solar power system.", "Maintenance Plan": "A clear maintenance plan was created to guide the community in cleaning panels and checking battery health." } },
            4: { title: "Phase 4: Evaluation & Communication", icon: "<span aria-hidden='true'>📊</span>", keywords: { "Impact Assessment": "An impact assessment conducted a year later showed a 50% increase in literacy rates among students.", "Funding Proposal": "The team wrote a detailed funding proposal to a foundation to get the money for their project.", "Stakeholder Engagement": "Stakeholder engagement, including meetings with community elders and teachers, was key to the project's success.", "Persuasive Communication": "The student's persuasive communication during the presentation convinced the judges to fund their idea.", "Social Return on Investment": "The social return on investment was high, as every dollar spent on the project generated significant educational and health benefits." } }
        };

        window.showPhase = function(phaseNumber) {
            const phase = phases[phaseNumber];
            const content = document.querySelector('#page-final-project-hub #phaseContent');
            if (!content) return;
            let keywordsHtml = Object.entries(phase.keywords).map(([keyword, definition]) => `
                <div class="keyword-item bg-gray-50 p-4 rounded-xl border-l-4 border-amber-500" onclick="showKeyword('${keyword}', '${definition.replace(/'/g, "\\'")}')">
                    <h4 class="font-semibold text-gray-800 mb-2">${keyword}</h4>
                    <p class="text-gray-600 text-sm">${definition.substring(0, 100)}...</p>
                </div>`).join('');
            content.innerHTML = `
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">${phase.icon}</div>
                    <h3 class="text-2xl font-bold text-gray-800">${phase.title}</h3>
                </div>
                <div class="grid md:grid-cols-2 gap-4">${keywordsHtml}</div>`;
        }
        window.showKeyword = function(keyword, definition) {
            document.getElementById('modalTitle').textContent = keyword;
            document.getElementById('modalContent').textContent = definition;
            document.getElementById('keywordModal').classList.remove('hidden');
            document.getElementById('keywordModal').classList.add('flex');
        }
        window.closeModal = function() {
            document.getElementById('keywordModal').classList.add('hidden');
            document.getElementById('keywordModal').classList.remove('flex');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // ===================================================================================
            // --- MAIN SCRIPT ---
            // Best practices applied:
            // 1. AudioWorklet: For non-blocking, performant audio.
            // 2. Accessibility: ARIA live regions and focus-visible styles.
            // 3. Code Organization: Clear sections for state, audio, UI, etc.
            // 4. Robustness: Graceful handling of audio initialization failures.
            // ===================================================================================

            // --- STATE MANAGEMENT ---
            let score = 0, currentPage = lessonData.startPageId, timerInterval;
            const pageHistory = [lessonData.startPageId];
            let pageSequence = [];
            let earnedBadges = [];
            let selectedWord = { element: null, text: '' };

            // --- AUDIO & TTS ENGINE ---
            let audioContext, speechService, sequenceNode;
            
            // --- SOUND & PHRASE CONTENT ---
            const correctPhrases = [ "Stellar work!", "You've got it!", "Absolutely brilliant!", "That's the one!", "Incredible!", "You're a genius!", "Keep it up!", "Outstanding!", "Perfectly done!", "You're on fire!" ];
            const incorrectPhrases = [ "That was a great attempt! Let's try another.", "Not this time, but you're getting warmer!", "Every try is a step forward. Keep going!", "Mistakes are proof that you are trying. Don't stop!", "That's not the answer, but I believe in you!", "So close! What's your next idea?", "Don't worry, the best discoveries come after a few tries.", "That's a learning opportunity! Try again.", "Your persistence is inspiring. Let's go again.", "Even experts get it wrong sometimes. You've got this!" ];
            const correctSounds = [ {name: "Bright Ding", seq: [{freq:880,dur:0.3}]}, {name: "Double Chime", seq: [{freq:660,dur:0.2},{freq:880,dur:0.2}]}, {name: "Sparkle Sweep", seq: [{freq:500,dur:0.3},{freq:1500,dur:0.1}]}, {name: "Bell Ping", seq: [{freq:784,dur:0.4}]}, {name: "Arcade Win", seq: [{freq:880,type:'square',dur:0.15},{freq:1320,type:'square',dur:0.15}]}, {name: "Coin Drop", seq: [{freq:1200,type:'sawtooth',dur:0.15},{freq:1800,type:'sawtooth',dur:0.15}]}, {name: "Harp Pluck", seq: [{freq:660,dur:0.15},{freq:880,dur:0.15},{freq:990,dur:0.15}]}, {name: "Pop Click", seq: [{freq:1000,type:'square',dur:0.05}]}, {name: "Magic Twinkle", seq: [{freq:1200,dur:0.1},{freq:2000,dur:0.1}]}, {name: "Level Up", seq: [{freq:660,dur:0.15},{freq:880,dur:0.15},{freq:1320,dur:0.15}]}, {name: "Rising Arpeggio", seq: [{freq:523, dur:0.1}, {freq:659, dur:0.1}, {freq:784, dur:0.1}, {freq:1046, dur:0.1}]}, {name: "Quick Trill", seq: [{freq:988, dur:0.05, gap: 0.05}, {freq:1046, dur:0.05, gap: 0.05}, {freq:988, dur:0.05, gap: 0.05}, {freq:1046, dur:0.05}]}, {name: "Fanfare", seq: [{freq:784, dur:0.15}, {freq:1046, dur:0.25}]}, {name: "Confirm Beep", seq: [{freq:600, type:'triangle', dur:0.1}, {freq:1200, type:'triangle', dur:0.1, gap: 0.1}]}, {name: "Synth Pluck", seq: [{freq:900, type:'sawtooth', vol: 0.3, dur:0.2}]}, {name: "Bell Tree", seq: [{freq:2000, dur:0.05}, {freq:2500, dur:0.05, gap:0.1}, {freq:3000, dur:0.05}]}, {name: "Scale Up", seq: [{freq:440, dur:0.1}, {freq:550, dur:0.1}, {freq:660, dur:0.1}]}, {name: "Shimmer", seq: [{freq:1500, dur:0.4, vol: 0.4}, {freq:1510, dur:0.4, vol:0.4, gap: -0.4}]}, {name: "Power Up", seq: [{freq:330, type:'square', dur:0.1}, {freq:440, type:'square', dur:0.1}, {freq:660, type:'square', dur:0.2}]}, {name: "Complete Chime", seq: [{freq:1046, dur:0.5}]}, {name: "Success Chord", seq: [{freq:523.25, dur:0.4}, {freq:659.25, dur:0.4, gap: -0.4}, {freq:783.99, dur:0.4, gap: -0.4}]}, {name: "Laser Zap", seq: [{freq:1500, type:'sawtooth', dur:0.01}, {freq:500, type:'sawtooth', dur:0.1}]}, {name: "Soft Bell", seq: [{freq:1046.50, dur:0.5, vol: 0.4}]}, {name: "Echo Ping", seq: [{freq:1200, dur:0.1, gap: 0.2}, {freq:1200, dur:0.1, vol: 0.2}]}, {name: "Bubble Pop", seq: [{freq:800, type:'triangle', dur:0.05, vol:0.8}]}, {name: "Achievement", seq: [{freq:392, dur:0.1}, {freq:523, dur:0.1}, {freq:784, dur:0.2}]}, {name: "Positive Chirp", seq: [{freq:2000, type:'sine', dur:0.1}]}, {name: "Digital OK", seq: [{freq:880, type:'square', dur:0.15}, {freq:1108, type:'square', dur:0.15}]}, {name: "Crystal Clear", seq: [{freq:3000, dur:0.2, vol:0.3}]}, {name: "Triumph", seq: [{freq:523.25, type:'sawtooth', dur:0.6}]}, {name: "Glimmer", seq: [{freq:2000, dur:0.3}, {freq:2010, dur:0.3, gap: -0.3}]}, {name: "Double Pop", seq: [{freq:1000, type:'square', dur:0.05, gap:0.05}, {freq:1200, type:'square', dur:0.05}]}, {name: "Ascend", seq: [{freq:440, dur:0.05}, {freq:554, dur:0.05}, {freq:659, dur:0.05}, {freq:880, dur:0.1}]}, {name: "Mission Done", seq: [{freq:261, dur:0.15}, {freq:392, dur:0.15}, {freq:523, dur:0.3}]}, {name: "Harp Cascade", seq: [{freq:1046, dur:0.1}, {freq:784, dur:0.1}, {freq:659, dur:0.1}, {freq:523, dur:0.1}]}, {name: "Victory", seq: [{freq:523, dur:0.1}, {freq:523, dur:0.1, gap:0.1}, {freq:784, dur:0.2}, {freq:659, dur:0.3}]}, {name: "Simple OK", seq: [{freq:700, type:'triangle', dur:0.2}]}, {name: "Gleam", seq: [{freq:4000, dur:0.05, vol:0.2}]}, {name: "Prize Reveal", seq: [{freq:1200, dur:0.1}, {freq:1600, dur:0.1}, {freq:2000, dur:0.2}]}, {name: "Final Ding", seq: [{freq:1046.50, dur:0.4}]} ];
            const incorrectSounds = [ {name: "Buzzer", seq: [{freq:200,type:'square',dur:0.5}]}, {name: "Double Buzz", seq: [{freq:200,type:'square',dur:0.2},{freq:200,type:'square',dur:0.2}]}, {name: "Descending Wah", seq: [{freq:600,dur:0.2},{freq:200,dur:0.3}]}, {name: "Flat Fail", seq: [{freq:150,dur:0.4}]}, {name: "Error Beep", seq: [{freq:400,type:'sawtooth',dur:0.3}]}, {name: "Glitch Zap", seq: [{freq:1000,type:'square',dur:0.05},{freq:300,type:'square',dur:0.05}]}, {name: "Sad Trombone", seq: [{freq:400,dur:0.2},{freq:300,dur:0.2},{freq:200,dur:0.3}]}, {name: "Reject Click", seq: [{freq:100,type:'square',dur:0.05}]}, {name: "Alarm Chirp", seq: [{freq:500,dur:0.2},{freq:500,dur:0.2}]}, {name: "Drop Off", seq: [{freq:800,dur:0.2},{freq:100,dur:0.3}]}, {name: "Wobble", seq: [{freq:300, dur:0.4}, {freq:290, dur:0.4, gap: -0.4}]}, {name: "Downward Slide", seq: [{freq:500, type:'sawtooth', dur:0.05}, {freq:400, type:'sawtooth', dur:0.05}, {freq:300, type:'sawtooth', dur:0.05}, {freq:200, type:'sawtooth', dur:0.2}]}, {name: "Detuned Chord", seq: [{freq:220, dur:0.5}, {freq:225, dur:0.5, gap: -0.5}]}, {name: "Muted Thud", seq: [{freq:100, type:'triangle', dur:0.2, vol: 0.8}]}, {name: "Static Burst", seq: [{freq:1800, type:'sawtooth', dur:0.05}, {freq:1900, type:'sawtooth', dur:0.05, gap: -0.05}, {freq:1700, type:'sawtooth', dur:0.05, gap: -0.05}]}, {name: "Game Over", seq: [{freq:330, dur:0.2}, {freq:220, dur:0.2}, {freq:110, dur:0.3}]}, {name: "Clank", seq: [{freq:800, type:'square', dur:0.1}, {freq:810, type:'square', dur:0.1, gap: -0.1}]}, {name: "Wrong Synth", seq: [{freq:155, type:'sawtooth', dur:0.4}]}, {name: "Fail Arpeggio", seq: [{freq:523, dur:0.1}, {freq:392, dur:0.1}, {freq:261, dur:0.2}]}, {name: "Rattle", seq: [{freq:900, type:'square', dur:0.02, gap:0.02}, {freq:900, type:'square', dur:0.02, gap:0.02}, {freq:900, type:'square', dur:0.02}]}, {name: "Wrong Chord", seq: [{freq:261.63, dur:0.5}, {freq:311.13, dur:0.5, gap:-0.5}, {freq:369.99, dur:0.5, gap:-0.5}]}, {name: "System Error", seq: [{freq:110, type:'square', dur:0.6}]}, {name: "Mechanical Fail", seq: [{freq:250, type:'sawtooth', dur:0.2}, {freq:240, type:'sawtooth', dur:0.2, gap:-0.2}]}, {name: "Short Circuit", seq: [{freq:1800, type:'square', dur:0.02}, {freq:1850, type:'square', dur:0.02, gap:-0.02}]}, {name: "Deflated", seq: [{freq:500, dur:0.1}, {freq:400, dur:0.1}, {freq:300, dur:0.1}, {freq:200, dur:0.2}]}, {name: "Denied", seq: [{freq:220, dur:0.2, gap:0.1}, {freq:220, dur:0.2}]}, {name: "Alert Beep", seq: [{freq:1000, type:'sawtooth', dur:0.1, gap:0.1}, {freq:1000, type:'sawtooth', dur:0.1}]}, {name: "Low Drone", seq: [{freq:80, dur:0.8}]}, {name: "Scrape", seq: [{freq:600, type:'sawtooth', dur:0.3}, {freq:610, type:'sawtooth', dur:0.3, gap:-0.3}]}, {name: "Bonk", seq: [{freq:150, type:'triangle', dur:0.15, vol:0.9}]}, {name: "Glitchy Signal", seq: [{freq:800, type:'square', dur:0.03}, {freq:400, type:'square', dur:0.03}, {freq:1200, type:'square', dur:0.03}]}, {name: "Sad Beep", seq: [{freq:440, dur:0.3}, {freq:415, dur:0.3, gap:-0.3}]}, {name: "Error Chord", seq: [{freq:440, dur:0.4}, {freq:466, dur:0.4, gap:-0.4}]}, {name: "System Halt", seq: [{freq:100, type:'sawtooth', dur:0.6}]}, {name: "Warning Siren", seq: [{freq:800, dur:0.2, gap:0.1}, {freq:700, dur:0.2}]}, {name: "Interference", seq: [{freq:2500, type:'square', dur:0.2, vol:0.2}, {freq:2550, type:'square', dur:0.2, vol:0.2, gap:-0.2}]}, {name: "Shutdown", seq: [{freq:400, type:'square', dur:0.1}, {freq:300, type:'square', dur:0.1}, {freq:200, type:'square', dur:0.2}]}, {name: "Muted Error", seq: [{freq:120, dur:0.2}]}, {name: "Dissonant Ring", seq: [{freq:1000, dur:0.4}, {freq:1015, dur:0.4, gap:-0.4}]}, {name: "Final Buzz", seq: [{freq:120, type:'square', dur:0.5}]} ];

            /** * SpeechService v6.0 — Patched for fixed Microsoft Natural Online voices
             * Ava, Emma, Brian, Andrew, William only
             */
            class SpeechService {
                constructor() {
                    this.synth = window.speechSynthesis;
                    this.isInitialized = false;
                    this.isTtsEnabled = true;
                    this.voices = [];
                    this.speechRate = 0.85;

                    // Speaker → Preferred voices mapping
                    this.speakerVoiceMap = {
                        // Core voices
                        'ava':     { names: ['Microsoft Ava Online (Natural) - English (United States)'], lang: 'en-US' },
                        'emma':    { names: ['Microsoft Emma Online (Natural) - English (United States)'], lang: 'en-US' },
                        'brian':   { names: ['Microsoft Brian Online (Natural) - English (United States)'], lang: 'en-US' },
                        'andrew':  { names: ['Microsoft Andrew Online (Natural) - English (United States)'], lang: 'en-US' },
                        'william': { names: ['Microsoft William Online (Natural) - English (Australia)'], lang: 'en-AU' },

                        // Character assignments
                        'chris':    { names: ['Microsoft William Online (Natural) - English (Australia)'], lang: 'en-AU' },
                        'chen':     { names: ['Microsoft Andrew Online (Natural) - English (United States)'], lang: 'en-US' },
                        'sofia':    { names: ['Microsoft Ava Online (Natural) - English (United States)'], lang: 'en-US' },
                        'lecturer': { names: ['Microsoft Brian Online (Natural) - English (United States)'], lang: 'en-US' },
                        'alex':     { names: ['Microsoft Andrew Online (Natural) - English (United States)'], lang: 'en-US' },
                        'sarah':    { names: ['Microsoft Emma Online (Natural) - English (United States)'], lang: 'en-US' },
                        'david':    { names: ['Microsoft Brian Online (Natural) - English (United States)'], lang: 'en-US' }
                    };
                }

                async _setupVoices() {
                    const voicesPromise = new Promise(resolve => {
                        if (this.synth.getVoices().length) return resolve(this.synth.getVoices());
                        this.synth.onvoiceschanged = () => resolve(this.synth.getVoices());
                    });

                    this.voices = await voicesPromise;
                    if (!this.voices.length) {
                        console.warn("No voices available.");
                        return;
                    }
                    
                    // Warm-up call to unlock speech synthesis on some browsers after a user gesture.
                    const warmUp = new SpeechSynthesisUtterance(' ');
                    warmUp.volume = 0;
                    this.synth.speak(warmUp);
                    this.synth.cancel();

                    this.isInitialized = true;
                    console.log("Voices loaded and speech engine warmed up:", this.voices.map(v => v.name));
                }

                _getVoiceForSpeaker(speakerName) {
                    if (!speakerName) return null;
                    const key = speakerName.toLowerCase();
                    const entry = this.speakerVoiceMap[key];
                    if (!entry) return null;

                    // Try preferred names in order
                    for (const preferredName of entry.names) {
                        const match = this.voices.find(v => v.name === preferredName);
                        if (match) return match;
                    }
                    // Fallback: match by language
                    return this.voices.find(v => v.lang === entry.lang) || null;
                }

                speak(text, speakerName = null, rate = this.speechRate) {
                    if (!this.isTtsEnabled || !text || !text.trim()) {
                        return;
                    }
                    if (!this.isInitialized) {
                        console.warn("SpeechService not initialized yet.");
                        return;
                    }
                
                    // Cancel any ongoing speech to prevent overlap
                    this.synth.cancel();
                
                    const utter = new SpeechSynthesisUtterance(text);
                    utter.rate = rate;
                
                    // Default to 'brian' for narrator/system voice if no specific speaker is provided
                    const finalSpeakerName = speakerName || 'brian';
                    const voice = this._getVoiceForSpeaker(finalSpeakerName);
                
                    if (voice) {
                        utter.voice = voice;
                    } else {
                        // Fallback if even the default voice isn't found
                        utter.voice = this.voices.find(v => v.lang === 'en-US') || this.voices[0];
                        console.warn(`Voice for speaker "${finalSpeakerName}" not found. Using fallback: ${utter.voice?.name}`);
                    }
                
                    utter.onerror = (e) => {
                        if (e.error !== 'canceled') {
                           console.error("SpeechSynthesisUtterance.onerror", e);
                        }
                    };
                    this.synth.speak(utter);
                }

                toggleTts() {
                    this.isTtsEnabled = !this.isTtsEnabled;
                }
            }
            
            async function speakDialogue(text) {
                if (!speechService || !speechService.isInitialized || !speechService.isTtsEnabled || !text) {
                    return;
                }
                
                // Cancel any ongoing speech first
                if (speechService.synth) speechService.synth.cancel();
                await new Promise(resolve => setTimeout(resolve, 150)); // Short pause to ensure cancellation completes

                const lines = text.split('\n').filter(line => line.trim() !== '');
                const queue = lines.map(line => {
                    const parts = line.split(':');
                    const speaker = parts.length > 1 ? parts[0].trim() : null;
                    const dialogue = (parts.length > 1 ? parts.slice(1).join(':') : line).trim();

                    if (!dialogue) return null;

                    const utter = new SpeechSynthesisUtterance(dialogue);
                    utter.rate = speechService.speechRate;
                    
                    const voice = speechService._getVoiceForSpeaker(speaker);
                    if (voice) {
                        utter.voice = voice;
                    } else {
                        // Fallback if speaker voice not found
                        utter.voice = speechService.voices.find(v => v.lang === 'en-US') || speechService.voices[0];
                    }
                    
                    utter.onerror = (e) => {
                        if (e.error !== 'canceled') {
                            console.error('SpeechSynthesisUtterance.onerror (dialogue)', e);
                        }
                    };
                    
                    return utter;
                }).filter(item => item !== null);

                let currentUtteranceIndex = 0;

                const playNext = () => {
                    if (currentUtteranceIndex < queue.length && speechService.isTtsEnabled) {
                        const item = queue[currentUtteranceIndex];
                        item.onend = playNext; // When this one ends, play the next one
                        speechService.synth.speak(item);
                        currentUtteranceIndex++;
                    }
                };

                playNext();
            }


            window.toggleTTS = (button) => {
                if (!speechService) return;
                speechService.toggleTts(); // Toggles the state
                const isNowEnabled = speechService.isTtsEnabled; // Reads the new state

                const iconPath = isNowEnabled 
                    ? "M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"
                    : "M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z M17 14l-4-4m0 4l4-4";
                button.querySelector('svg').classList.toggle('text-gray-600', isNowEnabled);
                button.querySelector('svg').classList.toggle('text-gray-400', !isNowEnabled);
                button.querySelector('path').setAttribute('d', iconPath);

                if (isNowEnabled) {
                    const pageData = lessonData.pages.find(p => p.id === currentPage);
                     if(pageData) {
                        // Re-trigger speech for the current page
                        if (pageData.type === 'dialogue') {
                            speakDialogue(pageData.content.dialogue);
                        } else {
                            const targetPage = document.getElementById(`page-${currentPage}`);
                            let textToSpeak = '';
                            if (pageData.id === 'reading-main') {
                                const readingContainer = targetPage.querySelector('.space-y-6');
                                if (readingContainer) {
                                    textToSpeak = Array.from(readingContainer.querySelectorAll('h4, p'))
                                        .map(el => el.textContent)
                                        .join(' \n ');
                                }
                            } else { 
                                const readableContent = targetPage.querySelector('.readable-content');
                                const titleElement = targetPage.querySelector('h2, h3');
                                if (readableContent) {
                                    textToSpeak = readableContent.innerHTML;
                                } else if (titleElement) {
                                    textToSpeak = titleElement.innerHTML;
                                }
                            }
                            if (textToSpeak) {
                                speechService.speak(stripHtmlAndEmojis(textToSpeak), 'brian');
                            }
                        }
                    }
                } else {
                    if (speechService.synth) speechService.synth.cancel();
                }
            };
            
            async function initializeAudio() {
                if (audioContext) return;
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    const processorScript = document.getElementById('sequence-processor').textContent;
                    const blob = new Blob([processorScript], { type: 'application/javascript' });
                    const workletURL = URL.createObjectURL(blob);
                    await audioContext.audioWorklet.addModule(workletURL);

                    sequenceNode = new AudioWorkletNode(audioContext, 'sequence-processor');
                    sequenceNode.port.onmessage = (event) => {
                        if (event.data.type === 'noteOn') {
                            const { freq, dur, vol, waveType } = event.data;
                            const now = audioContext.currentTime;
                            const osc = audioContext.createOscillator();
                            const gain = audioContext.createGain();
                            osc.type = waveType;
                            osc.frequency.setValueAtTime(freq, now);
                            gain.gain.setValueAtTime(vol, now);
                            gain.gain.exponentialRampToValueAtTime(0.001, now + dur);
                            osc.connect(gain).connect(audioContext.destination);
                            osc.start(now);
                            osc.stop(now + dur);
                        }
                    };
                    
                    speechService = new SpeechService();
                    await speechService._setupVoices(); // Patched initialization call

                } catch (e) {
                    console.error("Audio/Speech initialization failed:", e);
                }
            }

            const playSound = (isCorrect) => {
                if (!sequenceNode) return;
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                const soundBank = isCorrect ? correctSounds : incorrectSounds;
                const sound = soundBank[Math.floor(Math.random() * soundBank.length)];
                sequenceNode.port.postMessage({
                    type: 'play',
                    sequence: sound.seq
                });
            }

            // --- Background & Completion Animations ---
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            let particles = [];
            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                particles.forEach((p, i) => {
                    p.y -= p.speed;
                    p.x += Math.sin(p.y / 50);
                    if (p.y < -p.radius) particles.splice(i, 1);
                    bgCtx.beginPath();
                    bgCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    bgCtx.globalAlpha = p.opacity;
                    bgCtx.fillStyle = p.color;
                    bgCtx.fill();
                });
                if (Math.random() > 0.97 && particles.length < 100) {
                    particles.push({ x: Math.random() * bgCanvas.width, y: bgCanvas.height + 20, radius: Math.random() * 5 + 2, speed: Math.random() * 2 + 1, color: ['#34d399', '#f59e0b', '#a78bfa'][Math.floor(Math.random() * 3)], opacity: Math.random() * 0.5 + 0.5 });
                }
                requestAnimationFrame(animateBackground);
            }
            window.addEventListener('resize', () => { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; });
            animateBackground();

            function runCompletionAnimation() {
                const canvas = document.getElementById('completion-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
                let fireworks = [], confetti = [];

                function Firework(sx, sy, tx, ty) { this.x = sx; this.y = sy; this.sx = sx; this.sy = sy; this.tx = tx; this.ty = ty; this.distanceToTarget = Math.sqrt(Math.pow(tx - sx, 2) + Math.pow(ty - sy, 2)); this.distanceTraveled = 0; this.angle = Math.atan2(ty - sy, tx - sx); this.speed = 2; this.acceleration = 1.05; this.brightness = Math.random() * 50 + 50; this.targetRadius = 1; this.particles = []; }
                Firework.prototype.update = function(index) { this.speed *= this.acceleration; let vx = Math.cos(this.angle) * this.speed; let vy = Math.sin(this.angle) * this.speed; this.distanceTraveled = Math.sqrt(Math.pow(this.x - this.sx, 2) + Math.pow(this.y - this.sy, 2)); if (this.distanceTraveled >= this.distanceToTarget) { for(let i = 0; i < 30; i++) { this.particles.push(new Particle(this.tx, this.ty)); } fireworks.splice(index, 1); } else { this.x += vx; this.y += vy; } }
                Firework.prototype.draw = function() { ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x - Math.cos(this.angle) * 10, this.y - Math.sin(this.angle) * 10); ctx.strokeStyle = `hsl(${Math.random() * 360}, 100%, ${this.brightness}%)`; ctx.stroke(); }
                function Particle(x, y) { this.x = x; this.y = y; this.angle = Math.random() * Math.PI * 2; this.speed = Math.random() * 10; this.friction = 0.95; this.gravity = 1; this.hue = Math.random() * 360; this.brightness = Math.random() * 50 + 50; this.alpha = 1; this.decay = Math.random() * 0.03 + 0.015; }
                Particle.prototype.update = function(index) { this.speed *= this.friction; this.x += Math.cos(this.angle) * this.speed; this.y += Math.sin(this.angle) * this.speed + this.gravity; this.alpha -= this.decay; if (this.alpha <= this.decay) this.particles.splice(index, 1); }
                Particle.prototype.draw = function() { ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); ctx.fillStyle = `hsla(${this.hue}, 100%, ${this.brightness}%, ${this.alpha})`; ctx.fill(); }
                function Confetti() { this.x = Math.random() * canvas.width; this.y = -20; this.w = 10; this.h = 20; this.speed = Math.random() * 3 + 2; this.gravity = 0.5; this.angle = 0; this.rotation = Math.random() * 0.1 - 0.05; this.color = `hsl(${Math.random() * 360}, 100%, 50%)`; }
                Confetti.prototype.update = function(index) { this.y += this.speed; this.speed += this.gravity; this.angle += this.rotation; if (this.y > canvas.height) confetti.splice(index, 1); }
                Confetti.prototype.draw = function() { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle); ctx.fillStyle = this.color; ctx.fillRect(-this.w / 2, -this.h / 2, this.w, this.h); ctx.restore(); }

                let animationRunning = true;
                function animate() {
                    if (!animationRunning) return;
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.globalCompositeOperation = 'lighter';
                    fireworks.forEach((f, i) => { f.draw(); f.update(i); f.particles.forEach((p, j) => { p.draw(); p.update(j); }); });
                    confetti.forEach((c, i) => { c.draw(); c.update(i); });
                    requestAnimationFrame(animate);
                }
                const interval = setInterval(() => {
                    fireworks.push(new Firework(canvas.width / 2, canvas.height, Math.random() * canvas.width, Math.random() * canvas.height / 2));
                    for(let i = 0; i < 10; i++) confetti.push(new Confetti());
                }, 800);
                setTimeout(() => { clearInterval(interval); setTimeout(() => animationRunning = false, 5000); }, 5000);
                animate();
            }

            // --- APP INITIALIZATION ---
            window.startApp = async function() {
                await initializeAudio();
                navigateTo(lessonData.homePageId);
            }
            
            function startTimer(duration, display, onComplete) {
                let timer = duration;
                const update = () => { display.textContent = `${String(Math.floor(timer/60)).padStart(2,'0')}:${String(timer%60).padStart(2,'0')}`; };
                update();
                timerInterval = setInterval(() => { timer--; update(); if (timer < 0) { clearInterval(timerInterval); if (onComplete) onComplete(); } }, 1000);
            }
            
            function stripHtmlAndEmojis(text) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                return tempDiv.textContent || tempDiv.innerText || "";
            }


            // --- NAVIGATION & PAGE FLOW ---
            window.navigateTo = (pageId) => {
                const targetPage = document.getElementById(`page-${pageId}`);
                if (!targetPage) return console.warn('navigateTo: no page found for id', pageId);
                if (pageId === currentPage) return;
                
                clearInterval(timerInterval);
                if(speechService && speechService.synth) speechService.synth.cancel();

                document.getElementById(`page-${currentPage}`)?.classList.remove('active');
                targetPage.classList.add('active');
                currentPage = pageId;
                if (pageHistory[pageHistory.length - 1] !== currentPage) pageHistory.push(currentPage);
                
                const pageData = lessonData.pages.find(p => p.id === pageId);
                if (!pageData) return;

                if (pageData.type === 'timer') {
                    const timerEl = document.getElementById(pageData.content.timerId);
                    if (timerEl) startTimer(pageData.content.duration, timerEl, goNext);
                } else if (pageData.id === 'final-project-hub') {
                    window.showPhase(1); // Initialize the project hub view
                }

                if (speechService) {
                    if (pageData.type === 'dialogue') {
                        speakDialogue(pageData.content.dialogue);
                    } else {
                        let textToSpeak = '';
                        // Special handling for the tiered reading page to read all texts
                        if (pageData.id === 'reading-main') {
                            const readingContainer = targetPage.querySelector('.space-y-6');
                            if (readingContainer) {
                                textToSpeak = Array.from(readingContainer.querySelectorAll('h4, p'))
                                    .map(el => el.textContent)
                                    .join(' \n ');
                            }
                        } else { // General handling for other pages
                            const readableContent = targetPage.querySelector('.readable-content');
                            const titleElement = targetPage.querySelector('h2, h3');
                            if (readableContent) {
                                textToSpeak = readableContent.innerHTML;
                            } else if (titleElement) {
                                textToSpeak = titleElement.innerHTML;
                            }
                        }
                        
                        if (textToSpeak) {
                            speechService.speak(stripHtmlAndEmojis(textToSpeak), 'brian');
                        }

                        // Also handle animations for specific pages
                        if (pageData.type === 'certificate') {
                            runCompletionAnimation();
                        }
                    }
                }


                updateNavButtons();
                window.scrollTo(0, 0);
            }

            window.goNext = () => {
                const currentIndex = pageSequence.indexOf(currentPage);
                if (currentIndex > -1 && currentIndex < pageSequence.length - 1) navigateTo(pageSequence[currentIndex + 1]);
            }
            window.goBack = () => {
                if (pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); }
            }

            function updateNavButtons() {
                const nav = document.getElementById('nav-header');
                if (!nav) return;
                nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
                const backBtn = nav.querySelector('button:first-child');
                backBtn.disabled = pageHistory.length <= 1;
                backBtn.classList.toggle('opacity-50', backBtn.disabled);
                const nextBtn = nav.querySelector('button:last-child');
                const currentIndex = pageSequence.indexOf(currentPage);
                const isLast = currentIndex >= pageSequence.length - 1;
                const isCertificate = currentPage === 'certificate';
                nextBtn.disabled = isLast || currentPage === lessonData.homePageId || isCertificate;
                nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
            }
            
            // --- UI FEEDBACK, BADGES, & SCORE ---
            function showFeedbackMessage(isCorrect) {
                const phrases = isCorrect ? correctPhrases : incorrectPhrases;
                const message = phrases[Math.floor(Math.random() * phrases.length)];
                
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `feedback-toast ${isCorrect ? 'correct' : 'encouraging'}`;
                toast.setAttribute('role', 'status');
                toast.setAttribute('aria-live', 'assertive');
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4500);

                if (speechService) {
                    speechService.speak(message);
                }
            }

            function updateScore(points) {
                score += points;
                document.getElementById('score-display').textContent = score;
            }

            // --- QUIZ LOGIC ---
            window.checkTfngAnswer = function(clickedButton, chosenAnswer, correctAnswer) {
                const buttonContainer = clickedButton.parentElement;
                Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
                const isCorrect = chosenAnswer === correctAnswer;
                showFeedbackMessage(isCorrect);
                
                const feedbackIcon = document.createElement('span');
                feedbackIcon.className = `ml-2 text-xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'}`;
                feedbackIcon.textContent = isCorrect ? '✓' : '✗';
                clickedButton.closest('.question-group').appendChild(feedbackIcon);

                if (isCorrect) {
                    playSound(true);
                    clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-green-500');
                    updateScore(10);
                } else {
                    playSound(false);
                    clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-red-600');
                    const correctBtn = Array.from(buttonContainer.children).find(btn => btn.textContent === correctAnswer.charAt(0));
                    if (correctBtn) correctBtn.className = correctBtn.className.replace(/bg-\w+-500/, 'bg-green-500');
                }
            }
            
            window.checkMcqAnswer = function(button, isCorrect) {
                const questionGroup = button.closest('.question-group');
                questionGroup.querySelectorAll('.quiz-option').forEach(opt => opt.disabled = true);
                showFeedbackMessage(isCorrect);

                const feedbackIcon = document.createElement('span');
                feedbackIcon.className = `ml-2 text-xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'}`;
                feedbackIcon.textContent = isCorrect ? '✓' : '✗';
                button.appendChild(feedbackIcon);

                if (isCorrect) {
                    playSound(true);
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-green-500', 'border-green-600', 'text-white');
                    updateScore(10);
                } else {
                    playSound(false);
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-red-500', 'border-red-600', 'text-white');
                    const correctButton = questionGroup.querySelector(".quiz-option[data-correct='true']");
                    if (correctButton) {
                        correctButton.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                        correctButton.classList.add('bg-green-500', 'border-green-600', 'text-white');
                    }
                }
            }

            function initGapFill(pageId) {
                const page = document.getElementById(pageId);
                if (!page) return;
                const gaps = page.querySelectorAll('.gap');
                const words = page.querySelectorAll('.word-bank-word');
                const wordBank = page.querySelector('.word-bank-container');

                words.forEach(word => {
                    word.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', word.dataset.word); setTimeout(() => word.classList.add('opacity-50'), 0); });
                    word.addEventListener('dragend', () => word.classList.remove('opacity-50'));
                    word.addEventListener('click', handleWordClick);
                });

                gaps.forEach(gap => {
                    gap.addEventListener('dragover', e => e.preventDefault());
                    gap.addEventListener('drop', e => handleDrop(e, gap));
                    gap.addEventListener('click', handleGapClick);
                });

                function handleWordClick(e) {
                    const clickedWord = e.currentTarget;
                    if (clickedWord.parentElement.classList.contains('gap')) {
                        clickedWord.parentElement.classList.remove('correct', 'incorrect');
                        wordBank.appendChild(clickedWord);
                        return;
                    }
                    if (selectedWord.element) selectedWord.element.classList.remove('selected');
                    if (selectedWord.element === clickedWord) {
                        selectedWord = { element: null, text: '' };
                    } else {
                        selectedWord = { element: clickedWord, text: clickedWord.dataset.word };
                        clickedWord.classList.add('selected');
                    }
                }

                function handleGapClick(e) {
                    const clickedGap = e.currentTarget;
                    if (!selectedWord.element || clickedGap.children.length > 0) return;
                    const wordElement = selectedWord.element;
                    clickedGap.appendChild(wordElement);
                    wordElement.classList.remove('selected');
                    checkGap(clickedGap);
                    selectedWord = { element: null, text: '' };
                }

                function handleDrop(e, gap) {
                    e.preventDefault();
                    if (gap.children.length > 0) return;
                    const wordText = e.dataTransfer.getData('text/plain');
                    const wordElement = page.querySelector(`.word-bank-word[data-word="${wordText}"]`);
                    if (wordElement) {
                        gap.appendChild(wordElement);
                        checkGap(gap);
                    }
                }

                function checkGap(gap) {
                    const word = gap.querySelector('.word-bank-word');
                    const isCorrect = word && word.dataset.word === gap.dataset.answer;
                    gap.classList.remove('correct', 'incorrect');
                    gap.classList.add(isCorrect ? 'correct' : 'incorrect');
                    if (isCorrect) {
                        playSound(true);
                        updateScore(10);
                        showFeedbackMessage(true);
                        word.draggable = false;
                    } else {
                        playSound(false);
                        showFeedbackMessage(false);
                    }
                }
            }
            
            window.generateCertificate = function() {
                const name = document.getElementById('name-input-cert').value || "Dedicated Learner";
                document.getElementById('certificate-name').textContent = name;
                document.getElementById('certificate-score').textContent = score;
                document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
                document.getElementById('cert-initial-controls').classList.add('hidden');
                document.getElementById('cert-generated-controls').classList.remove('hidden');
            }

            window.downloadCertificateAsImage = function() {
                const certElement = document.getElementById('certificate-to-print');
                html2canvas(certElement, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'renewable-energy-certificate.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            }

            // --- DYNAMIC PAGE & QUIZ GENERATION ---
            function createPageElement(id, content) {
                const section = document.createElement('section');
                section.id = `page-${id}`;
                section.className = 'page';
                section.innerHTML = content;
                document.getElementById('dynamic-pages-container').appendChild(section);
            }
            
            function populateQuizzes() {
                // Vocab Match Quiz
                const vocabMatchPage = lessonData.pages.find(p => p.id === 'vocab-match');
                vocabMatchPage.content.questions = lessonData.vocabulary.map((v, i) => {
                    const otherDefs = lessonData.vocabulary.filter((_, idx) => idx !== i).map(item => item.def);
                    const options = [v.def, ...otherDefs.sort(() => 0.5 - Math.random()).slice(0, 3)].sort(() => 0.5 - Math.random());
                    return { question: `What is the definition of "${v.word}"?`, options: options, correctAnswer: v.def };
                });

                // Reading Comprehension Quizzes
                lessonData.pages.find(p => p.id === 'reading-quiz-gap-fill').content.sentences = [
                    { text: ['A wind', 'uses moving air to generate electricity.'], answer: 'turbine' }, { text: ['The main network that distributes electricity is called the', '.'], answer: 'power grid' }, { text: ['A key goal for global', 'is ensuring all children have access to quality education.'], answer: 'development' }, { text: ['Lack of internet access in some areas creates a significant', '.'], answer: 'digital divide' }, { text: ['Providing clean energy to all communities is a matter of', '.'], answer: 'energy equity' }
                ];
                lessonData.pages.find(p => p.id === 'reading-quiz-tfng').content.questions = [
                    { statement: 'Off-grid communities are connected to the main power supply.', correctAnswer: 'False' }, { statement: 'Renewable energy can help students study at night.', correctAnswer: 'True' }, { statement: 'The digital divide refers to the different prices of computers.', correctAnswer: 'False' }, { statement: 'A battery can store electricity for later use.', correctAnswer: 'True' }, { statement: 'Building large power plants is the only way to get electricity to remote areas.', correctAnswer: 'False' },
                ];
                lessonData.pages.find(p => p.id === 'reading-quiz-mcq').content.questions = [
                     { question: 'What is the main problem described in the texts?', options: ['Solar panels are too expensive.', 'A lack of electricity creates barriers to education.', 'Wind turbines are too noisy.', 'Students don’t like to study at night.'], correctAnswer: 'A lack of electricity creates barriers to education.' }, { question: 'What does “decentralized renewable energy” mean in the text?', options: ['A single, giant power station for the whole country.', 'Energy that is not controlled by the government.', 'Small, local power systems not connected to the main grid.', 'Energy that is free for everyone.'], correctAnswer: 'Small, local power systems not connected to the main grid.' }, { question: 'How does electricity help bridge the digital divide?', options: ['It makes books cheaper.', 'It allows people to use computers and the internet.', 'It makes the school day shorter.', 'It helps teachers travel to remote areas.'], correctAnswer: 'It allows people to use computers and the internet.' }, { question: 'Which of the following is NOT a benefit of solar power mentioned in the texts?', options: ['It provides light for studying at night.', 'It enables the use of digital learning tools.', 'It works better during a storm.', 'It can be installed in remote, off-grid locations.'], correctAnswer: 'It works better during a storm.' }, { question: 'The term Energiewende in Germany refers to the country’s...', options: ['Educational reform policy.', 'Transition to renewable energy sources.', 'Plan to build more highways.', 'National holiday for engineers.'], correctAnswer: 'Transition to renewable energy sources.' },
                ];
                
                // Listening Quizzes
                lessonData.pages.find(p => p.id === 'lecture-digital-divide-quiz-mcq').content.questions = [
                    { question: 'What is the main problem discussed in the lecture?', options: ['Climate change', 'The digital divide in education', 'Air pollution', 'Traffic in cities'], correctAnswer: 'The digital divide in education' }, { question: 'Why is traditional grid expansion not always a good solution for rural areas?', options: ['It is too fast', 'It is too expensive and difficult to build', 'It uses too much water', 'It causes pollution'], correctAnswer: 'It is too expensive and difficult to build' }, { question: 'What is one benefit of solar microgrids for schools?', options: ['They make schools bigger', 'They provide reliable power for learning tools', 'They reduce the number of students', 'They replace teachers'], correctAnswer: 'They provide reliable power for learning tools' }, { question: 'What does battery storage help with?', options: ['Making food', 'Keeping power available after sunset', 'Cleaning classrooms', 'Teaching math'], correctAnswer: 'Keeping power available after sunset' }, { question: 'What does the speaker say is needed for long-term success?', options: ['More exams', 'Community training and local ownership', 'More textbooks', 'Bigger school buildings'], correctAnswer: 'Community training and local ownership' }
                ];
                lessonData.pages.find(p => p.id === 'lecture-digital-divide-quiz-tfng').content.questions = [
                    { statement: "Decentralized renewable energy can help schools in remote areas.", correctAnswer: 'True' }, { statement: "The lecture says solar panels are only useful in cities.", correctAnswer: 'False' }, { statement: "Battery storage helps schools use power at night.", correctAnswer: 'True' }, { statement: "The speaker says only governments should solve the digital divide.", correctAnswer: 'False' }, { statement: "The lecture mentions that students can use online libraries and remote tutoring.", correctAnswer: 'True' }
                ];
                lessonData.pages.find(p => p.id === 'lecture-digital-divide-quiz-gap-fill').content.sentences = [
                    { text: ['Extending traditional power grids is often too expensive and logistically', '.'], answer: 'difficult' }, { text: ['By generating power', ', we can bypass the limitations of centralized grids.'], answer: 'locally' }, { text: ['Battery storage ensures power is available even after', '.'], answer: 'sunset' }, { text: ['Success requires sustainable models with community training and local', '.'], answer: 'ownership' }, { text: ['Bridging the digital divide is a pathway to educational', 'and empowerment.'], answer: 'equity' }
                ];

                lessonData.pages.find(p => p.id === 'podcast-convo-energy-quiz-mcq').content.questions = [
                    { question: 'What does Alex say decentralized renewable energy could help solve?', options: ['Climate change', 'The digital divide in rural education', 'Traffic problems', 'Food shortages'], correctAnswer: 'The digital divide in rural education' }, { question: 'What concern does Chris raise about using technology in remote areas?', options: ['People don’t want it', 'It’s too fast', 'It’s hard to maintain and expensive', 'It’s already perfect'], correctAnswer: 'It’s hard to maintain and expensive' }, { question: 'What solution does Sarah suggest to help overcome infrastructure challenges?', options: ['Building more cities', 'Community training and new funding models', 'Using more textbooks', 'Sending teachers to cities'], correctAnswer: 'Community training and new funding models' }, { question: 'What does Alex say about pilot programs?', options: ['They are too expensive', 'They don’t work', 'They show inspiring results', 'They are only for big cities'], correctAnswer: 'They show inspiring results' }, { question: 'What do all speakers agree on by the end of the conversation?', options: ['The challenge is too difficult', 'The idea should be delayed', 'The potential is worth the effort', 'Only governments should act'], correctAnswer: 'The potential is worth the effort' }
                ];
                lessonData.pages.find(p => p.id === 'podcast-convo-energy-quiz-tfng').content.questions = [
                    { statement: "Decentralized energy means power from local sources like solar panels.", correctAnswer: 'True' }, { statement: "Chris believes internet access is easy to provide in rural areas.", correctAnswer: 'False' }, { statement: "Sarah says rooftop gardens can help rural schools.", correctAnswer: 'Not Given' }, { statement: "Alex believes the emotional impact of connecting kids to the internet is powerful.", correctAnswer: 'True' }, { statement: "The speakers think only technology companies should solve the problem.", correctAnswer: 'False' }
                ];
                lessonData.pages.find(p => p.id === 'podcast-convo-energy-quiz-gap-fill').content.sentences = [
                    { text: ['Sarah says lack of access feels terribly', '.'], answer: 'unfair' }, { text: ['Chris is skeptical about how easy it will be to implement and', 'all the tech.'], answer: 'maintain' }, { text: ['The social return on', 'in education is immense.'], answer: 'investment' }, { text: ['Sarah says the situation requires a', 'approach.'], answer: 'multifaceted' }, { text: ['Chris worries about the', 'like dodgy connections and flat batteries.'], answer: 'practicalities' }
                ];

                lessonData.pages.find(p => p.id === 'dilemma-solar-farm-quiz-mcq').content.questions = [
                    { question: 'What is Emma’s main reason for choosing Location A?', options: ['It is cheaper to build there', 'It is closer to the power grid', 'It is sacred land with cultural significance', 'It has better sunlight exposure'], correctAnswer: 'It is sacred land with cultural significance' }, { question: 'What does Sarah say about the 5,000 people in the rural town?', options: ['They can easily relocate', 'Their livelihoods would be devastated', 'They support the solar farm', 'They are not aware of the project'], correctAnswer: 'Their livelihoods would be devastated' }, { question: 'What ethical principle does Emma emphasize?', options: ['Economic growth', 'Cultural preservation and non-removal', 'Technological innovation', 'Majority rule'], correctAnswer: 'Cultural preservation and non-removal' }, { question: 'What alternative does David suggest?', options: ['Building on both sites', 'Delaying the project', 'Using smaller, distributed solar projects', 'Asking the government to decide'], correctAnswer: 'Using smaller, distributed solar projects' }, { question: 'What does the group agree on at the end?', options: ['Location A is the best choice', 'There is no perfect solution', 'The farmland should be protected', 'The indigenous community should be relocated'], correctAnswer: 'There is no perfect solution' }
                ];
                lessonData.pages.find(p => p.id === 'dilemma-solar-farm-quiz-tfng').content.questions = [
                    { statement: "Sarah is from Los Angeles, California.", correctAnswer: 'True' }, { statement: "David believes the farmland is more important than the sacred land.", correctAnswer: 'True' }, { statement: "Emma says the indigenous community has already agreed to relocate.", correctAnswer: 'False' }, { statement: "The group discusses the possibility of negotiating with both communities.", correctAnswer: 'True' }, { statement: "Dr. Chen is present during the discussion.", correctAnswer: 'False' }
                ];
                lessonData.pages.find(p => p.id === 'dilemma-solar-farm-quiz-gap-fill').content.sentences = [
                    { text: ['David describes the dilemma as a conflict between utilitarian and', 'ethics.'], answer: 'deontological' }, { text: ['Emma argues that the sacred land is', 'because of its cultural and historical value.'], answer: 'irreplaceable' }, { text: ['Sarah believes that losing the farmland would be devastating to the rural town’s', '.'], answer: 'livelihoods' }, { text: ['Emma refers to the trauma of the', 'Generations as a real-world example.'], answer: 'Stolen' }, { text: ['David suggests exploring smaller, distributed solar projects to reduce the massive', '.'], answer: 'footprint' }
                ];

                lessonData.pages.find(p => p.id === 'dilemma-wind-farm-quiz-mcq').content.questions = [
                    { question: 'What is Emma’s main concern about investing in the wind farm?', options: ['The wind farm is not reliable', 'Her town might be exploited financially', 'The technology is too new', 'The energy is not clean'], correctAnswer: 'Her town might be exploited financially' }, { question: 'What does Sarah say about not investing at all?', options: ['It will delay the project', 'It will cause pollution and blackouts', 'It will save money', 'It will improve trust'], correctAnswer: 'It will cause pollution and blackouts' }, { question: 'What solution does David propose to build trust between towns?', options: ['A public debate', 'A third-party mediator', 'A government subsidy', 'A shared energy contract'], correctAnswer: 'A third-party mediator' }, { question: 'What strategy does David mention that Dr. Chen suggested?', options: ['Phased investment', 'Legal action', 'Advertising campaign', 'Price matching'], correctAnswer: 'Phased investment' }, { question: 'What does the group agree on at the end of the discussion?', options: ['The wind farm should be canceled', 'There is no easy answer', 'The other town should pay more', 'The old power source is better'], correctAnswer: 'There is no easy answer' }
                ];
                lessonData.pages.find(p => p.id === 'dilemma-wind-farm-quiz-tfng').content.questions = [
                    { statement: "Sarah is from Los Angeles, California.", correctAnswer: 'True' }, { statement: "David believes both towns should invest in the wind farm.", correctAnswer: 'True' }, { statement: "Emma says her town has already invested in the wind farm.", correctAnswer: 'False' }, { statement: "The group discusses using a mediator to ensure fairness.", correctAnswer: 'True' }, { statement: "Dr. Chen is present during the discussion.", correctAnswer: 'False' }
                ];
                lessonData.pages.find(p => p.id === 'dilemma-wind-farm-quiz-gap-fill').content.sentences = [
                    { text: ['David describes the situation as a classic', 'action problem.'], answer: 'collective' }, { text: ['Emma worries that her town might be', 'if the other town doesn’t invest.'], answer: 'exploited' }, { text: ['Sarah says relying on old power sources is increasingly', '.'], answer: 'unsustainable' }, { text: ['Emma says the issue is not just about energy, but also about her town’s', '.'], answer: 'finances' }, { text: ['David suggests involving a third-party', 'to ensure fairness.'], answer: 'mediator' }
                ];
            }

            function initializeLesson() {
                document.getElementById('main-title').innerHTML = lessonData.title;
                document.getElementById('main-subtitle').innerHTML = lessonData.subtitle;
                document.getElementById('main-svg-container').innerHTML = `<svg viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:rgb(251, 191, 36);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(249, 115, 22);stop-opacity:1" /></linearGradient></defs><rect width="600" height="300" fill="#fffbeb"/><path d="M50,150 C150,50 350,50 450,150 S550,250 650,150" stroke="url(#grad1)" stroke-width="8" fill="none" stroke-linecap="round" opacity="0.5"/><path d="M-50,200 C50,100 250,100 350,200 S450,300 550,200" stroke="url(#grad1)" stroke-width="8" fill="none" stroke-linecap="round" opacity="0.7"/><text x="50%" y="45%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="48" fill="#b45309" font-weight="bold">Powering Potential <tspan aria-hidden="true">💡</tspan></text></svg>`;

                populateQuizzes();

                const menuButtons = lessonData.mainMenu.map(item => {
                    const colors = { green: 'bg-green-500 border-green-700', blue: 'bg-blue-500 border-blue-700', sky: 'bg-sky-500 border-sky-700', amber: 'bg-amber-500 border-amber-700', rose: 'bg-rose-500 border-rose-700', violet: 'bg-violet-500 border-violet-700', teal: 'bg-teal-500 border-teal-700', orange: 'bg-orange-500 border-orange-700', indigo: 'bg-indigo-500 border-indigo-700', lime: 'bg-lime-500 border-lime-700', emerald: 'bg-emerald-500 border-emerald-700', red: 'bg-red-500 border-red-700', purple: 'bg-purple-500 border-purple-700' };
                    return `<button onclick="navigateTo('${item.target}')" class="btn-animated-3d ${colors[item.color] || colors['green']} text-white font-bold text-xl p-4 rounded-xl">${item.text}</button>`;
                }).join('');
                createPageElement(lessonData.homePageId, `<div class="bg-white rounded-2xl shadow-lg p-8"><h2 class="text-4xl font-bold text-center text-amber-800 mb-8">Main Menu</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4">${menuButtons}</div></div>`);
                
                // Build the master page sequence for next/back buttons
                pageSequence = [lessonData.startPageId, lessonData.homePageId];
                const menuOrder = lessonData.mainMenu.map(item => item.target);
                const pageOrderMap = {
                    'tps-start': ['tps-think', 'tps-pair', 'tps-share'],
                    'warm-up': ['vocab-start'],
                    'vocab-start': lessonData.vocabulary.map((v, i) => `vocab-${i}`),
                    'reading-main': ['reading-quiz-gap-fill', 'reading-quiz-tfng', 'reading-quiz-mcq'],
                    'lecture-digital-divide': ['lecture-digital-divide-quiz-mcq', 'lecture-digital-divide-quiz-tfng', 'lecture-digital-divide-quiz-gap-fill'],
                    'podcast-convo-energy': ['podcast-convo-energy-quiz-mcq', 'podcast-convo-energy-quiz-tfng', 'podcast-convo-energy-quiz-gap-fill'],
                    'dilemma-solar-farm': ['dilemma-solar-farm-quiz-mcq', 'dilemma-solar-farm-quiz-tfng', 'dilemma-solar-farm-quiz-gap-fill'],
                    'dilemma-wind-farm': ['dilemma-wind-farm-quiz-mcq', 'dilemma-wind-farm-quiz-tfng', 'dilemma-wind-farm-quiz-gap-fill'],
                    'thinking-prompts': ['exam-practice'],
                    'final-project-hub': ['writing-task', 'self-assessment', 'certificate']
                };
                 // Add the vocab quiz after the last vocab card
                pageOrderMap[`vocab-${lessonData.vocabulary.length - 1}`] = ['vocab-match'];

                menuOrder.forEach(startId => {
                    let queue = [startId];
                    let visited = new Set([startId]);
                    while(queue.length > 0) {
                        let current = queue.shift();
                        if (!pageSequence.includes(current)) {
                            pageSequence.push(current);
                        }
                        if (pageOrderMap[current]) {
                            pageOrderMap[current].forEach(next => {
                                if (!visited.has(next)) {
                                    queue.push(next);
                                    visited.add(next);
                                }
                            });
                        }
                    }
                });

                lessonData.vocabulary.forEach((v, i) => {
                    createPageElement(`vocab-${i}`, `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h3 class="text-2xl font-bold text-sky-600 mb-2">Vocabulary ${i + 1} / ${lessonData.vocabulary.length}</h3><div class="my-8"><h2 class="text-5xl font-bold text-gray-800 mb-4">${v.word}</h2><p class="text-2xl text-gray-600 mb-4">${v.def}</p><p class="text-xl text-gray-500 italic">"${v.sentence}"</p></div></div></div>`);
                });

                lessonData.pages.forEach(page => {
                    let pageHTML = '';
                    switch (page.type) {
                        case 'simple':
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-gray-800 mb-6">${page.content.title}</h2><p class="text-xl text-gray-600 mb-8">${page.content.text}</p></div></div>`;
                            break;
                        case 'timer':
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col justify-center text-left pt-16"><div class="w-full flex justify-between items-center mb-4"><h2 class="text-2xl md:text-3xl font-bold text-green-700">${page.content.title}</h2><div id="${page.content.timerId}" class="text-3xl md:text-4xl font-bold text-gray-700 ml-4"></div></div><div class="readable-content"><p class="text-lg md:text-xl text-gray-600 mt-8">${page.content.text}</p></div></div>`;
                            break;
                        case 'dialogue':
                        case 'lecture':
                        case 'html-content':
                            const titleColor = { 'dialogue': 'text-orange-700', 'lecture': 'text-amber-700', 'html-content': 'text-rose-700' }[page.type] || 'text-gray-800';
                            const contentHTML = page.type === 'html-content' ? page.content.html : (page.content.dialogue || '').split('\n\n').map(line => {
                                const [speaker, ...rest] = line.split(':');
                                return `<p><strong class="text-amber-700">${speaker}:</strong>${rest.join(':')}</p>`
                            }).join('');
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center ${titleColor} mb-6">${page.content.title}</h2><div class="readable-content text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg max-h-[70vh] overflow-y-auto">${contentHTML}</div></div>`;
                            break;
                        case 'quiz-tfng':
                        case 'quiz-mcq':
                        case 'quiz-gap-fill':
                            let questionsHTML = '';
                            if (page.type === 'quiz-tfng') {
                                questionsHTML = page.content.questions.map((q, index) => {
                                    const buttonsHTML = ['True', 'False', 'Not Given'].map(label => `<button onclick="checkTfngAnswer(this, '${label}', '${q.correctAnswer}')" class="tfng-button bg-${label === 'True' ? 'blue' : label === 'False' ? 'red' : 'gray'}-500 text-white font-bold w-12 h-10 rounded-full">${label.charAt(0)}</button>`).join('');
                                    return `<div class="question-group flex items-center gap-4 p-4 rounded-lg bg-gray-100"><div class="button-container flex-shrink-0 flex gap-2">${buttonsHTML}</div><p>${index + 1}. ${q.statement}</p></div>`;
                                }).join('');
                            } else if (page.type === 'quiz-mcq') {
                                questionsHTML = page.content.questions.map((q, index) => {
                                    const optionsHTML = q.options.map(opt => `<button onclick="checkMcqAnswer(this, ${opt === q.correctAnswer})" data-correct="${opt === q.correctAnswer}" class="quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200">${opt}</button>`).join('');
                                    return `<div class="question-group ${index > 0 ? 'border-t pt-6' : ''}"><p class="font-semibold mb-2">${index + 1}. ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-2">${optionsHTML}</div></div>`;
                                }).join('');
                            } else if (page.type === 'quiz-gap-fill') {
                                const words = page.content.sentences.map(s => s.answer).sort(() => Math.random() - 0.5);
                                const gapFillHTML = page.content.sentences.map((s, i) => `<p class="text-lg mb-4">${i + 1}. ${s.text[0]} <span class="gap" data-answer="${s.answer}"></span> ${s.text[1]}</p>`).join('');
                                const wordBankHTML = words.map(w => `<div class="word-bank-word" draggable="true" data-word="${w}">${w}</div>`).join('');
                                questionsHTML = `<div class="gap-fill-container">${gapFillHTML}</div><div class="word-bank-container mt-8 p-4 bg-gray-100 rounded-lg flex flex-wrap gap-4 justify-center">${wordBankHTML}</div>`;
                            }
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h3 class="text-3xl font-bold text-pink-600 mb-6 text-center">${page.content.title}</h3><div class="space-y-6">${questionsHTML}</div></div>`;
                            break;
                        case 'writing-task':
                            const startersHTML = page.content.starters.map(s => `<li class="text-gray-500">${s}</li>`).join('');
                            const wordBankHTML = page.content.wordBank ? `<div class="mt-6"><h4 class="font-bold text-lg text-indigo-600">Word Bank:</h4><div class="flex flex-wrap gap-2 mt-2 p-4 bg-gray-100 rounded-lg">${page.content.wordBank.map(w => `<span class="bg-white px-2 py-1 rounded-md shadow-sm text-gray-700">${w}</span>`).join('')}</div></div>` : '';
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-center text-indigo-700 mb-6">${page.content.title}</h2><div class="text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg"><h3 class="font-bold text-xl text-indigo-600">Prompt:</h3><p>${page.content.prompt}</p><h3 class="font-bold text-xl text-indigo-600 mt-4">Sentence Starters:</h3><ul class="list-disc list-inside ml-4">${startersHTML}</ul>${wordBankHTML}</div></div><div class="text-center mt-6"><button onclick="goNext()" class="action-button bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-xl hover:bg-blue-700">Continue to Final Reflection</button></div></div>`;
                            break;
                        case 'certificate':
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16 relative overflow-hidden"><canvas id="completion-canvas"></canvas><div class="relative z-10"><div class="readable-content"><h2 class="text-4xl font-bold text-amber-600 mb-4">${page.content.title}</h2><p class="text-xl text-gray-600 mb-6">${page.content.text}</p></div><div id="certificate-to-print" class="bg-amber-50 border-4 border-dashed border-amber-300 rounded-lg p-8 max-w-2xl mx-auto"><div class="flex justify-center mb-4"><span class="text-6xl">💡</span></div><h3 class="text-3xl font-bold text-amber-800">${page.content.certificateTitle}</h3><p class="mt-4 text-lg">This certificate is awarded to</p><p id="certificate-name" class="text-2xl font-bold text-amber-600 my-2 border-b-2 border-gray-400 pb-2">[Enter Your Name Here]</p><p class="mt-4 text-lg">for successfully completing this lesson.</p><p class="mt-6 text-md"><strong>Final Score:</strong> <span id="certificate-score" class="font-bold"></span> points</p><p class="text-sm mt-1"><strong>Date of Completion:</strong> <span id="certificate-date"></span></p></div><div id="cert-controls" class="mt-6"><div id="cert-initial-controls"><input type="text" id="name-input-cert" placeholder="Enter your name for the certificate" class="text-center p-2 border rounded-lg w-full max-w-md"><button onclick="generateCertificate()" class="action-button mt-4 bg-amber-600 text-white font-bold py-2 px-6 rounded-full hover:bg-amber-700">Generate Certificate</button></div><div id="cert-generated-controls" class="hidden mt-4 flex flex-wrap justify-center gap-4"><button onclick="downloadCertificateAsImage()" class="action-button bg-green-600 text-white font-bold py-2 px-4 rounded-full text-sm">Download Image</button></div></div></div></div>`;
                            break;
                    }
                    if (pageHTML) {
                        createPageElement(page.id, pageHTML);
                        if (page.type === 'quiz-gap-fill') {
                            initGapFill(`page-${page.id}`);
                        }
                    }
                });
                
                updateNavButtons();
            }

            initializeLesson();
            
            document.getElementById('keywordModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
