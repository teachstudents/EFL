<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listening Challenge: Fruit Choices</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-image: linear-gradient(to bottom right, #e9d5ff, #fbcfe8); /* Tailwind purple-200 to pink-200 */
            color: #374151; /* Tailwind gray-700 */
            padding: 20px;
            text-align: center;
        }
        .hidden { display: none !important; }
        .game-container {
            background-color: white;
            padding: 25px 30px; 
            border-radius: 16px; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.1); 
            width: 100%;
            max-width: 750px; 
            margin-top: 20px;
        }
        #start-screen input[type="text"] {
            border: 2px solid #d1d5db; /* Tailwind gray-300 */
            padding: 12px 15px; 
            border-radius: 8px;
            margin-right: 10px;
            width: calc(100% - 140px); 
            max-width: 320px;
            transition: border-color 0.3s ease;
            color: #1e293b;
        }
        #start-screen input[type="text"]:focus {
            border-color: #7c3aed; /* Tailwind purple-600 */
            outline: none;
        }
        .game-button, .choice-button, .action-button, .settings-button { 
            padding: 12px 24px; 
            font-size: 1.05rem; 
            font-weight: 600; 
            color: #1f2937; /* Default black/dark gray text */
            background-color: white;
            border: 1px solid #cbd5e1; /* slate-300 border */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, border-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .game-button:hover:not(:disabled), .settings-button:hover { 
            background-color: #f9fafb; /* gray-50 */ 
            border-color: #9ca3af; /* gray-400 */
            transform: translateY(-1px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.07); 
        }
        .game-button:disabled {
            background-color: #f3f4f6; /* gray-100 */
            color: #9ca3af; /* gray-400 */
            border-color: #e5e7eb; /* gray-200 */
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        .choice-button {
            border: 1px solid #9ca3af; /* gray-400 */
            margin: 6px;
            display: block;
            width: 100%;
            font-size: 1rem; 
            padding-top: 10px; 
            padding-bottom: 10px;
            line-height: 1.4; 
        }
        .choice-button:hover:not(:disabled) { 
            background-color: #f3f4f6; /* gray-100 */ 
            border-color: #6b7280; /* gray-500 */
            transform: translateY(-1px); 
        }
        .choice-button.correct { background-color: #10b981; color: white; border-color: #059669;}
        .choice-button.incorrect { background-color: #f43f5e; color: white; border-color: #e11d48;}
        .choice-button:disabled { 
             opacity: 0.7;
        }
        .choice-button.correct:disabled, .choice-button.incorrect:disabled {
            opacity: 1; 
        }


        .action-button { 
            border: 1px solid #60a5fa; /* blue-400 */
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        .action-button:hover {
            background-color: #eff6ff; /* blue-50 */
            border-color: #3b82f6; /* blue-500 */
        }
        
        #game-stats div { margin: 6px 0; font-size: 1rem; color: #334155; }
        #game-stats span.font-bold { color: #1e293b; }

        .modal-overlay {
            background-color: rgba(30, 41, 59, 0.7); 
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 15px;
        }
        .modal-content {
            background-color: white;
            padding: 30px; 
            border-radius: 12px; 
            width: 95%;
            max-width: 600px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative; 
        }
        #feedback { font-weight: 600; margin-top: 15px; min-height: 28px; font-size: 1.1rem; }
        #example-sentence-feedback { /* Will show the scenario text */
            margin-top: 8px;
            font-style: normal; 
            color: #4b5563; 
            font-size: 0.95rem;
            border-top: 1px dashed #e5e7eb;
            padding-top: 8px;
            text-align: left;
        }
        #badge-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #7c3aed; /* purple-600 */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            font-weight: 600;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        #badges-display span {
            background-color: #facc15; 
            color: #78350f; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 0.85rem;
            font-weight: 500;
            margin: 0 4px;
            display: inline-block;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .voice-selector-container {
            margin: 15px 0; padding: 15px; background-color: #f5f3ff; /* violet-50 */ border-radius: 10px;
            border: 1px solid #ede9fe; /* violet-100 */
        }
        #voiceSelect {
            padding: 10px 14px; 
            border-radius: 8px;
            border: 2px solid #ddd6fe; /* violet-200 */
            background-color: white;
            min-width: 220px;
            font-weight: 500;
            color: #374151;
            transition: border-color 0.3s ease;
        }
        #voiceSelect:focus {
            border-color: #7c3aed; /* purple-600 */
            outline: none;
        }
        #current-activity-display {
            min-height: 60px; 
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f0f0f8; 
            border-radius: 8px;
            border: 1px solid #e2e0f0; 
            color: #4338ca; /* indigo-700 */
            font-style: italic;
            font-weight: 500;
        }
        #rewardGif {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 150px; 
            max-height: 150px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001; 
        }
        
        #question-stimulus-display { 
            font-size: 1.2rem;
            font-weight: 500;
            color: #4338ca; 
            margin-bottom: 10px;
        }
        .settings-button {
            padding: 8px 16px;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        .settings-modal-content label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #374151;
        }
         .settings-modal-content input[type="checkbox"] {
            margin-right: 8px;
            accent-color: #7c3aed;
        }


        @media (max-width: 480px) { 
            #start-screen input[type="text"] {
                 width: 100%; max-width: none; margin-bottom:10px; margin-right:0;
            }
            .game-button, .choice-button, .action-button, .settings-button { padding: 10px 18px; font-size: 0.95rem;}
            .game-container { padding: 20px 15px; }
            .choice-button { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <audio id="correctSoundEffect" preload="auto"></audio> 
    <audio id="incorrectSoundEffect" preload="auto"></audio> 
    <div id="badge-alert" class="hidden">Badge Unlocked!</div>

    <div id="start-screen" class="game-container text-center">
        <h1 class="text-4xl font-bold mb-4 text-purple-700">Listening Challenge: Fruit Choices</h1>
        <p class="mb-6 text-slate-600 text-lg">Enter your name and test your listening skills!</p>
        <div class="flex flex-col sm:flex-row items-center justify-center">
            <input type="text" id="username" placeholder="Your Gamer Name">
            <button id="start-button" class="game-button mt-3 sm:mt-0">Start Game</button>
        </div>
    </div>

    <div id="game-screen" class="game-container hidden">
        <div class="flex flex-wrap justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-purple-700">Go, <span id="display-username"></span>!</h2>
            <div>
                 <button id="settings-button" class="settings-button mr-2">Settings</button>
                 <button id="quit-button" class="game-button !bg-rose-500 hover:!bg-rose-600 !text-white">Quit</button>
            </div>
        </div>
        
        <div id="game-stats" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6 text-slate-700">
            <div>Score: <span id="score" class="font-bold text-xl">0</span> / <span id="total-possible-score" class="font-bold text-xl">0</span></div> 
            <div>Questions: <span id="questions-answered" class="font-bold text-xl">0</span>/<span id="total-questions" class="text-xl">0</span></div> 
            <div>Badges: <span id="badges-display">None</span></div>
        </div>

        <div class="voice-selector-container">
            <label for="voiceSelect" class="text-slate-700 font-semibold">Select English Voice:</label>
            <select id="voiceSelect"></select>
        </div>
        
        <div id="current-activity-display" class="text-lg">
            Click "Start First Question" to begin!
        </div>
        <button id="initiate-question-button" class="game-button mt-4">Start First Question / Next Question</button>

    </div>

    <div id="question-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <img id="rewardGif" class="hidden" alt="Reward Animation"> 
            <div class="flex justify-between items-center mb-2">
                <p class="text-sm text-slate-500">Question Timer: <span id="modal-timer" class="font-bold text-base">--</span>s</p>
                <button id="repeat-button" class="action-button">Repeat Audio</button>
            </div>
            <div id="question-stimulus-display" class="mb-4 p-4 bg-slate-100 rounded-lg min-h-[60px] flex flex-col justify-center items-center">
                Listen to the story...
            </div>
            <p id="question-text" class="mb-5 text-xl font-semibold text-slate-800"></p>
            <div id="answer-options" class="grid grid-cols-1 sm:grid-cols-2 gap-3"> 
                {/* Answer buttons will be dynamically added here by JavaScript */}
            </div>
            <div id="feedback" class="mt-5"></div>
            <div id="example-sentence-feedback" class="hidden"></div> 
            <button id="next-question-button-modal" class="game-button mt-5 hidden w-full !bg-emerald-500 hover:!bg-emerald-600 text-white">Next Question</button>
        </div>
    </div>
    
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="settings-modal-content modal-content">
            <h3 class="text-2xl font-bold mb-6 text-purple-700">Settings</h3>
            <div>
                <label for="toggle-tts">
                    <input type="checkbox" id="toggle-tts" checked> Enable Text-to-Speech
                </label>
            </div>
            <div class="mt-4">
                <label for="toggle-sfx">
                    <input type="checkbox" id="toggle-sfx" checked> Enable Sound Effects
                </label>
            </div>
            <button id="close-settings-button" class="game-button mt-8 w-full">Close</button>
        </div>
    </div>

    <div id="game-over-screen" class="game-container hidden text-center">
        <h2 class="text-3xl font-bold text-purple-700 mb-5">Game Over, <span id="final-username"></span>!</h2>
        <div class="mb-4">
            <p class="text-2xl text-slate-700 mb-1">Final Score: <span id="final-score" class="font-bold text-purple-600">0</span> / <span id="final-total-possible-score" class="font-bold text-purple-600">0</span></p>
            <p class="text-xl text-slate-600">Badges Earned: <span id="final-badges-display">None</span></p>
        </div>
        <div id="high-scores-container" class="mt-6 mb-6 p-4 border border-purple-300 rounded-lg">
            <h4 class="text-xl font-semibold text-purple-700 mb-3">High Scores</h4>
            <ol id="high-scores-list" class="list-decimal list-inside text-left text-slate-600">
                {/* High scores will be populated here */}
            </ol>
        </div>
        <button id="play-again-button" class="game-button">Play Again!</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Fully Loaded and Parsed - Listening Challenge: Fruit Choices");
            // --- DOM Elements ---
            const startScreen = document.getElementById('start-screen');
            const gameScreen = document.getElementById('game-screen');
            const gameOverScreen = document.getElementById('game-over-screen');
            const usernameInput = document.getElementById('username');
            const startButton = document.getElementById('start-button');
            const quitButton = document.getElementById('quit-button');
            const displayUsername = document.getElementById('display-username');
            const scoreDisplay = document.getElementById('score');
            const totalPossibleScoreDisplay = document.getElementById('total-possible-score'); 
            const questionsAnsweredDisplay = document.getElementById('questions-answered');
            const totalQuestionsDisplay = document.getElementById('total-questions');
            const badgesDisplay = document.getElementById('badges-display');
            const voiceSelect = document.getElementById('voiceSelect');
            const currentActivityDisplay = document.getElementById('current-activity-display');
            const initiateQuestionButton = document.getElementById('initiate-question-button');
            const badgeAlert = document.getElementById('badge-alert');
            
            const questionModal = document.getElementById('question-modal');
            const modalTimerDisplay = document.getElementById('modal-timer');
            const questionStimulusDisplay = document.getElementById('question-stimulus-display');
            const questionTextDisplay = document.getElementById('question-text');
            const answerOptionsContainer = document.getElementById('answer-options');
            const feedbackDisplay = document.getElementById('feedback');
            const exampleSentenceFeedbackDisplay = document.getElementById('example-sentence-feedback');
            const nextQuestionButtonModal = document.getElementById('next-question-button-modal');
            const repeatButton = document.getElementById('repeat-button');
            const correctSoundEffect = document.getElementById('correctSoundEffect'); 
            const incorrectSoundEffect = document.getElementById('incorrectSoundEffect'); 
            const rewardGif = document.getElementById('rewardGif'); 

            const settingsButton = document.getElementById('settings-button');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsButton = document.getElementById('close-settings-button');
            const toggleTtsCheckbox = document.getElementById('toggle-tts');
            const toggleSfxCheckbox = document.getElementById('toggle-sfx');

            const finalUsernameDisplay = document.getElementById('final-username');
            const finalScoreDisplay = document.getElementById('final-score');
            const finalTotalPossibleScoreDisplay = document.getElementById('final-total-possible-score'); 
            const finalBadgesDisplay = document.getElementById('final-badges-display');
            const playAgainButton = document.getElementById('play-again-button');
            const highScoresList = document.getElementById('high-scores-list');


            // --- Game Data & Config ---
            let TOTAL_QUESTIONS_PER_GAME; 
            const POINTS_PER_CORRECT_ANSWER = 4; 
            const TIME_PER_QUESTION = 20; 
            let gameData = {};
            let currentQuestionData = {}; 
            let questionTimerInterval = null;
            let voices = [];
            let userSelectedVoice = null; 
            let currentNarratorVoice = null; 
            let speakTimeoutId = null; 
            let voicesPopulated = false;
            let currentUtterance = null; 
            let currentUtteranceCallback = null; 
            let isSpeakingTransition = false; 
            let settings = {
                isTtsEnabled: true,
                areSoundEffectsEnabled: true
            };


            let shuffledQuestionIndices = [];
            let currentQuestionIndexInShuffledList = 0;
            
            // --- Scenario Data ---
            const fruits = ["Apples", "Bananas", "Oranges", "Grapes", "Strawberries", "Blueberries", "Pineapples", "Mangoes", "Peaches", "Pears", "Cherries", "Watermelons", "Kiwis", "Lemons", "Limes", "Avocados", "Raspberries", "Blackberries", "Plums", "Coconuts"];
            
            const twoItemTemplates = [
                (item1, item2) => `I looked at the ${item1}, but I chose the ${item2} instead.`,
                (item1, item2) => `I was deciding between ${item1} and ${item2}. I went with the ${item2}.`,
                (item1, item2) => `Although the ${item1} looked nice, I preferred the ${item2}.`,
                (item1, item2) => `I almost bought the ${item1}, but then I saw the ${item2} and liked them more.`,
                (item1, item2) => `My first choice was ${item1}, but the ${item2} were a much better fit for my recipe.`,
                (item1, item2) => `I considered the ${item1}, but ultimately picked the ${item2}.`,
                (item1, item2) => `For today's shopping, I thought about getting ${item1}, but I took the ${item2} home.`,
                (item1, item2) => `The ${item1} looked good, but the ${item2} were perfect.`,
                (item1, item2) => `Between the ${item1} and the ${item2}, I selected the ${item2}.`,
                (item1, item2) => `I was looking for fresh fruit. I saw some ${item1}, but the ${item2} were what I really wanted.`
            ];

            let listeningTestQuestions = [];
            function generateListeningQuestions() {
                listeningTestQuestions = []; // Clear previous questions
                let questionId = 1;
                for (let i = 0; i < 50; i++) {
                    const template = twoItemTemplates[i % 10]; // Cycle through templates
                    let fruitOptions = [];
                    while(fruitOptions.length < 2) {
                        const randomFruit = fruits[Math.floor(Math.random() * fruits.length)];
                        if (!fruitOptions.includes(randomFruit)) {
                            fruitOptions.push(randomFruit);
                        }
                    }
                    listeningTestQuestions.push({
                        id: questionId++,
                        scenario: template(fruitOptions[0], fruitOptions[1]),
                        options: [...fruitOptions], 
                        correctOptionIndex: 1 // The second fruit mentioned is always the correct one
                    });
                }
                TOTAL_QUESTIONS_PER_GAME = listeningTestQuestions.length;
                console.log(`Generated ${TOTAL_QUESTIONS_PER_GAME} listening questions.`);
            }


            // --- Load Settings ---
            function loadSettings() {
                const savedSettings = localStorage.getItem('listeningGameSettings');
                if (savedSettings) {
                    settings = JSON.parse(savedSettings);
                }
                toggleTtsCheckbox.checked = settings.isTtsEnabled;
                toggleSfxCheckbox.checked = settings.areSoundEffectsEnabled;
            }

            // --- Save Settings ---
            function saveSettings() {
                localStorage.setItem('listeningGameSettings', JSON.stringify(settings));
            }
            
            // --- High Score Logic ---
            const MAX_HIGH_SCORES = 5;
            function getHighScores() {
                const scores = localStorage.getItem('listeningGameHighScores');
                return scores ? JSON.parse(scores) : [];
            }

            function saveHighScore(score, username) {
                const highScores = getHighScores();
                const newScore = { score, username, date: new Date().toLocaleDateString() };
                highScores.push(newScore);
                highScores.sort((a, b) => b.score - a.score); 
                highScores.splice(MAX_HIGH_SCORES); 
                localStorage.setItem('listeningGameHighScores', JSON.stringify(highScores));
            }

            function displayHighScores() {
                const highScores = getHighScores();
                highScoresList.innerHTML = ''; 
                if (highScores.length === 0) {
                    highScoresList.innerHTML = '<li class="text-slate-500">No high scores yet!</li>';
                    return;
                }
                highScores.forEach(scoreItem => {
                    const li = document.createElement('li');
                    li.textContent = `${scoreItem.username}: ${scoreItem.score} (on ${scoreItem.date})`;
                    highScoresList.appendChild(li);
                });
            }


            // --- TTS Functions ---
            function getVoiceByName(namePart) {
                if (!voices || voices.length === 0) return null;
                const lowerNamePart = namePart.toLowerCase();
                return voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes(lowerNamePart));
            }

            function getVoiceForCurrentQuestionSet(questionNum) { 
                let targetVoiceName = "";
                const upcomingQuestionIndex = questionNum;

                if (upcomingQuestionIndex < 10) targetVoiceName = "emma";
                else if (upcomingQuestionIndex < 20) targetVoiceName = "roger";
                else if (upcomingQuestionIndex < 30) targetVoiceName = "jenny";
                else if (upcomingQuestionIndex < 40) targetVoiceName = "eric"; 
                else if (upcomingQuestionIndex < 50) targetVoiceName = "thomas";
                else targetVoiceName = "emma"; 

                if (targetVoiceName) {
                    const foundVoice = getVoiceByName(targetVoiceName);
                    if (foundVoice) return foundVoice;
                }
                return userSelectedVoice || (voices.length > 0 ? voices[0] : null);
            }

            function populateVoiceList(loadedVoices) {
                if (voicesPopulated && loadedVoices.length === voices.length && voiceSelect.options.length === loadedVoices.filter(v => v.lang.startsWith('en')).length) return;
                console.log("populateVoiceList called with", loadedVoices.length, "voices");
                
                voices = loadedVoices; 
                voiceSelect.innerHTML = '';
                const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                
                englishVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.setAttribute('data-name', voice.name);
                    option.setAttribute('data-lang', voice.lang);
                    voiceSelect.appendChild(option);
                });

                if (englishVoices.length > 0) {
                    voicesPopulated = true;
                    console.log("English voices found:", englishVoices.length);
                    let initialDefaultVoice = getVoiceByName("emma"); 

                    if (!initialDefaultVoice) { 
                        const naturalKeywords = ["natural", "neural", "wavenet", "studio", "enhanced", "premium"];
                        initialDefaultVoice = englishVoices.find(v => naturalKeywords.some(kw => v.name.toLowerCase().includes(kw)));
                        if (!initialDefaultVoice) initialDefaultVoice = englishVoices.find(v => v.name === "Google US English" || v.name.toLowerCase().includes("united states"));
                        if (!initialDefaultVoice) initialDefaultVoice = englishVoices.find(v => v.name === "Microsoft Zira Desktop - English (United States)");
                        if (!initialDefaultVoice) initialDefaultVoice = englishVoices.find(v => v.default && v.lang.startsWith('en')); 
                        if (!initialDefaultVoice) initialDefaultVoice = englishVoices[0]; 
                    }
                    
                    userSelectedVoice = initialDefaultVoice; 
                    currentNarratorVoice = userSelectedVoice; 
                    console.log("Initial default voice (userSelectedVoice):", userSelectedVoice ? userSelectedVoice.name : "None");
                    
                    for (let i = 0; i < voiceSelect.options.length; i++) {
                        if (voiceSelect.options[i].dataset.name === userSelectedVoice.name && voiceSelect.options[i].dataset.lang === userSelectedVoice.lang) {
                            voiceSelect.selectedIndex = i;
                            break;
                        }
                    }
                    initiateQuestionButton.disabled = false; 
                } else {
                    currentActivityDisplay.textContent = "No English voices found for Text-to-Speech. Game may not function correctly.";
                    initiateQuestionButton.disabled = true; 
                    console.warn("No English voices found.");
                }
            }
            
            function initSpeechSynthesis() {
                 if ('speechSynthesis' in window) {
                    console.log("Speech Synthesis API supported.");
                    const tryPopulate = () => {
                        const currentVoices = speechSynthesis.getVoices();
                        if (currentVoices.length > 0 ) {
                             if (!voicesPopulated || voices.length !== currentVoices.length || voiceSelect.options.length === 0) {
                                populateVoiceList(currentVoices);
                             }
                        } else if (currentVoices.length === 0 && !voicesPopulated){
                             console.log("getVoices() returned empty list initially.");
                        }
                    };

                    if (speechSynthesis.onvoiceschanged !== undefined) {
                        speechSynthesis.onvoiceschanged = tryPopulate;
                    }
                    tryPopulate(); 
                    setTimeout(tryPopulate, 300); 
                    setTimeout(tryPopulate, 1200); 

                    voiceSelect.addEventListener('change', (e) => {
                        const selectedOption = e.target.options[e.target.selectedIndex];
                        userSelectedVoice = voices.find(voice => voice.name === selectedOption.dataset.name && voice.lang === selectedOption.dataset.lang);
                        console.log("User changed voice to:", userSelectedVoice ? userSelectedVoice.name : "None");
                    });
                } else {
                    console.warn("Speech Synthesis not supported");
                    if(voiceSelect.parentElement) voiceSelect.parentElement.classList.add('hidden');
                    currentActivityDisplay.textContent = "Text-to-Speech is not supported in your browser.";
                    initiateQuestionButton.disabled = true; 
                }
            }
             

            function speak(text, callback) {
                if (!settings.isTtsEnabled) {
                    console.log("TTS is disabled in settings.");
                    if (callback) setTimeout(callback, 0);
                    return;
                }

                if (isSpeakingTransition) {
                    console.warn("Speak request ignored: Previous speech transition in progress for:", text ? text.substring(0,30) + "..." : "No text");
                    if (callback) setTimeout(callback, 0); 
                    return;
                }
                isSpeakingTransition = true;
                console.log("Speak request for:", text ? text.substring(0,30) + "..." : "No text provided");

                if (!('speechSynthesis'in window) || !text) {
                    console.warn("Speak function: TTS not supported or no text.");
                    isSpeakingTransition = false;
                    if (callback) setTimeout(callback, 0);
                    return;
                }

                if (speakTimeoutId) clearTimeout(speakTimeoutId);
                
                if (currentUtterance) { 
                    currentUtterance.onend = null;
                    currentUtterance.onerror = null;
                    currentUtterance.onstart = null;
                }

                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtteranceCallback = callback; 

                currentNarratorVoice = getVoiceForCurrentQuestionSet(gameData.questionsAnswered || 0);
                currentUtterance.voice = currentNarratorVoice || userSelectedVoice; 

                if (!currentUtterance.voice && voices && voices.length > 0) {
                     let fallbackVoice = voices.find(v => v.default && v.lang.startsWith('en'));
                     if (!fallbackVoice) fallbackVoice = voices.find(v => v.lang.startsWith('en'));
                     if (!fallbackVoice && voices.length > 0) fallbackVoice = voices[0];
                     currentUtterance.voice = fallbackVoice;
                }
                
                currentUtterance.onstart = () => {
                     console.log("Speech event: onstart for current utterance:", text.substring(0,15) + "...");
                };

                currentUtterance.onend = () => {
                    console.log("Speech event: onend for current utterance:", text.substring(0,15) + "...");
                    isSpeakingTransition = false;
                    if (currentUtteranceCallback) { 
                        const cb = currentUtteranceCallback;
                        currentUtteranceCallback = null; 
                        try { cb(); } catch(e) { console.error("Error in onend callback:", e); }
                    }
                };
                currentUtterance.onerror = (event) => {
                    console.error("SpeechSynthesisUtterance.onerror for current utterance. Event:", event, "Error type:", event.error, "Text:", text.substring(0,30) + "...");
                    isSpeakingTransition = false;
                    if (event.error && event.error !== 'canceled' && event.error !== 'interrupted') { 
                        currentActivityDisplay.textContent = `Audio Error (${event.error}). Try another voice.`;
                    } else if (event.error === 'canceled') {
                        console.warn("Current utterance speech was CANCELED.");
                    } else if (event.error === 'interrupted') {
                        console.warn("Current utterance speech was INTERRUPTED.");
                    }
                    if (currentUtteranceCallback) { 
                        const cb = currentUtteranceCallback;
                        currentUtteranceCallback = null; 
                        try { cb(); } catch(e) { console.error("Error in onerror callback:", e); }
                    }
                };
                
                const doSpeak = () => {
                    console.log("Executing speechSynthesis.speak for:", text.substring(0,30) + "...");
                    speechSynthesis.speak(currentUtterance);
                };

                if (speechSynthesis.speaking || speechSynthesis.pending) {
                    console.log("Speech is speaking or pending. Canceling...");
                    speechSynthesis.cancel(); 
                    speakTimeoutId = setTimeout(doSpeak, 300); 
                } else {
                    speakTimeoutId = setTimeout(doSpeak, 50); 
                }
            }

            // --- Game Logic Functions ---
            function resetGameData() {
                gameData = {
                    username: usernameInput.value.trim() || "Player",
                    score: 0,
                    questionsAnswered: 0,
                    totalQuestions: TOTAL_QUESTIONS_PER_GAME, 
                    badges: [],
                    correctStreak: 0,
                    fastAnswers: 0
                };
                shuffledQuestionIndices = Array.from(Array(listeningTestQuestions.length).keys());
                shuffleArray(shuffledQuestionIndices); 
                currentQuestionIndexInShuffledList = 0; 

                updateGameStatsDisplay(); 
                initiateQuestionButton.textContent = "Start First Question";
                const englishVoicesExist = voices && voices.filter(v => v.lang.startsWith('en')).length > 0;
                initiateQuestionButton.disabled = !('speechSynthesis' in window) || !englishVoicesExist;
                currentActivityDisplay.textContent = "Click 'Start First Question' to begin!";
                 if (initiateQuestionButton.disabled && settings.isTtsEnabled) { 
                    currentActivityDisplay.textContent = "Text-to-Speech is not available or no English voices found. Cannot start game.";
                } else if (!settings.isTtsEnabled) {
                     currentActivityDisplay.textContent = "Text-to-Speech is disabled in settings. Click to begin.";
                     initiateQuestionButton.disabled = false; 
                }
            }

            function updateGameStatsDisplay() {
                displayUsername.textContent = gameData.username;
                scoreDisplay.textContent = gameData.score;
                totalPossibleScoreDisplay.textContent = gameData.totalQuestions * POINTS_PER_CORRECT_ANSWER; 
                questionsAnsweredDisplay.textContent = gameData.questionsAnswered;
                totalQuestionsDisplay.textContent = gameData.totalQuestions; 
                updateBadgesDisplay();
            }
            
            function showBadgeAlert(badgeName) {
                badgeAlert.textContent = `Badge Unlocked: ${badgeName}!`;
                badgeAlert.classList.remove('hidden');
                badgeAlert.style.opacity = 1;
                badgeAlert.style.transform = 'translate(-50%, 0)';
                setTimeout(() => {
                    badgeAlert.style.opacity = 0;
                    badgeAlert.style.transform = 'translate(-50%, -20px)';
                    setTimeout(() => badgeAlert.classList.add('hidden'), 500);
                }, 2500);
            }

            function awardBadge(badgeName) {
                if (!gameData.badges.includes(badgeName)) {
                    gameData.badges.push(badgeName);
                    updateBadgesDisplay();
                    showBadgeAlert(badgeName); 
                }
            }

            function updateBadgesDisplay() {
                 badgesDisplay.innerHTML = gameData.badges.length > 0 ? 
                    gameData.badges.map(b => `<span class="inline-block">${b}</span>`).join(' ') : 'None';
            }

            function startGame() {
                generateListeningQuestions(); 
                console.log("startGame called");
                loadSettings(); 
                totalQuestionsDisplay.textContent = listeningTestQuestions.length; 
                if (!usernameInput.value.trim()) {
                    const nameField = document.getElementById('username');
                    nameField.classList.add('border-red-500', 'placeholder-red-400');
                    nameField.focus();
                    setTimeout(() => nameField.classList.remove('border-red-500', 'placeholder-red-400'), 2000);
                    return;
                }
                resetGameData(); 
                startScreen.classList.add('hidden');
                gameOverScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
            }
            
            function startNewQuestionRound() {
                console.log("startNewQuestionRound. Qs answered:", gameData.questionsAnswered, " Shuffled list index:", currentQuestionIndexInShuffledList);
                if (gameData.questionsAnswered >= TOTAL_QUESTIONS_PER_GAME) { 
                    endGame();
                    return;
                }
                initiateQuestionButton.disabled = true; 
                currentActivityDisplay.textContent = settings.isTtsEnabled ? "Listen carefully..." : "Read the question below.";

                if (currentQuestionIndexInShuffledList >= shuffledQuestionIndices.length) {
                    console.warn("Ran out of unique questions. This should not happen if TOTAL_QUESTIONS_PER_GAME is set to list length.");
                    endGame();
                    return;
                }

                const questionIndex = shuffledQuestionIndices[currentQuestionIndexInShuffledList];
                currentQuestionData = { ...listeningTestQuestions[questionIndex] }; 
                
                console.log(`New Question ID: ${currentQuestionData.id}, Scenario: ${currentQuestionData.scenario.substring(0,30)}... Correct Answer: ${currentQuestionData.correctAnswer}`);
                questionStimulusDisplay.textContent = "Listen to the story..."; 
                questionTextDisplay.textContent = `Which fruit did the person choose?`;
                
                if(settings.isTtsEnabled){
                    speak(currentQuestionData.scenario, () => {
                        displayQuestionModalWithOptions();
                    });
                } else {
                     displayQuestionModalWithOptions(); 
                }
            }
            
            function displayQuestionModalWithOptions() {
                const { options, correctAnswer } = currentQuestionData;
                let displayOptions = [...options]; 
                shuffleArray(displayOptions); 

                answerOptionsContainer.innerHTML = '';
                displayOptions.forEach(optionText => {
                    const choiceBtn = document.createElement('button');
                    choiceBtn.classList.add('choice-button');
                    choiceBtn.textContent = optionText;
                    choiceBtn.disabled = false; 
                    choiceBtn.addEventListener('click', () => checkAnswer(optionText, correctAnswer, choiceBtn));
                    answerOptionsContainer.appendChild(choiceBtn);
                });
                
                feedbackDisplay.textContent = '';
                exampleSentenceFeedbackDisplay.classList.add('hidden');
                exampleSentenceFeedbackDisplay.textContent = '';
                nextQuestionButtonModal.classList.add('hidden');
                rewardGif.classList.add('hidden'); 
                questionModal.classList.remove('hidden');
                startQuestionTimer();
            }
            
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            function startQuestionTimer() {
                clearInterval(questionTimerInterval);
                gameData.timeLeft = TIME_PER_QUESTION;
                modalTimerDisplay.textContent = gameData.timeLeft;
                questionTimerInterval = setInterval(() => {
                    gameData.timeLeft--;
                    modalTimerDisplay.textContent = gameData.timeLeft;
                    if (gameData.timeLeft <= 0) {
                        clearInterval(questionTimerInterval);
                        const correctAnswerText = currentQuestionData.correctAnswer;
                        feedbackDisplay.textContent = `Time's up! The answer was: ${correctAnswerText}`;
                        feedbackDisplay.style.color = '#f59e0b'; 
                        disableAnswerOptions(correctAnswerText);
                        nextQuestionButtonModal.classList.remove('hidden');
                        gameData.correctStreak = 0;
                        
                        gameData.questionsAnswered++; 
                        currentQuestionIndexInShuffledList++; 
                        exampleSentenceFeedbackDisplay.textContent = `Story: ${currentQuestionData.scenario}`;
                        exampleSentenceFeedbackDisplay.classList.remove('hidden');

                        updateGameStatsDisplay();
                        if (gameData.questionsAnswered >= gameData.totalQuestions) {
                             nextQuestionButtonModal.textContent = "Show Results";
                        }
                    }
                }, 1000);
            }

            function disableAnswerOptions(correctAnswerText = null) {
                Array.from(answerOptionsContainer.children).forEach(btn => {
                    btn.disabled = true;
                    if (correctAnswerText && btn.textContent === correctAnswerText && !btn.classList.contains('correct')) {
                        btn.classList.add('correct'); 
                    }
                });
            }

            function checkAnswer(selectedAnswerText, correctAnswerText, buttonElement) {
                clearInterval(questionTimerInterval);
                disableAnswerOptions(correctAnswerText); 
                gameData.questionsAnswered++;
                currentQuestionIndexInShuffledList++; 


                exampleSentenceFeedbackDisplay.textContent = `Story: ${currentQuestionData.scenario}`;
                exampleSentenceFeedbackDisplay.classList.remove('hidden');

                if (selectedAnswerText === correctAnswerText) {
                    gameData.score += POINTS_PER_CORRECT_ANSWER; 
                    feedbackDisplay.textContent = "Correct! Well done!";
                    feedbackDisplay.style.color = '#10b981'; 
                    buttonElement.classList.add('correct');
                    gameData.correctStreak++;

                    if (settings.areSoundEffectsEnabled && correctSoundEffect.src && !correctSoundEffect.src.endsWith('/') && !correctSoundEffect.src.startsWith('blob:')) { 
                        correctSoundEffect.currentTime = 0;
                        correctSoundEffect.play().catch(e => console.warn("Could not play correct.mp3.", e));
                    } else if (settings.areSoundEffectsEnabled) {
                        console.log("Placeholder: Play correct.mp3 (src not set).");
                    }
                    
                    if (rewardGif.src && !rewardGif.src.endsWith('/') && !rewardGif.src.startsWith('blob:') && !rewardGif.src.includes('placehold.co')) {
                         rewardGif.classList.remove('hidden');
                    } else { 
                        rewardGif.src = 'https://placehold.co/120x120/a7f3d0/14532d?text=Awesome!'; 
                        rewardGif.classList.remove('hidden');
                    }
                    setTimeout(() => rewardGif.classList.add('hidden'), 2500);

                    if (gameData.correctStreak === 3) awardBadge("3-in-a-Row!");
                    if (gameData.correctStreak === 5) awardBadge("Listening Pro!");

                } else {
                    feedbackDisplay.textContent = `Not quite. The answer was: ${correctAnswerText}`;
                    feedbackDisplay.style.color = '#f43f5e'; 
                    buttonElement.classList.add('incorrect');
                     Array.from(answerOptionsContainer.children).find(btn => btn.textContent === correctAnswerText)?.classList.add('correct');
                    gameData.correctStreak = 0;

                    if (settings.areSoundEffectsEnabled && incorrectSoundEffect.src && !incorrectSoundEffect.src.endsWith('/') && !incorrectSoundEffect.src.startsWith('blob:')) {
                        incorrectSoundEffect.currentTime = 0;
                        incorrectSoundEffect.play().catch(e => console.warn("Could not play incorrect.mp3.", e));
                    } else if (settings.areSoundEffectsEnabled) {
                        console.log("Placeholder: Play incorrect.mp3 (src not set).");
                    }
                }
                
                updateGameStatsDisplay();
                checkBadges();
                nextQuestionButtonModal.classList.remove('hidden');

                if (gameData.questionsAnswered >= gameData.totalQuestions) {
                    nextQuestionButtonModal.textContent = "Show Results";
                }
            }
            
            function checkBadges() {
                if (gameData.score >= (TOTAL_QUESTIONS_PER_GAME * POINTS_PER_CORRECT_ANSWER * 0.5) && !gameData.badges.includes("Halfway Hero!")) awardBadge("Halfway Hero!");
                if (gameData.score >= (TOTAL_QUESTIONS_PER_GAME * POINTS_PER_CORRECT_ANSWER * 0.8) && !gameData.badges.includes("Super Scorer!")) awardBadge("Super Scorer!");
                if (gameData.questionsAnswered === gameData.totalQuestions && gameData.score === (TOTAL_QUESTIONS_PER_GAME * POINTS_PER_CORRECT_ANSWER)) awardBadge("Perfect Score!");
                else if (gameData.questionsAnswered === gameData.totalQuestions && gameData.score > 0) awardBadge("Test Complete!");
            }

            function proceedAfterModal() { 
                questionModal.classList.add('hidden');
                initiateQuestionButton.disabled = false; 
                
                if (gameData.questionsAnswered >= gameData.totalQuestions) {
                    endGame();
                } else {
                   nextQuestionButtonModal.textContent = "Next Question"; 
                   currentActivityDisplay.textContent = "Click 'Next Question' to continue.";
                   initiateQuestionButton.textContent = "Next Question";
                }
            }
            
            function endGame() {
                console.log("endGame called");
                saveHighScore(gameData.score, gameData.username);
                displayHighScores();
                initiateQuestionButton.textContent = "Play Again?"; 
                initiateQuestionButton.disabled = false; 
                questionModal.classList.add('hidden'); 
                gameOverScreen.classList.remove('hidden');
                gameScreen.classList.add('hidden'); 
                finalUsernameDisplay.textContent = gameData.username;
                finalScoreDisplay.textContent = gameData.score;
                finalTotalPossibleScoreDisplay.textContent = gameData.totalQuestions * POINTS_PER_CORRECT_ANSWER; 
                finalBadgesDisplay.innerHTML = gameData.badges.length > 0 ? 
                    gameData.badges.map(b => `<span class="inline-block">${b}</span>`).join(' ') : 'None';
            }
            
            function quitGame() {
                 clearInterval(questionTimerInterval);
                 if (confirm("Are you sure you want to quit? Your progress may be lost.")) {
                    gameScreen.classList.add('hidden');
                    questionModal.classList.add('hidden');
                    gameOverScreen.classList.add('hidden'); 
                    startScreen.classList.remove('hidden');
                 }
            }

            // --- Settings Modal Logic ---
            settingsButton.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });
            closeSettingsButton.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });
            toggleTtsCheckbox.addEventListener('change', (e) => {
                settings.isTtsEnabled = e.target.checked;
                saveSettings();
                if (!settings.isTtsEnabled && (speechSynthesis.speaking || speechSynthesis.pending)) {
                    speechSynthesis.cancel(); 
                }
            });
            toggleSfxCheckbox.addEventListener('change', (e) => {
                settings.areSoundEffectsEnabled = e.target.checked;
                saveSettings();
            });


            // --- Event Listeners ---
            startButton.addEventListener('click', startGame);
            playAgainButton.addEventListener('click', () => {
                gameOverScreen.classList.add('hidden');
                startScreen.classList.remove('hidden'); 
            });
            nextQuestionButtonModal.addEventListener('click', proceedAfterModal);
            initiateQuestionButton.addEventListener('click', startNewQuestionRound);
            quitButton.addEventListener('click', quitGame);
            repeatButton.addEventListener('click', () => { 
                if (currentQuestionData && currentQuestionData.scenario ) { 
                    speak(currentQuestionData.scenario, null); 
                } else {
                    console.log("Nothing to repeat or currentQuestionData not set.");
                }
            });

            // Initial Load
            initSpeechSynthesis();
            loadSettings(); 

        });
    </script>
</body>
</html>
