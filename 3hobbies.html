<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hobby & Schedule Quiz</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none; /* Prevent text selection for game feel */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(45deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            animation: backgroundShift 30s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0% { background: linear-gradient(45deg, #11998e 0%, #38ef7d 100%); }
            25% { background: linear-gradient(45deg, #FF9966 0%, #FF5E62 100%); }
            50% { background: linear-gradient(45deg, #56CCF2 0%, #2F80ED 100%); }
            75% { background: linear-gradient(45deg, #4776E6 0%, #8E54E9 100%); }
            100% { background: linear-gradient(45deg, #11998e 0%, #38ef7d 100%); }
        }

        /* Floating Hobby Emojis - Adjusted to float in lower area */
        .hobby-float {
            position: absolute;
            font-size: 40px;
            opacity: 0.4;
            animation: floatMove 10s linear infinite;
            z-index: 1;
            pointer-events: none;
        }

        @keyframes floatMove {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            20% { opacity: 0.6; }
            80% { opacity: 0.6; }
            100% { transform: translateY(40vh) rotate(180deg); opacity: 0; }
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 15px;
            position: relative;
            z-index: 10;
            justify-content: space-between;
        }

        .bottom-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 15px;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .progress-section {
            flex: 1;
            margin: 0 15px;
        }

        .progress-bar {
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb);
            border-radius: 15px;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-emoji {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            animation: bounce 0.5s ease-in-out infinite alternate;
        }

        @keyframes bounce {
            0% { transform: translateY(-50%) scale(1); }
            100% { transform: translateY(-50%) scale(1.2); }
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            background: linear-gradient(145deg, #d64545, #a83232);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .players-section {
            display: none;
        }

        .player-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .player-name {
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            line-height: 1.2;
        }

        .player-score {
            font-size: 14px;
            font-weight: 600;
            color: #ffd700;
            text-align: center;
            margin-top: 2px;
        }

        .player-stats {
            display: flex;
            gap: 8px;
            margin-top: 5px;
            font-size: 12px;
            color: #eee;
        }

        .player-streak {
            background: rgba(255, 165, 0, 0.3);
            padding: 2px 6px;
            border-radius: 8px;
            display: none; /* Hidden by default */
        }

        .player-badges {
            display: flex;
            gap: 2px;
        }

        .question-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.5s ease, opacity 0.5s ease;
        }
        
        /* Animation classes for question transition */
        .question-enter { opacity: 0; transform: translateY(-20px); }
        .question-active { opacity: 1; transform: translateY(0); }

        .question-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .game-area {
            display: flex;
            flex: 1;
            gap: 15px;
            align-items: flex-start;
            margin-top: 20px;
            justify-content: center;
        }

        .choices-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            max-width: 33%;
        }

        .choice-button {
            background: linear-gradient(145deg, #4a5fd1, #5a3f8f);
            border: none;
            border-radius: 12px;
            padding: 5px 5px;
            font-size: 22px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0px #3a4a9f;
            position: relative;
            overflow: hidden;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-break: break-word;
            line-height: 1.1;
            text-transform: lowercase; /* Lowercase as requested */
        }

        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0px #3a4a9f;
            filter: brightness(1.1);
        }

        .choice-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0px #3a4a9f;
        }

        /* Ripple Effect */
        .choice-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .choice-button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% { transform: scale(0, 0); opacity: 0.5; }
            100% { transform: scale(20, 20); opacity: 0; }
        }

        .choice-button.correct {
            animation: correctAnswer 4s ease-in-out;
            background: linear-gradient(145deg, #2fa15f, #1f8f8f);
            box-shadow: 0 4px 0px #1a7a4f;
        }

        .choice-button.incorrect {
            animation: incorrectAnswer 2s ease-in-out;
            background: linear-gradient(145deg, #d64545, #a83232);
            box-shadow: 0 4px 0px #8f2222;
        }

        @keyframes correctAnswer {
            0% { transform: scale(1); }
            10% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes incorrectAnswer {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .sparkle { position: absolute; width: 10px; height: 10px; background: #ffd700; border-radius: 50%; animation: sparkle 1s ease-out forwards; pointer-events: none; }
        @keyframes sparkle { 0% { opacity: 1; transform: scale(0); } 50% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0); } }
        .token { position: absolute; width: 20px; height: 20px; background: linear-gradient(45deg, #ffd700, #ffed4e); border-radius: 50%; border: 2px solid #ff6b6b; font-size: 12px; font-weight: bold; color: #333; display: flex; align-items: center; justify-content: center; animation: tokenFly 2s ease-out forwards; pointer-events: none; z-index: 1000; }
        @keyframes tokenFly { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.5); } }
        
        .leaderboard, .learning-phase, .name-shuffle {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.98); padding: 40px; border-radius: 30px; text-align: center; font-size: 24px; color: #333; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); z-index: 1000; display: none;
        }
        .name-shuffle { width: 80%; max-width: 800px; }
        .shuffle-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 30px; min-height: 200px; align-items: center; }
        .shuffle-name { padding: 10px 15px; background: linear-gradient(145deg, #667eea, #764ba2); color: white; border-radius: 10px; font-size: 16px; font-weight: 600; transition: all 0.3s ease; }
        .shuffle-name.selected { background: linear-gradient(145deg, #43e97b, #38f9d7); transform: scale(1.2); box-shadow: 0 0 20px #43e97b; }
        .selected-players { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .selected-player { background: linear-gradient(145deg, #f093fb, #f5576c); color: white; padding: 15px; border-radius: 15px; font-size: 18px; font-weight: 700; }

        .round-info-display {
            color: white; font-size: 18px; font-weight: 600; background: rgba(255, 255, 255, 0.2); padding: 8px 16px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.3); text-align: center; white-space: nowrap;
        }

        .main-menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .menu-container { background: rgba(255, 255, 255, 0.95); padding: 60px; border-radius: 30px; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .menu-title { font-size: 48px; font-weight: 700; color: #333; margin-bottom: 20px; }
        .grade-buttons { display: flex; gap: 20px; justify-content: center; }
        .grade-btn { background: linear-gradient(145deg, #4a5fd1, #5a3f8f); border: none; border-radius: 20px; padding: 20px 40px; font-size: 24px; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .grade-btn:hover { transform: translateY(-5px); }

        .fireworks, .winner-firework, .celebration-burst { pointer-events: none; position: absolute; }
        
        /* Glitter CSS */
        .glitter {
            position: absolute;
            width: 8px;
            height: 8px;
            background: linear-gradient(45deg, #ff69b4, #00ffff, #ffd700, #ff4757);
            border-radius: 50%;
            animation: glitterFloat 2s ease-out forwards;
            pointer-events: none;
            z-index: 2000;
        }

        @keyframes glitterFloat {
            0% { opacity: 1; transform: scale(0) rotate(0deg); }
            25% { opacity: 1; transform: scale(1.5) rotate(90deg); }
            50% { opacity: 0.8; transform: scale(1) rotate(180deg); }
            75% { opacity: 0.6; transform: scale(1.2) rotate(270deg); }
            100% { opacity: 0; transform: scale(0) rotate(360deg); }
        }
        
        /* Targeted Feedback Styles - Only animate correct button for specific player */
        .active-player-correct {
            animation: correctAnswer 4s ease-in-out;
            background: linear-gradient(145deg, #2fa15f, #1f8f8f) !important;
            box-shadow: 0 4px 0px #1a7a4f !important;
        }
        
        .active-player-incorrect {
            animation: incorrectAnswer 2s ease-in-out;
            background: linear-gradient(145deg, #d64545, #a83232) !important;
            box-shadow: 0 4px 0px #8f2222 !important;
        }
        
        /* Streak Indicator specific to this player */
        .streak-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, #FFD700, #FFA000);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
            animation: streakGlow 1s ease-in-out infinite alternate;
            border: 2px solid #FFF;
        }
        
        /* Confetti Particle */
        .confetti-particle {
            position: absolute;
            width: 8px;
            height: 12px;
            background-color: #f00;
            animation: confettiFall 2.5s ease-out forwards;
            z-index: 2001;
            pointer-events: none;
        }
        
        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(200px) rotate(720deg) translateX(50px); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div class="main-menu" id="mainMenu">
        <div class="menu-container">
            <h1 class="menu-title">üé® Hobby & Schedule Quiz</h1>
            <h2 class="menu-subtitle">Select Your Grade</h2>
            <div class="grade-buttons">
                <button class="grade-btn" onclick="playClickSound(); selectGrade(10)">Grade 10</button>
                <button class="grade-btn" onclick="playClickSound(); selectGrade(11)">Grade 11</button>
                <button class="grade-btn" onclick="playClickSound(); selectGrade(12)">Grade 12</button>
            </div>
        </div>
    </div>

    <div class="game-container" id="gameContainer" style="display: none;">
        <!-- Question Section (Hidden) -->
        <div class="question-section" id="questionSection" style="display: none;">
            <div class="question-title" id="questionTitle"></div>
        </div>
        
        <!-- Global Streak Indicator (kept for big streaks, but individual stats are under players) -->
        <div class="streak-indicator" id="streakIndicator">
            üî• Streak: <span id="streakCount">0</span>
        </div>

        <!-- Game Area (Answer Buttons & Players) -->
        <div class="game-area">
            <div class="choices-column">
                <button class="choice-button" onclick="playClickSound(); selectAnswer(0)">hobby 1</button>
                <button class="choice-button" onclick="playClickSound(); selectAnswer(1)">hobby 2</button>
                <button class="choice-button" onclick="playClickSound(); selectAnswer(2)">hobby 3</button>
                <button class="choice-button" onclick="playClickSound(); selectAnswer(3)">hobby 4</button>
                <div class="player-container">
                    <div class="player-name" id="player1">Player 1</div>
                    <div class="player-score" id="score1">0 points</div>
                    <div class="player-stats">
                        <div class="player-streak" id="streak1"></div>
                        <div class="player-badges" id="badges1"></div>
                    </div>
                </div>
            </div>

            <div class="choices-column">
                <button class="choice-button" onclick="playClickSound(); selectAnswer(4)">hobby 5</button>
                <button class="choice-button" onclick="playClickSound(); selectAnswer(5)">hobby 6</button>
                <button class="choice-button" onclick="playClickSound(); selectAnswer(6)">hobby 7</button>
                <button class="choice-button" onclick="playClickSound(); selectAnswer(7)">hobby 8</button>
                <div class="player-container">
                    <div class="player-name" id="player2">Player 2</div>
                    <div class="player-score" id="score2">0 points</div>
                    <div class="player-stats">
                        <div class="player-streak" id="streak2"></div>
                        <div class="player-badges" id="badges2"></div>
                    </div>
                </div>
            </div>

            <div class="choices-column">
                <button class="choice-button" onclick="playClickSound(); selectAnswer(8)">hobby 9</button>
                <button class="choice-button" onclick="playClickSound(); selectAnswer(9)">hobby 10</button>
                <button class="choice-button" onclick="playClickSound(); selectAnswer(10)">hobby 11</button>
                <button class="choice-button" onclick="playClickSound(); selectAnswer(11)">hobby 12</button>
                <div class="player-container">
                    <div class="player-name" id="player3">Player 3</div>
                    <div class="player-score" id="score3">0 points</div>
                    <div class="player-stats">
                        <div class="player-streak" id="streak3"></div>
                        <div class="player-badges" id="badges3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Controls (Timer, Menu, Round) -->
        <div class="bottom-section">
            <div class="control-buttons">
                <button class="control-btn" onclick="playClickSound(); backToMenu()">üè† Menu</button>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">
                        <div class="progress-emoji" id="progressEmoji">üé®</div>
                    </div>
                </div>
            </div>
            <div class="round-info-display">
                <span id="roundDisplay">Round 1 of 8</span> | Questions Left: <span id="questionsLeft">10</span>
            </div>
        </div>
    </div>

    <!-- Overlays -->
    <div class="leaderboard" id="leaderboard">
        <h2>üèÜ Round Complete! üèÜ</h2>
        <div id="leaderboardContent"></div>
        <div id="globalLeaderboardContent" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
            <h3>üåü Global Leaderboard üåü</h3>
            <div id="globalScores"></div>
        </div>
        <div style="margin-top: 20px; font-size: 16px; color: #666;">Next round starting automatically in 5 seconds...</div>
    </div>

    <div class="learning-phase" id="learningPhase">
        <div id="learningContent"></div>
    </div>

    <div class="name-shuffle" id="nameShuffle">
        <h2 class="shuffle-title">Selecting Players...</h2>
        <div class="shuffle-container" id="shuffleContainer"></div>
        <div class="selected-players" id="selectedPlayers"></div>
    </div>

    <script>
        // ========================================
        // üìö STUDENT NAMES
        // ========================================
        const studentsByGrade = {
            10: [
                "ÂÜØÂ•ïÂ∞ò / FENG, YICHEN", "ÈªÑËã•Ê∂µ / HUANG, RUOHAN", "Êùé‰∏∞Â±π / LI, FENGYI", 
                "ÊùéÈπèÊΩû / LI, PENGLU", "Ê¢ÅÈî¶Â§© / LING, JINTIAN", "ÂàòÊôØÊâ¨ / LIU, JINGYANG",
                "Èæô‰øäÂøó / LONG, JUNZHI", "È©¨Ëµ´ / MA, HE", "ËÅÇÊ∫™Â∫∑ / NIE, XIKANG",
                "Â∫û‰∫ëËîö / PANG, YUNWEI", "Êõ≤ÂÆ∂Áëû / QU, JIARUI", "Â≠ôËØóÁ´• / SUN, SHITONG",
                "ÁéãÂ≠êË®Ä / WANG, ZIYAN", "ËµµÊµ©Áê≥ / Howlin", "Âº†ÂÆ∏ÊÅ∫ / ZHANG, CHENKAI",
                "ËµµÊµ©Êñá / ZHAO, HAOWEN",
            ],
            11: [
                "Êü¥ÂçìÁë∂ / Iris", "Êùé‰πãÁî® / Max", "Êûó‰∫ëÊõ¶ / Cathy",
                "ÂàòÁèÇÂê´ / Sandy", "È™ÜÊ¢¶‰πî / Vicky", "ÂÆãÊòäËΩ© / Jim",
                "ÂêëÂÆ∂ÊÖï / Jackie", "ÂæêÂòâÁÅè / Jay", "Êù®È¶•ÂÆÅ / Grace",
                "Âº†‰∏éÂçì / Emily", "ËµµÂçÉÊ¢¶ / Rhea"
            ],
            12: [
                "ÂÆâÊîøËÅø / AN, ZHENGYU", "Ëî°Â≠êÂ¢® / CAI, ZIMO", "ÂàòÈïáÊ¶ï / LIU, ZHENRONG",
                "È©¨Áü•Ë°å / MA, ZHIXING", "ÈÇ±Â§© / QIU, TIAN", "ÁõõÊÄùËØ≠ / SHENG, SIYU",
                "ÂîêÂèØÁõà / TANG, KEYING", "Áî∞Â≠êÂá° / TIAN, ZIFAN", "Ë∞¢ÊñØÈ£û / XIE, SIFEI",
                "Êù®Âä†È∫í / YANG, JIAQI", "Âº†Á®ãÁöì / ZHANG, CHENGHAO", "ËµµÊô®ËææÈë´ / ZHAO, CHENDAXIN",
                "Âë®ÈÄ∏Âá° / ZHOU, YIFAN"
            ]
        };

        // Name Formatter: Chinese / English -> English (Chinese)
        function formatStudentName(nameStr) {
            if (!nameStr) return nameStr;
            const parts = nameStr.split(' / ');
            if (parts.length === 2) {
                // parts[0] is Chinese, parts[1] is English
                return `${parts[1]} (${parts[0]})`;
            }
            return nameStr;
        }

        // ========================================
        // üéØ HOBBY DATABASE (Correct Collocations)
        // ========================================
        // action: Infinitive phrase (e.g., "play soccer", "go swimming")
        // gerund: Gerund phrase (e.g., "playing soccer", "swimming")
        
        const easyHobbies = [
            { id: "soccer", display: "Soccer", action: "play soccer", gerund: "playing soccer", emoji: "‚öΩ" },
            { id: "basketball", display: "Basketball", action: "play basketball", gerund: "playing basketball", emoji: "üèÄ" },
            { id: "swimming", display: "Swimming", action: "go swimming", gerund: "swimming", emoji: "üèä" },
            { id: "reading", display: "Reading", action: "read books", gerund: "reading", emoji: "üìö" },
            { id: "cooking", display: "Cooking", action: "cook dinner", gerund: "cooking", emoji: "üç≥" },
            { id: "dancing", display: "Dancing", action: "dance", gerund: "dancing", emoji: "üíÉ" },
            { id: "painting", display: "Painting", action: "paint pictures", gerund: "painting", emoji: "üé®" },
            { id: "singing", display: "Singing", action: "sing songs", gerund: "singing", emoji: "üé§" },
            { id: "gaming", display: "Video Games", action: "play video games", gerund: "playing video games", emoji: "üéÆ" },
            { id: "cycling", display: "Cycling", action: "go cycling", gerund: "cycling", emoji: "üö≤" },
            { id: "running", display: "Running", action: "go running", gerund: "running", emoji: "üèÉ" },
            { id: "fishing", display: "Fishing", action: "go fishing", gerund: "fishing", emoji: "üé£" },
            { id: "piano", display: "Piano", action: "play the piano", gerund: "playing the piano", emoji: "üéπ" },
            { id: "guitar", display: "Guitar", action: "play the guitar", gerund: "playing the guitar", emoji: "üé∏" },
            { id: "shopping", display: "Shopping", action: "go shopping", gerund: "shopping", emoji: "üõçÔ∏è" }
        ];

        const mediumHobbies = [
            { id: "photography", display: "Photography", action: "take photos", gerund: "taking photos", emoji: "üì∏" },
            { id: "hiking", display: "Hiking", action: "go hiking", gerund: "hiking", emoji: "ü•æ" },
            { id: "camping", display: "Camping", action: "go camping", gerund: "camping", emoji: "‚õ∫" },
            { id: "chess", display: "Chess", action: "play chess", gerund: "playing chess", emoji: "‚ôüÔ∏è" },
            { id: "yoga", display: "Yoga", action: "do yoga", gerund: "doing yoga", emoji: "üßò" },
            { id: "gardening", display: "Gardening", action: "do gardening", gerund: "gardening", emoji: "üå±" },
            { id: "baking", display: "Baking", action: "bake cookies", gerund: "baking", emoji: "üßÅ" },
            { id: "skateboarding", display: "Skateboarding", action: "go skateboarding", gerund: "skateboarding", emoji: "üõπ" },
            { id: "skiing", display: "Skiing", action: "go skiing", gerund: "skiing", emoji: "üéø" },
            { id: "tennis", display: "Tennis", action: "play tennis", gerund: "playing tennis", emoji: "üéæ" },
            { id: "volleyball", display: "Volleyball", action: "play volleyball", gerund: "playing volleyball", emoji: "üèê" },
            { id: "writing", display: "Writing", action: "write stories", gerund: "writing", emoji: "‚úçÔ∏è" },
            { id: "knitting", display: "Knitting", action: "knit", gerund: "knitting", emoji: "üß∂" },
            { id: "puzzles", display: "Puzzles", action: "do puzzles", gerund: "doing puzzles", emoji: "üß©" },
            { id: "origami", display: "Origami", action: "do origami", gerund: "doing origami", emoji: "üìÑ" }
        ];

        const hardHobbies = [
            { id: "calligraphy", display: "Calligraphy", action: "practice calligraphy", gerund: "doing calligraphy", emoji: "üñãÔ∏è" },
            { id: "scuba_diving", display: "Scuba Diving", action: "go scuba diving", gerund: "scuba diving", emoji: "ü§ø" },
            { id: "archery", display: "Archery", action: "do archery", gerund: "doing archery", emoji: "üèπ" },
            { id: "fencing", display: "Fencing", action: "fence", gerund: "fencing", emoji: "ü§∫" },
            { id: "pottery", display: "Pottery", action: "do pottery", gerund: "making pottery", emoji: "üè∫" },
            { id: "astronomy", display: "Astronomy", action: "study astronomy", gerund: "studying astronomy", emoji: "üî≠" },
            { id: "robotics", display: "Robotics", action: "build robots", gerund: "building robots", emoji: "ü§ñ" },
            { id: "woodworking", display: "Woodworking", action: "do woodworking", gerund: "doing woodworking", emoji: "ü™ö" },
            { id: "birdwatching", display: "Birdwatching", action: "go birdwatching", gerund: "birdwatching", emoji: "üê¶" },
            { id: "collecting", display: "Collecting", action: "collect antiques", gerund: "collecting things", emoji: "üè∫" },
            { id: "magic", display: "Magic Tricks", action: "do magic tricks", gerund: "doing magic tricks", emoji: "üé©" },
            { id: "surfing", display: "Surfing", action: "go surfing", gerund: "surfing", emoji: "üèÑ" },
            { id: "climbing", display: "Rock Climbing", action: "go rock climbing", gerund: "rock climbing", emoji: "üßó" },
            { id: "horseback", display: "Horse Riding", action: "go horse riding", gerund: "horse riding", emoji: "üèá" },
            { id: "violin", display: "Violin", action: "play the violin", gerund: "playing the violin", emoji: "üéª" }
        ];

        // ========================================
        // üìù CONVERSATION TEMPLATES
        // ========================================
        
        const conversationTemplates = {
            easy: {
                templates: [
                    "I really like {gerund}.",
                    "My favorite hobby is {gerund}.",
                    "I want to {action} this weekend.",
                    "Have you ever tried {gerund}?",
                    "I am going to {action} today.",
                    "Do you want to {action} with me?"
                ]
            },
            medium: {
                templates: [
                    "I have never tried {gerund}, but I really want to learn.",
                    "I used to like {gerund1}, but now I prefer {gerund}.",
                    "I wanted to {action1}, but I decided to {action} instead.",
                    "My friend enjoys {gerund1}, but I think {gerund} is more fun.",
                    "I have tried {gerund1} before, but I have not tried {gerund} yet.",
                    "This Saturday, I am definitely going to {action}."
                ]
            },
            hard: {
                templates: [
                    "I usually {action1} on Mondays, but on Tuesdays I {action}.",
                    "I'm busy on Saturday {gerund1}, so on Sunday I will {action}.",
                    "I was planning to {action1}, but since it's raining, I'll {action} indoors.",
                    "On Wednesday I usually {action1}, but on Thursday I am free to {action}.",
                    "My schedule is full. Monday is {gerund1}, Tuesday is {gerund2}, but Friday is finally time for {gerund}.",
                    "I haven't tried {gerund} yet, even though I {action1} every week.",
                    "Which day for {gerund}? I think I'll squeeze it in on Wednesday after {gerund1}."
                ]
            }
        };

        // ======= STATE =======
        let currentGrade = null;
        let studentNames = [];
        let totalRounds = 8;
        let currentRound = 1;
        let currentQuestion = 1;
        let maxQuestions = 10;
        let isChampionship = false;
        let currentPlayers = [];
        let usedPlayers = [];
        let roundWinners = new Set();
        let playerScores = {};
        let globalLeaderboard = {};
        let playerStreaks = {};
        let timeLeft = 15;
        let gameActive = false;
        let currentQuestionData = null;
        let questionInterval = null;
        let timers = new Set();
        let cachedVoices = [];
        let voicesReady = false;
        let audioContext = null;

        // ======= HELPERS =======
        function clearTimer(ref) {
          if (!ref) return;
          if (ref._type === 'interval') clearInterval(ref.id);
          else clearTimeout(ref.id);
          timers.delete(ref);
        }

        function makeInterval(fn, ms) {
          const id = setInterval(fn, ms);
          const ref = { id, _type: 'interval' };
          timers.add(ref);
          return ref;
        }

        function makeTimeout(fn, ms) {
          const id = setTimeout(fn, ms);
          const ref = { id, _type: 'timeout' };
          timers.add(ref);
          return ref;
        }

        function stopAllSpeech() {
          if ('speechSynthesis' in window) {
            speechSynthesis.cancel();
          }
        }

        function ensureVoicesReady() {
          return new Promise(resolve => {
            if (voicesReady) return resolve(cachedVoices);
            const load = () => {
              cachedVoices = speechSynthesis.getVoices();
              if (cachedVoices && cachedVoices.length > 0) {
                voicesReady = true;
                resolve(cachedVoices);
              }
            };
            const existing = speechSynthesis.getVoices();
            if (existing && existing.length > 0) {
              cachedVoices = existing;
              voicesReady = true;
              resolve(cachedVoices);
            } else {
              window.speechSynthesis.onvoiceschanged = () => load();
              try {
                const u = new SpeechSynthesisUtterance('');
                speechSynthesis.speak(u);
                speechSynthesis.cancel();
              } catch {}
              makeTimeout(load, 1000);
            }
          });
        }

        // Generic speech function
        function speakOnce(text, { lang = 'en-US', rate = 0.85, pitch = 1, voicePref = null } = {}) {
            return new Promise(async (resolve) => {
                if (!('speechSynthesis' in window) || !text) return resolve();
                await ensureVoicesReady();
                stopAllSpeech(); 
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.rate = rate; 
                u.pitch = pitch;
                
                if (cachedVoices.length > 0) {
                    let selectedVoice;
                    if (voicePref === 'Brian') {
                        selectedVoice = cachedVoices.find(v => v.name.includes('Brian') && v.lang.startsWith('en'));
                    } else {
                        // Default to Emma for general questions
                        selectedVoice = cachedVoices.find(v => v.name.includes('Emma') && v.lang.startsWith('en')) ||
                                        cachedVoices.find(v => v.name.includes('Microsoft Emma')) ||
                                        cachedVoices.find(v => v.lang.startsWith('en'));
                    }
                    if (selectedVoice) u.voice = selectedVoice;
                }
                u.onend = () => resolve();
                u.onerror = () => resolve();
                speechSynthesis.speak(u);
            });
        }
        
        function speak(text) { return speakOnce(text, { lang: 'en-US', rate: 0.85, pitch: 1, voicePref: 'Emma' }); }
        
        // FEEDBACK VOICE: Brian
        function speakBrian(text) { return speakOnce(text, { lang: 'en-US', rate: 0.85, pitch: 1, voicePref: 'Brian' }); }

        function playAudio() {
            if (!currentQuestionData) return Promise.resolve();
            return speak(currentQuestionData.script);
        }

        // ======= AUDIO ENGINE (IMPROVED) =======
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function playTone(freq, type, duration, startTime = 0, vol = 0.1) {
            if (!audioContext) initAudio();
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioContext.currentTime + startTime);
            
            gain.gain.setValueAtTime(vol, audioContext.currentTime + startTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + startTime + duration);
            
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start(audioContext.currentTime + startTime);
            osc.stop(audioContext.currentTime + startTime + duration);
        }

        function playClickSound() {
            // Short high blip
            playTone(800, 'sine', 0.1, 0, 0.05);
        }

        function playTickSound() {
            // Woodblock-ish
            playTone(600, 'square', 0.05, 0, 0.05);
        }

        function playBuzzerSound() {
            // Low buzz
            playTone(150, 'sawtooth', 0.5, 0, 0.2);
            playTone(145, 'sawtooth', 0.5, 0, 0.2); // Dissonance
        }

        function playCorrectSound() {
            // Major Triad Arpeggio (C Major)
            playTone(523.25, 'sine', 0.4, 0, 0.1); // C5
            playTone(659.25, 'sine', 0.4, 0.1, 0.1); // E5
            playTone(783.99, 'sine', 0.6, 0.2, 0.1); // G5
            playTone(1046.50, 'sine', 0.8, 0.3, 0.05); // C6
        }

        function playWrongSound() {
            // Descending dissonant slide
            if (!audioContext) initAudio();
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(300, audioContext.currentTime);
            osc.frequency.linearRampToValueAtTime(100, audioContext.currentTime + 0.4);
            gain.gain.setValueAtTime(0.2, audioContext.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.4);
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + 0.4);
        }

        function playShuffleSound() {
            // Rapid random tones
            for(let i=0; i<10; i++){
                playTone(400 + Math.random()*400, 'sine', 0.05, i*0.05, 0.03);
            }
        }

        function playWinFanfare() {
            // Victory melody
            const now = 0;
            playTone(523.25, 'square', 0.2, now, 0.1); // C
            playTone(523.25, 'square', 0.2, now+0.2, 0.1); // C
            playTone(523.25, 'square', 0.2, now+0.4, 0.1); // C
            playTone(659.25, 'square', 0.6, now+0.6, 0.1); // E
            playTone(783.99, 'square', 0.8, now+0.9, 0.1); // G
        }

        // ======= GAME LOGIC =======
        function startTimer() {
            const progressFill = document.getElementById('progressFill');
            const progressEmoji = document.getElementById('progressEmoji');
            if (questionInterval) clearTimer(questionInterval);

            timeLeft = 15;
            progressFill.style.width = '100%';
            progressEmoji.textContent = '‚è±Ô∏è';

            questionInterval = makeInterval(() => {
                timeLeft--;
                const percentage = (timeLeft / 15) * 100;
                progressFill.style.width = percentage + '%';
                if (timeLeft <= 5 && timeLeft > 0) { playTickSound(); }
                if (timeLeft <= 0) {
                    clearTimer(questionInterval);
                    questionInterval = null;
                    stopAllSpeech();
                    playBuzzerSound();
                    timeUp();
                }
            }, 1000);
        }

        async function startNewQuestion() {
            if (currentQuestion > maxQuestions) {
                endRound();
                return;
            }
            stopAllSpeech();
            if (questionInterval) clearTimer(questionInterval);

            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => {
                button.disabled = false;
                button.classList.remove('active-player-correct', 'active-player-incorrect');
                button.classList.remove('correct', 'incorrect'); // Clean up old classes
            });

            // Transition Animation
            const qSection = document.getElementById('questionSection');
            qSection.classList.remove('question-active');
            qSection.classList.add('question-enter');

            gameActive = true;
            timeLeft = 15;
            currentQuestionData = generateQuestion();
            document.getElementById('questionsLeft').textContent = (maxQuestions - currentQuestion + 1);
            document.getElementById('progressFill').style.width = '100%';
            updateStreakDisplay();
            
            // Slide in
            setTimeout(() => {
                qSection.classList.remove('question-enter');
                qSection.classList.add('question-active');
            }, 50);

            startTimer();
            
            if (gameActive) await playAudio();
        }

        function generateQuestion() {
            let difficulty, itemPool;
            
            // Championship always uses Hard
            if (isChampionship) {
                difficulty = 'hard';
                itemPool = hardHobbies;
            } else {
                if (currentQuestion === 1) {
                    difficulty = 'easy';
                    itemPool = easyHobbies;
                } else if (currentQuestion <= 5) {
                    difficulty = 'medium';
                    itemPool = mediumHobbies;
                } else {
                    difficulty = 'hard';
                    itemPool = hardHobbies;
                }
            }
            
            const correctItem = itemPool[Math.floor(Math.random() * itemPool.length)];
            const allItems = [...easyHobbies, ...mediumHobbies, ...hardHobbies];
            const distractorPool = allItems.filter(item => item.id !== correctItem.id);
            const distractorItems = distractorPool.sort(() => Math.random() - 0.5).slice(0, 3);

            const choices = [correctItem, ...distractorItems];
            const templates = conversationTemplates[difficulty].templates;
            let script = templates[Math.floor(Math.random() * templates.length)];
            
            // Replacements using Action (verb phrase) and Gerund (ing phrase)
            script = script.replace(/{action}/g, correctItem.action);
            script = script.replace(/{gerund}/g, correctItem.gerund);
            
            // Fallback for simple nouns if needed, but mostly covered by above
            script = script.replace(/{item}/g, correctItem.display); 

            if (distractorItems[0]) {
                script = script.replace(/{action1}/g, distractorItems[0].action);
                script = script.replace(/{gerund1}/g, distractorItems[0].gerund);
            }
            if (distractorItems[1]) {
                script = script.replace(/{action2}/g, distractorItems[1].action);
                script = script.replace(/{gerund2}/g, distractorItems[1].gerund);
            }

            const p1Choices = [...choices].sort(() => Math.random() - 0.5);
            const p2Choices = [...choices].sort(() => Math.random() - 0.5);
            const p3Choices = [...choices].sort(() => Math.random() - 0.5);
            
            const buttons = document.querySelectorAll('.choice-button');
            p1Choices.forEach((c, i) => { buttons[i].textContent = c.display.toLowerCase(); });
            p2Choices.forEach((c, i) => { buttons[i+4].textContent = c.display.toLowerCase(); });
            p3Choices.forEach((c, i) => { buttons[i+8].textContent = c.display.toLowerCase(); });

            return {
                script,
                correctItem,
                player1Choices: p1Choices,
                player2Choices: p2Choices,
                player3Choices: p3Choices
            };
        }

        async function selectAnswer(choiceIndex) {
            if (!gameActive || !currentQuestionData) return;
            
            gameActive = false;
            if (questionInterval) clearTimer(questionInterval);
            stopAllSpeech();

            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => button.disabled = true);

            let answeringPlayer, selectedChoice, playerStartIndex, playerEndIndex;
            
            if (choiceIndex < 4) { 
                answeringPlayer = currentPlayers[0]; 
                selectedChoice = currentQuestionData.player1Choices[choiceIndex];
                playerStartIndex = 0; playerEndIndex = 4;
            } else if (choiceIndex < 8) { 
                answeringPlayer = currentPlayers[1]; 
                selectedChoice = currentQuestionData.player2Choices[choiceIndex-4];
                playerStartIndex = 4; playerEndIndex = 8;
            } else { 
                answeringPlayer = currentPlayers[2]; 
                selectedChoice = currentQuestionData.player3Choices[choiceIndex-8];
                playerStartIndex = 8; playerEndIndex = 12;
            }
            
            const isCorrect = selectedChoice.id === currentQuestionData.correctItem.id;
            
            const playerButton = buttons[choiceIndex];
            
            if (isCorrect) {
                playerButton.classList.add('active-player-correct');
                createFireworks(playerButton);
                createConfetti(playerButton);
                createSparkles(playerButton);
            } else {
                playerButton.classList.add('active-player-incorrect');
                createShakeEffect(playerButton);
            }
            
            if (!playerStreaks[answeringPlayer]) playerStreaks[answeringPlayer] = 0;
            
            if (isCorrect) {
                playerStreaks[answeringPlayer]++;
                let points = 10 + (playerStreaks[answeringPlayer] >= 3 ? Math.min(playerStreaks[answeringPlayer]*2, 20) : 0);
                playerScores[answeringPlayer] += points;
                playCorrectSound();
                
                let msg = `Correct!`;
                if (playerStreaks[answeringPlayer] > 2) msg += ` ${playerStreaks[answeringPlayer]} in a row!`;
                await speak(msg);
                await speakBrian(`${formatStudentName(answeringPlayer).split(' (')[0]}, correct! Plus ${points} points!`);
                createFlyingTokens(playerButton, getPlayerScoreElement(answeringPlayer), `+${points}`);
                if (playerStreaks[answeringPlayer] > 2) createStreakEffects(playerButton);
            } else {
                playerStreaks[answeringPlayer] = 0;
                playerScores[answeringPlayer] -= 5;
                
                currentPlayers.forEach(p => {
                    if (p !== answeringPlayer) {
                        playerScores[p] += 5;
                        const scoreEl = getPlayerScoreElement(p);
                        createFlyingTokens(playerButton, scoreEl, '+5');
                    }
                });
                
                playWrongSound();
                await speak(`Incorrect.`);
                await speakBrian(`${formatStudentName(answeringPlayer).split(' (')[0]}, incorrect. Minus five points. Opponents get 5 points!`);
                createFlyingTokens(playerButton, getPlayerScoreElement(answeringPlayer), '-5');
            }
            
            updatePlayerDisplay();
            
            makeTimeout(() => {
                currentQuestion++;
                startNewQuestion();
            }, 2000);
        }

        async function timeUp() {
            gameActive = false;
            stopAllSpeech();
            currentPlayers.forEach(p => playerStreaks[p] = 0);
            
            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => button.disabled = true);

            buttons.forEach((button) => {
                if (button.textContent === currentQuestionData.correctItem.display.toLowerCase()) {
                    button.classList.add('correct');
                }
            });

            await speakBrian(`Time's up! The correct answer is ${currentQuestionData.correctItem.display}`);
            updatePlayerDisplay();
            makeTimeout(() => { currentQuestion++; startNewQuestion(); }, 2000);
        }

        async function endRound() {
            stopAllSpeech();
            const leaderboard = document.getElementById('leaderboard');
            const content = document.getElementById('leaderboardContent');
            const globalContent = document.getElementById('globalScores');
            
            currentPlayers.forEach(player => {
                if (!globalLeaderboard[player]) globalLeaderboard[player] = 0;
                globalLeaderboard[player] += playerScores[player];
            });
            
            const sortedPlayers = [...currentPlayers].sort((a, b) => playerScores[b] - playerScores[a]);
            
            if (!isChampionship) {
                roundWinners.add(sortedPlayers[0]);
            }

            let leaderboardHTML = '<h3>Round Scores:</h3>';
            sortedPlayers.forEach((player, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                leaderboardHTML += `<div style="margin: 10px 0; font-size: 20px;">${medal} ${formatStudentName(player)}: ${playerScores[player]}</div>`;
            });
            
            const globalSorted = Object.entries(globalLeaderboard).sort(([,a], [,b]) => b - a).slice(0, 10);
            let globalHTML = '';
            globalSorted.forEach(([player, score], index) => {
                const medal = index === 0 ? 'üëë' : index === 1 ? 'ü•á' : index === 2 ? 'ü•à' : '‚≠ê';
                globalHTML += `<div style="margin: 5px 0; font-size: 16px;">${medal} ${formatStudentName(player)}: ${score}</div>`;
            });
            
            content.innerHTML = leaderboardHTML;
            globalContent.innerHTML = globalHTML;
            leaderboard.style.display = 'block';
            createWinnerFireworks();
            playWinFanfare(); // New sound

            const winner = sortedPlayers[0];
            const winnerName = formatStudentName(winner);
            const winnerEng = winnerName.split(' (')[0];
            
            if (!isChampionship) {
                if (currentRound < totalRounds) {
                    await speak(`Round winner is ${winnerEng}!`);
                    await speakBrian(`Congratulations ${winnerEng}! You won this round!`);
                    makeTimeout(() => { nextRound(); }, 5000);
                } else {
                    await speak(`Round winner is ${winnerEng}!`);
                    await speakBrian(`End of regular rounds. Preparing for Championship!`);
                    makeTimeout(() => { startChampionshipRound(); }, 5000);
                }
            } else {
                const champion = sortedPlayers[0];
                const champName = formatStudentName(champion);
                const champEng = champName.split(' (')[0];
                await speak(`Championship Winner is ${champEng}!`);
                await speakBrian(`The Ultimate Champion is... ${champEng}!`);
                makeTimeout(() => { backToMenu(); }, 8000);
            }
        }

        function nextRound() {
            stopAllSpeech();
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('streakIndicator').style.display = 'none';
            currentRound++;
            currentQuestion = 1;
            maxQuestions = 10;
            document.getElementById('roundDisplay').textContent = `Round ${currentRound} of ${totalRounds}`;
            Object.keys(playerScores).forEach(p => playerScores[p] = 0);
            Object.keys(playerStreaks).forEach(p => playerStreaks[p] = 0);
            selectNewPlayers();
        }

        function startChampionshipRound() {
            stopAllSpeech();
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('streakIndicator').style.display = 'none';
            
            isChampionship = true;
            currentRound++; // Logically round + 1
            currentQuestion = 1;
            maxQuestions = 5; // 5 complicated questions
            
            document.getElementById('roundDisplay').textContent = `üèÜ CHAMPIONSHIP ROUND`;
            
            let potentialPlayers = Array.from(roundWinners);
            
            if (potentialPlayers.length < 3) {
                 const sortedGlobal = Object.entries(globalLeaderboard).sort(([,a], [,b]) => b - a).map(([p]) => p);
                 for (let p of sortedGlobal) {
                     if (!potentialPlayers.includes(p)) {
                         potentialPlayers.push(p);
                         if (potentialPlayers.length >= 3) break;
                     }
                 }
            }
            
            currentPlayers = potentialPlayers.slice(0, 3);
            
            Object.keys(playerScores).forEach(p => playerScores[p] = 0);
            Object.keys(playerStreaks).forEach(p => playerStreaks[p] = 0);
            
            const shuffleDiv = document.getElementById('nameShuffle');
            shuffleDiv.querySelector('.shuffle-title').innerHTML = 'üèÜ CHAMPIONSHIP PLAYOFF üèÜ';
            document.getElementById('shuffleContainer').innerHTML = '<div style="font-size: 24px; color: #666; margin-bottom: 20px;">Round Winners Compete!</div>';
            const selectedPlayersDiv = document.getElementById('selectedPlayers');
            selectedPlayersDiv.innerHTML = '';
            
            currentPlayers.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'selected-player';
                d.textContent = `P${i+1}: ${formatStudentName(p)}`;
                selectedPlayersDiv.appendChild(d);
            });
            shuffleDiv.style.display = 'block';
            makeTimeout(() => showPlayerCountdown(true), 4000);
        }

        function selectNewPlayers() {
            showNameShuffle();
            
            let avail = studentNames.filter(n => !usedPlayers.includes(n));
            
            if (avail.length < 3) {
                usedPlayers = [];
                avail = [...studentNames];
            }
            
            const container = document.getElementById('shuffleContainer');
            container.innerHTML = '';
            document.getElementById('selectedPlayers').innerHTML = '';
            
            avail.forEach((n, i) => {
                setTimeout(() => {
                    const d = document.createElement('div');
                    d.className = 'shuffle-name';
                    d.textContent = formatStudentName(n);
                    container.appendChild(d);
                }, i*50);
            });
            setTimeout(() => selectPlayersSequentially(avail, 0), avail.length*50 + 1000);
        }

        function selectPlayersSequentially(avail, idx) {
            if (idx >= 3) { setTimeout(() => showPlayerCountdown(), 1000); return; }
            
            if (avail.length === 0) {
                 avail = studentNames.filter(n => !currentPlayers.includes(n));
            }

            const selIdx = Math.floor(Math.random() * avail.length);
            const p = avail.splice(selIdx, 1)[0];
            currentPlayers.push(p);
            usedPlayers.push(p);
            const formattedName = formatStudentName(p);

            const container = document.getElementById('shuffleContainer');
            const targetElement = Array.from(container.querySelectorAll('.shuffle-name')).find(el => el.textContent === formattedName);

            let count = 0;
            const int = setInterval(async () => {
                const names = Array.from(container.querySelectorAll('.shuffle-name'));
                names.forEach(e => e.classList.remove('selected'));
                
                if (count < 10) {
                    if (names.length > 0) {
                        const rand = Math.floor(Math.random() * names.length);
                        names[rand].classList.add('selected');
                        playClickSound(); // Sound on shuffle
                    }
                } else {
                    clearInterval(int);
                    if (targetElement) targetElement.classList.add('selected');
                    
                    setTimeout(async () => {
                        if (targetElement) targetElement.remove();
                        
                        const d = document.createElement('div');
                        d.className = 'selected-player';
                        d.textContent = `P${idx + 1}: ${formattedName}`;
                        document.getElementById('selectedPlayers').appendChild(d);
                        
                        playCorrectSound();
                        const spokenName = formattedName.split(' (')[0];
                        await speakBrian(spokenName); 
                        
                        setTimeout(() => selectPlayersSequentially(avail, idx + 1), 500);
                    }, 500);
                }
                count++;
            }, 100);
        }

        function showNameShuffle() { document.getElementById('nameShuffle').style.display = 'block'; currentPlayers = []; playShuffleSound(); }
        function showPlayerCountdown(final=false) {
            const div = document.getElementById('nameShuffle');
            if (!final) div.querySelector('.shuffle-container').innerHTML = '';
            let c = 5;
            const t = div.querySelector('.shuffle-title');
            t.textContent = `Starting in ${c}...`;
            const i = setInterval(() => {
                c--;
                t.textContent = `Starting in ${c}...`;
                playTickSound();
                if (c<=0) {
                    clearInterval(i);
                    currentPlayers.forEach(p => playerScores[p]=0);
                    updatePlayerDisplay();
                    div.style.display='none';
                    startNewQuestion();
                }
            }, 1000);
        }

        function updatePlayerDisplay() {
            document.getElementById('player1').textContent = formatStudentName(currentPlayers[0]) || 'P1';
            document.getElementById('score1').textContent = (playerScores[currentPlayers[0]]||0) + ' pts';
            document.getElementById('player2').textContent = formatStudentName(currentPlayers[1]) || 'P2';
            document.getElementById('score2').textContent = (playerScores[currentPlayers[1]]||0) + ' pts';
            document.getElementById('player3').textContent = formatStudentName(currentPlayers[2]) || 'P3';
            document.getElementById('score3').textContent = (playerScores[currentPlayers[2]]||0) + ' pts';
            updateStreakDisplay();
        }

        function updateStreakDisplay() {
            currentPlayers.forEach((p, idx) => {
                const streakDiv = document.getElementById(`streak${idx+1}`);
                const badgesDiv = document.getElementById(`badges${idx+1}`);
                const streak = playerStreaks[p] || 0;
                
                if (streak > 0) {
                    streakDiv.style.display = 'block';
                    streakDiv.textContent = `üî• ${streak}`;
                } else {
                    streakDiv.style.display = 'none';
                }
                
                let badgesHTML = '';
                if (streak >= 3) badgesHTML += '‚ö°';
                if (streak >= 5) badgesHTML += 'üëë';
                badgesDiv.innerHTML = badgesHTML;
            });
            document.getElementById('streakIndicator').style.display = 'none';
        }

        function backToMenu() {
            stopAllSpeech();
            if(questionInterval) clearTimer(questionInterval);
            gameActive = false; currentRound = 1; currentQuestion = 1; isChampionship = false;
            currentPlayers = []; usedPlayers = []; playerScores = {}; playerStreaks = {}; globalLeaderboard = {}; roundWinners = new Set();
            ['leaderboard', 'learningPhase', 'nameShuffle', 'gameContainer', 'streakIndicator'].forEach(id => document.getElementById(id).style.display = 'none');
            document.getElementById('mainMenu').style.display = 'flex';
        }

        function selectGrade(g) {
            initAudio(); // Initialize audio context on first interaction
            currentGrade = g;
            studentNames = studentsByGrade[g];
            totalRounds = g === 10 ? 6 : 5;
            maxQuestions = 10;
            document.getElementById('roundDisplay').textContent = `Round 1 of ${totalRounds}`;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            selectNewPlayers();
        }

        // Effects
        function createFireworks(b) {
            const r = b.getBoundingClientRect();
            for(let i=0;i<15;i++) {
                setTimeout(()=>{
                    const f = document.createElement('div'); f.className='fireworks';
                    f.style.left = r.left + r.width/2 + 'px'; f.style.top = r.top + r.height/2 + 'px';
                    document.body.appendChild(f); setTimeout(()=>f.remove(), 2000);
                }, i*100);
            }
        }
        function createSparkles(b) {
            const r = b.getBoundingClientRect();
            for(let i=0;i<10;i++) {
                setTimeout(()=>{
                    const s = document.createElement('div'); s.className='sparkle';
                    s.style.left = r.left + Math.random()*r.width + 'px';
                    s.style.top = r.top + Math.random()*r.height + 'px';
                    document.body.appendChild(s); setTimeout(()=>s.remove(), 1000);
                }, i*50);
            }
            // Glitter
            for(let i=0;i<20;i++) {
                setTimeout(()=>{
                    const g = document.createElement('div'); g.className='glitter';
                    g.style.left = r.left + Math.random()*r.width + 'px';
                    g.style.top = r.top + Math.random()*r.height + 'px';
                    document.body.appendChild(g); setTimeout(()=>g.remove(), 2000);
                }, i*30);
            }
        }
        function createConfetti(b) {
            const r = b.getBoundingClientRect();
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti-particle';
                c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                c.style.left = r.left + r.width/2 + (Math.random()*100 - 50) + 'px';
                c.style.top = r.top + r.height/2 + (Math.random()*50 - 25) + 'px';
                // Random fall speed
                c.style.animationDuration = (1.5 + Math.random()) + 's';
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 2500);
            }
        }
        
        function createShakeEffect(b) {
            for(let i=0;i<5;i++) {
                setTimeout(()=>{
                    const x = document.createElement('div'); x.innerHTML='‚ùå'; x.style.position='absolute';
                    x.style.left = b.getBoundingClientRect().left + 20 + 'px';
                    x.style.top = b.getBoundingClientRect().top + 'px';
                    x.style.zIndex=1001; x.style.animation='fadeOut 1s forwards';
                    document.body.appendChild(x); setTimeout(()=>x.remove(), 1000);
                }, i*100);
            }
        }
        function createFlyingTokens(from, to, txt) {
            if(!from||!to)return;
            const f = from.getBoundingClientRect(); const t = to.getBoundingClientRect();
            for(let i=0;i<5;i++){
                setTimeout(()=>{
                    const tk = document.createElement('div'); tk.className='token'; tk.textContent=txt;
                    tk.style.left=f.left+f.width/2+'px'; tk.style.top=f.top+f.height/2+'px';
                    document.body.appendChild(tk);
                    setTimeout(()=>{
                        tk.style.transition='all 1s ease';
                        tk.style.left=t.left+t.width/2+'px'; tk.style.top=t.top+t.height/2+'px';
                        tk.style.opacity=0;
                    }, 50);
                    setTimeout(()=>tk.remove(), 1100);
                }, i*100);
            }
        }
        function createStreakEffects(b) { createFireworks(b); }
        function createWinnerFireworks() {
            for(let i=0;i<30;i++) {
                setTimeout(()=>{
                    const f = document.createElement('div'); f.className='winner-firework';
                    f.style.left=Math.random()*window.innerWidth+'px'; f.style.top=Math.random()*window.innerHeight+'px';
                    document.body.appendChild(f); setTimeout(()=>f.remove(), 3000);
                }, i*100);
            }
        }
        function getPlayerScoreElement(p) {
            const idx = currentPlayers.indexOf(p);
            if(idx===0) return document.getElementById('score1');
            if(idx===1) return document.getElementById('score2');
            if(idx===2) return document.getElementById('score3');
        }

        window.addEventListener('load', () => {
            setTimeout(initGame, 1000);
            ensureVoicesReady();
            // Try to init audio context on click anywhere if blocked
            document.body.addEventListener('click', initAudio, { once: true });
        });
        
        function initGame() {
            // BG effects
            setInterval(()=>{
                // Create random floating hobby emojis
                const emojis = ['üé®','‚öΩ','üèÄ','üé∏','üì∏','üèä','üìö','üç≥','üíÉ','üé§','üéÆ','üö≤','üèÉ','üé£','üéπ'];
                const e = document.createElement('div'); 
                e.className='hobby-float';
                e.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                e.style.left=Math.random()*window.innerWidth+'px';
                // Random duration for variety
                e.style.animationDuration = (10 + Math.random() * 10) + 's';
                document.body.appendChild(e); 
                setTimeout(()=>e.remove(), 20000);
            }, 1500);
        }
    </script>
</body>
</html>
