<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QA14 Speaking Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            position: relative;
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        audio::-webkit-media-controls-panel {
            padding: 5px;
        }
        /* Improve scrolling on mobile */
        .scroll-container {
            scrollbar-width: thin;
            scrollbar-color: #4f46e5 #e5e7eb;
        }
        .scroll-container::-webkit-scrollbar {
            width: 6px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gradient-to-br dark:from-slate-900 dark:via-blue-900 dark:to-slate-900 text-gray-800 dark:text-gray-200 flex items-center justify-center p-2 sm:p-4">
    
    <div id="app-container" class="w-full max-w-xl mx-auto text-center h-full relative z-10">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-white dark:bg-gray-800 dark:shadow-lg p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center">
            <div id="name-entry-container">
                <div class="mb-6">
                    <i class="fas fa-microphone-lines text-5xl text-indigo-600 dark:text-indigo-400 mb-2"></i>
                </div>
                <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">QA14 Practice</h1>
                <p class="mb-6 text-gray-600 dark:text-gray-400 text-sm">Enter your name to begin session QA14.</p>
                <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 text-center text-lg text-gray-900 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                <button id="start-with-name-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md transition-transform active:scale-95">Start QA14</button>
            </div>

            <div id="topic-selection-container" class="hidden h-full flex flex-col">
                 <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-2 flex-shrink-0">Hello, <span id="user-name-display"></span>!</h1>
                 
                 <div id="instructions" class="text-sm text-gray-600 dark:text-gray-400 mb-4 text-left space-y-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg flex-shrink-0 border border-gray-200 dark:border-gray-700">
                      <p><i class="fas fa-bullhorn mr-2 text-indigo-500"></i>Speak until the timer runs out.</p>
                      <p><i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Use the sentence starters for help.</p>
                      <p><i class="fas fa-download mr-2 text-blue-500"></i>Download your recording after speaking.</p>
                 </div>
                 
                 <div class="flex-grow overflow-y-auto scroll-container pr-1">
                    <div id="topic-selection" class="grid grid-cols-1 sm:grid-cols-2 gap-3 pb-2">
                        <!-- Topic buttons will be injected here -->
                    </div>
                 </div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden bg-white dark:bg-gray-800 dark:shadow-lg rounded-2xl shadow-lg app-shell p-3 sm:p-4">
            <header class="flex-shrink-0">
                <div class="flex justify-between items-center mb-2">
                    <div class="w-1/3 text-left">
                         <button id="back-to-topics-btn" class="text-xs sm:text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-1.5 px-3 rounded-lg shadow-sm transition-colors">
                             <i class="fas fa-arrow-left mr-1"></i>Topics
                         </button>
                    </div>
                    <div class="w-1/3 text-center">
                         <button id="samples-btn" class="hidden text-xs sm:text-sm bg-amber-500 hover:bg-amber-600 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition-colors">
                             <i class="fas fa-lightbulb mr-1"></i>Ideas
                         </button>
                    </div>
                    <div class="w-1/3 text-right">
                         <button id="next-btn" class="hidden text-xs sm:text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-sm disabled:bg-indigo-400 dark:disabled:bg-indigo-800 disabled:cursor-not-allowed transition-colors">
                             Next<i class="fas fa-arrow-right ml-1"></i>
                         </button>
                    </div>
                </div>

                <!-- Timer Display -->
                <div class="relative w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-2 flex-shrink-0">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200 dark:text-gray-700" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="timer-progress" class="timer-circle text-indigo-500" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-2xl font-bold font-mono"></div>
                    <button id="pause-resume-btn" class="hidden absolute bottom-0 right-0 w-8 h-8 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center text-sm shadow-md z-20 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                        <i class="fas fa-pause"></i>
                    </button>
                </div>
                
                <p id="phase-indicator" class="font-semibold text-indigo-600 dark:text-indigo-400 mb-1 text-sm uppercase tracking-wide flex-shrink-0"></p>

                <!-- Question Display -->
                <div id="question-container" class="min-h-[60px] flex items-center justify-center mb-2 bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-xl border border-indigo-100 dark:border-indigo-800">
                    <h2 id="question-text" class="text-base sm:text-lg font-bold leading-snug text-center w-full text-gray-800 dark:text-gray-100"></h2>
                </div>
                
                <div id="error-message-box" class="hidden text-red-500 bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-800 p-2 rounded-lg text-xs mb-2"></div>

                <!-- Recording Action Buttons -->
                <div id="recording-actions-container" class="flex flex-col items-center justify-center mb-1">
                    <!-- Initial Record Button -->
                    <button id="record-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold w-14 h-14 rounded-full text-xl shadow-lg shadow-red-500/30 transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <!-- Stop Button -->
                    <button id="stop-record-btn" class="hidden bg-gray-800 hover:bg-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 text-white font-bold w-14 h-14 rounded-full text-xl shadow-lg flex items-center justify-center transition-all active:scale-95">
                        <i class="fas fa-stop"></i>
                    </button>
                    
                    <!-- Post-Recording Controls -->
                    <div id="post-recording-actions" class="hidden w-full flex-col items-center justify-center space-y-2 mt-1">
                        <audio id="audio-player" controls class="w-full max-w-xs h-8"></audio>
                        <div class="flex gap-2 w-full max-w-xs">
                            <!-- Download button -->
                            <button id="download-btn"
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg text-xs shadow-md transition-all flex items-center justify-center gap-2">
                                 <i class="fas fa-download"></i> Save MP3
                            </button>
                            
                            <!-- Upload/Share button (Example Link) -->
                            <a id="upload-link"
                               href="#" 
                               onclick="alert('Please configure the upload link in the code!'); return false;"
                               class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-3 rounded-lg text-xs shadow-md transition-all flex items-center justify-center gap-2">
                                 <i class="fas fa-cloud-upload-alt"></i> Upload
                            </a>
                        </div>
                    </div>
                </div>
                 <div id="recording-status" class="hidden items-center justify-center text-red-500 font-semibold text-xs animate-pulse">
                      <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
                      Recording in progress...
                 </div>
            </header>
            
            <main class="flex-grow flex flex-col overflow-y-auto scroll-container min-h-0 space-y-3 pt-2 px-1">
                 <!-- Sentence Starters -->
                <div id="starters-container" class="hidden text-left bg-white dark:bg-gray-700/30 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                    <h3 class="text-xs font-bold uppercase text-gray-400 mb-2 tracking-wider">Sentence Starters</h3>
                    <div id="starters-list" class="flex flex-wrap gap-2">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Word Bank -->
                <div id="word-bank-container" class="hidden text-left bg-white dark:bg-gray-700/30 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                    <h3 class="text-xs font-bold uppercase text-gray-400 mb-2 tracking-wider">Useful Vocabulary</h3>
                    <div id="word-bank-list" class="flex flex-wrap gap-2">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Sample Answers Display -->
                <div id="samples-container" class="hidden text-left">
                    <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 p-3 rounded-xl">
                        <h3 class="text-xs font-bold uppercase text-amber-600 dark:text-amber-500 mb-2 tracking-wider flex items-center">
                            <i class="fas fa-star mr-1"></i> Sample Responses
                        </h3>
                        <ul id="samples-list" class="space-y-2 list-none text-sm text-gray-700 dark:text-gray-300">
                        </ul>
                    </div>
                </div>
            </main>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center">
            <div id="certificate-to-download" class="w-full bg-slate-50 dark:bg-slate-700 p-6 sm:p-10 rounded-xl border-4 border-double border-yellow-400 dark:border-yellow-500 text-center shadow-inner relative overflow-hidden">
                <!-- Watermark -->
                <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none">
                    <i class="fas fa-award text-9xl"></i>
                </div>
                
                <div class="relative z-10">
                    <i class="fas fa-crown text-5xl text-yellow-500 mb-4 drop-shadow-sm"></i>
                    <h1 class="text-2xl sm:text-3xl font-serif font-bold text-gray-800 dark:text-white mb-2">Certificate of Excellence</h1>
                    <div class="h-1 w-20 bg-yellow-500 mx-auto mb-4"></div>
                    <p class="text-sm sm:text-base text-gray-600 dark:text-gray-300 uppercase tracking-widest mb-4">QA14 Presented To</p>
                    
                    <p id="certificate-name" class="text-3xl sm:text-5xl font-bold my-4 text-indigo-700 dark:text-indigo-300 font-serif italic"></p>
                    
                    <p class="text-base text-gray-600 dark:text-gray-300">For successfully completing the QA14 speaking practice.</p>
                    <div class="mt-8 flex justify-center items-center gap-2 text-xs text-gray-400">
                        <span>Date: <span id="certificate-date"></span></span>
                        <span>•</span>
                        <span>Verified</span>
                    </div>
                </div>
            </div>
            <button id="download-certificate-btn" class="mt-8 w-full max-w-xs bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-md transition-all active:scale-95 flex items-center justify-center">
                <i class="fas fa-file-image mr-2"></i>Download Image
            </button>
             <button id="back-to-main-menu-btn" class="mt-4 text-sm text-gray-500 hover:text-indigo-500 transition-colors">Start New Session</button>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 text-center max-w-sm w-full border border-gray-200 dark:border-gray-700">
            <div class="mb-4 text-yellow-500 text-4xl">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h3 id="modal-title" class="text-xl font-bold mb-2 dark:text-white">End Session?</h3>
            <p id="modal-message" class="text-gray-600 dark:text-gray-400 mb-6 text-sm">Returning to the topic list will clear your current progress.</p>
            <div class="flex justify-center gap-3">
                <button id="modal-cancel-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200 transition-colors">Cancel</button>
                <button id="modal-confirm-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">End Session</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // ==========================================
        //  QA14 DATA SECTION
        // ==========================================
        const practiceData = {
            "Appointments": [
                {
                    question: "Scenario: You need to make an appointment with a doctor. Call the doctor's office and explain that you have a bad cold and would like to be seen.",
                    starters: ["Hello, my name is... I'd like to make an appointment.", "Good morning, I would like to see a doctor.", "I'm calling because I'm not feeling well.", "Do you have any available appointments today or tomorrow?"],
                    wordBank: ["make an appointment (Termin)", "a bad cold (Erkältung)", "sore throat", "fever", "available", "health insurance card (Krankenversichertenkarte)"],
                    samples: [
                        "Hello, my name is [Name]. I would like to make an appointment to see a doctor. I have a bad cold and a fever, and I've been feeling sick for two days.",
                        "Good morning. I'm calling to schedule an appointment. I have a sore throat and a cough. Do you have any availability this afternoon?",
                        "Hello, I am a new patient. I would like to see a doctor because I am feeling unwell. I have my health insurance card. When is the doctor's next free appointment?"
                    ]
                },
                {
                    question: "Scenario: You are at a German bank to open a student bank account (Girokonto). What questions would you ask the bank employee?",
                    starters: ["Hello, I'm a new student and I'd like to open an account.", "I have a few questions about the student account.", "Is this account free for students?", "How long does it take to receive the card?"],
                    wordBank: ["student account (Girokonto)", "monthly fees (monatliche Gebühren)", "online banking", "EC card (Girocard)", "documents needed", "passport", "registration (Anmeldung)"],
                    samples: [
                        "Hello, I would like to open a student account. Could you please tell me if there are any monthly fees for students?",
                        "I'd like to ask about online banking. Is it easy to set up, and can I use it to transfer money back to my family in China?",
                        "Thank you for the information. What documents do I need to bring with me to open the account? I have my passport and my university enrollment letter."
                    ]
                }
            ],
            "University Life": [
                {
                    question: "Scenario: You didn't understand an important concept in a university lecture. How would you ask the professor for clarification after class?",
                    starters: ["Excuse me, Professor...", "I'm sorry to bother you, I have a quick question about the lecture.", "I didn't quite understand the part about...", "Could you possibly explain... in another way?"],
                    wordBank: ["clarification", "didn't understand", "a bit confused", "could you explain", "the concept of", "the difference between", "office hours (Sprechstunde)"],
                    samples: [
                        "Excuse me, Professor Schmidt. I found the lecture very interesting, but I was a bit confused about the concept of opportunity cost. Could you explain it one more time?",
                        "I have a quick question about the presentation. I didn't quite understand the difference between the two theories you mentioned. Is there a simple example?",
                        "Thank you for the lecture. I'm still having some trouble with the formula you showed. Would it be okay to come to your office hours this week to discuss it?"
                    ]
                },
                {
                    question: "Scenario: You see a notice for a university film club that you want to join. Approach the students at the table and ask how to become a member.",
                    starters: ["Hi there, I saw your sign for the film club.", "Excuse me, could you tell me a little bit about this club?", "This looks really interesting. How can I sign up?", "What kind of activities do you do?"],
                    wordBank: ["film club", "sign up", "become a member", "meeting times", "membership fee", "movie screenings", "discussion", "interested in joining"],
                    samples: [
                        "Hi, I saw your flyer and I'm very interested in joining the film club. Could you tell me how to sign up?",
                        "This looks like fun. What kind of movies do you usually watch? And when are the regular meeting times?",
                        "Hello, I am a new student here and I love movies. Is there a membership fee to join the club, and what kind of events do you organize?"
                    ]
                }
            ],
            "Shopping & Errands": [
                {
                    question: "Scenario: You are at a German supermarket and cannot find soy sauce. Ask a store employee where you can find it.",
                    starters: ["Excuse me, can you help me please?", "I'm sorry to bother you, I'm looking for...", "Could you please tell me where the... is?", "I can't seem to find..."],
                    wordBank: ["soy sauce (Sojasauce)", "in which aisle", "the Asian food section", "I'm looking for", "where can I find", "thank you for your help"],
                    samples: [
                        "Excuse me, I'm looking for soy sauce. Could you please tell me which aisle I can find it in?",
                        "Pardon me, do you know where the Asian food section is? I need to buy some soy sauce and noodles.",
                        "Hello, I'm sorry to bother you. I can't seem to find soy sauce anywhere. Can you help me?"
                    ]
                },
                {
                    question: "Scenario: You are at the post office (Post) and need to send a small package to China. Explain what you need to the clerk.",
                    starters: ["Hello, I'd like to send this package to...", "Good morning, I need to mail this to China.", "What is the best way to send this package?", "How much would it cost to send...?"],
                    wordBank: ["send a package", "to China", "tracking number", "how long will it take", "customs form (Zollinhaltserklärung)", "air mail (Luftpost)", "shipping cost"],
                    samples: [
                        "Hello, I would like to send this small package to Beijing, China. Could you tell me what the shipping options are?",
                        "Good morning. I need to mail this package. Does it include a tracking number, and about how long will it take to arrive in China?",
                        "Hi, I'd like to send this. Do I need to fill out one of those green customs forms? It's just a book and some sweets."
                    ]
                }
            ],
            "Social Interactions": [
                {
                    question: "Scenario: Your German roommate is having a party and it's a bit too loud for you to study. How do you politely ask them to turn the music down?",
                    starters: ["Hey, I know you're having fun, but...", "I'm sorry to interrupt the party, but...", "Would you mind turning the music down a little?", "I have a big exam tomorrow and..."],
                    wordBank: ["a little loud", "turn it down", "have an exam", "need to study", "I'd appreciate it", "no problem", "I'm sorry to ask"],
                    samples: [
                        "Hey, it sounds like you're having a great time! I'm sorry to be a killjoy, but I have a huge exam tomorrow and I'm having trouble concentrating. Would you mind turning the music down just a little bit?",
                        "Hi, sorry to interrupt. The party looks fun, but the music is a bit loud for me to study. I would really appreciate it if you could lower it a little.",
                        "I know it's your party, but I need to get up very early tomorrow. Would it be okay if you turned the volume down after 11 PM?"
                    ]
                },
                {
                    question: "Scenario: You meet your neighbor in the hallway. Make some simple small talk with them.",
                    starters: ["Hello, how are you today?", "This weather is..., isn't it?", "Are you having a good week?", "Do you have any plans for the weekend?"],
                    wordBank: ["neighbor (Nachbar)", "the weather (das Wetter)", "weekend (Wochenende)", "busy week", "nice to see you", "have a good day"],
                    samples: [
                        "Oh, hello! We haven't really met, I'm [Name] from apartment 2B. This rainy weather is crazy, isn't it?",
                        "Good morning! How are you? I hope you have a nice weekend. Do you have any special plans?",
                        "Hi there. It's been a busy week, I'm glad it's finally Friday. I'm just on my way to the supermarket. See you later!"
                    ]
                }
            ]
        };
        // ==========================================
        //  END OF QA14 DATA
        // ==========================================

        // --- DOM Elements ---
        const ui = {
            welcomeScreen: document.getElementById('welcome-screen'),
            practiceScreen: document.getElementById('practice-screen'),
            nameEntryContainer: document.getElementById('name-entry-container'),
            nameInput: document.getElementById('name-input'),
            startWithNameBtn: document.getElementById('start-with-name-btn'),
            topicSelectionContainer: document.getElementById('topic-selection-container'),
            userNameDisplay: document.getElementById('user-name-display'),
            topicSelection: document.getElementById('topic-selection'),
            nextBtn: document.getElementById('next-btn'),
            backToTopicsBtn: document.getElementById('back-to-topics-btn'),
            samplesBtn: document.getElementById('samples-btn'),
            timerDisplay: document.getElementById('timer-display'),
            timerProgress: document.getElementById('timer-progress'),
            phaseIndicator: document.getElementById('phase-indicator'),
            questionText: document.getElementById('question-text'),
            samplesContainer: document.getElementById('samples-container'),
            samplesList: document.getElementById('samples-list'),
            startersContainer: document.getElementById('starters-container'),
            startersList: document.getElementById('starters-list'),
            wordBankContainer: document.getElementById('word-bank-container'),
            wordBankList: document.getElementById('word-bank-list'),
            errorMessagebox: document.getElementById('error-message-box'),
            recordBtn: document.getElementById('record-btn'),
            stopRecordBtn: document.getElementById('stop-record-btn'),
            audioPlayer: document.getElementById('audio-player'),
            recordingStatus: document.getElementById('recording-status'),
            postRecordingActions: document.getElementById('post-recording-actions'),
            downloadBtn: document.getElementById('download-btn'),
            certificateScreen: document.getElementById('certificate-screen'),
            downloadCertificateBtn: document.getElementById('download-certificate-btn'),
            backToMainMenuBtn: document.getElementById('back-to-main-menu-btn'),
            modal: document.getElementById('confirmation-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
            pauseResumeBtn: document.getElementById('pause-resume-btn')
        };


        // --- State Variables ---
        let userName = '';
        let currentQuestionIndex = 0;
        let masterQuestionList = [];
        let currentQuestions = []; 
        let timerInterval;
        let isTimerPaused = false;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;
        let completedTopics = {};

        const FULL_DASH_ARRAY = 283;
        const DEFAULT_RESPONSE_TIME = 60; // Default time since it wasn't specified in new data

        // --- Text-to-Speech (Slowed down to 85%) ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;
        let ttsInitialized = false;

        function initializeTTS() {
            return new Promise((resolve) => {
                if (!synth) {
                    ttsInitialized = true;
                    return resolve();
                }

                const setBestVoice = () => {
                    const voices = synth.getVoices();
                    if (voices.length === 0) return;
                    
                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    const bestVoice = englishVoices.find(v => v.name.includes("Google") || v.name.includes("Microsoft") || v.name.includes("Natural"));
                    
                    preferredVoice = bestVoice || englishVoices[0] || voices[0];
                    ttsInitialized = true;
                    resolve();
                };

                if (synth.getVoices().length > 0) {
                    setBestVoice();
                } else {
                    synth.onvoiceschanged = setBestVoice;
                }
            });
        }

        function speak(text) {
            if (!ttsInitialized || !synth || !text) return;

            try {
                if (synth.speaking) synth.cancel();
                
                setTimeout(() => {
                    const utterThis = new SpeechSynthesisUtterance(text);
                    if (preferredVoice) utterThis.voice = preferredVoice;
                    utterThis.pitch = 1;
                    utterThis.rate = 0.85; // Slow down speech for secondary students
                    synth.speak(utterThis);
                }, 50); 
            } catch (e) {
                console.error("TTS Error:", e);
            }
        }

        // --- Local Storage (Updated for QA14) ---
        function loadProgress() {
            const savedCompletedTopics = localStorage.getItem('QA14_CompletedTopics');
            if (savedCompletedTopics) {
                try {
                    completedTopics = JSON.parse(savedCompletedTopics) || {};
                } catch (e) { completedTopics = {}; }
            }
            const savedName = localStorage.getItem('QA14_UserName');
            if (savedName) {
                 userName = savedName;
                 ui.nameInput.value = userName;
            }
        }

        function saveProgress() {
            localStorage.setItem('QA14_CompletedTopics', JSON.stringify(completedTopics));
            if(userName) localStorage.setItem('QA14_UserName', userName);
        }

        // --- UI Initialization & Data Setup ---
        function initializeTopics() {
            ui.topicSelection.innerHTML = '';
            for (const topic in practiceData) {
                const button = document.createElement('button');
                
                let checkmark = '';
                let bgClass = "bg-white dark:bg-gray-700 hover:bg-indigo-50 dark:hover:bg-indigo-900/40 border border-gray-200 dark:border-gray-600";
                
                if (completedTopics && completedTopics[topic]) {
                    checkmark = `<i class="fas fa-check-circle ml-auto text-emerald-500 text-xl"></i>`;
                    bgClass = "bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800";
                }

                button.className = `w-full text-left p-4 rounded-xl shadow-sm transition-all transform hover:scale-[1.02] flex items-center ${bgClass}`;
                button.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center mr-3 text-indigo-600 dark:text-indigo-400">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div>
                            <span class="block font-bold text-gray-800 dark:text-white">${topic}</span>
                        </div>
                    </div>
                    ${checkmark}
                `;
                
                button.dataset.topic = topic;
                button.addEventListener('click', () => startPractice(topic));
                ui.topicSelection.appendChild(button);
            }
        }
        
        function createMasterList() {
            masterQuestionList = [];
            for (const topic in practiceData) {
                practiceData[topic].forEach(question => {
                    masterQuestionList.push({ ...question, topicName: topic });
                });
            }
        }

        // --- Core App Logic ---
        function startPractice(topic) {
            const startIndex = masterQuestionList.findIndex(q => q.topicName === topic);
            currentQuestionIndex = (startIndex !== -1) ? startIndex : 0;
            currentQuestions = masterQuestionList;
            
            ui.welcomeScreen.classList.add('hidden');
            ui.practiceScreen.classList.remove('hidden');
            ui.certificateScreen.classList.add('hidden');
            ui.nextBtn.classList.remove('hidden');
            ui.samplesBtn.classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            // Track completion of previous topic
            if (currentQuestionIndex > 0) {
                const prevQuestion = currentQuestions[currentQuestionIndex - 1];
                const currentQuestion = currentQuestions[currentQuestionIndex];
                if (currentQuestion && prevQuestion.topicName !== currentQuestion.topicName) {
                    if (!completedTopics[prevQuestion.topicName]) {
                        completedTopics[prevQuestion.topicName] = true;
                        saveProgress();
                    }
                }
            }

            // End of all questions
            if (currentQuestionIndex >= currentQuestions.length) {
                if (currentQuestions.length > 0) {
                    const lastTopicName = currentQuestions[currentQuestions.length - 1].topicName;
                      if (!completedTopics[lastTopicName]) {
                        completedTopics[lastTopicName] = true;
                        saveProgress();
                    }
                }
                showCertificate();
                return;
            }

            ui.nextBtn.disabled = true;

            const item = currentQuestions[currentQuestionIndex];
            resetUIForNewQuestion();
            
            // Format question text
            let fullQuestion = (item.intro ? item.intro + " " : "") + item.question;
            ui.questionText.textContent = fullQuestion;
            ui.questionText.classList.add('fade-in');
            setTimeout(() => ui.questionText.classList.remove('fade-in'), 500);

            speak(fullQuestion);
            
            // Populate Starters
            if (item.starters && item.starters.length > 0) {
                ui.startersList.innerHTML = '';
                item.starters.forEach(starter => {
                    const span = document.createElement('span');
                    span.className = 'bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-1.5 rounded-lg dark:bg-indigo-900 dark:text-indigo-300 border border-indigo-200 dark:border-indigo-800';
                    span.textContent = starter;
                    ui.startersList.appendChild(span);
                });
                ui.startersContainer.classList.remove('hidden');
            }

            // Populate Word Bank
            if (item.wordBank && item.wordBank.length > 0) {
                ui.wordBankList.innerHTML = '';
                item.wordBank.forEach(word => {
                    const span = document.createElement('span');
                    span.className = 'bg-emerald-100 text-emerald-800 text-xs font-medium px-2.5 py-1.5 rounded-lg dark:bg-emerald-900 dark:text-emerald-300 border border-emerald-200 dark:border-emerald-800';
                    span.textContent = word;
                    ui.wordBankList.appendChild(span);
                });
                ui.wordBankContainer.classList.remove('hidden');
            }

            ui.phaseIndicator.textContent = `${item.topicName} • ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            
            const responseTime = item.timer || DEFAULT_RESPONSE_TIME;
            startTimer(responseTime, () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                }
                ui.recordBtn.disabled = true;
                ui.recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                ui.pauseResumeBtn.classList.add('hidden');
                ui.nextBtn.disabled = false;
                
                // Audio cue that time is up (optional)
                const ding = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'); // Placeholder
            });
        }
        
        function showCertificate() {
            ui.practiceScreen.classList.add('hidden');
            ui.welcomeScreen.classList.add('hidden');
            ui.certificateScreen.classList.remove('hidden');
            document.getElementById('certificate-name').textContent = userName;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
            speak(`Congratulations ${userName}. You have completed all the QA14 speaking topics!`);
        }
        
        function showErrorMessage(message) {
            ui.errorMessagebox.textContent = message;
            ui.errorMessagebox.classList.remove('hidden');
            setTimeout(() => {
                ui.errorMessagebox.classList.add('hidden');
            }, 5000);
        }

        // --- Recording & Transcription Logic ---
        async function startRecording() {
            if (!window.MediaRecorder) {
                showErrorMessage("Audio recording is not supported on this browser.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const isMobileEdge = /Edg\/\d+.*Android/.test(navigator.userAgent);
                let options = {};
                if (!isMobileEdge) {
                    const mimeTypes = ['audio/webm;codecs=opus', 'audio/ogg;codecs=opus', 'audio/webm', 'audio/ogg'];
                    const supportedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
                    if (supportedType) options.mimeType = supportedType;
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.start();

                ui.recordBtn.classList.add('hidden');
                ui.stopRecordBtn.classList.remove('hidden');
                ui.recordingStatus.classList.remove('hidden');

                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    recordedBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedBlob);
                    ui.audioPlayer.src = audioUrl;
                    ui.postRecordingActions.classList.remove('hidden');
                    ui.recordingStatus.classList.add('hidden');
                    ui.stopRecordBtn.classList.add('hidden');
                    ui.recordBtn.classList.add('hidden');
                    ui.nextBtn.disabled = false;
                });
            } catch (err) {
                console.error("Error starting recording:", err);
                showErrorMessage("Microphone access denied. Please check your browser settings.");
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
        }
        
        // --- Confirmation Modal ---
        function showConfirmationModal(title, message, onConfirm) {
            ui.modalTitle.textContent = title;
            ui.modalMessage.textContent = message;
            ui.modal.classList.remove('hidden');

            const confirmHandler = () => {
                onConfirm();
                hide();
            };

            const hide = () => {
                ui.modal.classList.add('hidden');
                ui.modalConfirmBtn.removeEventListener('click', confirmHandler);
                ui.modalCancelBtn.removeEventListener('click', hide);
            };

            ui.modalConfirmBtn.addEventListener('click', confirmHandler);
            ui.modalCancelBtn.addEventListener('click', hide);
        }


        // --- Timer Functions ---
        function startTimer(duration, onEndCallback) {
            let timeLeft = duration;
            clearInterval(timerInterval);
            updateTimerDisplay(timeLeft, duration);

            timerInterval = setInterval(() => {
                if (!isTimerPaused) {
                    timeLeft--;
                    updateTimerDisplay(timeLeft, duration);
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        if(onEndCallback) onEndCallback();
                    }
                }
            }, 1000);
        }

        function togglePauseTimer() {
            isTimerPaused = !isTimerPaused;
            if (isTimerPaused) {
                ui.pauseResumeBtn.innerHTML = '<i class="fas fa-play"></i>';
                ui.pauseResumeBtn.classList.add('text-green-600');
            } else {
                ui.pauseResumeBtn.innerHTML = '<i class="fas fa-pause"></i>';
                ui.pauseResumeBtn.classList.remove('text-green-600');
            }
        }

        function updateTimerDisplay(timeLeft, totalDuration) {
            const minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            if (seconds < 10) seconds = `0${seconds}`;
            ui.timerDisplay.textContent = `${minutes}:${seconds}`;
            
            const fraction = timeLeft / totalDuration;
            const offset = fraction * FULL_DASH_ARRAY;
            ui.timerProgress.style.strokeDashoffset = FULL_DASH_ARRAY - offset;
            
            // Change color based on time left
            if (timeLeft <= 10) {
                ui.timerProgress.classList.add('text-red-500');
                ui.timerProgress.classList.remove('text-indigo-500');
            } else {
                ui.timerProgress.classList.add('text-indigo-500');
                ui.timerProgress.classList.remove('text-red-500');
            }
        }

        // --- UI Helper Functions ---
        function resetUIForNewQuestion() {
            ui.samplesContainer.classList.add('hidden');
            ui.startersContainer.classList.add('hidden');
            ui.wordBankContainer.classList.add('hidden');
            ui.errorMessagebox.classList.add('hidden');
            ui.recordBtn.disabled = false;
            ui.recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            resetRecordingUI();
            
            isTimerPaused = false;
            ui.pauseResumeBtn.innerHTML = '<i class="fas fa-pause"></i>';
            ui.pauseResumeBtn.classList.remove('hidden', 'text-green-600');
            ui.timerProgress.classList.add('text-indigo-500');
        }

        function resetRecordingUI() {
            ui.recordBtn.classList.remove('hidden');
            ui.stopRecordBtn.classList.add('hidden');
            ui.recordingStatus.classList.add('hidden');
            ui.postRecordingActions.classList.add('hidden');
            ui.audioPlayer.src = '';
            audioChunks = [];
            recordedBlob = null;
        }

        // --- Event Listeners ---
        ui.startWithNameBtn.addEventListener('click', () => {
            userName = ui.nameInput.value.trim();
            if (userName) {
                saveProgress();
                ui.nameEntryContainer.classList.add('hidden');
                ui.userNameDisplay.textContent = userName;
                ui.topicSelectionContainer.classList.remove('hidden');
                initializeTopics();
            } else {
                ui.nameInput.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => ui.nameInput.classList.remove('ring-2', 'ring-red-500'), 1000);
            }
        });

        ui.recordBtn.addEventListener('click', startRecording);
        ui.stopRecordBtn.addEventListener('click', stopRecording);
        ui.pauseResumeBtn.addEventListener('click', togglePauseTimer);
        
        ui.downloadCertificateBtn.addEventListener('click', () => {
          const certificateNode = document.getElementById('certificate-to-download');
          // Simple detection for mobile devices where auto-download might be blocked
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          
          html2canvas(certificateNode, { scale: 2 }).then(canvas => {
            canvas.toBlob(blob => {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `Certificate_${userName.replace(/\s+/g, '_')}.png`;
              
              if (isMobile) {
                  // Open in new tab for mobile so they can long-press save
                  const newWindow = window.open(url, '_blank');
                  if (!newWindow) alert('Please allow popups to download the certificate.');
              } else {
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
              }
              setTimeout(() => URL.revokeObjectURL(url), 100);
            });
          });
        });

        ui.backToMainMenuBtn.addEventListener('click', () => {
            ui.certificateScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            ui.nameEntryContainer.classList.add('hidden');
            ui.topicSelectionContainer.classList.remove('hidden');
            initializeTopics();
        });

        ui.downloadBtn.addEventListener('click', () => {
            if (recordedBlob) {
                const topicName = currentQuestions[currentQuestionIndex].topicName.replace(/\s+/g, '_');
                const sanitizedUserName = userName.replace(/\s+/g, '_');
                const fileNameAudio = `${sanitizedUserName}_${topicName}_Q${currentQuestionIndex + 1}.mp3`; // Naming it MP3 for compatibility though it is webm
                const blobUrl = URL.createObjectURL(recordedBlob);
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                a.download = fileNameAudio;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Visual feedback
                const btnContent = ui.downloadBtn.innerHTML;
                ui.downloadBtn.innerHTML = `<i class="fas fa-check"></i> Saved`;
                ui.downloadBtn.classList.replace('bg-blue-600', 'bg-green-600');
                setTimeout(() => {
                    ui.downloadBtn.innerHTML = btnContent;
                    ui.downloadBtn.classList.replace('bg-green-600', 'bg-blue-600');
                    URL.revokeObjectURL(blobUrl);
                }, 2000);
            }
        });

        ui.nextBtn.addEventListener('click', () => {
            ui.nextBtn.disabled = true;
            currentQuestionIndex++;
            showQuestion();
        });

        ui.backToTopicsBtn.addEventListener('click', () => {
            showConfirmationModal(
                'Return to Topics?',
                'Progress on the current topic will be lost.',
                () => {
                    ui.practiceScreen.classList.add('hidden');
                    ui.welcomeScreen.classList.remove('hidden');
                    clearInterval(timerInterval);
                    if (synth && synth.speaking) synth.cancel();
                    if (mediaRecorder && mediaRecorder.state === 'recording') stopRecording();
                    initializeTopics();
                }
            );
        });

        ui.samplesBtn.addEventListener('click', () => {
            if (!ui.samplesContainer.classList.contains('hidden')) {
                ui.samplesContainer.classList.add('hidden');
                return;
            }

            const currentTopicName = masterQuestionList[currentQuestionIndex].topicName;
            const item = currentQuestions[currentQuestionIndex];

            ui.samplesList.innerHTML = ''; 
            if (item.samples && item.samples.length > 0) {
                item.samples.forEach(sample => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-quote-left text-amber-500 mr-2 text-xs"></i>${sample}`;
                    li.className = 'mb-2 pb-2 border-b border-gray-100 dark:border-gray-700 last:border-0 last:mb-0 last:pb-0';
                    ui.samplesList.appendChild(li);
                });
            } else {
                 ui.samplesList.innerHTML = '<li>No sample answers available for this question.</li>';
            }
            ui.samplesContainer.classList.remove('hidden');
        });
        
        // --- Initial Load ---
        async function main() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder) {
                ui.recordBtn.disabled = true;
                ui.recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            await initializeTTS().catch(err => console.error(err));
            
            createMasterList();
            loadProgress();
            initializeTopics();
        }
        
        main();
    });
    </script>
</body>
</html>
