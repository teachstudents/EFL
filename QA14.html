<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Joel's Speaking Practice 14</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            position: relative;
        }
        /* Snowfall effect */
        .snowflake {
            color: #fff;
            font-size: 1em;
            font-family: Arial, sans-serif;
            text-shadow: 0 0 5px #000;
            position: fixed;
            top: -10%;
            z-index: 0;
            user-select: none;
            animation: snowfall linear infinite;
        }

        @keyframes snowfall {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(105vh) rotate(360deg); opacity: 0; }
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        audio::-webkit-media-controls-panel {
            padding: 5px;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display {
            margin: 0 2px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Make sure app content is above the snow */
        #app-container {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center p-2 sm:p-4">
    
    <div id="snow-container"></div>

    <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 fixed top-4 right-4 z-50">
        <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
        <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707-.707a1 1 0 01-1.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707z"></path></svg>
    </button>

    <div id="app-container" class="w-full max-w-xl mx-auto text-center h-full">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center">
            <div id="name-entry-container">
                <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">Joel's Speaking Practice 13</h1>
                <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 text-center text-lg text-gray-900 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                <button id="start-with-name-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">Start</button>
            </div>
            <div id="topic-selection-container" class="hidden">
                 <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">Hello, <span id="user-name-display"></span>!</h1>
                 <div id="instructions" class="text-sm text-gray-600 dark:text-gray-400 mb-4 text-left space-y-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                     <p><i class="fas fa-bullhorn mr-2 text-indigo-500"></i>Try to speak until the time runs out. You can use the sentence starters and word bank for help.</p>
                     <p><i class="fas fa-download mr-2 text-blue-500"></i>After recording, download your answer and upload it. If the upload doesn't work, save the downloaded files.</p>
                     <p><i class="fas fa-award mr-2 text-yellow-500"></i>You must complete all 9 topics to get the Certificate of Completion as proof you finished the homework.</p>
                 </div>
                <div id="topic-selection" class="grid grid-cols-3 gap-4">
                    <!-- Topic buttons will be injected here -->
                </div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden bg-white dark:bg-gray-800 rounded-2xl shadow-lg app-shell p-3 sm:p-4">
            <header class="flex-shrink-0">
                <div class="flex justify-between items-center mb-1">
                    <button id="back-to-topics-btn" class="text-indigo-500 hover:text-indigo-700"><i class="fas fa-arrow-left mr-2"></i>Topics</button>
                </div>
                <!-- Timer Display -->
                <div class="relative w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-2 flex-shrink-0">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200 dark:text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="timer-progress" class="timer-circle text-indigo-500" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-2xl font-bold"></div>
                </div>
                <p id="phase-indicator" class="font-semibold text-indigo-500 dark:text-indigo-400 mb-2 text-base flex-shrink-0"></p>

                <!-- Question Display -->
                <div id="question-container" class="min-h-[50px] flex items-center justify-center mb-2">
                    <h2 id="question-text" class="text-base sm:text-lg font-semibold leading-relaxed text-left w-full"></h2>
                </div>
                
                <div id="error-message-box" class="hidden text-red-500 bg-red-100 dark:bg-red-900/50 p-2 rounded-lg text-sm mb-2"></div>

                <!-- Recording Action Buttons -->
                <div id="recording-actions-container" class="flex flex-col items-center justify-center mb-2">
                    <!-- Initial Record Button -->
                    <button id="record-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md transition-transform transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <!-- Stop Button -->
                    <button id="stop-record-btn" class="hidden bg-gray-700 hover:bg-gray-800 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md flex items-center justify-center">
                        <i class="fas fa-stop"></i>
                    </button>
                    <!-- Post-Recording Controls -->
                    <div id="post-recording-actions" class="hidden w-full flex-col items-center justify-center space-y-2 mt-2">
                        <audio id="audio-player" controls class="w-full max-w-xs"></audio>
                        <div class="flex items-center justify-center space-x-2 w-full max-w-xs">
                             <button id="download-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md transition-colors">
                                 <i class="fas fa-download mr-1"></i>Download
                             </button>
                            <a href="https://xichengacademy-my.sharepoint.com/:f:/g/personal/joelmitchell_xichengacademy_cn/EjxMFg8-baNEo5uuWUBc4EoBzn1DVWJ1Ym_NFx6hPlJ0dQ" target="_blank" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md">
                                 <i class="fas fa-upload mr-1"></i>Upload
                             </a>
                        </div>
                    </div>
                </div>
                 <div id="recording-status" class="hidden items-center justify-center text-red-500 font-semibold mb-1">
                     <div class="w-2 h-2 bg-red-500 rounded-full mr-2 recording-indicator"></div>
                     Recording...
                 </div>
            </header>
            
            <main class="flex-grow flex flex-col overflow-y-auto min-h-0 space-y-2 pt-2">
                 <!-- Sentence Starters -->
                <div id="starters-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Sentence Starters</h3>
                    <div id="starters-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Word Bank -->
                <div id="word-bank-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Word Bank</h3>
                    <div id="word-bank-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Sample Answers Display -->
                <div id="samples-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center flex-shrink-0">Sample Responses</h3>
                    <ul id="samples-list" class="space-y-2 list-disc list-inside bg-indigo-900/70 dark:bg-indigo-900/90 p-3 rounded-lg max-h-28 sm:max-h-32 overflow-y-auto">
                    </ul>
                </div>
            </main>

            <footer class="flex-shrink-0 mt-2">
                <!-- Next Button -->
                <div id="controls-container">
                     <button id="next-btn" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg text-lg shadow-md">Next</button>
                </div>
            </footer>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center">
            <div id="certificate-to-download" class="w-full bg-gray-50 dark:bg-gray-700 p-8 rounded-lg border-4 border-yellow-400 dark:border-yellow-500 text-center">
                <i class="fas fa-award text-6xl text-yellow-500 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Certificate of Completion</h1>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">This certificate is awarded to</p>
                <p id="certificate-name" class="text-4xl font-bold my-4 text-indigo-600 dark:text-indigo-400"></p>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">for successfully completing all 9 speaking practice topics.</p>
                <p class="text-sm mt-6 text-gray-500 dark:text-gray-400">Issued on: <span id="certificate-date"></span></p>
            </div>
            <button id="download-certificate-btn" class="mt-6 w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">
                <i class="fas fa-download mr-2"></i>Download Certificate
            </button>
             <button id="back-to-main-menu-btn" class="mt-3 text-sm text-indigo-500 hover:underline">Back to Main Menu</button>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA: Questions and Sample Answers for Part 13 ---
        const practiceData = {
            "Appointments": [
                {
                    question: "Scenario: You need to make an appointment with a doctor. Call the doctor's office and explain that you have a bad cold and would like to be seen.",
                    starters: ["Hello, my name is... I'd like to make an appointment.", "Good morning, I would like to see a doctor.", "I'm calling because I'm not feeling well.", "Do you have any available appointments today or tomorrow?"],
                    wordBank: ["make an appointment (Termin)", "a bad cold (Erkältung)", "sore throat", "fever", "available", "health insurance card (Krankenversichertenkarte)"],
                    samples: [
                        "Hello, my name is [Name]. I would like to make an appointment to see a doctor. I have a bad cold and a fever, and I've been feeling sick for two days.",
                        "Good morning. I'm calling to schedule an appointment. I have a sore throat and a cough. Do you have any availability this afternoon?",
                        "Hello, I am a new patient. I would like to see a doctor because I am feeling unwell. I have my health insurance card. When is the doctor's next free appointment?"
                    ]
                },
                {
                    question: "Scenario: You are at a German bank to open a student bank account (Girokonto). What questions would you ask the bank employee?",
                    starters: ["Hello, I'm a new student and I'd like to open an account.", "I have a few questions about the student account.", "Is this account free for students?", "How long does it take to receive the card?"],
                    wordBank: ["student account (Girokonto)", "monthly fees (monatliche Gebühren)", "online banking", "EC card (Girocard)", "documents needed", "passport", "registration (Anmeldung)"],
                    samples: [
                        "Hello, I would like to open a student account. Could you please tell me if there are any monthly fees for students?",
                        "I'd like to ask about online banking. Is it easy to set up, and can I use it to transfer money back to my family in China?",
                        "Thank you for the information. What documents do I need to bring with me to open the account? I have my passport and my university enrollment letter."
                    ]
                }
            ],
            "University Life": [
                {
                    question: "Scenario: You didn't understand an important concept in a university lecture. How would you ask the professor for clarification after class?",
                    starters: ["Excuse me, Professor...", "I'm sorry to bother you, I have a quick question about the lecture.", "I didn't quite understand the part about...", "Could you possibly explain... in another way?"],
                    wordBank: ["clarification", "didn't understand", "a bit confused", "could you explain", "the concept of", "the difference between", "office hours (Sprechstunde)"],
                    samples: [
                        "Excuse me, Professor Schmidt. I found the lecture very interesting, but I was a bit confused about the concept of opportunity cost. Could you explain it one more time?",
                        "I have a quick question about the presentation. I didn't quite understand the difference between the two theories you mentioned. Is there a simple example?",
                        "Thank you for the lecture. I'm still having some trouble with the formula you showed. Would it be okay to come to your office hours this week to discuss it?"
                    ]
                },
                {
                    question: "Scenario: You see a notice for a university film club that you want to join. Approach the students at the table and ask how to become a member.",
                    starters: ["Hi there, I saw your sign for the film club.", "Excuse me, could you tell me a little bit about this club?", "This looks really interesting. How can I sign up?", "What kind of activities do you do?"],
                    wordBank: ["film club", "sign up", "become a member", "meeting times", "membership fee", "movie screenings", "discussion", "interested in joining"],
                    samples: [
                        "Hi, I saw your flyer and I'm very interested in joining the film club. Could you tell me how to sign up?",
                        "This looks like fun. What kind of movies do you usually watch? And when are the regular meeting times?",
                        "Hello, I am a new student here and I love movies. Is there a membership fee to join the club, and what kind of events do you organize?"
                    ]
                }
            ],
            "Shopping & Errands": [
                {
                    question: "Scenario: You are at a German supermarket and cannot find soy sauce. Ask a store employee where you can find it.",
                    starters: ["Excuse me, can you help me please?", "I'm sorry to bother you, I'm looking for...", "Could you please tell me where the... is?", "I can't seem to find..."],
                    wordBank: ["soy sauce (Sojasauce)", "in which aisle", "the Asian food section", "I'm looking for", "where can I find", "thank you for your help"],
                    samples: [
                        "Excuse me, I'm looking for soy sauce. Could you please tell me which aisle I can find it in?",
                        "Pardon me, do you know where the Asian food section is? I need to buy some soy sauce and noodles.",
                        "Hello, I'm sorry to bother you. I can't seem to find soy sauce anywhere. Can you help me?"
                    ]
                },
                {
                    question: "Scenario: You are at the post office (Post) and need to send a small package to China. Explain what you need to the clerk.",
                    starters: ["Hello, I'd like to send this package to...", "Good morning, I need to mail this to China.", "What is the best way to send this package?", "How much would it cost to send...?"],
                    wordBank: ["send a package", "to China", "tracking number", "how long will it take", "customs form (Zollinhaltserklärung)", "air mail (Luftpost)", "shipping cost"],
                    samples: [
                        "Hello, I would like to send this small package to Beijing, China. Could you tell me what the shipping options are?",
                        "Good morning. I need to mail this package. Does it include a tracking number, and about how long will it take to arrive in China?",
                        "Hi, I'd like to send this. Do I need to fill out one of those green customs forms? It's just a book and some sweets."
                    ]
                }
            ],
            "Social Interactions": [
                {
                    question: "Scenario: Your German roommate is having a party and it's a bit too loud for you to study. How do you politely ask them to turn the music down?",
                    starters: ["Hey, I know you're having fun, but...", "I'm sorry to interrupt the party, but...", "Would you mind turning the music down a little?", "I have a big exam tomorrow and..."],
                    wordBank: ["a little loud", "turn it down", "have an exam", "need to study", "I'd appreciate it", "no problem", "I'm sorry to ask"],
                    samples: [
                        "Hey, it sounds like you're having a great time! I'm sorry to be a killjoy, but I have a huge exam tomorrow and I'm having trouble concentrating. Would you mind turning the music down just a little bit?",
                        "Hi, sorry to interrupt. The party looks fun, but the music is a bit loud for me to study. I would really appreciate it if you could lower it a little.",
                        "I know it's your party, but I need to get up very early tomorrow. Would it be okay if you turned the volume down after 11 PM?"
                    ]
                },
                {
                    question: "Scenario: You meet your neighbor in the hallway. Make some simple small talk with them.",
                    starters: ["Hello, how are you today?", "This weather is..., isn't it?", "Are you having a good week?", "Do you have any plans for the weekend?"],
                    wordBank: ["neighbor (Nachbar)", "the weather (das Wetter)", "weekend (Wochenende)", "busy week", "nice to see you", "have a good day"],
                    samples: [
                        "Oh, hello! We haven't really met, I'm [Name] from apartment 2B. This rainy weather is crazy, isn't it?",
                        "Good morning! How are you? I hope you have a nice weekend. Do you have any special plans?",
                        "Hi there. It's been a busy week, I'm glad it's finally Friday. I'm just on my way to the supermarket. See you later!"
                    ]
                }
            ],
            "Transportation": [
                {
                    question: "Scenario: You are on a train and a ticket inspector (Kontrolleur) asks for your ticket. You realize you bought a ticket for the wrong zone. Explain the situation.",
                    starters: ["Oh, I am so sorry, I think I made a mistake.", "I'm new here and I'm still confused by the ticket system.", "I believe I bought the wrong ticket by accident.", "Can I please buy the correct ticket from you?"],
                    wordBank: ["my apologies", "an honest mistake", "wrong zone (falsche Zone)", "confusing", "new in Germany", "buy a new ticket", "didn't realize"],
                    samples: [
                        "I am so sorry, I think I made a mistake. I am a new student here and the zone system is still very confusing to me. I believe I accidentally bought a ticket for Zone A instead of Zone B.",
                        "My apologies, I didn't realize this ticket was not valid for this train. It was an honest mistake. Is it possible for me to buy the correct ticket from you now?",
                        "Oh no, I see this is the wrong ticket. I am very sorry. I just arrived in Germany a week ago and I'm still learning how public transport works."
                    ]
                },
                {
                    question: "Scenario: You are at a train station (Bahnhof) and the announcement is only in German. Ask a stranger what the announcement said.",
                    starters: ["Excuse me, I'm sorry to bother you.", "My German is not very good yet.", "Could you please tell me what that announcement was about?", "Did they say the train is delayed?"],
                    wordBank: ["announcement (Durchsage)", "delayed (verspätet)", "platform change (Gleiswechsel)", "canceled (fällt aus)", "I didn't understand", "could you please help me?"],
                    samples: [
                        "Excuse me, I'm sorry to bother you, but my German is not very good. Could you please tell me what that announcement said about the train to Munich?",
                        "Pardon me, I didn't understand the announcement. Did they say the train is delayed or is there a platform change?",
                        "Hello, could you please help me? I'm not sure what the announcement meant. Is the train to Frankfurt still leaving from platform 5?"
                    ]
                }
            ],
             "Cultural Exchange": [
                {
                    question: "Scenario: A German classmate says something about China that is not correct (a stereotype). How would you politely correct them?",
                    starters: ["That's an interesting point. Actually, in my experience...", "I understand why you might think that, but...", "That's a common stereotype, but in reality...", "Can I share a different perspective with you?"],
                    wordBank: ["stereotype", "actually", "in fact", "it depends on the region", "modern China is...", "it's more complex than that", "my experience is different"],
                    samples: [
                        "I can see why you might think that all Chinese food is the same, but actually, the food is very different in every province. For example, Sichuan food is very spicy, but Shanghai food is sweeter.",
                        "That's a common stereotype, but in reality, not everyone in China is good at math! Just like any country, people have different strengths and weaknesses.",
                        "I understand why you might think that. However, modern cities like Shanghai and Shenzhen are extremely high-tech, maybe even more so than some cities in Europe."
                    ]
                },
                {
                    question: "Scenario: A new German friend asks you to explain the Mid-Autumn Festival. Briefly describe it to them.",
                    starters: ["The Mid-Autumn Festival is one of the most important holidays in China.", "It's a time for family reunion, similar to...", "The main tradition is to...", "We eat a special food called..."],
                    wordBank: ["Mid-Autumn Festival (Mondfest)", "family reunion", "full moon", "togetherness", "mooncakes (Mondkuchen)", "lanterns", "gratitude", "harvest"],
                    samples: [
                        "The Mid-Autumn Festival is a bit like Thanksgiving in America. It's a time for families to get together for a big dinner and appreciate the full moon.",
                        "The main tradition is to eat mooncakes, which are round pastries with different fillings. Their round shape symbolizes family togetherness and completeness.",
                        "It's a beautiful festival. Besides eating, we also look at the full moon, which is supposed to be the brightest of the year, and children sometimes carry colorful lanterns."
                    ]
                }
            ],
            "Housing Issues": [
                {
                    question: "Scenario: The heating (Heizung) in your student dorm room is broken and it is very cold. Explain the problem to the building manager (Hausmeister).",
                    starters: ["Hello, I'm calling from room...", "I'm having a problem with the heating in my room.", "The radiator doesn't seem to be working.", "My room is very cold, could you please..."],
                    wordBank: ["heating (Heizung)", "radiator (Heizkörper)", "is broken", "not working", "very cold", "could you please take a look?", "as soon as possible", "building manager (Hausmeister)"],
                    samples: [
                        "Hello, my name is [Name] from room 402. I'm calling because the heating in my room is not working, and it has been very cold for the last two days.",
                        "Good morning. I'm having a problem with the radiator in my apartment. It's not getting warm, even when I turn it all the way up. Could you please come and take a look when you have a chance?",
                        "Hi, I live in room 315. The heating is broken. Is it possible for you to send someone to fix it today? It is very cold, and I cannot study properly."
                    ]
                },
                {
                    question: "Scenario: Your roommate in a shared apartment (WG) often leaves their dirty dishes in the sink. How would you politely ask them to be tidier?",
                    starters: ["Hey, can we talk for a minute?", "I wanted to talk about something small regarding the kitchen.", "Would you mind trying to...?", "It would really help me if we could..."],
                    wordBank: ["shared space (WG)", "dirty dishes", "in the sink", "keep the kitchen clean", "cleaning schedule", "teamwork", "would you mind", "it bothers me a little"],
                    samples: [
                        "Hey, do you have a second? I wanted to talk about the kitchen. I've noticed that dishes are often left in the sink for a long time, and it makes it hard to cook. Would you mind trying to wash them soon after you use them?",
                        "Hi, can we chat about the kitchen? It would really help me out if we could both agree to keep the sink clear of dirty dishes. Maybe we can make a rule to wash them within 24 hours?",
                        "I feel a bit awkward bringing this up, but the dirty dishes in the sink bother me. Since we share this space, could we try to keep it a bit tidier together?"
                    ]
                }
            ],
            "Part-Time Job": [
                {
                    question: "Scenario: You see a 'Help Wanted' (Aushilfe gesucht) sign in a local cafe. Go inside and ask the manager if the position is still available.",
                    starters: ["Hello, I saw the sign in your window.", "Excuse me, are you still looking for help?", "I'm interested in the part-time position.", "Could you tell me more about the job?"],
                    wordBank: ["Help Wanted (Aushilfe gesucht)", "part-time job", "still available", "student", "looking for work", "flexible hours", "experience", "CV (Lebenslauf)"],
                    samples: [
                        "Hello, I saw your 'Aushilfe gesucht' sign in the window. I am a student and I am looking for a part-time job. Is the position still available?",
                        "Excuse me, I noticed you are looking for help. I have some experience working in a cafe in my hometown and I would be very interested. Who should I speak to about the job?",
                        "Good afternoon. I'm interested in the part-time position you have advertised. I have my CV with me. Could you tell me what the working hours would be like?"
                    ]
                },
                {
                    question: "Scenario: In a job interview for a student job, the interviewer asks, 'Why should we hire you?'. What would you say?",
                    starters: ["I believe you should hire me because I am...", "I am a very... person.", "Although I don't have much experience, I am...", "My skills in... would be very useful for this job."],
                    wordBank: ["hard-working", "quick learner", "reliable", "friendly", "good with customers", "organized", "motivated", "team player", "eager to learn"],
                    samples: [
                        "I believe you should hire me because I am a very quick learner and I am highly motivated. I am confident I can learn all the tasks for this job very fast.",
                        "Although I don't have a lot of professional experience, I am a very hard-working and reliable person. You can count on me to be on time and to do my job well.",
                        "I am very friendly and I enjoy talking to people, so I think my communication skills would be very useful for a customer service role like this one."
                    ]
                }
            ],
            "Social Plans": [
                {
                    question: "Scenario: You have two invitations for the same night: one from a new German friend and one from your old friends from China. Explain your decision.",
                    starters: ["That's a very difficult situation.", "I would have to choose between... and...", "I think I would probably choose to go with... because...", "It would be a tough choice, but my priority would be..."],
                    wordBank: ["difficult choice", "old friends", "new friend", "integration", "feeling homesick", "make a good impression", "explain the situation", "reschedule"],
                    samples: [
                        "That's a tough choice. I think I would explain the situation to both friends and try to reschedule with one of them. For example, I could meet my new German friend for coffee the next day.",
                        "I would probably choose to go with my new German friend, because making local connections and practicing my German is one of my main goals for being here.",
                        "It would be a very difficult decision, but I might choose to spend the evening with my old friends from China, especially if I was feeling a bit homesick and needed the comfort of the familiar."
                    ]
                },
                {
                    question: "Scenario: A German friend invites you to go hiking on a day when the weather forecast is very bad. Politely express your concern and suggest an alternative plan.",
                    starters: ["Thank you for the invitation! I'm a bit concerned about...", "I'd love to go hiking, but have you seen the weather forecast?", "Maybe we could... instead?", "How about we go hiking next weekend when the weather is better?"],
                    wordBank: ["weather forecast (Wettervorhersage)", "heavy rain", "thunderstorm", "might be dangerous", "alternative plan", "go to a museum", "watch a movie", "play board games"],
                    samples: [
                        "Thanks for the invitation to go hiking! I just checked the weather forecast and it looks like there will be heavy rain. I'm a bit concerned it might not be safe. Could we maybe go to the cinema instead?",
                        "I would love to go hiking with you, but I saw there's a warning for thunderstorms tomorrow. How about we play some board games at my place and we can go hiking next weekend when the weather is sunny?",
                        "That's a great idea, but the forecast says it will be very cold and windy. Perhaps we could visit that new art museum we talked about, and save the hike for a nicer day?"
                    ]
                }
            ]
        };


        // --- DOM Elements ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const welcomeScreen = document.getElementById('welcome-screen');
        const practiceScreen = document.getElementById('practice-screen');
        const nameEntryContainer = document.getElementById('name-entry-container');
        const nameInput = document.getElementById('name-input');
        const startWithNameBtn = document.getElementById('start-with-name-btn');
        const topicSelectionContainer = document.getElementById('topic-selection-container');
        const userNameDisplay = document.getElementById('user-name-display');
        const topicSelection = document.getElementById('topic-selection');
        const nextBtn = document.getElementById('next-btn');
        const backToTopicsBtn = document.getElementById('back-to-topics-btn');
        
        const timerDisplay = document.getElementById('timer-display');
        const timerProgress = document.getElementById('timer-progress');
        const phaseIndicator = document.getElementById('phase-indicator');
        
        const questionContainer = document.getElementById('question-container');
        const questionText = document.getElementById('question-text');
        const samplesContainer = document.getElementById('samples-container');
        const samplesList = document.getElementById('samples-list');
        const startersContainer = document.getElementById('starters-container');
        const startersList = document.getElementById('starters-list');
        const wordBankContainer = document.getElementById('word-bank-container');
        const wordBankList = document.getElementById('word-bank-list');
        const errorMessagebox = document.getElementById('error-message-box');

        const recordBtn = document.getElementById('record-btn');
        const stopRecordBtn = document.getElementById('stop-record-btn');
        const audioPlayer = document.getElementById('audio-player');
        const recordingStatus = document.getElementById('recording-status');
        const postRecordingActions = document.getElementById('post-recording-actions');
        const downloadBtn = document.getElementById('download-btn');
        
        // Certificate UI
        const certificateScreen = document.getElementById('certificate-screen');
        const downloadCertificateBtn = document.getElementById('download-certificate-btn');
        const backToMainMenuBtn = document.getElementById('back-to-main-menu-btn');


        // --- State Variables ---
        let userName = '';
        let currentQuestionIndex = 0;
        let currentQuestions = [];
        let timerInterval;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;
        let completedTopics = {};
        let speechRecognition;
        let finalTranscript = '';

        const FULL_DASH_ARRAY = 283;
        const DEFAULT_RESPONSE_TIME = 60;
        const READ_TIME = 60;

        // --- Text-to-Speech ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;
        let ttsInitialized = false;

        function initializeTTS() {
            return new Promise((resolve) => {
                if (!synth) {
                    ttsInitialized = true;
                    return resolve();
                }

                const setBestVoice = () => {
                    const voices = synth.getVoices();
                    if (voices.length === 0) return;
                    
                    const scoreVoice = (voice) => {
                        let score = 0;
                        const name = voice.name.toLowerCase();
                        if (name.includes('natural')) score += 5;
                        if (name.includes('brian') || name.includes('emma')) score += 4;
                        if (name.includes('microsoft')) score += 3;
                        if (name.includes('google')) score += 2;
                        if (voice.localService) score += 1;
                        return score;
                    };

                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    if (englishVoices.length > 0) {
                        englishVoices.sort((a, b) => scoreVoice(b) - scoreVoice(a));
                        preferredVoice = englishVoices[0];
                    }
                    
                    ttsInitialized = true;
                    resolve();
                };

                if (synth.getVoices().length > 0) {
                    setBestVoice();
                } else {
                    synth.onvoiceschanged = setBestVoice;
                }
            });
        }

        function speak(text, isFeedback = false) {
            if (!ttsInitialized) return;
            try {
                if (synth.speaking) synth.cancel();
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.onerror = (event) => console.error('SpeechSynthesisUtterance.onerror', event);
                if (preferredVoice) utterThis.voice = preferredVoice;
                utterThis.pitch = 1;  
                utterThis.rate = 0.85; // Slow down speech as requested
                synth.speak(utterThis);
            } catch (e) {
                console.error("Speech synthesis failed:", e);
            }
        }

        // --- Local Storage ---
        function loadProgress() {
            const savedCompletedTopics = localStorage.getItem('languagePracticeCompletedTopics');
            if (savedCompletedTopics) {
                try {
                    const parsed = JSON.parse(savedCompletedTopics);
                    // Basic validation to ensure it's an object
                    if (typeof parsed === 'object' && parsed !== null) {
                       completedTopics = parsed;
                    } else {
                        completedTopics = {};
                    }
                } catch (e) {
                    console.error("Failed to parse saved progress:", e);
                    completedTopics = {}; // Reset progress if data is corrupt
                }
            }
            const savedName = localStorage.getItem('languagePracticeUserName');
            if (savedName) {
                 userName = savedName;
                 nameInput.value = userName;
            }
        }

        function saveProgress() {
            localStorage.setItem('languagePracticeCompletedTopics', JSON.stringify(completedTopics));
            if(userName) localStorage.setItem('languagePracticeUserName', userName);
        }

        // --- UI Initialization ---
        function initializeTopics() {
            topicSelection.innerHTML = '';
            for (const topic in practiceData) {
                const button = document.createElement('button');
                
                let checkmark = '';
                if (completedTopics && completedTopics[topic]) {
                    checkmark = `<i class="fas fa-check-circle text-green-500 ml-2"></i>`;
                    button.className = "w-full bg-green-100 dark:bg-green-900/50 p-2 rounded-lg shadow-md hover:bg-green-200 dark:hover:bg-green-800/60 transition-colors flex items-center justify-center";
                } else {
                    button.className = "w-full bg-white dark:bg-gray-700 p-2 rounded-lg shadow-md hover:bg-indigo-100 dark:hover:bg-indigo-800 transition-all transform hover:scale-105 flex items-center justify-center";
                }

                button.innerHTML = `<span class="text-sm font-semibold">${topic}</span> ${checkmark}`;
                button.dataset.topic = topic;
                button.addEventListener('click', () => startPractice(topic));
                topicSelection.appendChild(button);
            }
        }

        // --- Core App Logic ---
        function startPractice(topic) {
            currentQuestions = practiceData[topic];
            currentQuestions.topicName = topic;
            currentQuestionIndex = 0;
            welcomeScreen.classList.add('hidden');
            practiceScreen.classList.remove('hidden');
            certificateScreen.classList.add('hidden');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                phaseIndicator.textContent = "Topic Complete!";
                questionText.textContent = "You've finished this topic. Well done!";
                completedTopics[currentQuestions.topicName] = true;
                saveProgress();
                checkAllTopicsCompleted();
                resetRecordingUI();
                nextBtn.classList.add('hidden');
                speak("You've completed this topic! Well done.");
                return;
            }

            const item = currentQuestions[currentQuestionIndex];
            resetUIForNewQuestion();
            
            let fullQuestion = (item.intro ? item.intro + " " : "") + item.question;
            questionText.textContent = fullQuestion;
            questionText.classList.add('fade-in');
            setTimeout(() => questionText.classList.remove('fade-in'), 500);

            speak(fullQuestion);
            
            // Populate Sentence Starters
            if (item.starters && item.starters.length > 0) {
                startersList.innerHTML = '';
                item.starters.forEach(starter => {
                    const button = document.createElement('button');
                    button.className = 'bg-indigo-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-indigo-600 dark:text-white cursor-default';
                    button.textContent = starter;
                    startersList.appendChild(button);
                });
                startersContainer.classList.remove('hidden');
            }

            // Populate Word Bank
            if (item.wordBank && item.wordBank.length > 0) {
                wordBankList.innerHTML = '';
                item.wordBank.forEach(word => {
                    const button = document.createElement('button');
                    button.className = 'bg-green-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-green-600 dark:text-white cursor-default';
                    button.textContent = word;
                    wordBankList.appendChild(button);
                });
                wordBankContainer.classList.remove('hidden');
            }

            const responseTime = item.timer || DEFAULT_RESPONSE_TIME;
            phaseIndicator.textContent = `Prepare & Record (Question ${currentQuestionIndex + 1} of ${currentQuestions.length})`;
            startTimer(responseTime, showSampleAnswersAndStartReadTimer);
        }

        function showSampleAnswersAndStartReadTimer() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
            
            phaseIndicator.textContent = "Review";
            recordBtn.disabled = true;
            recordBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const item = currentQuestions[currentQuestionIndex];
            if (item.samples && item.samples.length > 0) {
                samplesList.innerHTML = '';
                item.samples.forEach(sample => {
                    const li = document.createElement('li');
                    li.textContent = sample;
                    // Changed to white text as requested
                    li.className = 'text-white text-sm sm:text-base';
                    samplesList.appendChild(li);
                });
                samplesContainer.classList.remove('hidden');
            }


            startTimer(READ_TIME, () => {
                phaseIndicator.textContent = "Time's up!";
                nextBtn.classList.remove('hidden');
            });
        }
        
        // --- Certificate Logic ---
        function checkAllTopicsCompleted() {
            const totalTopics = Object.keys(practiceData).length;
            const completedCount = Object.keys(completedTopics).length;
            if (completedCount === totalTopics) {
                showCertificate();
            }
        }
        
        function showCertificate() {
            practiceScreen.classList.add('hidden');
            welcomeScreen.classList.add('hidden');
            certificateScreen.classList.remove('hidden');
            document.getElementById('certificate-name').textContent = userName;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
        }
        
        function showErrorMessage(message) {
            errorMessagebox.textContent = message;
            errorMessagebox.classList.remove('hidden');
            setTimeout(() => {
                errorMessagebox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        // --- Recording & Transcription Logic ---
        async function startRecording() {
            if (!window.MediaRecorder) {
                showErrorMessage("Audio recording is not supported on this browser.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const isEdge = window.navigator.userAgent.includes("Edg");
                let options = {};
                if (!isEdge) {
                    const mimeTypes = ['audio/webm;codecs=opus', 'audio/ogg;codecs=opus', 'audio/webm', 'audio/ogg'];
                    const supportedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
                    if (supportedType) options.mimeType = supportedType;
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.start();
                startTranscription();

                recordBtn.classList.add('hidden');
                stopRecordBtn.classList.remove('hidden');
                recordingStatus.classList.remove('hidden');

                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    recordedBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedBlob);
                    audioPlayer.src = audioUrl;
                    postRecordingActions.classList.remove('hidden');
                    recordingStatus.classList.add('hidden');
                    stopRecordBtn.classList.add('hidden');
                    recordBtn.classList.add('hidden');
                });
            } catch (err) {
                console.error("Error starting recording:", err);
                showErrorMessage("Could not start audio recording. Please grant microphone permission.");
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
            if (speechRecognition) {
                speechRecognition.stop();
            }
        }

        function startTranscription() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("Speech recognition not supported.");
                return;
            }

            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';
            finalTranscript = '';

            speechRecognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
            };
            
            speechRecognition.onerror = (event) => {
                 console.error('Speech recognition error detected: ' + event.error);
            }

            speechRecognition.start();
        }

        // --- Timer Functions ---
        function startTimer(duration, onEndCallback) {
            let timeLeft = duration;
            clearInterval(timerInterval);
            updateTimerDisplay(timeLeft, duration);

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft, duration);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if(onEndCallback) onEndCallback();
                }
            }, 1000);
        }

        function updateTimerDisplay(timeLeft, totalDuration) {
            const minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            if (seconds < 10) seconds = `0${seconds}`;
            timerDisplay.textContent = `${minutes}:${seconds}`;
            
            const fraction = timeLeft / totalDuration;
            const offset = fraction * FULL_DASH_ARRAY;
            timerProgress.style.strokeDashoffset = FULL_DASH_ARRAY - offset;
        }

        // --- UI Helper Functions ---
        function resetUIForNewQuestion() {
            samplesContainer.classList.add('hidden');
            startersContainer.classList.add('hidden');
            wordBankContainer.classList.add('hidden');
            nextBtn.classList.add('hidden');
            errorMessagebox.classList.add('hidden');
            recordBtn.disabled = false;
            recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            resetRecordingUI();
        }

        function resetRecordingUI() {
            recordBtn.classList.remove('hidden');
            stopRecordBtn.classList.add('hidden');
            recordingStatus.classList.add('hidden');
            postRecordingActions.classList.add('hidden');
            audioPlayer.src = '';
            audioChunks = [];
            recordedBlob = null;
            finalTranscript = '';
        }

        // --- Theme Toggle Logic ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        };
        
        // --- Snowfall Logic ---
        function createSnow() {
            const snowContainer = document.getElementById('snow-container');
            const snowflakeCount = 50;
            for (let i = 0; i < snowflakeCount; i++) {
                let snowflake = document.createElement('div');
                snowflake.innerHTML = '❄';
                snowflake.classList.add('snowflake');
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.animationDuration = Math.random() * 5 + 5 + 's'; // 5-10 seconds
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                snowflake.style.fontSize = Math.random() * 1.5 + 0.5 + 'em';
                snowflake.style.opacity = Math.random();
                snowContainer.appendChild(snowflake);
            }
        }


        // --- Event Listeners ---
        startWithNameBtn.addEventListener('click', () => {
            userName = nameInput.value.trim();
            if (userName) {
                saveProgress();
                nameEntryContainer.classList.add('hidden');
                userNameDisplay.textContent = userName;
                topicSelectionContainer.classList.remove('hidden');
            } else {
                // Using a custom message box instead of alert()
                const nameError = document.createElement('div');
                nameError.textContent = "Please enter your name.";
                nameError.className = "text-red-500 text-sm mt-2";
                startWithNameBtn.insertAdjacentElement('afterend', nameError);
                setTimeout(() => nameError.remove(), 2000);
            }
        });

        recordBtn.addEventListener('click', startRecording);
        stopRecordBtn.addEventListener('click', stopRecording);
        
        downloadCertificateBtn.addEventListener('click', () => {
            const certificateNode = document.getElementById('certificate-to-download');
            html2canvas(certificateNode, { scale: 2 }).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = `Certificate_of_Completion_${userName.replace(/\s+/g, '_')}.png`;
                a.click();
            });
        });

        backToMainMenuBtn.addEventListener('click', () => {
            certificateScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            initializeTopics();
        });

        downloadBtn.addEventListener('click', () => {
            if (recordedBlob) {
                const topicName = currentQuestions.topicName.replace(/\s+/g, '_');
                const sanitizedUserName = userName.replace(/\s+/g, '_');
                const fileName = `${sanitizedUserName}_${topicName}_Q${currentQuestionIndex + 1}.webm`;
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = URL.createObjectURL(recordedBlob);
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // Visual feedback
                const originalText = downloadBtn.innerHTML;
                downloadBtn.innerHTML = `<i class="fas fa-check mr-1"></i>Downloaded!`;
                downloadBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                downloadBtn.classList.add('bg-green-600');
                setTimeout(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.classList.remove('bg-green-600');
                    downloadBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
            }
        });

        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            showQuestion();
        });

        backToTopicsBtn.addEventListener('click', () => {
            practiceScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            clearInterval(timerInterval);
            initializeTopics();
        });
        
        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
            applyTheme(isDark ? 'dark' : 'light');
        });

        // --- Initial Load ---
        async function main() {
            // Set initial theme
            const savedTheme = localStorage.getItem('color-theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                // If no theme saved, use system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    applyTheme('dark');
                } else {
                    applyTheme('light');
                }
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !SpeechRecognition) {
                recordBtn.disabled = true;
                recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                recordBtn.title = "Audio recording or recognition is not supported on this browser.";
            }
            if (!window.speechSynthesis) {
                 console.warn("Text-to-speech is not supported on this browser.");
            }
            
            await initializeTTS().catch(err => console.error(err));
            
            createSnow();
            loadProgress();
            initializeTopics();
        }
        
        main();
    });
    </script>
</body>
</html>
