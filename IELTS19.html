<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classroom Speaking Master - 2026 Topics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* Base Styles */
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      overflow: hidden;
      color: #2d3748;
    }

    /* Container */
    .app-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      position: relative;
    }

    /* Cards/Screens */
    .screen-card {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 24px;
      padding: 1.5rem;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 1200px;
      height: 95vh;
      display: none; /* Hidden by default */
      flex-direction: column;
      animation: slideIn 0.4s ease-out;
      position: relative;
    }

    .screen-card.active {
      display: flex;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Setup Screen */
    .student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 0.8rem;
      overflow-y: auto;
      padding-right: 0.5rem;
      max-height: 50vh;
    }

    .student-card {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .student-card:hover { border-color: #667eea; transform: translateY(-2px); }
    .student-card.selected { background: #ebf8ff; border-color: #4299e1; }
    
    .student-avatar {
      width: 32px;
      height: 32px;
      background: #edf2f7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #4a5568;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    /* Speaking Screen Layout */
    .question-layout {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 1rem;
    }

    /* Big Question Box at Top */
    .question-box {
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      color: white;
      padding: 1rem;
      border-radius: 20px;
      font-family: 'Fredoka', sans-serif;
      text-align: center;
      box-shadow: 0 8px 20px rgba(66, 153, 225, 0.4);
      position: relative;
      min-height: 15%; 
      flex-grow: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .question-text-display {
      font-size: 1.6rem; 
      line-height: 1.2;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 0.5rem;
      padding: 0 3rem;
    }

    /* Help Section (Word Bank) */
    .help-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr; 
      gap: 1rem;
      flex-grow: 1;
      min-height: 0;
    }

    .help-panel {
      background: #fff;
      border: 2px solid #edf2f7;
      border-radius: 16px;
      padding: 0.8rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
    }

    .help-header {
      font-family: 'Fredoka', sans-serif;
      color: #4a5568;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: bold;
      flex-shrink: 0;
    }

    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      overflow-y: auto;
      align-content: flex-start;
      padding-bottom: 0.5rem;
    }

    /* Headers inside the tag container */
    .toolkit-category {
        width: 100%;
        font-size: 0.8rem;
        color: #718096;
        font-weight: 800;
        text-transform: uppercase;
        margin-top: 0.8rem;
        margin-bottom: 0.4rem;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.2rem;
        letter-spacing: 0.05em;
    }
    .toolkit-category:first-child { margin-top: 0; }
    
    .toolkit-category.compact {
        margin-top: 0.5rem;
        margin-bottom: 0.2rem;
        color: #63b3ed;
    }

    /* Separator for mixed panels */
    .panel-separator {
        width: 100%;
        height: 2px;
        background-color: #e2e8f0;
        margin: 0.5rem 0;
        flex-shrink: 0;
    }

    .tag {
      background: #f7fafc;
      padding: 0.35rem 0.7rem;
      border-radius: 8px;
      border: 1px solid #cbd5e0;
      font-size: 0.85rem;
      color: #2d3748;
      font-weight: 600;
      box-shadow: 0 2px 0 rgba(0,0,0,0.05);
      cursor: pointer;
    }
    .tag:active { transform: scale(0.95); }
    
    .tag.special {
        background: #ebf8ff;
        border-color: #bee3f8;
        color: #2b6cb0;
    }
    
    .tag.idiom {
        background: #f0fff4;
        border-color: #9ae6b4;
        color: #276749;
        font-weight: 800;
        width: 100%;
        text-align: center;
    }

    /* Timer & Progress */
    .timer-float {
      position: absolute;
      top: 50%;
      right: 1rem;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(4px);
      color: white;
      padding: 0.2rem 1.2rem;
      border-radius: 50px;
      font-weight: 800;
      font-size: 1.5rem; 
      border: 2px solid rgba(255,255,255,0.4);
    }

    .part-indicator {
        position: absolute;
        top: 0.5rem;
        left: 1rem;
        font-size: 0.8rem;
        font-weight: 800;
        text-transform: uppercase;
        color: rgba(255,255,255,0.7);
        letter-spacing: 0.1em;
    }

    .speaker-indicator {
        position: absolute;
        bottom: 0.5rem;
        left: 1rem;
        font-size: 0.9rem;
        font-weight: 700;
        color: white;
        background: rgba(0,0,0,0.1);
        padding: 0.1rem 0.6rem;
        border-radius: 8px;
    }

    .rec-indicator {
        position: absolute;
        top: 0.5rem;
        right: 1rem;
        font-size: 0.7rem;
        font-weight: 700;
        color: #fff;
        background: #e53e3e;
        padding: 0.1rem 0.6rem;
        border-radius: 20px;
        animation: pulse-red 1.5s infinite;
        display: none;
    }
    @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    .progress-track {
      width: 100%;
      height: 12px;
      background: #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
      margin-top: auto;
      flex-shrink: 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #48bb78, #38a169);
      width: 100%;
      transition: width 1s linear;
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: bold;
      font-size: 1.2rem;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 15px rgba(0,0,0,0.2); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background: #cbd5e0; }

    /* Selection Screen */
    .roulette-wrapper {
      background: #2d3748;
      color: white;
      border-radius: 30px;
      padding: 4rem 2rem;
      text-align: center;
      margin: 2rem 0;
      border: 8px solid #4a5568;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
    }
    .roulette-name { font-size: 4.5rem; font-family: 'Fredoka', sans-serif; text-shadow: 0 4px 0 #000; }

    /* Countdown */
    .giant-countdown {
      font-size: 12rem;
      font-weight: 900;
      color: #4299e1;
      text-align: center;
      animation: pulse 1s infinite;
      font-family: 'Fredoka', sans-serif;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    /* Preview Screen Layout */
    .preview-grid {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 1.5rem;
    }
    .preview-card {
      flex: 1;
      background: #ebf8ff;
      border-left: 8px solid #4299e1;
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* Transition Overlay */
    #transition-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 50;
        border-radius: 24px;
    }
  </style>
 </head>
 <body>

 <div class="app-container">

  <!-- 1. SETUP SCREEN -->
  <div id="screen-setup" class="screen-card active">
    <h1 class="text-4xl font-extrabold text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-6 font-fredoka">IELTS Speaking Master + Recorder</h1>
    
    <div class="grid grid-cols-2 gap-6 mb-6">
      <div class="flex flex-col">
        <label class="font-bold text-gray-600 mb-2 text-lg">üìÖ Practice Date</label>
        <input type="date" id="date-picker" class="p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none text-xl font-bold text-gray-700">
      </div>
      <div class="flex flex-col">
        <label class="font-bold text-gray-600 mb-2 text-lg">üìö Select Topic (New 2026 Added)</label>
        <select id="theme-select" class="p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none bg-white text-xl font-bold text-gray-700">
          <!-- Populated by JS -->
        </select>
      </div>
    </div>

    <div class="flex-grow flex flex-col min-h-0">
      <div class="flex justify-between items-end mb-2">
        <h2 class="text-2xl font-bold text-gray-700">üéì Attendance</h2>
        <button onclick="selectAllStudents()" class="text-blue-600 font-bold hover:bg-blue-50 px-3 py-1 rounded">Select All</button>
      </div>
      <div id="student-grid" class="student-grid">
        <!-- Populated by JS -->
      </div>
    </div>

    <button id="btn-start" class="btn-primary mt-6" disabled>üöÄ Start Session & Enable Mic</button>
  </div>

  <!-- 2. PREVIEW SCREEN -->
  <div id="screen-preview" class="screen-card">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-3xl font-extrabold text-gray-800">Topic Preview</h2>
      <div class="bg-red-100 text-red-600 font-black px-6 py-2 rounded-xl text-3xl shadow-sm border border-red-200" id="preview-timer">60</div>
    </div>
    
    <div id="preview-content" class="preview-grid">
      <!-- Populated by JS to fill screen -->
    </div>
  </div>

  <!-- 3. SELECTION SCREEN -->
  <div id="screen-selection" class="screen-card" style="max-width: 900px; justify-content: center;">
    <h2 class="text-4xl font-extrabold text-gray-700 text-center mb-6">üé≤ Who is speaking next?</h2>
    <div class="roulette-wrapper">
      <div id="roulette-display" class="roulette-name">...</div>
    </div>
  </div>

  <!-- 4. COUNTDOWN SCREEN -->
  <div id="screen-countdown" class="screen-card" style="justify-content: center;">
    <h2 class="text-4xl font-bold text-gray-600 text-center mb-10">Get Ready!</h2>
    <div id="countdown-display" class="giant-countdown">5</div>
    <div id="next-speaker-name" class="text-4xl mt-12 font-bold text-blue-600 text-center"></div>
  </div>

  <!-- 5. SPEAKING SCREEN (MAIN) -->
  <div id="screen-speaking" class="screen-card">
    <!-- Overlay for Fast Transition -->
    <div id="transition-overlay">
        <div class="text-6xl mb-4">üéâ</div>
        <h1 class="text-5xl font-black text-blue-600 mb-2">Great Job!</h1>
        <p class="text-2xl text-gray-500 font-bold">Saving Audio...</p>
    </div>

    <div class="question-layout">
      
      <!-- Top: Big Question -->
      <div class="question-box">
        <!-- Integrated Info Indicators -->
        <div id="part-indicator" class="part-indicator">Part 1</div>
        <div id="speaker-indicator" class="speaker-indicator">Student</div>
        <div id="rec-indicator" class="rec-indicator">‚óè REC</div>

        <div id="question-timer" class="timer-float">30</div>
        <div id="question-text" class="question-text-display">
          Question text goes here...
        </div>
      </div>

      <!-- Bottom: Help & Progress -->
      <div class="help-grid">
        
        <!-- LEFT: Stalling -> Starting -> Clarifying -->
        <div class="help-panel bg-purple-50 border-purple-100">
          <div class="help-header text-purple-600">
            <span>üöÄ</span> Stalling, Start & Clarify
          </div>
          <div id="toolkit-left" class="tag-container">
            <!-- Stalling / Starting / Clarifying Phrases -->
          </div>
        </div>

        <!-- MIDDLE: Opinion -> Starters -> Connecting -->
        <div class="help-panel">
          <div class="help-header text-blue-600">
            <span>üí°</span> Opinion & Ideas
          </div>
          <div id="toolkit-middle-top" class="tag-container"></div> <!-- Opinion -->
          <div class="panel-separator"></div>
          <div id="stems-container" class="tag-container"></div> <!-- Starters -->
          <div class="panel-separator"></div>
          <div id="toolkit-middle-bottom" class="tag-container"></div> <!-- Connecting -->
        </div>

        <!-- RIGHT: Vocab + Concluding -->
        <div class="help-panel">
          <div class="help-header text-green-600">
            <span>üìö</span> Vocab & Concluding
          </div>
          <div id="words-container" class="tag-container"></div>
          <div class="panel-separator"></div>
          <div id="toolkit-right" class="tag-container">
             <!-- Concluding -->
          </div>
        </div>

      </div>

      <div class="progress-track">
        <div id="progress-bar" class="progress-fill"></div>
      </div>
      
    </div>
  </div>

 </div>

 <script>
/** * CONFIGURATION & DATA */
// REPLACED OLD TOOLKIT WITH STRUCTURED CATEGORIES
const IELTS_TOOLKIT = [
  {
    category: "Stalling",
    target: "left",
    phrases: [
      "That's not something I've thought about before.",
      "Wow, that's a tough question.",
      "I need a couple of seconds to think...",
      "I'm not quite sure what to say here...",
      "Let me see... how should I put this..."
    ]
  },
  {
    category: "Starting",
    target: "left",
    phrases: [
      "Well, let me begin by saying...",
      "To start off, I'd like to mention...",
      "First and foremost, I believe that...",
      "Actually, that's an interesting point..."
    ]
  },
  {
    category: "Clarifying",
    target: "left",
    phrases: [
      "I am not sure what you mean...",
      "Could you be more specific?",
      "Could you repeat the question, please?",
      "I'm sorry, I didn't catch that.",
      "Do you mean that...?"
    ]
  },
  {
    category: "Opinion",
    target: "middle-top",
    phrases: [
      "In my opinion...",
      "If you ask me...",
      "I firmly believe that...",
      "From my perspective...",
      "As I see it...",
      "I'm convinced that..."
    ]
  },
  {
    category: "Connecting",
    target: "middle-bottom",
    phrases: [
      "Building on that...",
      "Another aspect to consider is...",
      "I almost forgot to say that...",
      "From a broader perspective...",
      "Furthermore...",
      "On top of that..."
    ]
  },
  {
    category: "Concluding",
    target: "right",
    phrases: [
      "In conclusion...",
      "To sum up...",
      "Finally, I'd say that...",
      "So, that's my main point."
    ]
  }
];

const STUDENTS = [
  { english: "Iris", chinese: "Êü¥ÂçìÁë∂" },
  { english: "Max", chinese: "Êùé‰πãÁî®" },
  { english: "Cathy", chinese: "Êûó‰∫ëÊõ¶" },
  { english: "Sandy", chinese: "ÂàòÁèÇÂê´" },
  { english: "Vicky", chinese: "È™ÜÊ¢¶‰πî" },
  { english: "Jim", chinese: "ÂÆãÊòäËΩ©" },
  { english: "Jackie", chinese: "ÂêëÂÆ∂ÊÖï" },
  { english: "Jay", chinese: "ÂæêÂòâÁÅè" },
  { english: "Grace", chinese: "Êù®È¶•ÂÆÅ" },
  { english: "Emily", chinese: "Âº†‰∏éÂçì" },
  { english: "Rhea", chinese: "ËµµÂçÉÊ¢¶" },
  { english: "Student A", chinese: "" },
  { english: "Student B", chinese: "" },
  { english: "Student C", chinese: "" },
  { english: "Student D", chinese: "" }
];

const TIMING = { part1: 30, part2: 90, part3: 45 };

// Merged Themes (Old + New PDF Content + Expanded Vocab)
const THEMES = [
  // --- NEW PDF TOPICS (2026) ---
  {
    name: "2026: Shoes & Habits",
    idiom: "Walk a mile in someone's shoes",
    part1: "Do you prefer comfortable shoes or good-looking shoes? How often do you buy them?",
    part1_stems: ["I tend to value durability over...", "I occasionally make an impulse buy...", "Finding the right fit is...", "I rarely purchase...", "I value comfort more than..."],
    part1_words: ["durability", "aesthetics", "ergonomic", "blisters", "trendy", "retailer", "arch support", "impulse buy", "cushioning", "synthetic", "leather", "high heels", "soles"],
    
    part2: "Describe a pair of shoes you really like. What are they? Where did you buy them? Why do you like them?",
    part2_stems: ["I want to talk about...", "I bought them at a specialized retailer...", "They are incredibly...", "I prefer them because..."],
    part2_words: ["sneakers", "formal wear", "long-lasting", "stylish", "comfortable", "brand-name", "quality", "breathable", "waterproof", "versatile"],
    
    part3: "Why do some students care so much about wearing expensive shoe brands?",
    part3_stems: ["It's often about status...", "Peer pressure plays a role...", "They believe price equals quality...", "Consequently..."],
    part3_words: ["status symbol", "materialism", "peer pressure", "consumer habits", "affordability", "trends", "overpriced", "logo", "advertising"]
  },
  {
    name: "2026: Plants & Gardening",
    idiom: "Green thumb (Good at gardening)",
    part1: "Do you keep plants at home? Did you grow any when you were young?",
    part1_stems: ["Back when I was younger, I used to...", "Nowadays I focus more on...", "I find it therapeutic to...", "I don't have a green thumb but..."],
    part1_words: ["cultivate", "botanical", "air purification", "succulents", "maintenance", "therapeutic", "blossom", "sapling", "potted plant", "watering", "sunlight"],
    
    part2: "Describe a plant that is important in your country (or one you grew). What is it? Why is it important?",
    part2_stems: ["A plant that is culturally significant is...", "I once attempted to grow...", "It requires a lot of...", "It symbolizes..."],
    part2_words: ["native species", "symbolism", "agriculture", "environment", "blooming", "fragrance", "nature", "leaves", "roots", "growth"],
    
    part3: "Why is it important to have green spaces and plants in cities?",
    part3_stems: ["Ideally, cities should have...", "Plants help to...", "From an environmental perspective...", "It improves mental health by..."],
    part3_words: ["urban jungle", "pollution", "relaxation", "ecosystem", "sustainable", "concrete jungle", "well-being", "oxygen", "photosynthesis", "shade"]
  },
  {
    name: "2026: Public Places",
    idiom: "Hustle and bustle (Busy activity)",
    part1: "Do you like visiting crowded places? Do you talk to strangers in public?",
    part1_stems: ["If I am in a bustling place...", "I usually wear headphones to...", "I prefer to create a sanctuary...", "I avoid the hustle and bustle by..."],
    part1_words: ["bustling", "sanctuary", "etiquette", "invade privacy", "isolation", "communal spaces", "claustrophobic", "strangers", "crowded", "noise"],
    
    part2: "Describe a public place you enjoy visiting to study or relax. Where is it? What do you do there?",
    part2_stems: ["My go-to spot is...", "It offers a sense of...", "I usually go there to...", "The atmosphere is..."],
    part2_words: ["library", "public park", "atmosphere", "quietude", "concentration", "scenery", "public facility", "amenities", "accessible", "benches"],
    
    part3: "Is it rude to wear headphones when you are with friends in public?",
    part3_stems: ["It depends on...", "Generally speaking, it signals...", "If you are engaging with others...", "Social etiquette suggests..."],
    part3_words: ["social norms", "disrespectful", "engagement", "communication", "interaction", "body language", "polite", "antisocial", "distracted", "rude"]
  },
  {
    name: "2026: Borrowing & Lending",
    idiom: "Neither a borrower nor a lender be",
    part1: "How do you feel when people don't return things they borrowed?",
    part1_stems: ["I generally feel annoyed when...", "Lending possessions can be awkward...", "I keep track of my things to...", "I might lend it if..."],
    part1_words: ["possessions", "trustworthy", "friction", "awkward", "generosity", "sentimental value", "reliability", "permission", "damaged", "replacement"],
    
    part2: "Describe a time you borrowed something useful from someone. What was it? Why did you need it?",
    part2_stems: ["I vividly remember borrowing...", "I was in a pinch because...", "They were kind enough to...", "It saved me from..."],
    part2_words: ["essential", "emergency", "grateful", "assistance", "return", "condition", "helpful", "favor", "owe", "repay"],
    
    part3: "Is it better to borrow money from friends or from a bank?",
    part3_stems: ["Borrowing from friends can cause friction...", "A bank has a clear return policy...", "It risks the friendship if...", "Financially speaking..."],
    part3_words: ["interest rate", "relationship", "debt", "formal agreement", "risk", "financial literacy", "loan", "contract", "obligation"]
  },
  {
    name: "2026: Achievements",
    idiom: "Pass with flying colors",
    part1: "Do you often praise your friends when they do something well?",
    part1_stems: ["I always try to compliment...", "It gives them a sense of...", "I believe positive feedback is...", "I told my friend that..."],
    part1_words: ["accomplishment", "recognition", "excel at", "proficiency", "compliment", "feedback", "validation", "supportive", "encourage", "celebrate"],
    
    part2: "Describe an experience where you did something well (e.g. at school). What was it? How did you feel?",
    part2_stems: ["I remember a time when I mastered...", "I managed to excel at...", "It gave me a real sense of accomplishment...", "The teacher said that..."],
    part2_words: ["achievement", "hard work", "dedication", "success", "proud", "effort", "outcome", "milestone", "triumph", "goal"],
    
    part3: "Does praise help students learn better than criticism?",
    part3_stems: ["Positive reinforcement is...", "Criticism can be discouraging...", "Validation boosts confidence...", "On the other hand, constructive criticism..."],
    part3_words: ["motivation", "self-esteem", "encouragement", "constructive", "improvement", "psychology", "confidence", "inspiration", "growth"]
  },
  // --- ORIGINAL TOPICS ---
  {
    name: "Hobbies & Free Time",
    idiom: "Recharge one's batteries",
    part1: "What do you usually do on weekends to relax?",
    part1_stems: ["I tend to...", "My go-to activity is...", "I'm really into...", "Whenever I have a spare moment..."],
    part1_words: ["unwind", "leisure", "passion", "recharge", "escapism", "downtime", "therapeutic", "pastime", "interest", "amateur"],
    part2: "Describe a hobby you really enjoy. What is it? When did you start? Why do you like it?",
    part2_stems: ["One hobby I'm passionate about is...", "I took it up when...", "It appeals to me because...", "What draws me to this is..."],
    part2_words: ["creative outlet", "therapeutic", "challenging", "sense of achievement", "stimulating", "productivity", "collecting", "skill", "talent", "fun"],
    part3: "Why is it important for students to have hobbies outside of school?",
    part3_stems: ["Crucially...", "It fosters...", "Aside from academics...", "Striking a balance is key because..."],
    part3_words: ["well-rounded", "mental well-being", "social skills", "balance", "burnout", "academic pressure", "relief", "development", "variety"]
  },
  {
    name: "School Life",
    idiom: "Hit the books",
    part1: "Which subject do you find most interesting at school?",
    part1_stems: ["Without a doubt...", "I find ... fascinating because...", "I'm drawn to...", "I have a knack for..."],
    part1_words: ["engaging", "curriculum", "concepts", "practical", "theory", "intellectually stimulating", "assignment", "lecture", "campus", "grades"],
    part2: "Describe your favorite teacher. Who are they? What do they teach? Why do you like them?",
    part2_stems: ["The teacher who stands out is...", "Their teaching style is...", "I admire them for...", "They have a unique way of..."],
    part2_words: ["inspirational", "approachable", "knowledgeable", "engaging", "mentor", "role model", "supportive", "patience", "guidance", "strict"],
    part3: "Do you think homework is useful for students?",
    part3_stems: ["To some extent...", "Conversely...", "It reinforces...", "It's a contentious issue but..."],
    part3_words: ["consolidation", "burden", "independent learning", "discipline", "time management", "workload", "stress", "practice", "review"]
  },
  {
    name: "Technology",
    idiom: "Glued to the screen",
    part1: "Which app do you use the most on your phone?",
    part1_stems: ["I'm constantly on...", "I find myself scrolling...", "It's essential for...", "I'm glued to..."],
    part1_words: ["interface", "connect", "content", "algorithm", "addictive", "user-friendly", "digital footprint", "notification", "platform", "software"],
    part2: "Describe a website or app that helps you learn. What is it? How do you use it? Why is it helpful?",
    part2_stems: ["An invaluable tool for me is...", "It features...", "It enhances my learning by...", "I rely on it for..."],
    part2_words: ["resource", "interactive", "comprehensive", "accessible", "tutorial", "visual aid", "database", "wireless", "device", "online"],
    part3: "Do teenagers spend too much time on their phones?",
    part3_stems: ["It's a double-edged sword...", "Excessive screen time...", "The fear of missing out drives...", "It distracts us from..."],
    part3_words: ["detrimental", "virtual interaction", "sedentary", "moderation", "cyberbullying", "attention span", "social media", "gaming", "distraction"]
  }
];

let state = {
  date: new Date().toISOString().split('T')[0],
  selectedThemeIndex: 0,
  selectedStudents: new Set(),
  remainingStudents: [],
  currentStudent: null,
  step: 'setup', 
  currentPart: 1,
  timerInterval: null,
  mediaRecorder: null,
  audioChunks: [],
  stream: null
};

/* --- AUDIO EFFECTS --- */
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

function playTone(freq, type, duration) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}

function playClickSound() { playTone(800, 'square', 0.05); }
function playTickSound() { playTone(1200, 'sine', 0.05); }
function playWinSound() { 
  [400, 500, 600, 800].forEach((f, i) => setTimeout(() => playTone(f, 'triangle', 0.3), i * 100));
}

/* --- TTS --- */
function speakText(text) {
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  
  const voices = window.speechSynthesis.getVoices();
  const targetVoice = voices.find(v => v.name.includes('Andrew') || v.name.includes('Brian') || v.name.includes('Emma'));
  const backupVoice = voices.find(v => v.name.includes('Microsoft') && v.lang.includes('en'));
  
  if (targetVoice) utterance.voice = targetVoice;
  else if (backupVoice) utterance.voice = backupVoice;
  
  utterance.rate = 0.85; // Slow down
  window.speechSynthesis.speak(utterance);
}

window.speechSynthesis.onvoiceschanged = () => { console.log("Voices loaded"); };


/* --- DOM & LOGIC --- */
const screens = {
  setup: document.getElementById('screen-setup'),
  preview: document.getElementById('screen-preview'),
  selection: document.getElementById('screen-selection'),
  countdown: document.getElementById('screen-countdown'),
  speaking: document.getElementById('screen-speaking')
};

function init() {
  document.getElementById('date-picker').value = state.date;
  const themeSelect = document.getElementById('theme-select');
  THEMES.forEach((theme, index) => {
    const opt = document.createElement('option');
    opt.value = index;
    opt.textContent = theme.name;
    themeSelect.appendChild(opt);
  });
  renderStudentGrid();
  document.getElementById('theme-select').addEventListener('change', (e) => state.selectedThemeIndex = parseInt(e.target.value));
  document.getElementById('date-picker').addEventListener('change', (e) => state.date = e.target.value);
  document.getElementById('btn-start').addEventListener('click', startPreview);
}

function renderStudentGrid() {
  const grid = document.getElementById('student-grid');
  grid.innerHTML = '';
  STUDENTS.forEach((student, index) => {
    const el = document.createElement('div');
    el.className = `student-card ${state.selectedStudents.has(index) ? 'selected' : ''}`;
    el.onclick = () => toggleStudent(index);
    el.innerHTML = `
      <div class="student-avatar">${student.english.substring(0,2)}</div>
      <div>
        <div class="font-bold text-gray-700">${student.english}</div>
        <div class="text-xs text-gray-400">${student.chinese}</div>
      </div>
    `;
    grid.appendChild(el);
  });
  document.getElementById('btn-start').disabled = state.selectedStudents.size === 0;
}

function toggleStudent(index) {
  if (state.selectedStudents.has(index)) state.selectedStudents.delete(index);
  else state.selectedStudents.add(index);
  renderStudentGrid();
}

function selectAllStudents() {
  state.selectedStudents = new Set(STUDENTS.map((_, i) => i));
  renderStudentGrid();
}

function switchScreen(screenName) {
  Object.values(screens).forEach(s => s.classList.remove('active'));
  screens[screenName].classList.add('active');
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// 1. PREVIEW
async function startPreview() {
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  try {
    state.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    // Keep mic ready
  } catch (err) {
    alert("Microphone access is required for recording! Please allow access and try again.");
    return;
  }

  const theme = THEMES[state.selectedThemeIndex];
  const container = document.getElementById('preview-content');
  
  container.innerHTML = `
    <div class="preview-card bg-blue-50 border-l-8 border-blue-500">
      <h3 class="text-2xl font-black text-blue-700 uppercase tracking-widest mb-2">Part 1 (${TIMING.part1}s)</h3>
      <p class="text-3xl font-bold text-gray-800 leading-tight">${theme.part1}</p>
    </div>
    <div class="preview-card bg-green-50 border-l-8 border-green-500">
      <h3 class="text-2xl font-black text-green-700 uppercase tracking-widest mb-2">Part 2 (${TIMING.part2}s)</h3>
      <p class="text-3xl font-bold text-gray-800 leading-tight">${theme.part2}</p>
    </div>
    <div class="preview-card bg-purple-50 border-l-8 border-purple-500">
      <h3 class="text-2xl font-black text-purple-700 uppercase tracking-widest mb-2">Part 3 (${TIMING.part3}s)</h3>
      <p class="text-3xl font-bold text-gray-800 leading-tight">${theme.part3}</p>
    </div>
  `;

  let selectedIndices = Array.from(state.selectedStudents);
  selectedIndices = shuffleArray(selectedIndices);
  state.remainingStudents = selectedIndices.map(i => STUDENTS[i]);

  switchScreen('preview');
  
  let timeLeft = 60;
  const timerDisplay = document.getElementById('preview-timer');
  const interval = setInterval(() => {
    timeLeft--;
    timerDisplay.textContent = timeLeft;
    if (timeLeft <= 10) playTickSound();
    if(timeLeft <= 0) {
      clearInterval(interval);
      startSelection();
    }
  }, 1000);
}

// 2. SELECTION
function startSelection() {
  if(state.remainingStudents.length === 0) {
    alert("All students have finished!");
    location.reload();
    return;
  }
  
  document.getElementById('transition-overlay').style.display = 'none';

  switchScreen('selection');
  const display = document.getElementById('roulette-display');
  let counter = 0;
  let speed = 50;
  
  const spin = () => {
    const randomName = STUDENTS[Math.floor(Math.random() * STUDENTS.length)].english;
    display.textContent = randomName;
    playClickSound();
    
    counter++;
    if(counter < 30) {
      setTimeout(spin, speed);
      speed += 5;
    } else {
      state.currentStudent = state.remainingStudents[0];
      display.textContent = state.currentStudent.english;
      display.style.color = '#48bb78';
      playWinSound();
      
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
      });

      setTimeout(startCountdown, 2000);
    }
  };
  spin();
}

// 3. COUNTDOWN
function startCountdown() {
  switchScreen('countdown');
  document.getElementById('next-speaker-name').textContent = `${state.currentStudent.english} (${state.currentStudent.chinese})`;
  let timeLeft = 3;
  const display = document.getElementById('countdown-display');
  display.textContent = timeLeft;
  
  const interval = setInterval(() => {
    timeLeft--;
    display.textContent = timeLeft;
    playTickSound();
    if(timeLeft <= 0) {
      clearInterval(interval);
      startSpeakingSession();
    }
  }, 1000);
}

// 4. SPEAKING SESSION
function startSpeakingSession() {
  switchScreen('speaking');
  document.getElementById('speaker-indicator').textContent = state.currentStudent.english;
  
  // Start Recording
  if (state.stream) {
    state.audioChunks = [];
    state.mediaRecorder = new MediaRecorder(state.stream);
    state.mediaRecorder.ondataavailable = e => state.audioChunks.push(e.data);
    state.mediaRecorder.start();
    document.getElementById('rec-indicator').style.display = 'block';
  }

  runPart(1);
}

function runPart(partNumber) {
  state.currentPart = partNumber;
  const theme = THEMES[state.selectedThemeIndex];
  const qText = document.getElementById('question-text');
  const pBar = document.getElementById('progress-bar');
  const partIndicator = document.getElementById('part-indicator');
  
  let question, duration, stems, words;
  if(partNumber === 1) {
    question = theme.part1; duration = TIMING.part1; stems = theme.part1_stems; words = theme.part1_words;
  } else if(partNumber === 2) {
    question = theme.part2; duration = TIMING.part2; stems = theme.part2_stems; words = theme.part2_words;
  } else {
    question = theme.part3; duration = TIMING.part3; stems = theme.part3_stems; words = theme.part3_words;
  }

  partIndicator.textContent = `Part ${partNumber}`;
  qText.textContent = question;
  pBar.style.width = '100%';
  pBar.style.transition = 'none';
  
  // CLEAR ALL CONTAINERS FIRST
  document.getElementById('toolkit-left').innerHTML = '';
  document.getElementById('toolkit-middle-top').innerHTML = '';
  document.getElementById('toolkit-middle-bottom').innerHTML = '';
  document.getElementById('toolkit-right').innerHTML = '';

  // Render Distributed Toolkit with Rotation
  IELTS_TOOLKIT.forEach(cat => {
      let containerId;
      if (cat.target === 'left') containerId = 'toolkit-left';
      else if (cat.target === 'middle-top') containerId = 'toolkit-middle-top';
      else if (cat.target === 'middle-bottom') containerId = 'toolkit-middle-bottom';
      else containerId = 'toolkit-right';

      renderToolkitCategory(containerId, cat, partNumber);
  });
  
  renderTags('stems-container', stems);
  renderTags('words-container', words);
  
  const wordsContainer = document.getElementById('words-container');
  const idiomTag = document.createElement('span');
  idiomTag.className = 'tag idiom';
  idiomTag.textContent = theme.idiom;
  wordsContainer.prepend(idiomTag);
  
  // Add listeners for clicking
  [...document.getElementsByClassName('tag')].forEach(tag => {
      tag.onclick = (e) => speakText(e.target.textContent);
  });

  speakText(question);

  const timerDisplay = document.getElementById('question-timer');
  let remaining = duration;
  timerDisplay.textContent = remaining;

  setTimeout(() => {
    pBar.style.transition = `width ${duration}s linear`;
    pBar.style.width = '0%';
  }, 100);

  if(state.timerInterval) clearInterval(state.timerInterval);

  state.timerInterval = setInterval(() => {
    remaining--;
    timerDisplay.textContent = remaining;
    
    if(remaining <= 10) {
       timerDisplay.style.background = 'red'; 
       playTickSound();
    } else {
       timerDisplay.style.background = 'rgba(255,255,255,0.2)';
    }

    if(remaining <= 0) {
      clearInterval(state.timerInterval);
      if(partNumber < 3) runPart(partNumber + 1);
      else finishStudent();
    }
  }, 1000);
}

function renderToolkitCategory(containerId, categoryObj, partNumber) {
  const container = document.getElementById(containerId);
  
  // Header
  const header = document.createElement('div');
  header.className = 'toolkit-category compact';
  header.textContent = categoryObj.category;
  container.appendChild(header);

  // Rotation Logic: 2 phrases per part
  // Offset logic: (Part1 -> 0, Part2 -> 2, Part3 -> 4) % length
  const offset = (partNumber - 1) * 2;
  const p1 = categoryObj.phrases[offset % categoryObj.phrases.length];
  const p2 = categoryObj.phrases[(offset + 1) % categoryObj.phrases.length];
  
  const selectedPhrases = [p1, p2];

  // Render Phrases
  selectedPhrases.forEach(phrase => {
      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.textContent = phrase;
      container.appendChild(tag);
  });
}

function renderTags(containerId, items, isSpecial = false) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  items.forEach(item => {
    const tag = document.createElement('span');
    tag.className = `tag ${isSpecial ? 'special' : ''}`;
    tag.textContent = item;
    container.appendChild(tag);
  });
}

// 5. FINISH & DOWNLOAD
function finishStudent() {
  state.remainingStudents.shift();
  document.getElementById('rec-indicator').style.display = 'none';

  // Stop Recorder & Download
  if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
    state.mediaRecorder.onstop = () => {
      const blob = new Blob(state.audioChunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `${state.currentStudent.english}_${state.date}_${THEMES[state.selectedThemeIndex].name}.webm`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
    };
    state.mediaRecorder.stop();
  }

  // Show Overlay
  const overlay = document.getElementById('transition-overlay');
  overlay.style.display = 'flex';
  playWinSound();
  confetti({ particleCount: 100, origin: { y: 0.5 } });

  setTimeout(() => {
      startSelection();
  }, 3500);
}

init();

</script>
</body>
</html>
