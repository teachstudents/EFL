<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji Vocabulary Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            display: grid;
            grid-template-areas: 
                "left-gadgets top-bar right-gadgets"
                "left-gadgets main-area right-gadgets"
                "left-gadgets bottom-bar right-gadgets";
            grid-template-columns: 100px 1fr 100px;
            grid-template-rows: 80px 1fr 60px;
        }

        /* Top Dashboard */
        .top-bar {
            grid-area: top-bar;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .score-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .score-display {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.1s ease-in-out;
        }
        
        #streakCounter {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff9800;
            background: rgba(255, 152, 0, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            transition: transform 0.2s ease, color 0.3s ease, background-color 0.3s ease;
        }

        .current-word-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        #currentTopic {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: normal;
        }
        
        .topic-text {
             vertical-align: middle;
             margin-left: 0.25em;
        }

        .current-word {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.6rem;
            font-weight: bold;
            color: #333;
        }
        
        .target-emojis {
            display: flex;
            gap: 0.5rem;
            font-size: 1.2rem;
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 10px;
            margin-top: 2px;
            min-height: 28px; /* So it doesn't jump when empty */
        }

        .timer-display {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .timer-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(#28a745 0deg, #28a745 var(--progress, 360deg), #e9ecef var(--progress, 360deg));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            transition: all 0.1s ease;
        }

        .timer-circle.warning {
            background: conic-gradient(#ffc107 0deg, #ffc107 var(--progress, 360deg), #e9ecef var(--progress, 360deg));
        }

        .timer-circle.danger {
            background: conic-gradient(#dc3545 0deg, #dc3545 var(--progress, 360deg), #e9ecef var(--progress, 360deg));
            animation: timerPulse 1s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Left Gadgets */
        .left-gadgets {
            grid-area: left-gadgets;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            padding: 1rem 0.5rem;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
        }

        .time-extender-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .knob {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: white;
            font-weight: bold;
        }
        .knob-5s { background: linear-gradient(45deg, #ff6b6b, #ee5a52); }

        .knob:hover:not(.used) {
            transform: scale(1.1);
        }
        
        .knob.earned {
            animation: earnedPulse 1.5s infinite;
        }

        @keyframes earnedPulse {
            0% { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 4px 25px rgba(255, 255, 255, 0.9); }
            100% { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        }

        .knob-10s { background: linear-gradient(45deg, #feca57, #ff9f43); }
        .knob-15s { background: linear-gradient(45deg, #48dbfb, #0abde3); }

        .knob.used {
            background: #6c757d;
            cursor: not-allowed;
            transform: scale(0.9);
            opacity: 0.5;
        }

        .gadget-container { text-align: center; }

        .gadget-switch {
            position: relative;
            width: 36px;
            height: 64px;
            background: #343a40;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .switch-handle {
            position: absolute;
            top: 6px;
            left: 6px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .hint-handle { background: linear-gradient(45deg, #ffd700, #ffed4e); }
        .shield-handle { background: linear-gradient(45deg, #48dbfb, #0abde3); }


        .gadget-switch.active .switch-handle {
            top: 34px;
        }
        .gadget-switch.used {
            background: #6c757d;
            cursor: not-allowed;
        }

        .gadget-btn-small {
            background: linear-gradient(45deg, #9c27b0, #e91e63);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 10px;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .gadget-btn-small:hover { transform: scale(1.1); }
        

        /* Right Gadgets */
        .right-gadgets {
            grid-area: right-gadgets;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            padding: 1rem 0.5rem;
            box-shadow: -4px 0 15px rgba(0,0,0,0.1);
        }

        .multiplier-section, .score-booster-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .meter-container {
            display: flex;
            gap: 5px;
            align-items: flex-end;
        }

        .meter {
            width: 20px;
            height: 120px;
            background: #e9ecef;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .meter-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            transition: height 0.3s ease;
            border-radius: 10px;
        }
        .frenzy-meter-fill { background: linear-gradient(to top, #28a745, #20c997); }
        .booster-meter-fill { background: linear-gradient(to top, #007bff, #0056b3); }

        .gadget-btn {
            color: #333;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.7rem;
            width: 80px;
        }
        .frenzy-btn { background: linear-gradient(45deg, #ffd700, #ffed4e); }
        .booster-btn { background: linear-gradient(45deg, #17a2b8, #138496); color: white; }

        .gadget-btn:hover:not(:disabled) {
            transform: scale(1.1);
        }
        .frenzy-btn:hover:not(:disabled) { box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5); }
        .booster-btn:hover:not(:disabled) { box-shadow: 0 4px 15px rgba(23, 162, 184, 0.5); }


        .gadget-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .gadget-btn.active {
            animation: frenzyPulse 0.5s infinite;
        }

        @keyframes frenzyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .shuffle-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #9c27b0, #e91e63);
            color: white;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .shuffle-btn:hover {
            transform: scale(1.1) rotate(180deg);
        }

        /* Main Play Area */
        .main-area {
            grid-area: main-area;
            position: relative;
            overflow: hidden;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        }
        
        .main-area-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 500;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            color: white;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .emoji-grid {
            position: absolute;
            width: 110%; 
            height: 110%; 
            display: grid;
            grid-template-columns: repeat(15, 1fr); 
            grid-template-rows: repeat(10, 1fr);
            gap: 8px; 
            animation: emojiDrift 40s linear infinite alternate;
        }

        @keyframes emojiDrift {
            0% { transform: translate(-5%, -5%); }
            100% { transform: translate(5%, 5%); }
        }

        .emoji {
            font-size: 2.5rem; 
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px;
        }

        .emoji:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.8);
        }

        .emoji.correct {
            animation: correctPop 0.5s ease;
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .emoji.incorrect {
            animation: incorrectShake 0.5s ease;
            background: #f8d7da;
            border: 2px solid #dc3545;
        }

        .emoji.hint {
            animation: hintPulse 2s ease;
            background: #fff3cd;
            border: 3px solid #ffc107;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.8);
        }
        
        .emoji.filtered {
            opacity: 0.1;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        @keyframes correctPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1.2); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes hintPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 193, 7, 0.8); }
            50% { transform: scale(1.3); box-shadow: 0 0 30px rgba(255, 193, 7, 1); }
        }

        /* Bottom Progress Bar */
        .bottom-bar {
            grid-area: bottom-bar;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 2rem;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
        }

        .time-progress-bar {
            width: 80%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .time-progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.5s linear, background-color 0.5s ease;
            border-radius: 10px;
        }

        /* Screens */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            text-align: center;
            transition: opacity 0.5s ease;
        }
        
        .screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #playerNameInput {
            font-size: 1.5rem;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            border: 2px solid #ddd;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .start-btn, .leaderboard-btn, .back-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
            padding: 1rem 3rem;
        }
        
        .start-btn {
             width: 300px;
             height: 100px;
             animation: startGlow 2s infinite;
        }

        @keyframes startGlow {
            0%, 100% { box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5); }
            50% { box-shadow: 0 8px 35px rgba(40, 167, 69, 0.8); }
        }

        .start-btn:hover, .leaderboard-btn:hover, .back-btn:hover {
            transform: scale(1.1);
        }

        .final-score {
            font-size: 4rem;
            font-weight: bold;
            color: #ffd700;
            margin: 1rem 0;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        
        .game-over-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        #leaderboardScreen h1 {
            font-size: 3rem;
            margin-bottom: 2rem;
            color: #ffd700;
        }
        
        #leaderboardList {
            list-style: none;
            font-size: 1.5rem;
            width: 80%;
            max-width: 500px;
            margin-bottom: 2rem;
        }
        
        #leaderboardList li {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            background: rgba(255,255,255,0.1);
        }
        
        #leaderboardList li:nth-child(1) { background: rgba(255, 215, 0, 0.3); font-weight: bold; }
        #leaderboardList li:nth-child(2) { background: rgba(192, 192, 192, 0.3); }
        #leaderboardList li:nth-child(3) { background: rgba(205, 127, 50, 0.3); }


        /* Effects */
        .time-bonus-popup, .unlock-popup {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            z-index: 2600;
            pointer-events: none;
            animation: phrase-fade 3s ease-in-out forwards;
        }
        .time-bonus-popup {
            top: 60%;
            font-size: 2rem;
            color: #48dbfb;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .unlock-popup {
            top: 40%;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 20px;
            padding: 1.5rem 2rem;
            text-align: center;
        }
        .unlock-popup h2 {
            color: #ffd700;
        }
        .unlock-popup p {
            font-size: 1.5rem;
        }
        .unlocked-category-badge {
            font-size: 4rem;
            margin: 0.5rem 0;
        }

        .multiplier-active {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            padding: 1rem 2rem;
            border-radius: 20px;
            font-size: 2rem;
            font-weight: bold;
            z-index: 1000;
            animation: multiplierPulse 0.5s infinite;
        }
        
        .frenzy-indicator { background: linear-gradient(45deg, #ffd700, #ffed4e); }
        .booster-indicator { background: linear-gradient(45deg, #17a2b8, #138496); color: white;}


        @keyframes multiplierPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .gadget-label {
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            margin-top: 0.5rem;
        }
        
        .flying-coin {
            position: fixed;
            font-size: 1.5rem;
            color: gold;
            background: radial-gradient(circle, #ffd700, #f0c000);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            transition: all 0.8s cubic-bezier(0.5, 0, 1, 0.5);
        }

        .motivational-phrase {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 4px 8px rgba(0,0,0,0.6);
            padding: 1rem 2rem;
            border-radius: 20px;
            background: rgba(0,0,0,0.7);
            z-index: 2500;
            pointer-events: none;
            animation: phrase-fade 2s ease-in-out forwards;
        }

        @keyframes phrase-fade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 80px 1fr 80px;
            }
            
            .knob, .shuffle-btn {
                width: 60px;
                height: 60px;
                font-size: 1.2rem;
            }
            
            .current-word {
                font-size: 1.4rem;
            }
            
            .emoji {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Top Dashboard -->
        <div class="top-bar">
             <div class="score-container">
                <div class="score-display" id="scoreDisplay">0</div>
                <div id="streakCounter">🔥0</div>
            </div>
            <div class="current-word-container">
                 <div id="currentTopic"></div>
                 <div class="target-emojis" id="targetEmojis"></div>
                <div class="current-word">
                    <span id="currentWord">Ready?</span>
                </div>
            </div>
            <div class="timer-display">
                <div class="timer-circle" id="timerCircle">120</div>
            </div>
        </div>

        <!-- Left Gadgets -->
        <div class="left-gadgets">
            <div class="gadget-container">
                 <div class="time-extender-container">
                    <div class="knob knob-5s" id="timeKnob5" onclick="useTimeExtender(5)">+5s</div>
                    <div class="knob knob-10s used" id="timeKnob10" onclick="useTimeExtender(10)">+10s</div>
                    <div class="knob knob-15s used" id="timeKnob15" onclick="useTimeExtender(15)">+15s</div>
                </div>
                <div class="gadget-label">Time Extenders</div>
            </div>
             <div class="gadget-container">
                <div class="gadget-switch" id="hintSwitch" onclick="useHint()">
                    <div class="switch-handle hint-handle"></div>
                </div>
                <div class="gadget-label">Hint</div>
            </div>
             <div class="gadget-container">
                <button class="gadget-btn-small" onclick="useResetWord()">🔄</button>
                <div class="gadget-label">Reset Word (-3s)</div>
            </div>
        </div>

        <!-- Main Play Area -->
        <div class="main-area">
             <div class="main-area-overlay" id="mainAreaOverlay"></div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>

        <!-- Right Gadgets -->
        <div class="right-gadgets">
            <div class="meter-container">
                <div class="multiplier-section">
                    <div class="meter">
                        <div class="meter-fill frenzy-meter-fill" id="frenzyMeterFill" style="height: 0%"></div>
                    </div>
                    <button class="gadget-btn frenzy-btn" id="frenzyBtn" onclick="activateFrenzy()" disabled>2X Frenzy</button>
                </div>
                 <div class="score-booster-section">
                    <div class="meter">
                        <div class="meter-fill booster-meter-fill" id="boosterMeterFill" style="height: 0%"></div>
                    </div>
                    <button class="gadget-btn booster-btn" id="boosterBtn" onclick="activateScoreBooster()" disabled>3X Score</button>
                </div>
            </div>
             <div class="gadget-container">
                <div class="gadget-switch" id="shieldSwitch" onclick="useStreakShield()">
                     <div class="switch-handle shield-handle"></div>
                </div>
                <div class="gadget-label">Streak Shield</div>
            </div>
            <div class="gadget-container">
                <button class="shuffle-btn" onclick="shuffleEmojis()">🔀</button>
                <div class="gadget-label">Shuffle (-2s)</div>
            </div>
        </div>

        <!-- Bottom Progress Bar -->
        <div class="bottom-bar">
            <div class="time-progress-bar">
                <div class="time-progress-fill" id="timeProgressFill"></div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div class="screen" id="startScreen">
        <h1 style="font-size: 3rem; margin-bottom: 2rem;">🎯 Emoji Vocabulary Challenge</h1>
        <p style="font-size: 1.2rem; margin-bottom: 1rem; text-align: center; max-width: 600px;">
            Find 3 emojis that match each word! Use your gadgets wisely and race against time!
        </p>
        <input type="text" id="playerNameInput" placeholder="Enter your name">
        <button class="start-btn" onclick="startGame()">START</button>
    </div>

    <!-- Game Over Screen -->
    <div class="screen hidden" id="gameOverScreen">
        <h1 style="font-size: 3rem; margin-bottom: 1rem;">🎉 Game Over!</h1>
        <div class="final-score" id="finalScore">0</div>
        <p style="font-size: 1.2rem; margin-bottom: 2rem;">Words Completed: <span id="wordsCompleted">0</span></p>
        <div class="game-over-buttons">
            <button class="leaderboard-btn" onclick="restartGame()">Play Again</button>
            <button class="leaderboard-btn" onclick="showLeaderboard()">Leaderboard</button>
        </div>
    </div>
    
    <!-- Leaderboard Screen -->
    <div class="screen hidden" id="leaderboardScreen">
        <h1>🏆 Leaderboard</h1>
        <ol id="leaderboardList"></ol>
        <button class="back-btn" onclick="hideLeaderboard()">Back to Start</button>
    </div>


    <script>
        // --- GAME CONFIG ---
        const EMOJIS_TO_FIND = 3;
        const GRID_SIZE = 150;
        const INITIAL_TIME = 120;
        const LEADERBOARD_KEY = 'emojiVocabLeaderboard';
        const UNLOCKS_KEY = 'emojiVocabUnlocks';

        // --- GAME STATE ---
        let gameActive = false, timeLeft = INITIAL_TIME, score = 0, currentWordIndex = 0, foundEmojis = 0, frenzyMeter = 0, frenzyActive = false, frenzyTimeLeft = 0, scoreBoosterMeter = 0, scoreBoosterActive = false, wordsCompleted = 0, audioCtx, allGameWords = [], currentPlayerName = "Player", wordStartTime, currentStreak = 0, streakShieldActive = false;
        let timeExtenders = { 5: { used: false, earned: true }, 10: { used: true, earned: false }, 15: { used: true, earned: false } };
        let streakShieldUsed;

        // --- NEW THEMED GAME DATA ---
        const gameData = {
            Animals: { badge: "🦓", unlockedByDefault: true, vocab: [ { word: "Lion", emojis: ["🦁", "👑", "🥩"] }, { word: "Monkey", emojis: ["🐒", "🍌", "🌴"] }, { word: "Elephant", emojis: ["🐘", "🥜", "💧"] }, { word: "Snake", emojis: ["🐍", "🌿", "🐀"] }, { word: "Bear", emojis: ["🐻", "🍯", "🐟"] }, { word: "Fox", emojis: ["🦊", "🐔", "🌳"] }, { word: "Rabbit", emojis: ["🐰", "🥕", "🐇"] } ] },
            Food: { badge: "🍕", unlockedByDefault: true, vocab: [ { word: "Pizza", emojis: ["🍕", "🧀", "🍅"] }, { word: "Hamburger", emojis: ["🍔", "🥩", "🥬"] }, { word: "Taco", emojis: ["🌮", "🌶️", "🥑"] }, { word: "Sushi", emojis: ["🍣", "🍙", "🐟"] }, { word: "Cake", emojis: ["🍰", "🎂", "🥳"] }, { word: "Donut", emojis: ["🍩", "☕", "🍬"] }, { word: "Salad", emojis: ["🥗", "🥬", "🍅"] } ] },
            Fruits: { badge: "🍎", unlockedByDefault: true, vocab: [ { word: "Apple", emojis: ["🍎", "🌳", "🥧"] }, { word: "Banana", emojis: ["🍌", "🐒", "🥤"] }, { word: "Strawberry", emojis: ["🍓", "🍦", "🍰"] }, { word: "Grapes", emojis: ["🍇", "🍷", "🧀"] }, { word: "Watermelon", emojis: ["🍉", "☀️", "🔪"] } ] },
            Vegetables: { badge: "🥕", unlockedByDefault: false, vocab: [ { word: "Carrot", emojis: ["🥕", "🐰", "🧡"] }, { word: "Broccoli", emojis: ["🥦", "🌳", "🥗"] }, { word: "Corn", emojis: ["🌽", "🍿", "🧈"] }, { word: "Potato", emojis: ["🥔", "🍟", "🥔"] }, { word: "Tomato", emojis: ["🍅", "🍝", "🍕"] }, { word: "Onion", emojis: ["🧅", "😭", "🍔"] }, { word: "Lettuce", emojis: ["🥬", "🥗", "🍔"] } ] },
            Transportation: { badge: "🚗", unlockedByDefault: false, vocab: [ { word: "Car", emojis: ["🚗", "🚙", "🛣️"] }, { word: "Bus", emojis: ["🚌", "🚏", "🚌"] }, { word: "Train", emojis: ["🚆", "🚂", "🛤️"] }, { word: "Bicycle", emojis: ["🚲", "🚴", "🏞️"] }, { word: "Airplane", emojis: ["✈️", "🛫", "☁️"] }, { word: "Boat", emojis: ["🚤", "⛵", "🌊"] }, { word: "Helicopter", emojis: ["🚁", "🚁", "🏙️"] } ] },
            Sports: { badge: "⚽", unlockedByDefault: false, vocab: [ { word: "Soccer", emojis: ["⚽", "🥅", "🏆"] }, { word: "Basketball", emojis: ["🏀", "🏀", "⛹️"] }, { word: "Football", emojis: ["🏈", "🏟️", "💪"] }, { word: "Baseball", emojis: ["⚾", "🧢", "🌭"] }, { word: "Tennis", emojis: ["🎾", "🎾", "🏆"] }, { word: "Golf", emojis: ["⛳", "🏌️", "⛳"] }, { word: "Swimming", emojis: ["🏊", "🌊", "🏅"] } ] },
            School: { badge: "✏️", unlockedByDefault: false, vocab: [ { word: "Pencil", emojis: ["✏️", "📝", "✍️"] }, { word: "Book", emojis: ["📖", "📚", "🤓"] }, { word: "Backpack", emojis: ["🎒", "🎒", "🏫"] }, { word: "Scissors", emojis: ["✂️", "📄", "🎨"] }, { word: "Glue", emojis: ["🧴", "✨", "🧴"] }, { word: "Ruler", emojis: ["📏", "📐", "📏"] }, { word: "Teacher", emojis: ["🧑‍🏫", "👩‍🏫", "📚"] } ] },
            Insects: { badge: "🦋", unlockedByDefault: false, vocab: [ { word: "Butterfly", emojis: ["🦋", "🌸", "🐛"] }, { word: "Bee", emojis: ["🐝", "🍯", "🌻"] }, { word: "Ant", emojis: ["🐜", "🐜", "🍓"] }, { word: "Ladybug", emojis: ["🐞", "🐞", "🍀"] }, { word: "Spider", emojis: ["🕷️", "🕸️", "🕷️"] }, { word: "Snail", emojis: ["🐌", "🥬", "💧"] } ] },
            Travel: { badge: "✈️", unlockedByDefault: false, vocab: [ { word: "Beach", emojis: ["🏖️", "☀️", "🌊"] }, { word: "Mountain", emojis: ["🏔️", "⛰️", "🧗"] }, { word: "Suitcase", emojis: ["🧳", "✈️", "🏨"] }, { word: "Passport", emojis: ["🛂", "🛂", "✈️"] }, { word: "Camera", emojis: ["📷", "📸", "🏞️"] }, { word: "Map", emojis: ["🗺️", "🧭", "📍"] } ] },
            "Sea Creatures": { badge: "🐙", unlockedByDefault: false, vocab: [ { word: "Octopus", emojis: ["🐙", "🦑", "🌊"] }, { word: "Dolphin", emojis: ["🐬", "🐬", "🌊"] }, { word: "Whale", emojis: ["🐋", "🐳", "🌊"] }, { word: "Shark", emojis: ["🦈", "🐟", "🌊"] }, { word: "Jellyfish", emojis: ["🪼", "💧", "🌊"] }, { word: "Crab", emojis: ["🦀", "🦞", "🏖️"] }, { word: "Fish", emojis: ["🐠", "🐡", "🐟"] } ] }
        };
        const UNLOCK_ORDER = ["Vegetables", "Transportation", "Sports", "School", "Insects", "Travel", "Sea Creatures"];
        let unlockedCategories = [];
        
        const allEmojis = [...new Set(Object.values(gameData).flatMap(category => category.vocab.flatMap(item => item.emojis)))];
        const correctSounds = [ {name: "Bright Ding", seq: [{freq:880,dur:0.3}]}, {name: "Double Chime", seq: [{freq:660,dur:0.2},{freq:880,dur:0.2}]}, {name: "Sparkle Sweep", seq: [{freq:500,dur:0.3},{freq:1500,dur:0.1}]}, {name: "Bell Ping", seq: [{freq:784,dur:0.4}]}, {name: "Arcade Win", seq: [{freq:880,type:'square',dur:0.15},{freq:1320,type:'square',dur:0.15}]}, {name: "Coin Drop", seq: [{freq:1200,type:'sawtooth',dur:0.15},{freq:1800,type:'sawtooth',dur:0.15}]}, {name: "Harp Pluck", seq: [{freq:660,dur:0.15},{freq:880,dur:0.15},{freq:990,dur:0.15}]}, {name: "Pop Click", seq: [{freq:1000,type:'square',dur:0.05}]}, {name: "Magic Twinkle", seq: [{freq:1200,dur:0.1},{freq:1800,dur:0.1}]}, {name: "Level Up", seq: [{freq:660,dur:0.15},{freq:880,dur:0.15},{freq:1320,dur:0.15}]}, {name: "Rising Arpeggio", seq: [{freq:523, dur:0.1}, {freq:659, dur:0.1}, {freq:784, dur:0.1}, {freq:1046, dur:0.1}]}, {name: "Quick Trill", seq: [{freq:988, dur:0.05, gap: 0.05}, {freq:1046, dur:0.05, gap: 0.05}, {freq:988, dur:0.05, gap: 0.05}, {freq:1046, dur:0.05}]}, {name: "Fanfare", seq: [{freq:784, dur:0.15}, {freq:1046, dur:0.25}]}, {name: "Confirm Beep", seq: [{freq:600, type:'triangle', dur:0.1}, {freq:1200, type:'triangle', dur:0.1, gap: 0.1}]}, {name: "Synth Pluck", seq: [{freq:900, type:'sawtooth', vol: 0.3, dur:0.2}]}, {name: "Bright Ding", seq: [{freq:880,dur:0.3}]}, {name: "Scale Up", seq: [{freq:440, dur:0.1}, {freq:550, dur:0.1}, {freq:660, dur:0.1}]}, {name: "Shimmer", seq: [{freq:1500, dur:0.4, vol: 0.4}, {freq:1510, dur:0.4, vol:0.4, gap: -0.4}]}, {name: "Power Up", seq: [{freq:330, type:'square', dur:0.1}, {freq:440, type:'square', dur:0.1}, {freq:660, type:'square', dur:0.2}]}, {name: "Complete Chime", seq: [{freq:1046, dur:0.5}]}, {name: "Success Chord", seq: [{freq:523.25, dur:0.4}, {freq:659.25, dur:0.4, gap: -0.4}, {freq:783.99, dur:0.4, gap: -0.4}]}, {name: "Laser Zap", seq: [{freq:1500, type:'sawtooth', dur:0.01}, {freq:500, type:'sawtooth', dur:0.1}]}, {name: "Soft Bell", seq: [{freq:1046.50, dur:0.5, vol: 0.4}]}, {name: "Echo Ping", seq: [{freq:1200, dur:0.1, gap: 0.2}, {freq:1200, dur:0.1, vol: 0.2}]}, {name: "Bubble Pop", seq: [{freq:800, type:'triangle', dur:0.05, vol:0.8}]}, {name: "Achievement", seq: [{freq:392, dur:0.1}, {freq:523, dur:0.1}, {freq:784, dur:0.2}]}, {name: "Positive Chirp", seq: [{freq:1800, type:'sine', dur:0.1}]}, {name: "Digital OK", seq: [{freq:880, type:'square', dur:0.15}, {freq:1108, type:'square', dur:0.15}]}, {name: "Triumph", seq: [{freq:523.25, type:'sawtooth', dur:0.6}]}, {name: "Double Chime", seq: [{freq:660,dur:0.2},{freq:880,dur:0.2}]}, {name: "Double Pop", seq: [{freq:1000, type:'square', dur:0.05, gap:0.05}, {freq:1200, type:'square', dur:0.05}]}, {name: "Ascend", seq: [{freq:440, dur:0.05}, {freq:554, dur:0.05}, {freq:659, dur:0.05}, {freq:880, dur:0.1}]}, {name: "Mission Done", seq: [{freq:261, dur:0.15}, {freq:392, dur:0.15}, {freq:523, dur:0.3}]}, {name: "Harp Cascade", seq: [{freq:1046, dur:0.1}, {freq:784, dur:0.1}, {freq:659, dur:0.1}, {freq:523, dur:0.1}]}, {name: "Victory", seq: [{freq:523, dur:0.1}, {freq:523, dur:0.1, gap:0.1}, {freq:784, dur:0.2}, {freq:659, dur:0.3}]}, {name: "Simple OK", seq: [{freq:700, type:'triangle', dur:0.2}]},  {name: "Prize Reveal", seq: [{freq:1200, dur:0.1}, {freq:1600, dur:0.1}, {freq:1800, dur:0.2}]}, {name: "Final Ding", seq: [{freq:1046.50, dur:0.4}]} ];
        const incorrectSounds = [ {name: "Buzzer", seq: [{freq:200,type:'square',dur:0.5}]}, {name: "Double Buzz", seq: [{freq:200,type:'square',dur:0.2},{freq:200,type:'square',dur:0.2}]}, {name: "Descending Wah", seq: [{freq:600,dur:0.2},{freq:200,dur:0.3}]}, {name: "Flat Fail", seq: [{freq:150,dur:0.4}]}, {name: "Error Beep", seq: [{freq:400,type:'sawtooth',dur:0.3}]}, {name: "Glitch Zap", seq: [{freq:1000,type:'square',dur:0.05},{freq:300,type:'square',dur:0.05}]}, {name: "Sad Trombone", seq: [{freq:400,dur:0.2},{freq:300,dur:0.2},{freq:200,dur:0.3}]}, {name: "Reject Click", seq: [{freq:100,type:'square',dur:0.05}]}, {name: "Alarm Chirp", seq: [{freq:500,dur:0.2},{freq:500,dur:0.2}]}, {name: "Drop Off", seq: [{freq:800,dur:0.2},{freq:100,dur:0.3}]}, {name: "Wobble", seq: [{freq:300, dur:0.4}, {freq:290, dur:0.4, gap: -0.4}]}, {name: "Downward Slide", seq: [{freq:500, type:'sawtooth', dur:0.05}, {freq:400, type:'sawtooth', dur:0.05}, {freq:300, type:'sawtooth', dur:0.05}, {freq:200, type:'sawtooth', dur:0.2}]}, {name: "Detuned Chord", seq: [{freq:220, dur:0.5}, {freq:225, dur:0.5, gap: -0.5}]}, {name: "Muted Thud", seq: [{freq:100, type:'triangle', dur:0.2, vol: 0.8}]}, {name: "Static Burst", seq: [{freq:1800, type:'sawtooth', dur:0.05}, {freq:1900, type:'sawtooth', dur:0.05, gap: -0.05}, {freq:1700, type:'sawtooth', dur:0.05, gap: -0.05}]}, {name: "Game Over", seq: [{freq:330, dur:0.2}, {freq:220, dur:0.2}, {freq:110, dur:0.3}]}, {name: "Clank", seq: [{freq:800, type:'square', dur:0.1}, {freq:810, type:'square', dur:0.1, gap: -0.1}]}, {name: "Wrong Synth", seq: [{freq:155, type:'sawtooth', dur:0.4}]}, {name: "Fail Arpeggio", seq: [{freq:523, dur:0.1}, {freq:392, dur:0.1}, {freq:261, dur:0.2}]}, {name: "Rattle", seq: [{freq:900, type:'square', dur:0.02, gap:0.02}, {freq:900, type:'square', dur:0.02, gap:0.02}, {freq:900, type:'square', dur:0.02}]}, {name: "Wrong Chord", seq: [{freq:261.63, dur:0.5}, {freq:311.13, dur:0.5, gap:-0.5}, {freq:369.99, dur:0.5, gap:-0.5}]}, {name: "System Error", seq: [{freq:110, type:'square', dur:0.6}]}, {name: "Mechanical Fail", seq: [{freq:250, type:'sawtooth', dur:0.2}, {freq:240, type:'sawtooth', dur:0.2, gap:-0.2}]}, {name: "Short Circuit", seq: [{freq:1800, type:'square', dur:0.02}, {freq:1850, type:'square', dur:0.02, gap:-0.02}]}, {name: "Deflated", seq: [{freq:500, dur:0.1}, {freq:400, dur:0.1}, {freq:300, dur:0.1}, {freq:200, dur:0.2}]}, {name: "Denied", seq: [{freq:220, dur:0.2, gap:0.1}, {freq:220, dur:0.2}]}, {name: "Alert Beep", seq: [{freq:1000, type:'sawtooth', dur:0.1, gap:0.1}, {freq:1000, type:'sawtooth', dur:0.1}]}, {name: "Low Drone", seq: [{freq:80, dur:0.8}]}, {name: "Scrape", seq: [{freq:600, type:'sawtooth', dur:0.3}, {freq:610, type:'sawtooth', dur:0.3, gap:-0.3}]}, {name: "Bonk", seq: [{freq:150, type:'triangle', dur:0.15, vol:0.9}]}, {name: "Glitchy Signal", seq: [{freq:800, type:'square', dur:0.03}, {freq:400, type:'square', dur:0.03}, {freq:1200, type:'square', dur:0.03}]}, {name: "Sad Beep", seq: [{freq:440, dur:0.3}, {freq:415, dur:0.3, gap:-0.3}]}, {name: "Error Chord", seq: [{freq:440, dur:0.4}, {freq:466, dur:0.4, gap:-0.4}]}, {name: "System Halt", seq: [{freq:100, type:'sawtooth', dur:0.6}]}, {name: "Warning Siren", seq: [{freq:800, dur:0.2, gap:0.1}, {freq:700, dur:0.2}]}, {name: "Interference", seq: [{freq:2500, type:'square', dur:0.2, vol:0.2}, {freq:2550, type:'square', dur:0.2, vol:0.2, gap:-0.2}]}, {name: "Shutdown", seq: [{freq:400, type:'square', dur:0.1}, {freq:300, type:'square', dur:0.1}, {freq:200, type:'square', dur:0.2}]}, {name: "Muted Error", seq: [{freq:120, dur:0.2}]}, {name: "Dissonant Ring", seq: [{freq:1000, dur:0.4}, {freq:1015, dur:0.4, gap:-0.4}]}, {name: "Final Buzz", seq: [{freq:120, type:'square', dur:0.5}]} ];
        const correctPhrases = [ "Stellar work!", "You've got it!", "Absolutely brilliant!", "That's the one!", "Incredible!", "You're a genius!", "Keep it up!", "Outstanding!", "Perfectly done!", "You're on fire!" ];
        const incorrectPhrases = [ "That was a great attempt! Let's try another.", "Not this time, but you're getting warmer!", "Every try is a step forward. Keep going!", "Mistakes are proof that you are trying. Don't stop!", "That's not the answer, but I believe in you!", "So close! What's your next idea?", "Don't worry, the best discoveries come after a few tries.", "That's a learning opportunity! Try again.", "Your persistence is inspiring. Let's go again.", "Even experts get it wrong sometimes. You've got this!" ];

        let gameTimer, frenzyTimer, nextWordTimeout;
        
        function loadUnlockedCategories() {
            const savedUnlocks = localStorage.getItem(UNLOCKS_KEY);
            if (savedUnlocks) {
                unlockedCategories = JSON.parse(savedUnlocks);
            } else {
                unlockedCategories = Object.keys(gameData).filter(cat => gameData[cat].unlockedByDefault);
                localStorage.setItem(UNLOCKS_KEY, JSON.stringify(unlockedCategories));
            }
        }
        
        function initializeWordList() {
            allGameWords = [];
            unlockedCategories.forEach(categoryName => {
                const category = gameData[categoryName];
                if (category) {
                    category.vocab.forEach(wordData => {
                        allGameWords.push({ ...wordData, category: categoryName, badge: category.badge });
                    });
                }
            });
            for (let i = allGameWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allGameWords[i], allGameWords[j]] = [allGameWords[j], allGameWords[i]];
            }
        }

        function startGame() {
            currentPlayerName = document.getElementById('playerNameInput').value || 'Player';
            document.getElementById('startScreen').classList.add('hidden');
            
            // Initialize AudioContext on user interaction
            if (!audioCtx) {
                 audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Reset all state variables
            gameActive = true;
            timeLeft = INITIAL_TIME;
            score = 0;
            currentWordIndex = 0;
            foundEmojis = 0;
            frenzyMeter = 0;
            frenzyActive = false;
            scoreBoosterMeter = 0;
            scoreBoosterActive = false;
            wordsCompleted = 0;
            currentStreak = 0;
            
            loadUnlockedCategories();
            initializeWordList();
            updateDisplay();
            resetGadgetsUI();
            loadNewWord();
            generateEmojiGrid();
            updateTimeBar();
            
            if(gameTimer) clearInterval(gameTimer);
            gameTimer = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            if (!gameActive) return;
            timeLeft--;
            updateTimerDisplay();
            updateTimeBar();
            
            if (frenzyActive) {
                frenzyTimeLeft--;
                if (frenzyTimeLeft <= 0) deactivateFrenzy();
            }
            if (timeLeft <= 0) {
                timeLeft = 0;
                endGame();
            }
        }

        function updateTimerDisplay() {
            const timerCircle = document.getElementById('timerCircle');
            const progress = (timeLeft / INITIAL_TIME) * 360;
            timerCircle.textContent = timeLeft;
            timerCircle.style.setProperty('--progress', progress + 'deg');
            
            timerCircle.classList.toggle('danger', timeLeft <= 15);
            timerCircle.classList.toggle('warning', timeLeft > 15 && timeLeft <= 45);
            if(timeLeft <=10 && timeLeft > 0) playSound('tick');
        }

        function updateTimeBar() {
            const timeFill = document.getElementById('timeProgressFill');
            const timePercent = (timeLeft / INITIAL_TIME) * 100;
            timeFill.style.width = `${timePercent}%`;

            if (timePercent < 15) {
                timeFill.style.backgroundColor = '#dc3545';
            } else if (timePercent < 40) {
                timeFill.style.backgroundColor = '#ffc107';
            } else {
                timeFill.style.backgroundColor = '#28a745';
            }
        }

        function loadNewWord() {
            if (currentWordIndex >= allGameWords.length) {
                initializeWordList(); 
                currentWordIndex = 0;
            }

            const currentWordData = allGameWords[currentWordIndex];
            document.getElementById('currentWord').textContent = currentWordData.word;
            document.getElementById('currentTopic').innerHTML = `${currentWordData.badge} <span class="topic-text">${currentWordData.category}</span>`;
            document.getElementById('targetEmojis').innerHTML = currentWordData.emojis.map(e => `<span>${e}</span>`).join('');
            
            foundEmojis = 0;
            document.querySelectorAll('.emoji').forEach(e => e.classList.remove('correct', 'incorrect', 'hint', 'filtered'));
            wordStartTime = Date.now();
            setTimeout(() => speakWord(currentWordData.word), 300);
        }

        function generateEmojiGrid() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = '';
            
            const currentWordData = allGameWords[currentWordIndex];
            const targetEmojis = currentWordData.emojis.slice(0, EMOJIS_TO_FIND);
            const gridEmojis = [];
            
            targetEmojis.forEach(emoji => {
                for (let i = 0; i < 3; i++) gridEmojis.push(emoji);
            });
            
            while (gridEmojis.length < GRID_SIZE) {
                gridEmojis.push(allEmojis[Math.floor(Math.random() * allEmojis.length)]);
            }
            
            for (let i = gridEmojis.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gridEmojis[i], gridEmojis[j]] = [gridEmojis[j], gridEmojis[i]];
            }
            
            gridEmojis.forEach(emoji => {
                const emojiElement = document.createElement('div');
                emojiElement.className = 'emoji';
                emojiElement.textContent = emoji;
                emojiElement.onclick = () => selectEmoji(emojiElement, emoji);
                grid.appendChild(emojiElement);
            });
        }

        function getBasePoints(streak) {
            if (streak >= 15) return 20;
            if (streak >= 10) return 15;
            if (streak >= 5) return 12;
            return 10;
        }

        function selectEmoji(element, emoji) {
            if (!gameActive || element.classList.contains('correct') || element.classList.contains('incorrect')) return;
            
            const currentWordData = allGameWords[currentWordIndex];
            const isCorrect = currentWordData.emojis.includes(emoji);
            
            if (isCorrect) {
                element.classList.add('correct');
                foundEmojis++;
                currentStreak++;
                
                const basePoints = getBasePoints(currentStreak);
                let points = basePoints;
                if (frenzyActive) points *= 2;
                if (scoreBoosterActive) {
                    points *= 3;
                    scoreBoosterActive = false; 
                    document.querySelector('.booster-indicator')?.remove();
                    playSound('boosterCollect');
                } else {
                    playSound('correct');
                }
                score += points;

                animateCoins(element);
                showMotivationalPhrase(true);
                
                frenzyMeter = Math.min(100, frenzyMeter + 5 + currentStreak);
                scoreBoosterMeter = Math.min(100, scoreBoosterMeter + 5 + currentStreak);
                updateMeters();
                
                if (foundEmojis >= EMOJIS_TO_FIND) completeWord();
                
            } else {
                if (streakShieldActive) {
                    streakShieldActive = false;
                    document.getElementById('shieldSwitch').classList.remove('active');
                    playSound('shieldBlock');
                } else {
                    currentStreak = 0;
                }
                element.classList.add('incorrect');
                playSound('incorrect');
                showMotivationalPhrase(false);
                setTimeout(() => element.classList.remove('incorrect'), 500);
            }
            updateDisplay();
            updateTimerDisplay();
            updateTimeBar();
        }

        function checkAndUnlockCategory() {
            if (wordsCompleted > 0 && wordsCompleted % 3 === 0) {
                const nextUnlock = UNLOCK_ORDER.find(cat => !unlockedCategories.includes(cat));
                if (nextUnlock) {
                    unlockedCategories.push(nextUnlock);
                    localStorage.setItem(UNLOCKS_KEY, JSON.stringify(unlockedCategories));
                    showUnlockPopup(nextUnlock);
                    initializeWordList();
                    currentWordIndex = Math.min(currentWordIndex, allGameWords.length - 1);
                }
            }
        }
        
        function completeWord() {
            wordsCompleted++;
            checkAndUnlockCategory();
            playSound('wordComplete');
            const bonus = frenzyActive ? 100 : 50;
            score += bonus;
            
            const elapsedTime = Date.now() - wordStartTime;
            if (elapsedTime < 5000) {
                if(timeExtenders[15].used) {
                    timeExtenders[15].earned = true;
                    const knob = document.getElementById('timeKnob15');
                    knob.classList.remove('used');
                    knob.classList.add('earned');
                    showTimeBonusPopup("+15s Extender Earned!");
                }
            } else if (elapsedTime < 10000) {
                 if(timeExtenders[10].used) {
                    timeExtenders[10].earned = true;
                    const knob = document.getElementById('timeKnob10');
                    knob.classList.remove('used');
                    knob.classList.add('earned');
                    showTimeBonusPopup("+10s Extender Earned!");
                }
            }
            updateTimerDisplay();

            const overlay = document.getElementById('mainAreaOverlay');
            let countdown = 2;
            overlay.textContent = `Next Word in ${countdown}...`;
            overlay.style.opacity = '1';
            
            const countdownInterval = setInterval(() => {
                countdown--;
                overlay.textContent = `Next Word in ${countdown}...`;
                if(countdown <= 0) clearInterval(countdownInterval);
            }, 1000);

            if(nextWordTimeout) clearTimeout(nextWordTimeout);
            nextWordTimeout = setTimeout(() => {
                overlay.style.opacity = '0';
                currentWordIndex++;
                loadNewWord();
                generateEmojiGrid();
                updateDisplay();
            }, 2000);
        }

        function useTimeExtender(seconds) {
            if (!gameActive) return;
            const extender = timeExtenders[seconds];
            if (extender.used || !extender.earned) return;
            timeLeft += seconds;
            extender.used = true;
            extender.earned = false;

            const knob = document.getElementById(`timeKnob${seconds}`);
            knob.classList.add('used');
            knob.classList.remove('earned');
            
            playSound('knobTurn');
            updateTimerDisplay();
            updateTimeBar();
        }

        function useResetWord(){
            if (!gameActive || timeLeft <= 3) return;
            timeLeft -= 3;
            playSound('shuffle');
            updateTimerDisplay();
            updateTimeBar();
            currentWordIndex++;
            loadNewWord();
            generateEmojiGrid();
        }

        function useStreakShield() {
            if (streakShieldUsed || !gameActive || streakShieldActive) return;
            streakShieldUsed = true;
            streakShieldActive = true;
            const switchEl = document.getElementById('shieldSwitch');
            switchEl.classList.add('active');
            switchEl.classList.add('used');
            playSound('shieldActivate');
        }

        function useHint() {
            if (!gameActive) return;
            const targetEmojis = allGameWords[currentWordIndex].emojis;
            const availableHints = [...document.querySelectorAll('.emoji')].filter(el => 
                targetEmojis.includes(el.textContent) && !el.classList.contains('correct') && !el.classList.contains('hint')
            );
            
            if (availableHints.length > 0) {
                const hintElement = availableHints[Math.floor(Math.random() * availableHints.length)];
                hintElement.classList.add('hint');
                setTimeout(() => hintElement.classList.remove('hint'), 2000);
                
                score = Math.max(0, score - 5);
                updateDisplay();
                playSound('switchFlip');
                
                const hintSwitch = document.getElementById('hintSwitch');
                hintSwitch.classList.add('active');
                setTimeout(() => hintSwitch.classList.remove('active'), 300);
            }
        }
        
        function updateMeters() {
            document.getElementById('frenzyMeterFill').style.height = frenzyMeter + '%';
            document.getElementById('boosterMeterFill').style.height = scoreBoosterMeter + '%';
            document.getElementById('frenzyBtn').disabled = frenzyMeter < 100 || frenzyActive;
            document.getElementById('boosterBtn').disabled = scoreBoosterMeter < 100 || scoreBoosterActive;
        }

        function activateFrenzy() {
            if (frenzyMeter < 100 || frenzyActive) return;
            frenzyActive = true;
            frenzyTimeLeft = 10;
            frenzyMeter = 0;
            updateMeters();
            playSound('powerUp');
            
            const indicator = document.createElement('div');
            indicator.className = 'multiplier-active frenzy-indicator';
            indicator.textContent = '2X FRENZY! 🔥';
            document.body.appendChild(indicator);
            
            frenzyTimer = setTimeout(deactivateFrenzy, 10000);
        }
        
        function activateScoreBooster() {
            if (scoreBoosterMeter < 100 || scoreBoosterActive) return;
            scoreBoosterActive = true;
            scoreBoosterMeter = 0;
            updateMeters();
            playSound('boosterActivate');
            
            const indicator = document.createElement('div');
            indicator.className = 'multiplier-active booster-indicator';
            indicator.textContent = '3X SCORE BOOST! ✨';
            document.body.appendChild(indicator);
        }

        function deactivateFrenzy() {
            frenzyActive = false;
            frenzyTimeLeft = 0;
            document.querySelector('.frenzy-indicator')?.remove();
            if (frenzyTimer) clearTimeout(frenzyTimer);
        }

        function shuffleEmojis() {
            if (!gameActive || timeLeft <= 2) return;
            timeLeft -= 2;
            updateTimerDisplay();
            updateTimeBar();
            generateEmojiGrid();
            playSound('shuffle');
        }

        function showMotivationalPhrase(isCorrect) {
            const phrase = isCorrect ? correctPhrases[Math.floor(Math.random() * correctPhrases.length)] : incorrectPhrases[Math.floor(Math.random() * incorrectPhrases.length)];
            const message = document.createElement('div');
            message.className = 'motivational-phrase';
            message.textContent = phrase;
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 2000);
        }
        
        function showTimeBonusPopup(text) {
            const popup = document.createElement('div');
            popup.className = 'time-bonus-popup';
            popup.textContent = text;
            document.body.appendChild(popup);
            playSound('powerUp');
            setTimeout(() => popup.remove(), 2000);
        }
        
        function showUnlockPopup(categoryName) {
            const data = gameData[categoryName];
            if (!data) return;

            const popup = document.createElement('div');
            popup.className = 'unlock-popup';
            popup.innerHTML = `<h2>New Category Unlocked!</h2><div class="unlocked-category-badge">${data.badge}</div><p>${categoryName}</p>`;
            document.body.appendChild(popup);
            playSound('achievement');
            setTimeout(() => popup.remove(), 3000);
        }

        function animateCoins(startElement) {
            const scoreDisplay = document.getElementById('scoreDisplay');
            const startRect = startElement.getBoundingClientRect();
            const endRect = scoreDisplay.getBoundingClientRect();

            for (let i = 0; i < 5; i++) {
                const coin = document.createElement('div');
                coin.textContent = '💰';
                coin.className = 'flying-coin';
                const startX = startRect.left + startRect.width / 2, startY = startRect.top + startRect.height / 2;
                const endX = endRect.left + endRect.width / 2, endY = endRect.top + endRect.height / 2;
                
                coin.style.left = `${startX}px`;
                coin.style.top = `${startY}px`;
                document.body.appendChild(coin);

                setTimeout(() => {
                    coin.style.left = `${endX}px`;
                    coin.style.top = `${endY}px`;
                    coin.style.transform = 'scale(0.5)';
                    coin.style.opacity = '0';
                }, 50 * i);

                setTimeout(() => {
                    coin.remove();
                    if (i === 4) {
                        scoreDisplay.style.transform = 'scale(1.2)';
                        setTimeout(() => scoreDisplay.style.transform = 'scale(1)', 150);
                    }
                }, 800 + 50 * i);
            }
        }

        function updateDisplay() {
            document.getElementById('scoreDisplay').textContent = score;
            const streakCounter = document.getElementById('streakCounter');
            streakCounter.textContent = `🔥${currentStreak}`;
            streakCounter.style.transform = `scale(${1 + currentStreak * 0.05})`;

            const streakColor = getBasePoints(currentStreak) > 10 ? '#f57c00' : '#ff9800';
            const streakBg = getBasePoints(currentStreak) > 10 ? 'rgba(245, 124, 0, 0.2)' : 'rgba(255, 152, 0, 0.1)';
            streakCounter.style.color = streakColor;
            streakCounter.style.backgroundColor = streakBg;
        }

        function speakWord(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                
                const voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                     const desiredVoiceNames = ["Brian", "Emma", "Ava", "William", "Alex", "Samantha"];
                     let selectedVoice;

                    // 1. Find a preferred premium voice
                    selectedVoice = voices.find(v => v.lang === 'en-US' && desiredVoiceNames.some(name => v.name.includes(name)));
                    
                    // 2. Fallback to any Microsoft voice
                    if (!selectedVoice) {
                        selectedVoice = voices.find(v => v.lang === 'en-US' && v.name.includes("Microsoft"));
                    }
                    
                    // 3. Fallback to any US English voice
                    if (!selectedVoice) {
                        selectedVoice = voices.find(v => v.lang === 'en-US');
                    }
                     if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }
                }
                
                utterance.rate = 0.85; 
                utterance.pitch = 1;
                utterance.lang = 'en-US';
                utterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror', event);
                };
                window.speechSynthesis.speak(utterance);
            }
        }

        function playSound(type) {
            if (!audioCtx) return;
            let soundSeq;
            switch (type) {
                case 'correct': soundSeq = correctSounds[Math.floor(Math.random() * correctSounds.length)].seq; break;
                case 'incorrect': soundSeq = incorrectSounds[Math.floor(Math.random() * incorrectSounds.length)].seq; break;
                case 'tick': soundSeq = [{ freq: 1000, dur: 0.05, type: 'square' }]; break;
                case 'wordComplete': soundSeq = [{freq: 523, dur:0.1}, {freq: 659, dur:0.1}, {freq: 784, dur:0.1}, {freq: 1046, dur:0.2}]; break;
                case 'knobTurn': soundSeq = [{freq: 400, dur: 0.1, type: 'sawtooth'}, {freq: 800, dur: 0.1, type: 'sawtooth'}]; break;
                case 'switchFlip': soundSeq = [{freq: 1200, dur: 0.05, type: 'square'}]; break;
                case 'powerUp': soundSeq = [{freq: 330, type:'square', dur:0.1}, {freq: 440, type:'square', dur:0.1}, {freq: 660, type:'square', dur:0.2}]; break;
                case 'shuffle': soundSeq = [{freq: 200, dur: 0.1}, {freq: 600, dur: 0.1}, {freq: 400, dur: 0.1}, {freq: 800, dur: 0.1}]; break;
                case 'boosterActivate': soundSeq = [{freq: 400, dur: 0.1}, {freq: 600, dur: 0.1}, {freq: 900, dur: 0.2}]; break;
                case 'boosterCollect': soundSeq = [{freq:523, dur:0.4}, {freq:659, dur:0.4, gap:-0.4}, {freq:990, dur:0.4, gap:-0.4}]; break;
                case 'shieldActivate': soundSeq = [{freq:1500, dur:0.1}, {freq:1800, dur:0.2}]; break;
                case 'shieldBlock': soundSeq = [{freq: 300, type:'sawtooth', dur:0.3}]; break;
                case 'achievement': soundSeq = [{freq:392, dur:0.1}, {freq:523, dur:0.1}, {freq:784, dur:0.2}, {freq:1046, dur:0.3}]; break;
                default: return;
            }
            let time = audioCtx.currentTime;
            soundSeq.forEach(note => {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = note.freq; o.type = note.type || 'sine';
                g.gain.setValueAtTime(note.vol || 0.5, time);
                const s = time + (note.gap || 0), e = s + note.dur;
                o.start(s); g.gain.exponentialRampToValueAtTime(1e-5, e); o.stop(e);
                time = e;
            });
        }

        function endGame() {
            gameActive = false;
            clearInterval(gameTimer);
            if (frenzyTimer) clearTimeout(frenzyTimer);
            if (nextWordTimeout) clearTimeout(nextWordTimeout);
            
            const leaderboard = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || [];
            leaderboard.push({ name: currentPlayerName, score: score });
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard.splice(10);
            localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboard));

            document.getElementById('finalScore').textContent = score;
            document.getElementById('wordsCompleted').textContent = wordsCompleted;
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }

        function restartGame() {
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }
        
        function showLeaderboard() {
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.add('hidden');

            const leaderboard = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || [];
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            if (leaderboard.length === 0) {
                list.innerHTML = '<li>No scores yet. Be the first!</li>';
            } else {
                leaderboard.forEach(entry => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${entry.name}</span><span>${entry.score}</span>`;
                    list.appendChild(li);
                });
            }
            document.getElementById('leaderboardScreen').classList.remove('hidden');
        }

        function hideLeaderboard() {
            document.getElementById('leaderboardScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }
        
        function resetGadgetsUI(){
            timeExtenders = { 5: { used: false, earned: true }, 10: { used: true, earned: false }, 15: { used: true, earned: false } };
            document.getElementById('timeKnob5').classList.remove('used', 'earned');
            document.getElementById('timeKnob10').classList.add('used');
            document.getElementById('timeKnob10').classList.remove('earned');
            document.getElementById('timeKnob15').classList.add('used');
            document.getElementById('timeKnob15').classList.remove('earned');

            const shieldSwitch = document.getElementById('shieldSwitch');
            shieldSwitch.classList.remove('used', 'active');
            streakShieldUsed = false;
            streakShieldActive = false;
            updateMeters();
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                // This ensures that the voice list is populated when the browser is ready.
            };
        }

    </script>
</body>
</html>
