<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçΩÔ∏è Joel's Restaurant Dialogue Practice üó£Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
/* Global font stack for all text */
body, button, input, h1, h2, h3, h4, p, div {
  font-family: 'Fredoka', 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;
  font-weight: 500;
}

/* Force emoji-capable font for the staff flag only */
#staffFlag {
  font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;
  transform: none !important; /* disable float animation for flags */
  display: inline-block;
}

        body {
            background: linear-gradient(270deg, #ff9a9e, #fad0c4, #fbc2eb, #a18cd1);
            background-size: 800% 800%;
            animation: gradientShift 45s ease infinite;
        }

        @keyframes gradientShift {
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }

        #emoji-rain-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .emoji-rain {
            position: absolute;
            top: -10vh;
            color: white;
            opacity: 0.6;
            animation: rainFall linear 1;
        }

        @keyframes rainFall {
            to {
                transform: translateY(120vh) rotate(360deg);
            }
        }
        
        .floating-emoji {
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }

        .sparkle {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #fde047;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            animation: sparkle-animation 0.6s forwards;
            box-shadow: 0 0 10px #fff, 0 0 15px #fde047;
        }

        @keyframes sparkle-animation {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }
        
        .menu-card { transition: all 0.3s ease; cursor: pointer; }
        .menu-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        .dialogue-bubble {
            position: relative;
            border-radius: 20px;
            padding: 12px 18px;
            margin: 8px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            opacity: 0.6;
            transition: all 0.4s ease-in-out;
            transform: scale(0.98);
        }
        .dialogue-bubble.active { opacity: 1; transform: scale(1.02); box-shadow: 0 8px 20px rgba(79, 70, 229, 0.2); }
        .customer-bubble { background: linear-gradient(135deg, #e3f2fd, #bbdefb); margin-left: 20px; }
        .staff-bubble { background: linear-gradient(135deg, #f3e5f5, #e1bee7); margin-right: 20px; }
        
        mark { background-color: #fde047; border-radius: 3px; }
        
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #dc2626; color: white; padding: 10px 20px; border-radius: 9999px; z-index: 50; display: none; opacity: 0; transition: opacity 0.5s ease; font-size: 0.875rem; }
    </style>
</head>
<body class="min-h-screen">
    <div id="notification" class="notification"></div>
    <div id="emoji-rain-container"></div>
    <div class="container mx-auto px-4 py-6 max-w-5xl">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-3">üçΩÔ∏è Joel's Restaurant</h1>
        </div>

        <!-- Main Menu Selection -->
        <div id="menuSelection" class="bg-white/95 backdrop-filter backdrop-blur-lg rounded-3xl p-5 shadow-2xl mb-6">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">üè™ Welcome!</h2>
            <p class="text-lg text-gray-600 text-center mb-6">Choose a meal time to start your dialogue practice</p>
            
            <div class="grid md:grid-cols-3 gap-6">
                <div class="menu-card bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl p-5" onclick="generateScenario('breakfast')">
                    <div class="text-center">
                        <div class="text-7xl mb-3 floating-emoji">üåÖ</div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Breakfast</h3>
                        <p class="text-gray-600">Morning conversations</p>
                    </div>
                </div>
                
                <div class="menu-card bg-gradient-to-br from-green-100 to-teal-100 rounded-2xl p-5" onclick="generateScenario('lunch')">
                    <div class="text-center">
                        <div class="text-7xl mb-3 floating-emoji">‚òÄÔ∏è</div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Lunch</h3>
                        <p class="text-gray-600">Midday conversations</p>
                    </div>
                </div>
                
                <div class="menu-card bg-gradient-to-br from-purple-100 to-indigo-100 rounded-2xl p-5" onclick="generateScenario('dinner')">
                    <div class="text-center">
                        <div class="text-7xl mb-3 floating-emoji">üåô</div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Dinner</h3>
                        <p class="text-gray-600">Evening conversations</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Restaurant Details -->
        <div id="restaurantDetails" class="hidden">
            <div class="bg-white/95 backdrop-filter backdrop-blur-lg rounded-3xl p-5 shadow-2xl mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center">
                    <div class="text-center">
                        <div class="text-3xl mb-1 floating-emoji" id="mealIcon">üåÖ</div>
                        <h3 class="text-lg font-bold text-gray-800" id="mealType">Breakfast</h3>
                    </div>
                    
                    <div class="text-center cursor-pointer" id="staffContainer" data-tts="true" onclick="playBilingualGreeting()">
                        <div class="text-3xl mb-1 floating-emoji" id="staffFlag">üë®‚Äçüç≥</div>
                        <h3 class="text-lg font-bold text-gray-800">Today's Staff</h3>
                        <p class="text-md text-gray-600" id="staffInfo">Sarah (Waitress)</p>
                    </div>

                    <div class="text-center cursor-pointer" id="timeContainer" data-tts="true">
                        <div class="text-3xl mb-1 floating-emoji">‚è∞</div>
                        <h3 class="text-lg font-bold text-gray-800">Opening Times</h3>
                        <p class="text-md text-gray-600" id="timeInfo">8:00 AM - 11:30 AM</p>
                    </div>
                    
                    <div class="text-center cursor-pointer" id="specialContainer" data-tts="true">
                        <div class="text-3xl mb-1 floating-emoji">‚≠ê</div>
                        <h3 class="text-lg font-bold text-gray-800">Special Today</h3>
                        <p class="text-sm text-gray-600" id="specialOffer">10% off pancakes!</p>
                    </div>
                </div>
                
                <div class="text-center mt-5">
                    <button onclick="generateScenario(currentMeal)" class="bg-blue-500 text-white px-5 py-2 rounded-xl font-bold hover:bg-blue-600 transition-colors mr-3">
                        üîÑ Shuffle Details
                    </button>
                    <button onclick="backToMenu()" class="bg-gray-500 text-white px-5 py-2 rounded-xl font-bold hover:bg-gray-600 transition-colors">
                        ‚Üê Back to Menu
                    </button>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-6">
                <div class="bg-white/95 backdrop-filter backdrop-blur-lg rounded-3xl p-5 shadow-2xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center" id="menuTitle">Today's Menu</h2>
                    <div class="grid md:grid-cols-2 gap-4" id="menuItems"></div>
                </div>

                <div class="bg-white/95 backdrop-filter backdrop-blur-lg rounded-3xl p-5 shadow-2xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">üí¨ Interactive Dialogue</h2>
                    <div id="dialogueBox" class="h-96 overflow-y-auto bg-gray-50 rounded-2xl p-3"></div>
                    <div class="text-center mt-5">
                        <button id="startDialogueBtn" onclick="startDialogue()" class="bg-purple-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-purple-600 transition-colors text-lg">
                            ‚ñ∂Ô∏è Start Conversation
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =================================================================================
        // --- 1. GLOBAL STATE & DATA ---
        // =================================================================================
        let currentMeal = '';
        let currentMenu = [];
        let currentStaff = {};
        let currentTimes = {};
        let dialogueScript = [];
        let currentDialogueLine = 0;

        const restaurantData = {
             breakfast: {
                icon: 'üåÖ',
                baseHour: 7,
                items: [
                    { name: 'Classic Pancakes', emoji: 'ü•û', price: 9.99, description: 'Fluffy pancakes with maple syrup and berries' },
                    { name: 'Bagel with Lox', emoji: 'ü•Ø', price: 13.50, description: 'Toasted bagel with cream cheese and smoked salmon' },
                    { name: 'Greek Yogurt Parfait', emoji: 'ü•ó', price: 7.99, description: 'Layered with granola, honey, and fresh fruit' },
                    { name: 'Full English Breakfast', emoji: 'ü•ì', price: 15.00, description: 'Eggs, bacon, sausage, beans, and toast' },
                    { name: 'Breakfast Tacos', emoji: 'üåÆ', price: 11.50, description: 'Scrambled eggs, avocado, and salsa in a tortilla' },
                    { name: 'Mango Smoothie Bowl', emoji: 'ü•≠', price: 9.50, description: 'Thick mango smoothie with coconut flakes' },
                    { name: 'Coffee', emoji: '‚òï', price: 3.50, description: 'Freshly brewed coffee' },
                    { name: 'Orange Juice', emoji: 'üßÉ', price: 4.00, description: 'Freshly squeezed orange juice' }
                ]
            },
            lunch: {
                icon: '‚òÄÔ∏è',
                baseHour: 12,
                items: [
                    { name: 'Grilled Cheese & Soup', emoji: 'üßÄ', price: 12.00, description: 'Classic grilled cheese with a bowl of tomato soup' },
                    { name: 'Hummus Bowl', emoji: 'ü•ô', price: 11.75, description: 'Mediterranean hummus with pita, olives, and veggies' },
                    { name: 'Chicken Caesar Wrap', emoji: 'üåØ', price: 12.50, description: 'Grilled chicken and caesar salad in a tortilla wrap' },
                    { name: 'Ramen', emoji: 'üçú', price: 15.50, description: 'Pork broth ramen with a soft-boiled egg' },
                    { name: 'Sushi Rolls', emoji: 'üç£', price: 16.00, description: 'A selection of fresh sushi rolls with miso soup' },
                    { name: 'Ceviche', emoji: 'üê†', price: 14.50, description: 'Fresh fish cured in citrus juices with onion' },
                    { name: 'Calamari Fritti', emoji: 'ü¶ë', price: 13.00, description: 'Lightly fried squid rings with marinara sauce' },
                    { name: 'Iced Tea', emoji: 'üçπ', price: 3.75, description: 'Refreshing iced tea with lemon' },
                ]
            },
            dinner: {
                icon: 'üåô',
                baseHour: 18,
                items: [
                    { name: 'Dijon Baked Salmon', emoji: 'üêü', price: 22.99, description: 'Baked salmon with roasted vegetables' },
                    { name: 'Spaghetti Carbonara', emoji: 'üçù', price: 19.00, description: 'Classic pasta with eggs, cheese, and pancetta' },
                    { name: 'Chicken Fajitas', emoji: 'üåÆ', price: 20.50, description: 'Sizzling chicken with peppers and onions' },
                    { name: 'Steak with Potatoes', emoji: 'ü•©', price: 28.50, description: '12oz steak with garlic mashed potatoes' },
                    { name: 'Chicken Tikka Masala', emoji: 'üçõ', price: 21.00, description: 'Creamy tomato curry with chicken and naan' },
                    { name: 'Shrimp Scampi', emoji: 'ü¶ê', price: 23.50, description: 'Shrimp in garlic and white wine sauce over pasta' },
                    { name: 'Oysters Rockefeller', emoji: 'ü¶™', price: 18.00, description: 'Oysters baked with butter, herbs, and breadcrumbs' },
                    { name: 'Lobster Thermidor', emoji: 'ü¶û', price: 35.00, description: 'Creamy mixture of cooked lobster meat and brandy' },
                    { name: 'Red Wine', emoji: 'üç∑', price: 9.00, description: 'A glass of our house red' }
                ]
            }
        };

        const staffMembers = [
            { name: 'Ava', role: 'Waitress', voiceKey: 'en-US-Ava', flag: 'üá∫üá∏' },
            { name: 'Andrew', role: 'Waiter', voiceKey: 'en-US-Andrew', flag: 'üá∫üá∏' },
            { name: 'Jean-Pierre', role: 'Waiter', voiceKey: 'fr-FR', flag: 'üá´üá∑'},
            { name: 'Sofia', role: 'Waitress', voiceKey: 'es-ES', flag: 'üá™üá∏'},
            { name: 'Wei', role: 'Waiter', voiceKey: 'zh-CN', flag: 'üá®üá≥'},
            { name: 'Liam', role: 'Waiter', voiceKey: 'en-AU', flag: 'üá¶üá∫' }
        ];
        
        const staffScripts = {
            'fr-FR': { english: "Welcome! You should try our special!", native: "Bonjour! C'est d√©licieux, je vous le recommande!"},
            'es-ES': { english: "Hello! Our special today is a great choice!", native: "¬°Hola! ¬°Nuestra especialidad de hoy es una opci√≥n fant√°stica!"},
            'zh-CN': { english: "Welcome! I think you will really like the special.", native: "Ê¨¢Ëøé! ÊàëËßâÂæó‰Ω†‰∏ÄÂÆö‰ºöÂñúÊ¨¢Ëøô‰∏™ÁâπÂà´Êé®Ëçê„ÄÇ"},
            'en-AU': { english: "G'day, mate! The special is a real beauty today.", native: "You'll love it, I reckon!"},
            'en-US-Ava': { english: "Welcome! I highly recommend our special today!", native: ""},
            'en-US-Andrew': { english: "Hello there! Our special is a fantastic choice today!", native: ""}
        };

        const specialOffers = [ '10% off all main courses!', 'Free dessert with any entree', 'Happy hour: 2-for-1 drinks', '15% student discount' ];

        // =================================================================================
        // --- 2. AUDIO & SPEECH SYNTHESIS (ROBUST) ---
        // =================================================================================
        let allVoices = [];
        
        function showNotification(message) {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.opacity = 1, 10);
            setTimeout(() => {
                el.style.opacity = 0;
                setTimeout(() => el.style.display = 'none', 500);
            }, 4000);
        }

        async function getVoice(voiceKey) {
            if (allVoices.length === 0) {
                 allVoices = await new Promise(resolve => {
                    let voices = speechSynthesis.getVoices();
                    if (voices.length) return resolve(voices);
                    speechSynthesis.onvoiceschanged = () => resolve(speechSynthesis.getVoices());
                });
            }

            const parts = voiceKey.split('-');
            const lang = `${parts[0]}-${parts[1]}`;
            const name = parts[2];
            
            let voice;

            if (name) {
                voice = allVoices.find(v => v.lang === lang && v.name.includes('Microsoft') && v.name.includes(name));
            }
            if (!voice && name) {
                voice = allVoices.find(v => v.name.includes(name));
            }
            if (!voice) {
                 voice = allVoices.find(v => v.lang === lang);
            }
            if (!voice) {
                voice = allVoices.find(v => v.lang === 'en-US');
            }

            if (!voice) throw new Error(`Could not find a suitable voice for key: ${voiceKey}`);
            return voice;
        }

        async function speakText(text, voiceKey, onEndCallback = null, highlightElementId = null) {
            try {
                const voice = await getVoice(voiceKey);
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = voice;
                utterance.lang = voice.lang;
                utterance.rate = 0.85;

                const highlightElement = document.getElementById(highlightElementId);
                if (highlightElement) {
                    utterance.onboundary = (event) => {
                        if (event.name === 'word') {
                            const start = event.charIndex;
                            let end = text.indexOf(' ', start);
                            if (end === -1) end = text.length;
                            highlightElement.innerHTML = `"${text.substring(0, start)}<mark>${text.substring(start, end)}</mark>${text.substring(end)}"`;
                        }
                    };
                    utterance.onend = () => {
                        highlightElement.innerHTML = `"${text}"`;
                        if (onEndCallback) onEndCallback();
                    };
                } else {
                    if (onEndCallback) utterance.onend = onEndCallback;
                }
                
                speechSynthesis.cancel();
                speechSynthesis.speak(utterance);
            } catch (err) {
                showNotification(err.message);
                if (onEndCallback) onEndCallback();
            }
        }
        
        // =================================================================================
        // --- 3. SCENARIO GENERATION & UI LOGIC ---
        // =================================================================================
        function getRandomItems(arr, count) {
            return [...arr].sort(() => 0.5 - Math.random()).slice(0, count);
        }
        
        function formatTime(hour, minute) {
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const h = hour % 12 || 12;
            const m = minute < 10 ? '0' + minute : minute;
            return `${h}:${m} ${ampm}`;
        }

        function generateScenario(mealType) {
            currentMeal = mealType;
            const mealData = restaurantData[mealType];
            
            const minuteIncrements = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55];
            const startHour = mealData.baseHour + Math.floor(Math.random() * 2); 
            const startMinute = getRandomItems(minuteIncrements, 1)[0];
            const endHour = startHour + 4 + Math.floor(Math.random() * 2);
            const endMinute = getRandomItems(minuteIncrements, 1)[0];
            currentTimes = {
                start: formatTime(startHour, startMinute),
                end: formatTime(endHour, endMinute)
            };

            currentMenu = getRandomItems(mealData.items, Math.floor(Math.random() * 2) + 4);
            currentStaff = getRandomItems(staffMembers, 1)[0];
            const currentSpecial = getRandomItems(specialOffers, 1)[0];

            document.getElementById('mealIcon').textContent = mealData.icon;
            document.getElementById('mealType').textContent = mealType.charAt(0).toUpperCase() + mealType.slice(1);
            
            document.getElementById('staffFlag').textContent = currentStaff.flag;
            document.getElementById('staffInfo').textContent = `${currentStaff.name} (${currentStaff.role})`;
           
            const timeInfoEl = document.getElementById('timeInfo');
            timeInfoEl.textContent = `${currentTimes.start} - ${currentTimes.end}`;
            document.getElementById('timeContainer').onclick = () => speakText(`We are open from ${currentTimes.start} to ${currentTimes.end}`, 'en-US-Ava');

            const specialOfferEl = document.getElementById('specialOffer');
            specialOfferEl.textContent = currentSpecial;
            document.getElementById('specialContainer').onclick = () => speakText(specialOfferEl.textContent, 'en-US-Ava');

            document.getElementById('menuTitle').textContent = `Today's ${mealType.charAt(0).toUpperCase() + mealType.slice(1)} Menu`;

            document.getElementById('menuItems').innerHTML = currentMenu.map(item => `
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 border-2 border-gray-200 cursor-pointer" data-tts="true" onclick="speakText('${item.name}. ${item.description.replace(/'/g, "\\'")}', 'en-US-Ava')">
                    <div class="flex items-start space-x-3">
                        <div class="text-3xl pt-1 floating-emoji">${item.emoji}</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800">${item.name}</h4>
                            <p class="text-xl font-bold text-green-600">$${item.price.toFixed(2)}</p>
                            <p class="text-xs text-gray-600">${item.description}</p>
                        </div>
                    </div>
                </div>
            `).join('');

            prepareInteractiveDialogue();

            document.getElementById('menuSelection').classList.add('hidden');
            document.getElementById('restaurantDetails').classList.remove('hidden');
        }

        function backToMenu() {
            document.getElementById('restaurantDetails').classList.add('hidden');
            document.getElementById('menuSelection').classList.remove('hidden');
            speechSynthesis.cancel();
        }
        
        // =================================================================================
        // --- 4. DIALOGUE LOGIC ---
        // =================================================================================
        
        function playBilingualGreeting() {
            const script = staffScripts[currentStaff.voiceKey];
            if (!script) {
                speakText(`Hello, I'm ${currentStaff.name}.`, currentStaff.voiceKey || 'en-US-Ava');
                return;
            }
            speakText(script.english, 'en-US-Ava', () => {
                if(script.native) {
                    setTimeout(() => speakText(script.native, currentStaff.voiceKey), 300);
                }
            });
        }
        
        function prepareInteractiveDialogue() {
            const customerVoiceKey = getRandomItems(['en-US-Ava', 'en-US-Andrew', 'en-US-Emma'], 1)[0];
            let randomFood = getRandomItems(currentMenu.filter(i => i.price > 10), 1)[0];
            let randomDrink = getRandomItems(currentMenu.filter(i => i.price <= 5), 1)[0];

            if (!randomFood || !randomDrink || randomFood.name === randomDrink.name) {
                const distinctItems = [...new Set(currentMenu)];
                if (distinctItems.length >= 2) {
                    const twoItems = getRandomItems(distinctItems, 2);
                    randomFood = twoItems[0].price > twoItems[1].price ? twoItems[0] : twoItems[1];
                    randomDrink = twoItems[0].price > twoItems[1].price ? twoItems[1] : twoItems[0];
                } else {
                    randomFood = currentMenu[0];
                    randomDrink = currentMenu[0] || currentMenu[0];
                }
            }
            const totalPrice = randomFood.price + randomDrink.price;

            dialogueScript = [
                { speaker: currentStaff.role, name: currentStaff.name, text: `Hello! I'm ${currentStaff.name}. Can I start you with a drink?`, voiceKey: 'en-US-Brian' },
                { speaker: 'Customer', name: 'You', text: `Yes, I'll have the ${randomDrink.name}, please.`, voiceKey: customerVoiceKey },
                { speaker: currentStaff.role, name: currentStaff.name, text: `Excellent choice. And are you ready to order your meal?`, voiceKey: 'en-US-Brian' },
                { speaker: 'Customer', name: 'You', text: `I am. I'll have the ${randomFood.name}.`, voiceKey: customerVoiceKey },
                { speaker: currentStaff.role, name: currentStaff.name, text: `Perfect. Just so you know, our special today is ${document.getElementById('specialOffer').textContent}`, voiceKey: 'en-US-Brian' },
                { speaker: 'Customer', name: 'You', text: `Oh, that sounds good! Maybe next time.`, voiceKey: customerVoiceKey },
                { speaker: currentStaff.role, name: currentStaff.name, text: `I'll have that right out for you.`, voiceKey: 'en-US-Brian' },
                { speaker: 'Customer', name: 'You', text: `Excuse me, could we get the check, please?`, voiceKey: customerVoiceKey },
                { speaker: currentStaff.role, name: currentStaff.name, text: `Certainly. Your total is $${totalPrice.toFixed(2)}.`, voiceKey: 'en-US-Brian' },
                { speaker: 'Customer', name: 'You', text: `Thank you for the great service!`, voiceKey: customerVoiceKey }
            ];

            const dialogueBox = document.getElementById('dialogueBox');
            dialogueBox.innerHTML = dialogueScript.map((line, index) => `
                <div class="dialogue-bubble ${line.speaker.toLowerCase().includes('wait') || line.speaker.toLowerCase().includes('owner') ? 'staff-bubble' : 'customer-bubble'} cursor-pointer" id="line-${index}" data-tts="true" onclick="speakTextWithHighlight(${index})">
                    <div class="flex items-start space-x-3">
                        <div class="text-2xl floating-emoji">${line.speaker.toLowerCase().includes('wait') || line.speaker.toLowerCase().includes('owner') ? 'üë®‚Äçüç≥' : 'üë§'}</div>
                        <div>
                            <p class="font-semibold text-gray-800 mb-1">${line.name}</p>
                            <p class="text-black" id="line-text-${index}">"${line.text}"</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('startDialogueBtn').disabled = false;
        }

        function speakTextWithHighlight(index) {
            const line = dialogueScript[index];
            speakText(line.text, line.voiceKey, null, `line-text-${index}`);
        }

        function startDialogue() {
            currentDialogueLine = 0;
            document.getElementById('startDialogueBtn').disabled = true;
            playNextLine();
        }

        function playNextLine() {
            if (currentDialogueLine >= dialogueScript.length) {
                document.getElementById('startDialogueBtn').disabled = false;
                speakText("Practice complete! Feel free to shuffle the details or start a new scenario.", 'en-US-Ava');
                document.querySelectorAll('.dialogue-bubble').forEach(el => el.classList.remove('active'));
                return;
            }

            document.querySelectorAll('.dialogue-bubble').forEach(el => el.classList.remove('active'));
            const lineElement = document.getElementById(`line-${currentDialogueLine}`);
            lineElement.classList.add('active');
            lineElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            const line = dialogueScript[currentDialogueLine];
            const onEnd = () => {
                currentDialogueLine++;
                setTimeout(playNextLine, 800);
            };
            speakText(line.text, line.voiceKey, onEnd, `line-text-${currentDialogueLine}`);
        }
        
        // =================================================================================
        // --- 5. VISUAL EFFECTS ---
        // =================================================================================

        function startEmojiRain() {
            const container = document.getElementById('emoji-rain-container');
            const emojis = ['ü•û', 'üç≥', 'ü•ë', 'üçû', 'ü•ó', 'ü•™', 'üåÆ', 'üçï', 'üêü', 'ü•©', 'üçó', 'ü¶û', '‚òï', 'üçπ', 'üç∑', 'üçì', 'üçé', 'üçí', 'üçá'];
            
            setInterval(() => {
                if(document.hidden) return; // Pause if tab is not active
                const emojiEl = document.createElement('div');
                emojiEl.classList.add('emoji-rain');
                emojiEl.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emojiEl.style.left = Math.random() * 100 + 'vw';
                emojiEl.style.fontSize = Math.random() * 1.5 + 1 + 'rem';
                const duration = Math.random() * 8 + 10;
                emojiEl.style.animationDuration = duration + 's';
                
                container.appendChild(emojiEl);

                setTimeout(() => {
                    emojiEl.remove();
                }, duration * 1000);
            }, 500);
        }

        function createSparkle(x, y) {
            const sparkle = document.createElement('div');
            sparkle.classList.add('sparkle');
            
            const offsetX = (Math.random() - 0.5) * 40;
            const offsetY = (Math.random() - 0.5) * 40;
            
            sparkle.style.left = `${x + offsetX}px`;
            sparkle.style.top = `${y + offsetY}px`;
            
            document.body.appendChild(sparkle);
            
            setTimeout(() => {
                sparkle.remove();
            }, 600);
        }
        
        document.addEventListener('click', function(e) {
            if (e.target.closest('[data-tts="true"]')) {
                for (let i = 0; i < 8; i++) {
                    createSparkle(e.clientX, e.clientY);
                }
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            loadVoices();
            startEmojiRain();
        });
        
    </script>
</body>
</html>
