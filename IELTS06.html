<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Listening Practice</title>
    <style>
        :root {
            --primary: #005a9e;
            --bg: #f3f2f1;
            --paper: #ffffff;
            --text: #201f1e;
            --active-tab: #004578;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 5px;
            font-size: 14px;
            line-height: 1.3;
        }
        .container {
            max-width: 950px; 
            margin: 0 auto;
            background: var(--paper);
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 95vh;
        }
        
        /* Compact Header with Integrated Buttons */
        .header-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 100;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
            align-items: center;
        }
        
        .section-btn {
            background: #e1dfdd;
            color: #333;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            flex: 1;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .section-btn:hover { background: #d0d0d0; }
        .section-btn.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .play-icon { font-size: 0.8em; }

        /* Content Area */
        h2 { 
            color: var(--primary); 
            font-size: 1.1rem; 
            margin: 0 0 8px 0; 
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }
        h3 { margin: 6px 0 4px 0; font-size: 1rem; color: #444; }
        p { margin: 4px 0; }
        
        .test-section { display: none; animation: fadeIn 0.2s ease-in; }
        .test-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .question-block {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #faf9f8;
            border-left: 3px solid #ddd;
        }
        
        label { display: block; margin-bottom: 2px; cursor: pointer; font-size: 0.9rem; }
        
        /* Default Inputs */
        input[type="text"], input[type="number"] {
            padding: 3px 6px;
            border: 1px solid #999;
            border-radius: 3px;
            width: 140px;
            font-size: 0.9rem;
        }
        input[type="text"]:focus { border-color: var(--primary); outline: none; }
        
        .mcq-option { padding: 2px 5px; border-radius: 3px; }
        .mcq-option:hover { background: #f0f0f0; }

        /* GRID LAYOUT FOR MCQS (Sections 2 & 3) */
        .mcq-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px;
            margin-bottom: 15px;
        }
        .mcq-grid .question-block {
            margin-bottom: 0;
            height: 100%; 
            box-sizing: border-box;
            font-size: 0.9rem;
        }
        @media(max-width: 700px) {
            .mcq-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media(max-width: 500px) {
            .mcq-grid { grid-template-columns: 1fr; }
        }

        /* LARGE FONT FOR SECTIONS 1 & 4 */
        .large-font-section .question-block {
            font-size: 1.15rem; 
            line-height: 1.6;
        }
        .large-font-section input[type="text"], 
        .large-font-section input[type="number"] {
            font-size: 1.1rem;
            padding: 5px 8px;
            width: 180px; 
        }
        .large-font-section h3 { font-size: 1.2rem; }

        /* Results & Transcript */
        .feedback { display: none; margin-left: 8px; font-weight: bold; font-size: 0.85em; }
        .correct { color: #107c10; }
        .incorrect { color: #a80000; }
        
        #transcript-container {
            margin-top: 15px;
            padding: 10px;
            background: #f8f8f8;
            display: none;
            border: 1px solid #ddd;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        .script-line { margin-bottom: 4px; color: #555; }
        
        .action-bar {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
            display: flex;
            gap: 10px;
        }
        .check-btn {
            background: #107c10;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .check-btn:hover { background: #0b5a0b; }
        .secondary-btn {
            background: #605e5c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    
    <!-- Integrated Header -->
    <div class="header-controls">
        <button class="section-btn" style="flex: 0 0 auto; background: #333; color: white;" onclick="calculateFinalScore()">
            Final Score
        </button>
        <button class="section-btn active" onclick="playSection(1)">
            <span class="play-icon">▶</span> Section 1
        </button>
        <button class="section-btn" onclick="playSection(2)">
            <span class="play-icon">▶</span> Section 2
        </button>
        <button class="section-btn" onclick="playSection(3)">
            <span class="play-icon">▶</span> Section 3
        </button>
        <button class="section-btn" onclick="playSection(4)">
            <span class="play-icon">▶</span> Section 4
        </button>
        <button class="section-btn" style="flex: 0 0 auto; background: #a80000; color: white;" onclick="stopAudio()" title="Stop Audio">
            ■
        </button>
    </div>

    <form id="test-form" onsubmit="return false;">
        
        <!-- SECTION 1 (Large Font) -->
        <div id="sec-1" class="test-section active large-font-section">
            <h2>Section 1: Rental Enquiry</h2>
            <div class="question-block">
                <h3>Notes: Rental Form</h3>
                <p>1. Tenant has sold several <input type="text" id="q1" class="ans-input" data-key="paintings"> <span class="feedback" id="fb-q1"></span></p>
                <p>2. Preferred Location: Near the <input type="text" id="q2" class="ans-input" data-key="uptown"> area. <span class="feedback" id="fb-q2"></span></p>
                <p>3. Transport: Within <input type="text" id="q3" class="ans-input" data-key="biking"> distance. <span class="feedback" id="fb-q3"></span></p>
                <p>4. House 2 Rent: $<input type="number" id="q4" class="ans-input" data-key="650"> <span class="feedback" id="fb-q4"></span></p>
                <p>5. Address: 1566 <input type="text" id="q5" class="ans-input" data-key="honeysuckle"> Drive. <span class="feedback" id="fb-q5"></span></p>
            </div>
            <div class="question-block">
                <h3>House Condition</h3>
                <p>6. Several <input type="text" id="q6" class="ans-input" data-key="windows"> are broken. <span class="feedback" id="fb-q6"></span></p>
                <p>7. Washing clothes by <input type="text" id="q7" class="ans-input" data-key="hand">. <span class="feedback" id="fb-q7"></span></p>
                <p>8. The <input type="text" id="q8" class="ans-input" data-key="tiles"> in the kitchen are broken. <span class="feedback" id="fb-q8"></span></p>
                <p>9. The tenant will speak to the <input type="text" id="q9" class="ans-input" data-key="landlord">. <span class="feedback" id="fb-q9"></span></p>
                <p>10. Move in: As soon as <input type="text" id="q10" class="ans-input" data-key="ready">. <span class="feedback" id="fb-q10"></span></p>
            </div>
        </div>

        <!-- SECTION 2 (MCQ Grid + Normal Directions) -->
        <div id="sec-2" class="test-section">
            <h2>Section 2: Ironbridge Excursion</h2>
            
            <div class="mcq-grid">
                <div class="question-block">
                    <p><strong>11.</strong> Why recommend the excursion?</p>
                    <label class="mcq-option"><input type="radio" name="q11" value="A"> A. Mandatory course</label>
                    <label class="mcq-option"><input type="radio" name="q11" value="B" data-key="B"> B. Relaxed way to meet</label>
                    <label class="mcq-option"><input type="radio" name="q11" value="C"> C. Discount available</label>
                    <span class="feedback" id="fb-q11"></span>
                </div>
                <div class="question-block">
                    <p><strong>12.</strong> How will the group travel?</p>
                    <label class="mcq-option"><input type="radio" name="q12" value="A" data-key="A"> A. Bus and staff cars</label>
                    <label class="mcq-option"><input type="radio" name="q12" value="B"> B. Train</label>
                    <label class="mcq-option"><input type="radio" name="q12" value="C"> C. Private vehicles</label>
                    <span class="feedback" id="fb-q12"></span>
                </div>
                <div class="question-block">
                    <p><strong>13.</strong> Problem with the list?</p>
                    <label class="mcq-option"><input type="radio" name="q13" value="A"> A. It gets lost</label>
                    <label class="mcq-option"><input type="radio" name="q13" value="B"> B. Missing numbers</label>
                    <label class="mcq-option"><input type="radio" name="q13" value="C" data-key="C"> C. Signatures hard to read</label>
                    <span class="feedback" id="fb-q13"></span>
                </div>
                <div class="question-block">
                    <p><strong>14.</strong> Lunch arrangement?</p>
                    <label class="mcq-option"><input type="radio" name="q14" value="A"> A. Bring packed lunch</label>
                    <label class="mcq-option"><input type="radio" name="q14" value="B"> B. Free sandwiches</label>
                    <label class="mcq-option"><input type="radio" name="q14" value="C" data-key="C"> C. Restaurant 15% off</label>
                    <span class="feedback" id="fb-q14"></span>
                </div>
                 <div class="question-block">
                    <p><strong>15.</strong> Deadline for signing up?</p>
                    <label class="mcq-option"><input type="radio" name="q15" value="A"> A. Tuesday morning</label>
                    <label class="mcq-option"><input type="radio" name="q15" value="B" data-key="B"> B. Saturday 6:00 PM</label>
                    <label class="mcq-option"><input type="radio" name="q15" value="C"> C. Monday afternoon</label>
                    <span class="feedback" id="fb-q15"></span>
                </div>
            </div>

            <div class="question-block">
                <h3>Campus Directions</h3>
                <p>16. Garage is behind the <input type="text" id="q16" class="ans-input" data-key="engineering workshop">. <span class="feedback" id="fb-q16"></span></p>
                <p>17. Pass the Child Care Center on your <input type="text" id="q17" class="ans-input" data-key="left">. <span class="feedback" id="fb-q17"></span></p>
                <p>18. Pass the Sports Center and <input type="text" id="q18" class="ans-input" data-key="tennis courts">. <span class="feedback" id="fb-q18"></span></p>
                <p>19. Cross over <input type="text" id="q19" class="ans-input" data-key="central square">. <span class="feedback" id="fb-q19"></span></p>
                <p>20. Bring a <input type="text" id="q20" class="ans-input" data-key="warm jacket/umbrella/jacket">. <span class="feedback" id="fb-q20"></span></p>
            </div>
        </div>

        <!-- SECTION 3 (MCQ Grid + Normal Notes) -->
        <div id="sec-3" class="test-section">
            <h2>Section 3: Amazon Conservation</h2>
            
            <div class="mcq-grid">
                <div class="question-block">
                    <p><strong>21.</strong> Current situation?</p>
                    <label class="mcq-option"><input type="radio" name="q21" value="A"> A. Entirely negative</label>
                    <label class="mcq-option"><input type="radio" name="q21" value="B" data-key="B"> B. Mixed threats/progress</label>
                    <label class="mcq-option"><input type="radio" name="q21" value="C"> C. Improving rapidly</label>
                    <span class="feedback" id="fb-q21"></span>
                </div>
                <div class="question-block">
                    <p><strong>22.</strong> Why "Critical Size" project?</p>
                    <label class="mcq-option"><input type="radio" name="q22" value="A" data-key="A"> A. Didn't know area size</label>
                    <label class="mcq-option"><input type="radio" name="q22" value="B"> B. Land loss</label>
                    <label class="mcq-option"><input type="radio" name="q22" value="C"> C. No funding</label>
                    <span class="feedback" id="fb-q22"></span>
                </div>
                <div class="question-block">
                    <p><strong>23.</strong> Fragmented forests?</p>
                    <label class="mcq-option"><input type="radio" name="q23" value="A"> A. Trees grow faster</label>
                    <label class="mcq-option"><input type="radio" name="q23" value="B" data-key="B"> B. Shed species diversity</label>
                    <label class="mcq-option"><input type="radio" name="q23" value="C"> C. Fire resistant</label>
                    <span class="feedback" id="fb-q23"></span>
                </div>
                <div class="question-block">
                    <p><strong>24.</strong> Policy response?</p>
                    <label class="mcq-option"><input type="radio" name="q24" value="A"> A. Build fences</label>
                    <label class="mcq-option"><input type="radio" name="q24" value="B" data-key="B"> B. Reconnect fragments</label>
                    <label class="mcq-option"><input type="radio" name="q24" value="C"> C. Ignore small areas</label>
                    <span class="feedback" id="fb-q24"></span>
                </div>
                <div class="question-block">
                    <p><strong>25.</strong> 1969 analysis found?</p>
                    <label class="mcq-option"><input type="radio" name="q25" value="A"> A. New insects</label>
                    <label class="mcq-option"><input type="radio" name="q25" value="B"> B. Soil degradation</label>
                    <label class="mcq-option"><input type="radio" name="q25" value="C" data-key="C"> C. Bird clusters</label>
                    <span class="feedback" id="fb-q25"></span>
                </div>
                <div class="question-block">
                    <p><strong>26.</strong> GIS usage started?</p>
                    <label class="mcq-option"><input type="radio" name="q26" value="A"> A. 1969</label>
                    <label class="mcq-option"><input type="radio" name="q26" value="B" data-key="B"> B. 1990</label>
                    <label class="mcq-option"><input type="radio" name="q26" value="C"> C. 2000</label>
                    <span class="feedback" id="fb-q26"></span>
                </div>
            </div>
            
            <div class="question-block">
                <h3>GIS Advantages</h3>
                <p>27. Updates: Allows for a <input type="text" id="q27" class="ans-input" data-key="changing"> picture. <span class="feedback" id="fb-q27"></span></p>
                <p>28. Data includes vectors like <input type="text" id="q28" class="ans-input" data-key="roads/railroads">. <span class="feedback" id="fb-q28"></span></p>
                <p>29. It is <input type="text" id="q29" class="ans-input" data-key="accessible"> to everyone. <span class="feedback" id="fb-q29"></span></p>
                <p>30. Available on the <input type="text" id="q30" class="ans-input" data-key="internet">. <span class="feedback" id="fb-q30"></span></p>
            </div>
        </div>

        <!-- SECTION 4 (Large Font) -->
        <div id="sec-4" class="test-section large-font-section">
            <h2>Section 4: Tower Bridge</h2>
            <div class="question-block">
                <h3>History & Design</h3>
                <p>31. The bridge is just over <input type="text" id="q31" class="ans-input" data-key="100/one hundred"> years old. <span class="feedback" id="fb-q31"></span></p>
                <p>32. Built due to traffic from tall <input type="text" id="q32" class="ans-input" data-key="ships">. <span class="feedback" id="fb-q32"></span></p>
                <p>33. Must not look like a <input type="text" id="q33" class="ans-input" data-key="modern"> bridge. <span class="feedback" id="fb-q33"></span></p>
                <p>34. Took <input type="text" id="q34" class="ans-input" data-key="8/eight"> years to build. <span class="feedback" id="fb-q34"></span></p>
                <p>35. Opens twice a <input type="text" id="q35" class="ans-input" data-key="week"> now. <span class="feedback" id="fb-q35"></span></p>
                <p>36. Original colorful <input type="text" id="q36" class="ans-input" data-key="wheels"> are still used. <span class="feedback" id="fb-q36"></span></p>
                <p>37. The <input type="text" id="q37" class="ans-input" data-key="walkways"> were closed years ago. <span class="feedback" id="fb-q37"></span></p>
                <h3>Future Plans</h3>
                <p>38. There will be a special <input type="text" id="q38" class="ans-input" data-key="exhibition">. <span class="feedback" id="fb-q38"></span></p>
                <p>39. One tower will have a <input type="text" id="q39" class="ans-input" data-key="pub">. <span class="feedback" id="fb-q39"></span></p>
                <p>40. Symbol of <input type="text" id="q40" class="ans-input" data-key="London">. <span class="feedback" id="fb-q40"></span></p>
            </div>
        </div>

        <div class="action-bar">
            <button class="check-btn" onclick="checkAnswers()">Check Section Answers</button>
            <button class="secondary-btn" onclick="toggleTranscript()">Transcript</button>
        </div>

    </form>
    <div id="transcript-container"></div>
</div>

<script>
    // --- 1. TRANSCRIPT DATA ---
    const script = [
        // SECTION 1
        { s:1, t: "Section 1. Conversation between an agent and a student.", v: "Narrator" },
        { s:1, t: "Good afternoon. Do you rent apartments here?", v: "Andrew" },
        { s:1, t: "Yes. Are you looking to rent?", v: "Emma" },
        { s:1, t: "Maybe a house actually. Do you rent those?", v: "Andrew" },
        { s:1, t: "Yes. Will you be renting alone?", v: "Emma" },
        { s:1, t: "No, two friends will live with me. But I'm the primary renter. I'm an artist and I've already sold a number of paintings.", v: "Andrew" },
        { s:1, t: "Oh, so you want to be near the uptown area? That's where most galleries are.", v: "Emma" },
        { s:1, t: "Yes. I don't have a car, so I prefer being within biking distance.", v: "Andrew" },
        { s:1, t: "There's a large four bedroom house right off Main Street.", v: "Emma" },
        { s:1, t: "How much is it per month?", v: "Andrew" },
        { s:1, t: "Around 950 dollars.", v: "Emma" },
        { s:1, t: "Ouch. Too much. Anything cheaper?", v: "Andrew" },
        { s:1, t: "I have a three bedroom. That's for 650 dollars.", v: "Emma" },
        { s:1, t: "That is affordable, but I wanted one extra room. Anything else?", v: "Andrew" },
        { s:1, t: "Here's a 5 bedroom. It's further away, but they're only asking 800 dollars.", v: "Emma" },
        { s:1, t: "That price is okay. Address?", v: "Andrew" },
        { s:1, t: "1566 Honeysuckle Drive. Wood Heights.", v: "Emma" },
        { s:1, t: "Is it furnished?", v: "Andrew" },
        { s:1, t: "Partially. But take a look at this list.", v: "Emma" },
        { s:1, t: "(Pause) Hi, you're back. How was it?", v: "Emma" },
        { s:1, t: "A lot, but I know why it's low. A couple of windows are broken.", v: "Andrew" },
        { s:1, t: "I'll get a work crew out there today.", v: "Emma" },
        { s:1, t: "Did they have a washer and dryer?", v: "Andrew" },
        { s:1, t: "No.", v: "Emma" },
        { s:1, t: "I can wash clothes by hand until I find used ones. But the tiles in the kitchen floor were broken.", v: "Andrew" },
        { s:1, t: "Okay, I'll talk to the landlord.", v: "Emma" },
        { s:1, t: "If you can do those things, I'll take it as soon as you're ready.", v: "Andrew" },

        // SECTION 2
        { s:2, t: "Section 2. Overseas student officer talking about an excursion.", v: "Narrator" },
        { s:2, t: "Hello everyone, my name is Pamela Sutcliffe. Next Tuesday, the 28th, we have arranged an excursion to Ironbridge. We hope you'll come because it is a relaxed and fun way to get to know each other.", v: "Eva" },
        { s:2, t: "Ironbridge is 55 kilometers away. We will be traveling by the college bus. If we need extra transport, we will use staff cars.", v: "Eva" },
        { s:2, t: "Please sign the list on the notice board. Please print your name clearly, I often can't read signatures.", v: "Eva" },
        { s:2, t: "Regarding lunch, there is a nice restaurant in Ironbridge which gives a 15 percent discount to the college.", v: "Eva" },
        { s:2, t: "Please sign up by Saturday at 6 pm at the latest.", v: "Eva" },
        { s:2, t: "The college bus garage is behind the engineering workshop. To get there, walk east until you get to the Child Care Center on your left. Turn left, walk past the Sports Center and Tennis courts. Cross over Central Square and opposite you is the Engineering Workshop.", v: "Eva" },
        { s:2, t: "Please wear comfortable shoes, and bring a warm jacket and umbrella if the weather changes.", v: "Eva" },
        
        // SECTION 3
        { s:3, t: "Section 3. A conversation on rivers.", v: "Narrator" },
        { s:3, t: "Tell me about the current state of the Amazon.", v: "Brian" },
        { s:3, t: "We have increased deforestation. But also progress. It is a mix of both good and bad.", v: "Emma" },
        { s:3, t: "You started the Minimum Critical Size of Ecosystems project?", v: "Brian" },
        { s:3, t: "Yes. Conservationists didn't know how big areas had to be.", v: "Emma" },
        { s:3, t: "Talk about forest fragmentation.", v: "Brian" },
        { s:3, t: "As habitats are destroyed, the fragments shed species. One policy response is to try and reconnect the fragments.", v: "Emma" },
        { s:3, t: "Was this when people began prioritizing refuges?", v: "Brian" },
        { s:3, t: "Yes. One clue was an analysis in 1969 regarding bird species finding geographic clusters.", v: "Emma" },
        { s:3, t: "What are advantages of GIS, which started in 1990?", v: "Brian" },
        { s:3, t: "First, you can update the system so it's a constantly changing picture. Second, you can include large amounts of data like roads. Finally, because it is accessible on the internet, anyone can see it.", v: "Emma" },

        // SECTION 4
        { s:4, t: "Section 4. Tower Bridge.", v: "Narrator" },
        { s:4, t: "Tower bridge is located in London. It is just over 100 years old. It was proposed in 1850 because of the tall ships.", v: "Andrew" },
        { s:4, t: "Designers had two problems. One: it must look like the old tower. Two: it must not look like a modern bridge.", v: "Andrew" },
        { s:4, t: "The bridge took 8 years to build. Today it opens perhaps only twice a week. The colorful wheels and engines are still in good condition.", v: "Andrew" },
        { s:4, t: "Things are changing. The walkways were closed years ago. In the future, there will be a special exhibition. There will be a restaurant in one tower and a pub in the other. But Tower Bridge will always mean London.", v: "Andrew" }
    ];

    // --- 2. TTS ENGINE ---
    const synth = window.speechSynthesis;
    let isPlaying = false;
    let currentSection = 0;
    let currentIndex = 0;
    let utterance = null;
    let voices = [];

    const voiceMap = {
        "Narrator": "Microsoft Brian Online (Natural)", 
        "Andrew": "Microsoft Andrew Online (Natural)",
        "Emma": "Microsoft Emma Online (Natural)",
        "Eva": "Microsoft Eva Online (Natural)",
        "Brian": "Microsoft Brian Online (Natural)"
    };

    function loadVoices() {
        voices = synth.getVoices();
    }

    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = loadVoices;
    }

    function getVoice(name) {
        const targetName = voiceMap[name] || name;
        let found = voices.find(v => v.name.includes(targetName));
        if (!found) found = voices.find(v => v.lang === 'en-US' && v.name.includes('Natural'));
        if (!found) found = voices.find(v => v.lang.startsWith('en'));
        return found;
    }

    function playSection(secNum) {
        stopAudio();
        
        document.querySelectorAll('.test-section').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.section-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`sec-${secNum}`).classList.add('active');
        // Because of the 'Final Score' button at index 0, section buttons are now indices 1-4
        // secNum 1 is at index 1
        const allBtns = document.querySelectorAll('.section-btn');
        // allBtns[0] is Final Score
        // allBtns[1] is Sec 1
        if(allBtns[secNum]) allBtns[secNum].classList.add('active');

        currentSection = secNum;
        currentIndex = script.findIndex(line => line.s === secNum);
        
        if (currentIndex !== -1) {
            isPlaying = true;
            if (voices.length === 0) loadVoices();
            playNext();
        }
    }

    function playNext() {
        if (!isPlaying || currentIndex >= script.length) {
            isPlaying = false;
            return;
        }

        const line = script[currentIndex];
        
        if (line.s !== currentSection) {
            isPlaying = false;
            return; 
        }

        utterance = new SpeechSynthesisUtterance(line.t);
        utterance.voice = getVoice(line.v);
        utterance.rate = 1.0; 

        utterance.onend = function() {
            if (isPlaying) {
                currentIndex++;
                setTimeout(playNext, 500); 
            }
        };

        synth.speak(utterance);
    }

    function stopAudio() {
        synth.cancel();
        isPlaying = false;
    }

    // --- 3. UI LOGIC ---
    function checkAnswers() {
        // Find the active section div
        const activeDiv = document.querySelector('.test-section.active');
        if(!activeDiv) {
            alert("No section is currently active.");
            return;
        }

        // Only select inputs INSIDE the active section
        const inputs = activeDiv.querySelectorAll('input[type="text"], input[type="number"]');
        const radios = activeDiv.querySelectorAll('input[type="radio"]');

        let score = 0;
        let total = 0;

        // 1. Text Inputs
        inputs.forEach(input => {
            const key = input.getAttribute('data-key');
            if(key) {
                total++;
                const userVal = input.value.trim().toLowerCase();
                const fb = document.getElementById(`fb-${input.id}`);
                const correctKeys = key.toLowerCase().split('/');
                
                if (correctKeys.includes(userVal)) {
                    score++;
                    fb.innerHTML = "✓";
                    fb.className = "feedback correct";
                } else {
                    fb.innerHTML = `✗ (${key.split('/')[0]})`;
                    fb.className = "feedback incorrect";
                }
                fb.style.display = "inline";
            }
        });

        // 2. Radio Inputs (tricky part: find unique groups in this section)
        const radioNames = new Set();
        radios.forEach(r => radioNames.add(r.name));
        
        radioNames.forEach(name => {
            total++;
            // Find checked radio for this name inside activeDiv
            const selected = activeDiv.querySelector(`input[name="${name}"]:checked`);
            const fb = document.getElementById(`fb-${name}`);
            let correctVal = "";
            
            // Need to find correct value from one of the radios in this group
            activeDiv.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                if (r.getAttribute('data-key')) correctVal = r.value;
            });

            if (selected && selected.value === correctVal) {
                score++;
                fb.innerHTML = "✓ Correct";
                fb.className = "feedback correct";
            } else {
                fb.innerHTML = `✗ Correct: ${correctVal}`;
                fb.className = "feedback incorrect";
            }
            if(fb) fb.style.display = "block";
        });

        alert(`Section Score: ${score} out of ${total}`);
    }

    function calculateFinalScore() {
        let score = 0;
        let total = 0;

        // Check ALL text inputs
        document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
            const key = input.getAttribute('data-key');
            if(key) {
                total++;
                const userVal = input.value.trim().toLowerCase();
                const correctKeys = key.toLowerCase().split('/');
                if (correctKeys.includes(userVal)) score++;
            }
        });

        // Check ALL radio inputs
        // Get all unique names across the document
        const allRadioNames = new Set();
        document.querySelectorAll('input[type="radio"]').forEach(r => allRadioNames.add(r.name));
        
        allRadioNames.forEach(name => {
            total++;
            const selected = document.querySelector(`input[name="${name}"]:checked`);
            let correctVal = "";
            document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                if (r.getAttribute('data-key')) correctVal = r.value;
            });
            if (selected && selected.value === correctVal) score++;
        });

        alert(`Final Score: ${score} out of ${total}`);
    }

    function toggleTranscript() {
        const div = document.getElementById('transcript-container');
        if (div.style.display === 'block') {
            div.style.display = 'none';
        } else {
            div.innerHTML = script.map(s => `<div class="script-line">${s.t}</div>`).join('');
            div.style.display = 'block';
        }
    }
</script>

</body>
</html>
