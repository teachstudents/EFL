<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classroom Speaking Master</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* Base Styles */
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
      overflow: hidden;
      color: #2d3748;
    }

    /* Container */
    .app-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
      position: relative;
    }

    /* Cards/Screens */
    .screen-card {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      padding: 0.8rem;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 1600px;
      height: 98vh;
      display: none; /* Hidden by default */
      flex-direction: column;
      animation: slideIn 0.3s ease-out;
      position: relative;
    }

    .screen-card.active {
      display: flex;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Setup Screen - Student Grid Optimized */
    .student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.4rem;
      overflow-y: auto;
      padding-right: 0.2rem;
      flex-grow: 1;
    }

    .student-card {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 0.3rem; /* Very tight padding */
      display: flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
      transition: all 0.1s;
    }

    .student-card:hover { border-color: #667eea; transform: translateY(-1px); }
    .student-card.selected { background: #ebf8ff; border-color: #4299e1; }
    
    .student-avatar {
      width: 28px;
      height: 28px;
      background: #edf2f7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #4a5568;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    
    .student-name {
        font-size: 1.1rem; 
        font-weight: 800;
        color: #2d3748;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Speaking Screen Layout */
    .question-layout {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 0.5rem; 
    }

    /* Big Question Box at Top - TIGHT FIT */
    .question-box {
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      color: white;
      padding: 0.5rem; /* Minimized Padding */
      border-radius: 16px;
      font-family: 'Fredoka', sans-serif;
      text-align: center;
      box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
      position: relative;
      flex-shrink: 0; /* Don't shrink below content */
      display: flex;
      align-items: center; 
      justify-content: center;
      min-height: 15vh; /* Allow it to be smaller if text is short */
    }

    .question-text-display {
      font-size: clamp(2rem, 3.5vw, 3.5rem); /* Dynamic Font */
      line-height: 1.1;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      width: 100%;
      padding: 0 1rem; /* Minimal side padding */
    }

    /* Help Section (Word Bank) - Compact & Filled */
    .help-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr; 
      gap: 0.5rem;
      flex-grow: 1; 
      min-height: 0; 
      overflow: hidden;
    }

    .help-panel {
      background: #fff;
      border: 2px solid #edf2f7;
      border-radius: 12px;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
    }

    .help-header {
      font-family: 'Fredoka', sans-serif;
      color: #4a5568;
      font-size: 1.2rem;
      margin-bottom: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-weight: 800;
      flex-shrink: 0;
      border-bottom: 2px solid #f7fafc;
      padding-bottom: 0.2rem;
    }

    .tag-container {
      display: flex;
      flex-direction: column; /* Top down */
      gap: 0.4rem;
      overflow-y: auto;
      padding-bottom: 0.5rem;
      height: 100%;
    }

    .tag {
      background: #f7fafc;
      padding: 0.5rem 0.8rem;
      border-radius: 8px;
      border: 1px solid #cbd5e0;
      font-size: 1.2rem; 
      color: #2d3748;
      font-weight: 700;
      box-shadow: 0 2px 0 rgba(0,0,0,0.05);
      cursor: pointer;
      text-align: left;
      line-height: 1.1;
    }
    .tag:hover { background: #e2e8f0; transform: translateX(2px); }
    
    .tag.special { background: #ebf8ff; border-color: #bee3f8; color: #2b6cb0; }
    .tag.advanced { background: #f3e8ff; border-color: #d8b4fe; color: #7e22ce; }
    
    .tag.idiom {
        background: #f0fff4;
        border-color: #9ae6b4;
        color: #276749;
        font-weight: 800;
        font-style: italic;
        text-align: center;
        border-width: 2px;
        font-size: 1.3rem;
    }

    .tag.summary {
        background: #fff5f5;
        border-color: #fed7d7;
        color: #c53030;
        font-weight: 800;
        border-width: 2px;
        font-size: 1.3rem;
    }

    .section-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        color: #a0aec0;
        font-weight: 700;
        margin-top: 0.5rem;
        margin-bottom: 0.2rem;
    }

    /* Timer & Progress */
    .timer-float {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(255,255,255,0.25);
      backdrop-filter: blur(8px);
      color: white;
      padding: 0.2rem 0.8rem;
      border-radius: 50px;
      font-weight: 800;
      font-size: 1.5rem; 
      border: 2px solid rgba(255,255,255,0.5);
    }

    .part-indicator {
        position: absolute;
        top: 0.5rem;
        left: 0.8rem;
        font-size: 0.9rem;
        font-weight: 900;
        text-transform: uppercase;
        color: rgba(255,255,255,0.8);
        letter-spacing: 0.1em;
    }

    .speaker-indicator {
        position: absolute;
        bottom: 0.5rem;
        left: 0.8rem;
        font-size: 1rem;
        font-weight: 700;
        color: white;
        background: rgba(0,0,0,0.15);
        padding: 0.2rem 0.6rem;
        border-radius: 8px;
    }

    .progress-track {
      width: 100%;
      height: 10px;
      background: #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
      margin-top: auto;
      flex-shrink: 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #48bb78, #38a169);
      width: 100%;
      transition: width 1s linear;
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 2rem;
      border-radius: 16px;
      font-weight: 800;
      font-size: 1.5rem;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 15px rgba(0,0,0,0.2); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background: #cbd5e0; }

    /* Selection Screen */
    .roulette-wrapper {
      background: #2d3748;
      color: white;
      border-radius: 30px;
      padding: 4rem 2rem;
      text-align: center;
      margin: 2rem 0;
      border: 8px solid #4a5568;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
    }
    .roulette-name { font-size: 5rem; font-family: 'Fredoka', sans-serif; text-shadow: 0 4px 0 #000; }

    /* Countdown */
    .giant-countdown {
      font-size: 14rem;
      font-weight: 900;
      color: #4299e1;
      text-align: center;
      animation: pulse 1s infinite;
      font-family: 'Fredoka', sans-serif;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    /* Transition Overlay */
    #transition-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 50;
        border-radius: 24px;
    }
  </style>
 </head>
 <body>

 <div class="app-container">

  <!-- 1. SETUP SCREEN -->
  <div id="screen-setup" class="screen-card active">
    <h1 class="text-4xl font-extrabold text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-6 font-fredoka">Classroom Speaking Master</h1>
    
    <div class="grid grid-cols-3 gap-6 mb-6">
      <div class="flex flex-col">
        <label class="font-bold text-gray-600 mb-2 text-xl">üìÖ Date</label>
        <input type="date" id="date-picker" class="p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none font-bold text-gray-700 text-xl">
      </div>
      <div class="flex flex-col">
        <label class="font-bold text-gray-600 mb-2 text-xl">üè´ Grade Level</label>
        <select id="grade-select" class="p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none bg-white font-bold text-gray-700 text-xl">
            <option value="10">Grade 10</option>
            <option value="11" selected>Grade 11</option>
            <option value="12">Grade 12</option>
        </select>
      </div>
      <div class="flex flex-col">
        <label class="font-bold text-gray-600 mb-2 text-xl">üìö Topic</label>
        <select id="theme-select" class="p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none bg-white font-bold text-gray-700 text-xl">
          <!-- Populated by JS -->
        </select>
      </div>
    </div>

    <div class="flex-grow flex flex-col min-h-0">
      <div class="flex justify-between items-end mb-3">
        <h2 class="text-2xl font-bold text-gray-700">üéì Select Students</h2>
        <button onclick="selectAllStudents()" class="text-blue-600 font-bold text-xl hover:bg-blue-50 px-4 py-2 rounded">Select All</button>
      </div>
      <div id="student-grid" class="student-grid">
        <!-- Populated by JS -->
      </div>
    </div>

    <button id="btn-start" class="btn-primary mt-6" disabled>üöÄ Start Session</button>
  </div>

  <!-- 2. PREVIEW SCREEN -->
  <div id="screen-preview" class="screen-card" style="justify-content: center; text-align: center;">
    <h2 class="text-4xl font-extrabold text-gray-800 mb-8">Topic Selected</h2>
    <div class="bg-blue-50 p-10 rounded-3xl border-4 border-blue-200 mb-8 shadow-inner">
        <h1 id="preview-topic-name" class="text-7xl font-black text-blue-600 mb-6">Topic Name</h1>
        <p class="text-3xl text-gray-500 font-bold">Random Part 1, 2, or 3</p>
    </div>
    <div class="text-4xl font-bold text-red-500" id="preview-timer">Starting in 3...</div>
  </div>

  <!-- 3. SELECTION SCREEN -->
  <div id="screen-selection" class="screen-card" style="max-width: 900px; justify-content: center;">
    <h2 class="text-4xl font-extrabold text-gray-700 text-center mb-8">üé≤ Who is speaking next?</h2>
    <div class="roulette-wrapper">
      <div id="roulette-display" class="roulette-name">...</div>
    </div>
  </div>

  <!-- 4. COUNTDOWN SCREEN -->
  <div id="screen-countdown" class="screen-card" style="justify-content: center;">
    <h2 class="text-5xl font-bold text-gray-600 text-center mb-10">Get Ready!</h2>
    <div id="countdown-display" class="giant-countdown">7</div>
    <div id="next-speaker-name" class="text-5xl mt-12 font-bold text-blue-600 text-center"></div>
  </div>

  <!-- 5. SPEAKING SCREEN (MAIN) -->
  <div id="screen-speaking" class="screen-card">
    <!-- Overlay for Fast Transition -->
    <div id="transition-overlay">
        <div class="text-6xl mb-4">üéâ</div>
        <h1 class="text-6xl font-black text-blue-600 mb-2">Great Job!</h1>
        <p class="text-3xl text-gray-500 font-bold">Getting next student...</p>
    </div>

    <div class="question-layout">
      
      <!-- Top: Big Question -->
      <div class="question-box">
        <!-- Integrated Info Indicators -->
        <div id="part-indicator" class="part-indicator">Part 1</div>
        <div id="speaker-indicator" class="speaker-indicator">Student</div>

        <div id="question-timer" class="timer-float">45</div>
        <div id="question-text" class="question-text-display">
          Question text goes here...
        </div>
      </div>

      <!-- Bottom: Help & Progress -->
      <div class="help-grid">
        <!-- 1. Left: Fillers -> Fluency -> Starters -->
        <div class="help-panel bg-indigo-50 border-indigo-100">
          <div class="help-header text-indigo-700">
            <span>üí¨</span> 1. Start & Flow
          </div>
          <div id="col-start" class="tag-container">
            <!-- Fillers, Fluency, Starters -->
          </div>
        </div>

        <!-- 2. Middle: Phrases -> Advanced -->
        <div class="help-panel bg-blue-50 border-blue-100">
          <div class="help-header text-blue-700">
            <span>üó£</span> 2. Phrases & Detail
          </div>
          <div id="col-middle" class="tag-container">
              <!-- Phrases, Advanced -->
          </div>
        </div>

        <!-- 3. Right: Idioms -> Summary -> VOCAB (Balanced) -->
        <div class="help-panel bg-green-50 border-green-100">
          <div class="help-header text-green-700">
            <span>‚ú®</span> 3. Finish & Words
          </div>
          <div id="col-finish" class="tag-container">
              <!-- Idioms, Summary, WordBank -->
          </div>
        </div>
      </div>

      <div class="progress-track">
        <div id="progress-bar" class="progress-fill"></div>
      </div>
      
    </div>
  </div>

 </div>

 <script>
/** * DATA CONFIGURATION */

// Student Data Organization
const STUDENT_DATA = {
    "10": [
        { english: "Dino", chinese: "" }, { english: "Tracy", chinese: "" }, { english: "Billie", chinese: "" },
        { english: "Jessie", chinese: "" }, { english: "Von Tony", chinese: "" }, { english: "Jim", chinese: "" },
        { english: "Andrew", chinese: "" }, { english: "Mark", chinese: "" }, { english: "Leo", chinese: "" },
        { english: "Apollo", chinese: "" }, { english: "Lion", chinese: "" }, { english: "Tony", chinese: "" },
        { english: "Jenny", chinese: "" }, { english: "Steven", chinese: "" }, { english: "Mike", chinese: "" },
        { english: "Howlin", chinese: "" }
    ],
    "11": [
        { english: "Iris", chinese: "Êü¥ÂçìÁë∂" }, { english: "Max", chinese: "Êùé‰πãÁî®" }, { english: "Cathy", chinese: "Êûó‰∫ëÊõ¶" },
        { english: "Sandy", chinese: "ÂàòÁèÇÂê´" }, { english: "Vicky", chinese: "È™ÜÊ¢¶‰πî" }, { english: "Jim", chinese: "ÂÆãÊòäËΩ©" },
        { english: "Jackie", chinese: "ÂêëÂÆ∂ÊÖï" }, { english: "Jay", chinese: "ÂæêÂòâÁÅè" }, { english: "Grace", chinese: "Êù®È¶•ÂÆÅ" },
        { english: "Emily", chinese: "Âº†‰∏éÂçì" }, { english: "Rhea", chinese: "ËµµÂçÉÊ¢¶" }
    ],
    "12": [
        { english: "Anna", chinese: "" }, { english: "Mia", chinese: "" }, { english: "Kenn", chinese: "" },
        { english: "Max", chinese: "" }, { english: "Sky", chinese: "" }, { english: "Sheng", chinese: "" },
        { english: "Keying", chinese: "" }, { english: "Cen", chinese: "" }, { english: "Xifei", chinese: "" },
        { english: "Jiaqi", chinese: "" }, { english: "Zack", chinese: "" }, { english: "Azure", chinese: "" },
        { english: "Joe", chinese: "" }
    ]
};

// FULL Rich Content Data (Restored from your input + Summaries)
const PRACTICE_DATA = {
    "Hometown": [
        { type: "Part 1", question: "Let's talk about your hometown. Where are you from?", timer: 30, fillers: ["Well, let me think...", "To be honest...", "I suppose...", "Actually...", "That's easy..."], starters: ["I come from...", "My hometown is...", "It is a city called..."], wordBank: ["Beijing", "capital", "province", "historical", "modern", "district", "residents", "suburbs", "urban"], collocations: ["densely populated", "located in", "famous for", "bustling streets", "local community", "hometown glory", "residential area"], advanced: ["picturesque", "cosmopolitan", "metropolis", "infrastructure", "renovated"], idiom: "Home is where the heart is", summary: "So, that is where I come from." },
        { type: "Part 2", question: "Describe a place in your hometown interesting to tourists.", timer: 90, fillers: ["Actually, I need a moment...", "Let me see...", "If I'm not mistaken...", "I'd like to talk about...", "One place comes to mind..."], starters: ["I want to describe...", "It is located in...", "You can see..."], wordBank: ["Great Wall", "Palace", "Temple", "site", "museum", "park", "lake", "view"], collocations: ["tourist attraction", "ancient architecture", "breathtaking view", "cultural heritage", "must-visit spot", "flock to", "historical significance"], advanced: ["magnificent", "preservation", "iconic", "awe-inspiring", "splendor"], idiom: "A stone's throw away", summary: "In short, it is a must-visit place." },
        { type: "Part 3", question: "How has your hometown changed recently?", timer: 60, fillers: ["That's a good question...", "What I mean is...", "Another point is...", "It's hard to say, but...", "Generally speaking..."], starters: ["It has changed...", "In the past...", "Now we have..."], wordBank: ["skyscrapers", "subway", "traffic", "convenient", "economy", "shops", "roads", "tech"], collocations: ["urban development", "traffic congestion", "rapid change", "standard of living", "public transport", "shopping mall", "high-rise building"], advanced: ["drastically", "transformation", "commercialized", "expansion", "gentrification"], idiom: "Concrete jungle", summary: "To sum up, it has changed a lot." }
    ],
    "School Life": [
        { type: "Part 1", question: "Tell me about your school. What is your favorite subject?", timer: 30, fillers: ["Well, let me think...", "To be honest...", "I suppose...", "As a matter of fact...", "Actually..."], starters: ["I study at...", "My favorite subject is...", "I find... very interesting."], wordBank: ["Maths", "English", "P.E.", "History", "Physics", "campus", "textbook", "experiment", "literature"], collocations: ["attend classes", "sit an exam", "favorite subject", "broaden my horizons", "gain knowledge", "highly qualified", "strict discipline"], advanced: ["curriculum", "fascinating", "compulsory"], idiom: "Hit the books", summary: "That is why I enjoy school." },
        { type: "Part 2", question: "Describe a school project you worked hard on.", timer: 90, fillers: ["Actually, I need a moment...", "Let me see...", "If I'm not mistaken...", "I recall...", "Let me gather my thoughts..."], starters: ["I remember...", "I had to...", "It was difficult..."], wordBank: ["presentation", "research", "teamwork", "deadline", "effort", "grade"], collocations: ["meet a deadline", "group project", "give a presentation", "conduct research", "put effort into"], advanced: ["challenging", "collaborate", "accomplishment"], idiom: "Pass with flying colors", summary: "Overall, it was a success." },
        { type: "Part 3", question: "Do students have too much homework?", timer: 60, fillers: ["That's a good question...", "What I mean is...", "Another point is...", "From my perspective...", "I strongly believe..."], starters: ["Yes, I think...", "Compared to...", "It creates..."], wordBank: ["pressure", "stress", "review", "knowledge", "free time"], collocations: ["academic pressure", "heavy workload", "stay up late", "mental health", "balance work"], advanced: ["overwhelming", "detrimental", "essential"], idiom: "Burn the midnight oil", summary: "All in all, we need less work." }
    ],
    "Food & Festivals": [
        { type: "Part 1", question: "What is your favorite Chinese dish?", timer: 30, fillers: ["Well, let me think...", "To be honest...", "I suppose...", "Oh, definitely...", "Without a doubt..."], starters: ["My favorite dish is...", "I really love...", "It tastes..."], wordBank: ["Peking Duck", "Dumplings", "Hot Pot", "spicy", "savory", "sweet", "bitter", "salty"], collocations: ["traditional dish", "mouth-watering", "rich flavor", "staple food", "authentic taste", "culinary skills", "home-cooked meal"], advanced: ["delicacy", "appetizing", "nutritious", "gastronomy", "authentic"], idiom: "Make my mouth water", summary: "It is simply delicious." },
        { type: "Part 2", question: "Describe a traditional festival.", timer: 90, fillers: ["Actually, I need a moment...", "Let me see...", "If I'm not mistaken...", "Hmm...", "Well, generally..."], starters: ["I'd like to talk about...", "It happens in...", "My family usually..."], wordBank: ["Spring Festival", "reunion", "red envelopes", "lanterns", "fireworks", "customs", "ancestors", "decorations"], collocations: ["family reunion", "festive atmosphere", "celebrate together", "pay respects", "exchange gifts", "quality time", "lunar calendar"], advanced: ["significance", "commemorate", "prosperity", "symbolize", "annual"], idiom: "Feast for the eyes", summary: "That is how we celebrate it." },
        { type: "Part 3", question: "Why is it important to learn about festivals?", timer: 60, fillers: ["That's a good question...", "What I mean is...", "Another point is...", "Generally speaking...", "The way I see it..."], starters: ["It is important because...", "It helps us...", "If we don't..."], wordBank: ["culture", "identity", "history", "preserve", "values", "roots", "heritage", "generations"], collocations: ["cultural heritage", "keep traditions alive", "sense of belonging", "pass down", "national identity", "historical significance", "cultural values"], advanced: ["vital", "inheritance", "appreciation", "continuity", "unification"], idiom: "Cup of tea", summary: "In conclusion, traditions matter." }
    ],
    "Hobbies": [
        { type: "Part 1", question: "What do you do in your free time?", timer: 30, fillers: ["Well, let me think...", "To be honest...", "I suppose...", "As a matter of fact...", "Actually..."], starters: ["In my free time...", "I usually...", "I am a fan of..."], wordBank: ["basketball", "reading", "games", "music", "draw", "painting", "novel", "relax"], collocations: ["spare time", "leisure activity", "unwind", "creative outlet", "avid reader", "pass the time", "stay active"], advanced: ["recreational", "passionate", "pursue", "enthusiastic", "engage"], idiom: "Let off steam", summary: "That is how I relax." },
        { type: "Part 2", question: "Describe a hobby you want to try.", timer: 90, fillers: ["Actually, I need a moment...", "Let me see...", "If I'm not mistaken...", "Interesting...", "I've thought..."], starters: ["I want to try...", "It looks...", "I need to..."], wordBank: ["skiing", "coding", "photography", "piano", "exciting", "instrument", "skill", "creative"], collocations: ["take up", "develop skills", "master the art", "broaden interests", "artistic expression", "challenge myself", "learn the basics"], advanced: ["acquire", "captivating", "expertise", "proficient", "dedication"], idiom: "Give it a shot", summary: "I really hope to try it soon." },
        { type: "Part 3", question: "Are hobbies important for students?", timer: 60, fillers: ["That's a good question...", "What I mean is...", "Another point is...", "Absolutely...", "I'm convinced..."], starters: ["Yes, because...", "Hobbies provide...", "Without hobbies..."], wordBank: ["mental health", "creativity", "social", "balance", "stress", "academic", "pressure", "lifestyle"], collocations: ["well-rounded", "relieve stress", "maintain balance", "boost confidence", "escape reality", "social skills", "personal growth"], advanced: ["integral", "therapeutic", "holistic", "essential", "beneficial"], idiom: "All work and no play", summary: "To conclude, balance is key." }
    ],
    "Family & Friends": [
         { type: "Part 1", question: "Who are you closest to in your family?", timer: 30, fillers: ["Well, let me think...", "To be honest...", "I suppose...", "I'd say...", "Probably..."], starters: ["I am closest to...", "We often...", "She helps me..."], wordBank: ["mother", "father", "grandma", "supportive", "kind", "sibling", "cousin", "strict"], collocations: ["get along", "close relationship", "family bond", "quality time", "look up to", "confide in", "mutual respect"], advanced: ["inseparable", "confide", "guidance", "cherish", "unwavering"], idiom: "Flesh and blood", summary: "She means the world to me." },
        { type: "Part 2", question: "Describe your best friend.", timer: 90, fillers: ["Actually, I need a moment...", "Let me see...", "If I'm not mistaken...", "I've known...", "My best friend..."], starters: ["My best friend is...", "We met...", "He/She is..."], wordBank: ["cheerful", "honest", "reliable", "funny", "tall", "secret", "trust", "memory"], collocations: ["childhood friend", "have in common", "sense of humor", "shared interests", "enjoy company", "trust implicitly", "count on"], advanced: ["trustworthy", "dependable", "bond", "supportive", "genuine"], idiom: "Through thick and thin", summary: "I am lucky to have him/her." },
        { type: "Part 3", question: "What makes a 'good friend'?", timer: 60, fillers: ["That's a good question...", "What I mean is...", "Another point is...", "It depends...", "In my opinion..."], starters: ["A good friend...", "The main quality...", "I value..."], wordBank: ["honesty", "loyalty", "trust", "listener", "support", "forgive", "kindness", "help"], collocations: ["mutual respect", "stand by you", "keep a secret", "good listener", "offer advice", "supportive nature", "trustworthy friend"], advanced: ["integrity", "empathy", "reliable", "compassion", "sincerity"], idiom: "Shoulder to cry on", summary: "Ultimately, trust is everything." }
    ],
     "Technology": [
        { type: "Part 1", question: "How often do you use a mobile phone?", timer: 30, fillers: ["Well, let me think...", "To be honest...", "I suppose...", "Mostly...", "Actually..."], starters: ["I use it...", "Every day...", "I mainly use..."], wordBank: ["chatting", "WeChat", "homework", "games", "daily", "smartphone", "app", "internet"], collocations: ["browse internet", "scroll media", "stay connected", "check notifications", "send messages", "daily routine", "screen time"], advanced: ["indispensable", "device", "frequently", "integral", "rely"], idiom: "Glued to the screen", summary: "I use it all the time." },
        { type: "Part 2", question: "Describe a useful app for studies.", timer: 90, fillers: ["Actually, I need a moment...", "Let me see...", "If I'm not mistaken...", "Let me reflect...", "One app..."], starters: ["I often use...", "It helps me...", "It has..."], wordBank: ["dictionary", "translate", "online", "efficient", "video", "platform", "search", "download"], collocations: ["user-friendly", "educational tool", "access resources", "improve skills", "search for info", "highly recommended", "boost productivity"], advanced: ["comprehensive", "innovative", "accessible", "invaluable", "feature"], idiom: "At your fingertips", summary: "It makes studying much easier." },
        { type: "Part 3", question: "Do children spend too much time on screens?", timer: 60, fillers: ["That's a good question...", "What I mean is...", "Another point is...", "From my view...", "It's serious..."], starters: ["Yes, it is...", "Many children...", "It affects..."], wordBank: ["addicted", "eyesight", "health", "social", "distraction", "focus", "limit", "control"], collocations: ["screen time", "sedentary lifestyle", "face-to-face", "attention span", "physical health", "mental well-being", "social interaction"], advanced: ["excessive", "consequences", "moderation", "detrimental", "addiction"], idiom: "Double-edged sword", summary: "We must limit screen time." }
    ],
     "Travel": [
        { type: "Part 1", question: "Do you like traveling?", timer: 30, fillers: ["Well, let me think...", "To be honest...", "I suppose...", "You know...", "Certainly..."], starters: ["Yes, I love...", "I enjoy...", "It gives me..."], wordBank: ["explore", "culture", "relax", "food", "scenery", "trip", "vacation", "flight"], collocations: ["tourist destination", "local cuisine", "go sightseeing", "broaden mind", "escape the city", "cultural experience", "breathtaking view"], advanced: ["exotic", "picturesque", "memorable", "rejuvenate", "adventure"], idiom: "Travel light", summary: "Traveling is my passion." },
        { type: "Part 2", question: "Describe a city you visited.", timer: 90, fillers: ["Actually, I need a moment...", "Let me see...", "If I'm not mistaken...", "I'll tell you...", "One trip..."], starters: ["I visited...", "It is in...", "It is famous..."], wordBank: ["Shanghai", "Chengdu", "pandas", "spicy", "history", "museum", "mountain", "river"], collocations: ["scenic spot", "memorable experience", "ancient history", "local specialty", "cultural heritage", "must-see", "tourist hotspot"], advanced: ["iconic", "magnificent", "bustling", "vibrant", "landmark"], idiom: "Off the beaten track", summary: "It was an unforgettable trip." },
        { type: "Part 3", question: "Car vs High-speed train?", timer: 60, fillers: ["That's a good question...", "What I mean is...", "Another point is...", "No doubt...", "It's clear..."], starters: ["I prefer...", "Trains are...", "Cars are..."], wordBank: ["fast", "convenient", "traffic", "comfortable", "time", "ticket", "station", "drive"], collocations: ["public transport", "high-speed network", "traffic jam", "cost-effective", "environmentally friendly", "punctual service", "travel time"], advanced: ["punctual", "efficient", "preferable", "reliable", "congestion"], idiom: "Hustle and bustle", summary: "Trains are definitely better." }
    ],
    "Animals & Pets": [
        { type: "Part 1", question: "Do you have a pet?", timer: 30, fillers: ["Well, let me think...", "To be honest...", "I suppose...", "Actually...", "Sadly no..."], starters: ["I have a...", "My favorite...", "I don't..."], wordBank: ["dog", "cat", "rabbit", "cute", "loyal", "fur", "feed", "walk"], collocations: ["keep a pet", "furry friend", "take care of", "animal lover", "domestic animal", "loyal companion", "play with"], advanced: ["companion", "affectionate", "responsibility", "adorable", "bond"], idiom: "Cat nap", summary: "Pets are great companions." },
        { type: "Part 2", question: "Describe an interesting animal.", timer: 90, fillers: ["Actually, I need a moment...", "Let me see...", "If I'm not mistaken...", "I think...", "One animal..."], starters: ["I think...", "It lives...", "It looks..."], wordBank: ["panda", "elephant", "wild", "bamboo", "nature", "forest", "zoo", "fur"], collocations: ["endangered species", "natural habitat", "wild animal", "unique features", "protect wildlife", "animal kingdom", "native to"], advanced: ["fascinating", "distinctive", "conservation", "habitat", "species"], idiom: "Gentle giant", summary: "They are truly amazing creatures." },
        { type: "Part 3", question: "Why do people keep pets?", timer: 60, fillers: ["That's a good question...", "What I mean is...", "Another point is...", "Hard to say...", "I imagine..."], starters: ["People keep...", "Pets provide...", "For old people..."], wordBank: ["company", "friend", "duty", "lonely", "stress", "care", "family", "love"], collocations: ["loyal companion", "provide company", "emotional support", "relieve loneliness", "reduce stress", "part of the family", "unconditional love"], advanced: ["alleviate", "bond", "unconditional", "companionship", "responsibility"], idiom: "Man's best friend", summary: "They bring us joy." }
    ],
    "Environment": [
        { type: "Part 1", question: "Is there a park near you?", timer: 30, fillers: ["Well, let me think...", "To be honest...", "I suppose...", "Well, yes...", "Not really..."], starters: ["Yes, there is...", "It is called...", "I go there..."], wordBank: ["trees", "flowers", "lake", "exercise", "grass", "bench", "nature", "walk"], collocations: ["fresh air", "green space", "morning exercise", "public park", "peace and quiet", "natural beauty", "community park"], advanced: ["tranquil", "scenic", "vicinity", "atmosphere", "recreational"], idiom: "Breath of fresh air", summary: "It is a nice place to relax." },
        { type: "Part 2", question: "Describe how you help the environment.", timer: 90, fillers: ["Actually, I need a moment...", "Let me see...", "If I'm not mistaken...", "Thinking...", "I try to..."], starters: ["I try to...", "My family...", "At school..."], wordBank: ["recycle", "water", "lights", "plastic", "waste", "rubbish", "energy", "clean"], collocations: ["save energy", "eco-friendly", "reduce waste", "public transport", "protect the planet", "environmentally friendly", "sort rubbish"], advanced: ["sustainable", "conserve", "eco-conscious", "preservation", "impact"], idiom: "Do my bit", summary: "Small actions make a difference." },
        { type: "Part 3", question: "Biggest environmental problems?", timer: 60, fillers: ["That's a good question...", "What I mean is...", "Another point is...", "Serious issue...", "I'm worried..."], starters: ["The biggest...", "Cities have...", "We have..."], wordBank: ["pollution", "smog", "noise", "waste", "rubbish", "factory", "smoke", "health"], collocations: ["global warming", "air quality", "noise pollution", "carbon footprint", "climate change", "industrial waste", "environmental protection"], advanced: ["severe", "contamination", "hazardous", "pollutant", "emission"], idiom: "Tip of the iceberg", summary: "We must act now." }
    ],
     "Sports": [
        { type: "Part 1", question: "Do you like playing sports?", timer: 30, fillers: ["Well, let me think...", "To be honest...", "I suppose...", "Not really...", "Absolutely..."], starters: ["Yes, I like...", "I play...", "I'm not sporty..."], wordBank: ["basketball", "football", "swim", "run", "active", "gym", "team", "ball"], collocations: ["keep fit", "team sport", "regular exercise", "physical activity", "stay healthy", "join a club", "workout routine"], advanced: ["vigorous", "beneficial", "sedentary", "athletic", "stamina"], idiom: "Get the ball rolling", summary: "Sports keep me healthy." },
        { type: "Part 2", question: "Describe a sport you would like to try.", timer: 90, fillers: ["Actually, I need a moment...", "Let me see...", "If I'm not mistaken...", "I've wanted to...", "It looks fun..."], starters: ["I want to try...", "It looks...", "I need to learn..."], wordBank: ["skiing", "surfing", "tennis", "diving", "gear", "coach", "lesson", "safe"], collocations: ["physical strength", "requires equipment", "adrenaline rush", "extreme sport", "master the skill", "take up", "outdoor activity"], advanced: ["exhilarating", "endurance", "agility", "coordination", "technique"], idiom: "Give it my best shot", summary: "It sounds like a fun challenge." },
        { type: "Part 3", question: "Why is it important for children to play sports?", timer: 60, fillers: ["That's a good question...", "What I mean is...", "Another point is...", "I feel that...", "It's essential..."], starters: ["It helps them...", "Sports teach...", "They learn..."], wordBank: ["health", "teamwork", "confidence", "fun", "friends", "win", "lose", "rule"], collocations: ["build character", "team spirit", "healthy lifestyle", "social skills", "mental health", "fair play", "cooperation skill"], advanced: ["resilience", "collaboration", "fundamental", "discipline", "competitiveness"], idiom: "Healthy body, healthy mind", summary: "Sports teach essential life skills." }
    ]
};

let state = {
  date: new Date().toISOString().split('T')[0],
  selectedTopic: Object.keys(PRACTICE_DATA)[0],
  currentGrade: "11",
  studentsForGrade: [],
  selectedStudents: new Set(),
  remainingStudents: [],
  currentStudent: null,
  currentPart: 0,
  timerInterval: null,
  stream: null
};

/* --- AUDIO EFFECTS --- */
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

function playTone(freq, type, duration) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}

function playClickSound() { playTone(800, 'square', 0.05); }
function playTickSound() { playTone(1200, 'sine', 0.05); }
function playWinSound() { 
  [400, 500, 600, 800].forEach((f, i) => setTimeout(() => playTone(f, 'triangle', 0.3), i * 100));
}

/* --- TTS --- */
function speakText(text) {
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  const voices = window.speechSynthesis.getVoices();
  
  // STRICT VOICE FILTER
  const allowedNames = [
    'Emma', 
    'Eva', 
    'Andrew', 
    'Brian', 
    'Microsoft Online Multilingual Natural'
  ];
  
  const targetVoice = voices.find(v => 
    allowedNames.some(name => v.name.toLowerCase().includes(name.toLowerCase()))
  );
  
  if (targetVoice) utterance.voice = targetVoice;
  utterance.rate = 0.85; 
  window.speechSynthesis.speak(utterance);
}

// Init voices
window.speechSynthesis.onvoiceschanged = () => { console.log("Voices loaded"); };

/* --- DOM & LOGIC --- */
const screens = {
  setup: document.getElementById('screen-setup'),
  preview: document.getElementById('screen-preview'),
  selection: document.getElementById('screen-selection'),
  countdown: document.getElementById('screen-countdown'),
  speaking: document.getElementById('screen-speaking')
};

function init() {
  document.getElementById('date-picker').value = state.date;
  
  const themeSelect = document.getElementById('theme-select');
  Object.keys(PRACTICE_DATA).forEach(key => {
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = key;
    themeSelect.appendChild(opt);
  });

  document.getElementById('grade-select').addEventListener('change', (e) => loadGrade(e.target.value));
  document.getElementById('theme-select').addEventListener('change', (e) => state.selectedTopic = e.target.value);
  document.getElementById('btn-start').addEventListener('click', startPreview);

  loadGrade("11");
}

function loadGrade(grade) {
    state.currentGrade = grade;
    state.studentsForGrade = STUDENT_DATA[grade];
    state.selectedStudents.clear();
    renderStudentGrid();
}

function renderStudentGrid() {
  const grid = document.getElementById('student-grid');
  grid.innerHTML = '';
  state.studentsForGrade.forEach((student, index) => {
    const el = document.createElement('div');
    el.className = `student-card ${state.selectedStudents.has(index) ? 'selected' : ''}`;
    el.onclick = () => toggleStudent(index);
    el.innerHTML = `
      <div class="student-avatar">${student.english.substring(0,2)}</div>
      <div class="student-name">${student.english} ${student.chinese ? student.chinese : ''}</div>
    `;
    grid.appendChild(el);
  });
  updateStartButton();
}

function toggleStudent(index) {
  if (state.selectedStudents.has(index)) state.selectedStudents.delete(index);
  else state.selectedStudents.add(index);
  renderStudentGrid();
}

function selectAllStudents() {
  state.selectedStudents = new Set(state.studentsForGrade.map((_, i) => i));
  renderStudentGrid();
}

function updateStartButton() {
    document.getElementById('btn-start').disabled = state.selectedStudents.size === 0;
}

function switchScreen(screenName) {
  Object.values(screens).forEach(s => s.classList.remove('active'));
  screens[screenName].classList.add('active');
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// 1. PREVIEW
async function startPreview() {
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  
  document.getElementById('preview-topic-name').textContent = state.selectedTopic;

  let selectedIndices = Array.from(state.selectedStudents);
  selectedIndices = shuffleArray(selectedIndices);
  
  // Anti-Repeat First Speaker Logic
  const lastFirstStudent = localStorage.getItem('lastFirstStudent');
  if (selectedIndices.length > 1 && 
      STUDENT_DATA[state.currentGrade][selectedIndices[0]].english === lastFirstStudent) {
        console.log("Avoided repeat first speaker!");
        [selectedIndices[0], selectedIndices[selectedIndices.length - 1]] = 
        [selectedIndices[selectedIndices.length - 1], selectedIndices[0]];
  }

  if (selectedIndices.length > 0) {
      localStorage.setItem('lastFirstStudent', STUDENT_DATA[state.currentGrade][selectedIndices[0]].english);
  }

  state.remainingStudents = selectedIndices.map(i => state.studentsForGrade[i]);

  switchScreen('preview');
  
  let timeLeft = 3;
  const timerDisplay = document.getElementById('preview-timer');
  const interval = setInterval(() => {
    timeLeft--;
    timerDisplay.textContent = `Starting in ${timeLeft}...`;
    playTickSound();
    if(timeLeft <= 0) {
      clearInterval(interval);
      startSelection();
    }
  }, 1000);
}

// 2. SELECTION
function startSelection() {
  if(state.remainingStudents.length === 0) {
    alert("All students have finished!");
    location.reload();
    return;
  }
  
  document.getElementById('transition-overlay').style.display = 'none';

  switchScreen('selection');
  const display = document.getElementById('roulette-display');
  let counter = 0;
  let speed = 50;
  
  const allNames = state.studentsForGrade.map(s => s.english);

  const spin = () => {
    const randomName = allNames[Math.floor(Math.random() * allNames.length)];
    display.textContent = randomName;
    playClickSound();
    
    counter++;
    if(counter < 30) { 
      setTimeout(spin, speed);
      speed += 5;
    } else {
      state.currentStudent = state.remainingStudents[0];
      display.textContent = state.currentStudent.english;
      display.style.color = '#48bb78';
      playWinSound();
      
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
      });

      setTimeout(startCountdown, 2000);
    }
  };
  spin();
}

// 3. COUNTDOWN
function startCountdown() {
  switchScreen('countdown');
  const cnName = state.currentStudent.chinese ? `(${state.currentStudent.chinese})` : '';
  document.getElementById('next-speaker-name').textContent = `${state.currentStudent.english} ${cnName}`;
  let timeLeft = 7;
  const display = document.getElementById('countdown-display');
  display.textContent = timeLeft;
  
  const interval = setInterval(() => {
    timeLeft--;
    display.textContent = timeLeft;
    playTickSound();
    if(timeLeft <= 0) {
      clearInterval(interval);
      startSpeakingSession();
    }
  }, 1000);
}

// 4. SPEAKING SESSION
function startSpeakingSession() {
  switchScreen('speaking');
  document.getElementById('speaker-indicator').textContent = state.currentStudent.english;
  
  const questions = PRACTICE_DATA[state.selectedTopic];
  const randomIndex = Math.floor(Math.random() * questions.length);
  
  runQuestion(randomIndex);
}

function runQuestion(partIndex) {
  state.currentPart = partIndex;
  const questions = PRACTICE_DATA[state.selectedTopic];
  const currentQ = questions[partIndex];

  // UI Updates
  document.getElementById('part-indicator').textContent = currentQ.type;
  document.getElementById('question-text').textContent = currentQ.question;
  
  // --- ORGANIZED WORD BANK (Top-Down Flow) ---
  
  // COL 1: Fillers -> Fluency -> Starters
  const leftItems = [
      ...(currentQ.fillers || []), 
      "---", 
      ...(currentQ.starters || [])
  ];
  renderTags('col-start', leftItems, 'standard');

  // COL 2: Phrases -> Advanced
  const middleItems = [
      ...(currentQ.collocations || []), 
      "---",
      ...(currentQ.advanced || [])
  ];
  renderTags('col-middle', middleItems, 'advanced');

  // COL 3: Idioms -> Summary -> Vocab
  const rightContainer = document.getElementById('col-finish');
  rightContainer.innerHTML = '';
  
  // Idiom
  if(currentQ.idiom) {
      const tag = document.createElement('span');
      tag.className = 'tag idiom';
      tag.textContent = `"${currentQ.idiom}"`;
      tag.onclick = () => speakText(currentQ.idiom);
      rightContainer.appendChild(tag);
  }
  
  // Summary
  if(currentQ.summary) {
      const tag = document.createElement('span');
      tag.className = 'tag summary';
      tag.textContent = `‚û° ${currentQ.summary}`;
      tag.onclick = () => speakText(currentQ.summary);
      rightContainer.appendChild(tag);
  } else {
      const tag = document.createElement('span');
      tag.className = 'tag summary';
      tag.textContent = `‚û° In conclusion...`;
      rightContainer.appendChild(tag);
  }

  // Vocab (Moved to Col 3)
  const vocabSpacer = document.createElement('div');
  vocabSpacer.style.width = '100%';
  vocabSpacer.style.height = '2px';
  vocabSpacer.style.backgroundColor = '#cbd5e0';
  vocabSpacer.style.margin = '0.5rem 0';
  rightContainer.appendChild(vocabSpacer);

  // Render Vocab Words Manually into Right Container
  (currentQ.wordBank || []).forEach(word => {
      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.textContent = word;
      tag.onclick = () => speakText(word);
      rightContainer.appendChild(tag);
  });

  // TTS
  speakText(currentQ.question);

  // Timer 
  const duration = 45; 
  const timerDisplay = document.getElementById('question-timer');
  const pBar = document.getElementById('progress-bar');
  
  timerDisplay.textContent = duration;
  pBar.style.width = '100%';
  pBar.style.transition = 'none';

  setTimeout(() => {
    pBar.style.transition = `width ${duration}s linear`;
    pBar.style.width = '0%';
  }, 100);

  if(state.timerInterval) clearInterval(state.timerInterval);
  let remaining = duration;

  state.timerInterval = setInterval(() => {
    remaining--;
    timerDisplay.textContent = remaining;
    
    if(remaining <= 10) {
       timerDisplay.style.background = 'red'; 
       playTickSound();
    } else {
       timerDisplay.style.background = 'rgba(255,255,255,0.2)';
    }

    if(remaining <= 0) {
      clearInterval(state.timerInterval);
      finishStudent();
    }
  }, 1000);
}

function renderTags(containerId, items, specialType) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  items.forEach(item => {
    if(item === "---") {
        const spacer = document.createElement('div');
        spacer.style.width = '100%';
        spacer.style.height = '2px';
        spacer.style.backgroundColor = '#cbd5e0';
        spacer.style.margin = '0.5rem 0';
        container.appendChild(spacer);
        return;
    }

    const tag = document.createElement('span');
    const isAdvanced = specialType === 'advanced' && PRACTICE_DATA[state.selectedTopic][state.currentPart].advanced && PRACTICE_DATA[state.selectedTopic][state.currentPart].advanced.includes(item);
    
    tag.className = `tag ${isAdvanced ? 'advanced' : ''}`;
    tag.textContent = item;
    tag.onclick = () => speakText(item);
    container.appendChild(tag);
  });
}

function finishStudent() {
  state.remainingStudents.shift(); 
  
  const overlay = document.getElementById('transition-overlay');
  overlay.style.display = 'flex';
  playWinSound();
  confetti({ particleCount: 100, origin: { y: 0.5 } });

  setTimeout(() => {
      startSelection();
  }, 3000);
}

init();

</script>
</body>
</html>
