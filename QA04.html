<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Joel's Speaking Practice 04</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            position: relative;
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        audio::-webkit-media-controls-panel {
            padding: 5px;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display {
            margin: 0 2px;
        }
        /* Make sure app content is above the background */
        #app-container {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gradient-to-br dark:from-gray-900 dark:via-indigo-900 dark:to-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center p-2 sm:p-4">
    
    <div id="app-container" class="w-full max-w-xl mx-auto text-center h-full">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-white dark:bg-gray-800 dark:shadow-lg p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center">
            <div id="name-entry-container">
                <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">Joel's Speaking Practice 04</h1>
                <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 text-center text-lg text-gray-900 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                <button id="start-with-name-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">Start</button>
            </div>
            <div id="topic-selection-container" class="hidden">
                 <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">Hello, <span id="user-name-display"></span>!</h1>
                 <div id="instructions" class="text-sm text-gray-600 dark:text-gray-400 mb-4 text-left space-y-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                         <p><i class="fas fa-bullhorn mr-2 text-indigo-500"></i>Try to speak until the time runs out. You can use the sentence starters and word bank for help.</p>
                         <p><i class="fas fa-download mr-2 text-blue-500"></i>After recording, download your answer and upload it. If the upload doesn't work, save the downloaded files.</p>
                         <p><i class="fas fa-award mr-2 text-yellow-500"></i>You must complete all 9 topics to get the Certificate of Completion as proof you finished the homework.</p>
                 </div>
                <div id="topic-selection" class="grid grid-cols-3 gap-4">
                    <!-- Topic buttons will be injected here -->
                </div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden bg-white dark:bg-gray-800 dark:shadow-lg rounded-2xl shadow-lg app-shell p-3 sm:p-4">
            <header class="flex-shrink-0">
                <div class="flex justify-between items-center mb-2">
                    <div class="w-1/3 text-left">
                         <button id="back-to-topics-btn" class="text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-1 px-3 rounded-lg shadow-sm">
                            <i class="fas fa-arrow-left mr-2"></i>Topics
                        </button>
                    </div>
                    <div class="w-1/3 text-center">
                         <button id="samples-btn" class="hidden text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg shadow-md">
                             <i class="fas fa-comment-dots mr-1"></i>Sample Answers
                         </button>
                    </div>
                    <div class="w-1/3 text-right">
                         <button id="next-btn" class="hidden text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-lg shadow-sm disabled:bg-indigo-400 dark:disabled:bg-indigo-800 disabled:cursor-not-allowed">
                            Next<i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
                <!-- Timer Display -->
                <div class="relative w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-2 flex-shrink-0">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200 dark:text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="timer-progress" class="timer-circle text-indigo-500" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-2xl font-bold"></div>
                </div>
                <p id="phase-indicator" class="font-semibold text-indigo-500 dark:text-indigo-400 mb-2 text-base flex-shrink-0"></p>

                <!-- Question Display -->
                <div id="question-container" class="min-h-[50px] flex items-center justify-center mb-2">
                    <h2 id="question-text" class="text-base sm:text-lg font-semibold leading-relaxed text-left w-full"></h2>
                </div>
                
                <div id="error-message-box" class="hidden text-red-500 bg-red-100 dark:bg-red-900/50 p-2 rounded-lg text-sm mb-2"></div>

                <!-- Recording Action Buttons -->
                <div id="recording-actions-container" class="flex flex-col items-center justify-center mb-2">
                    <!-- Initial Record Button -->
                    <button id="record-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md transition-transform transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <!-- Stop Button -->
                    <button id="stop-record-btn" class="hidden bg-gray-700 hover:bg-gray-800 text-white font-bold w-14 h-14 rounded-full text-xl shadow-md flex items-center justify-center">
                        <i class="fas fa-stop"></i>
                    </button>
                    <!-- Post-Recording Controls -->
                    <div id="post-recording-actions" class="hidden w-full flex-col items-center justify-center space-y-2 mt-2">
                        <audio id="audio-player" controls class="w-full max-w-xs"></audio>
                        <div class="flex flex-col gap-3 w-full max-w-xs">
                            <!-- Smart Download button -->
                            <button id="download-btn"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md transition-all duration-200 ease-in-out hover:shadow-lg hover:shadow-blue-500/50 focus:ring-2 focus:ring-blue-400 focus:outline-none active:scale-95 flex items-center justify-center">
                                <i class="fas fa-download mr-1"></i>Download Recording
                            </button>
                            
                            <!-- Upload button -->
                            <a id="sharepoint-upload-link"
                               href="https://xichengacademy-my.sharepoint.com/:f:/g/personal/joelmitchell_xichengacademy_cn/EjxMFg8-baNEo5uuWUBc4EoBzn1DVWJ1Ym_NFx6hPlJ0dQ"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-md transition-all duration-200 ease-in-out hover:shadow-lg hover:shadow-green-500/50 focus:ring-2 focus:ring-green-400 focus:outline-none active:scale-95 flex items-center justify-center">
                                <i class="fas fa-upload mr-1"></i>Upload to Folder
                            </a>
                        </div>
                    </div>
                </div>
                 <div id="recording-status" class="hidden items-center justify-center text-red-500 font-semibold mb-1">
                     <div class="w-2 h-2 bg-red-500 rounded-full mr-2 recording-indicator"></div>
                     Recording...
                 </div>
            </header>
            
            <main class="flex-grow flex flex-col overflow-y-auto min-h-0 space-y-2 pt-2">
                 <!-- Sentence Starters -->
                <div id="starters-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Sentence Starters</h3>
                    <div id="starters-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Word Bank -->
                <div id="word-bank-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center">Word Bank</h3>
                    <div id="word-bank-list" class="flex flex-wrap gap-2 justify-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Sample Answers Display -->
                <div id="samples-container" class="hidden text-left">
                    <h3 class="text-sm font-bold mb-1 text-center flex-shrink-0">Sample Responses</h3>
                    <ul id="samples-list" class="space-y-2 list-inside bg-indigo-900/70 dark:bg-indigo-900/90 p-3 rounded-lg max-h-28 sm:max-h-32 overflow-y-auto">
                    </ul>
                </div>
            </main>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center">
            <div id="certificate-to-download" class="w-full bg-gray-50 dark:bg-gray-700 p-8 rounded-lg border-4 border-yellow-400 dark:border-yellow-500 text-center">
                <i class="fas fa-award text-6xl text-yellow-500 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Certificate of Completion</h1>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">This certificate is awarded to</p>
                <p id="certificate-name" class="text-4xl font-bold my-4 text-indigo-600 dark:text-indigo-400"></p>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-300">for successfully completing all 9 speaking practice topics.</p>
                <p class="text-sm mt-6 text-gray-500 dark:text-gray-400">Issued on: <span id="certificate-date"></span></p>
            </div>
            <button id="download-certificate-btn" class="mt-6 w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md">
                <i class="fas fa-download mr-2"></i>Download Certificate
            </button>
             <button id="back-to-main-menu-btn" class="mt-3 text-sm text-indigo-500 hover:underline">Back to Main Menu</button>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 text-center max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Are you sure?</h3>
            <p id="modal-message" class="text-gray-600 dark:text-gray-400 mb-6">Returning to the topic list will stop your current practice.</p>
            <div class="flex justify-center gap-4">
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Yes</button>
                <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white">Cancel</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA: Questions and Sample Answers for Part 04 ---
        const practiceData = {
            "Daily Life": [
                { 
                    question: "Describe a typical day at your high school in Beijing. What's your favorite subject and why?", 
                    starters: ["A typical day for me starts with...", "After classes, I usually...", "My favorite subject is... because...", "The school day is long, but..."], 
                    wordBank: ["early morning", "classes", "lunch break", "homework", "evening study", "mathematics", "history", "challenging", "interesting"], 
                    samples: [
                        "A typical day starts very early, around 6:30 AM. We have classes all morning, a short lunch break, and then more classes in the afternoon. My favorite subject is Physics because I enjoy solving problems.",
                        "My day is mostly filled with classes from morning until late afternoon. After school, I have dinner and then start my evening self-study session. I enjoy my history class the most because the stories are so interesting.",
                        "We usually have about eight classes a day. My favorite is English, because learning a new language opens up a new world of books and movies, and it's a useful skill for the future."
                    ] 
                },
                { 
                    question: "What do you and your friends like to do for fun on the weekends in Beijing?", 
                    starters: ["On the weekends, we love to...", "A popular activity for us is...", "If the weather is good, we might...", "To relax after a long week, we..."], 
                    wordBank: ["go shopping", "watch a movie", "play basketball", "visit a museum", "hang out at a cafe", "Sanlitun", "Nanluoguxiang", "explore the city", "relax"], 
                    samples: [
                        "On the weekends, my friends and I love to go to a shopping mall like in Sanlitun to walk around, look at the shops, and maybe get some bubble tea.",
                        "If we're feeling energetic, we often go to a local court to play basketball for a few hours. It's a great way to exercise and have fun together.",
                        "To relax after a long week of school, we sometimes just find a quiet cafe where we can chat, do some light homework, and enjoy some snacks."
                    ] 
                }
            ],
            "Food & Culture": [
                { 
                    question: "If a German friend visited you in Beijing, what's one snack or street food you would insist they try?", 
                    starters: ["I would absolutely insist they try...", "They cannot leave Beijing without trying...", "A must-try snack is... because...", "I would take them to..."], 
                    wordBank: ["Jianbing (煎饼)", "Tanghulu (糖葫芦)", "Chuan'r (串儿)", "Bingtang hulu", "savory", "sweet and sour", "barbecue skewers", "local delicacy", "unique flavor"], 
                    samples: [
                        "I would insist they try Jianbing for breakfast. It's a savory crepe made with egg, crispy crackers, and a special sauce, and it's both delicious and cheap.",
                        "They cannot leave Beijing without trying Tanghulu, which are candied hawthorn berries on a stick. It's a classic Beijing snack that is both sweet and a little sour.",
                        "A must-try food, especially in the evening, is Chuan'r, which are grilled meat skewers. It's a very social food, and perfect to eat with friends."
                    ] 
                },
                { 
                    question: "What's your favorite holiday in China (like Spring Festival) and how does your family celebrate it?", 
                    starters: ["My favorite holiday is definitely...", "My family celebrates by...", "The most important tradition for us is...", "On that day, we always..."], 
                    wordBank: ["Spring Festival (春节)", "Mid-Autumn Festival", "Dragon Boat Festival", "family reunion dinner", "red envelopes (红包)", "fireworks", "dumplings (饺子)", "traditions"], 
                    samples: [
                        "My favorite holiday is Spring Festival. My family celebrates by having a huge reunion dinner on New Year's Eve, and the best part is getting red envelopes with money inside.",
                        "I love the Dragon Boat Festival. My grandmother always makes zongzi, which are sticky rice dumplings, and sometimes we go to a nearby park to watch the dragon boat races.",
                        "For me, the Mid-Autumn festival is the best. We celebrate by having dinner with the whole family and then eating mooncakes outside while looking at the full moon."
                    ] 
                }
            ],
            "City & Transport": [
                { 
                    question: "How do you usually get around Beijing? What do you think about the public transport system?", 
                    starters: ["I usually get around by...", "The public transport system is...", "My favorite way to travel is... because...", "I think the subway is..."], 
                    wordBank: ["subway", "bus", "bicycle", "efficient", "crowded", "convenient", "affordable", "traffic jams", "rush hour"], 
                    samples: [
                        "I usually get around by subway because it's fast and avoids the traffic jams on the streets. I think the system is very efficient, but it can get extremely crowded during rush hour.",
                        "I often ride my bicycle for short distances because it's good exercise and environmentally friendly. For longer trips, the bus is a good, affordable option.",
                        "The public transport system in Beijing is very convenient. You can get almost anywhere with the subway, and it's much cheaper than taking a taxi."
                    ] 
                },
                { 
                    question: "Describe your favorite place in Beijing (like a park, a museum, or a historical site) and explain why you like it.", 
                    starters: ["My favorite place is...", "I love going to... because...", "It's a special place for me since...", "I would recommend visiting..."], 
                    wordBank: ["Summer Palace", "Forbidden City", "798 Art District", "Beihai Park", "peaceful", "historical", "creative atmosphere", "beautiful scenery", "escape the city"], 
                    samples: [
                        "My favorite place is Beihai Park. I love going there because it's a huge, beautiful park in the middle of the city where you can rent a boat on the lake and feel relaxed.",
                        "I really enjoy the 798 Art District. It's full of interesting art galleries and cool sculptures, and it has a very creative and modern atmosphere.",
                        "The Summer Palace is my favorite. The scenery is breathtaking with the lake and the hills, and it makes me feel connected to the history of my city."
                    ] 
                }
            ],
            "Importance of Electricity": [
                { 
                    question: "Imagine a day without electricity. What are the top three things you would miss the most and why?", 
                    starters: ["If there was no electricity, I would miss...", "The first thing I'd miss is...", "Life would be so different without...", "It would be impossible to..."], 
                    wordBank: ["internet", "lights", "refrigerator", "air conditioning", "smartphone", "entertainment", "communication", "modern conveniences", "daily life"], 
                    samples: [
                        "I would miss the internet the most, because I use it for homework, talking to friends, and entertainment. Without it, I would feel very disconnected.",
                        "The top three things I'd miss are lights at night, the refrigerator to keep food fresh, and my phone for communication. Life would be very difficult and boring.",
                        "First, I'd miss the air conditioning on a hot day. Second, I would miss being able to cook easily. And third, I'd miss watching videos to relax after studying."
                    ] 
                },
                { 
                    question: "How has electricity changed the way students learn and study compared to your parents' generation?", 
                    starters: ["Electricity has revolutionized learning by...", "Compared to my parents' time, we have...", "Students today can... because of electricity.", "The biggest difference is..."], 
                    wordBank: ["online resources", "computers", "projectors", "digital libraries", "e-books", "instant access", "research", "interactive learning", "educational apps"], 
                    samples: [
                        "Electricity allows us to use computers for research. My parents had to go to the library and search through books, but we can find information instantly online.",
                        "The biggest difference is the use of technology in the classroom, like smartboards and projectors. It makes lessons more interactive and engaging.",
                        "Because of electricity, we can study at night with good lighting and use educational apps on our tablets, which gives us more flexibility than my parents had."
                    ] 
                }
            ],
            "Importance of Water": [
                { 
                    question: "Why is it important for big cities like Beijing to conserve water? What is one way your family tries to save water?", 
                    starters: ["It's crucial to conserve water because...", "Beijing is a city with..., so...", "One way my family saves water is...", "We try to be mindful of..."], 
                    wordBank: ["water scarcity", "large population", "drought", "precious resource", "shorter showers", "reusing water", "fixing leaks", "conservation", "sustainability"], 
                    samples: [
                        "It's crucial to conserve water in Beijing because it's a very dry city with a huge population, so there isn't enough water for everyone if we waste it.",
                        "My family tries to save water by taking shorter showers. We know that every drop counts, so we are mindful not to leave the water running.",
                        "One way we save water is by collecting the water used to wash vegetables and then using it to water our plants. It's a small but effective way to reuse water."
                    ] 
                },
                { 
                    question: "Besides drinking, what is your favorite activity that involves water?", 
                    starters: ["My favorite water activity is...", "I really enjoy... because it's...", "On a hot day, there's nothing better than...", "I find... very relaxing."], 
                    wordBank: ["swimming", "visiting a beach", "boating on a lake", "water parks", "relaxing shower", "refreshing", "fun", "peaceful", "cooling down"], 
                    samples: [
                        "My favorite water activity is swimming. On a hot summer day, it's the most refreshing way to cool down and have fun with my friends.",
                        "I really enjoy just walking by a river or a lake. The sound of the water is very peaceful and helps me clear my mind after a stressful week of school.",
                        "I love going to water parks. The slides are so exciting and it's a great way to have an adventure and escape the city heat during the summer."
                    ] 
                }
            ],
             "Hobbies & Talents": [
                { 
                    question: "What is a hobby you are passionate about? How did you get started with it?", 
                    starters: ["I'm really passionate about...", "I first got into... when...", "My hobby is... and I started by...", "It all began when..."], 
                    wordBank: ["playing guitar", "drawing anime", "coding", "dancing", "reading", "self-taught", "took a class", "inspired by", "practice"], 
                    samples: [
                        "I'm really passionate about playing the guitar. I got started when my father taught me a few basic chords, and I've been teaching myself new songs from the internet ever since.",
                        "My hobby is drawing. I first got into it by trying to copy my favorite anime characters, and now I'm trying to create my own original characters.",
                        "I love coding. It all began with a basic programming class at school, and I found it so interesting that I started learning more advanced languages online."
                    ] 
                },
                { 
                    question: "Do you believe it's important for students to have hobbies, or should they focus only on their studies?", 
                    starters: ["I strongly believe that hobbies are...", "While studies are important, hobbies provide...", "Focusing only on studies can lead to...", "I think a balance is best because..."], 
                    wordBank: ["essential", "burnout", "stress relief", "creativity", "well-rounded", "develop skills", "balance", "mental health", "personal growth"], 
                    samples: [
                        "I strongly believe that hobbies are essential. Focusing only on studies can lead to stress and burnout, while hobbies provide a necessary outlet for relaxation and creativity.",
                        "While studies are important, hobbies help you develop other skills. For example, playing a team sport teaches you teamwork, which is a very important life skill.",
                        "I think a balance is best because hobbies can actually help with studying. Taking a break to do something you enjoy can improve your focus and concentration when you return to your homework."
                    ] 
                }
            ],
            "Technology in Life": [
                { 
                    question: "How has having a smartphone changed your daily life? Is it mostly positive or negative?", 
                    starters: ["Having a smartphone has changed my life by...", "I think it's mostly positive because...", "However, there are negative sides, like...", "It's a mix of both, but..."], 
                    wordBank: ["communication", "convenience", "information", "distraction", "addictive", "helpful tool", "entertainment", "social media", "double-edged sword"], 
                    samples: [
                        "I think having a smartphone is mostly positive because it gives me instant access to information for my studies and makes it so easy to stay in touch with family and friends.",
                        "It's a double-edged sword. On one hand, it's an incredibly helpful tool. On the other hand, it can be a major distraction and it's easy to waste too much time on it.",
                        "A negative side is that I sometimes find myself scrolling through social media instead of doing my homework. It can be very addictive if you are not careful."
                    ] 
                },
                { 
                    question: "What is one app on your phone that you find very useful for your studies, and how do you use it?", 
                    starters: ["A very useful app for me is...", "I use... to help me with...", "This app is great for...", "It helps me organize..."], 
                    wordBank: ["dictionary app", "note-taking app", "language learning", "quiz app", "organize homework", "review vocabulary", "solve problems", "efficient", "resource"], 
                    samples: [
                        "A very useful app for me is Pleco, the dictionary app. When I'm reading English texts, I can quickly look up new words, which makes studying much more efficient.",
                        "I use a note-taking app called Notion to organize all my school subjects. I can make checklists for homework and keep all my notes in one place, which is very helpful.",
                        "I find language learning apps like Duolingo useful. I use it to practice my English vocabulary for a few minutes every day, and the games make it fun to learn."
                    ] 
                }
            ],
            "Future & Dreams": [
                { 
                    question: "What job or career are you interested in for the future? What skills do you think you need to develop for it?", 
                    starters: ["In the future, I'd like to be a...", "I'm interested in a career in...", "To become a..., I need to develop...", "My dream job is..."], 
                    wordBank: ["doctor", "engineer", "designer", "scientist", "problem-solving", "communication skills", "creativity", "strong foundation", "passion"], 
                    samples: [
                        "In the future, I'd like to be a software engineer. I need to develop strong problem-solving skills and become fluent in several programming languages.",
                        "I'm interested in a career in graphic design. To succeed, I need to improve my creativity and learn how to use professional design software like Photoshop.",
                        "My dream job is to be a doctor. I know I'll need a strong foundation in biology and chemistry, and I also need to develop good communication skills to talk to patients."
                    ] 
                },
                { 
                    question: "If you could have any superpower, what would it be and how would you use it to help others?", 
                    starters: ["If I had a superpower, I would choose...", "I would use this power to...", "With the ability to..., I could...", "My chosen superpower would be..."], 
                    wordBank: ["flying", "teleportation", "healing", "invisibility", "super strength", "help people", "solve problems", "make the world better", "protect"], 
                    samples: [
                        "If I could have any superpower, I would choose the ability to heal. I would use it to help sick people in hospitals and cure diseases.",
                        "I would choose teleportation. I could use it to deliver emergency supplies to places affected by natural disasters instantly.",
                        "My chosen superpower would be flying. It would be amazing to see the world from above, and I could use it to help find people who are lost in the mountains or at sea."
                    ] 
                }
            ],
            "Friendship": [
                 { 
                    question: "What qualities do you think are most important in a good friend?", 
                    starters: ["For me, the most important quality is...", "A good friend should be...", "I value friends who are...", "Honesty is crucial because..."], 
                    wordBank: ["honesty", "loyalty", "supportive", "trustworthy", "good listener", "sense of humor", "kindness", "dependable", "understanding"], 
                    samples: [
                        "For me, the most important quality in a friend is trustworthiness. It's essential to have someone you can share your secrets with and know they won't tell anyone.",
                        "I value friends who are supportive. When you're going through a difficult time, having a friend who encourages you and believes in you makes a huge difference.",
                        "A good friend should have a great sense of humor. Life can be stressful, and it's important to have friends you can laugh with."
                    ] 
                },
                { 
                    question: "Describe a time a friend helped you with a problem. What happened and how did it make you feel?", 
                    starters: ["I remember one time when...", "I was struggling with..., and my friend...", "They helped me by...", "It made me feel..."], 
                    wordBank: ["grateful", "supported", "understood", "relieved", "academic problem", "personal issue", "listened to me", "gave me advice", "cheered me up"], 
                    samples: [
                        "I remember I was really struggling to understand a math concept before a big test. My friend, who is great at math, spent an entire afternoon explaining it to me until I finally got it. I felt so grateful.",
                        "There was a time I was feeling sad after a disagreement with my parents. My best friend just sat and listened to me without judging. It made me feel understood and much less alone.",
                        "I once forgot my homework at home, and my friend let me look at theirs during the break so I could quickly finish it before class. It made me feel so relieved and supported."
                    ] 
                }
            ]
        };

        // --- DOM Elements ---
        const ui = {
            welcomeScreen: document.getElementById('welcome-screen'),
            practiceScreen: document.getElementById('practice-screen'),
            nameEntryContainer: document.getElementById('name-entry-container'),
            nameInput: document.getElementById('name-input'),
            startWithNameBtn: document.getElementById('start-with-name-btn'),
            topicSelectionContainer: document.getElementById('topic-selection-container'),
            userNameDisplay: document.getElementById('user-name-display'),
            topicSelection: document.getElementById('topic-selection'),
            nextBtn: document.getElementById('next-btn'),
            backToTopicsBtn: document.getElementById('back-to-topics-btn'),
            samplesBtn: document.getElementById('samples-btn'),
            timerDisplay: document.getElementById('timer-display'),
            timerProgress: document.getElementById('timer-progress'),
            phaseIndicator: document.getElementById('phase-indicator'),
            questionText: document.getElementById('question-text'),
            samplesContainer: document.getElementById('samples-container'),
            samplesList: document.getElementById('samples-list'),
            startersContainer: document.getElementById('starters-container'),
            startersList: document.getElementById('starters-list'),
            wordBankContainer: document.getElementById('word-bank-container'),
            wordBankList: document.getElementById('word-bank-list'),
            errorMessagebox: document.getElementById('error-message-box'),
            recordBtn: document.getElementById('record-btn'),
            stopRecordBtn: document.getElementById('stop-record-btn'),
            audioPlayer: document.getElementById('audio-player'),
            recordingStatus: document.getElementById('recording-status'),
            postRecordingActions: document.getElementById('post-recording-actions'),
            downloadBtn: document.getElementById('download-btn'),
            certificateScreen: document.getElementById('certificate-screen'),
            downloadCertificateBtn: document.getElementById('download-certificate-btn'),
            backToMainMenuBtn: document.getElementById('back-to-main-menu-btn'),
            modal: document.getElementById('confirmation-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn')
        };


        // --- State Variables ---
        let userName = '';
        let currentQuestionIndex = 0;
        let masterQuestionList = [];
        let currentQuestions = []; 
        let timerInterval;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;
        let completedTopics = {};

        const FULL_DASH_ARRAY = 283;
        const DEFAULT_RESPONSE_TIME = 60;

        // --- Text-to-Speech ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;
        let ttsInitialized = false;

        function initializeTTS() {
            return new Promise((resolve) => {
                if (!synth) {
                    ttsInitialized = true;
                    return resolve();
                }

                const setBestVoice = () => {
                    const voices = synth.getVoices();
                    if (voices.length === 0) return;
                    
                    const scoreVoice = (voice) => {
                        let score = 0;
                        const name = voice.name.toLowerCase();
                        if (name.includes('natural')) score += 5;
                        if (name.includes('brian') || name.includes('emma')) score += 4;
                        if (name.includes('microsoft')) score += 3;
                        if (name.includes('google')) score += 2;
                        if (voice.localService) score += 1;
                        return score;
                    };

                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    if (englishVoices.length > 0) {
                        englishVoices.sort((a, b) => scoreVoice(b) - scoreVoice(a));
                        preferredVoice = englishVoices[0];
                    }
                    
                    ttsInitialized = true;
                    resolve();
                };

                if (synth.getVoices().length > 0) {
                    setBestVoice();
                } else {
                    synth.onvoiceschanged = setBestVoice;
                }
            });
        }

        function speak(text) {
            if (!ttsInitialized || !synth || !text) {
                console.warn("TTS not ready or text is empty.");
                return;
            }

            try {
                if (synth.speaking) {
                    synth.cancel();
                }
                setTimeout(() => {
                    const utterThis = new SpeechSynthesisUtterance(text);
                    utterThis.onerror = (event) => {
                        console.error(`SpeechSynthesisUtterance.onerror: ${event.error}`, { text: text });
                    };
                    if (preferredVoice) {
                        utterThis.voice = preferredVoice;
                    }
                    utterThis.pitch = 1;
                    utterThis.rate = 0.85;
                    synth.speak(utterThis);
                }, 100); 

            } catch (e) {
                console.error("Speech synthesis 'speak' function threw an exception:", e);
            }
        }

        // --- Local Storage ---
        function loadProgress() {
            const savedCompletedTopics = localStorage.getItem('languagePracticeCompletedTopics04');
            if (savedCompletedTopics) {
                try {
                    const parsed = JSON.parse(savedCompletedTopics);
                    if (typeof parsed === 'object' && parsed !== null) {
                        completedTopics = parsed;
                    } else {
                         completedTopics = {};
                    }
                } catch (e) {
                    console.error("Failed to parse saved progress:", e);
                    completedTopics = {};
                }
            }
            const savedName = localStorage.getItem('languagePracticeUserName04');
            if (savedName) {
                 userName = savedName;
                 ui.nameInput.value = userName;
            }
        }

        function saveProgress() {
            localStorage.setItem('languagePracticeCompletedTopics04', JSON.stringify(completedTopics));
            if(userName) localStorage.setItem('languagePracticeUserName04', userName);
        }

        // --- UI Initialization & Data Setup ---
        function initializeTopics() {
            ui.topicSelection.innerHTML = '';
            for (const topic in practiceData) {
                const button = document.createElement('button');
                
                let checkmark = '';
                if (completedTopics && completedTopics[topic]) {
                    checkmark = `<i class="fas fa-check-circle ml-2 text-blue-500"></i>`;
                    button.className = "w-full bg-green-100 dark:bg-green-900/50 p-2 rounded-lg shadow-md hover:bg-green-200 dark:hover:bg-green-800/60 transition-colors flex items-center justify-center";
                } else {
                    button.className = "w-full bg-white dark:bg-gray-700 p-2 rounded-lg shadow-md hover:bg-indigo-100 dark:hover:bg-indigo-800 transition-all transform hover:scale-105 flex items-center justify-center";
                }

                button.innerHTML = `<span class="text-sm font-semibold">${topic}</span> ${checkmark}`;
                button.dataset.topic = topic;
                button.addEventListener('click', () => startPractice(topic));
                ui.topicSelection.appendChild(button);
            }
        }
        
        function createMasterList() {
            masterQuestionList = [];
            for (const topic in practiceData) {
                practiceData[topic].forEach(question => {
                    masterQuestionList.push({ ...question, topicName: topic });
                });
            }
        }

        // --- Core App Logic ---
        function startPractice(topic) {
            const startIndex = masterQuestionList.findIndex(q => q.topicName === topic);
            currentQuestionIndex = (startIndex !== -1) ? startIndex : 0;
            currentQuestions = masterQuestionList;
            
            ui.welcomeScreen.classList.add('hidden');
            ui.practiceScreen.classList.remove('hidden');
            ui.certificateScreen.classList.add('hidden');
            ui.nextBtn.classList.remove('hidden');
            ui.samplesBtn.classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex > 0) {
                const prevQuestion = currentQuestions[currentQuestionIndex - 1];
                const currentQuestion = currentQuestions[currentQuestionIndex];
                if (currentQuestion && prevQuestion.topicName !== currentQuestion.topicName) {
                    if (!completedTopics[prevQuestion.topicName]) {
                        completedTopics[prevQuestion.topicName] = true;
                        saveProgress();
                    }
                }
            }

            if (currentQuestionIndex >= currentQuestions.length) {
                if (currentQuestions.length > 0) {
                    const lastTopicName = currentQuestions[currentQuestions.length - 1].topicName;
                     if (!completedTopics[lastTopicName]) {
                        completedTopics[lastTopicName] = true;
                        saveProgress();
                    }
                }
                ui.phaseIndicator.textContent = "All topics complete!";
                ui.questionText.textContent = "You've finished everything. Fantastic work!";
                speak("You've finished everything. Fantastic work!");
                ui.nextBtn.classList.add('hidden');
                ui.samplesBtn.classList.add('hidden');
                showCertificate();
                return;
            }

            ui.nextBtn.disabled = true;

            const item = currentQuestions[currentQuestionIndex];
            resetUIForNewQuestion();
            
            let fullQuestion = (item.intro ? item.intro + " " : "") + item.question;
            ui.questionText.textContent = fullQuestion;
            ui.questionText.classList.add('fade-in');
            setTimeout(() => ui.questionText.classList.remove('fade-in'), 500);

            speak(fullQuestion);
            
            if (item.starters && item.starters.length > 0) {
                ui.startersList.innerHTML = '';
                item.starters.forEach(starter => {
                    const button = document.createElement('button');
                    button.className = 'bg-indigo-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-indigo-600 dark:text-white cursor-default';
                    button.textContent = starter;
                    ui.startersList.appendChild(button);
                });
                ui.startersContainer.classList.remove('hidden');
            }

            if (item.wordBank && item.wordBank.length > 0) {
                ui.wordBankList.innerHTML = '';
                item.wordBank.forEach(word => {
                    const button = document.createElement('button');
                    button.className = 'bg-green-500 text-white text-sm font-medium px-2.5 py-1 rounded-full dark:bg-green-600 dark:text-white cursor-default';
                    button.textContent = word;
                    ui.wordBankList.appendChild(button);
                });
                ui.wordBankContainer.classList.remove('hidden');
            }

            ui.phaseIndicator.textContent = `${item.topicName} (Question ${currentQuestionIndex + 1} of ${currentQuestions.length})`;
            
            const responseTime = item.timer || DEFAULT_RESPONSE_TIME;
            startTimer(responseTime, () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                }
                ui.phaseIndicator.textContent = "Time's up! Click Next to continue.";
                ui.recordBtn.disabled = true;
                ui.recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                ui.nextBtn.disabled = false;
            });
        }
        
        function showCertificate() {
            ui.practiceScreen.classList.add('hidden');
            ui.welcomeScreen.classList.add('hidden');
            ui.certificateScreen.classList.remove('hidden');
            document.getElementById('certificate-name').textContent = userName;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
        }
        
        function showErrorMessage(message) {
            ui.errorMessagebox.textContent = message;
            ui.errorMessagebox.classList.remove('hidden');
            setTimeout(() => {
                ui.errorMessagebox.classList.add('hidden');
            }, 5000);
        }

        // --- Recording & Transcription Logic ---
        async function startRecording() {
            if (!window.MediaRecorder) {
                showErrorMessage("Audio recording is not supported on this browser.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const isMobileEdge = /Edg\/\d+.*Android/.test(navigator.userAgent);
                let options = {};
                if (!isMobileEdge) {
                    const mimeTypes = ['audio/webm;codecs=opus', 'audio/ogg;codecs=opus', 'audio/webm', 'audio/ogg'];
                    const supportedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
                    if (supportedType) options.mimeType = supportedType;
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.start();

                ui.recordBtn.classList.add('hidden');
                ui.stopRecordBtn.classList.remove('hidden');
                ui.recordingStatus.classList.remove('hidden');

                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    recordedBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedBlob);
                    ui.audioPlayer.src = audioUrl;
                    ui.postRecordingActions.classList.remove('hidden');
                    ui.recordingStatus.classList.add('hidden');
                    ui.stopRecordBtn.classList.add('hidden');
                    ui.recordBtn.classList.add('hidden');
                    ui.nextBtn.disabled = false;
                });
            } catch (err) {
                console.error("Error starting recording:", err);
                showErrorMessage("Could not start audio recording. Please grant microphone permission.");
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
        }
        
        // --- Confirmation Modal ---
        function showConfirmationModal(title, message, onConfirm) {
            ui.modalTitle.textContent = title;
            ui.modalMessage.textContent = message;
            ui.modal.classList.remove('hidden');

            const confirmHandler = () => {
                onConfirm();
                hide();
            };

            const hide = () => {
                ui.modal.classList.add('hidden');
                ui.modalConfirmBtn.removeEventListener('click', confirmHandler);
                ui.modalCancelBtn.removeEventListener('click', hide);
            };

            ui.modalConfirmBtn.addEventListener('click', confirmHandler);
            ui.modalCancelBtn.addEventListener('click', hide);
        }


        // --- Timer Functions ---
        function startTimer(duration, onEndCallback) {
            let timeLeft = duration;
            clearInterval(timerInterval);
            updateTimerDisplay(timeLeft, duration);

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft, duration);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if(onEndCallback) onEndCallback();
                }
            }, 1000);
        }

        function updateTimerDisplay(timeLeft, totalDuration) {
            const minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            if (seconds < 10) seconds = `0${seconds}`;
            ui.timerDisplay.textContent = `${minutes}:${seconds}`;
            
            const fraction = timeLeft / totalDuration;
            const offset = fraction * FULL_DASH_ARRAY;
            ui.timerProgress.style.strokeDashoffset = FULL_DASH_ARRAY - offset;
        }

        // --- UI Helper Functions ---
        function resetUIForNewQuestion() {
            ui.samplesContainer.classList.add('hidden');
            ui.startersContainer.classList.add('hidden');
            ui.wordBankContainer.classList.add('hidden');
            ui.errorMessagebox.classList.add('hidden');
            ui.recordBtn.disabled = false;
            ui.recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            resetRecordingUI();
        }

        function resetRecordingUI() {
            ui.recordBtn.classList.remove('hidden');
            ui.stopRecordBtn.classList.add('hidden');
            ui.recordingStatus.classList.add('hidden');
            ui.postRecordingActions.classList.add('hidden');
            ui.audioPlayer.src = '';
            audioChunks = [];
            recordedBlob = null;
        }

        // --- Event Listeners ---
        ui.startWithNameBtn.addEventListener('click', () => {
            userName = ui.nameInput.value.trim();
            if (userName) {
                saveProgress();
                ui.nameEntryContainer.classList.add('hidden');
                ui.userNameDisplay.textContent = userName;
                ui.topicSelectionContainer.classList.remove('hidden');
            } else {
                const nameError = document.createElement('div');
                nameError.textContent = "Please enter your name.";
                nameError.className = "text-red-500 text-sm mt-2";
                ui.startWithNameBtn.insertAdjacentElement('afterend', nameError);
                setTimeout(() => nameError.remove(), 2000);
            }
        });

        ui.recordBtn.addEventListener('click', startRecording);
        ui.stopRecordBtn.addEventListener('click', stopRecording);
        
        ui.downloadCertificateBtn.addEventListener('click', () => {
          const certificateNode = document.getElementById('certificate-to-download');
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const newTab = isIOS ? window.open() : null;

          html2canvas(certificateNode, { scale: 2 }).then(canvas => {
            canvas.toBlob(blob => {
              const url = URL.createObjectURL(blob);
              if (isIOS && newTab) {
                newTab.location = url;
              } else {
                const a = document.createElement('a');
                a.href = url;
                a.download = `Certificate_of_Completion_04_${userName.replace(/\s+/g, '_')}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
              }
              URL.revokeObjectURL(url);
            });
          });
        });

        ui.backToMainMenuBtn.addEventListener('click', () => {
            ui.certificateScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            initializeTopics();
        });

        ui.downloadBtn.addEventListener('click', () => {
            if (recordedBlob) {
                const topicName = currentQuestions[currentQuestionIndex].topicName.replace(/\s+/g, '_');
                const sanitizedUserName = userName.replace(/\s+/g, '_');
                const fileNameAudio = `P4_${sanitizedUserName}_${topicName}_Q${currentQuestionIndex + 1}.webm`;
                const blobUrl = URL.createObjectURL(recordedBlob);
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                a.download = fileNameAudio;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(blobUrl);

                const originalText = ui.downloadBtn.innerHTML;
                ui.downloadBtn.innerHTML = `<i class="fas fa-check mr-1"></i>Downloaded!`;
                ui.downloadBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                ui.downloadBtn.classList.add('bg-green-600');
                setTimeout(() => {
                    ui.downloadBtn.innerHTML = originalText;
                    ui.downloadBtn.classList.remove('bg-green-600');
                    ui.downloadBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
            }
        });

        ui.nextBtn.addEventListener('click', () => {
            ui.nextBtn.disabled = true;
            currentQuestionIndex++;
            showQuestion();
        });

        ui.backToTopicsBtn.addEventListener('click', () => {
            showConfirmationModal(
                'Return to Topics?',
                'Are you sure? This will stop your current practice session and any recording will be lost.',
                () => {
                    ui.practiceScreen.classList.add('hidden');
                    ui.welcomeScreen.classList.remove('hidden');
                    clearInterval(timerInterval);
                    if (synth && synth.speaking) synth.cancel();
                    if (mediaRecorder && mediaRecorder.state === 'recording') stopRecording();
                    initializeTopics();
                }
            );
        });

        ui.samplesBtn.addEventListener('click', () => {
            if (!ui.samplesContainer.classList.contains('hidden')) {
                ui.samplesContainer.classList.add('hidden');
                return;
            }

            const currentTopicName = masterQuestionList[currentQuestionIndex].topicName;
            const questionsForCurrentTopic = practiceData[currentTopicName];

            ui.samplesList.innerHTML = ''; 
            questionsForCurrentTopic.forEach((questionItem, index) => {
                const questionHeader = document.createElement('h4');
                questionHeader.textContent = `Q${index + 1}: ${questionItem.question}`;
                questionHeader.className = 'font-bold text-white text-sm mt-2 first:mt-0';
                ui.samplesList.appendChild(questionHeader);

                if (questionItem.samples && questionItem.samples.length > 0) {
                    questionItem.samples.forEach(sample => {
                        const li = document.createElement('li');
                        li.textContent = `\u2022 ${sample}`;
                        li.className = 'text-white text-sm sm:text-base ml-2';
                        ui.samplesList.appendChild(li);
                    });
                }
            });
            ui.samplesContainer.classList.remove('hidden');
        });
        
        // --- Initial Load ---
        async function main() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder) {
                ui.recordBtn.disabled = true;
                ui.recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                ui.recordBtn.title = "Audio recording is not supported on this browser.";
            }
            if (!window.speechSynthesis) {
                 console.warn("Text-to-speech is not supported on this browser.");
            }
            
            await initializeTTS().catch(err => console.error(err));
            
            createMasterList();
            loadProgress();
            initializeTopics();
        }
        
        main();

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (isIOS) {
            const sharepointLink = document.getElementById('sharepoint-upload-link');
            if (sharepointLink) {
                sharepointLink.removeAttribute('target');
            }
        }
    });
    </script>
</body>
</html>
