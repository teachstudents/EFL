<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Sahara: From Green Savanna to Solar Powerhouse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @keyframes desert-bg {
            0% { background-color: #fde68a; } /* Sunrise Yellow */
            25% { background-color: #f0abfc; } /* Midday Purple Haze */
            50% { background-color: #fb923c; } /* Sunset Orange */
            75% { background-color: #38bdf8; } /* Solar Panel Blue */
            100% { background-color: #fde68a; } /* Sunrise Yellow */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            animation: desert-bg 240s linear infinite;
            padding-top: 85px; /* Adjusted padding for progress bar */
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
            border: none;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px -1px rgba(0,0,0,0.2), 0 1px 2px -2px rgba(0,0,0,0.1), inset 0 -2px 0 0 rgba(0,0,0,0.2);
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 44px; padding: 0 4px;
            border: 2px dashed #9ca3af; border-radius: 8px; margin: 0 4px;
            vertical-align: middle; background-color: #f3f4f6;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 8px;
            background-color: white; user-select: none;
        }
        .word-bank-word.selected { outline: 2px solid #6366f1; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; }
        .gap.correct .word-bank-word { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .gap.incorrect .word-bank-word { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Feedback Message & Badge Notification */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #fde047, #f97316); }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 20px; } to { opacity: 0; bottom: 0; } }

        /* Certificate Canvas */
        #completion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* Progress Bar */
        #progress-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 8px; width: 100%; margin-top: 8px; }
        #progress-bar { height: 100%; width: 0%; background-color: #38bdf8; transition: width 0.5s ease-out; }
        
        /* Vocab Game Timer */
        #vocab-game-timer-bar { height: 6px; background-color: #38bdf8; transition: width 0.1s linear; }
        
        /* Shake Animation for incorrect answers */
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        .explanation-text {
            margin-top: 12px;
            padding: 10px;
            background-color: #f3f4f6;
            border-left: 4px solid #f59e0b;
            font-size: 0.9em;
            color: #4b5563;
            border-radius: 4px;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #certificate-to-print, #certificate-to-print * { visibility: visible; }
            #certificate-to-print { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="antialiased text-gray-800 text-lg">
    <canvas id="background-canvas"></canvas>
    <div id="reward-animation-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]"></div>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-md mx-auto bg-white/90 backdrop-blur-sm shadow-lg rounded-full p-2">
            <div class="flex justify-center items-center gap-2">
                <button onclick="goBack()" class="nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="font-bold text-base text-amber-500 px-3 whitespace-nowrap">Points ‚ú®: <span id="score-display">0</span></div>
                <button onclick="navigateTo('main-menu')" class="nav-button bg-gray-800 text-white font-bold p-2 rounded-full hover:bg-gray-900">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                </button>
                <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-full hover:bg-gray-200" title="Toggle Sound">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
                </button>
                <button onclick="goNext()" class="nav-button bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
        </div>
    </header>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <section id="page-title-screen" class="page active text-center bg-white rounded-2xl shadow-lg p-8">
            <div class="h-full flex flex-col justify-center items-center">
                <h1 id="main-title" class="text-5xl md:text-6xl font-bold text-slate-800 mb-4"></h1>
                <p id="main-subtitle" class="text-xl md:text-2xl text-gray-600 mb-8"></p>
                <div id="main-svg-container" class="rounded-lg mb-8 w-full max-w-lg mx-auto"></div>
                <button onclick="startApp()" class="action-button bg-orange-500 text-white font-bold py-3 px-8 rounded-full text-2xl hover:bg-orange-600">START LESSON</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION (SAHARA) ---
        // ===================================================================================
        const lessonData = {
            title: "The Sahara",
            subtitle: "From Green Savanna to Solar Powerhouse <span aria-hidden='true'>‚òÄÔ∏è</span>",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-tps', text: '0. Think-Pair-Share <span aria-hidden="true">üß†</span>', color: 'amber', target: 'tps-start' },
                { id: 'menu-goals', text: '1. Learning Goals <span aria-hidden="true">üéØ</span>', color: 'teal', target: 'learning-goals' },
                { id: 'menu-warmup', text: '2. Warm-Up & Vocab <span aria-hidden="true">üìö</span>', color: 'sky', target: 'warm-up' },
                { id: 'menu-vocab-game', text: 'Vocab Game <span aria-hidden="true">üéÆ</span>', color: 'sky', target: 'vocab-game'},
                { id: 'menu-reading1', text: '3. Reading: Green Past, Dry Present <span aria-hidden="true">üìú</span>', color: 'green', target: 'reading-history' },
                { id: 'menu-reading2', text: '4. Reading: A Solar Future? <span aria-hidden="true">‚òÄÔ∏è</span>', color: 'blue', target: 'reading-solar' },
                { id: 'menu-convo1', text: '5. Listening: A Conversation <span aria-hidden="true">üßë‚Äçü§ù‚Äçüßë</span>', color: 'lime', target: 'convo-students' },
                { id: 'menu-podcast1', text: '6. Listening: A Podcast <span aria-hidden="true">üéß</span>', color: 'orange', target: 'podcast-experts' },
                { id: 'menu-debate', text: '7. Discussion: Project Hurdles <span aria-hidden="true">ü§î</span>', color: 'rose', target: 'debate-hurdles' },
                { id: 'menu-writing', text: '7b. Writing Activity <span aria-hidden="true">üìù</span>', color: 'purple', target: 'writing-activity' },
                { id: 'menu-final', text: '8. Final Projects <span aria-hidden="true">‚úçÔ∏è</span>', color: 'violet', target: 'final-project-hub' },
            ],
            vocabulary: [
                { word: 'Savanna', def: 'A grassy plain in tropical or subtropical regions, with few trees.', sentence: 'Thousands of years ago, the Sahara was a lush savanna, not a desert.' },
                { word: 'Desertification', def: 'The process by which fertile land becomes desert, typically as a result of drought, deforestation, or inappropriate agriculture.', sentence: 'Climate change and human activities are accelerating desertification in the Sahel region.' },
                { word: 'African Humid Period', def: 'A climate period in Africa (c. 11,000 to 5,000 years ago) during which the Sahara was much wetter and greener.', sentence: 'Rock art from the African Humid Period shows animals like hippos and giraffes.' },
                { word: 'Sahel', def: 'The eco-climatic and biogeographic zone of transition in Africa between the Sahara to the north and the savannas to the south.', sentence: 'The Sahel is particularly vulnerable to desertification.' },
                { word: 'Great Green Wall', def: 'An ambitious African-led initiative to grow an 8,000km line of trees and plants across Africa to combat land degradation.', sentence: 'The Great Green Wall is more of a mosaic of projects than a literal wall.' },
                { word: 'Concentrated Solar Power', def: 'A system that uses mirrors or lenses to concentrate a large area of sunlight onto a receiver.', sentence: 'Concentrated Solar Power can generate electricity even after the sun has set.' },
                { word: 'Photovoltaics (PV)', def: 'The conversion of light into electricity using semiconducting materials, often seen in solar panels.', sentence: 'PV panels are becoming cheaper and more efficient every year.' },
                { word: 'Geopolitics', def: 'Politics, especially international relations, as influenced by geographical factors.', sentence: 'The geopolitics of building power lines across multiple countries is a major challenge.' },
                { word: 'Ecosystem', def: 'A biological community of interacting organisms and their physical environment.', sentence: 'The ancient green Sahara supported a rich ecosystem of plants and animals.' },
                { word: 'Infrastructure', def: 'The basic physical and organizational structures and facilities (e.g., buildings, roads, power supplies) needed for the operation of a society.', sentence: 'The cost of infrastructure for transmitting solar power is enormous.' }
            ],
            pages: [
                // 0. Think Pair Share
                { id: 'tps-start', type: 'simple', content: { title: 'Activity: Think-Pair-Share <span aria-hidden="true">üß†</span>', text: 'Let\'s think about how places change over time.' } },
                { id: 'tps-think', type: 'timer', content: { title: '1. Think <span aria-hidden="true">ü§î</span>', text: 'Look at a picture of the Sahara Desert today. Now, imagine that same place thousands of years ago was green and full of lakes and animals. What do you think could cause such a dramatic change in a landscape?', duration: 120, timerId: 'timer-think' } },
                { id: 'tps-pair', type: 'timer', content: { title: '2. Pair <span aria-hidden="true">üë•</span>', text: 'With a partner, share your ideas. Discuss what this tells you about Earth\'s climate. Is the climate always stable, or does it change naturally? How might human actions affect this natural process?', duration: 180, timerId: 'timer-pair' } },
                { id: 'tps-share', type: 'timer', content: { title: '3. Share <span aria-hidden="true">üó£Ô∏è</span>', text: 'As a class, let\'s share some of our thoughts. How does understanding that the Sahara used to be green change your perspective on modern climate change and issues like desertification?', duration: 300, timerId: 'timer-share' } },

                // 1. Learning Goals
                { id: 'learning-goals', type: 'html-content', content: { title: 'Learning Goals <span aria-hidden="true">üéØ</span>', html: `
                                    <div class="text-left space-y-4">
                                        <p><strong class="text-teal-600">Learning Intention:</strong> We are learning to describe the Sahara's environmental history and evaluate its potential as a source of renewable energy.</p>
                                        <hr class="my-4">
                                        <h3 class="text-2xl font-bold text-teal-600 mb-3">Success Criteria</h3>
                                        <ul class="list-disc list-inside space-y-2 text-xl">
                                            <li>I can describe the environmental conditions of the "Green Sahara".</li>
                                            <li>I can identify the main causes of modern <strong>desertification</strong>.</li>
                                            <li>I can explain the potential benefits of Saharan solar power.</li>
                                            <li>I can analyze the significant hurdles (political, economic, environmental) to large-scale solar projects in the region.</li>
                                        </ul>
                                    </div>` } },
                
                // 2. Warm-Up & Vocab
                { id: 'warm-up', type: 'html-content', content: { title: 'Pre-Reading & Pre-Listening <span aria-hidden="true">üìö</span>', html: `
                                    <ol class="list-decimal list-inside space-y-6 text-xl text-left">
                                        <li>When you think of the Sahara Desert, what are the first three words that come to your mind?</li>
                                        <li>The module talks about a "Green Sahara." What do you think that means? What would a "Green Sahara" look like?</li>
                                        <li>What is "solar power"? How do we use it today, and why is it considered a "clean" form of energy?</li>
                                        <li>Imagine you have to build a giant power plant in the middle of a desert. What are some of the biggest challenges you might face?</li>
                                        <li>What is the "Great Green Wall"? Based on its name, what do you think its purpose might be?</li>
                                    </ol>` } },
                { id: 'vocab-start', type: 'simple', content: { title: 'Unit Vocabulary <span aria-hidden="true">üìö</span>', text: 'Let\'s learn the key terms for this unit. Click the "Next" arrow to cycle through the words.' } },
                { id: 'vocab-game', type: 'vocab-game', content: { title: 'Vocabulary Review Game <span aria-hidden="true">üéÆ</span>'} },
                
                // 3. Reading: History
                { id: 'reading-history', type: 'html-content', content: { title: 'Reading: Green Past, Dry Present <span aria-hidden="true">üìú</span>', html: `
                                    <div class="space-y-6 text-left readable-content">
                                        <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-green-500">
                                            <h4 class="font-bold text-xl text-gray-800">Level 1: The Main Idea</h4>
                                            <p>A very long time ago, the Sahara was not a desert. It was a green land called a savanna, with grass, lakes, and many animals. People lived there and drew pictures of their green world on rocks. Over time, the weather changed, and the Sahara slowly turned into the big, sandy desert we know today.</p>
                                        </div>
                                        <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-green-600">
                                            <h4 class="font-bold text-xl text-gray-900">Level 2: Adding Detail</h4>
                                            <p>The "Green Sahara" existed during a time called the <strong>African Humid Period</strong>, from about 11,000 to 5,000 years ago. Natural shifts in the Earth's orbit brought heavy monsoon rains to the area, creating a rich <strong>ecosystem</strong>. Today, the opposite is happening. A process called <strong>desertification</strong>, where fertile land becomes desert, is a major problem. This is especially true in the <strong>Sahel</strong>, the region just south of the Sahara. This process is made worse by modern climate change and human activities like deforestation.</p>
                                        </div>
                                        <div class="bg-gray-200 p-4 rounded-lg border-l-4 border-green-700">
                                            <h4 class="font-bold text-xl text-gray-900">Level 3: The Full Picture</h4>
                                            <p>The transformation from savanna to desert was caused by predictable, long-term cycles in Earth's orbit, known as Milankovitch cycles, which altered the path of African monsoons. While this initial drying was a natural phenomenon, contemporary <strong>desertification</strong> is being dangerously accelerated by anthropogenic factors. Rising global temperatures and unsustainable land management practices are increasing pressure on the fragile <strong>Sahel</strong> ecosystem. In response, a massive, pan-African project called the <strong>Great Green Wall</strong> was initiated to combat land degradation through a mosaic of restorative actions.</p>
                                        </div>
                                    </div>` } },
                { id: 'reading-history-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [] } },
                { id: 'reading-history-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False/Not Given', questions: [] } },
                { id: 'reading-history-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap Fill', sentences: [] } },

                // 4. Reading: Solar Power
                { id: 'reading-solar', type: 'html-content', content: { title: 'Reading: A Solar Future? <span aria-hidden="true">‚òÄÔ∏è</span>', html: `
                                    <div class="space-y-6 text-left readable-content">
                                        <div class="bg-sky-50 p-4 rounded-lg">
                                            <h4 class="font-bold text-xl text-sky-800">A Future Powered by the Sun</h4>
                                            <p>While desertification poses a significant challenge, the Sahara's vast, sun-drenched landscape presents an extraordinary opportunity. The desert receives more solar energy than almost any other place on Earth. This has led to a major push to develop massive solar farms. Visionary projects aim to harness this power not only for the African continent but also to export clean energy to Europe via undersea cables, using technologies like <strong>Concentrated Solar Power</strong> (CSP) and <strong>Photovoltaics</strong> (PV).</p>
                                        </div>
                                        <div class="bg-blue-50 p-4 rounded-lg">
                                            <h4 class="font-bold text-xl text-blue-800">Potential Benefits</h4>
                                            <p>The potential benefits of Saharan solar power are immense. It could provide massive amounts of clean energy to power North Africa, sub-Saharan Africa, and Europe, drastically reducing global carbon emissions. It could also spur economic development, create jobs, and provide new revenue streams for countries in the region, all while reducing dependence on volatile fossil fuel markets for nations in both Africa and Europe.</p>
                                        </div>
                                        <div class="bg-red-50 p-4 rounded-lg">
                                            <h4 class="font-bold text-xl text-red-800">Significant Hurdles</h4>
                                            <p>Despite the potential, there are major challenges. Many parts of the Sahara are in regions with political and security challenges, making large-scale <strong>infrastructure</strong> projects risky. The cost of building solar farms and, crucially, the high-voltage transmission lines to carry the electricity over thousands of kilometers is enormous. There are also environmental concerns, such as the high amount of water needed for cleaning panels and the damage caused by sandstorms.</p>
                                        </div>
                                    </div>` } },
                { id: 'reading-solar-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [] } },
                { id: 'reading-solar-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False/Not Given', questions: [] } },
                { id: 'reading-solar-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap Fill', sentences: [] } },
                
                // 5. Listening: A Conversation
                { id: 'convo-students', type: 'dialogue', content: { title: 'Listening: A Conversation <span aria-hidden="true">üßë‚Äçü§ù‚Äçüßë</span>', dialogue: "Maya: I'm looking at this rock art from the Tassili n'Ajjer mountains in the Sahara. It's incredible. There are paintings of people swimming and herding cattle. How is that possible in a desert?\n\nLiam: That's the \"Green Sahara\" part of our research. It wasn't always a desert. For thousands of years, it was a savanna, like the Serengeti. The art is like a time capsule. It's direct evidence from the people who lived there, showing us exactly what their environment was like.\n\nMaya: So it's not just about history; it's climate science. The art proves the climate was completely different.\n\nLiam: Exactly. And it makes you think. If it could change so drastically from wet to dry naturally, what are we doing to it now with modern climate change? It kind of puts the whole desertification issue into perspective." } },
                { id: 'convo-students-quiz-mcq', type: 'quiz-mcq', content: { title: 'Conversation Quiz (MCQ)', questions: [] } },
                { id: 'convo-students-quiz-tfng', type: 'quiz-tfng', content: { title: 'Conversation Quiz (TFNG)', questions: [] } },
                { id: 'convo-students-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Conversation Quiz (Gap Fill)', sentences: [] } },
                
                // 6. Listening: Podcast
                { id: 'podcast-experts', type: 'dialogue', content: { title: 'Listening: A Podcast <span aria-hidden="true">üéß</span>', dialogue: "Dr. Lena Hassan: Welcome to 'Planet Forward.' Today, we're discussing the Sahara's future. With us is Dr. Ben Carter, a climate scientist, and Javier Morales, a renewable energy analyst. Ben, let's start with the Great Green Wall. Is it working?\n\nDr. Ben Carter: The progress is slower than hoped, but the concept is sound. It's not just a wall of trees. It's a mosaic of projects‚Äîreforestation, sustainable farming, water conservation. Where it has been implemented, it's restoring land and lives. But it's battling against accelerating climate change and requires immense international support to succeed on a continental scale.\n\nDr. Lena Hassan: Javier, turning to you. The idea of powering Europe with Saharan sun has been around for a while. Is it fantasy?\n\nJavier Morales: Less of a fantasy every year. The technology is here. The cost of solar has plummeted. The real barriers are what we call 'above-ground risks.' You have to build massive transmission lines across multiple countries with varying levels of political stability. You need international agreements that hold up for decades. The engineering is the easy part; the geopolitics is the puzzle we're still trying to solve." } },
                { id: 'podcast-experts-quiz-mcq', type: 'quiz-mcq', content: { title: 'Podcast Quiz (MCQ)', questions: [] } },
                { id: 'podcast-experts-quiz-tfng', type: 'quiz-tfng', content: { title: 'Podcast Quiz (TFNG)', questions: [] } },
                { id: 'podcast-experts-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Podcast Quiz (Gap Fill)', sentences: [] } },

                // 7. Discussion: Project Hurdles
                { id: 'debate-hurdles', type: 'dialogue', content: { title: 'Discussion: Project Hurdles <span aria-hidden="true">ü§î</span>', dialogue: "Moderator: Welcome. Today's topic: Of the major hurdles facing Saharan solar projects, which is the most difficult to overcome: the technical and financial cost, or the political instability?\n\nSofia: I believe it's the political instability. You can have the best, cheapest technology in the world, but if you can't guarantee the safety of your workers or the security of your transmission lines for the next 30 years, no one will invest the billions of dollars needed. A single conflict could disrupt the power supply for millions. You can't solve that with just engineering.\n\nDavid: I disagree. Money solves a lot of problems. The real issue is the sheer scale and cost of the infrastructure. Building the solar farms is one thing, but constructing thousands of kilometers of high-voltage lines across the desert and under the Mediterranean Sea is an unprecedented financial and technical challenge. If the project could be proven to be incredibly profitable and the energy cheap, countries would have a powerful incentive to cooperate and create stability. The money has to come first.\n\nSofia: But profitability depends on stability. It's a chicken-and-egg problem. Without stable agreements between countries, you can't secure the investment. Without investment, you can't build the project that would encourage stability. That's why the geopolitics must be solved first.\n\nDavid: And I'd argue that a massive, mutually beneficial economic project is one of the best tools we have to create that geopolitical stability. It forces cooperation. The technical cost is a known quantity, a number on a spreadsheet. Political risk is much harder to predict and manage." } },
                { id: 'debate-hurdles-quiz-mcq', type: 'quiz-mcq', content: { title: 'Debate Quiz (MCQ)', questions: [] } },
                { id: 'debate-hurdles-quiz-tfng', type: 'quiz-tfng', content: { title: 'Debate Quiz (TFNG)', questions: [] } },
                { id: 'debate-hurdles-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Debate Quiz (Gap Fill)', sentences: [] } },
                
                // 7b. Writing Activity
                { id: 'writing-activity', type: 'html-content', content: { title: 'Writing Activity <span aria-hidden="true">üìù</span>', html: `
                    <div class="bg-white rounded-2xl shadow-xl p-8 text-left">
                        <h2 class="text-3xl font-bold text-purple-600 mb-4">Connecting the Dots</h2>
                        <div class="space-y-3 text-lg readable-content">
                            <p><strong>Your Task:</strong> Write a 250-word response to the following question: How can the lessons from the Sahara's past and the promise of its future in solar energy teach us about the relationship between the environment, technology, and society?</p>
                            <p>In your response, consider:</p>
                            <ul class="list-disc list-inside ml-4">
                                <li>How the Sahara's change from a <strong>savanna</strong> to a desert shows that our environment is not static.</li>
                                <li>How a technological solution like solar power could bring economic development but also faces huge <strong>geopolitical</strong> and <strong>infrastructure</strong> challenges.</li>
                                <li>Whether technology alone is enough to solve a complex problem like <strong>desertification</strong>.</li>
                            </ul>
                        </div>
                         <div class="word-bank-container mt-6 p-4 bg-gray-100 rounded-lg flex flex-wrap gap-3 justify-center">
                            <h4 class="w-full text-center font-bold text-gray-700 mb-2">Word Bank</h4>
                            <span class="bg-white p-2 rounded-md shadow-sm">Savanna</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Desertification</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Ecosystem</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Infrastructure</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Geopolitics</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Technology</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Climate Change</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Sustainability</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Economic Development</span>
                            <span class="bg-white p-2 rounded-md shadow-sm">Solution</span>
                        </div>
                        <div class="mt-8">
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">My Response <span aria-hidden="true">üìì</span></h3>
                            <textarea id="journal-entry" class="w-full h-64 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Start writing your 250-word response here..."></textarea>
                        </div>
                    </div>` } },

                // 8. Final Project
                { id: 'final-project-hub', type: 'html-content', content: { title: 'Final Projects Hub <span aria-hidden="true">‚úçÔ∏è</span>', html: `
                                    <div class="bg-white rounded-2xl shadow-xl p-8 text-left space-y-8">
                                        <div>
                                            <h2 class="text-3xl font-bold text-violet-600 mb-4">Assessment 1: GRASPS Task</h2>
                                            <div class="space-y-3 text-lg">
                                                <p><strong class="font-semibold text-violet-700">Goal:</strong> To create a compelling proposal to secure funding for a component of the Sahara solar energy initiative.</p>
                                                <p><strong class="font-semibold text-violet-700">Role:</strong> You are a project development team for a renewable energy company.</p>
                                                <p><strong class="font-semibold text-violet-700">Audience:</strong> The board of directors of the World Bank's Climate Investment Funds.</p>
                                                <p><strong class="font-semibold text-violet-700">Situation:</strong> You are in the final round of a competition for a multi-billion dollar grant. Your task is to convince the board that your project is the most viable, sustainable, and impactful.</p>
                                                <p><strong class="font-semibold text-violet-700">Product:</strong> A 5-minute multimedia presentation and a one-page executive summary. Your proposal must detail your plan, address the key hurdles (political, financial, environmental), and highlight the benefits for both Africa and the world.</p>
                                                <p><strong class="font-semibold text-violet-700">Standards:</strong> Your proposal will be judged on its feasibility, persuasiveness, use of evidence, and clarity.</p>
                                            </div>
                                        </div>
                                        <hr>
                                        <div>
                                            <h2 class="text-3xl font-bold text-violet-600 mb-4">Assessment 2: Problem-Solving Group Project</h2>
                                            <div class="space-y-3 text-lg">
                                                <p><strong class="font-semibold text-violet-700">Challenge:</strong> Your group is a consulting firm hired by the African Union to design a model for a new 500-megawatt solar farm in the Sahel region. Your goal is to create a plan that is both profitable and sustainable, serving as a blueprint for future projects.</p>
                                                <p><strong class="font-semibold text-violet-700">Deliverable:</strong> A 10-page report detailing your three-part plan (Environmental Sustainability, Community Partnership, and Risk Mitigation), to be presented to the class.</p>
                                            </div>
                                        </div>
                                        <div class="mt-8">
                                            <h3 class="text-2xl font-bold text-violet-600 mb-3">My Project Notes <span aria-hidden="true">üìì</span></h3>
                                            <textarea id="field-notes" class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Jot down your ideas, key data, and arguments here..."></textarea>
                                        </div>
                                    </div>` } },
                { id: 'certificate', type: 'certificate', content: { title: 'Module Complete! <span aria-hidden="true">üéâ</span>', text: 'You have successfully completed the "Sahara" module.', certificateTitle: 'Certificate of Achievement' } }
            ]
        };
        // --- END OF LESSON CONTENT CONFIGURATION ---
        // ===================================================================================

     class SpeechService {
              constructor() { this.synth = window.speechSynthesis; this.isInitialized = false; this.isTtsEnabled = true; this.voices = {}; this.speechRate = 0.85; this.isDialoguePlaying = false; }
              async _setupVoices() {
                  const voicesPromise = new Promise(resolve => { if (this.synth.getVoices().length) return resolve(this.synth.getVoices()); this.synth.onvoiceschanged = () => resolve(this.synth.getVoices()); });
                  const availableVoices = await voicesPromise;
                  if (!availableVoices.length) { console.warn("No speech synthesis voices available."); return; }
                  const speakerToVoiceMap = {
                      'maya': ['Microsoft Emma Online (Natural) - English (United States)', 'Microsoft Ava Online (Natural) - English (United States)'],
                      'liam': ['Microsoft Brian Online (Natural) - English (United States)', 'Microsoft Andrew Online (Natural) - English (United States)'],
                      'dr. lena hassan': ['Microsoft Ava Online (Natural) - English (United States)'],
                      'dr. ben carter': ['Microsoft Brian Online (Natural) - English (United States)'],
                      'javier morales': ['Microsoft Andrew Online (Natural) - English (United States)'],
                      'moderator': ['Microsoft Brian Online (Natural) - English (United States)'],
                      'sofia': ['Microsoft Ava Online (Natural) - English (United States)'],
                      'david': ['Microsoft Andrew Online (Natural) - English (United States)'],
                      'vocab': ['Microsoft Andrew Online (Natural) - English (United States)'],
                      'brian': ['Microsoft Brian Online (Natural) - English (United States)'],
                  };
                  for (const speaker in speakerToVoiceMap) {
                      const voicePriorityList = speakerToVoiceMap[speaker];
                      let chosenVoice = null;
                      for (const voiceName of voicePriorityList) {
                          const foundVoice = availableVoices.find(v => v.name === voiceName);
                          if (foundVoice) { chosenVoice = foundVoice; break; }
                      }
                      if (chosenVoice) { this.voices[speaker] = chosenVoice; } else { console.warn(`Could not find specified voices for speaker: "${speaker}"`); }
                  }
                  this.voices['default'] = availableVoices.find(v => v.name === 'Microsoft Ava Online (Natural) - English (United States)') || availableVoices.find(v => v.lang === 'en-US');
             }
             async init() { if (this.isInitialized) return; try { const warmUp = new SpeechSynthesisUtterance(' '); warmUp.volume = 0; this.synth.speak(warmUp); this.synth.cancel(); await this._setupVoices(); this.isInitialized = true; } catch (e) { console.error("Speech synthesis setup failed:", e); } }
             _cleanTextForSpeech(text) { const tempDiv = document.createElement('div'); const textWithoutSpans = text.replace(/<span aria-hidden="true">.*?<\/span>/g, ' '); tempDiv.innerHTML = textWithoutSpans; let cleanText = tempDiv.textContent || tempDiv.innerText || ''; cleanText = cleanText.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, ''); return cleanText; }
             async speak(text, { onEndCallback = null, voiceKey = 'default' } = {}) { if (!this.isInitialized || !this.isTtsEnabled || !text) { if (onEndCallback) onEndCallback(); return; } if (this.synth.speaking) { this.synth.cancel(); await new Promise(resolve => setTimeout(resolve, 100)); } const cleanText = this._cleanTextForSpeech(text); if (!cleanText.trim()) { if (onEndCallback) onEndCallback(); return; } const utter = new SpeechSynthesisUtterance(cleanText); utter.voice = this.voices[voiceKey] || this.voices['default']; utter.rate = this.speechRate; if (onEndCallback) utter.onend = onEndCallback; utter.onerror = (e) => { console.error('SpeechSynthesisUtterance.onerror', e); if (onEndCallback) onEndCallback(); }; try { this.synth.speak(utter); } catch (e) { console.error("Error calling synth.speak:", e); if (onEndCallback) onEndCallback(); } }
             async speakDialogue(text) { if (!this.isInitialized || !this.isTtsEnabled || !text || this.isDialoguePlaying) return; this.cancel(); this.isDialoguePlaying = true; const lines = text.split('\n').filter(line => line.trim() !== '' && line.includes(':')); const queue = lines.map(line => { const [speaker, ...parts] = line.split(':'); const dialogue = parts.join(':').trim(); const cleanDialogue = this._cleanTextForSpeech(dialogue); const voiceKey = speaker.toLowerCase().replace(/dr\. |professor /g, '').trim(); return { text: cleanDialogue, voiceKey: voiceKey }; }).filter(item => item.text); if (queue.length === 0) { this.isDialoguePlaying = false; return; } const playNext = () => { if (queue.length > 0 && this.isTtsEnabled) { const item = queue.shift(); const utter = new SpeechSynthesisUtterance(item.text); utter.voice = this.voices[item.voiceKey] || this.voices['default']; utter.rate = this.speechRate; utter.onend = playNext; utter.onerror = (e) => { console.warn('A speech synthesis error occurred, attempting to recover.', e.error); try { this.synth.cancel(); } catch (cancelError) { console.error("Error while cancelling synth:", cancelError); } setTimeout(playNext, 250); }; try { this.synth.speak(utter); } catch(e) { console.error("Error in synth.speak:", e); setTimeout(playNext, 250); } } else { this.isDialoguePlaying = false; } }; playNext(); }
             cancel() { if (this.synth) { this.isDialoguePlaying = false; this.synth.cancel(); } }
             toggleTTS(forceState) { this.isTtsEnabled = forceState === undefined ? !this.isTtsEnabled : forceState; if (!this.isTtsEnabled) { this.cancel(); } return this.isTtsEnabled; }
        }

        // --- Global App State and Functions ---
        const speechService = new SpeechService();
        let score = 0, currentPage = lessonData.startPageId, timerInterval;
        const pageHistory = [lessonData.startPageId];
        let pageSequence = [];
        let completedSections = new Set();
        let vocabGameTimer;
        let selectedWord = { element: null, text: '' };
        let correctSoundSynth;


        // --- Progress and Completion Logic ---
        const pageToMenuMap = {};
        function buildPageToMenuMap() {
            lessonData.mainMenu.forEach(menuItem => {
                let queue = [menuItem.target];
                let visited = new Set(queue);
                while (queue.length > 0) {
                    const pageId = queue.shift();
                    pageToMenuMap[pageId] = menuItem.id;
                    const pageDef = lessonData.pages.find(p => p.id === pageId);
                    if (pageDef && pageDef.type.startsWith('quiz')) {
                        const nextQuizPage = getNextQuizPage(pageId);
                        if (nextQuizPage && !visited.has(nextQuizPage)) {
                            queue.push(nextQuizPage);
                            visited.add(nextQuizPage);
                        }
                    }
                }
            });
            // Manual mapping for vocab game
            pageToMenuMap['vocab-game'] = 'menu-vocab-game';
        }

        function getNextQuizPage(pageId) {
            const sequence = ['mcq', 'tfng', 'gap-fill'];
            const parts = pageId.split('-quiz-');
            if (parts.length < 2) return null;
            const prefix = parts[0];
            const type = parts[1];
            const currentIndex = sequence.indexOf(type);
            if (currentIndex > -1 && currentIndex < sequence.length - 1) {
                const nextPageId = `${prefix}-quiz-${sequence[currentIndex + 1]}`;
                if (lessonData.pages.some(p => p.id === nextPageId)) {
                    return nextPageId;
                }
            }
            return null;
        }

        function updateProgressBar() {
            const progress = (completedSections.size / lessonData.mainMenu.length) * 100;
            const bar = document.getElementById('progress-bar');
            if (bar) bar.style.width = `${progress}%`;
        }

        function updateMenuCompletionState() {
            const menuContainer = document.getElementById('page-main-menu');
            if (!menuContainer) return;
            lessonData.mainMenu.forEach(item => {
                const button = menuContainer.querySelector(`#menu-btn-${item.id}`);
                if (button && completedSections.has(item.id)) {
                    if (!button.innerHTML.includes('‚úì')) {
                        button.innerHTML += ' <span class="text-green-300">‚úì</span>';
                    }
                }
            });
        }

        function markSectionAsComplete(pageId) {
            const menuId = pageToMenuMap[pageId];
            if (menuId && !completedSections.has(menuId)) {
                completedSections.add(menuId);
                updateProgressBar();
            }
        }
        
        function checkQuizPageCompletion(pageId) {
            const pageElement = document.getElementById(`page-${pageId}`);
            if (!pageElement) return false;

            if (pageId.includes('gap-fill')) {
                const gaps = pageElement.querySelectorAll('.gap');
                return gaps.length > 0 && Array.from(gaps).every(g => g.classList.contains('correct'));
            } else {
                const questions = pageElement.querySelectorAll('.question-group');
                return questions.length > 0 && Array.from(questions).every(q => q.querySelector('button:disabled'));
            }
        }


        // --- App Navigation ---
        window.toggleTTS = (button) => {
            const isNowEnabled = speechService.toggleTTS();
            const iconPath = isNowEnabled 
                ? "M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"
                : "M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z M17 14l-4-4m0 4l4-4";
            button.querySelector('svg').classList.toggle('text-gray-600', isNowEnabled);
            button.querySelector('svg').classList.toggle('text-gray-400', !isNowEnabled);
            button.querySelector('path').setAttribute('d', iconPath);

            if (isNowEnabled) {
                const pageData = lessonData.pages.find(p => p.id === currentPage);
                const targetPage = document.getElementById(`page-${currentPage}`);
                if (pageData && pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else if (targetPage) {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    if (readableContent) speechService.speak(readableContent.innerText);
                    else if (titleElement) speechService.speak(titleElement.innerText);
                }
            }
        };

        window.startApp = async function() {
            await speechService.init(); 
            try { await Tone.start(); } catch (e) { console.error(e); }
            navigateTo(lessonData.homePageId);
        }
        
        function startTimer(duration, display, onComplete) {
            let timer = duration;
            const update = () => { display.textContent = `${String(Math.floor(timer/60)).padStart(2,'0')}:${String(timer%60).padStart(2,'0')}`; };
            update();
            timerInterval = setInterval(() => { timer--; update(); if (timer < 0) { clearInterval(timerInterval); if (onComplete) onComplete(); } }, 1000);
        }

        window.navigateTo = (pageId) => {
            const previousPageId = currentPage;
            
            // Mark completion if leaving a quiz page and it's fully answered
            if (previousPageId.includes('-quiz-')) {
                if (checkQuizPageCompletion(previousPageId)) {
                    const nextQuizPage = getNextQuizPage(previousPageId);
                    if (!nextQuizPage) { // This was the last quiz in the sequence
                       markSectionAsComplete(previousPageId);
                    }
                }
            }
            
            const targetPage = document.getElementById(`page-${pageId}`);
            if (!targetPage) return console.warn('navigateTo: no page found for id', pageId);
            if (pageId === currentPage) return;
            
            clearInterval(timerInterval);
            clearTimeout(vocabGameTimer);
            speechService.cancel();

            // Mark simple pages as complete on navigation
            const previousPageDef = lessonData.pages.find(p => p.id === previousPageId);
            if (previousPageDef && !previousPageDef.type.startsWith('quiz') && previousPageId !== 'vocab-game') {
                 markSectionAsComplete(previousPageId);
            }

            document.getElementById(`page-${currentPage}`)?.classList.remove('active');
            targetPage.classList.add('active');
            currentPage = pageId;
            if (pageHistory[pageHistory.length - 1] !== currentPage) pageHistory.push(currentPage);
            
            const pageData = lessonData.pages.find(p => p.id === pageId);
            if (pageData) {
                if (pageData.type === 'timer') {
                    const timerEl = document.getElementById(pageData.content.timerId);
                    if (timerEl) startTimer(pageData.content.duration, timerEl, goNext);
                } else if (pageData.type === 'vocab-game') {
                    startVocabGame();
                }
                
                if (pageId.startsWith('vocab-')) {
                    const vocabIndex = parseInt(pageId.split('-')[1]);
                    const vocabItem = lessonData.vocabulary[vocabIndex];
                    if (vocabItem) {
                        const textToSpeak = `${vocabItem.word}. ${vocabItem.def}. For example: ${vocabItem.sentence}`;
                        speechService.speak(textToSpeak, { voiceKey: 'vocab' });
                    }
                } else if (pageData.type === 'dialogue') {
                    speechService.speakDialogue(pageData.content.dialogue);
                } else {
                    const readableContent = targetPage.querySelector('.readable-content');
                    const titleElement = targetPage.querySelector('h2, h3');
                    const contentToSpeak = readableContent ? readableContent.innerText : (titleElement ? titleElement.innerText : '');
                    const voiceOptions = {};
                    if (pageId === 'reading-solar') {
                        voiceOptions.voiceKey = 'brian';
                    }
                    speechService.speak(contentToSpeak, voiceOptions);
                }
            } else if (pageId === lessonData.homePageId) {
                speechService.speak(targetPage.querySelector('h2').innerText);
                updateMenuCompletionState();
            }
            updateNavButtons();
            window.scrollTo(0, 0);
        }

        window.goNext = () => { const currentIndex = pageSequence.indexOf(currentPage); if (currentIndex > -1 && currentIndex < pageSequence.length - 1) navigateTo(pageSequence[currentIndex + 1]); }
        window.goBack = () => { if (pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); } }

        function updateNavButtons() {
            const nav = document.getElementById('nav-header');
            if (!nav) return;
            nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
            const backBtn = nav.querySelector('button:first-child');
            backBtn.disabled = pageHistory.length <= 1;
            backBtn.classList.toggle('opacity-50', backBtn.disabled);
            const nextBtn = nav.querySelector('button:last-child');
            const currentIndex = pageSequence.indexOf(currentPage);
            const isLast = currentIndex >= pageSequence.length - 1;
            nextBtn.disabled = isLast || currentPage === lessonData.homePageId;
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }
        
        function playCorrectSound() {
            if (!correctSoundSynth) {
                correctSoundSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 },
                }).toDestination();
            }
            const now = Tone.now();
            correctSoundSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n", now);
        }

        function triggerConfetti() {
            const container = document.getElementById('reward-animation-container');
            const colors = ['#fde047', '#f97316', '#38bdf8', '#22c55e', '#a855f7'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = confetti.style.width;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.top = `${Math.random() * 100}%`;
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.opacity = '0';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                const animation = `confetti-fall ${Math.random() * 2 + 1.5}s ease-out forwards`;
                confetti.style.animation = animation;
                container.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3500);
            }
        }

        function showFeedbackMessage(isCorrect, verbalPraise = false) {
            const correctFeedback = ["That's right!", "Excellent!", "Perfect!", "Great job!"];
            const incorrectFeedback = ["Not quite.", "Keep trying!", "Almost there."];
            const message = isCorrect ? correctFeedback[Math.floor(Math.random() * correctFeedback.length)] : incorrectFeedback[Math.floor(Math.random() * incorrectFeedback.length)];
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `feedback-toast ${isCorrect ? 'correct' : 'encouraging'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
            if (isCorrect && verbalPraise) {
                speechService.speak(message);
            }
        }

        function updateScore(points) { score += points; document.getElementById('score-display').textContent = score; }

        function checkCompletionAndMark() {
            const nextQuizPage = getNextQuizPage(currentPage);
             if (!nextQuizPage && checkQuizPageCompletion(currentPage)) {
                 markSectionAsComplete(currentPage);
             }
        }

        function handleCorrectAnswer(button) {
            updateScore(10);
            playCorrectSound();
            triggerConfetti();
            showFeedbackMessage(true, true);
        }

        window.checkTfngAnswer = function(clickedButton, chosenAnswer, correctAnswer) {
            const buttonContainer = clickedButton.parentElement;
            Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
            const isCorrect = chosenAnswer === correctAnswer;
            if (isCorrect) {
                handleCorrectAnswer(clickedButton);
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-green-500');
            } else {
                showFeedbackMessage(false, false);
                clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-red-600');
                const correctBtn = Array.from(buttonContainer.children).find(btn => btn.textContent === correctAnswer.charAt(0));
                if (correctBtn) correctBtn.className = correctBtn.className.replace(/bg-\w+-500/, 'bg-green-500');
            }
            setTimeout(checkCompletionAndMark, 100);
        }
        
        window.checkMcqAnswer = function(button, isCorrect) {
            const questionGroup = button.closest('.question-group');
            questionGroup.querySelectorAll('.quiz-option').forEach(opt => opt.disabled = true);
            if (isCorrect) {
                handleCorrectAnswer(button);
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'border-green-600', 'text-white');
            } else {
                showFeedbackMessage(false, false);
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'border-red-600', 'text-white', 'shake');
                const correctButton = questionGroup.querySelector(".quiz-option[data-correct='true']");
                if (correctButton) {
                    correctButton.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    correctButton.classList.add('bg-green-500', 'border-green-600', 'text-white');
                }
            }
            setTimeout(checkCompletionAndMark, 100);
        }

        function initGapFill(pageId) {
            const page = document.getElementById(pageId);
            if (!page) return;
            const gaps = page.querySelectorAll('.gap');
            const words = page.querySelectorAll('.word-bank-word');
            const wordBank = page.querySelector('.word-bank-container');

            words.forEach(word => {
                word.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', word.dataset.word); });
                word.addEventListener('click', handleWordClick);
            });
            gaps.forEach(gap => {
                gap.addEventListener('dragover', e => e.preventDefault());
                gap.addEventListener('drop', e => handleDrop(e, gap));
                gap.addEventListener('click', handleGapClick);
            });

            function handleWordClick(e) {
                const clickedWord = e.currentTarget;
                if (clickedWord.parentElement.classList.contains('gap')) { 
                    clickedWord.parentElement.classList.remove('correct', 'incorrect');
                    wordBank.appendChild(clickedWord); 
                    return; 
                }
                if (selectedWord.element) selectedWord.element.classList.remove('selected');
                if (selectedWord.element === clickedWord) { selectedWord = { element: null, text: '' }; } 
                else { selectedWord = { element: clickedWord, text: clickedWord.dataset.word }; clickedWord.classList.add('selected'); }
            }
            function handleGapClick(e) {
                const clickedGap = e.currentTarget;
                if (clickedGap.children.length > 0 && selectedWord.element) { // Swap words
                    const wordInGap = clickedGap.children[0];
                    const originalParent = selectedWord.element.parentElement;
                    originalParent.appendChild(wordInGap);
                    clickedGap.appendChild(selectedWord.element);
                    checkGap(clickedGap);
                } else if (selectedWord.element) { // Place word in empty gap
                    clickedGap.appendChild(selectedWord.element);
                    checkGap(clickedGap);
                } else if (clickedGap.children.length > 0) { // Return word to bank
                    wordBank.appendChild(clickedGap.children[0]);
                    clickedGap.classList.remove('correct', 'incorrect');
                }

                if(selectedWord.element) selectedWord.element.classList.remove('selected');
                selectedWord = { element: null, text: '' };
            }
            function handleDrop(e, gap) {
                e.preventDefault();
                const wordText = e.dataTransfer.getData('text/plain');
                const wordElement = page.querySelector(`.word-bank-word[data-word="${wordText}"]`);
                if (wordElement) { 
                    if (gap.children.length > 0) {
                        wordBank.appendChild(gap.children[0]);
                        gap.classList.remove('correct', 'incorrect');
                    }
                    gap.appendChild(wordElement); 
                    checkGap(gap); 
                }
            }
            function checkGap(gap) {
                const word = gap.querySelector('.word-bank-word');
                const isCorrect = word && word.dataset.word.toLowerCase() === gap.dataset.answer.toLowerCase();
                gap.classList.toggle('correct', isCorrect);
                gap.classList.toggle('incorrect', !isCorrect);
                if (isCorrect) { 
                    updateScore(10);
                    playCorrectSound();
                    triggerConfetti();
                    showFeedbackMessage(true, true);
                } else { 
                    showFeedbackMessage(false, false); 
                }
                setTimeout(checkCompletionAndMark, 100);
            }
        }

        // --- Vocab Game Logic ---
        let vocabGameQuestions = [];
        let vocabGameCurrentIndex = 0;
        let vocabGameScore = 0;
        const ROUND_TIME = 10000; // 10 seconds

        function startVocabGame() {
            vocabGameQuestions = [...lessonData.vocabulary].sort(() => 0.5 - Math.random());
            vocabGameCurrentIndex = 0;
            vocabGameScore = 0;
            document.getElementById('vocab-game-score').textContent = '0';
            nextVocabGameRound();
        }

        function nextVocabGameRound() {
            if (vocabGameCurrentIndex >= vocabGameQuestions.length) {
                endVocabGame();
                return;
            }
            
            const question = vocabGameQuestions[vocabGameCurrentIndex];
            document.getElementById('vocab-game-definition').textContent = question.def;
            
            const options = [question.word];
            const wrongAnswers = lessonData.vocabulary.filter(v => v.word !== question.word);
            while (options.length < 4 && wrongAnswers.length > 0) {
                const randomWrong = wrongAnswers.splice(Math.floor(Math.random() * wrongAnswers.length), 1)[0];
                options.push(randomWrong.word);
            }
            
            const optionsContainer = document.getElementById('vocab-game-options');
            optionsContainer.innerHTML = '';
            options.sort(() => 0.5 - Math.random()).forEach(opt => {
                const button = document.createElement('button');
                button.className = 'quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200';
                button.textContent = opt;
                button.onclick = () => checkVocabGameAnswer(button, opt === question.word);
                optionsContainer.appendChild(button);
            });

            startRoundTimer();
        }
        
        function startRoundTimer() {
            clearTimeout(vocabGameTimer);
            const timerBar = document.getElementById('vocab-game-timer-bar');
            timerBar.style.transition = 'none';
            timerBar.style.width = '100%';
            
            setTimeout(() => {
                timerBar.style.transition = `width ${ROUND_TIME / 1000}s linear`;
                timerBar.style.width = '0%';
            }, 100);

            vocabGameTimer = setTimeout(() => {
                showFeedbackMessage(false, false);
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, ROUND_TIME);
        }

        function checkVocabGameAnswer(button, isCorrect) {
            clearTimeout(vocabGameTimer);
            if (isCorrect) {
                handleCorrectAnswer(button);
                vocabGameScore++;
                document.getElementById('vocab-game-score').textContent = vocabGameScore;
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-green-500', 'text-white');
            } else {
                showFeedbackMessage(false, false);
                button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                button.classList.add('bg-red-500', 'text-white', 'shake');
            }
            
            const optionsContainer = document.getElementById('vocab-game-options');
            optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

            setTimeout(() => {
                vocabGameCurrentIndex++;
                nextVocabGameRound();
            }, 1500);
        }

        function endVocabGame() {
            document.getElementById('vocab-game-definition').textContent = `Game Over! You scored ${vocabGameScore} out of ${vocabGameQuestions.length}.`;
            document.getElementById('vocab-game-options').innerHTML = `<button onclick="startVocabGame()" class="action-button bg-blue-500 text-white font-bold p-3 rounded-lg">Play Again</button>`;
            markSectionAsComplete('vocab-game');
        }


        function createPageElement(id, content) {
            const section = document.createElement('section');
            section.id = `page-${id}`;
            section.className = 'page';
            section.innerHTML = content;
            document.getElementById('dynamic-pages-container').appendChild(section);
        }
        
        function populateAllQuizzes() {
            // Reading: History Quizzes
            const readingHistoryMcq = lessonData.pages.find(p => p.id === 'reading-history-quiz-mcq');
            if (readingHistoryMcq) readingHistoryMcq.content.questions = [ { question: 'What was the Sahara like during the African Humid Period?', options: ['A dry desert', 'A vibrant savanna', 'Covered in ice', 'A series of volcanoes'], correctAnswer: 'A vibrant savanna' }, { question: "What is NOT a cause of modern desertification mentioned in the text?", options: ['Climate change', 'Overgrazing', 'Earthquakes', 'Deforestation'], correctAnswer: 'Earthquakes' }, { question: 'What is the "Great Green Wall"?', options: ['An ancient stone wall', 'A mountain range', 'A project to plant trees across Africa', 'A large solar farm'], correctAnswer: 'A project to plant trees across Africa' }, { question: 'What kind of evidence tells us about the "Green Sahara"?', options: ['Written books', 'Satellite images', 'Rock art', 'Dinosaur fossils'], correctAnswer: 'Rock art' }, { question: 'The region between the Sahara and the savanna is called the:', options: ['The Sahel', 'The Congo', 'The Serengeti', 'The Kalahari'], correctAnswer: 'The Sahel' } ];
            const readingHistoryTfng = lessonData.pages.find(p => p.id === 'reading-history-quiz-tfng');
            if(readingHistoryTfng) readingHistoryTfng.content.questions = [ { statement: 'The Sahara has always been a desert.', correctAnswer: 'False' }, { statement: "The change from a green savanna back to a desert was a natural process.", correctAnswer: 'True' }, { statement: 'Human activities are slowing down desertification.', correctAnswer: 'False' }, { statement: 'The Great Green Wall is a completed project.', correctAnswer: 'Not Given' }, { statement: 'The text suggests that animals like elephants once lived in the Sahara region.', correctAnswer: 'True' } ];
            const readingHistoryGapFill = lessonData.pages.find(p => p.id === 'reading-history-quiz-gap-fill');
            if (readingHistoryGapFill) readingHistoryGapFill.content.sentences = [ { text: ['During the African Humid Period, the Sahara was a vibrant', '.'], answer: 'savanna' }, { text: ["The process of land becoming desert is called", '.'], answer: 'desertification' }, { text: ['The', 'is a region at the southern edge of the desert under pressure.'], answer: 'Sahel' }, { text: ['The', 'is an ambitious initiative to restore land across the continent.'], answer: 'Great Green Wall' }, { text: ['The ancient green Sahara supported a rich', 'of plants and animals.'], answer: 'ecosystem' } ];

            // Reading: Solar Quizzes
            const readingSolarMcq = lessonData.pages.find(p => p.id === 'reading-solar-quiz-mcq');
            if(readingSolarMcq) readingSolarMcq.content.questions = [ { question: 'What major opportunity does the Sahara offer?', options: ['Oil drilling', 'Large-scale solar power', 'Diamond mining', 'Water parks'], correctAnswer: 'Large-scale solar power' }, { question: 'Which of these is a type of solar technology mentioned?', options: ['Nuclear Fusion', 'Wind Turbines', 'Concentrated Solar Power (CSP)', 'Geothermal Vents'], correctAnswer: 'Concentrated Solar Power (CSP)' }, { question: 'What is a potential economic benefit of Saharan solar projects?', options: ['Reducing the global population', 'Creating jobs and new revenue', 'Lowering food prices', 'Making the desert cooler'], correctAnswer: 'Creating jobs and new revenue' }, { question: "What is a significant hurdle for these projects?", options: ["There isn't enough sun.", "Political instability in the region.", "The technology doesn't exist yet.", "It's too cold in the desert at night."], correctAnswer: "Political instability in the region." }, { question: "What is a specific environmental concern mentioned?", options: ['The panels are too shiny', 'The projects are too noisy', 'High water usage for cleaning panels', 'The projects block animal migration'], correctAnswer: 'High water usage for cleaning panels' } ];
            const readingSolarTfng = lessonData.pages.find(p => p.id === 'reading-solar-quiz-tfng');
            if(readingSolarTfng) readingSolarTfng.content.questions = [ { statement: 'The Sahara receives very little solar energy.', correctAnswer: 'False' }, { statement: 'Projects aim to export energy to Europe.', correctAnswer: 'True' }, { statement: 'The text states that the cost of building solar farms is very low.', correctAnswer: 'False' }, { statement: 'Sandstorms are not a problem for solar panels in the desert.', correctAnswer: 'False' }, { statement: 'The project will only benefit Africa.', correctAnswer: 'False' } ];
            const readingSolarGapFill = lessonData.pages.find(p => p.id === 'reading-solar-quiz-gap-fill');
            if(readingSolarGapFill) readingSolarGapFill.content.sentences = [ { text: ['PV panels are a type of', 'technology.'], answer: 'Photovoltaics' }, { text: ['A major challenge is the high cost of', 'to transport the electricity.'], answer: 'infrastructure' }, { text: ['CSP stands for', '.'], answer: 'Concentrated Solar Power' }, { text: ['Political and security issues make large-scale projects', '.'], answer: 'risky' }, { text: ['One benefit is reducing dependence on', 'fuels.'], answer: 'fossil' } ];
            
            // Conversation Quizzes
            const convoStudentsMcq = lessonData.pages.find(p => p.id === 'convo-students-quiz-mcq');
            if(convoStudentsMcq) convoStudentsMcq.content.questions = [ { question: "What did Maya find in the Sahara rock art?", options: ['Camels and sand dunes', 'People swimming and herding cattle', 'Modern cars', 'Pyramids'], correctAnswer: 'People swimming and herding cattle' }, { question: "What does Liam compare the ancient Green Sahara to?", options: ['The Amazon Rainforest', 'The Serengeti', 'The Arctic Tundra', 'The Himalayas'], correctAnswer: 'The Serengeti' }, { question: "What does Maya realize the rock art is evidence of?", options: ['Ancient aliens', 'A different climate', 'A lost civilization', 'A movie set'], correctAnswer: 'A different climate' }, { question: "What does Liam say the art puts into perspective?", options: ['The cost of art', 'The history of cattle', 'Modern desertification', 'The importance of tourism'], correctAnswer: 'Modern desertification' } ];
            const convoStudentsTfng = lessonData.pages.find(p => p.id === 'convo-students-quiz-tfng');
            if(convoStudentsTfng) convoStudentsTfng.content.questions = [ { statement: "Maya and Liam are working on a history project.", correctAnswer: 'Not Given' }, { statement: "Liam describes the rock art as a time capsule.", correctAnswer: 'True' }, { statement: 'Maya was not surprised by what she saw in the art.', correctAnswer: 'False' }, { statement: 'The conversation suggests that Earth\'s climate can change naturally.', correctAnswer: 'True' } ];
            const convoStudentsGapFill = lessonData.pages.find(p => p.id === 'convo-students-quiz-gap-fill');
            if(convoStudentsGapFill) convoStudentsGapFill.content.sentences = [ { text: ['The rock art shows people', 'and herding cattle.'], answer: 'swimming' }, { text: ['Liam says the Sahara used to be a', ', like the Serengeti.'], answer: 'savanna' }, { text: ['Maya realizes the art is proof of a completely different', '.'], answer: 'climate' }, { text: ['The art serves as direct', 'from the people who lived there.'], answer: 'evidence' } ];

            // Podcast Quizzes
            const podcastExpertsMcq = lessonData.pages.find(p => p.id === 'podcast-experts-quiz-mcq');
            if(podcastExpertsMcq) podcastExpertsMcq.content.questions = [ { question: "What is Dr. Ben Carter's opinion on the Great Green Wall?", options: ['It is a complete failure.', 'It is finished and successful.', 'Its progress is slow, but the concept is sound.', 'It is a wall made of stone.'], correctAnswer: 'Its progress is slow, but the concept is sound.' }, { question: "According to Javier Morales, what is the 'easy part' of the Sahara solar project?", options: ['The geopolitics', 'The engineering', 'Getting the money', 'Cleaning the panels'], correctAnswer: 'The engineering' }, { question: "What does Javier Morales call the main barriers to the project?", options: ['Underground risks', 'Financial risks', 'Above-ground risks', 'Technological risks'], correctAnswer: 'Above-ground risks' }, { question: "What does Dr. Carter say the Great Green Wall is battling against?", options: ['Lack of trees', 'Accelerating climate change', 'A shortage of workers', 'Political opposition'], correctAnswer: 'Accelerating climate change' }, { question: "What is the 'puzzle' Javier Morales says they are still trying to solve?", options: ['The cost of solar panels', 'The efficiency of the technology', 'The geopolitics of international agreements', 'The lack of sunlight'], correctAnswer: 'The geopolitics of international agreements' }];
            const podcastExpertsTfng = lessonData.pages.find(p => p.id === 'podcast-experts-quiz-tfng');
            if(podcastExpertsTfng) podcastExpertsTfng.content.questions = [ { statement: 'Dr. Ben Carter is a renewable energy analyst.', correctAnswer: 'False' }, { statement: 'The Great Green Wall is just a single line of trees.', correctAnswer: 'False' }, { statement: 'Javier Morales believes the Sahara solar project is a complete fantasy.', correctAnswer: 'False' }, { statement: 'The cost of solar technology has gone up recently.', correctAnswer: 'Not Given' }, { statement: 'Javier Morales is optimistic that the Sahara solar project is becoming more realistic over time.', correctAnswer: 'True' } ];
            const podcastExpertsGapFill = lessonData.pages.find(p => p.id === 'podcast-experts-quiz-gap-fill');
            if(podcastExpertsGapFill) podcastExpertsGapFill.content.sentences = [ { text: ['The Great Green Wall is a', 'of different projects.'], answer: 'mosaic' }, { text: ['Javier says the real barriers are the', '.'], answer: 'geopolitics' }, { text: ['The cost of solar has', 'in recent years.'], answer: 'plummeted' }, { text: ['The project requires international agreements that hold up for', '.'], answer: 'decades' }, { text: ['The project requires immense international', 'to succeed on a large scale.'], answer: 'support' } ];
            
            // Debate: Hurdles Quizzes
            const debateHurdlesMcq = lessonData.pages.find(p => p.id === 'debate-hurdles-quiz-mcq');
            if(debateHurdlesMcq) debateHurdlesMcq.content.questions = [ { question: "What does Sofia believe is the biggest hurdle?", options: ['The financial cost', 'The technical challenges', 'Political instability', 'Environmental concerns'], correctAnswer: 'Political instability' }, { question: "What does David believe is the biggest hurdle?", options: ['Political instability', 'The sheer scale and cost of infrastructure', 'Finding enough workers', 'Getting permission from local communities'], correctAnswer: 'The sheer scale and cost of infrastructure' }, { question: "What does David think a profitable project would create?", options: ['More conflict', 'An incentive for countries to cooperate', 'An environmental disaster', 'Higher energy prices'], correctAnswer: 'An incentive for countries to cooperate' }, { question: "What does Sofia call the relationship between profitability and stability?", options: ['A simple solution', 'A chicken-and-egg problem', 'A waste of time', 'A technical issue'], correctAnswer: 'A chicken-and-egg problem' }, { question: "What is David's core argument about the relationship between economics and politics?", options: ['Politics should always come before economics.', 'A mutually beneficial economic project can create political stability.', 'Economics and politics are unrelated.', 'Political stability makes projects less profitable.'], correctAnswer: 'A mutually beneficial economic project can create political stability.' } ];
            const debateHurdlesTfng = lessonData.pages.find(p => p.id === 'debate-hurdles-quiz-tfng');
            if(debateHurdlesTfng) debateHurdlesTfng.content.questions = [ { statement: 'Sofia and David both agree that political instability is not a problem.', correctAnswer: 'False' }, { statement: 'David believes that money is the primary driver that can solve other problems.', correctAnswer: 'True' }, { statement: 'Sofia thinks that technical problems are harder to solve than political ones.', correctAnswer: 'False' }, { statement: 'Both speakers are arguing in favor of abandoning the project.', correctAnswer: 'False' }, { statement: 'Sofia believes that technical solutions are enough to solve the project\'s main problems.', correctAnswer: 'False' } ];
            const debateHurdlesGapFill = lessonData.pages.find(p => p.id === 'debate-hurdles-quiz-gap-fill');
            if(debateHurdlesGapFill) debateHurdlesGapFill.content.sentences = [ { text: ['Sofia argues that', 'is the biggest risk for investors.'], answer: 'instability' }, { text: ['David is focused on the enormous cost of the', '.'], answer: 'infrastructure' }, { text: ['David believes a massive economic project forces', '.'], answer: 'cooperation' }, { text: ['Sofia describes the situation as a', 'problem.'], answer: 'chicken-and-egg' }, { text: ["David views technical cost as a known", ', unlike political risk.'], answer: 'quantity' } ];
        }

        function initializeLesson() {
            document.getElementById('main-title').innerHTML = lessonData.title;
            document.getElementById('main-subtitle').innerHTML = lessonData.subtitle;
            document.getElementById('main-svg-container').innerHTML = `<svg viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="sunGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#fef08a"/><stop offset="100%" stop-color="#f97316"/></linearGradient></defs><rect width="600" height="300" fill="#f0abfc"/><path d="M0 200 C 100 150, 200 250, 300 200 C 400 150, 500 250, 600 200 V 300 H 0 Z" fill="#fb923c" fill-opacity="0.6"/><path d="M0 220 C 150 180, 250 280, 400 220 C 500 180, 550 260, 600 240 V 300 H 0 Z" fill="#d97706"/><circle cx="100" cy="100" r="40" fill="url(#sunGrad)"><animateTransform attributeName="transform" type="translate" values="0 0; 400 0; 0 0" dur="20s" repeatCount="indefinite"/></circle></svg>`;

            populateAllQuizzes();
            buildPageToMenuMap();

            const menuButtons = lessonData.mainMenu.map(item => {
                const colors = { green: 'bg-green-500 border-green-700', blue: 'bg-blue-500 border-blue-700', sky: 'bg-sky-500 border-sky-700', amber: 'bg-amber-500 border-amber-700', rose: 'bg-rose-500 border-rose-700', violet: 'bg-violet-500 border-violet-700', teal: 'bg-teal-500 border-teal-700', orange: 'bg-orange-500 border-orange-700', indigo: 'bg-indigo-500 border-indigo-700', lime: 'bg-lime-500 border-lime-700', emerald: 'bg-emerald-500 border-emerald-700', red: 'bg-red-500 border-red-700', purple: 'bg-purple-500 border-purple-700' };
                return `<button id="menu-btn-${item.id}" onclick="navigateTo('${item.target}')" class="btn-animated-3d ${colors[item.color] || colors['green']} text-white font-bold text-xl p-4 rounded-xl">${item.text}</button>`;
            }).join('');
            createPageElement(lessonData.homePageId, `<div class="bg-white rounded-2xl shadow-lg p-8"><h2 class="text-4xl font-bold text-center text-slate-800 mb-8">Main Menu</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${menuButtons}</div></div>`);
            
            const pageOrderMap = { 
                'tps-start': ['tps-think', 'tps-pair', 'tps-share'],
                'warm-up': ['vocab-start'], 
                'vocab-start': lessonData.vocabulary.map((v, i) => `vocab-${i}`),
                'reading-history': ['reading-history-quiz-mcq', 'reading-history-quiz-tfng', 'reading-history-quiz-gap-fill'],
                'reading-solar': ['reading-solar-quiz-mcq', 'reading-solar-quiz-tfng', 'reading-solar-quiz-gap-fill'],
                'convo-students': ['convo-students-quiz-mcq', 'convo-students-quiz-tfng', 'convo-students-quiz-gap-fill'],
                'podcast-experts': ['podcast-experts-quiz-mcq', 'podcast-experts-quiz-tfng', 'podcast-experts-quiz-gap-fill'],
                'debate-hurdles': ['debate-hurdles-quiz-mcq', 'debate-hurdles-quiz-tfng', 'debate-hurdles-quiz-gap-fill'],
                'writing-activity': ['final-project-hub'],
                'final-project-hub': ['certificate'] 
            };
            let flatPageList = [lessonData.startPageId, lessonData.homePageId];
            lessonData.mainMenu.forEach(item => {
                let queue = [item.target];
                let visited = new Set();
                while(queue.length > 0) {
                    let current = queue.shift();
                    if (visited.has(current)) continue;
                    visited.add(current);
                    flatPageList.push(current);
                    // Add vocab words after vocab-start
                    if (current === 'vocab-start') {
                         flatPageList.push(...lessonData.vocabulary.map((v, i) => `vocab-${i}`));
                    }
                    if (pageOrderMap[current]) {
                        queue.push(...pageOrderMap[current]);
                    }
                }
            });
            pageSequence = [...new Set(flatPageList)];

            lessonData.vocabulary.forEach((v, i) => {
                 createPageElement(`vocab-${i}`, `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h3 class="text-2xl font-bold text-sky-600 mb-2">Vocabulary ${i + 1} / ${lessonData.vocabulary.length}</h3><div class="my-8"><h2 class="text-5xl font-bold text-gray-800 mb-4">${v.word}</h2><p class="text-2xl text-gray-600 mb-4">${v.def}</p><p class="text-xl text-gray-500 italic">"${v.sentence}"</p></div></div></div>`);
            });

            lessonData.pages.forEach(page => {
                let pageHTML = '';
                switch (page.type) {
                    case 'simple': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-gray-800 mb-6">${page.content.title}</h2><p class="text-xl text-gray-600 mb-8">${page.content.text}</p></div></div>`; break;
                    case 'timer': pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-left pt-16"><div class="w-full flex justify-between items-center mb-4"><h2 class="text-2xl md:text-3xl font-bold text-blue-700">${page.content.title}</h2><div id="${page.content.timerId}" class="text-3xl md:text-4xl font-bold text-gray-700 ml-4"></div></div><div class="readable-content"><p class="text-lg md:text-xl text-gray-600 mt-8">${page.content.text}</p></div></div>`; break;
                    case 'dialogue':
                    case 'html-content':
                        const contentHTML = page.type === 'html-content' ? page.content.html : (page.content.dialogue || '').split('\n\n').map(line => `<p>${line.replace(/([^:]+):/, '<strong class="font-semibold text-blue-700">$1:</strong>')}</p>`).join('');
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-slate-800 mb-6">${page.content.title}</h2><div class="text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg max-h-[70vh] overflow-y-auto">${contentHTML}</div></div>`;
                        break;
                    case 'vocab-game':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center text-sky-600 mb-4">${page.content.title}</h2><div class="text-center mb-4 text-lg">Score: <span id="vocab-game-score" class="font-bold">0</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mb-4"><div id="vocab-game-timer-bar" class="bg-blue-600 h-2.5 rounded-full"></div></div><div id="vocab-game-definition" class="text-center text-2xl font-semibold my-6 min-h-[6rem]"></div><div id="vocab-game-options" class="grid grid-cols-2 gap-4"></div></div>`;
                        break;
                    case 'certificate':
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16 relative overflow-hidden"><canvas id="completion-canvas"></canvas><div class="relative z-10"><div class="readable-content"><h2 class="text-4xl font-bold text-amber-600 mb-4">${page.content.title}</h2><p class="text-xl text-gray-600 mb-6">${page.content.text}</p></div><div id="certificate-to-print" class="bg-amber-50 border-4 border-dashed border-amber-300 rounded-lg p-8 max-w-2xl mx-auto"><div class="flex justify-center mb-4"><span class="text-6xl"><span aria-hidden="true">‚òÄÔ∏è</span></span></div><h3 class="text-3xl font-bold text-slate-800">${page.content.certificateTitle}</h3><p class="mt-4 text-lg">This certificate is awarded to</p><p id="certificate-name" class="text-2xl font-bold text-orange-600 my-2 border-b-2 border-gray-400 pb-2">[Enter Your Name Here]</p><p class="mt-4 text-lg">for successfully completing this lesson.</p><p class="mt-6 text-md"><strong>Final Score:</strong> <span id="certificate-score" class="font-bold"></span> points</p><p class="text-sm mt-1"><strong>Date of Completion:</strong> <span id="certificate-date"></span></p></div><div id="cert-controls" class="mt-6"><div id="cert-initial-controls"><input type="text" id="name-input-cert" placeholder="Enter your name for the certificate" class="text-center p-2 border rounded-lg w-full max-w-md"><button onclick="generateCertificate()" class="action-button mt-4 bg-orange-500 text-white font-bold py-2 px-6 rounded-full hover:bg-orange-600">Generate Certificate</button></div><div id="cert-generated-controls" class="hidden mt-4 flex flex-wrap justify-center gap-4"><button onclick="downloadCertificateAsImage()" class="action-button bg-sky-600 text-white font-bold py-2 px-4 rounded-full text-sm">Download Image</button></div></div></div></div>`;
                        break;
                    case 'quiz-tfng':
                    case 'quiz-mcq':
                    case 'quiz-gap-fill':
                        let questionsHTML = '';
                        if (page.type === 'quiz-tfng' && page.content.questions) {
                            questionsHTML = page.content.questions.map((q, i) => `<div class="question-group flex items-center gap-4 p-4 rounded-lg bg-gray-100"><div class="flex-shrink-0 flex gap-2">${['True', 'False', 'Not Given'].map(l => `<button onclick="checkTfngAnswer(this, '${l}', '${q.correctAnswer}')" class="tfng-button bg-${l==='True'?'blue':l==='False'?'red':'gray'}-500 text-white font-bold w-12 h-10 rounded-full">${l.charAt(0)}</button>`).join('')}</div><p>${i + 1}. ${q.statement}</p></div>`).join('');
                        } else if (page.type === 'quiz-mcq' && page.content.questions) {
                            questionsHTML = page.content.questions.map((q, i) => `<div class="question-group ${i > 0 ? 'border-t pt-6 mt-6' : ''}"><p class="font-semibold mb-2">${i + 1}. ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-2">${q.options.map(o => `<button onclick="checkMcqAnswer(this, '${o.replace(/'/g, "\\'")}' === '${q.correctAnswer.replace(/'/g, "\\'")}')" data-correct="${o === q.correctAnswer}" class="quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200">${o}</button>`).join('')}</div></div>`).join('');
                        } else if (page.type === 'quiz-gap-fill' && page.content.sentences) {
                            const words = page.content.sentences.map(s => s.answer).sort(() => Math.random() - 0.5);
                            questionsHTML = `<div class="gap-fill-container">${page.content.sentences.map((s, i) => `<p class="text-lg mb-4">${i + 1}. ${s.text[0]} <span class="gap" data-answer="${s.answer}"></span> ${s.text[1] || ''}</p>`).join('')}</div><div class="word-bank-container mt-8 p-4 bg-gray-100 rounded-lg flex flex-wrap gap-4 justify-center">${words.map(w => `<div class="word-bank-word" draggable="true" data-word="${w}">${w}</div>`).join('')}</div>`;
                        }
                        pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h3 class="text-3xl font-bold text-rose-600 mb-6 text-center">${page.content.title}</h3><div class="space-y-6">${questionsHTML}</div></div>`;
                        break;
                }
                if (pageHTML) {
                    createPageElement(page.id, pageHTML);
                    if (page.type === 'quiz-gap-fill') initGapFill(`page-${page.id}`);
                }
            });
            updateNavButtons();
        }

        function generateCertificate() {
            const name = document.getElementById('name-input-cert').value || 'An Anonymous Learner';
            document.getElementById('certificate-name').textContent = name;
            document.getElementById('certificate-score').textContent = score;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
            document.getElementById('cert-initial-controls').classList.add('hidden');
            document.getElementById('cert-generated-controls').classList.remove('hidden');

            const canvas = document.getElementById('completion-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;
            let particles = [];
            for(let i=0; i<50; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 5 + 1,
                    color: ['#fde047', '#f97316', '#38bdf8'][Math.floor(Math.random() * 3)],
                    speed: Math.random() * 2 + 1
                });
            }
            function animateCert() {
                ctx.clearRect(0,0,canvas.width, canvas.height);
                particles.forEach(p => {
                    p.y -= p.speed;
                    if(p.y < 0) { p.y = canvas.height; p.x = Math.random() * canvas.width; }
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                });
                requestAnimationFrame(animateCert);
            }
            animateCert();
        }

        function downloadCertificateAsImage() {
            const certElement = document.getElementById('certificate-to-print');
            html2canvas(certElement, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Sahara_Lesson_Certificate.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            initializeLesson();
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            let particles = [];
            
            const styleSheet = document.createElement("style");
            styleSheet.type = "text/css";
            styleSheet.innerText = `@keyframes confetti-fall { 0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 100% { transform: translateY(1000px) rotate(360deg); opacity: 0; } }`;
            document.head.appendChild(styleSheet);
            
            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                
                particles.forEach((p, i) => {
                    p.y -= p.speed;
                    if (p.y < -p.radius) particles.splice(i, 1);
                    bgCtx.beginPath();
                    bgCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    bgCtx.fillStyle = p.color;
                    bgCtx.fill();
                });

                if (Math.random() > 0.95 && particles.length < 50) {
                    particles.push({ 
                        x: Math.random() * bgCanvas.width, 
                        y: bgCanvas.height + 20, 
                        radius: Math.random() * 2 + 1, 
                        speed: Math.random() * 0.5 + 0.2, 
                        color: `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.1})`
                    });
                }
                
                requestAnimationFrame(animateBackground);
            }
            window.addEventListener('resize', () => { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; });
            animateBackground();
        });
    </script>
</body>
</html>

