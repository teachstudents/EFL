<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Festival Fusion Challenge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+SC:wght@500;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #2e003e 0%, #4a0000 100%); /* Purple to Red */
            --glass-bg: rgba(40, 0, 40, 0.85);
            
            /* Mardi Gras Colors */
            --mg-purple: #800080;
            --mg-green: #008000;
            --mg-gold: #FFD700;
            
            /* CNY Colors */
            --cny-red: #D2042D;
            --cny-gold: #FFCC00;

            --primary-glow: var(--mg-gold);
            --secondary-glow: var(--cny-red);
            --accent-glow: var(--mg-green);
            
            /* New High Contrast Team Colors */
            --team-one-color: #00FF00; /* Bright Green/Jade */
            --team-two-color: #FFD700; /* Gold/Yellow */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cinzel', serif;
            background: var(--bg-gradient);
            color: #FFD700; /* Gold text default */
            overflow: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* --- BACKGROUND EFFECTS (CONFETTI) --- */
        #confetti-field {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg) rotateX(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg) rotateX(360deg); opacity: 0; }
        }

        /* --- LAYOUT --- */
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 5px 10px; 
            position: relative;
            z-index: 10;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER & PROGRESS --- */
        .game-progress {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 0 0;
            padding: 0.5rem 2rem;
            border-top: 3px solid var(--primary-glow);
            box-shadow: 0 -5px 20px rgba(255, 215, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            height: 70px;
        }

        .header-team-score {
            text-align: center;
            font-size: 1.5rem;
            color: var(--team-two-color); /* Changed to Gold */
            text-shadow: 0 0 5px #000;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 10px;
            border: 1px solid var(--mg-gold);
        }
        
        .header-team-score span {
            font-size: 0.9rem;
            color: #fff;
            display: block;
            margin-bottom: 2px;
            font-weight: bold;
        }

        .round-info {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
        }

        /* --- GAMEPLAY AREA --- */
        .game-play {
            display: none;
            flex-grow: 1;
            flex-direction: column;
            justify-content: flex-start;
            padding-top: 5px; 
            padding-bottom: 5px;
            height: calc(100vh - 80px);
        }

        /* NEW SHARED QUESTION BANNER */
        .question-banner {
            background: rgba(20, 0, 20, 0.6);
            border: 2px solid var(--mg-gold);
            border-radius: 15px;
            padding: 0.3rem 1rem; 
            margin-bottom: 0.5rem; 
            text-align: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 90px;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        .question-banner.visible {
            opacity: 1;
        }

        .banner-main-text {
            font-family: 'Noto Sans SC', sans-serif;
            font-size: clamp(1.8rem, 3.5vw, 3rem);
            color: var(--mg-gold);
            text-shadow: 2px 2px 0px #000, 0 0 15px var(--cny-red);
            line-height: 1.1;
            margin-bottom: 0.1rem;
        }

        .banner-sub-text {
            font-family: 'Roboto', sans-serif;
            font-size: clamp(1rem, 1.4vw, 1.6rem);
            color: #fff;
            font-style: italic;
            text-shadow: 1px 1px 2px #000;
            margin-top: 0;
            line-height: 1.2;
        }

        .battle-arena {
            display: flex;
            justify-content: center;
            gap: 2rem;
            align-items: stretch;
            height: 100%;
            max-height: 65vh; 
        }

        .versus-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 900;
            color: var(--mg-gold);
            text-shadow: 0 0 20px var(--cny-red);
            width: 60px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- PLAYER CARD --- */
        .player-card {
            flex: 1;
            background: rgba(20, 0, 20, 0.7);
            border: 2px solid var(--mg-gold);
            border-radius: 20px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 0 20px rgba(128, 0, 128, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .player-card.active-turn {
            box-shadow: 0 0 40px var(--mg-gold);
            border-color: #fff;
            background: rgba(40, 0, 0, 0.8); /* Slight reddish tint for active */
        }

        /* Top Section: Question & Answers */
        .question-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            margin-bottom: 0.5rem;
            overflow-y: auto; 
        }

        /* REVEAL TEXT */
        .correct-reveal-text {
            height: 24px;
            text-align: center;
            color: var(--mg-green);
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
            text-shadow: 0 0 5px #000;
        }
        .correct-reveal-text.show { opacity: 1; }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.6rem;
            opacity: 1;
            transition: opacity 0.3s ease-in;
            margin-top: 0.5rem;
        }
        
        .answers-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .answer-btn {
            background: linear-gradient(90deg, rgba(128, 0, 128, 0.4), rgba(0, 128, 0, 0.4)); /* Purple/Green gradient */
            border: 1px solid var(--mg-gold);
            color: white;
            padding: 0.8rem; 
            font-size: 1.1rem;
            font-family: 'Roboto', sans-serif; 
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            text-transform: none; 
            position: relative;
            overflow: hidden;
        }

        .answer-btn:hover {
            background: var(--mg-gold);
            color: black;
            transform: scale(1.02);
            box-shadow: 0 0 15px var(--mg-gold);
        }

        .answer-btn.correct { background: var(--mg-green); color: white; border-color: #fff; box-shadow: 0 0 30px var(--mg-green); }
        .answer-btn.incorrect { background: var(--cny-red); color: white; border-color: #fff; box-shadow: 0 0 30px var(--cny-red); }
        .answer-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* Bottom Section: Player Info */
        .player-info-footer {
            border-top: 1px solid rgba(255,215,0,0.3);
            padding-top: 0.5rem;
            margin-top: auto;
        }

        .player-details {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 5px;
        }

        .player-identity {
            text-align: left;
            flex: 1;
        }

        .player-score-area {
            text-align: right;
            min-width: 100px;
        }

        .player-name-display {
            font-size: 1.1rem;
            color: var(--mg-gold);
            font-weight: bold;
            margin-bottom: 0.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }
        
        .english-name-display {
            font-size: 0.8rem;
            color: #fff;
            opacity: 0.8;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 2px;
        }

        .player-stats {
            font-size: 0.8rem;
            color: #aaa;
        }

        .round-score {
            font-size: 2rem;
            color: var(--mg-green);
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0,255,0,0.3);
            line-height: 1;
        }

        /* Timer Bar within Player Card */
        .local-timer-container {
            width: 100%;
            height: 6px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
            border: 1px solid #444;
        }

        .local-timer-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--mg-green), var(--mg-gold), var(--cny-red));
            width: 100%;
            transform-origin: left;
            transition: width 0.1s linear;
        }

        /* --- MODES & SETUP --- */
        .centered-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
            z-index: 50;
        }

        .mode-btn {
            background: rgba(0,0,0,0.6);
            border: 2px solid var(--mg-gold);
            color: var(--mg-gold);
            padding: 1rem 3rem;
            font-size: 1.5rem;
            margin: 1rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            transition: 0.3s;
            text-shadow: 0 0 5px var(--mg-gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .mode-btn:hover {
            background: var(--mg-gold);
            color: #4a0000;
            box-shadow: 0 0 40px var(--mg-gold);
        }
        
        /* --- PLAYER SELECTION GRID --- */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            max-width: 800px;
            max-height: 60vh;
            overflow-y: auto;
            margin: 0 auto 2rem auto;
            padding: 10px;
        }
        
        .player-toggle-btn {
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--mg-gold);
            color: #fff;
            padding: 0.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            transition: 0.2s;
        }
        
        .player-toggle-btn.selected {
            background: var(--mg-green);
            border-color: #fff;
            box-shadow: 0 0 10px var(--mg-green);
        }
        
        .player-toggle-btn.deselected {
            background: rgba(255, 0, 0, 0.3);
            opacity: 0.6;
            color: #aaa;
        }

        /* --- CHAMPIONSHIP MODAL --- */
        .championship-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 0, 0, 0.95);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-y: auto; /* Allow scrolling for scorecard */
        }
        
        .trophy-icon { font-size: 5rem; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        /* Scoreboard Table */
        .scoreboard-table {
            width: 80%;
            max-width: 600px;
            border-collapse: collapse;
            margin-top: 20px;
            color: #fff;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
        }
        .scoreboard-table th, .scoreboard-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255,215,0,0.3);
        }
        .scoreboard-table th {
            background: rgba(255,215,0,0.2);
            color: var(--mg-gold);
        }

    </style>
</head>
<body>

    <div id="confetti-field"></div>

    <div class="game-container">
        
        <!-- MAIN MENU -->
        <div id="mainMenu" class="centered-menu">
            <h1 style="font-size: 4rem; margin-bottom: 1rem; color: var(--mg-gold); text-shadow: 0 0 20px var(--cny-red);">FESTIVAL FUSION</h1>
            <p style="color: #fff; font-size: 1.2rem; margin-bottom: 2rem; text-shadow: 0 0 10px #000;">Mardi Gras & Chinese New Year Celebration</p>
            <button class="mode-btn" onclick="initPlayerSelection(10)">Grade 10</button>
            <button class="mode-btn" onclick="initPlayerSelection(11)">Grade 11</button>
            <button class="mode-btn" onclick="initPlayerSelection(12)">Grade 12</button>
        </div>

        <!-- PLAYER SELECTION MENU -->
        <div id="playerSelection" class="centered-menu" style="display:none;">
            <h2 style="font-size: 2.5rem; margin-bottom: 1rem; color: #fff;">SELECT PLAYERS</h2>
            <p style="color: #ccc; margin-bottom: 1.5rem;">Click to remove absent students</p>
            <div id="playerSelectionGrid" class="selection-grid"></div>
            <button class="mode-btn" onclick="confirmPlayers()">GENERATE TEAMS</button>
            <button class="mode-btn" style="border-color: #666; font-size: 1rem;" onclick="location.reload()">BACK</button>
        </div>

        <!-- TEAM SETUP (Hidden) -->
        <div id="teamSetup" class="centered-menu" style="display:none;">
            <h2 style="font-size: 2.5rem; margin-bottom: 2rem; color: #fff;">GATHERING TEAMS...</h2>
            <div style="display: flex; gap: 2rem; justify-content: center;">
                <div style="background: rgba(74, 0, 0, 0.8); padding: 2rem; border: 2px solid var(--mg-gold); border-radius: 10px;">
                    <h3 id="setupTeam1Name" style="color: var(--team-one-color);">Team 1</h3>
                    <div id="setupTeam1List" style="margin-top: 1rem; font-size: 0.9rem; color: #fff;"></div>
                </div>
                <div style="background: rgba(46, 0, 62, 0.8); padding: 2rem; border: 2px solid var(--mg-green); border-radius: 10px;">
                    <h3 id="setupTeam2Name" style="color: var(--team-two-color);">Team 2</h3>
                    <div id="setupTeam2List" style="margin-top: 1rem; font-size: 0.9rem; color: #fff;"></div>
                </div>
            </div>
        </div>

        <!-- NEXT MATCHUP / SELECTION SCREEN -->
        <div id="matchupScreen" class="centered-menu" style="display:none;">
            <h2 style="font-size: 2rem; margin-bottom: 2rem; color: var(--mg-gold);">NEXT CELEBRATION BATTLE</h2>
            <div style="display: flex; gap: 4rem; align-items: center; justify-content: center; margin-bottom: 2rem;">
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; color: var(--team-one-color);" id="matchupTeam1">Team 1</div>
                    <div style="font-size: 2rem; font-weight: bold; color: #fff;" id="matchupPlayer1">Selecting...</div>
                </div>
                <div style="font-size: 3rem; color: var(--mg-gold); font-family: 'Cinzel';">VS</div>
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; color: var(--team-two-color);" id="matchupTeam2">Team 2</div>
                    <div style="font-size: 2rem; font-weight: bold; color: #fff;" id="matchupPlayer2">Selecting...</div>
                </div>
            </div>
            <div id="countdown" style="font-size: 4rem; color: var(--mg-green); font-weight: bold;">6</div>
        </div>

        <!-- GAMEPLAY ARENA -->
        <div id="gamePlay" class="game-play">
            
            <!-- NEW SHARED HEADER FOR QUESTION -->
            <div id="questionBanner" class="question-banner">
                <div id="bannerMainText" class="banner-main-text">WORD</div>
                <div id="bannerSubText" class="banner-sub-text">Sentence goes here</div>
            </div>

            <div class="battle-arena">
                <!-- Player 1 Card -->
                <div class="player-card" id="cardP1">
                    <div class="question-section">
                        <!-- REVEAL -->
                        <div class="correct-reveal-text" id="reveal1">Answer</div>
                        <div class="answers-grid" id="answers1">
                            <!-- Buttons injected here -->
                        </div>
                    </div>
                    <div class="player-info-footer">
                        <div class="player-details">
                            <div class="player-identity">
                                <div class="player-name-display" id="nameP1">Player Name</div>
                                <div class="player-stats">Total Points: <span id="totalPointsP1">0</span></div>
                            </div>
                            <div class="player-score-area">
                                <div class="round-score" id="scoreP1">0</div>
                                <div class="english-name-display" id="engNameP1">Name</div>
                            </div>
                        </div>
                        <div class="local-timer-container">
                            <div class="local-timer-bar" id="timerBar1"></div>
                        </div>
                    </div>
                </div>

                <div class="versus-divider">VS</div>

                <!-- Player 2 Card -->
                <div class="player-card" id="cardP2">
                    <div class="question-section">
                        <!-- REVEAL -->
                        <div class="correct-reveal-text" id="reveal2">Answer</div>
                        <div class="answers-grid" id="answers2">
                            <!-- Buttons injected here -->
                        </div>
                    </div>
                    <div class="player-info-footer">
                        <div class="player-details">
                            <div class="player-identity">
                                <div class="player-name-display" id="nameP2">Player Name</div>
                                <div class="player-stats">Total Points: <span id="totalPointsP2">0</span></div>
                            </div>
                            <div class="player-score-area">
                                <div class="round-score" id="scoreP2">0</div>
                                <div class="english-name-display" id="engNameP2">Name</div>
                            </div>
                        </div>
                        <div class="local-timer-container">
                            <div class="local-timer-bar" id="timerBar2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HEADER (Moved to Bottom) -->
        <div class="game-progress" id="gameHeader" style="display:none;">
            <div class="header-team-score" style="border-color: var(--team-one-color);">
                <span id="headerTeam1Name" style="color: var(--team-one-color);">Team Alpha</span>
                <div id="headerTeam1Score" style="color: #fff;">0</div>
            </div>
            <div class="round-info">
                <div>ROUND <span id="currentRoundDisplay">1</span> / <span id="totalRoundsDisplay">5</span></div>
                <div style="font-size: 0.9rem; color: #ccc;">Word <span id="currentQuestionNum">1</span>/5</div>
            </div>
            <div class="header-team-score" style="border-color: var(--team-two-color);">
                <span id="headerTeam2Name" style="color: var(--team-two-color);">Team Beta</span>
                <div id="headerTeam2Score" style="color: #fff;">0</div>
            </div>
        </div>

    </div>

    <!-- CHAMPIONSHIP MODAL -->
    <div id="championshipModal" class="championship-modal">
        <!-- Content injected dynamically -->
    </div>

    <script>
        // --- DATA ---
        const grade10 = ["Dino", "Tracy", "Billie", "Jessie", "Von Tony", "Jim", "Andrew", "Mark", "Leo", "Apollo", "Jenny", "Tony", "Haowlin", "Lion", "Steven", "Mike"];
        const grade11 = ["Grace", "Iris", "Jackie", "Max", "Emily", "Rhea", "Vicky"];
        const grade12 = ["Anna", "Mia", "Kenn", "Max", "Sky", "Sheng", "Keying", "Zifan", "Sifei", "Jiaqi", "Zack", "Azure", "Joe"];
        
        const vocabulary = [
            { cn: "ÂΩ©Áè†", en: "beads", sentence: "She wore a necklace made of colorful ___." },
            { cn: "Â∫ÜÁ•ù", en: "celebration", sentence: "The birthday party was a big ___." },
            { cn: "ËäÇÂ∫ÜÂ≠£ËäÇ", en: "celebration season", sentence: "Winter is a busy ___ for many families." },
            { cn: "È¢úËâ≤", en: "colors", sentence: "Red and gold are lucky ___." },
            { cn: "Á§æÂå∫", en: "community", sentence: "We should help people in our ___." },
            { cn: "ÊúçË£Ö / ÊúçÈ•∞", en: "costumes", sentence: "The dancers wore beautiful ___." },
            { cn: "ÂàõÊÑè", en: "creativity", sentence: "Art class helps you show your ___." },
            { cn: "‰∫∫Áæ§", en: "crowds", sentence: "There were huge ___ watching the parade." },
            { cn: "ËàûËπà", en: "dancing", sentence: "We saw the lions ___ in the street." },
            { cn: "Ë£ÖÈ•∞", en: "decorations", sentence: "We put up red ___ for the new year." },
            { cn: "ËäÇÊó•", en: "festival", sentence: "The Spring ___ is the most important holiday." },
            { cn: "Ëä±ËΩ¶", en: "floats", sentence: "The parade had many large and colorful ___." },
            { cn: "ÂõΩÁéãËõãÁ≥ï", en: "king cake", sentence: "Whoever finds the baby in the ___ gets luck." },
            { cn: "Ê∏∏Ë°åÁªÑÁªá", en: "krewe", sentence: "The parade was organized by a local ___." }, 
            { cn: "Èù¢ÂÖ∑", en: "masks", sentence: "People wore mysterious ___ to hide their faces." },
            { cn: "Èü≥‰πê", en: "music", sentence: "The band played loud ___." },
            { cn: "Ê∏∏Ë°å", en: "parade", sentence: "We watched the ___ go down the street." },
            { cn: "Ë°®ÊºîËÄÖ", en: "performers", sentence: "The ___ entertained the crowd with tricks." },
            { cn: "Ë°óÂ§¥ËäÇÊó•", en: "street festival", sentence: "The market was part of a large ___." },
            { cn: "‰º†Áªü", en: "tradition", sentence: "It is a ___ to eat dumplings on New Year's Eve." },
            { cn: "Âõ¢ÂúÜ", en: "reunion", sentence: "Chinese New Year is a time for family ___." },
            { cn: "ÁÅØÁ¨º", en: "lanterns", sentence: "They lit red ___ to celebrate." },
            { cn: "ÁÉüËä±", en: "fireworks", sentence: "Loud ___ scared away the bad spirits." },
            { cn: "È•∫Â≠ê", en: "dumplings", sentence: "We ate ___ that looked like gold ingots." },
            { cn: "Á∫¢ÂåÖ", en: "red envelopes", sentence: "Children receive ___ with money inside." },
            { cn: "ÁîüËÇñ", en: "zodiac", sentence: "This year is the year of the Dragon in the ___." },
            { cn: "Â§ßÊâ´Èô§", en: "spring cleaning", sentence: "We did ___ to sweep away bad luck." },
            { cn: "ÂÆ∂Â∫≠ËÅöÈ§ê", en: "family dinner", sentence: "Everyone gathered for the big ___." },
            { cn: "Êò•ËÅî", en: "couplets", sentence: "We pasted red ___ on the door frames." },
            { cn: "ËàûÁãÆ", en: "lion dance", sentence: "Two performers moved together for the ___." },
            { cn: "ËàûÈæô", en: "dragon dance", sentence: "Many people held up poles for the long ___." },
            { cn: "ÁπÅËç£", en: "prosperity", sentence: "Fish represents ___ and wealth." },
            { cn: "Â•ΩËøê", en: "good fortune", sentence: "We wish you ___ in the coming year." },
            { cn: "Êñ∞ÁöÑÂºÄÂßã", en: "new beginnings", sentence: "Spring represents ___ and fresh starts." },
            { cn: "Êò•Ëøê", en: "travel rush", sentence: "The train station was crowded during the ___." },
            { cn: "Êò•Â≠£", en: "spring season", sentence: "Flowers bloom during the ___." }
        ];

        const praisePhrases = ["Excellent!", "Stellar!", "Amazing!", "Perfect!", "Genius!", "Superb!"];
        
        let state = {
            players: [],
            team1: { name: "", players: [], score: 0 },
            team2: { name: "", players: [], score: 0 },
            playerStats: {}, 
            rounds: [],
            currentRoundIdx: 0,
            currentQuestionIdx: 0,
            currentPlayer1: null,
            currentPlayer2: null,
            timer: null,
            isChampionship: false,
            roundResolved: false,
            inputLocked: false,
            showAnswersTimeout: null,
            selectedPool: [],
            vocabDeck: [] // Master deck to ensure no repeats
        };

        const synth = window.speechSynthesis;
        let voices = [];
        
        function initVoices() {
            voices = synth.getVoices();
        }
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }
        initVoices();

        function getEnglishName(fullString) {
            if (!fullString) return "";
            if (fullString.includes('/')) {
                return fullString.split('/')[1].trim();
            }
            return fullString;
        }

        function speak(text, isName = false, type = 'sentence') {
            if (synth.speaking) synth.cancel();
            
            let textToSpeak = isName ? getEnglishName(text) : text;
            
            if (!isName && textToSpeak.includes("___")) {
                textToSpeak = textToSpeak.replace("___", "...");
            }
            
            const utter = new SpeechSynthesisUtterance(textToSpeak);
            utter.rate = 0.85; 
            utter.lang = 'en-US';

            let chosenVoice = null;
            if (type === 'name') {
                const emmaMulti = voices.find(v => v.name.includes("Emma Multilingual") || v.name.includes("Emma"));
                const emmaNatural = voices.find(v => v.name.includes("Emma") && v.name.includes("Natural"));
                if (emmaMulti) chosenVoice = emmaMulti;
                else if (emmaNatural) chosenVoice = emmaNatural;
            } else {
                const andrew = voices.find(v => v.name.includes("Microsoft Andrew Online (Natural)"));
                const otherNatural = voices.find(v => v.name.includes("Natural") && v.lang.startsWith("en"));
                if (andrew) chosenVoice = andrew;
                else if (otherNatural) chosenVoice = otherNatural;
            }
            if (chosenVoice) utter.voice = chosenVoice;
            
            synth.speak(utter);
        }

        function playSound(type) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
                osc.start();
                osc.stop(ctx.currentTime + 0.8);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                osc.start();
                osc.stop(ctx.currentTime + 0.4);
            }
        }
        
        function getDistractors(correctEnglishWord) {
            const pool = vocabulary.filter(v => v.en !== correctEnglishWord).map(v => v.en);
            return pool.sort(() => 0.5 - Math.random()).slice(0, 3);
        }

        function getUniqueRoundVocab(count) {
            let selected = [];
            if (state.vocabDeck.length < count) {
                let freshDeck = [...vocabulary].sort(() => 0.5 - Math.random());
                state.vocabDeck = [...state.vocabDeck, ...freshDeck];
            }
            for (let i = 0; i < count; i++) {
                if (state.vocabDeck.length > 0) {
                    selected.push(state.vocabDeck.pop());
                } else {
                    selected.push(vocabulary[Math.floor(Math.random() * vocabulary.length)]);
                }
            }
            return selected;
        }

        let tempSelection = new Set();
        
        function initPlayerSelection(grade) {
            let pool = [];
            if (grade === 10) pool = [...grade10];
            else if (grade === 11) pool = [...grade11];
            else pool = [...grade12];
            
            tempSelection = new Set(pool); 
            
            const grid = document.getElementById('playerSelectionGrid');
            grid.innerHTML = '';
            
            pool.forEach(player => {
                const btn = document.createElement('div');
                btn.className = 'player-toggle-btn selected';
                btn.innerText = player.split('/')[0];
                btn.onclick = () => togglePlayer(player, btn);
                grid.appendChild(btn);
            });
            
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('playerSelection').style.display = 'block';
        }
        
        function togglePlayer(player, btn) {
            if (tempSelection.has(player)) {
                tempSelection.delete(player);
                btn.classList.remove('selected');
                btn.classList.add('deselected');
            } else {
                tempSelection.add(player);
                btn.classList.add('selected');
                btn.classList.remove('deselected');
            }
        }
        
        function confirmPlayers() {
            if (tempSelection.size < 2) {
                alert("Please select at least 2 players!");
                return;
            }
            generateTeams(Array.from(tempSelection));
        }

        function generateTeams(pool) {
            document.getElementById('playerSelection').style.display = 'none';
            
            state.vocabDeck = [...vocabulary].sort(() => 0.5 - Math.random());
            state.players = pool.sort(() => 0.5 - Math.random());
            state.playerStats = {};
            state.players.forEach(p => state.playerStats[p] = { score: 0, team: 0 });

            const mid = Math.ceil(pool.length / 2);
            state.team1.players = pool.slice(0, mid);
            state.team2.players = pool.slice(mid);
            state.team1.name = "The Jade Dragons";
            state.team2.name = "The Golden Lions";
            state.team1.players.forEach(p => state.playerStats[p].team = 1);
            state.team2.players.forEach(p => state.playerStats[p].team = 2);

            const totalRounds = Math.max(state.team1.players.length, state.team2.players.length);
            state.rounds = [];
            const WORDS_PER_ROUND = 5;

            for(let i=0; i<totalRounds; i++) {
                let roundQuestions = [];
                let roundVocab = getUniqueRoundVocab(WORDS_PER_ROUND);
                roundVocab.forEach(item => {
                    const distractors = getDistractors(item.en);
                    roundQuestions.push({ 
                        chinese: item.cn, 
                        answer: item.en, 
                        sentence: item.sentence,
                        distractors: distractors 
                    });
                });
                state.rounds.push(roundQuestions);
            }

            document.getElementById('gameHeader').style.display = 'flex';
            document.getElementById('headerTeam1Name').innerText = state.team1.name;
            document.getElementById('headerTeam2Name').innerText = state.team2.name;
            document.getElementById('totalRoundsDisplay').innerText = totalRounds;

            document.getElementById('teamSetup').style.display = 'block';
            document.getElementById('setupTeam1List').innerHTML = state.team1.players.map(p => `<div>${p}</div>`).join('');
            document.getElementById('setupTeam2List').innerHTML = state.team2.players.map(p => `<div>${p}</div>`).join('');
            
            setTimeout(() => {
                document.getElementById('teamSetup').style.display = 'none';
                startRoundSequence();
            }, 3000);
        }

        function startRoundSequence() {
            if (state.currentRoundIdx >= state.rounds.length) {
                checkChampionship();
                return;
            }

            state.currentPlayer1 = state.team1.players[state.currentRoundIdx % state.team1.players.length];
            state.currentPlayer2 = state.team2.players[state.currentRoundIdx % state.team2.players.length];

            document.getElementById('gamePlay').style.display = 'none';
            document.getElementById('matchupScreen').style.display = 'block';
            document.getElementById('matchupPlayer1').innerText = state.currentPlayer1.split('/')[0];
            document.getElementById('matchupPlayer2').innerText = state.currentPlayer2.split('/')[0];
            document.getElementById('matchupTeam1').innerText = state.team1.name;
            document.getElementById('matchupTeam2').innerText = state.team2.name;

            let count = 6;
            const cd = document.getElementById('countdown');
            cd.innerText = count;
            
            speak(state.currentPlayer1 + " versus " + state.currentPlayer2, true, 'name');

            const interval = setInterval(() => {
                count--;
                cd.innerText = count;
                if(count <= 0) {
                    clearInterval(interval);
                    document.getElementById('matchupScreen').style.display = 'none';
                    beginGameplay();
                }
            }, 1000);
        }

        function beginGameplay() {
            document.getElementById('gamePlay').style.display = 'flex';
            state.currentQuestionIdx = 0;
            document.getElementById('currentRoundDisplay').innerText = state.isChampionship ? "CHAMPIONSHIP" : state.currentRoundIdx + 1;
            
            document.getElementById('scoreP1').innerText = "0";
            document.getElementById('scoreP2').innerText = "0";
            document.getElementById('nameP1').innerText = state.currentPlayer1.split('/')[0];
            document.getElementById('engNameP1').innerText = getEnglishName(state.currentPlayer1);
            document.getElementById('nameP2').innerText = state.currentPlayer2.split('/')[0];
            document.getElementById('engNameP2').innerText = getEnglishName(state.currentPlayer2);

            document.getElementById('totalPointsP1').innerText = state.playerStats[state.currentPlayer1].score;
            document.getElementById('totalPointsP2').innerText = state.playerStats[state.currentPlayer2].score;

            loadQuestion();
        }

        function loadQuestion() {
            const maxQs = state.isChampionship ? 10 : 5;
            if (state.currentQuestionIdx >= maxQs) {
                handleRoundEnd();
                return;
            }

            state.roundResolved = false;
            state.inputLocked = false;

            let qData;
            if(state.isChampionship) {
                let roundVocab = getUniqueRoundVocab(1); 
                let item = roundVocab[0];
                let distractors = getDistractors(item.en);
                qData = { chinese: item.cn, answer: item.en, sentence: item.sentence, distractors: distractors };
            } else {
                qData = state.rounds[state.currentRoundIdx][state.currentQuestionIdx];
            }

            document.getElementById('currentQuestionNum').innerText = state.currentQuestionIdx + 1;

            const banner = document.getElementById('questionBanner');
            const bannerMain = document.getElementById('bannerMainText');
            const bannerSub = document.getElementById('bannerSubText');
            
            banner.classList.remove('visible');

            const isListeningRound = state.isChampionship || (!state.isChampionship && state.currentRoundIdx === state.rounds.length - 1);

            if (isListeningRound) {
                bannerMain.innerText = qData.sentence;
                bannerMain.style.fontSize = "clamp(1.5rem, 3vw, 2.5rem)"; 
                bannerSub.innerText = ""; 
            } else {
                bannerMain.innerText = qData.chinese;
                bannerMain.style.fontSize = ""; 
                bannerSub.innerText = qData.sentence; 
            }

            renderPlayerSide(1, qData);
            renderPlayerSide(2, qData);
            
            document.getElementById('answers1').classList.add('answers-hidden');
            document.getElementById('answers2').classList.add('answers-hidden');
            document.getElementById('reveal1').classList.remove('show');
            document.getElementById('reveal2').classList.remove('show');

            speak(qData.sentence, false, 'sentence');

            if (state.showAnswersTimeout) clearTimeout(state.showAnswersTimeout);
            state.showAnswersTimeout = setTimeout(() => {
                if(!state.roundResolved) {
                    banner.classList.add('visible');
                    document.getElementById('answers1').classList.remove('answers-hidden');
                    document.getElementById('answers2').classList.remove('answers-hidden');
                    startTimer();
                }
            }, 3000);
        }

        function handleRoundEnd() {
            const name1 = getEnglishName(state.currentPlayer1);
            const score1 = document.getElementById('scoreP1').innerText;
            const name2 = getEnglishName(state.currentPlayer2);
            const score2 = document.getElementById('scoreP2').innerText;
            
            let winnerText = "";
            let s1 = parseInt(score1);
            let s2 = parseInt(score2);
            
            if (s1 > s2) winnerText = `Congratulations ${name1}!`;
            else if (s2 > s1) winnerText = `Congratulations ${name2}!`;
            else winnerText = "It is a tie!";

            const announcement = `Round Over. ${name1} has ${score1} points. ${name2} has ${score2} points. ${winnerText}`;
            speak(announcement, false, 'name'); 

            setTimeout(() => {
                if(state.isChampionship) {
                    endGame();
                } else {
                    state.currentRoundIdx++;
                    startRoundSequence();
                }
            }, 9000);
        }

        function renderPlayerSide(pNum, qData) {
            document.getElementById(`reveal${pNum}`).innerText = `Answer: ${qData.answer}`;
            const btnContainer = document.getElementById(`answers${pNum}`);
            btnContainer.innerHTML = '';
            let choices = [qData.answer, ...qData.distractors].sort(() => 0.5 - Math.random());
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.innerText = choice.toLowerCase(); // Force lowercase
                btn.onclick = (e) => handleAnswer(pNum, choice, qData.answer, e.target);
                btnContainer.appendChild(btn);
            });
        }

        function startTimer() {
            let timeLeft = 100;
            const bar1 = document.getElementById('timerBar1');
            const bar2 = document.getElementById('timerBar2');
            
            if (state.timer) clearInterval(state.timer);
            
            state.timer = setInterval(() => {
                timeLeft -= 1; 
                bar1.style.width = timeLeft + "%";
                bar2.style.width = timeLeft + "%";
                
                if (timeLeft <= 0) {
                    clearInterval(state.timer);
                    resolveQuestion(false, 0); 
                }
            }, 100);
        }

        function handleAnswer(pNum, choice, correct, btn) {
            if (state.inputLocked) return;

            const isCorrect = choice === correct;
            
            if (isCorrect) {
                state.inputLocked = true;
                btn.classList.add('correct');
                playSound('correct');

                if (pNum === 1) {
                    state.team1.score += 10;
                    state.playerStats[state.currentPlayer1].score += 10;
                    document.getElementById('scoreP1').innerText = parseInt(document.getElementById('scoreP1').innerText) + 10;
                } else {
                    state.team2.score += 10;
                    state.playerStats[state.currentPlayer2].score += 10;
                    document.getElementById('scoreP2').innerText = parseInt(document.getElementById('scoreP2').innerText) + 10;
                }
                
                // Show Correct Answer Immediately (visual feedback)
                document.getElementById('reveal1').classList.add('show');
                document.getElementById('reveal2').classList.add('show');

                speak(praisePhrases[Math.floor(Math.random()*praisePhrases.length)], false, 'sentence');
                
                const otherPNum = pNum === 1 ? 2 : 1;
                disableButtons(otherPNum);
                disableButtons(pNum);

            } else {
                btn.classList.add('incorrect');
                playSound('incorrect');
                const btns = document.getElementById(`answers${pNum}`).children;
                for(let b of btns) b.disabled = true;
                
                const p1Disabled = Array.from(document.getElementById('answers1').children).every(b => b.disabled);
                const p2Disabled = Array.from(document.getElementById('answers2').children).every(b => b.disabled);
            }
        }

        function disableButtons(pNum) {
            const btns = document.getElementById(`answers${pNum}`).children;
            for(let b of btns) b.disabled = true;
        }

        function resolveQuestion(hasWinner, winnerNum) {
            document.getElementById('headerTeam1Score').innerText = state.team1.score;
            document.getElementById('headerTeam2Score').innerText = state.team2.score;
            
            document.getElementById('reveal1').classList.add('show');
            document.getElementById('reveal2').classList.add('show');

            setTimeout(() => {
                state.currentQuestionIdx++;
                loadQuestion();
            }, 2500);
        }

        function checkChampionship() {
            if(state.isChampionship) return;

            const t1Sorted = state.team1.players.sort((a,b) => state.playerStats[b].score - state.playerStats[a].score);
            const t2Sorted = state.team2.players.sort((a,b) => state.playerStats[b].score - state.playerStats[a].score);

            const champ1 = t1Sorted[0];
            const champ2 = t2Sorted[0];

            const modal = document.getElementById('championshipModal');
            modal.style.display = 'flex';
            
            modal.innerHTML = `
                <div class="trophy-icon">üèÜ</div>
                <h1 style="font-size: 4rem; color: var(--mg-gold); text-shadow: 0 0 20px var(--cny-red); margin: 1rem;">CHAMPIONSHIP</h1>
                <h2 style="font-size: 1.5rem; color: #fff; margin-bottom: 2rem;">The Grand Finale!</h2>
                <div style="display: flex; gap: 3rem; margin-bottom: 3rem;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; color: var(--team-one-color);">GREEN TEAM CHAMPION</div>
                        <div style="font-size: 2.5rem; font-weight: bold; color: #fff;">${champ1.split('/')[0]}</div>
                        <div style="color: var(--mg-gold);">${state.playerStats[champ1].score} pts</div>
                    </div>
                     <div style="text-align: center; font-size: 3rem; color: #fff; display: flex; align-items:center;">VS</div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; color: var(--team-two-color);">YELLOW TEAM CHAMPION</div>
                        <div style="font-size: 2.5rem; font-weight: bold; color: #fff;">${champ2.split('/')[0]}</div>
                         <div style="color: var(--mg-gold);">${state.playerStats[champ2].score} pts</div>
                    </div>
                </div>
                <div style="font-size: 1.5rem; color: #ccc; animation: pulse 1s infinite;">STARTING IN 5 SECONDS...</div>
            `;

            state.currentPlayer1 = champ1;
            state.currentPlayer2 = champ2;
            state.isChampionship = true;
            
            speak("Championship Round starting now.", false, 'name');

            setTimeout(() => {
                startChampionshipMatch();
            }, 5000);
        }

        function startChampionshipMatch() {
            document.getElementById('championshipModal').style.display = 'none';
            document.getElementById('gamePlay').style.display = 'flex';
            state.currentQuestionIdx = 0;
            beginGameplay();
        }

        function endGame() {
            const winner = state.team1.score > state.team2.score ? state.team1.name : state.team2.name;
            const allPlayers = [...state.players].sort((a, b) => state.playerStats[b].score - state.playerStats[a].score);
            let scoreRows = allPlayers.map(p => `
                <tr>
                    <td>${p.split('/')[0]}</td>
                    <td>${state.playerStats[p].score}</td>
                </tr>
            `).join('');

            const modal = document.getElementById('championshipModal');
            modal.innerHTML = `
                <h1 style="font-size: 4rem; color: var(--mg-gold);">GAME OVER</h1>
                <h2 style="font-size: 2rem; color: #fff; margin-bottom:1rem;">${winner} WINS!</h2>
                <h3 style="color:var(--mg-green); margin-top:10px;">FINAL SCOREBOARD</h3>
                <table class="scoreboard-table">
                    <thead>
                        <tr><th>Player</th><th>Score</th></tr>
                    </thead>
                    <tbody>
                        ${scoreRows}
                    </tbody>
                </table>
                <div style="margin-top: 20px;">
                    <button class="mode-btn" onclick="location.reload()">PLAY AGAIN</button>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function createConfetti() {
            const container = document.getElementById('confetti-field');
            const colors = ['#FFD700', '#D2042D', '#800080', '#008000']; 
            
            for (let i = 0; i < 150; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                const size = Math.random() * 8 + 5;
                conf.style.width = size + 'px';
                conf.style.height = size + 'px';
                conf.style.left = Math.random() * 100 + '%';
                
                conf.style.animationDuration = (Math.random() * 8 + 6) + 's';
                conf.style.animationDelay = (Math.random() * 5) + 's';
                
                container.appendChild(conf);
            }
        }
        createConfetti();

    </script>
</body>
</html>
