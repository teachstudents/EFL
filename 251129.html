<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Grade 7 IELTS Speaking Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            position: relative;
            background-color: #FDFBF7; /* Cream Background */
            color: #1a202c; /* Black/Dark Gray Text */
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        audio::-webkit-media-controls-panel {
            padding: 5px;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05); 
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.3); 
            border-radius: 4px;
        }
        
        /* Custom Classes for the Theme */
        .text-green-heading { color: #15803d; } /* Green 700 */
        .bg-cream-card { background-color: #ffffff; }
        
        /* Interactive Chips */
        .interactive-chip {
            cursor: pointer;
            transition: all 0.2s;
        }
        .interactive-chip:hover {
            transform: translateY(-1px);
            filter: brightness(0.95);
        }
        .interactive-chip:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="flex items-center justify-center p-2 sm:p-4">
    
    <div id="app-container" class="w-full max-w-xl mx-auto text-center h-full flex flex-col">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-cream-card shadow-lg p-6 sm:p-8 rounded-2xl h-full flex flex-col justify-center overflow-y-auto border border-gray-100 relative">
            <div id="name-entry-container">
                <h1 class="text-3xl font-bold text-green-heading mb-2">IELTS Prep: Grade 7</h1>
                <p class="text-sm text-gray-500 mb-6">Complete 10 Topics covering Part 1, 2 & 3</p>
                <input type="text" id="name-input" placeholder="Enter Your Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 text-center text-lg text-gray-900 bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                <button id="start-with-name-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md transition-colors">Start Practice</button>
            </div>
            <div id="topic-selection-container" class="hidden h-full flex flex-col">
                 <div class="flex justify-between items-end mb-2 flex-shrink-0">
                     <h1 class="text-2xl font-bold text-green-heading text-left">Hello, <span id="user-name-display"></span>!</h1>
                     <div class="text-xs font-bold text-blue-600" id="progress-text">0/10 Completed</div>
                 </div>
                 
                 <!-- Progress Bar -->
                 <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4 flex-shrink-0">
                    <div id="overall-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                 </div>
                 
                 <div id="instructions" class="text-xs text-gray-600 mb-4 text-left space-y-1 p-3 bg-blue-50 rounded-lg flex-shrink-0 border border-blue-100">
                      <p><strong>Goal:</strong> Complete all 10 Topics.</p>
                      <ul class="list-disc pl-4 text-blue-700">
                          <li><strong>Part 1:</strong> Warm-up (30s)</li>
                          <li><strong>Part 2:</strong> Long Turn (90s) - <em>Includes 1 min Prep!</em></li>
                          <li><strong>Part 3:</strong> Discussion (60s)</li>
                      </ul>
                 </div>
                 
                <div id="topic-selection" class="grid grid-cols-1 sm:grid-cols-2 gap-3 overflow-y-auto pb-4">
                    <!-- Topic buttons will be injected here -->
                </div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden bg-cream-card shadow-lg rounded-2xl app-shell border border-gray-100 relative">
            
            <!-- HEADER -->
            <header class="flex-shrink-0 bg-[#F9FAFB] p-3 border-b border-gray-200 rounded-t-2xl">
                <!-- Top Row: Navigation & Phase -->
                <div class="flex justify-between items-center mb-3">
                    <button id="back-to-topics-btn" class="text-xs bg-white hover:bg-gray-100 text-gray-700 font-bold py-1.5 px-3 rounded flex items-center border border-gray-200 shadow-sm transition-colors">
                        <i class="fas fa-home mr-1 text-green-heading"></i>Home
                    </button>
                    
                    <div id="phase-indicator" class="text-xs font-bold text-green-heading uppercase tracking-widest bg-green-50 px-2 py-1 rounded border border-green-100">
                        PART 1
                    </div>
                    
                    <button id="samples-btn" class="text-xs bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1.5 px-3 rounded shadow-sm flex items-center transition-colors">
                        <i class="fas fa-lightbulb mr-1"></i>Ideas
                    </button>
                </div>

                <!-- Middle Row: Controls -->
                <div class="flex items-center justify-between gap-2">
                    
                    <!-- Previous Button -->
                    <button id="prev-btn" class="w-10 h-10 flex-shrink-0 bg-white hover:bg-gray-50 text-gray-600 rounded-full flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed transition-all border border-gray-200 shadow-sm">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <!-- Center Group: Timer & Recorder -->
                    <div class="flex-grow flex items-center justify-center gap-4 bg-white rounded-xl p-2 shadow-sm border border-gray-100">
                        
                        <!-- Timer -->
                        <div class="flex flex-col items-center">
                            <div class="relative w-12 h-12 flex-shrink-0">
                                <svg class="w-full h-full" viewBox="0 0 100 100">
                                    <circle class="text-gray-200" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                                    <circle id="timer-progress" class="timer-circle text-blue-500" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                                </svg>
                                <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-700">0:00</div>
                            </div>
                            <!-- Prep Timer Button (Hidden by default) -->
                            <button id="prep-timer-btn" class="hidden mt-1 text-[9px] uppercase font-bold bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded hover:bg-yellow-200">
                                1m Prep
                            </button>
                            <!-- Normal Controls -->
                            <div id="normal-timer-controls" class="flex gap-1 mt-1">
                                <button id="pause-resume-btn" class="w-5 h-5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full flex items-center justify-center text-[10px]">
                                    <i class="fas fa-pause"></i>
                                </button>
                                <button id="reset-timer-btn" class="w-5 h-5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full flex items-center justify-center text-[10px]">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Divider -->
                        <div class="w-px h-10 bg-gray-200"></div>

                        <!-- Recorder Controls -->
                        <div class="flex items-center justify-center h-14 w-32 relative">
                             <!-- Record Button -->
                             <button id="record-btn" class="bg-red-500 hover:bg-red-600 text-white w-12 h-12 rounded-full text-lg shadow-md transition-transform transform hover:scale-105 flex items-center justify-center absolute z-10 border-2 border-white">
                                <i class="fas fa-microphone"></i>
                            </button>
                            
                            <!-- Stop Button -->
                            <button id="stop-record-btn" class="hidden bg-gray-800 hover:bg-gray-900 text-white w-12 h-12 rounded-full text-lg shadow-md flex items-center justify-center animate-pulse absolute z-10 border-2 border-white">
                                <i class="fas fa-stop"></i>
                            </button>

                             <!-- Post Recording (Player + Save) -->
                            <div id="post-recording-actions" class="hidden flex items-center gap-2 w-full animate-fadeIn">
                                <audio id="audio-player" controls class="h-8 w-20 flex-grow rounded-full"></audio>
                                <button id="download-btn" class="bg-blue-600 hover:bg-blue-700 text-white w-8 h-8 rounded-full text-xs shadow-md flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Next Button -->
                    <button id="next-btn" class="w-10 h-10 flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center shadow-md disabled:opacity-50 disabled:bg-gray-400 transition-all">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                 <div id="recording-status" class="hidden text-center text-red-500 font-bold text-[10px] mt-1 tracking-wider uppercase">
                      Recording...
                 </div>
            </header>
            
            <!-- MAIN CONTENT -->
            <main class="flex-grow overflow-y-auto p-3 sm:p-4 space-y-4">
                
                <!-- 1. Question Card -->
                <div id="question-container" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col items-center justify-center text-center">
                    <h2 id="question-text" class="text-lg sm:text-xl font-bold leading-relaxed text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" title="Click to hear question"></h2>
                </div>

                <!-- 2. Fillers & Fluency (Indigo Box) -->
                <div id="template-container" class="hidden w-full bg-indigo-50 border border-indigo-100 rounded-lg p-3 relative">
                    <span class="absolute -top-2 left-3 bg-indigo-100 text-indigo-700 px-2 py-0.5 text-[10px] font-bold rounded uppercase tracking-wider">Fluency Booster</span>
                    <!-- Fillers List -->
                    <div class="flex flex-wrap gap-2 justify-center mb-3 mt-1">
                        <span class="text-[10px] text-indigo-400 uppercase font-bold self-center mr-1">Start with:</span>
                        <div id="fillers-list" class="contents">
                            <!-- Fillers injected here -->
                        </div>
                    </div>
                    <!-- Template Structure -->
                    <div class="bg-white/60 p-2 rounded text-center border border-indigo-100">
                         <span id="template-text" class="text-sm text-gray-700 font-medium italic"></span>
                    </div>
                </div>

                <!-- 3. Sentence Starters (Blue Box) -->
                <div id="starters-container" class="hidden">
                    <div class="w-full bg-blue-50 border border-blue-100 rounded-lg p-3 relative">
                        <span class="absolute -top-2 left-3 bg-blue-100 text-blue-700 px-2 py-0.5 text-[10px] font-bold rounded uppercase tracking-wider">Sentence Starters</span>
                        <div id="starters-list" class="flex flex-wrap gap-2 justify-start mt-1">
                            <!-- Buttons injected here -->
                        </div>
                    </div>
                </div>

                <!-- 4. Vocabulary Power (Green Box) -->
                <div id="word-bank-container" class="hidden">
                    <div class="bg-green-50 p-3 rounded-lg border border-green-100 relative space-y-3 pt-4">
                        <span class="absolute -top-2 left-3 bg-green-100 text-green-700 px-2 py-0.5 text-[10px] font-bold rounded uppercase tracking-wider">Vocabulary Power</span>
                        
                        <!-- Word Bank -->
                        <div class="flex flex-wrap gap-2 justify-start items-center">
                            <span class="text-[10px] font-bold text-green-600 uppercase tracking-wide mr-2">Words:</span>
                            <div id="word-bank-list" class="contents"></div>
                        </div>

                        <!-- Collocations -->
                        <div class="flex flex-wrap gap-2 justify-start items-center border-t border-green-200/60 pt-2">
                            <span class="text-[10px] font-bold text-green-600 uppercase tracking-wide mr-2">Phrases:</span>
                            <div id="collocations-list" class="contents"></div>
                        </div>

                        <!-- Idiom -->
                        <div class="border-t border-green-200/60 pt-2 flex items-center">
                            <span class="text-[10px] font-bold text-green-600 uppercase tracking-wide mr-2">Idiom:</span>
                            <div id="idiom-text" class="text-sm font-semibold text-green-800 italic interactive-chip px-2 rounded hover:bg-green-100" onclick="speak(this.textContent)"></div>
                        </div>
                    </div>
                </div>

                <!-- 5. Sample Answers (Yellow Box) -->
                <div id="samples-container" class="hidden">
                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-left relative mt-2">
                        <span class="absolute -top-2 left-3 bg-yellow-100 text-yellow-700 px-2 py-0.5 text-[10px] font-bold rounded uppercase tracking-wider">Model Answer</span>
                        <ul id="samples-list" class="space-y-2 list-none mt-1">
                        </ul>
                    </div>
                </div>
                
                <!-- Spacer for scrolling -->
                <div class="h-4"></div>
            </main>
            
            <!-- Completion Celebration Overlay -->
            <div id="celebration-overlay" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center text-center p-4">
                <i class="fas fa-check-circle text-6xl text-green-500 mb-4 animate-bounce"></i>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Topic Completed!</h2>
                <p class="text-gray-600">Great job! Returning to menu...</p>
            </div>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center border border-gray-200">
            <div id="certificate-to-download" class="w-full bg-white p-8 rounded-lg border-8 border-double border-blue-400 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-4 bg-gradient-to-r from-blue-400 to-purple-500"></div>
                <div class="flex justify-center mb-4">
                    <i class="fas fa-medal text-7xl text-yellow-400 drop-shadow-md"></i>
                </div>
                <h1 class="text-3xl font-serif font-bold text-gray-800 mb-2">Certificate of Achievement</h1>
                <p class="text-md mt-2 text-gray-600 italic">This is to certify that</p>
                <p id="certificate-name" class="text-4xl font-bold my-6 text-blue-600 font-serif border-b-2 border-gray-300 inline-block px-8 pb-2"></p>
                <p class="text-md mt-2 text-gray-600">has successfully completed all 10 Topics of the<br><strong>Grade 7 IELTS Speaking Course</strong></p>
                <p class="text-sm mt-8 text-gray-500">Date: <span id="certificate-date"></span></p>
            </div>
            <button id="download-certificate-btn" class="mt-6 w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md transition-colors">
                <i class="fas fa-download mr-2"></i>Save Certificate
            </button>
             <button id="back-to-main-menu-btn" class="mt-3 text-sm text-blue-500 hover:underline">Back to Main Menu</button>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 text-center max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-bold mb-4 text-gray-800">Are you sure?</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Return to home? Current recording will be lost.</p>
            <div class="flex justify-center gap-4">
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow">Yes</button>
                <button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg shadow">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="error-message-box" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- DATA: 10 Topics (Updated with 3 Fillers per question) ---
        const practiceData = {
            "1. Hometown": [
                { 
                    type: "Part 1", 
                    question: "Let's talk about your hometown. Where are you from?", 
                    timer: 30,
                    fillers: ["To be honest...", "Well, let me see...", "Actually..."],
                    template: "<strong>Start Naturally:</strong> Well, I come from [Place], which is...",
                    starters: ["I come from...", "My hometown is...", "It is a city called...", "I live in the district of..."], 
                    wordBank: ["Beijing", "capital city", "province", "historical", "modern"], 
                    collocations: ["densely populated", "located in", "famous for"],
                    idiom: "Home is where the heart is",
                    samples: ["To be honest, I come from Beijing, which is the capital of China. It's a huge, modern city with a lot of history."]
                },
                { 
                    type: "Part 2", 
                    question: "Describe a place in your hometown that is interesting to tourists.", 
                    timer: 90,
                    fillers: ["Let me think...", "That's a good question...", "I'd like to describe..."],
                    template: "<strong>Give Examples:</strong> A good example would be [Place]. It is famous for...",
                    starters: ["I want to describe...", "It is located in...", "You can see...", "It is famous for..."], 
                    wordBank: ["The Great Wall", "Forbidden City", "Temple of Heaven", "historical site"], 
                    collocations: ["tourist attraction", "ancient architecture", "breathtaking view"],
                    idiom: "A stone's throw away (very close)",
                    samples: ["Let me think... A good example would be the Forbidden City. It used to be the palace for emperors, and it has amazing ancient architecture."]
                },
                { 
                    type: "Part 3", 
                    question: "How has your hometown changed in recent years? Is it better or worse?", 
                    timer: 60,
                    fillers: ["That’s a tricky one...", "It's hard to say, but...", "On the whole..."],
                    template: "<strong>Compare:</strong> Compared to the past, [Change]. In my opinion, it is [Better/Worse]...",
                    starters: ["It has changed a lot by...", "In the past, it was...", "Now, we have..."], 
                    wordBank: ["skyscrapers", "subway lines", "traffic", "pollution", "convenient"], 
                    collocations: ["urban development", "traffic congestion", "rapid change"],
                    idiom: "Concrete jungle",
                    samples: ["That's a tricky one. Compared to the past, we have more skyscrapers now. In my opinion, it is better because life is more convenient."]
                }
            ],
            "2. School Life": [
                { 
                    type: "Part 1", 
                    question: "Tell me about your school. What is your favorite subject?", 
                    timer: 30,
                    fillers: ["Well, actually...", "To tell you the truth...", "I suppose..."],
                    template: "<strong>Start with a Choice:</strong> If I had to choose my favorite, I’d say [Subject], because...",
                    starters: ["I study at...", "My favorite subject is...", "I find... very interesting."], 
                    wordBank: ["Maths", "English", "P.E.", "History", "Physics"], 
                    collocations: ["attend classes", "sit an exam", "favorite subject"],
                    idiom: "Hit the books (study hard)",
                    samples: ["Well, actually, if I had to choose my favorite, I’d say English, because I love learning about different cultures."]
                },
                { 
                    type: "Part 2", 
                    question: "Describe a school project or homework assignment you worked hard on.", 
                    timer: 90,
                    fillers: ["Let me reflect on that...", "One example comes to mind...", "I clearly remember..."],
                    template: "<strong>Add Information:</strong> What's more, [Detail about difficulty]. Basically, we had to...",
                    starters: ["I remember an assignment about...", "I had to...", "It was difficult because..."], 
                    wordBank: ["presentation", "research", "science fair", "teamwork", "deadline"], 
                    collocations: ["meet a deadline", "group project", "give a presentation"],
                    idiom: "Pass with flying colors (do very well)",
                    samples: ["Let me reflect on that... I remember a history project. Basically, we made a poster about the Tang Dynasty. What's more, it was challenging because we had a strict deadline."]
                },
                { 
                    type: "Part 3", 
                    question: "Do you think students in China have too much homework? Why?", 
                    timer: 60,
                    fillers: ["I suppose...", "Personally speaking...", "From my perspective..."],
                    template: "<strong>Express Opinion:</strong> I strongly believe that [Opinion]. To put it another way, [Explanation]...",
                    starters: ["Yes, I definitely think so...", "Compared to other countries...", "It creates a lot of..."], 
                    wordBank: ["pressure", "stress", "review", "knowledge", "free time"], 
                    collocations: ["academic pressure", "heavy workload", "stay up late"],
                    idiom: "Burn the midnight oil (work late)",
                    samples: ["I suppose I strongly believe that we have too much homework. To put it another way, many students burn the midnight oil to finish tasks, which creates pressure."]
                }
            ],
            "3. Food & Festivals": [
                { 
                    type: "Part 1", 
                    question: "What is your favorite Chinese dish?", 
                    timer: 30,
                    fillers: ["Oh, definitely...", "Without a doubt...", "Let me see..."],
                    template: "<strong>Start Thinking:</strong> I think my favorite is [Dish].",
                    starters: ["My favorite dish is...", "I really love eating...", "It tastes..."], 
                    wordBank: ["Peking Duck", "Dumplings", "Hot Pot", "spicy", "savory"], 
                    collocations: ["traditional dish", "mouth-watering", "rich flavor"],
                    idiom: "Make my mouth water",
                    samples: ["Oh, definitely... I think my favorite is Peking Duck. It really makes my mouth water just thinking about the crispy skin."]
                },
                { 
                    type: "Part 2", 
                    question: "Describe a traditional festival (like Spring Festival) and how your family celebrates it.", 
                    timer: 90,
                    fillers: ["Hmm, let me consider...", "Well, generally...", "I'd like to talk about..."],
                    template: "<strong>Add Info:</strong> Not only that, but we also [Activity].",
                    starters: ["I'd like to talk about...", "It happens in...", "My family usually..."], 
                    wordBank: ["Spring Festival", "Lunar New Year", "reunion dinner", "red envelopes"], 
                    collocations: ["family reunion", "festive atmosphere", "celebrate together"],
                    idiom: "Feast for the eyes (looks beautiful)",
                    samples: ["Hmm, let me consider... I'd like to talk about Spring Festival. My family has a big reunion dinner. Not only that, but we also light fireworks which are a feast for the eyes."]
                },
                { 
                    type: "Part 3", 
                    question: "Why is it important for young people to learn about traditional festivals?", 
                    timer: 60,
                    fillers: ["Generally speaking...", "I strongly feel...", "The way I see it..."],
                    template: "<strong>Express Opinion:</strong> From my point of view, it is important because [Reason].",
                    starters: ["It is important because...", "It helps us understand...", "If we don't celebrate them..."], 
                    wordBank: ["culture", "identity", "history", "preserve", "generations"], 
                    collocations: ["cultural heritage", "keep traditions alive", "sense of belonging"],
                    idiom: "Cup of tea (preference)",
                    samples: ["Generally speaking, from my point of view, it's important because it connects us to our history. We need to keep traditions alive."]
                }
            ],
            "4. Hobbies": [
                { 
                    type: "Part 1", 
                    question: "What do you do in your free time?", 
                    timer: 30,
                    fillers: ["As a matter of fact...", "Actually...", "To be honest..."],
                    template: "<strong>Give Examples:</strong> For instance, I often [Activity].",
                    starters: ["In my free time, I...", "I usually...", "I am a big fan of..."], 
                    wordBank: ["play basketball", "read books", "video games", "draw", "relax"], 
                    collocations: ["spare time", "leisure activity", "unwind and relax"],
                    idiom: "Let off steam (release energy/stress)",
                    samples: ["As a matter of fact, I love sports. For instance, I often play basketball to let off steam after school."]
                },
                { 
                    type: "Part 2", 
                    question: "Describe a hobby or sport you want to try in the future.", 
                    timer: 90,
                    fillers: ["That's an interesting choice...", "I've thought about this...", "I'd love to try..."],
                    template: "<strong>Clarify:</strong> What I mean is [Explanation].",
                    starters: ["I really want to try...", "It looks very...", "I need to learn..."], 
                    wordBank: ["skiing", "coding", "photography", "piano", "exciting"], 
                    collocations: ["take up a hobby", "develop new skills", "master the art"],
                    idiom: "Give it a shot (try it)",
                    samples: ["That's an interesting choice... I really want to try skiing. What I mean is, I want to give it a shot because sliding down snowy mountains looks exciting."]
                },
                { 
                    type: "Part 3", 
                    question: "Do you think hobbies are important for students? Why?", 
                    timer: 60,
                    fillers: ["I'm convinced that...", "There's no doubt...", "Absolutely..."],
                    template: "<strong>Conclude:</strong> Overall, I believe [Conclusion].",
                    starters: ["Absolutely, because...", "Hobbies provide...", "Without hobbies, life would be..."], 
                    wordBank: ["mental health", "stress relief", "creativity", "social skills"], 
                    collocations: ["well-rounded education", "relieve stress", "maintain a balance"],
                    idiom: "All work and no play (makes Jack a dull boy)",
                    samples: ["I'm convinced that hobbies are essential. Overall, I believe 'all work and no play' is bad for students, so hobbies provide necessary balance."]
                }
            ],
            "5. Family & Friends": [
                { 
                    type: "Part 1", 
                    question: "Who are you closest to in your family?", 
                    timer: 30,
                    fillers: ["I'd have to say...", "Well...", "Probably..."],
                    template: "<strong>Start with Choice:</strong> If I had to choose, I’d say [Person].",
                    starters: ["I am closest to my...", "We often...", "She/He helps me with..."], 
                    wordBank: ["mother", "father", "grandma", "supportive", "kind"], 
                    collocations: ["get along with", "close relationship", "family bond"],
                    idiom: "Flesh and blood (family)",
                    samples: ["I'd have to say, if I had to choose, I’d say I am closest to my mother. She is my flesh and blood and always supports me."]
                },
                { 
                    type: "Part 2", 
                    question: "Describe your best friend.", 
                    timer: 90,
                    fillers: ["Let me gather my thoughts...", "I've known them for ages...", "My best friend is..."],
                    template: "<strong>Add Info:</strong> Another point worth mentioning is [Detail].",
                    starters: ["My best friend is...", "We met when...", "He/She is very..."], 
                    wordBank: ["cheerful", "honest", "reliable", "funny", "tall"], 
                    collocations: ["childhood friend", "have a lot in common", "sense of humor"],
                    idiom: "Through thick and thin (in good and bad times)",
                    samples: ["Let me gather my thoughts... My best friend is Li Ming. We've been friends through thick and thin. Another point worth mentioning is his great sense of humor."]
                },
                { 
                    type: "Part 3", 
                    question: "What makes a 'good friend'? What qualities are most important?", 
                    timer: 60,
                    fillers: ["It depends on how you look at it...", "In my opinion...", "I believe that..."],
                    template: "<strong>Express Opinion:</strong> I tend to think that [Quality] is most important.",
                    starters: ["A good friend should be...", "The most important quality is...", "I value..."], 
                    wordBank: ["honesty", "loyalty", "trustworthy", "listener", "helpful"], 
                    collocations: ["trustworthy friend", "quality time", "keep a secret"],
                    idiom: "A shoulder to cry on",
                    samples: ["It depends on how you look at it, but I tend to think that honesty is key. You need a shoulder to cry on who will also tell you the truth."]
                }
            ],
            "6. Technology": [
                { 
                    type: "Part 1", 
                    question: "How often do you use a mobile phone?", 
                    timer: 30,
                    fillers: ["Well, mostly...", "To be honest...", "As a matter of fact..."],
                    template: "<strong>Rephrase:</strong> In other words, I use it [Frequency].",
                    starters: ["I use it...", "Every day for...", "I mainly use it to..."], 
                    wordBank: ["chatting", "WeChat", "homework", "games", "daily"], 
                    collocations: ["browse the internet", "scroll through social media", "stay connected"],
                    idiom: "Glued to the screen",
                    samples: ["Well, mostly I use my phone every day. In other words, I'm often glued to the screen in the evenings checking homework."]
                },
                { 
                    type: "Part 2", 
                    question: "Describe a website or app that helps you with your studies.", 
                    timer: 90,
                    fillers: ["Let me reflect on that...", "One app I use is...", "I find this one useful..."],
                    template: "<strong>Give Example:</strong> A good example would be [App Name].",
                    starters: ["I often use...", "It helps me to...", "It has features like..."], 
                    wordBank: ["dictionary app", "translation", "online course", "efficient"], 
                    collocations: ["user-friendly interface", "educational tool", "search for information"],
                    idiom: "At your fingertips (easily available)",
                    samples: ["Let me reflect on that... A good example would be Pleco. It puts definitions at your fingertips, which helps me read difficult English books."]
                },
                { 
                    type: "Part 3", 
                    question: "Do you think children spend too much time on screens today?", 
                    timer: 60,
                    fillers: ["From my perspective...", "It's a serious issue...", "Undoubtedly..."],
                    template: "<strong>Compare:</strong> While it’s true that [Benefit], I think [Drawback].",
                    starters: ["Yes, it is a big problem...", "Many children are...", "It can affect their..."], 
                    wordBank: ["addicted", "eyesight", "physical health", "social interaction"], 
                    collocations: ["screen time", "technological advancement", "sedentary lifestyle"],
                    idiom: "Double-edged sword (has pros and cons)",
                    samples: ["From my perspective, technology is a double-edged sword. While it’s true that screens help us learn, I think children spend too much time on them."]
                }
            ],
            "7. Travel": [
                { 
                    type: "Part 1", 
                    question: "Do you like traveling? Why?", 
                    timer: 30,
                    fillers: ["You know...", "Well, certainly...", "For sure..."],
                    template: "<strong>Start Interesting:</strong> That’s an interesting question. I’d probably say [Yes/No]...",
                    starters: ["Yes, I love traveling because...", "I enjoy...", "It gives me a chance to..."], 
                    wordBank: ["explore", "new cultures", "relax", "food", "scenery"], 
                    collocations: ["tourist destination", "local cuisine", "go sightseeing"],
                    idiom: "Travel light",
                    samples: ["You know... That’s an interesting question. I’d probably say yes, because I love exploring new cultures and local cuisines."]
                },
                { 
                    type: "Part 2", 
                    question: "Describe a city in China (other than your hometown) you have visited.", 
                    timer: 90,
                    fillers: ["I'll tell you about...", "One memorable trip was...", "I visited..."],
                    template: "<strong>Add Info:</strong> In addition, it is famous for [Feature].",
                    starters: ["I visited...", "It is in the... of China", "It is famous for..."], 
                    wordBank: ["Shanghai", "Xi'an", "Chengdu", "pandas", "spicy food"], 
                    collocations: ["scenic spot", "memorable experience", "ancient history"],
                    idiom: "Off the beaten track (unusual place)",
                    samples: ["I'll tell you about Chengdu. It is famous for Giant Pandas. In addition, the spicy hotpot there is an unforgettable experience."]
                },
                { 
                    type: "Part 3", 
                    question: "Is it better to travel by car or by high-speed train in China?", 
                    timer: 60,
                    fillers: ["There's no doubt that...", "It's clear that...", "I prefer..."],
                    template: "<strong>Compare:</strong> On the one hand [Cars]..., but on the other hand [Trains]...",
                    starters: ["I prefer...", "High-speed trains are...", "Cars are better for..."], 
                    wordBank: ["fast", "convenient", "traffic jams", "comfortable", "on time"], 
                    collocations: ["public transport", "high-speed network", "traffic jam"],
                    idiom: "Hustle and bustle (busy activity)",
                    samples: ["There's no doubt that trains are better. On the one hand, cars are private, but on the other hand, high-speed trains avoid the hustle and bustle of traffic."]
                }
            ],
            "8. Animals & Pets": [
                { 
                    type: "Part 1", 
                    question: "Do you have a pet? Or what is your favorite animal?", 
                    timer: 30,
                    fillers: ["Actually...", "Well, sadly no...", "Yes, I do..."],
                    template: "<strong>Start Simple:</strong> Well, I don't have a pet, but...",
                    starters: ["I have a pet...", "My favorite animal is...", "I don't have a pet, but I like..."], 
                    wordBank: ["dog", "cat", "rabbit", "cute", "loyal"], 
                    collocations: ["keep a pet", "furry friend", "take care of"],
                    idiom: "Cat nap (short sleep)",
                    samples: ["Actually... Well, I don't have a pet, but I love cats. They are cute furry friends who love to take a cat nap in the sun."]
                },
                { 
                    type: "Part 2", 
                    question: "Describe an animal that you think is interesting.", 
                    timer: 90,
                    fillers: ["Let's see...", "I think...", "One fascinating animal is..."],
                    template: "<strong>Give Example:</strong> Such as [Animal Feature/Action].",
                    starters: ["I think the... is very interesting.", "It lives in...", "It looks like..."], 
                    wordBank: ["panda", "elephant", "dolphin", "wild", "bamboo"], 
                    collocations: ["endangered species", "natural habitat", "wild animal"],
                    idiom: "Gentle giant",
                    samples: ["Let's see... I think the Giant Panda is interesting. They are gentle giants that live in bamboo forests. They have unique habits, such as eating all day."]
                },
                { 
                    type: "Part 3", 
                    question: "Why do you think people keep pets?", 
                    timer: 60,
                    fillers: ["It's hard to say, but...", "I imagine...", "The main reason is..."],
                    template: "<strong>Handle Difficult Q:</strong> That’s a tough question, but I guess [Reason].",
                    starters: ["People keep pets because...", "Pets provide...", "For old people, pets are..."], 
                    wordBank: ["companionship", "friendship", "responsibility", "lonely", "stress"], 
                    collocations: ["loyal companion", "provide company", "part of the family"],
                    idiom: "Man's best friend",
                    samples: ["It's hard to say, but... That’s a tough question, but I guess people want companionship. A dog is known as man's best friend for a reason."]
                }
            ],
            "9. Environment": [
                { 
                    type: "Part 1", 
                    question: "Is there a park near your home?", 
                    timer: 30,
                    fillers: ["Well, I guess...", "Yes, there is...", "Not exactly, but..."],
                    template: "<strong>Start Thinking:</strong> Let me see... Yes, there is...",
                    starters: ["Yes, there is a...", "It is called...", "I go there to..."], 
                    wordBank: ["trees", "flowers", "lake", "exercise", "walk the dog"], 
                    collocations: ["fresh air", "green space", "morning exercise"],
                    idiom: "A breath of fresh air",
                    samples: ["Well, I guess... Let me see... Yes, there is a community park. It's a breath of fresh air in the busy city with lots of green space."]
                },
                { 
                    type: "Part 2", 
                    question: "Describe something you do to help the environment.", 
                    timer: 90,
                    fillers: ["Thinking about it...", "I try my best to...", "One thing I do is..."],
                    template: "<strong>Rephrase:</strong> To put it another way, we try to [Action].",
                    starters: ["I try to...", "My family always...", "At school, we..."], 
                    wordBank: ["recycle", "save water", "turn off lights", "plastic bags"], 
                    collocations: ["save energy", "environmentally friendly", "reduce waste"],
                    idiom: "Do my bit (do my share)",
                    samples: ["Thinking about it... I try to save electricity to do my bit. To put it another way, I always turn off lights when I leave a room."]
                },
                { 
                    type: "Part 3", 
                    question: "What are the biggest environmental problems in cities today?", 
                    timer: 60,
                    fillers: ["That's a serious issue...", "I'm concerned about...", "The biggest problem is..."],
                    template: "<strong>Conclude:</strong> So, to sum up, the main issue is [Problem].",
                    starters: ["The biggest problem is...", "Cities have too much...", "We also have issues with..."], 
                    wordBank: ["air pollution", "smog", "traffic noise", "waste", "rubbish"], 
                    collocations: ["global warming", "air quality", "noise pollution"],
                    idiom: "Tip of the iceberg",
                    samples: ["That's a serious issue... Air pollution is huge. But that's just the tip of the iceberg; we also have too much waste. So, to sum up, pollution is the main issue."]
                }
            ],
            "10. Sports": [
                { 
                    type: "Part 1", 
                    question: "Do you like playing sports?", 
                    timer: 30,
                    fillers: ["To be honest...", "Well, not really...", "Yes, absolutely..."],
                    template: "<strong>Start Naturally:</strong> Well, I am a big fan of [Sport], because...",
                    starters: ["Yes, I really like...", "I play...", "I'm not very sporty, but..."], 
                    wordBank: ["basketball", "football", "swimming", "badminton", "running"], 
                    collocations: ["keep fit", "team sport", "regular exercise"],
                    idiom: "Get the ball rolling (start something)",
                    samples: ["To be honest... Well, I am a big fan of basketball, because it's a great team sport and helps me keep fit."]
                },
                { 
                    type: "Part 2", 
                    question: "Describe a sport you would like to try in the future.", 
                    timer: 90,
                    fillers: ["I've always wanted to...", "That looks fun...", "I'm interested in..."],
                    template: "<strong>Give Details:</strong> It requires [Equipment/Skill]. Basically, you have to...",
                    starters: ["I want to try...", "It looks...", "I need to learn..."], 
                    wordBank: ["skiing", "surfing", "skateboarding", "tennis", "diving"], 
                    collocations: ["physical strength", "requires equipment", "challenging sport"],
                    idiom: "Give it my best shot (try hard)",
                    samples: ["I've always wanted to try surfing. It requires good balance. Basically, you have to stand on a board on the ocean waves. I'd love to give it my best shot."]
                },
                { 
                    type: "Part 3", 
                    question: "Why is it important for children to play sports?", 
                    timer: 60,
                    fillers: ["I strongly feel that...", "It's essential...", "The main benefit is..."],
                    template: "<strong>Express Opinion:</strong> From my perspective, it teaches them [Skill].",
                    starters: ["It helps them...", "Sports teach...", "They can learn to..."], 
                    wordBank: ["health", "teamwork", "confidence", "discipline", "fun"], 
                    collocations: ["build character", "team spirit", "healthy lifestyle"],
                    idiom: "Healthy body, healthy mind",
                    samples: ["I strongly feel that sports are vital. From my perspective, it teaches them teamwork and builds character. As they say, 'healthy body, healthy mind'."]
                }
            ]
        };

        // --- DOM Elements ---
        const ui = {
            welcomeScreen: document.getElementById('welcome-screen'),
            practiceScreen: document.getElementById('practice-screen'),
            nameEntryContainer: document.getElementById('name-entry-container'),
            nameInput: document.getElementById('name-input'),
            startWithNameBtn: document.getElementById('start-with-name-btn'),
            topicSelectionContainer: document.getElementById('topic-selection-container'),
            userNameDisplay: document.getElementById('user-name-display'),
            topicSelection: document.getElementById('topic-selection'),
            overallProgressBar: document.getElementById('overall-progress-bar'),
            progressText: document.getElementById('progress-text'),
            
            // Header Controls
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            backToTopicsBtn: document.getElementById('back-to-topics-btn'),
            samplesBtn: document.getElementById('samples-btn'),
            timerDisplay: document.getElementById('timer-display'),
            timerProgress: document.getElementById('timer-progress'),
            phaseIndicator: document.getElementById('phase-indicator'),
            recordBtn: document.getElementById('record-btn'),
            stopRecordBtn: document.getElementById('stop-record-btn'),
            pauseResumeBtn: document.getElementById('pause-resume-btn'),
            resetTimerBtn: document.getElementById('reset-timer-btn'),
            prepTimerBtn: document.getElementById('prep-timer-btn'),
            normalTimerControls: document.getElementById('normal-timer-controls'),
            postRecordingActions: document.getElementById('post-recording-actions'),
            audioPlayer: document.getElementById('audio-player'),
            downloadBtn: document.getElementById('download-btn'),
            recordingStatus: document.getElementById('recording-status'),

            // Main Content
            questionText: document.getElementById('question-text'),
            templateContainer: document.getElementById('template-container'),
            fillersList: document.getElementById('fillers-list'),
            templateText: document.getElementById('template-text'),
            samplesContainer: document.getElementById('samples-container'),
            samplesList: document.getElementById('samples-list'),
            startersContainer: document.getElementById('starters-container'),
            startersList: document.getElementById('starters-list'),
            wordBankContainer: document.getElementById('word-bank-container'),
            wordBankList: document.getElementById('word-bank-list'),
            collocationsList: document.getElementById('collocations-list'),
            idiomText: document.getElementById('idiom-text'),
            celebrationOverlay: document.getElementById('celebration-overlay'),
            
            // Overlays
            errorMessagebox: document.getElementById('error-message-box'),
            certificateScreen: document.getElementById('certificate-screen'),
            downloadCertificateBtn: document.getElementById('download-certificate-btn'),
            backToMainMenuBtn: document.getElementById('back-to-main-menu-btn'),
            modal: document.getElementById('confirmation-modal'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
        };

        // --- State Variables ---
        let userName = '';
        let currentTopicKey = '';
        let currentQuestionIndex = 0; 
        let currentQuestions = []; 
        let timerInterval;
        let isTimerPaused = false;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;
        let completedTopics = {};
        let currentTimerDuration = 0;
        let isPrepMode = false;

        const FULL_DASH_ARRAY = 283;
        
        // --- Text-to-Speech ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;
        let ttsInitialized = false;

        // Make speak function global for onclick handlers
        window.speak = function(text) {
            if (!ttsInitialized || !synth || !text) return;
            try {
                if (synth.speaking) synth.cancel();
                setTimeout(() => {
                    const utterThis = new SpeechSynthesisUtterance(text);
                    if (preferredVoice) utterThis.voice = preferredVoice;
                    utterThis.rate = 0.85; // Slow down
                    synth.speak(utterThis);
                }, 100);
            } catch (e) { console.error(e); }
        }

        function initializeTTS() {
            return new Promise((resolve) => {
                if (!synth) { ttsInitialized = true; return resolve(); }
                const setBestVoice = () => {
                    const voices = synth.getVoices();
                    if (voices.length === 0) return;
                    const scoreVoice = (voice) => {
                        let score = 0;
                        const name = voice.name.toLowerCase();
                        if (name.includes('natural')) score += 5;
                        if (name.includes('google')) score += 4;
                        if (name.includes('en-us') || name.includes('en-gb')) score += 2;
                        return score;
                    };
                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    if (englishVoices.length > 0) {
                        englishVoices.sort((a, b) => scoreVoice(b) - scoreVoice(a));
                        preferredVoice = englishVoices[0];
                    }
                    ttsInitialized = true;
                    resolve();
                };
                if (synth.getVoices().length > 0) setBestVoice();
                else synth.onvoiceschanged = setBestVoice;
            });
        }

        // --- Local Storage ---
        function loadProgress() {
            try {
                const saved = localStorage.getItem('ieltsG7v3Completed');
                if (saved) completedTopics = JSON.parse(saved);
                const name = localStorage.getItem('ieltsG7v3Name');
                if (name) { userName = name; ui.nameInput.value = name; }
                updateProgressUI();
            } catch (e) {}
        }

        function saveProgress() {
            localStorage.setItem('ieltsG7v3Completed', JSON.stringify(completedTopics));
            if(userName) localStorage.setItem('ieltsG7v3Name', userName);
            updateProgressUI();
        }
        
        function updateProgressUI() {
            const total = Object.keys(practiceData).length;
            const completed = Object.keys(completedTopics).length;
            const percent = (completed / total) * 100;
            ui.overallProgressBar.style.width = `${percent}%`;
            ui.progressText.textContent = `${completed}/${total} Completed`;
        }

        // --- Logic ---
        function initializeTopics() {
            ui.topicSelection.innerHTML = '';
            const topics = Object.keys(practiceData);
            
            topics.forEach(topic => {
                const btn = document.createElement('button');
                const isDone = completedTopics[topic];
                
                let classes = "w-full p-4 rounded-xl shadow-sm border text-left transition-all transform hover:scale-[1.01] flex items-center justify-between ";
                if (isDone) {
                    classes += "bg-green-50 border-green-200";
                } else {
                    classes += "bg-white border-gray-200 hover:bg-gray-50";
                }

                btn.className = classes;
                btn.innerHTML = `
                    <div>
                        <span class="block text-lg font-bold ${isDone ? 'text-green-700' : 'text-gray-800'}">${topic}</span>
                        <span class="text-xs text-gray-500">3 Questions (Part 1, 2, 3)</span>
                    </div>
                    ${isDone ? '<i class="fas fa-check-circle text-green-500 text-2xl"></i>' : '<i class="fas fa-chevron-right text-gray-400"></i>'}
                `;
                btn.onclick = () => startTopic(topic);
                ui.topicSelection.appendChild(btn);
            });
        }

        function startTopic(topicKey) {
            currentTopicKey = topicKey;
            currentQuestions = practiceData[topicKey];
            currentQuestionIndex = 0;
            
            ui.welcomeScreen.classList.add('hidden');
            ui.certificateScreen.classList.add('hidden');
            ui.practiceScreen.classList.remove('hidden');
            
            loadQuestion();
        }

        function loadQuestion() {
            // Check for completion of Topic (Part 3 done)
            if (currentQuestionIndex >= currentQuestions.length) {
                completeTopic();
                return;
            }

            const q = currentQuestions[currentQuestionIndex];
            
            // Reset UI States
            resetUIState();
            
            ui.phaseIndicator.textContent = q.type.toUpperCase();
            ui.questionText.textContent = q.question;
            ui.questionText.onclick = () => window.speak(q.question);
            window.speak(q.question);
            
            // --- Part 2 Special Logic (Prep Timer) ---
            if (q.type.includes("Part 2")) {
                ui.prepTimerBtn.classList.remove('hidden');
                ui.normalTimerControls.classList.add('hidden');
            } else {
                ui.prepTimerBtn.classList.add('hidden');
                ui.normalTimerControls.classList.remove('hidden');
                startTimer(q.timer);
            }
            currentTimerDuration = q.timer;
            
            // --- Step 2: Fluency Booster (Fillers + Template) ---
            ui.fillersList.innerHTML = '';
            if (q.fillers && q.fillers.length > 0) {
                q.fillers.forEach(filler => {
                    const span = document.createElement('span');
                    span.className = `bg-indigo-100 text-indigo-700 border border-indigo-200 px-3 py-1 rounded-full text-xs font-medium interactive-chip`;
                    span.textContent = filler;
                    span.onclick = () => window.speak(filler);
                    ui.fillersList.appendChild(span);
                });
            }
            ui.templateText.innerHTML = q.template || "";
            ui.templateContainer.classList.remove('hidden');
            
            // --- Step 1: Starters ---
            renderList(ui.startersList, q.starters, 'blue');
            ui.startersContainer.classList.remove('hidden');
            
            // --- Step 3: Vocabulary Power ---
            renderList(ui.wordBankList, q.wordBank, 'green');
            renderList(ui.collocationsList, q.collocations || [], 'green'); // Using same green style for ease
            ui.idiomText.textContent = q.idiom ? `"${q.idiom}"` : "";
            ui.wordBankContainer.classList.remove('hidden');
            
            // --- Samples ---
            ui.samplesList.innerHTML = '';
            q.samples.forEach(s => {
                const li = document.createElement('li');
                li.className = 'text-sm text-gray-800';
                li.innerHTML = `<i class="fas fa-quote-left text-yellow-500 mr-2"></i>${s}`;
                ui.samplesList.appendChild(li);
            });
            
            // Button States
            ui.prevBtn.disabled = currentQuestionIndex === 0;
        }
        
        function completeTopic() {
            if (!completedTopics[currentTopicKey]) {
                completedTopics[currentTopicKey] = true;
                saveProgress();
                
                // Show celebration
                ui.celebrationOverlay.classList.remove('hidden');
                setTimeout(() => {
                    ui.celebrationOverlay.classList.add('hidden');
                    returnToMenuOrCert();
                }, 2000);
            } else {
                returnToMenuOrCert();
            }
        }
        
        function returnToMenuOrCert() {
            if (Object.keys(completedTopics).length === Object.keys(practiceData).length) {
                showCertificate();
            } else {
                ui.practiceScreen.classList.add('hidden');
                ui.welcomeScreen.classList.remove('hidden');
                initializeTopics();
            }
        }
        
        function resetUIState() {
            ui.recordBtn.classList.remove('hidden');
            ui.stopRecordBtn.classList.add('hidden');
            ui.postRecordingActions.classList.add('hidden');
            ui.postRecordingActions.classList.remove('flex');
            ui.recordingStatus.classList.add('hidden');
            ui.samplesContainer.classList.add('hidden');
            ui.samplesBtn.classList.remove('hidden');
            clearInterval(timerInterval);
            isPrepMode = false;
            ui.timerDisplay.classList.remove("text-yellow-600");
            ui.timerDisplay.classList.add("text-gray-700");
            if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
        }

        function renderList(container, items, color) {
            container.innerHTML = '';
            let bgClass;
            
            if (color === 'blue') {
                bgClass = 'bg-blue-100 text-blue-800 border border-blue-200';
            } else if (color === 'green') {
                bgClass = 'bg-green-100 text-green-800 border border-green-200';
            } 
            
            items.forEach(text => {
                const span = document.createElement('span');
                span.className = `${bgClass} px-3 py-1 rounded-full text-xs sm:text-sm font-medium shadow-sm interactive-chip`;
                span.textContent = text;
                span.onclick = () => window.speak(text);
                container.appendChild(span);
            });
        }

        // --- Recording ---
        async function startRecording() {
            if (!navigator.mediaDevices) { alert("Microphone not supported"); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    ui.audioPlayer.src = URL.createObjectURL(recordedBlob);
                    
                    ui.stopRecordBtn.classList.add('hidden');
                    ui.recordingStatus.classList.add('hidden');
                    
                    ui.recordBtn.classList.add('hidden'); 
                    ui.postRecordingActions.classList.remove('hidden');
                    ui.postRecordingActions.classList.add('flex');
                };
                
                mediaRecorder.start();
                ui.recordBtn.classList.add('hidden');
                ui.stopRecordBtn.classList.remove('hidden');
                ui.recordingStatus.classList.remove('hidden');
                
            } catch (e) { console.error(e); alert("Microphone access denied"); }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
        }

        // --- Timer ---
        function startTimer(seconds, isPrep = false) {
            clearInterval(timerInterval);
            let timeLeft = seconds;
            updateTimerUI(timeLeft, seconds);
            
            isTimerPaused = false;
            if(!isPrep) ui.pauseResumeBtn.innerHTML = '<i class="fas fa-pause"></i>';
            
            // Visual cue for prep
            if(isPrep) {
                ui.timerDisplay.classList.remove("text-gray-700");
                ui.timerDisplay.classList.add("text-yellow-600");
            } else {
                ui.timerDisplay.classList.add("text-gray-700");
                ui.timerDisplay.classList.remove("text-yellow-600");
            }

            timerInterval = setInterval(() => {
                if(!isTimerPaused) {
                    timeLeft--;
                    updateTimerUI(timeLeft, seconds);
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        if (isPrep) {
                            // Prep finished, start main timer
                            ui.prepTimerBtn.classList.add('hidden');
                            ui.normalTimerControls.classList.remove('hidden');
                            startTimer(currentTimerDuration); // Start speaking timer
                        } else {
                            if (mediaRecorder && mediaRecorder.state === 'recording') stopRecording();
                        }
                    }
                }
            }, 1000);
        }

        function updateTimerUI(current, total) {
            const mins = Math.floor(current / 60);
            const secs = current % 60;
            ui.timerDisplay.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            const offset = (current / total) * FULL_DASH_ARRAY; 
            ui.timerProgress.style.strokeDashoffset = FULL_DASH_ARRAY - offset;
        }
        
        function resetTimer() {
            clearInterval(timerInterval);
            startTimer(currentTimerDuration);
        }

        function showCertificate() {
            ui.practiceScreen.classList.add('hidden');
            ui.welcomeScreen.classList.add('hidden');
            ui.certificateScreen.classList.remove('hidden');
            document.getElementById('certificate-name').textContent = userName;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
        }

        // --- Event Listeners ---
        ui.startWithNameBtn.onclick = () => {
            const val = ui.nameInput.value.trim();
            if(!val) return;
            userName = val;
            saveProgress();
            ui.nameEntryContainer.classList.add('hidden');
            ui.userNameDisplay.textContent = userName;
            ui.topicSelectionContainer.classList.remove('hidden');
            ui.topicSelectionContainer.classList.add('flex');
        };

        ui.recordBtn.onclick = startRecording;
        ui.stopRecordBtn.onclick = stopRecording;
        
        // Navigation Handlers
        ui.nextBtn.onclick = () => {
            currentQuestionIndex++;
            loadQuestion();
        };
        
        ui.prevBtn.onclick = () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        };
        
        ui.prepTimerBtn.onclick = () => {
            startTimer(60, true); // Start 60s prep
        };
        
        ui.downloadBtn.onclick = () => {
            if(!recordedBlob) return;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(recordedBlob);
            const cleanTopic = currentTopicKey.replace(/[^a-zA-Z0-9]/g, '');
            const part = `Part${currentQuestionIndex+1}`;
            a.download = `${userName}_${cleanTopic}_${part}.webm`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            const oldHtml = ui.downloadBtn.innerHTML;
            ui.downloadBtn.innerHTML = '<i class="fas fa-check"></i>';
            ui.downloadBtn.classList.remove('bg-blue-600');
            ui.downloadBtn.classList.add('bg-green-600');
            setTimeout(() => {
                 ui.downloadBtn.innerHTML = oldHtml;
                 ui.downloadBtn.classList.add('bg-blue-600');
                 ui.downloadBtn.classList.remove('bg-green-600');
            }, 1500);
        };
        
        ui.samplesBtn.onclick = () => {
            if(ui.samplesContainer.classList.contains('hidden')) {
                ui.samplesContainer.classList.remove('hidden');
            } else {
                ui.samplesContainer.classList.add('hidden');
            }
        };
        
        ui.backToTopicsBtn.onclick = () => {
            ui.modal.classList.remove('hidden');
        };

        ui.modalConfirmBtn.onclick = () => {
            ui.modal.classList.add('hidden');
            clearInterval(timerInterval);
            if(mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
            if(synth) synth.cancel();
            
            ui.practiceScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            updateProgressUI();
            initializeTopics();
        };
        
        ui.modalCancelBtn.onclick = () => ui.modal.classList.add('hidden');
        
        ui.pauseResumeBtn.onclick = () => {
            isTimerPaused = !isTimerPaused;
            ui.pauseResumeBtn.innerHTML = isTimerPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
        };
        
        ui.resetTimerBtn.onclick = resetTimer;
        
        ui.downloadCertificateBtn.onclick = () => {
            const node = document.getElementById('certificate-to-download');
            html2canvas(node, { scale: 2 }).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL("image/png");
                a.download = `Certificate_${userName}.png`;
                a.click();
            });
        };
        
        ui.backToMainMenuBtn.onclick = () => {
            ui.certificateScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            updateProgressUI();
            initializeTopics();
        }

        // --- Init ---
        initializeTTS();
        loadProgress();
        initializeTopics();
    });
    </script>
</body>
</html>
