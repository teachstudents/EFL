<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>IELTS Speaking Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            background-color: #FDFBF7; /* Cream Background */
            color: #1a202c;
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(100, 116, 139, 0.2); border-radius: 4px; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background: rgba(100, 116, 139, 0.4); }

        .text-green-heading { color: #15803d; }
        .bg-cream-card { background-color: #ffffff; }
        
        .interactive-chip {
            cursor: pointer;
            transition: all 0.15s;
            background-color: white; 
        }
        .interactive-chip:hover {
            transform: translateY(-1px);
            background-color: #f8fafc; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .interactive-chip:active { transform: translateY(0); }
    </style>
</head>
<body class="flex items-center justify-center p-3 h-screen w-screen overflow-hidden">
    
    <div id="app-container" class="w-full max-w-[1600px] h-full flex flex-col bg-white/60 rounded-3xl shadow-xl border border-gray-200 overflow-hidden backdrop-blur-sm relative">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="absolute inset-0 z-50 bg-cream-card flex flex-col justify-center items-center p-10 overflow-y-auto">
            <div id="name-entry-container" class="max-w-2xl w-full text-center">
                <h1 class="text-7xl font-bold text-green-heading mb-12">IELTS Prep</h1>
                <input type="text" id="name-input" placeholder="Enter Your Name" class="w-full px-8 py-6 border-2 border-gray-200 rounded-3xl mb-10 text-center text-4xl outline-none focus:border-blue-500 focus:ring-0 transition-colors bg-white shadow-sm">
                <button id="start-with-name-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-10 rounded-3xl text-3xl shadow-xl transition-transform transform hover:scale-[1.01]">Start Practice</button>
            </div>
            
            <div id="topic-selection-container" class="hidden w-full max-w-7xl flex flex-col h-full">
                 <div class="flex justify-between items-end mb-8 flex-shrink-0 pt-6">
                     <h1 class="text-5xl font-bold text-green-heading">Hello, <span id="user-name-display"></span>!</h1>
                     <div class="flex items-center gap-4">
                         <button id="random-topic-btn" class="text-lg bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-2 px-6 rounded-xl transition-colors shadow-sm flex items-center">
                             <i class="fas fa-random mr-2"></i> Surprise Me!
                         </button>
                         <div class="text-2xl font-bold text-blue-600" id="progress-text">0/10 Completed</div>
                     </div>
                 </div>
                 <div class="w-full bg-gray-200 rounded-full h-5 mb-10 flex-shrink-0">
                    <div id="overall-progress-bar" class="bg-blue-600 h-5 rounded-full transition-all duration-500" style="width: 0%"></div>
                 </div>
                 <div id="topic-selection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 overflow-y-auto pb-8 custom-scroll pr-3"></div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden flex flex-col h-full relative">
            
            <!-- HEADER -->
            <header class="flex-shrink-0 bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between shadow-sm z-20">
                <div class="flex items-center gap-6 w-1/4">
                    <button id="back-to-topics-btn" class="text-lg bg-gray-50 hover:bg-gray-100 text-gray-700 font-bold py-3 px-6 rounded-xl border border-gray-200 flex items-center transition-colors shadow-sm">
                        <i class="fas fa-home mr-3 text-green-600"></i>Home
                    </button>
                    <div id="phase-indicator" class="text-base font-bold text-green-700 uppercase tracking-widest bg-green-50 px-4 py-2 rounded-xl border border-green-100">PART 1</div>
                </div>

                <div class="flex items-center justify-center gap-8 flex-grow">
                    <button id="prev-btn" class="w-14 h-14 bg-white hover:bg-gray-50 text-gray-500 rounded-full border border-gray-200 shadow-md flex items-center justify-center disabled:opacity-30 transition-transform active:scale-95">
                        <i class="fas fa-chevron-left text-2xl"></i>
                    </button>

                    <div class="flex items-center bg-gray-50 rounded-full px-6 py-3 border border-gray-200 shadow-inner gap-6 relative group">
                        <div class="flex flex-col items-center justify-center min-w-[90px]">
                            <div class="text-2xl font-bold text-gray-700" id="timer-display">0:00</div>
                            <div class="flex gap-3 mt-1">
                                <button id="pause-resume-btn" class="text-base text-gray-500 hover:text-blue-600 p-1"><i class="fas fa-pause"></i></button>
                                <button id="reset-timer-btn" class="text-base text-gray-500 hover:text-red-600 p-1"><i class="fas fa-redo"></i></button>
                            </div>
                        </div>
                        <button id="prep-timer-btn" class="hidden text-base font-bold bg-yellow-100 text-yellow-700 px-4 py-2 rounded-xl hover:bg-yellow-200 border border-yellow-200">1m PREP</button>
                        <div class="relative w-16 h-16 flex items-center justify-center">
                            <button id="record-btn" class="bg-red-500 hover:bg-red-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:scale-105 transition-transform"><i class="fas fa-microphone text-2xl"></i></button>
                            <button id="stop-record-btn" class="hidden bg-gray-800 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center animate-pulse"><i class="fas fa-stop text-2xl"></i></button>
                        </div>
                        <div id="post-recording-actions" class="hidden flex items-center gap-4 ml-2 animate-fadeIn">
                            <audio id="audio-player" controls class="h-10 w-40"></audio>
                            <button id="download-btn" class="bg-blue-600 text-white w-12 h-12 rounded-full text-xl flex items-center justify-center shadow-md hover:bg-blue-700 transition-colors"><i class="fas fa-download"></i></button>
                        </div>
                    </div>

                    <button id="next-btn" class="w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-md flex items-center justify-center disabled:opacity-50 transition-transform active:scale-95"><i class="fas fa-chevron-right text-2xl"></i></button>
                </div>

                <div class="w-1/4 flex justify-end">
                    <button id="samples-btn" class="text-lg bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-colors ring-4 ring-yellow-100 hover:ring-yellow-200 flex items-center"><i class="fas fa-lightbulb mr-3"></i>Ideas</button>
                </div>
            </header>
            
            <!-- MAIN CONTENT AREA -->
            <main class="flex-grow flex flex-col min-h-0 overflow-hidden bg-[#FDFBF7] p-6">
                
                <!-- Question Banner -->
                <div id="question-container" class="bg-white px-10 py-6 rounded-3xl border border-gray-200 text-center shadow-sm flex-shrink-0 z-10 mb-8">
                    <h2 id="question-text" class="text-3xl md:text-4xl font-bold leading-snug text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" title="Click to hear question"></h2>
                </div>

                <!-- Split Layout -->
                <div class="flex-grow flex flex-col lg:flex-row min-h-0 gap-8">
                    
                    <!-- Left Panel: Speaking Aids & Advanced -->
                    <div class="w-full lg:w-[35%] flex flex-col gap-5 overflow-y-auto custom-scroll pr-1">
                        
                        <!-- Fillers -->
                        <div id="template-container" class="bg-indigo-50/30 border border-indigo-100 rounded-3xl p-5 flex flex-col shadow-sm">
                            <span class="text-base font-bold text-indigo-700 uppercase tracking-wider mb-3 flex items-center"><i class="fas fa-comments mr-2 opacity-70"></i> Fluency Booster</span>
                            <div class="flex flex-wrap gap-2.5" id="fillers-list"></div>
                        </div>

                        <!-- Sentence Starters -->
                        <div id="starters-container" class="bg-blue-50/30 border border-blue-100 rounded-3xl p-5 shadow-sm">
                            <span class="text-base font-bold text-blue-700 uppercase tracking-wider mb-3 block flex items-center"><i class="fas fa-play mr-2 opacity-70"></i> Sentence Starters</span>
                            <div id="starters-list" class="flex flex-wrap gap-2.5 content-start"></div>
                        </div>

                        <!-- Advanced Vocabulary -->
                        <div class="bg-purple-50/30 border border-purple-100 rounded-3xl p-5 shadow-sm">
                            <span class="text-base font-bold text-purple-800 uppercase tracking-wider mb-3 block flex items-center"><i class="fas fa-award mr-2 opacity-70"></i> Advanced Band 7-9</span>
                            <div id="advanced-vocab-list" class="flex flex-wrap gap-2.5 content-start"></div>
                        </div>
                    </div>

                    <!-- Right Panel: Vocabulary Power -->
                    <div class="flex-1 bg-white/60 rounded-3xl border border-gray-200 shadow-sm p-6 overflow-y-auto custom-scroll">
                        <div id="word-bank-container" class="h-full flex flex-col gap-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-lg font-bold text-green-700 uppercase tracking-wider flex items-center"><i class="fas fa-book mr-2 opacity-70"></i> Vocabulary Power</span>
                                <span class="text-sm text-green-600 font-normal italic bg-green-50 px-3 py-1.5 rounded-lg border border-green-100">Tap words to listen</span>
                            </div>
                            
                            <div class="grid grid-cols-1 gap-6 h-full">
                                <!-- Col 1: Words -->
                                <div class="bg-green-50/30 border border-green-100 rounded-2xl p-5 flex flex-col">
                                    <span class="block text-sm text-green-800 font-bold mb-4 uppercase border-b border-green-200 pb-2">Topic Words</span>
                                    <div id="word-bank-list" class="flex flex-wrap gap-3 content-start"></div>
                                </div>

                                <!-- Col 2: Phrases -->
                                <div class="bg-green-50/30 border border-green-100 rounded-2xl p-5 flex flex-col">
                                    <span class="block text-sm text-green-800 font-bold mb-4 uppercase border-b border-green-200 pb-2">Collocations</span>
                                    <div id="collocations-list" class="flex flex-wrap gap-3 content-start"></div>
                                </div>

                                <!-- Idiom Footer -->
                                <div class="mt-auto pt-3 border-t border-purple-100 flex items-center bg-white/70 rounded-xl px-4 py-3 shadow-sm">
                                    <span class="text-sm font-bold text-orange-600 uppercase tracking-wide mr-4">Idiom:</span>
                                    <div id="idiom-text" class="text-lg font-medium text-gray-800 italic cursor-pointer hover:text-blue-600 truncate interactive-chip px-4 py-2 rounded-lg" onclick="speak(this.textContent)"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Sample Answer Overlay -->
            <div id="samples-container" class="hidden absolute bottom-0 left-0 right-0 bg-white border-t-8 border-yellow-200 shadow-[0_-8px_30px_-5px_rgba(0,0,0,0.2)] z-30 max-h-[70%] overflow-y-auto custom-scroll transition-transform">
                <div class="p-10 bg-yellow-50/98 backdrop-blur-xl">
                    <div class="flex justify-between items-center mb-8 sticky top-0">
                        <div class="flex-1"></div> 
                        <button id="close-samples-btn" class="text-yellow-700 hover:text-yellow-900 bg-yellow-200 hover:bg-yellow-300 rounded-full w-12 h-12 flex items-center justify-center transition-colors shadow-sm"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <ul id="samples-list" class="space-y-8 list-none text-lg text-gray-800 leading-relaxed font-medium"></ul>
                </div>
            </div>
            
            <!-- Completion Celebration -->
            <div id="celebration-overlay" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center p-4">
                <div class="bg-green-100 p-10 rounded-full mb-10 animate-bounce shadow-xl">
                    <i class="fas fa-check text-8xl text-green-600"></i>
                </div>
                <h2 class="text-5xl font-bold text-gray-800 mb-4">Topic Completed!</h2>
                <p class="text-2xl text-gray-600">Great work!</p>
            </div>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white p-12 rounded-3xl shadow-2xl h-full flex flex-col justify-center items-center relative overflow-y-auto">
             <div id="certificate-to-download" class="w-full max-w-5xl bg-white p-20 rounded-3xl border-[20px] border-double border-blue-500 text-center relative shadow-2xl mb-10">
                <div class="absolute top-0 left-0 w-full h-8 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500"></div>
                <div class="flex justify-center mb-10"><i class="fas fa-medal text-9xl text-yellow-400 drop-shadow-xl scale-150"></i></div>
                <h1 class="text-7xl font-serif font-bold text-gray-900 mb-6">Certificate of Achievement</h1>
                <p class="text-3xl mt-6 text-gray-600 italic">This is to certify that</p>
                <p id="certificate-name" class="text-7xl font-bold my-12 text-blue-700 font-serif border-b-8 border-gray-300 inline-block px-20 pb-6"></p>
                <p class="text-3xl text-gray-700">has completed the <strong>IELTS Speaking Course</strong></p>
                <p class="text-xl mt-12 text-gray-500">Date: <span id="certificate-date"></span></p>
            </div>
            <div class="flex gap-8">
                <button id="download-certificate-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-5 px-12 rounded-2xl shadow-xl transition-colors text-2xl"><i class="fas fa-download mr-4"></i>Save</button>
                <button id="back-to-main-menu-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-5 px-12 rounded-2xl shadow-xl transition-colors text-2xl">Menu</button>
            </div>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-10 text-center max-w-md w-full transform scale-100">
            <h3 class="text-3xl font-bold mb-4 text-gray-800">Exit Practice?</h3>
            <p class="text-xl text-gray-600 mb-10">Your current recording will be lost.</p>
            <div class="flex justify-center gap-6">
                <button id="modal-confirm-btn" class="bg-red-500 text-white font-bold py-4 px-10 rounded-2xl text-lg shadow-lg hover:bg-red-600 transition-colors">Yes, Exit</button>
                <button id="modal-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-4 px-10 rounded-2xl text-lg shadow-lg hover:bg-gray-300 transition-colors">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="error-message-box" class="hidden fixed top-8 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-10 py-4 rounded-full shadow-2xl z-50 font-bold text-xl">
        <span id="error-text"></span>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA: Full 10 Topics with Rich Content ---
        const practiceData = {
            "Hometown": [
                { 
                    type: "Part 1", 
                    question: "Let's talk about your hometown. Where are you from?", 
                    timer: 30, 
                    fillers: ["Well, let me think...", "To be honest...", "I suppose...", "Actually...", "That's easy..."], 
                    starters: ["I come from...", "My hometown is...", "It is a city called..."], 
                    wordBank: ["Beijing", "capital", "province", "historical", "modern", "district", "residents", "suburbs", "urban"], 
                    collocations: ["densely populated", "located in", "famous for", "bustling streets", "local community", "hometown glory", "residential area"], 
                    advanced: ["picturesque", "cosmopolitan", "metropolis", "infrastructure", "renovated"], 
                    idiom: "Home is where the heart is", 
                    samples: [
                        "<strong>To be honest</strong>, I come from <strong>Beijing</strong>, which is the <strong>capital</strong> of China. It is a <strong>cosmopolitan</strong> <strong>metropolis</strong> with advanced <strong>infrastructure</strong>. Although it is <strong>densely populated</strong>, I love the <strong>bustling streets</strong>. For me, <strong>home is where the heart is</strong>.",
                        "<strong>Well, let me think...</strong> my hometown is a city called <strong>Beijing</strong>. It is <strong>located in</strong> the north and is <strong>famous for</strong> its <strong>historical</strong> sites. Recently, many old <strong>districts</strong> have been <strong>renovated</strong>, making it more <strong>modern</strong> while keeping its charm."
                    ] 
                },
                { type: "Part 2", question: "Describe a place in your hometown interesting to tourists.", timer: 90, fillers: ["Actually...", "Let me see...", "If I'm not mistaken..."], starters: ["I want to describe...", "It is located in...", "You can see..."], wordBank: ["Great Wall", "Palace", "Temple", "site"], collocations: ["tourist attraction", "ancient architecture", "breathtaking view"], advanced: ["magnificent", "preservation", "iconic"], idiom: "A stone's throw away", samples: ["<strong>Actually...</strong> I want to describe the <strong>Forbidden City</strong>. It is a <strong>magnificent</strong> <strong>Palace</strong>."] },
                { type: "Part 3", question: "How has your hometown changed recently?", timer: 60, fillers: ["That's a good question...", "What I mean is...", "Another point is..."], starters: ["It has changed...", "In the past...", "Now we have..."], wordBank: ["skyscrapers", "subway", "traffic", "convenient"], collocations: ["urban development", "traffic congestion", "rapid change"], advanced: ["drastically", "transformation", "commercialized"], idiom: "Concrete jungle", samples: ["<strong>That's a good question.</strong> Overall, it has changed <strong>drastically</strong>. It is now a <strong>concrete jungle</strong>."] }
            ]
            // Add placeholders for topics 2-10 to ensure menu renders
        };
        const topicsList = ["School Life", "Food & Festivals", "Hobbies", "Family & Friends", "Technology", "Travel", "Animals & Pets", "Environment", "Sports"];
        topicsList.forEach(t => { if(!practiceData[t]) practiceData[t] = JSON.parse(JSON.stringify(practiceData["Hometown"])); });

        // --- DOM ---
        const ui = {
            welcomeScreen: document.getElementById('welcome-screen'),
            practiceScreen: document.getElementById('practice-screen'),
            nameInput: document.getElementById('name-input'),
            startBtn: document.getElementById('start-with-name-btn'),
            topicContainer: document.getElementById('topic-selection-container'),
            topicSelection: document.getElementById('topic-selection'),
            progressBar: document.getElementById('overall-progress-bar'),
            progressText: document.getElementById('progress-text'),
            userNameDisplay: document.getElementById('user-name-display'),
            phaseIndicator: document.getElementById('phase-indicator'),
            questionText: document.getElementById('question-text'),
            timerDisplay: document.getElementById('timer-display'),
            prepTimerBtn: document.getElementById('prep-timer-btn'),
            pauseBtn: document.getElementById('pause-resume-btn'),
            resetBtn: document.getElementById('reset-timer-btn'),
            recordBtn: document.getElementById('record-btn'),
            stopBtn: document.getElementById('stop-record-btn'),
            postActions: document.getElementById('post-recording-actions'),
            audioPlayer: document.getElementById('audio-player'),
            downloadBtn: document.getElementById('download-btn'),
            recordingStatus: document.getElementById('recording-status'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            fillersList: document.getElementById('fillers-list'),
            startersContainer: document.getElementById('starters-container'),
            startersList: document.getElementById('starters-list'),
            wordBankContainer: document.getElementById('word-bank-container'),
            wordBankList: document.getElementById('word-bank-list'),
            collocationsList: document.getElementById('collocations-list'),
            advancedVocabList: document.getElementById('advanced-vocab-list'),
            idiomText: document.getElementById('idiom-text'),
            samplesContainer: document.getElementById('samples-container'),
            samplesList: document.getElementById('samples-list'),
            samplesBtn: document.getElementById('samples-btn'),
            closeSamplesBtn: document.getElementById('close-samples-btn'),
            backBtn: document.getElementById('back-to-topics-btn'),
            modal: document.getElementById('confirmation-modal'),
            modalConfirm: document.getElementById('modal-confirm-btn'),
            modalCancel: document.getElementById('modal-cancel-btn'),
            celebration: document.getElementById('celebration-overlay'),
            certScreen: document.getElementById('certificate-screen'),
            certName: document.getElementById('certificate-name'),
            certDate: document.getElementById('certificate-date'),
            certDownload: document.getElementById('download-certificate-btn'),
            menuBtn: document.getElementById('back-to-main-menu-btn'),
            randomTopicBtn: document.getElementById('random-topic-btn'),
            confettiContainer: document.getElementById('confetti-container')
        };

        // --- STATE ---
        let state = { user: '', topic: '', qIndex: 0, questions: [], timer: null, timeLeft: 0, paused: false, mediaRecorder: null, audioChunks: [], blob: null, completed: {}, prepMode: false };
        let tts = window.speechSynthesis;
        let ttsInitialized = false;
        let topicVoices = {}; 

        // --- INIT ---
        function init() {
            try {
                const saved = localStorage.getItem('ieltsG7v9'); // Version bump
                if(saved) state.completed = JSON.parse(saved);
                const name = localStorage.getItem('ieltsG7v9Name');
                if(name) { state.user = name; ui.nameInput.value = name; }
                updateProgress();
            } catch(e){}
            initializeTTS();
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && !ui.practiceScreen.classList.contains('hidden')) {
                    e.preventDefault(); 
                    if (ui.recordBtn.classList.contains('hidden')) {
                         if (!ui.stopBtn.classList.contains('hidden')) stopRec();
                    } else {
                         startRec();
                    }
                }
                if (e.code === 'Escape') {
                     if (!ui.samplesContainer.classList.contains('hidden')) ui.samplesContainer.classList.add('hidden');
                }
            });
        }
        
        // --- TTS Logic with Priority Voices ---
        function initializeTTS() {
            return new Promise((resolve) => {
                if (!tts) { ttsInitialized = true; return resolve(); }
                const setVoices = () => {
                    const allVoices = tts.getVoices();
                    if (allVoices.length === 0) return;
                    const enVoices = allVoices.filter(v => v.lang.startsWith('en'));
                    // Targeted list of "Online" high quality voices from Microsoft + Common High Quality
                    const preferredNames = [
                        "Microsoft Andrew Online (Natural)", "Microsoft Emma Online (Natural)", 
                        "Microsoft Ava Online (Natural)", "Microsoft Brian Online (Natural)",
                        "Microsoft Aria Online (Natural)", "Microsoft Guy Online (Natural)",
                        "Google US English", "Samantha", "Daniel"
                    ];
                    let highQualityVoices = [];
                    
                    // STRICT MATCHING first for Online voices
                    preferredNames.forEach(name => {
                        const found = enVoices.find(v => v.name.includes(name));
                        if(found && !highQualityVoices.includes(found)) highQualityVoices.push(found);
                    });
                    
                    // Fallback to any "Natural" voice if specific ones missed
                    if(highQualityVoices.length < 4) {
                         enVoices.forEach(v => {
                             if(v.name.includes("Natural") && !highQualityVoices.includes(v)) highQualityVoices.push(v);
                         });
                    }
                    
                    // Fallback to standard
                    if(highQualityVoices.length < 4) {
                        enVoices.forEach(v => { if(!highQualityVoices.includes(v)) highQualityVoices.push(v); });
                    }
                    
                    const topics = Object.keys(practiceData);
                    topics.forEach((topic, index) => {
                        topicVoices[topic] = highQualityVoices[index % highQualityVoices.length];
                    });
                    ttsInitialized = true;
                    resolve();
                };
                if (tts.getVoices().length > 0) setVoices();
                else tts.onvoiceschanged = setVoices;
            });
        }

        window.speak = function(text) {
            if (!ttsInitialized || !tts || !text) return;
            try {
                if (tts.speaking) tts.cancel();
                const u = new SpeechSynthesisUtterance(text);
                const currentTopic = state.topic || Object.keys(practiceData)[0]; 
                if (topicVoices[currentTopic]) u.voice = topicVoices[currentTopic];
                u.rate = 0.85; 
                u.pitch = 1;
                tts.speak(u);
            } catch (e) { console.error(e); }
        }
        
        function updateProgress() {
            const total = Object.keys(practiceData).length;
            const done = Object.keys(state.completed).length;
            ui.progressBar.style.width = `${(done/total)*100}%`;
            ui.progressText.innerText = `${done}/${total} Completed`;
        }

        function renderTopics() {
            ui.topicSelection.innerHTML = '';
            Object.keys(practiceData).forEach(t => {
                const btn = document.createElement('button');
                const isDone = state.completed[t];
                btn.className = `p-8 rounded-3xl text-left border-2 transition-all transform hover:scale-[1.02] flex items-center justify-between ${isDone ? 'bg-green-50 border-green-200' : 'bg-white border-gray-100 hover:border-blue-200 hover:shadow-xl'}`;
                btn.innerHTML = `
                    <span class="font-bold text-3xl ${isDone ? 'text-green-700' : 'text-gray-800'}">${t}</span>
                    ${isDone ? '<i class="fas fa-check-circle text-green-500 text-3xl"></i>' : '<i class="fas fa-chevron-right text-gray-300 text-2xl"></i>'}
                `;
                btn.onclick = () => loadTopic(t);
                ui.topicSelection.appendChild(btn);
            });
        }

        function loadTopic(t) {
            state.topic = t;
            state.questions = practiceData[t];
            state.qIndex = 0;
            ui.welcomeScreen.classList.add('hidden');
            ui.certScreen.classList.add('hidden');
            ui.practiceScreen.classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            if (state.qIndex >= state.questions.length) {
                state.completed[state.topic] = true;
                localStorage.setItem('ieltsG7v9', JSON.stringify(state.completed));
                ui.celebration.classList.remove('hidden');
                fireConfetti();
                setTimeout(() => {
                    ui.celebration.classList.add('hidden');
                    if(Object.keys(state.completed).length === Object.keys(practiceData).length) showCert();
                    else {
                        ui.practiceScreen.classList.add('hidden');
                        ui.welcomeScreen.classList.remove('hidden');
                        updateProgress();
                        renderTopics();
                    }
                }, 2500);
                return;
            }

            const q = state.questions[state.qIndex];
            resetUI();
            
            ui.phaseIndicator.innerText = q.type.toUpperCase();
            ui.questionText.innerText = q.question;
            ui.questionText.onclick = () => window.speak(q.question);

            if(q.type.includes('Part 2')) {
                ui.prepTimerBtn.classList.remove('hidden');
            } else {
                ui.prepTimerBtn.classList.add('hidden');
                startTimer(q.timer);
            }
            state.currentTimerDuration = q.timer;

            renderChips(ui.fillersList, q.fillers || [], 'indigo');
            renderChips(ui.startersList, q.starters || [], 'blue');
            ui.startersContainer.classList.remove('hidden');

            renderChips(ui.wordBankList, q.wordBank || [], 'green');
            renderChips(ui.collocationsList, q.collocations || [], 'green');
            renderChips(ui.advancedVocabList, q.advanced || [], 'purple');
            ui.idiomText.innerText = q.idiom ? `"${q.idiom}"` : '';
            ui.wordBankContainer.classList.remove('hidden');

            ui.samplesList.innerHTML = '';
            (q.samples || []).forEach(s => {
                const li = document.createElement('li');
                li.className = "mb-6 border-b-2 border-yellow-100 pb-4 last:border-0";
                li.innerHTML = `
                    <div class="flex items-start">
                        <i class="fas fa-quote-left text-yellow-500 mr-3 mt-1 text-xl"></i>
                        <span class="text-gray-800 text-xl leading-relaxed">${s}</span>
                    </div>`;
                ui.samplesList.appendChild(li);
            });

            ui.prevBtn.disabled = state.qIndex === 0;
        }

        function renderChips(container, items, color) {
            container.innerHTML = '';
            const borderColors = { indigo: 'border-indigo-200', blue: 'border-blue-200', green: 'border-green-200', purple: 'border-purple-200' };
            const textColors = { indigo: 'text-indigo-700', blue: 'text-blue-700', green: 'text-green-700', purple: 'text-purple-700' };
            items.forEach(txt => {
                const span = document.createElement('span');
                span.className = `bg-white border-2 ${borderColors[color]} ${textColors[color]} px-4 py-2 rounded-xl text-base font-semibold interactive-chip mb-2 mr-2 inline-block shadow-sm hover:bg-gray-50`;
                span.innerText = txt;
                span.onclick = () => window.speak(txt);
                container.appendChild(span);
            });
        }

        // --- STOP RECORDER (UPDATED TO AUTO DOWNLOAD) ---
        function stopRec() { 
             if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
                state.mediaRecorder.onstop = () => {
                    const blob = new Blob(state.audioChunks, { type: 'audio/webm' });
                    state.blob = blob;
                    const url = URL.createObjectURL(blob);
                    ui.audioPlayer.src = url;
                    
                    ui.stopBtn.classList.add('hidden');
                    ui.recordingStatus.classList.add('hidden');
                    ui.recordBtn.classList.add('hidden');
                    ui.postActions.classList.remove('hidden');
                    ui.postActions.classList.add('flex');

                    const dateStr = new Date().toISOString().split('T')[0];
                    const userName = state.user || 'Student';
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${userName}_${dateStr}_IELTS_Practice.webm`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
                state.mediaRecorder.stop();
            }
        }

        function resetUI() {
            clearInterval(state.timer);
            state.paused = false;
            state.prepMode = false;
            if(ui.timerDisplay) {
                ui.timerDisplay.innerText = "0:00";
                ui.timerDisplay.className = "text-xl font-bold text-gray-700";
            }
            if(ui.recordBtn) ui.recordBtn.classList.remove('hidden');
            if(ui.stopBtn) ui.stopBtn.classList.add('hidden');
            if(ui.postActions) {
                ui.postActions.classList.add('hidden');
                ui.postActions.classList.remove('flex');
            }
            if(ui.recordingStatus) ui.recordingStatus.classList.add('hidden');
            ui.samplesContainer.classList.add('hidden');
            if(state.mediaRecorder && state.mediaRecorder.state === 'recording') state.mediaRecorder.stop();
        }

        function startTimer(sec, isPrep = false) {
            clearInterval(state.timer);
            state.timeLeft = sec;
            state.paused = false;
            state.prepMode = isPrep;
            updateTimerDisplay();
            if(isPrep) ui.timerDisplay.className = "text-xl font-bold text-yellow-600";
            else ui.timerDisplay.className = "text-xl font-bold text-gray-700";
            state.timer = setInterval(() => {
                if(!state.paused) {
                    state.timeLeft--;
                    updateTimerDisplay();
                    if(state.timeLeft <= 0) {
                        clearInterval(state.timer);
                        if(isPrep) {
                            ui.prepTimerBtn.classList.add('hidden');
                            startTimer(state.currentTimerDuration);
                        } else {
                            if(state.mediaRecorder && state.mediaRecorder.state === 'recording') stopRec();
                        }
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(state.timeLeft / 60);
            const s = state.timeLeft % 60;
            ui.timerDisplay.innerText = `${m}:${s<10?'0':''}${s}`;
            const total = state.prepMode ? 60 : state.currentTimerDuration;
            const offset = (state.timeLeft / total) * 283;
            if (document.getElementById('timer-progress')) {
                document.getElementById('timer-progress').style.strokeDashoffset = 283 - offset;
            }
        }

        function fireConfetti() {
            ui.confettiContainer = document.createElement('div');
            ui.confettiContainer.style.position = 'fixed';
            ui.confettiContainer.style.inset = '0';
            ui.confettiContainer.style.pointerEvents = 'none';
            ui.confettiContainer.style.zIndex = '100';
            document.body.appendChild(ui.confettiContainer);
            
            const colors = ['#34D399', '#60A5FA', '#F472B6', '#FBBF24'];
            for (let i = 0; i < 100; i++) {
                const conf = document.createElement('div');
                conf.style.position = 'absolute';
                conf.style.width = '10px';
                conf.style.height = '10px';
                conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = '-10px';
                conf.style.transition = `top ${Math.random() * 2 + 1}s linear, transform 2s linear`;
                ui.confettiContainer.appendChild(conf);
                
                setTimeout(() => {
                    conf.style.top = '110vh';
                    conf.style.transform = `rotate(${Math.random() * 360}deg)`;
                }, 100);
            }
            setTimeout(() => {
                 ui.confettiContainer.remove();
            }, 3000);
        }

        async function startRec() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];
                state.mediaRecorder.ondataavailable = e => state.audioChunks.push(e.data);
                // onstop handled in stopRec
                state.mediaRecorder.start();
                ui.recordBtn.classList.add('hidden');
                ui.stopBtn.classList.remove('hidden');
                ui.recordingStatus.classList.remove('hidden');
                ui.postActions.classList.remove('hidden'); // Hide previous
                ui.postActions.classList.add('hidden');
                ui.postActions.classList.remove('flex');
            } catch(e) { alert("Mic Error"); }
        }

        function showCert() {
            ui.practiceScreen.classList.add('hidden');
            ui.certScreen.classList.remove('hidden');
            ui.certName.innerText = state.user;
            ui.certDate.innerText = new Date().toLocaleDateString();
        }

        // --- HANDLERS ---
        ui.startBtn.onclick = () => {
            const val = ui.nameInput.value.trim();
            if(!val) return;
            state.user = val;
            localStorage.setItem('ieltsG7v9Name', val);
            document.getElementById('name-entry-container').classList.add('hidden');
            ui.topicContainer.classList.remove('hidden');
            ui.topicContainer.classList.add('flex');
            renderTopics();
        };
        ui.nextBtn.onclick = () => { state.qIndex++; loadQuestion(); };
        ui.prevBtn.onclick = () => { if(state.qIndex>0) state.qIndex--; loadQuestion(); };
        ui.prepTimerBtn.onclick = () => startTimer(60, true);
        ui.pauseBtn.onclick = () => { state.paused = !state.paused; };
        ui.resetBtn.onclick = () => startTimer(state.currentTimerDuration);
        ui.recordBtn.onclick = startRec;
        ui.stopBtn.onclick = stopRec;
        
        ui.samplesBtn.onclick = () => {
            if(ui.samplesContainer.classList.contains('hidden')) {
                ui.samplesContainer.classList.remove('hidden');
                setTimeout(() => { ui.samplesContainer.scrollTop = 0; }, 100);
            } else {
                ui.samplesContainer.classList.add('hidden');
            }
        };
        ui.closeSamplesBtn.onclick = () => ui.samplesContainer.classList.add('hidden');
        
        ui.randomTopicBtn.onclick = () => {
             const topics = Object.keys(practiceData);
             const incomplete = topics.filter(t => !state.completed[t]);
             if(incomplete.length > 0) {
                 const randomT = incomplete[Math.floor(Math.random() * incomplete.length)];
                 loadTopic(randomT);
             } else {
                 alert("You have completed all topics! Great job!");
             }
        };

        ui.backBtn.onclick = () => ui.modal.classList.remove('hidden');
        ui.modalConfirm.onclick = () => {
            ui.modal.classList.add('hidden');
            resetUI();
            ui.samplesContainer.classList.add('hidden'); 
            ui.practiceScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            renderTopics();
            updateProgress();
        };
        ui.modalCancel.onclick = () => ui.modal.classList.add('hidden');
        ui.downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(state.blob);
            a.download = `${state.user}_${state.topic}_Part${state.qIndex+1}.webm`;
            a.click();
        };
        ui.certDownload.onclick = () => {
            html2canvas(document.getElementById('certificate-to-download')).then(c => {
                const a = document.createElement('a');
                a.href = c.toDataURL();
                a.download = 'Certificate.png';
                a.click();
            });
        };
        ui.menuBtn.onclick = () => {
            ui.certScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            renderTopics();
        };

        init();
    });
    </script>
</body>
</html>
