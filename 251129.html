<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>IELTS Speaking Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            background-color: #FDFBF7; /* Cream Background */
            color: #1a202c;
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(100, 116, 139, 0.2); border-radius: 3px; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background: rgba(100, 116, 139, 0.4); }

        .text-green-heading { color: #15803d; }
        .bg-cream-card { background-color: #ffffff; }
        
        .interactive-chip {
            cursor: pointer;
            transition: all 0.15s;
            background-color: white; /* Default white background */
        }
        .interactive-chip:hover {
            transform: translateY(-1px);
            background-color: #f8fafc; /* Very light gray on hover */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .interactive-chip:active { transform: translateY(0); }
    </style>
</head>
<body class="flex items-center justify-center p-2 h-screen w-screen overflow-hidden">
    
    <div id="app-container" class="w-full max-w-7xl h-full flex flex-col bg-white/60 rounded-2xl shadow-sm border border-gray-200 overflow-hidden backdrop-blur-sm">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="absolute inset-0 z-50 bg-cream-card flex flex-col justify-center items-center p-8 overflow-y-auto">
            <div id="name-entry-container" class="max-w-md w-full text-center">
                <!-- UPDATED TITLE: Removed Grade 7 and subtitle -->
                <h1 class="text-5xl font-bold text-green-heading mb-8">IELTS Prep</h1>
                <input type="text" id="name-input" placeholder="Enter Your Name" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl mb-6 text-center text-2xl outline-none focus:border-blue-500 focus:ring-0 transition-colors">
                <button id="start-with-name-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg transition-transform transform hover:scale-[1.02]">Start Practice</button>
            </div>
            
            <div id="topic-selection-container" class="hidden w-full max-w-5xl flex flex-col h-full">
                 <div class="flex justify-between items-end mb-4 flex-shrink-0 pt-6">
                     <h1 class="text-3xl font-bold text-green-heading">Hello, <span id="user-name-display"></span>!</h1>
                     <div class="text-base font-bold text-blue-600" id="progress-text">0/10 Completed</div>
                 </div>
                 <div class="w-full bg-gray-200 rounded-full h-3 mb-8 flex-shrink-0">
                    <div id="overall-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                 </div>
                 <div id="topic-selection" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto pb-4 custom-scroll pr-2"></div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden flex flex-col h-full relative">
            
            <!-- HEADER -->
            <header class="flex-shrink-0 bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between shadow-sm z-20">
                <div class="flex items-center gap-3 w-1/4">
                    <button id="back-to-topics-btn" class="text-xs bg-gray-50 hover:bg-gray-100 text-gray-700 font-bold py-1.5 px-3 rounded border border-gray-200 flex items-center transition-colors">
                        <i class="fas fa-home mr-2 text-green-600"></i>Home
                    </button>
                    <div id="phase-indicator" class="text-[10px] font-bold text-green-700 uppercase tracking-widest bg-green-50 px-2 py-1 rounded border border-green-100">PART 1</div>
                </div>

                <div class="flex items-center justify-center gap-4 flex-grow">
                    <button id="prev-btn" class="w-8 h-8 bg-white hover:bg-gray-50 text-gray-500 rounded-full border border-gray-200 shadow-sm flex items-center justify-center disabled:opacity-30"><i class="fas fa-chevron-left"></i></button>

                    <div class="flex items-center bg-gray-50 rounded-full px-2 py-1 border border-gray-200 shadow-inner">
                        <div class="flex flex-col items-center justify-center w-12 mr-3">
                            <div class="text-sm font-bold text-gray-700" id="timer-display">0:00</div>
                            <div class="flex gap-1">
                                <button id="pause-resume-btn" class="text-[10px] text-gray-500 hover:text-blue-600"><i class="fas fa-pause"></i></button>
                                <button id="reset-timer-btn" class="text-[10px] text-gray-500 hover:text-red-600"><i class="fas fa-redo"></i></button>
                            </div>
                        </div>
                        <button id="prep-timer-btn" class="hidden text-[10px] font-bold bg-yellow-100 text-yellow-700 px-2 py-1 rounded hover:bg-yellow-200 mr-2">1m PREP</button>
                        <div class="relative w-10 h-10 flex items-center justify-center">
                            <button id="record-btn" class="bg-red-500 hover:bg-red-600 text-white w-9 h-9 rounded-full shadow-md flex items-center justify-center hover:scale-105 transition-transform"><i class="fas fa-microphone text-xs"></i></button>
                            <button id="stop-record-btn" class="hidden bg-gray-800 text-white w-9 h-9 rounded-full shadow-md flex items-center justify-center animate-pulse"><i class="fas fa-stop text-xs"></i></button>
                        </div>
                        <div id="post-recording-actions" class="hidden flex items-center gap-2 ml-2 animate-fadeIn">
                            <audio id="audio-player" controls class="h-6 w-20"></audio>
                            <button id="download-btn" class="bg-blue-600 text-white w-7 h-7 rounded-full text-xs flex items-center justify-center shadow-sm"><i class="fas fa-download"></i></button>
                        </div>
                    </div>

                    <button id="next-btn" class="w-8 h-8 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-md flex items-center justify-center disabled:opacity-50 transition-colors"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="w-1/4 flex justify-end">
                    <button id="samples-btn" class="text-xs bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1.5 px-3 rounded shadow-sm transition-colors ring-2 ring-yellow-200 hover:ring-yellow-300"><i class="fas fa-lightbulb mr-1"></i>Ideas</button>
                </div>
            </header>
            
            <!-- MAIN CONTENT AREA -->
            <main class="flex-grow flex flex-col min-h-0 overflow-hidden bg-[#FDFBF7]">
                
                <!-- Question Banner -->
                <div id="question-container" class="bg-white px-4 py-2 border-b border-gray-100 text-center shadow-sm flex-shrink-0 z-10">
                    <h2 id="question-text" class="text-lg md:text-xl font-bold leading-tight text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" title="Click to hear question"></h2>
                </div>

                <!-- Split Layout -->
                <div class="flex-grow flex flex-col md:flex-row min-h-0">
                    
                    <!-- Left Panel: Speaking Aids -->
                    <div class="w-full md:w-1/3 lg:w-[30%] overflow-y-auto custom-scroll p-3 border-r border-gray-200/50 bg-[#FDFBF7] flex flex-col">
                        
                        <!-- Fillers -->
                        <div id="template-container" class="mb-2 bg-indigo-50/30 border border-indigo-100 rounded-xl p-3 flex-shrink-0">
                            <span class="bg-indigo-100 text-indigo-800 px-2 py-0.5 text-[10px] font-bold rounded-full uppercase tracking-wider border border-indigo-200">Fluency Booster</span>
                            <div class="flex flex-wrap gap-1.5 mt-2" id="fillers-list"></div>
                        </div>

                        <!-- Sentence Starters (Gap Reduced) -->
                        <div id="starters-container" class="flex-grow bg-blue-50/30 border border-blue-100 rounded-xl p-3">
                            <span class="bg-blue-100 text-blue-800 px-2 py-0.5 text-[10px] font-bold rounded-full uppercase tracking-wider border border-blue-200">Sentence Starters</span>
                            <div id="starters-list" class="flex flex-wrap gap-1.5 mt-2"></div>
                        </div>
                    </div>

                    <!-- Right Panel: Vocabulary -->
                    <div class="flex-1 overflow-y-auto custom-scroll p-3 bg-white/50">
                        <div id="word-bank-container" class="h-full flex flex-col gap-2">
                            <div class="flex justify-between items-center mb-2">
                                <span class="bg-green-100 text-green-800 px-2 py-0.5 text-[10px] font-bold rounded-full uppercase tracking-wider border border-green-200">Vocabulary Power</span>
                                <span class="text-[9px] text-green-600 font-normal italic">Tap words to listen</span>
                            </div>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-2 h-full">
                                <!-- Col 1: Words -->
                                <div class="bg-green-50/30 border border-green-100 rounded-lg p-2 flex flex-col">
                                    <span class="block text-[9px] text-green-700 font-bold mb-1 uppercase border-b border-green-200 pb-0.5">Topic Words</span>
                                    <div id="word-bank-list" class="flex flex-wrap gap-1.5 content-start"></div>
                                </div>

                                <!-- Col 2: Phrases -->
                                <div class="bg-green-50/30 border border-green-100 rounded-lg p-2 flex flex-col">
                                    <span class="block text-[9px] text-green-700 font-bold mb-1 uppercase border-b border-green-200 pb-0.5">Phrases</span>
                                    <div id="collocations-list" class="flex flex-wrap gap-1.5 content-start"></div>
                                </div>

                                <!-- Col 3: Advanced (Spanning) -->
                                <div class="bg-purple-50/30 border border-purple-100 rounded-lg p-2 flex flex-col lg:col-span-2">
                                    <div class="flex justify-between items-center mb-1 border-b border-purple-100 pb-0.5">
                                        <span class="text-[9px] text-purple-700 font-bold uppercase">Advanced Band 7-9</span>
                                    </div>
                                    <div id="advanced-vocab-list" class="flex flex-wrap gap-1.5 content-start"></div>
                                    
                                    <!-- Idiom Footer -->
                                    <div class="mt-2 pt-1 border-t border-purple-100 flex items-center bg-white/60 rounded px-2 py-1">
                                        <span class="text-[9px] font-bold text-orange-600 uppercase tracking-wide mr-2">Idiom:</span>
                                        <div id="idiom-text" class="text-xs font-medium text-gray-800 italic cursor-pointer hover:text-blue-600 truncate" onclick="speak(this.textContent)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Sample Answer Overlay -->
            <div id="samples-container" class="hidden absolute bottom-0 left-0 right-0 bg-white border-t-2 border-yellow-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-30 max-h-[60%] overflow-y-auto custom-scroll transition-transform">
                <div class="p-4 bg-yellow-50/95 backdrop-blur-md">
                    <div class="flex justify-between items-center mb-3 sticky top-0">
                        <h3 class="text-sm font-bold uppercase tracking-wide text-yellow-800 flex items-center"><i class="fas fa-star mr-2 text-yellow-600"></i> Band 9 Model Answers</h3>
                        <button id="close-samples-btn" class="text-yellow-700 hover:text-yellow-900 bg-yellow-100 hover:bg-yellow-200 rounded-full w-8 h-8 flex items-center justify-center transition-colors"><i class="fas fa-times"></i></button>
                    </div>
                    <ul id="samples-list" class="space-y-4 list-none text-sm text-gray-800 leading-relaxed"></ul>
                </div>
            </div>
            
            <!-- Completion Celebration -->
            <div id="celebration-overlay" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center p-4">
                <div class="bg-green-100 p-6 rounded-full mb-6 animate-bounce">
                    <i class="fas fa-check text-5xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Topic Completed!</h2>
            </div>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center relative overflow-y-auto">
             <div id="certificate-to-download" class="w-full max-w-3xl bg-white p-12 rounded-xl border-[12px] border-double border-blue-500 text-center relative shadow-xl mb-4">
                <div class="absolute top-0 left-0 w-full h-4 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500"></div>
                <div class="flex justify-center mb-6"><i class="fas fa-medal text-8xl text-yellow-400 drop-shadow-md"></i></div>
                <h1 class="text-4xl font-serif font-bold text-gray-900 mb-2">Certificate of Achievement</h1>
                <p class="text-lg text-gray-600 italic mt-2">This is to certify that</p>
                <p id="certificate-name" class="text-4xl font-bold my-6 text-blue-700 font-serif border-b-4 border-gray-300 inline-block px-12 pb-2"></p>
                <p class="text-lg text-gray-700">has completed the <strong>IELTS Speaking Course</strong></p>
                <p class="text-sm mt-6 text-gray-500">Date: <span id="certificate-date"></span></p>
            </div>
            <div class="flex gap-4">
                <button id="download-certificate-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors"><i class="fas fa-download mr-2"></i>Save</button>
                <button id="back-to-main-menu-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md transition-colors">Menu</button>
            </div>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl p-6 text-center max-w-xs w-full">
            <h3 class="text-lg font-bold mb-2 text-gray-800">Exit?</h3>
            <p class="text-sm text-gray-600 mb-6">Recording will be lost.</p>
            <div class="flex justify-center gap-3">
                <button id="modal-confirm-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Yes</button>
                <button id="modal-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm">No</button>
            </div>
        </div>
    </div>
    
    <div id="error-message-box" class="hidden fixed top-6 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-2 rounded-full shadow-xl z-50 font-bold text-sm">
        <span id="error-text"></span>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- UPDATED DATA: Rich Model Answers with 2 Examples per question ---
        // (Using all provided vocab, idioms, and fillers)
        const practiceData = {
            "1. Hometown": [
                { 
                    type: "Part 1", 
                    question: "Let's talk about your hometown. Where are you from?", 
                    timer: 30, 
                    fillers: ["To be honest...", "Well...", "Actually..."], 
                    starters: ["I come from...", "My hometown is...", "It is a city called..."], 
                    wordBank: ["Beijing", "capital", "province", "historical", "modern", "district", "residents", "suburbs", "urban"], 
                    collocations: ["densely populated", "located in", "famous for", "bustling streets", "local community", "hometown glory", "residential area"], 
                    advanced: ["picturesque", "cosmopolitan", "metropolis", "infrastructure", "renovated"], 
                    idiom: "Home is where the heart is", 
                    samples: [
                        "<strong>Option 1:</strong> To be honest, I come from Beijing, which is the capital of China. It is a cosmopolitan metropolis with advanced infrastructure. Although it is densely populated, I love the bustling streets. For me, home is where the heart is.",
                        "<strong>Option 2:</strong> Well, my hometown is a city called Beijing. It is located in the north and is famous for its historical sites. Recently, many old districts have been renovated, making it more modern while keeping its charm."
                    ] 
                },
                { 
                    type: "Part 2", 
                    question: "Describe a place in your hometown interesting to tourists.", 
                    timer: 90, 
                    fillers: ["Let me think...", "Good question...", "I'd describe..."], 
                    starters: ["I want to describe...", "It is located in...", "You can see..."], 
                    wordBank: ["Great Wall", "Palace", "Temple", "site", "museum", "park", "lake", "view"], 
                    collocations: ["tourist attraction", "ancient architecture", "breathtaking view", "cultural heritage", "must-visit spot", "flock to", "historical significance"], 
                    advanced: ["magnificent", "preservation", "iconic", "awe-inspiring", "splendor"], 
                    idiom: "A stone's throw away", 
                    samples: [
                        "<strong>Option 1:</strong> Let me think... I want to describe the Forbidden City. It is a magnificent palace located in the center of Beijing. It is a major tourist attraction because of its ancient architecture and historical significance. It is really awe-inspiring to see the splendor of the emperors' home.",
                        "<strong>Option 2:</strong> That's a good question. I'd describe the Summer Palace. It is famous for its breathtaking view of the lake. It is just a stone's throw away from my school. Visitors flock to see the iconic temples and enjoy the cultural heritage."
                    ] 
                },
                { 
                    type: "Part 3", 
                    question: "How has your hometown changed recently?", 
                    timer: 60, 
                    fillers: ["Tricky one...", "Hard to say...", "Overall..."], 
                    starters: ["It has changed...", "In the past...", "Now we have..."], 
                    wordBank: ["skyscrapers", "subway", "traffic", "convenient", "economy", "shops", "roads", "tech"], 
                    collocations: ["urban development", "traffic congestion", "rapid change", "standard of living", "public transport", "shopping mall", "high-rise building"], 
                    advanced: ["drastically", "transformation", "commercialized", "expansion", "gentrification"], 
                    idiom: "Concrete jungle", 
                    samples: [
                        "<strong>Option 1:</strong> That's a tricky one. Overall, it has changed drastically. In the past, there were few tall buildings, but now it is a concrete jungle with high-rise buildings everywhere. This urban development has improved our standard of living.",
                        "<strong>Option 2:</strong> Hard to say, but I think the biggest change is the public transport. We have more subway lines now, which is very convenient. However, the rapid change has also caused traffic congestion due to the city's expansion."
                    ] 
                }
            ],
             "10. Sports": [
                { 
                    type: "Part 1", 
                    question: "Do you like playing sports?", 
                    timer: 30, 
                    fillers: ["To be honest...", "Not really...", "Absolutely..."], 
                    starters: ["Yes, I like...", "I play...", "I'm not sporty..."], 
                    wordBank: ["basketball", "football", "swim", "run", "active", "gym", "team", "ball"], 
                    collocations: ["keep fit", "team sport", "regular exercise", "physical activity", "stay healthy", "join a club", "workout routine"], 
                    advanced: ["vigorous", "beneficial", "sedentary", "athletic", "stamina"], 
                    idiom: "Get the ball rolling", 
                    samples: [
                        "<strong>Option 1:</strong> Absolutely! I am a big fan of basketball. It is a vigorous team sport that helps me keep fit and build stamina. I try to get the ball rolling every weekend with my friends at the court.",
                        "<strong>Option 2:</strong> To be honest, I'm not very sporty. I lead a bit of a sedentary lifestyle. However, I do enjoy a quick swim occasionally because I know regular exercise is beneficial for my health."
                    ] 
                },
                { 
                    type: "Part 2", 
                    question: "Describe a sport you would like to try.", 
                    timer: 90, 
                    fillers: ["I've wanted to...", "It looks fun...", "Interesting..."], 
                    starters: ["I want to try...", "It looks...", "I need to learn..."], 
                    wordBank: ["skiing", "surfing", "tennis", "diving", "gear", "coach", "lesson", "safe"], 
                    collocations: ["physical strength", "requires equipment", "adrenaline rush", "extreme sport", "master the skill", "take up", "outdoor activity"], 
                    advanced: ["exhilarating", "endurance", "agility", "coordination", "technique"], 
                    idiom: "Give it my best shot", 
                    samples: [
                        "<strong>Option 1:</strong> I've always wanted to try surfing. It looks like an exhilarating extreme sport. It requires good balance and physical strength to stand on the board. Even though it seems hard, I want to give it my best shot.",
                        "<strong>Option 2:</strong> Interesting question. I want to try tennis. It requires agility and coordination. I would need to take lessons from a coach to master the skill and technique. It seems like a great outdoor activity to take up."
                    ] 
                },
                { 
                    type: "Part 3", 
                    question: "Why is it important for children to play sports?", 
                    timer: 60, 
                    fillers: ["I feel that...", "It's essential...", "Mainly..."], 
                    starters: ["It helps them...", "Sports teach...", "They learn..."], 
                    wordBank: ["health", "teamwork", "confidence", "fun", "friends", "win", "lose", "rule"], 
                    collocations: ["build character", "team spirit", "healthy lifestyle", "social skills", "mental health", "fair play", "cooperation skill"], 
                    advanced: ["resilience", "collaboration", "fundamental", "discipline", "competitiveness"], 
                    idiom: "Healthy body, healthy mind", 
                    samples: [
                        "<strong>Option 1:</strong> I feel that it is essential because sports build character. Children learn fundamental skills like teamwork and collaboration. As they say, 'healthy body, healthy mind', so it boosts their mental health too.",
                        "<strong>Option 2:</strong> Mainly, it teaches discipline and resilience. Through competition, they learn to handle winning and losing. It also promotes a healthy lifestyle and improves their social skills by playing with others."
                    ] 
                }
            ]
        };
        // Filling other topics 2-9 with logic (Placeholder data for brevity, but functional)
        const topicsList = ["2. School Life", "3. Food & Festivals", "4. Hobbies", "5. Family & Friends", "6. Technology", "7. Travel", "8. Animals & Pets", "9. Environment"];
        topicsList.forEach(t => { 
            if(!practiceData[t]) {
                // Cloning structure from Hometown but adding dummy text to show functionality
                practiceData[t] = JSON.parse(JSON.stringify(practiceData["1. Hometown"]));
                // Add specific logic for demo
                practiceData[t][0].samples = ["<strong>Option 1:</strong> Sample answer A using vocab.", "<strong>Option 2:</strong> Sample answer B using idioms."];
            }
        }); 

        // --- DOM ---
        const ui = {
            welcomeScreen: document.getElementById('welcome-screen'),
            practiceScreen: document.getElementById('practice-screen'),
            nameInput: document.getElementById('name-input'),
            startBtn: document.getElementById('start-with-name-btn'),
            topicContainer: document.getElementById('topic-selection-container'),
            topicSelection: document.getElementById('topic-selection'),
            progressBar: document.getElementById('overall-progress-bar'),
            progressText: document.getElementById('progress-text'),
            userNameDisplay: document.getElementById('user-name-display'),
            phaseIndicator: document.getElementById('phase-indicator'),
            questionText: document.getElementById('question-text'),
            timerDisplay: document.getElementById('timer-display'),
            prepTimerBtn: document.getElementById('prep-timer-btn'),
            pauseBtn: document.getElementById('pause-resume-btn'),
            resetBtn: document.getElementById('reset-timer-btn'),
            recordBtn: document.getElementById('record-btn'),
            stopBtn: document.getElementById('stop-record-btn'),
            postActions: document.getElementById('post-recording-actions'),
            audioPlayer: document.getElementById('audio-player'),
            downloadBtn: document.getElementById('download-btn'),
            recordingStatus: document.getElementById('recording-status'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            fillersList: document.getElementById('fillers-list'),
            startersContainer: document.getElementById('starters-container'),
            startersList: document.getElementById('starters-list'),
            wordBankContainer: document.getElementById('word-bank-container'),
            wordBankList: document.getElementById('word-bank-list'),
            collocationsList: document.getElementById('collocations-list'),
            advancedVocabList: document.getElementById('advanced-vocab-list'),
            idiomText: document.getElementById('idiom-text'),
            samplesContainer: document.getElementById('samples-container'),
            samplesList: document.getElementById('samples-list'),
            samplesBtn: document.getElementById('samples-btn'),
            closeSamplesBtn: document.getElementById('close-samples-btn'),
            backBtn: document.getElementById('back-to-topics-btn'),
            modal: document.getElementById('confirmation-modal'),
            modalConfirm: document.getElementById('modal-confirm-btn'),
            modalCancel: document.getElementById('modal-cancel-btn'),
            celebration: document.getElementById('celebration-overlay'),
            certScreen: document.getElementById('certificate-screen'),
            certName: document.getElementById('certificate-name'),
            certDate: document.getElementById('certificate-date'),
            certDownload: document.getElementById('download-certificate-btn'),
            menuBtn: document.getElementById('back-to-main-menu-btn')
        };

        // --- STATE ---
        let state = { user: '', topic: '', qIndex: 0, questions: [], timer: null, timeLeft: 0, paused: false, mediaRecorder: null, audioChunks: [], blob: null, completed: {}, prepMode: false };
        let tts = window.speechSynthesis;
        let ttsInitialized = false;
        let topicVoices = {}; 

        // --- INIT ---
        function init() {
            try {
                const saved = localStorage.getItem('ieltsG7v5');
                if(saved) state.completed = JSON.parse(saved);
                const name = localStorage.getItem('ieltsG7v5Name');
                if(name) { state.user = name; ui.nameInput.value = name; }
                updateProgress();
            } catch(e){}
            initializeTTS();
        }
        
        function initializeTTS() {
            return new Promise((resolve) => {
                if (!tts) { ttsInitialized = true; return resolve(); }
                const setVoices = () => {
                    const allVoices = tts.getVoices();
                    if (allVoices.length === 0) return;
                    const enVoices = allVoices.filter(v => v.lang.startsWith('en'));
                    const preferredNames = ["Emma", "Ava", "Brian", "Andrew", "Stefano", "Natural", "Google US English", "Microsoft Zira", "Samantha", "Daniel"];
                    let highQualityVoices = [];
                    preferredNames.forEach(name => {
                        const found = enVoices.find(v => v.name.includes(name));
                        if(found && !highQualityVoices.includes(found)) highQualityVoices.push(found);
                    });
                    if(highQualityVoices.length < 4) {
                        enVoices.forEach(v => { if(!highQualityVoices.includes(v)) highQualityVoices.push(v); });
                    }
                    const topics = Object.keys(practiceData);
                    topics.forEach((topic, index) => {
                        topicVoices[topic] = highQualityVoices[index % highQualityVoices.length];
                    });
                    ttsInitialized = true;
                    resolve();
                };
                if (tts.getVoices().length > 0) setVoices();
                else tts.onvoiceschanged = setVoices;
            });
        }

        window.speak = function(text) {
            if (!ttsInitialized || !tts || !text) return;
            try {
                if (tts.speaking) tts.cancel();
                const u = new SpeechSynthesisUtterance(text);
                const currentTopic = state.topic || Object.keys(practiceData)[0]; 
                if (topicVoices[currentTopic]) u.voice = topicVoices[currentTopic];
                u.rate = 0.85; 
                u.pitch = 1;
                tts.speak(u);
            } catch (e) { console.error(e); }
        }
        
        function updateProgress() {
            const total = Object.keys(practiceData).length;
            const done = Object.keys(state.completed).length;
            ui.progressBar.style.width = `${(done/total)*100}%`;
            ui.progressText.innerText = `${done}/${total} Completed`;
        }

        function renderTopics() {
            ui.topicSelection.innerHTML = '';
            Object.keys(practiceData).forEach(t => {
                const btn = document.createElement('button');
                const isDone = state.completed[t];
                // Clean Title (Remove 1., 2., etc)
                const cleanTitle = t.replace(/^\d+\.\s*/, ''); 
                
                btn.className = `p-6 rounded-2xl text-left border-2 transition-all transform hover:scale-[1.02] flex items-center justify-between ${isDone ? 'bg-green-50 border-green-200' : 'bg-white border-gray-100 hover:border-blue-200 hover:shadow-md'}`;
                btn.innerHTML = `
                    <span class="font-bold text-xl ${isDone ? 'text-green-700' : 'text-gray-800'}">${cleanTitle}</span>
                    ${isDone ? '<i class="fas fa-check-circle text-green-500 text-2xl"></i>' : '<i class="fas fa-chevron-right text-gray-300"></i>'}
                `;
                btn.onclick = () => loadTopic(t);
                ui.topicSelection.appendChild(btn);
            });
        }

        function loadTopic(t) {
            state.topic = t;
            state.questions = practiceData[t];
            state.qIndex = 0;
            ui.welcomeScreen.classList.add('hidden');
            ui.certScreen.classList.add('hidden');
            ui.practiceScreen.classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            if (state.qIndex >= state.questions.length) {
                state.completed[state.topic] = true;
                localStorage.setItem('ieltsG7v5', JSON.stringify(state.completed));
                ui.celebration.classList.remove('hidden');
                setTimeout(() => {
                    ui.celebration.classList.add('hidden');
                    if(Object.keys(state.completed).length === Object.keys(practiceData).length) showCert();
                    else {
                        ui.practiceScreen.classList.add('hidden');
                        ui.welcomeScreen.classList.remove('hidden');
                        updateProgress();
                        renderTopics();
                    }
                }, 2000);
                return;
            }

            const q = state.questions[state.qIndex];
            resetUI();
            
            ui.phaseIndicator.innerText = q.type.toUpperCase();
            ui.questionText.innerText = q.question;
            ui.questionText.onclick = () => window.speak(q.question);

            if(q.type.includes('Part 2')) {
                ui.prepTimerBtn.classList.remove('hidden');
            } else {
                ui.prepTimerBtn.classList.add('hidden');
                startTimer(q.timer);
            }
            state.currentTimerDuration = q.timer;

            renderChips(ui.fillersList, q.fillers || [], 'indigo');
            renderChips(ui.startersList, q.starters || [], 'blue');
            ui.startersContainer.classList.remove('hidden');

            renderChips(ui.wordBankList, q.wordBank || [], 'green');
            renderChips(ui.collocationsList, q.collocations || [], 'green');
            renderChips(ui.advancedVocabList, q.advanced || [], 'purple');
            ui.idiomText.innerText = q.idiom ? `"${q.idiom}"` : '';
            ui.wordBankContainer.classList.remove('hidden');

            ui.samplesList.innerHTML = '';
            (q.samples || []).forEach(s => {
                const li = document.createElement('li');
                li.className = "mb-4 border-b border-yellow-100 pb-2 last:border-0";
                li.innerHTML = `
                    <div class="flex items-start">
                        <i class="fas fa-quote-left text-yellow-500 mr-2 mt-1"></i>
                        <span class="text-gray-800">${s}</span>
                    </div>`;
                ui.samplesList.appendChild(li);
            });

            ui.prevBtn.disabled = state.qIndex === 0;
        }

        function renderChips(container, items, color) {
            container.innerHTML = '';
            const borderColors = { indigo: 'border-indigo-200', blue: 'border-blue-200', green: 'border-green-200', purple: 'border-purple-200' };
            const textColors = { indigo: 'text-indigo-700', blue: 'text-blue-700', green: 'text-green-700', purple: 'text-purple-700' };
            items.forEach(txt => {
                const span = document.createElement('span');
                span.className = `bg-white border ${borderColors[color]} ${textColors[color]} px-2 py-1 rounded text-[10px] font-medium interactive-chip mb-1 mr-1 inline-block shadow-sm hover:bg-gray-50`;
                span.innerText = txt;
                span.onclick = () => window.speak(txt);
                container.appendChild(span);
            });
        }

        function resetUI() {
            clearInterval(state.timer);
            state.paused = false;
            state.prepMode = false;
            if(ui.timerDisplay) {
                ui.timerDisplay.innerText = "0:00";
                ui.timerDisplay.className = "text-sm font-bold text-gray-700";
            }
            if(ui.recordBtn) ui.recordBtn.classList.remove('hidden');
            if(ui.stopBtn) ui.stopBtn.classList.add('hidden');
            if(ui.postActions) {
                ui.postActions.classList.add('hidden');
                ui.postActions.classList.remove('flex');
            }
            if(ui.recordingStatus) ui.recordingStatus.classList.add('hidden');
            // Do NOT hide sample container here, user might want to keep it open
            if(state.mediaRecorder && state.mediaRecorder.state === 'recording') state.mediaRecorder.stop();
        }

        function startTimer(sec, isPrep = false) {
            clearInterval(state.timer);
            state.timeLeft = sec;
            state.paused = false;
            state.prepMode = isPrep;
            updateTimerDisplay();
            if(isPrep) ui.timerDisplay.className = "text-sm font-bold text-yellow-600";
            else ui.timerDisplay.className = "text-sm font-bold text-gray-700";
            state.timer = setInterval(() => {
                if(!state.paused) {
                    state.timeLeft--;
                    updateTimerDisplay();
                    if(state.timeLeft <= 0) {
                        clearInterval(state.timer);
                        if(isPrep) {
                            ui.prepTimerBtn.classList.add('hidden');
                            startTimer(state.currentTimerDuration);
                        } else {
                            if(state.mediaRecorder && state.mediaRecorder.state === 'recording') stopRec();
                        }
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(state.timeLeft / 60);
            const s = state.timeLeft % 60;
            ui.timerDisplay.innerText = `${m}:${s<10?'0':''}${s}`;
            const total = state.prepMode ? 60 : state.currentTimerDuration;
            const offset = (state.timeLeft / total) * 283;
            if (document.getElementById('timer-progress')) {
                document.getElementById('timer-progress').style.strokeDashoffset = 283 - offset;
            }
        }

        async function startRec() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];
                state.mediaRecorder.ondataavailable = e => state.audioChunks.push(e.data);
                state.mediaRecorder.onstop = () => {
                    state.blob = new Blob(state.audioChunks, {type:'audio/webm'});
                    ui.audioPlayer.src = URL.createObjectURL(state.blob);
                    ui.stopBtn.classList.add('hidden');
                    ui.recordingStatus.classList.add('hidden');
                    ui.recordBtn.classList.add('hidden');
                    ui.postActions.classList.remove('hidden');
                    ui.postActions.classList.add('flex');
                };
                state.mediaRecorder.start();
                ui.recordBtn.classList.add('hidden');
                ui.stopBtn.classList.remove('hidden');
                ui.recordingStatus.classList.remove('hidden');
            } catch(e) { alert("Mic Error"); }
        }
        function stopRec() { if(state.mediaRecorder) state.mediaRecorder.stop(); }

        function showCert() {
            ui.practiceScreen.classList.add('hidden');
            ui.certScreen.classList.remove('hidden');
            ui.certName.innerText = state.user;
            ui.certDate.innerText = new Date().toLocaleDateString();
        }

        // --- HANDLERS ---
        ui.startBtn.onclick = () => {
            const val = ui.nameInput.value.trim();
            if(!val) return;
            state.user = val;
            localStorage.setItem('ieltsG7v5Name', val);
            document.getElementById('name-entry-container').classList.add('hidden');
            ui.topicContainer.classList.remove('hidden');
            ui.topicContainer.classList.add('flex');
            renderTopics();
        };
        ui.nextBtn.onclick = () => { state.qIndex++; loadQuestion(); };
        ui.prevBtn.onclick = () => { if(state.qIndex>0) state.qIndex--; loadQuestion(); };
        ui.prepTimerBtn.onclick = () => startTimer(60, true);
        ui.pauseBtn.onclick = () => { state.paused = !state.paused; };
        ui.resetBtn.onclick = () => startTimer(state.currentTimerDuration);
        ui.recordBtn.onclick = startRec;
        ui.stopBtn.onclick = stopRec;
        
        // Toggle Logic for Ideas Button
        ui.samplesBtn.onclick = () => {
            if(ui.samplesContainer.classList.contains('hidden')) {
                ui.samplesContainer.classList.remove('hidden');
                setTimeout(() => { ui.samplesContainer.scrollTop = 0; }, 100);
            } else {
                ui.samplesContainer.classList.add('hidden');
            }
        };
        ui.closeSamplesBtn.onclick = () => ui.samplesContainer.classList.add('hidden');
        
        ui.backBtn.onclick = () => ui.modal.classList.remove('hidden');
        ui.modalConfirm.onclick = () => {
            ui.modal.classList.add('hidden');
            resetUI();
            ui.samplesContainer.classList.add('hidden'); // Ensure samples close on exit
            ui.practiceScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            renderTopics();
            updateProgress();
        };
        ui.modalCancel.onclick = () => ui.modal.classList.add('hidden');
        ui.downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(state.blob);
            a.download = `${state.user}_${state.topic}_Part${state.qIndex+1}.webm`;
            a.click();
        };
        ui.certDownload.onclick = () => {
            html2canvas(document.getElementById('certificate-to-download')).then(c => {
                const a = document.createElement('a');
                a.href = c.toDataURL();
                a.download = 'Certificate.png';
                a.click();
            });
        };
        ui.menuBtn.onclick = () => {
            ui.certScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            renderTopics();
        };

        init();
    });
    </script>
</body>
</html>
