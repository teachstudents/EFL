<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beyond the Plastic Bottle: The Future of Materials</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌊</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @keyframes slowColorChange {
            0% { background-color: #3b82f6; } /* Blue */
            25% { background-color: #1d4ed8; } /* Darker Blue */
            50% { background-color: #312e81; } /* Indigo */
            75% { background-color: #1d4ed8; } /* Darker Blue */
            100% { background-color: #3b82f6; } /* Blue */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            animation: slowColorChange 240s linear infinite;
            padding-top: 70px; /* Add padding to prevent nav overlap */
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
            border: none;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px -1px rgba(0,0,0,0.2), 0 1px 2px -2px rgba(0,0,0,0.1), inset 0 -2px 0 0 rgba(0,0,0,0.2);
        }
        
        /* Best Practice: Accessibility improvement for keyboard navigation */
        .action-button:focus-visible, .nav-button:focus-visible, .quiz-option:focus-visible, .tfng-button:focus-visible, .word-bank-word:focus-visible, .btn-animated-3d:focus-visible {
            outline: 3px solid #60a5fa; /* A nice blue outline */
            outline-offset: 2px;
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 44px; padding: 0 4px;
            border: 2px dashed #9ca3af; border-radius: 8px; margin: 0 4px;
            vertical-align: middle; background-color: #f3f4f6;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 8px;
            background-color: white; user-select: none;
        }
        .word-bank-word.selected { outline: 2px solid #6366f1; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; }
        .gap.correct .word-bank-word { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .gap.incorrect .word-bank-word { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Feedback Message & Badge Notification */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #fde047, #f97316); }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 20px; } to { opacity: 0; bottom: 0; } }

        /* Certificate Canvas */
        #completion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* Final Project Hub Styles */
        .phase-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .phase-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .keyword-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .keyword-item:hover {
            transform: scale(1.02);
            background-color: #f0f9ff;
        }
        .rooftop-animation {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .building-svg {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #certificate-to-print, #certificate-to-print * { visibility: visible; }
            #certificate-to-print { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="antialiased text-gray-800 text-lg">
    <canvas id="background-canvas"></canvas>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-sm mx-auto p-1.5 flex justify-center items-center gap-2 bg-white/90 backdrop-blur-sm shadow-lg rounded-full">
            <button onclick="goBack()" class="nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <!-- Best Practice: Accessibility improvement for screen readers -->
            <div class="font-bold text-base text-blue-600 px-3">Score: <span id="score-display" aria-live="polite">0</span></div>
            <button onclick="navigateTo('main-menu')" class="nav-button bg-gray-800 text-white font-bold p-2 rounded-full hover:bg-gray-900">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            </button>
            <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-full hover:bg-gray-200" title="Toggle Sound">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
            </button>
            <button onclick="goNext()" class="nav-button bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </header>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <section id="page-title-screen" class="page active text-center bg-white rounded-2xl shadow-lg p-8">
            <div class="h-full flex flex-col justify-center items-center">
                <h1 id="main-title" class="text-5xl md:text-6xl font-bold text-blue-800 mb-4"></h1>
                <p id="main-subtitle" class="text-xl md:text-2xl text-gray-600 mb-8"></p>
                <div id="main-svg-container" class="rounded-lg shadow-md mb-8 w-full max-w-lg mx-auto"></div>
                <button onclick="startApp()" class="action-button bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-2xl hover:bg-blue-700">START LESSON</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <!-- Keyword Modal -->
    <div id="keywordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <p id="modalContent" class="text-gray-700 leading-relaxed"></p>
            </div>
        </div>
    </div>
    
    <!-- 
        Best Practice: AudioWorklet for generating sound effects.
        This runs on a separate audio thread, ensuring smooth, responsive audio 
        without blocking the main UI thread, preventing clicks and lag.
    -->
    <script id="sound-effect-processor" type="worklet-script">
        class SoundEffectProcessor extends AudioWorkletProcessor {
            constructor() {
                super();
                this._phase = 0;
                this._amplitude = 0;
                this._frequency = 440;
                this._durationInSamples = 0;
                this._sampleCount = 0;

                this.port.onmessage = (event) => {
                    const { type, frequency, duration } = event.data;
                    if (type === 'play') {
                        this._amplitude = 0.2; // Start with some volume
                        this._frequency = frequency;
                        this._durationInSamples = duration * sampleRate;
                        this._sampleCount = 0; // Reset sample count to start playing
                    }
                };
            }

            process(inputs, outputs, parameters) {
                const output = outputs[0];
                const outputChannel = output[0];

                if (this._amplitude === 0) {
                    return true; // Nothing to play, keep processor alive
                }

                for (let i = 0; i < outputChannel.length; i++) {
                    if (this._sampleCount < this._durationInSamples) {
                        const wave = Math.sin((2 * Math.PI * this._frequency * this._phase) / sampleRate);
                        outputChannel[i] = wave * this._amplitude;
                        this._phase++;
                        this._sampleCount++;
                        // Simple fade out at the very end to prevent clicks
                        if (this._sampleCount > this._durationInSamples - 256) {
                            this._amplitude *= 0.99;
                        }
                    } else {
                        outputChannel[i] = 0; // Silence after duration
                    }
                }
                
                // If we've finished playing, reset amplitude to 0
                if (this._sampleCount >= this._durationInSamples) {
                    this._amplitude = 0;
                    this._phase = 0;
                }

                return true; // Keep the processor alive
            }
        }
        registerProcessor('sound-effect-processor', SoundEffectProcessor);
    </script>


    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION ---
        // ===================================================================================
        const lessonData = {
            title: "Beyond the Plastic Bottle",
            subtitle: "The Future of Materials <span aria-hidden='true'>🌊♻️</span>",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-tps', text: 'Think-Pair-Share <span aria-hidden="true">🧠</span>', color: 'green', target: 'tps-start' },
                { id: 'menu-goals', text: 'Learning Goals <span aria-hidden="true">🎯</span>', color: 'teal', target: 'learning-goals' },
                { id: 'menu-warmup', text: 'Warm-Up & Vocab <span aria-hidden="true">📚</span>', color: 'sky', target: 'warm-up' },
                { id: 'menu-reading', text: 'Reading: The Plastic Problem <span aria-hidden="true">📖</span>', color: 'blue', target: 'reading-main' },
                { id: 'menu-convo', text: 'Conversation Practice <span aria-hidden="true">🗣️</span>', color: 'indigo', target: 'conversation-practice' },
                { id: 'menu-lecture1', text: 'Listening: Bioplastics 101 <span aria-hidden="true">🧪</span>', color: 'amber', target: 'lecture-bioplastics-1' },
                { id: 'menu-lecture2', text: 'Listening: The Plastic Crisis <span aria-hidden="true">🗑️</span>', color: 'orange', target: 'lecture-plastic-crisis' },
                { id: 'menu-podcast1', text: 'Listening: A Conversation <span aria-hidden="true">🎧</span>', color: 'lime', target: 'podcast-convo-bioplastics' },
                { id: 'menu-debate', text: 'Dilemma: Business Ethics <span aria-hidden="true">🤔</span>', color: 'rose', target: 'dilemma-bubble-tea' },
                { id: 'menu-thinking', text: 'Thinking & Exam Prep <span aria-hidden="true">📝</span>', color: 'purple', target: 'thinking-prompts' },
                { id: 'menu-final', text: 'Final Project <span aria-hidden="true">✍️</span>', color: 'violet', target: 'final-project-hub' },
            ],
            badges: {
                'STREAK_5': { name: 'Hot Streak', icon: '🔥', description: '5 correct answers in a row' },
                'PERFECT_LEVEL': { name: 'Flawless', icon: '💎', description: 'Complete a level with no mistakes' },
                'GAME_COMPLETE': { name: 'Materials Master', icon: '🏆', description: 'Complete all challenges' },
            },
            vocabulary: [
                { word: 'Single-use', def: 'Designed to be used only once and then disposed of.', sentence: 'The café is trying to ban single-use plastic cups. <span aria-hidden="true">🥤</span>' },
                { word: 'Biodegradable', def: 'Able to be broken down naturally by bacteria.', sentence: 'Not all biodegradable materials break down quickly in the ocean. <span aria-hidden="true">🌊</span>' },
                { word: 'Compostable', def: 'Able to be turned into compost in specific conditions.', sentence: 'This coffee cup is compostable, but only in an industrial facility. <span aria-hidden="true">🏭</span>' },
                { word: 'Microplastics', def: 'Extremely small pieces of plastic debris in the environment.', sentence: 'Microplastics have been found in our water, air, and food. <span aria-hidden="true">⚠️</span>' },
                { word: 'Life Cycle', def: 'The series of changes in the life of a product, from creation to disposal.', sentence: 'We need to consider the full life cycle of a product.' },
                { word: 'Renewable', def: 'A resource that can be replaced naturally and used again.', sentence: 'Bamboo is a fast-growing, renewable resource. <span aria-hidden="true">🎋</span>' },
                { word: 'Fossil Fuels', def: 'Fuels such as gas, coal, and oil.', sentence: 'Most plastics are made from fossil fuels. <span aria-hidden="true">🛢️</span>' },
                { word: 'Alternative', def: 'One of two or more things that you can choose between.', sentence: 'Paper straws are a common alternative to plastic ones.' },
                { word: 'Pollution', def: 'Damage caused to water, air, etc. by harmful substances or waste.', sentence: 'Plastic pollution is a serious threat to marine animals. <span aria-hidden="true">🐢</span>' },
                { word: 'Circular Economy', def: 'An economic system aimed at eliminating waste and the continual use of resources.', sentence: 'In a circular economy, products are designed to be reused or recycled. <span aria-hidden="true">♻️</span>' }
            ],
            pages: [
                 // Think Pair Share
                { id: 'tps-start', type: 'simple', content: { title: 'Activity: Think-Pair-Share <span aria-hidden="true">🧠</span>', text: 'Let\'s brainstorm about our daily plastic use.' } },
                { id: 'tps-think', type: 'timer', content: { title: 'Think <span aria-hidden="true">🤔</span>', text: 'Think about your day so far. How many items made of plastic have you used? (e.g., toothbrush, phone case, water bottle, pen).', duration: 120, timerId: 'timer-think' } },
                { id: 'tps-pair', type: 'timer', content: { title: 'Pair <span aria-hidden="true">👥</span>', text: 'Pair with a colleague. Discuss: When you throw something “away,” where does it actually go?', duration: 180, timerId: 'timer-pair' } },
                { id: 'tps-share', type: 'timer', content: { title: 'Share <span aria-hidden="true">🗣️</span>', text: 'Let\'s share some ideas. If you could invent a new material to replace plastic, what would it be like?', duration: 300, timerId: 'timer-share' } },
                
                // STAGE 1 & 2
                { id: 'learning-goals', type: 'html-content', content: { title: 'Stage 1: Desired Results <span aria-hidden="true">🎯</span>', html: `
                    <p><strong class="text-rose-600">Topic:</strong> Eco-Friendly Materials vs. Single-Use Plastics</p>
                    <p><strong class="text-rose-600">Theme:</strong> Conscious Consumerism and the Circular Economy</p>
                    <p><strong class="text-rose-600">Essential Question:</strong> How do our everyday choices in materials impact the planet, and what innovations can lead us to a more sustainable future?</p>
                    <p><strong class="text-rose-600">Learning Intention:</strong> We are learning to evaluate the problems caused by single-use plastics and to analyze the benefits and drawbacks of eco-friendly alternatives.</p>
                    <hr class="my-4">
                    <h3 class="text-2xl font-bold text-rose-600 mb-3">Success Criteria</h3>
                    <ul class="list-disc list-inside space-y-2 text-xl">
                        <li>I can define “single-use plastic” and explain two reasons why it is a problem. <span aria-hidden="true">🛍️</span></li>
                        <li>I can compare and contrast two plastic alternatives using key vocabulary.</li>
                        <li>I can propose a practical, plastic-free solution for a common item. <span aria-hidden="true">💡</span></li>
                    </ul>` } },
                
                // STAGE 3 - W, H, E
                { id: 'warm-up', type: 'html-content', content: { title: 'Hook & Engage: Warm-Up', html: `
                    <h3 class="text-2xl font-bold text-sky-600 mb-3">Background-Building Questions</h3>
                    <ol class="list-decimal list-inside space-y-4 text-xl">
                        <li>Think about your day so far. How many items made of plastic have you used? (e.g., toothbrush, phone case, water bottle, pen).</li>
                        <li>When you throw something “away,” where does it actually go? <span aria-hidden="true">🗑️</span></li>
                        <li>If you could invent a new material to replace plastic, what would it be like? <span aria-hidden="true">🧪</span></li>
                    </ol>` } },
                { id: 'vocab-start', type: 'simple', content: { title: 'Unit Vocabulary <span aria-hidden="true">📚</span>', text: 'Let\'s learn the key terms for this unit. Click "Next" in the header to cycle through the words.' } },
                { id: 'vocab-match', type: 'quiz-mcq', content: { title: 'Vocabulary Practice: Matching', questions: [] } },
                { id: 'reading-main', type: 'html-content', content: { title: 'Reading: Tiered Texts <span aria-hidden="true">📖</span>', html: `
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold text-blue-600 mb-3">Pre-Reading Questions</h3>
                        <ol class="list-decimal list-inside space-y-2 text-xl">
                            <li>Why do you think plastic is so popular and used for so many things?</li>
                            <li>Look at the keywords. What do you predict will be the main message of the reading?</li>
                            <li>What kind of materials could be a good alternative to plastic?</li>
                        </ol>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-bold text-xl text-blue-800">Text 1: The Problem with Plastic</h4>
                            <p>We use plastic every day. Many plastic items are single-use. We use them once and throw them away. But plastic is a problem. It is made from fossil fuels. When we throw it away, it does not disappear. It stays in the environment for hundreds of years. This plastic trash can hurt animals in the ocean. <span aria-hidden="true">🐢</span> We need to use less plastic and find better alternatives.</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="font-bold text-xl text-yellow-800">Text 2: Beyond Plastic: Searching for Alternatives</h4>
                            <p>Single-use plastic is everywhere, from water bottles <span aria-hidden="true">🍾</span> to food packaging. Its convenience comes at a high price for the environment. Most plastic is made from non-renewable fossil fuels, and its production creates pollution. Because it is not biodegradable, almost every piece of plastic ever made still exists today. Much of it ends up in our oceans, where it breaks down into tiny microplastics that harm marine life <span aria-hidden="true">🐟</span> and can enter our food chain. As a result, scientists and innovators are searching for alternatives. Some companies now use materials like bamboo, glass, or metal. Others are developing “bioplastics” made from plants like corn. The goal is to move towards a circular economy, where we reuse materials instead of throwing them away. <span aria-hidden="true">♻️</span></p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-bold text-xl text-red-800">Text 3: Innovating Our Way Out of the Plastic Crisis</h4>
                            <p>The global reliance on single-use plastics has created a severe environmental crisis. These materials, derived primarily from fossil fuels, have a linear life cycle: extract, produce, use, and discard. This model leads to massive amounts of waste, and because plastic is not truly biodegradable, it accumulates in landfills and natural ecosystems. The most visible impact is ocean pollution, where plastic breaks down into pervasive microplastics, threatening marine biodiversity and human health. The solution requires a fundamental shift towards a circular economy. This involves not just recycling, but rethinking product design entirely. The most promising alternatives are often materials from renewable sources. For example, mycelium (the root structure of mushrooms) can be grown into custom shapes for packaging, and it is fully compostable. Seaweed is another versatile resource being transformed into edible films and sachets. However, not all alternatives are perfect. Some “bioplastics,” made from corn starch or sugarcane, only break down in high-temperature industrial composting facilities, not in a backyard compost or the ocean. This can confuse consumers and lead to improper disposal. Therefore, a critical evaluation of each material’s entire life cycle—from the resources needed to grow it to its end-of-life impact—is essential for finding truly sustainable solutions.</p>
                        </div>
                    </div>` } },
                { id: 'reading-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap Fill', sentences: [] } },
                { id: 'reading-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False', questions: [] } },
                { id: 'reading-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [] } },
                { id: 'conversation-practice', type: 'dialogue', content: { title: 'Interactive Conversation Practice <span aria-hidden="true">🗣️</span>', dialogue: "Alex: I’ve been trying to reduce my plastic use, but it’s so difficult. It seems like everything is wrapped in it.\n\nBen: I know what you mean. I bought some vegetables yesterday and they were on a plastic tray, wrapped in more plastic.\n\nAlex: Exactly! On one hand, it keeps the food fresh. But on the other hand, all that packaging is terrible for the environment.\n\nBen: That’s a valid point. I saw a coffee shop using compostable cups. What do you think about those?\n\nAlex: From my perspective, they’re better than plastic, but only if they are actually composted. Otherwise, they just end up in a landfill.\n\nBen: I see your point. So the best alternative is probably a reusable cup.\n\nAlex: I couldn’t agree more. It’s a small change, but if everyone did it, it would make a huge difference.\n\nBen: That’s true. Let’s make a deal to bring our own cups from now on." } },
                
                // LISTENING ACTIVITIES
                { id: 'lecture-bioplastics-1', type: 'dialogue', content: { title: 'Listening: Bioplastics 101 <span aria-hidden="true">🧪</span>', dialogue: "Lecturer: Hello everyone and welcome. Today we're diving into a truly fascinating and important topic: bioplastics. We'll embark on a journey to explore these innovative materials, covering their definition, diverse types, exciting potential benefits, and, importantly, the significant challenges they face. First, we'll lay the groundwork by defining what bioplastics are and how they stand apart from conventional plastics. Then, we'll delve into the various classifications and their promising applications across different industries. Finally, we'll critically examine their environmental footprint, considering their biodegradability and what happens to them at the end of their life cycle. Get ready for an insightful exploration.\n\nSarah: Moving on to the core of our discussion, let's define bioplastics. It's crucial to understand that bioplastic is a broad term for a family of materials that are either bio-based, meaning derived from renewable resources like plants, or biodegradable, meaning they can be broken down by microorganisms. Sometimes they are both. However, and this is a critical point, bio-based does not automatically guarantee biodegradability, and vice versa. This distinction is absolutely vital when assessing their environmental credentials. Furthermore, the conditions required for biodegradation can be quite specific. Many bioplastics require industrial composting facilities which, sadly, are not yet widely available. This presents a real hurdle for their end-of-life management. In stark contrast, traditional fossil fuel-based plastics are notoriously persistent, lingering in our environment for centuries. Therefore, while the shift to bio-based sources offers a hopeful reduction in our reliance on finite resources, the biodegradability aspect and the necessary infrastructure for proper disposal are paramount to realizing their true sustainability potential. It's a complex puzzle, isn't it?\n\nAlex: Indeed, Sarah. And building on that, let's talk about the types and applications. In addition to their composition, bioplastics come in various forms, each with different properties and potential uses. For instance, PLA, derived from cornstarch, is commonly used in packaging and 3D printing, offering good clarity and stiffness. PHA, produced by microorganisms, is often more flexible and can be truly biodegradable in various environments, which is quite promising. Then there are drop-in bioplastics, like bio-PET, which are chemically identical to their fossil fuel counterparts but are made from bio-based feedstock. These can be processed using existing infrastructure, which is a significant advantage, but they don't offer improved biodegradability. We must carefully consider the specific type of bioplastic and its intended use to understand its environmental impact. The diversity highlights both the innovation in this field and the complexity of making truly sustainable choices.\n\nSarah: That's an important distinction, Alex. Now, despite the challenges we've mentioned, bioplastics offer several exciting potential benefits. As we've touched upon, using renewable resources can help reduce our dependence on fossil fuels, contributing to energy security and potentially lower greenhouse gas emissions during production, though this is debated for some types. Additionally, for those bioplastics that are genuinely biodegradable in appropriate environments, they offer a potential pathway to reduce persistent plastic waste accumulating in landfills and oceans, a truly urgent global issue. Furthermore, some bioplastics can have a lower carbon footprint compared to conventional plastics over their life cycle, although this is highly dependent on production methods and land use. The potential is certainly there, and it's something to be optimistic about, provided we address the challenges.\n\nAlex: Absolutely, Sarah. However, to provide a balanced view, we must reiterate and expand on the challenges. The need for specific composting infrastructure for many biodegradable bioplastics is a major obstacle. Without it, they can end up in landfills, where they may not degrade effectively, or worse, contaminate recycling streams for traditional plastics. There are also significant concerns about the land required to grow the crops for bio-based plastics, potentially competing with food production or leading to deforestation, a worry we cannot ignore. Cost can also be a factor, with some bioplastics currently being more expensive than conventional plastics. Moreover, there is considerable consumer confusion surrounding labeling and disposal, which hinders proper waste management. These are substantial hurdles that require concerted effort from industry, governments, and consumers alike. It's not an easy road, but a necessary one.\n\nLecturer: To wrap up this lecture, let's quickly review what we've covered. We started by defining bioplastics as materials that are bio-based, biodegradable, or both, emphasizing that these are not mutually exclusive terms and highlighting the crucial difference between them and conventional plastics. We then explored the diverse types of bioplastics and their varied applications. We discussed the promising benefits, such as reduced reliance on fossil fuels and potential for reduced waste, but we also critically examined the significant challenges, including infrastructure limitations, land use concerns, cost, and consumer confusion. In conclusion, bioplastics represent a vital step in our journey towards more sustainable materials, offering exciting possibilities. However, achieving their full potential requires careful consideration of their entire life cycle, from source to disposal, and collaborative efforts to build the necessary systems and educate the public. It's a complex but incredibly important area, and understanding these nuances is key to making informed decisions about the future of plastics. Thank you for joining me today. I hope this has provided valuable insights into the world of bioplastics. What a journey it has been." } },
                { id: 'lecture-bioplastics-1-quiz-mcq', type: 'quiz-mcq', content: { title: 'Bioplastics 101 Quiz (MCQ)', questions: [] } },
                { id: 'lecture-bioplastics-1-quiz-tfng', type: 'quiz-tfng', content: { title: 'Bioplastics 101 Quiz (TFNG)', questions: [] } },
                { id: 'lecture-bioplastics-1-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Bioplastics 101 Quiz (Gap Fill)', sentences: [] } },
                { id: 'lecture-plastic-crisis', type: 'dialogue', content: { title: 'Listening: The Plastic Crisis <span aria-hidden="true">🗑️</span>', dialogue: "Professor: Welcome everyone to our lecture on environmental sustainability. Today's critical topic is the global reliance on single-use plastics and the search for sustainable alternatives. We'll start by examining the scale of the single-use plastic problem and its environmental impact, particularly on our oceans. Then we'll delve into the concept of shifting towards a circular economy for plastics and explore some promising alternative materials derived from renewable sources. Finally, we'll discuss the challenges and the importance of a critical evaluation of these alternatives. I'm joined by two students who've been looking into this, Maria and Omar. Thanks for being here.\n\nMaria: Thank you, professor. It's an important topic.\n\nOmar: Yeah, thanks for having us. The scale of the problem is quite shocking.\n\nProfessor: It certainly is, Omar. Maria, could you kick us off by describing the, quote, linear life cycle of traditional plastics and why it leads to such a significant waste problem?\n\nMaria: Sure, professor. Traditional plastics follow a linear model. We extract fossil fuels, produce the plastic product, use it once, and then discard it. Because plastics don't truly biodegrade, this take-make-dispose approach creates massive amounts of persistent waste that accumulates in landfills and pollutes our environment.\n\nProfessor: Exactly. And Omar, you mentioned the shocking scale of the problem. What's the most visible and concerning environmental impact of this plastic waste?\n\nOmar: From my perspective, professor, it's the ocean pollution. Plastic debris, especially single-use items, ends up in our oceans, harming marine life. Over time it breaks down into microplastics which are everywhere now and threaten biodiversity and potentially human health.\n\nProfessor: That's a crucial point. So the solution requires a fundamental shift. Maria, how does the concept of a circular economy apply to tackling this plastic crisis?\n\nMaria: Well, professor, a circular economy for plastics goes beyond just recycling. It's about redesigning products and systems entirely to keep plastics in use for as long as possible. This means designing for durability, repairability, and making sure materials can be easily recovered and reused or recycled at the end of a product's life.\n\nProfessor: Designing out waste from the beginning. That's key. Omar, what are some of the promising alternative materials to traditional single-use plastics that you've come across in your research?\n\nOmar: There are some really interesting materials from renewable sources, professor. For instance, mycelium, the root structure of mushrooms, can be grown into packaging. It's fully compostable. Seaweed is another versatile one. It can be turned into edible films or sachets for liquids.\n\nProfessor: Those sound like exciting possibilities. However, Maria, is it true that not all alternatives are as sustainable as they might seem? What should we be cautious about?\n\nMaria: That's right, professor. Some bioplastics made from things like cornstarch require specific conditions to break down, like high-temperature industrial composting. They won't just biodegrade in a backyard compost or in the ocean. This can be confusing for consumers and lead to them ending up in landfills anyway.\n\nProfessor: That's a very important distinction. Omar, what's your perspective on evaluating the sustainability of these alternative materials?\n\nOmar: We need to look at the entire life cycle, professor. Where do the raw materials come from? How much energy and water are used in production? And importantly, what happens at the end of the product's life? Is it truly compostable or recyclable in practice? A critical evaluation is essential to avoid unintended consequences.\n\nProfessor: Excellent points, both of you. It's clear that tackling the single-use plastic crisis requires a systemic shift towards a circular economy and a careful evaluation of sustainable alternatives. To wrap up our lecture today, we've discussed the environmental crisis caused by linear plastic consumption, the potential of a circular economy, and some promising yet complex alternative materials. Thank you, Maria and Omar for your thoughtful contributions.\n\nMaria: Thank you, professor. It was very informative.\n\nOmar: Thanks, professor." } },
                { id: 'lecture-plastic-crisis-quiz-mcq', type: 'quiz-mcq', content: { title: 'Plastic Crisis Quiz (MCQ)', questions: [] } },
                { id: 'lecture-plastic-crisis-quiz-tfng', type: 'quiz-tfng', content: { title: 'Plastic Crisis Quiz (TFNG)', questions: [] } },
                { id: 'lecture-plastic-crisis-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Plastic Crisis Quiz (Gap Fill)', sentences: [] } },
                { id: 'podcast-convo-bioplastics', type: 'dialogue', content: { title: 'Listening: A Conversation on Bioplastics <span aria-hidden="true">🎧</span>', dialogue: "Alex: Hey Sarah, Chris, what do you guys think about all this talk about bioplastics lately? Seems like they're everywhere.\n\nSarah: Oh hi Alex, yes I've noticed that too. There's a real buzz around them, isn't there? I'm a bit curious about how they actually compare to traditional plastics in terms of sustainability.\n\nChris: G’Day, Alex and Sarah. Yeah, you see them popping up more and more. I reckon the idea is fair dinkum, but I'm not sure if they're always the silver bullet people make them out to be. Some of them still take ages to break down—even the biodegradable ones.\n\nSarah: That's a good point, Chris. It feels a bit confusing. Are they really a solution or just another marketing trend? What are the real benefits anyway?\n\nAlex: Well, from what I understand, some are made from renewable resources, which is a plus compared to fossil fuels. And if they genuinely biodegrade in natural environments, that could help with the plastic waste problem.\n\nChris: True, Sarah, but you've got to be careful about the conditions needed for biodegradation. A lot of them need industrial composting, which isn't readily available everywhere. Chucking them in landfill doesn’t do much good, eh?\n\nSarah: Right, so proper disposal is key. It's not just about making them differently, but also having the right infrastructure to handle them at the end of their life. It's more complex than it seems.\n\nChris: Absolutely. And there's also the question of land use for growing the crops used to make some bioplastics. Could that compete with food production? It's not a straightforward issue.\n\nSarah: Good on you, Chris. It's definitely not black and white. There's potential for sure, but we need to be realistic about the challenges and ensure the whole life cycle is considered. No point in solving one problem by creating another, is there?\n\nChris: Couldn't agree more, Sarah. It seems like more research and development are needed—and importantly, clearer labeling and better waste management systems. It's a step in the right direction, but we're not quite there yet." } },
                { id: 'podcast-convo-bioplastics-quiz-mcq', type: 'quiz-mcq', content: { title: 'Bioplastics Conversation Quiz (MCQ)', questions: [] } },
                { id: 'podcast-convo-bioplastics-quiz-tfng', type: 'quiz-tfng', content: { title: 'Bioplastics Conversation Quiz (TFNG)', questions: [] } },
                { id: 'podcast-convo-bioplastics-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Bioplastics Conversation Quiz (Gap Fill)', sentences: [] } },
                { id: 'dilemma-bubble-tea', type: 'dialogue', content: { title: 'Dilemma: Business Ethics <span aria-hidden="true">🤔</span>', dialogue: "Daniel: So um, so uh moving on to another scenario. About the bubble tea companies and the sustainable cups. This is, this is an interesting one about competition and trust.\n\nElizabeth: Indeed. A situation with clear incentives for both cooperation and defection. As the manager of my bubble tea company, I suppose, thinking about it, in my opinion, the best course of action is to agree to switch to the expensive sustainable cups.\n\nLachlan: Yeah, I see your point, Elizabeth, about the environmental protection, but I have a different perspective. I believe we should choose not to switch, at least not secretly agreeing with the competitor. This is justified because, from my perspective, the most ethical choice is protecting our company from being exploited and losing all our customers if they don't switch.\n\nDaniel: Hmm, I understand why you say that, Lachlan. The risk of losing all the customers is huge. But um, while it is true that there's a risk of exploitation if only one switches, I still believe that the potential for protecting the environment and avoiding future government fines is, are more critical right now. The evidence suggests that environmental regulations are only going to get stricter.\n\nElizabeth: Precisely, Daniel. And could you please explain what you mean by protecting our company, Lachlan? I'm not sure I fully understand the, the long-term consequence of not switching at all.\n\nLachlan: Right. Well it's about survival, you know, if they don't switch and we do, they can lower prices and we're out of business. Furthermore, we must consider the impact on our employees if the company fails. It's not just about the environment or future fines.\n\nDaniel: That's a great point, Lachlan. I'd also like to add that if neither company switches, the pollution continues, which has a broader negative impact beyond just the fines.\n\nElizabeth: True, true. On the one hand, the risk of competitive disadvantage is compelling. But on the other hand, the certainty of environmental harm and future fines if neither switches. What would happen if we tried to make a public commitment to switching, rather than a secret agreement?\n\nLachlan: Yeah, I, I see what you mean, Elizabeth. It's a bit of a balancing act, isn't it? Trust versus self-interest. It seems to me that the only real option is, well, it's not easy to decide without knowing if we can truly trust our competitor.\n\nDaniel: Absolutely. I mean, ideally there would be a way to ensure cooperation. But with these two stark choices, I respectfully disagree that the only real option is not switching though. The potential positive impact on the environment is, is pretty clear if both cooperate.\n\nElizabeth: Perhaps a tit-for-tat strategy is the way to go. Start by switching ourselves and see if they follow suit, as Dr. Chen suggested previously. Though, of course, we don't have Dr. Chen here today. But you know that idea of starting with cooperation and then, then responding to their action.\n\nLachlan: Yeah, that makes sense. Little by little I reckon. Take the risk, see if they cooperate, and if not, switch back.\n\nDaniel: That's a possibility. We'd need to weigh the pros and cons carefully for that approach too. What if we lose too many customers in the meantime?\n\nElizabeth: Indeed. It's a complex issue with, with no easy answers in this scenario. A truly unenviable position for those company managers." } },
                { id: 'dilemma-bubble-tea-quiz-mcq', type: 'quiz-mcq', content: { title: 'Bubble Tea Dilemma Quiz (MCQ)', questions: [] } },
                { id: 'dilemma-bubble-tea-quiz-tfng', type: 'quiz-tfng', content: { title: 'Bubble Tea Dilemma Quiz (TFNG)', questions: [] } },
                { id: 'dilemma-bubble-tea-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Bubble Tea Dilemma Quiz (Gap Fill)', sentences: [] } },
                
                // STAGE 3 - R, E, T, O
                { id: 'thinking-prompts', type: 'html-content', content: { title: 'Rethink, Revise, Reflect <span aria-hidden="true">📝</span>', html: `
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-purple-600 mb-3">Harkness Discussion Prompt</h3>
                        <p class="text-xl italic">“Is it the responsibility of consumers to choose sustainable products, or is it the responsibility of companies and governments to stop producing and allowing single-use plastics?”</p>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-purple-600 mb-3">Higher-Order Thinking Questions</h3>
                        <ul class="list-disc list-inside space-y-2 text-lg">
                            <li><b>Remembering:</b> Name three alternatives to plastic mentioned in the texts.</li>
                            <li><b>Understanding:</b> Summarize the life cycle of a typical single-use plastic bottle.</li>
                            <li><b>Applying:</b> How could your school cafeteria apply the principles of the circular economy to reduce its waste?</li>
                            <li><b>Analyzing:</b> Compare the environmental impact of a glass bottle versus a plastic bottle, considering factors like production, weight for transport, and recyclability.</li>
                            <li><b>Evaluating:</b> Argue for or against the statement: “Banning all single-use plastics is the only way to solve the pollution crisis.”</li>
                            <li><b>Creating:</b> Invent a new, completely waste-free product package for a common item like toothpaste or soap.</li>
                        </ul>
                    </div>` } },
                { id: 'exam-practice', type: 'html-content', content: { title: 'Connections to IELTS & TOEFL', html: `
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">IELTS Speaking Practice</h3>
                            <p><b>Part 1:</b> What do you do to protect the environment? Do people in your country recycle? What kinds of things do they recycle?</p>
                            <p><b>Part 2 (Cue Card):</b> Describe a time you made a decision to be more environmentally friendly. You should say: what the decision was, why you made it, how it changed your behavior, and explain how you felt about it.</p>
                            <p><b>Part 3:</b> What are the pros and cons of consumerism? Do you think advertising encourages people to buy things they don’t need? How can we teach children to be responsible consumers?</p>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">TOEFL Independent Speaking</h3>
                            <p>Some people believe that progress is best made through technological innovation. Others believe it is best made through changing people’s behavior. Which view do you agree with and why? Use specific reasons and examples.</p>
                        </div>
                    </div>` } },
                { id: 'final-project-hub', type: 'html-content', content: { title: 'Final Project Hub <span aria-hidden="true">✍️</span>', html: `
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50">
                        <header class="bg-white shadow-lg border-b-4 border-blue-500">
                            <div class="max-w-7xl mx-auto px-6 py-8">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h1 class="text-4xl font-bold text-gray-800 mb-2"><span aria-hidden="true">♻️🧪</span> Beyond the Plastic Bottle</h1>
                                        <p class="text-xl text-gray-600">Final Project Guide</p>
                                    </div>
                                    <div class="rooftop-animation">
                                        <svg class="w-24 h-24" viewBox="0 0 100 100" fill="none"><path d="M35 25 L35 15 Q35 10 40 10 L60 10 Q65 10 65 15 L65 25" stroke="#ef4444" stroke-width="2" fill="none"/><rect x="30" y="25" width="40" height="50" rx="5" fill="#ef4444" opacity="0.3" stroke="#ef4444" stroke-width="2"/><text x="50" y="52" text-anchor="middle" class="text-xs fill-red-600 font-bold">OLD</text><path d="M75 45 L85 50 L75 55" stroke="#10b981" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/><rect x="90" y="25" width="40" height="50" rx="5" fill="#10b981" opacity="0.3" stroke="#10b981" stroke-width="2"/><text x="110" y="52" text-anchor="middle" class="text-xs fill-green-600 font-bold">NEW</text><circle class="plastic-particles" cx="95" cy="30" r="2" fill="#22c55e"/><circle class="plastic-particles" cx="125" cy="35" r="1.5" fill="#16a34a"/><circle class="plastic-particles" cx="105" cy="70" r="2" fill="#22c55e"/><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/></marker></defs></svg>
                                    </div>
                                </div>
                            </div>
                        </header>
                        <section class="max-w-7xl mx-auto px-6 py-12">
                            <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">🎯</span> Big Ideas & Understanding</h2>
                                <div class="grid md:grid-cols-2 gap-8"><div class="bg-gradient-to-r from-blue-100 to-purple-100 p-6 rounded-xl"><h3 class="text-xl font-semibold text-gray-800 mb-4"><span aria-hidden="true">🔄</span> Enduring Understanding</h3><p class="text-gray-700 leading-relaxed">Materials have a lifecycle with environmental and social consequences, and human innovation can create sustainable alternatives to address global problems like plastic pollution.</p></div><div class="bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-xl"><h3 class="text-xl font-semibold text-gray-800 mb-4"><span aria-hidden="true">🌟</span> Big Idea</h3><p class="text-gray-700 leading-relaxed">The materials we use shape our world and our future.</p></div></div>
                            </div>
                            <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">🎓</span> Transferable KSA Skills</h2>
                                <div class="grid md:grid-cols-3 gap-6"><div class="text-center p-6 bg-red-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">🧠</span></div><h3 class="text-xl font-semibold text-red-700 mb-3">Knowledge</h3><p class="text-gray-700 text-sm">Material lifecycle, sustainability principles, circular economy, chemistry & material science vocabulary</p></div><div class="text-center p-6 bg-blue-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">🛠️</span></div><h3 class="text-xl font-semibold text-blue-700 mb-3">Skills</h3><p class="text-gray-700 text-sm">Collaborative problem-solving, critical analysis, persuasive communication, research, technical design</p></div><div class="text-center p-6 bg-green-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">❤️</span></div><h3 class="text-xl font-semibold text-green-700 mb-3">Attitudes</h3><p class="text-gray-700 text-sm">Environmental stewardship, curiosity, responsibility, confidence to advocate for creative solutions</p></div></div>
                            </div>
                            <div class="mb-12">
                                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">🚀</span> Project-Based Learning Journey</h2>
                                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6"><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(1)"><div class="text-4xl mb-4"><span aria-hidden="true">🔍</span></div><h3 class="text-xl font-bold mb-2">Phase 1</h3><p class="text-sm opacity-90">Identifying Problems & Initial Inquiry</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(2)"><div class="text-4xl mb-4"><span aria-hidden="true">📚</span></div><h3 class="text-xl font-bold mb-2">Phase 2</h3><p class="text-sm opacity-90">Researching Solutions & Concepts</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(3)"><div class="text-4xl mb-4"><span aria-hidden="true">📐</span></div><h3 class="text-xl font-bold mb-2">Phase 3</h3><p class="text-sm opacity-90">Planning & Design</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(4)"><div class="text-4xl mb-4"><span aria-hidden="true">📊</span></div><h3 class="text-xl font-bold mb-2">Phase 4</h3><p class="text-sm opacity-90">Evaluation & Communication</p></div></div>
                            </div>
                            <div id="phaseContent" class="bg-white rounded-2xl shadow-xl p-8"></div>
                        </section>
                    </div>` } },
                { id: 'writing-task', type: 'writing-task', content: { 
                    title: 'Writing Activity <span aria-hidden="true">✍️</span>', 
                    prompt: 'Write an article for your school’s online magazine titled “Three Simple Steps to a Plastic-Free Life.” Your goal is to persuade other students to reduce their plastic consumption. For each step, explain the action and why it is important.', 
                    starters: ['We all know that plastic pollution is a major problem, but sometimes it feels too big to solve. However, by making a few small changes, we can make a big difference. Here are three simple steps...', 'The first and easiest step is to...', 'Another powerful action is to...', 'Finally, consider...', 'Reducing our reliance on plastic is a journey, not a race. By taking these small steps together, we can...'],
                    wordBank: ['alternative', 'aware', 'biodegradable', 'choice', 'circular economy', 'consumer', 'convenience', 'disposable', 'environment', 'future', 'habit', 'impact', 'life cycle', 'microplastics', 'packaging', 'pollution', 'recycle', 'reduce', 'renewable', 'responsibility', 'reuse', 'single-use', 'solution', 'sustainable', 'waste']
                } },
                { id: 'self-assessment', type: 'html-content', content: { title: 'Self-Assessment & Rubric <span aria-hidden="true">🧑‍🏫</span>', html: `
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold text-purple-600 mb-3">Metacognitive Self-Assessment</h3>
                        <ol class="list-decimal list-inside space-y-4 text-xl">
                            <li>“On a scale of 1-5, how much did my understanding of the ‘circular economy’ change during this lesson? What helped me understand it better?”</li>
                            <li>“What skill did I practice most today (e.g., reading, analyzing, collaborating, persuading)? What is one thing I could do to improve that skill?”</li>
                        </ol>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-purple-600 mb-3">Final Project Rubric (KASE-C)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-purple-50">
                                        <th class="border-b-2 p-2 w-1/4">Criterion</th>
                                        <th class="border-b-2 p-2">5 - Exemplary</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td class="border-b p-2 font-semibold">K – Knowledge</td><td class="border-b p-2">The proposal demonstrates deep, comprehensive knowledge of material lifecycles, sustainability principles, and the specific needs of the café.</td></tr>
                                    <tr><td class="border-b p-2 font-semibold">A – Analysis</td><td class="border-b p-2">The proposal expertly analyzes the café's current plastic use and provides a sophisticated justification for each recommended alternative, considering cost, function, and environmental impact.</td></tr>
                                    <tr><td class="border-b p-2 font-semibold">S – Structure</td><td class="border-b p-2">The proposal and presentation are exceptionally well-structured, logically weaving together the problem, the solutions, and the benefits for both the business and the environment.</td></tr>
                                    <tr><td class="border-b p-2 font-semibold">E – Evidence</td><td class="border-b p-2">The recommendations are supported by strong, relevant evidence from research on plastic alternatives and a clear understanding of the circular economy.</td></tr>
                                    <tr><td class="border-b p-2 font-semibold">C – Clarity</td><td class="border-b p-2">The language is exceptionally clear, precise, and persuasive. The project's vision and its benefits are communicated in an engaging way.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>` } },
                { id: 'certificate', type: 'certificate', content: { title: 'Module Complete! <span aria-hidden="true">🎉</span>', text: 'You have successfully completed the "Beyond the Plastic Bottle" module.', certificateTitle: 'Certificate of Completion' } }
            ]
        };
        // --- END OF LESSON CONTENT CONFIGURATION ---
        // ===================================================================================

        // --- PROJECT HUB DATA & FUNCTIONS ---
        const phases = {
            1: { title: "Phase 1: Identifying the Problem & Initial Inquiry", icon: "<span aria-hidden='true'>🔍</span>", keywords: { "Plastic Pollution": "The amount of plastic pollution in the oceans is a major problem, harming marine life and contaminating the food chain.", "Single-Use Plastics": "The company decided to eliminate single-use plastics from its products, such as straws and bottles, to be more eco-friendly.", "Environmental Footprint": "The new material was chosen for its small environmental footprint, using less energy and water to produce.", "Recycling": "Our city's recycling program encourages residents to sort their waste to be reprocessed into new products." } },
            2: { title: "Phase 2: Researching Solutions & Foundational Concepts", icon: "<span aria-hidden='true'>📚</span>", keywords: { "Bioplastics": "Many new products are being made from bioplastics, which are derived from plant-based materials like corn and sugarcane.", "Circular Economy": "The company is moving toward a circular economy model, where materials are reused and recycled to create a closed-loop system.", "Upcycling": "Instead of throwing away old clothes, we are teaching students upcycling techniques to turn them into new, fashionable items.", "Biodegradability": "The new packaging material was designed to have a high rate of biodegradability, so it will break down quickly in the environment.", "Material Science": "The field of material science is developing new substances, like self-healing concrete and super-strong alloys, to address modern challenges.", "Lifecycle Analysis": "The company performed a full lifecycle analysis of its product to understand its environmental impact from creation to disposal.", "Durability": "The new product was designed with durability in mind, so it will last for many years and not be thrown away easily." } },
            3: { title: "Phase 3: Planning & Design", icon: "<span aria-hidden='true'>📐</span>", keywords: { "Design Thinking": "The team used design thinking, starting with empathy for the user, to create a product that is both useful and sustainable.", "Prototype": "After a lot of brainstorming, the team created a small prototype of the new bottle to test its design and function.", "Chemical Composition": "The material scientist had to carefully study the chemical composition of the new plastic to ensure it was non-toxic and safe for food.", "Supply Chain": "The project's supply chain was designed to be local and transparent, ensuring that all materials were sourced ethically." } },
            4: { title: "Phase 4: Evaluation & Communication", icon: "<span aria-hidden='true'>📊</span>", keywords: { "Cost-Benefit Analysis": "The company conducted a cost-benefit analysis to show that the new sustainable material would save money in the long run.", "Ethical Considerations": "The ethical considerations of the project, such as fair labor practices and environmental impact, were a key part of the final proposal.", "Project Proposal": "The team's final product was a compelling project proposal that clearly explained their goals, budget, and plans for the new product.", "Persuasive Communication": "The team used powerful visuals and data to create a persuasive communication that convinced the audience to invest in their idea.", "Sustainable Development": "The project focused on sustainable development principles, ensuring that progress today doesn't harm future generations." } }
        };

        window.showPhase = function(phaseNumber) {
            const phase = phases[phaseNumber];
            const content = document.querySelector('#page-final-project-hub #phaseContent');
            if (!content) return;
            let keywordsHtml = Object.entries(phase.keywords).map(([keyword, definition]) => `
                <div class="keyword-item bg-gray-50 p-4 rounded-xl border-l-4 border-blue-500" onclick="showKeyword('${keyword}', '${definition.replace(/'/g, "\\'")}')">
                    <h4 class="font-semibold text-gray-800 mb-2">${keyword}</h4>
                    <p class="text-gray-600 text-sm">${definition.substring(0, 100)}...</p>
                </div>`).join('');
            content.innerHTML = `
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">${phase.icon}</div>
                    <h3 class="text-2xl font-bold text-gray-800">${phase.title}</h3>
                </div>
                <div class="grid md:grid-cols-2 gap-4">${keywordsHtml}</div>`;
        }
        window.showKeyword = function(keyword, definition) {
            document.getElementById('modalTitle').textContent = keyword;
            document.getElementById('modalContent').textContent = definition;
            document.getElementById('keywordModal').classList.remove('hidden');
            document.getElementById('keywordModal').classList.add('flex');
        }
        window.closeModal = function() {
            document.getElementById('keywordModal').classList.add('hidden');
            document.getElementById('keywordModal').classList.remove('flex');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // ===================================================================================
            // --- MAIN SCRIPT ---
            // Best practices applied:
            // 1. AudioWorklet: For non-blocking, performant audio.
            // 2. Accessibility: ARIA live regions and focus-visible styles.
            // 3. Code Organization: Clear sections for state, audio, UI, etc.
            // 4. Robustness: Graceful handling of audio initialization failures.
            // ===================================================================================

            // --- STATE MANAGEMENT ---
            let score = 0, currentPage = lessonData.startPageId, timerInterval;
            const pageHistory = [lessonData.startPageId];
            let pageSequence = [];
            let earnedBadges = [];
            let selectedWord = { element: null, text: '' };

            // --- AUDIO & TTS ENGINE ---
            let audioContext, speechService, soundEffectNode;
            
            /**
             * SpeechService v4.4 (Patched based on user feedback)
             */
            class SpeechService {
                constructor() {
                    this.synth = window.speechSynthesis;
                    this.isInitialized = false;
                    this.isTtsEnabled = true;
                    this.voices = [];
                    this.speechRate = 0.85;
                    this.isAndroid = /Android/i.test(navigator.userAgent);

                    // Explicit mapping: speaker → [preferred voices], lang
                    this.speakerVoiceMap = {
                        // English (US)
                        'alex':      { names: this.isAndroid ? ['Google US English'] : ['Microsoft Brian Online (Natural)'], lang: 'en-US' },
                        'ben':       { names: this.isAndroid ? ['Google US English'] : ['Microsoft Andrew Online (Natural)'], lang: 'en-US' },
                        'sarah':     { names: this.isAndroid ? ['Google US English'] : ['Microsoft Emma Online (Natural)'], lang: 'en-US' },
                        'maria':     { names: this.isAndroid ? ['Google US English'] : ['Microsoft Ava Online (Natural)'], lang: 'en-US' },
                        'omar':      { names: this.isAndroid ? ['Google US English'] : ['Microsoft Andrew Online (Natural)'], lang: 'en-US' },
                        'professor': { names: this.isAndroid ? ['Google UK English Male'] : ['Microsoft Brian Online (Natural)'], lang: 'en-US' },
                        'lecturer':  { names: this.isAndroid ? ['Google UK English Male'] : ['Microsoft Andrew Online (Natural)'], lang: 'en-US' },
                        'chris':     { names: this.isAndroid ? ['Google English (Australia)'] : ['Microsoft Emma Online (Natural)'], lang: 'en-US' },
                        'lachlan':   { names: this.isAndroid ? ['Google English (Australia)'] : ['Microsoft Christopher Online (Natural)'], lang: 'en-US' },
                        'elizabeth': { names: this.isAndroid ? ['Google US English'] : ['Microsoft Emma Online (Natural)'], lang: 'en-US' },
                        'daniel':    { names: this.isAndroid ? ['Google US English'] : ['Microsoft Brian Online (Natural)'], lang: 'en-US' },
                        // Multilingual
                        'seraphina': { names: this.isAndroid ? ['Google Deutsch'] : ['Seraphina'], lang: 'de-DE' },
                        'florian':   { names: this.isAndroid ? ['Google Deutsch'] : ['Florian'],   lang: 'de-DE' },
                        'sonia':     { names: this.isAndroid ? ['Google español'] : ['Sonia'], lang: 'es-ES' },
                        'nicolas':   { names: this.isAndroid ? ['Google français'] : ['Nicolas'], lang: 'fr-FR' },
                        'xiaoxiao':  { names: this.isAndroid ? ['Google 普通话', 'Google Mandarin'] : ['Xiaoxiao'], lang: 'zh-CN' }
                    };

                    // Feedback phrases — varied for motivation
                    this.feedbackPhrases = {
                        de: {
                            correct: [
                                "Sehr gut gemacht!",
                                "Klasse Leistung!",
                                "Super, weiter so!",
                                "Das hast du toll hinbekommen!",
                                "Ausgezeichnete Arbeit!",
                                "Fantastisch, du bist spitze!",
                                "Richtig gut gelöst!"
                            ],
                            incorrect: [
                                "Das ist leider nicht richtig.",
                                "Fast, versuch es noch einmal.",
                                "Nicht ganz, probier es noch einmal.",
                                "Das war knapp daneben.",
                                "Keine Sorge, du schaffst das beim nächsten Mal!",
                                "Versuch es noch einmal, du kannst das!"
                            ]
                        },
                        en: {
                            correct: [
                                "Well done!",
                                "Great job!",
                                "Excellent work!",
                                "Fantastic, keep it up!",
                                "You nailed it!"
                            ],
                            incorrect: [
                                "That's not correct.",
                                "Almost, try again.",
                                "Not quite, give it another go.",
                                "Close, but not correct.",
                                "Don't worry, you'll get it next time!"
                            ]
                        }
                        // Add more languages here if needed
                    };
                }
                _findVoice(preferredNames, langCode) {
                    for (const name of preferredNames) {
                        const match = this.voices.find(v =>
                            v.lang === langCode &&
                            v.name.toLowerCase().includes(name.toLowerCase())
                        );
                        if (match) return match;
                    }
                    return this.voices.find(v => v.lang === langCode) || null;
                }

                _getVoiceForSpeaker(speakerName) {
                    if (!this.isInitialized) {
                        console.warn("Voices not loaded yet");
                        return null;
                    }
                    const lower = speakerName.toLowerCase().trim();
                    if (this.speakerVoiceMap[lower]) {
                        const { names, lang } = this.speakerVoiceMap[lower];
                        return this._findVoice(names, lang);
                    }
                    // Fallback: default English voice
                    return this._findVoice(
                        this.isAndroid ? ['Google US English'] : ['Microsoft Ava Online (Natural)'],
                        'en-US'
                    );
                }

                async init() {
                    if (this.isInitialized) return;
                    const voicesPromise = new Promise(resolve => {
                        if (this.synth.getVoices().length) return resolve(this.synth.getVoices());
                        this.synth.onvoiceschanged = () => resolve(this.synth.getVoices());
                    });
                    this.voices = await voicesPromise;
                    this.isInitialized = true;
                    console.log("Voices loaded:", this.voices.map(v => `${v.name} (${v.lang})`));
                }

                speak(text, { onEndCallback = null } = {}) {
                    if (!this.isInitialized || !this.isTtsEnabled || !text) {
                        if (onEndCallback) onEndCallback();
                        return;
                    }
                    this.synth.cancel();
                    const utter = new SpeechSynthesisUtterance(text);
                    utter.voice = this._findVoice(
                        this.isAndroid ? ['Google US English'] : ['Microsoft Ava Online (Natural)'],
                        'en-US'
                    );
                    utter.rate = this.speechRate;
                    if (onEndCallback) utter.onend = onEndCallback;
                    this.synth.speak(utter);
                }

                speakDialogue(text) {
                    if (!this.isInitialized || !this.isTtsEnabled || !text) return;
                    this.synth.cancel();
                    const lines = text.split('\n').filter(line => line.trim());
                    const queue = lines.map(line => {
                        const [speaker, ...dialogueParts] = line.split(':');
                        const dialogue = dialogueParts.join(':').trim();
                        if (!dialogue) return null;
                        const utter = new SpeechSynthesisUtterance(dialogue);
                        const voice = this._getVoiceForSpeaker(speaker.trim());
                        if (voice) {
                            utter.voice = voice;
                            utter.lang = voice.lang;
                        }
                        utter.rate = this.speechRate;
                        return utter;
                    }).filter(Boolean);

                    const playNext = () => {
                        if (queue.length > 0) {
                            const next = queue.shift();
                            next.onend = playNext;
                            this.synth.speak(next);
                        }
                    };
                    playNext();
                }

                speakFeedback(langCode, isCorrect) {
                    if (!this.isInitialized || !this.isTtsEnabled) return;
                    const options = this.feedbackPhrases[langCode]?.[isCorrect ? 'correct' : 'incorrect'];
                    if (!options || options.length === 0) return;
                    const phrase = Array.isArray(options)
                        ? options[Math.floor(Math.random() * options.length)]
                        : options;

                    let voice;
                    switch (langCode) {
                        case 'de':
                            voice = this._findVoice(
                                this.isAndroid ? ['Google Deutsch'] : ['Seraphina', 'Florian'],
                                'de-DE'
                            );
                            break;
                        case 'en':
                        default:
                            voice = this._findVoice(
                                this.isAndroid ? ['Google US English'] : ['Microsoft Ava Online (Natural)'],
                                'en-US'
                            );
                    }

                    const utter = new SpeechSynthesisUtterance(phrase);
                    if (voice) {
                        utter.voice = voice;
                        utter.lang = voice.lang;
                    }
                    utter.rate = this.speechRate;
                    this.synth.speak(utter);
                }

                cancel() { if (this.synth) this.synth.cancel(); }

                toggleTTS(forceState) {
                    this.isTtsEnabled = forceState === undefined ? !this.isTtsEnabled : forceState;
                    if (!this.isTtsEnabled) {
                        this.cancel();
                    }
                    return this.isTtsEnabled;
                }
            }
            
            // The broken code block was here. It has been removed.

            window.toggleTTS = (button) => {
                if (!speechService) return;
                const isNowEnabled = speechService.toggleTTS();
                const iconPath = isNowEnabled 
                    ? "M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"
                    : "M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z M17 14l-4-4m0 4l4-4";
                button.querySelector('svg').classList.toggle('text-gray-600', isNowEnabled);
                button.querySelector('svg').classList.toggle('text-gray-400', !isNowEnabled);
                button.querySelector('path').setAttribute('d', iconPath);

                if (isNowEnabled) {
                    const pageData = lessonData.pages.find(p => p.id === currentPage);
                    if (pageData && pageData.type === 'dialogue') {
                        speechService.speakDialogue(pageData.content.dialogue);
                    }
                }
            };
            
            async function initializeAudio() {
                if (audioContext) return;
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Load the sound effect processor from the inline script tag
                    const processorScript = document.getElementById('sound-effect-processor').textContent;
                    const blob = new Blob([processorScript], { type: 'application/javascript' });
                    const workletURL = URL.createObjectURL(blob);
                    await audioContext.audioWorklet.addModule(workletURL);

                    // Create the AudioWorkletNode for sound effects
                    soundEffectNode = new AudioWorkletNode(audioContext, 'sound-effect-processor');
                    soundEffectNode.connect(audioContext.destination);

                    // Initialize speech synthesis service
                    speechService = new SpeechService();
                    await speechService.init();

                } catch (e) {
                    console.error("Audio/Speech initialization failed:", e);
                }
            }

            const playSound = (isCorrect) => {
                if (!soundEffectNode) return;
                // Best practice: AudioContext must be resumed after a user gesture.
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                soundEffectNode.port.postMessage({
                    type: 'play',
                    frequency: isCorrect ? 523.25 : 261.63, // C5 for correct, C4 for incorrect
                    duration: 0.15,
                });
            }

            // --- Background & Completion Animations ---
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            let particles = [];
            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                particles.forEach((p, i) => {
                    p.y -= p.speed;
                    p.x += Math.sin(p.y / 50);
                    if (p.y < -p.radius) particles.splice(i, 1);
                    bgCtx.beginPath();
                    bgCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    bgCtx.globalAlpha = p.opacity;
                    bgCtx.fillStyle = p.color;
                    bgCtx.fill();
                });
                if (Math.random() > 0.97 && particles.length < 100) {
                    particles.push({ x: Math.random() * bgCanvas.width, y: bgCanvas.height + 20, radius: Math.random() * 5 + 2, speed: Math.random() * 2 + 1, color: ['#34d399', '#f59e0b', '#a78bfa'][Math.floor(Math.random() * 3)], opacity: Math.random() * 0.5 + 0.5 });
                }
                requestAnimationFrame(animateBackground);
            }
            window.addEventListener('resize', () => { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; });
            animateBackground();

            function runCompletionAnimation() {
                const canvas = document.getElementById('completion-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
                let fireworks = [], confetti = [];

                function Firework(sx, sy, tx, ty) { this.x = sx; this.y = sy; this.sx = sx; this.sy = sy; this.tx = tx; this.ty = ty; this.distanceToTarget = Math.sqrt(Math.pow(tx - sx, 2) + Math.pow(ty - sy, 2)); this.distanceTraveled = 0; this.angle = Math.atan2(ty - sy, tx - sx); this.speed = 2; this.acceleration = 1.05; this.brightness = Math.random() * 50 + 50; this.targetRadius = 1; this.particles = []; }
                Firework.prototype.update = function(index) { this.speed *= this.acceleration; let vx = Math.cos(this.angle) * this.speed; let vy = Math.sin(this.angle) * this.speed; this.distanceTraveled = Math.sqrt(Math.pow(this.x - this.sx, 2) + Math.pow(this.y - this.sy, 2)); if (this.distanceTraveled >= this.distanceToTarget) { for(let i = 0; i < 30; i++) { this.particles.push(new Particle(this.tx, this.ty)); } fireworks.splice(index, 1); } else { this.x += vx; this.y += vy; } }
                Firework.prototype.draw = function() { ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x - Math.cos(this.angle) * 10, this.y - Math.sin(this.angle) * 10); ctx.strokeStyle = `hsl(${Math.random() * 360}, 100%, ${this.brightness}%)`; ctx.stroke(); }
                function Particle(x, y) { this.x = x; this.y = y; this.angle = Math.random() * Math.PI * 2; this.speed = Math.random() * 10; this.friction = 0.95; this.gravity = 1; this.hue = Math.random() * 360; this.brightness = Math.random() * 50 + 50; this.alpha = 1; this.decay = Math.random() * 0.03 + 0.015; }
                Particle.prototype.update = function(index) { this.speed *= this.friction; this.x += Math.cos(this.angle) * this.speed; this.y += Math.sin(this.angle) * this.speed + this.gravity; this.alpha -= this.decay; if (this.alpha <= this.decay) this.particles.splice(index, 1); }
                Particle.prototype.draw = function() { ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); ctx.fillStyle = `hsla(${this.hue}, 100%, ${this.brightness}%, ${this.alpha})`; ctx.fill(); }
                function Confetti() { this.x = Math.random() * canvas.width; this.y = -20; this.w = 10; this.h = 20; this.speed = Math.random() * 3 + 2; this.gravity = 0.5; this.angle = 0; this.rotation = Math.random() * 0.1 - 0.05; this.color = `hsl(${Math.random() * 360}, 100%, 50%)`; }
                Confetti.prototype.update = function(index) { this.y += this.speed; this.speed += this.gravity; this.angle += this.rotation; if (this.y > canvas.height) confetti.splice(index, 1); }
                Confetti.prototype.draw = function() { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle); ctx.fillStyle = this.color; ctx.fillRect(-this.w / 2, -this.h / 2, this.w, this.h); ctx.restore(); }

                let animationRunning = true;
                function animate() {
                    if (!animationRunning) return;
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.globalCompositeOperation = 'lighter';
                    fireworks.forEach((f, i) => { f.draw(); f.update(i); f.particles.forEach((p, j) => { p.draw(); p.update(j); }); });
                    confetti.forEach((c, i) => { c.draw(); c.update(i); });
                    requestAnimationFrame(animate);
                }
                const interval = setInterval(() => {
                    fireworks.push(new Firework(canvas.width / 2, canvas.height, Math.random() * canvas.width, Math.random() * canvas.height / 2));
                    for(let i = 0; i < 10; i++) confetti.push(new Confetti());
                }, 800);
                setTimeout(() => { clearInterval(interval); setTimeout(() => animationRunning = false, 5000); }, 5000);
                animate();
            }

            // --- APP INITIALIZATION ---
            window.startApp = async function() {
                await initializeAudio();
                navigateTo(lessonData.homePageId);
            }
            
            function startTimer(duration, display, onComplete) {
                let timer = duration;
                const update = () => { display.textContent = `${String(Math.floor(timer/60)).padStart(2,'0')}:${String(timer%60).padStart(2,'0')}`; };
                update();
                timerInterval = setInterval(() => { timer--; update(); if (timer < 0) { clearInterval(timerInterval); if (onComplete) onComplete(); } }, 1000);
            }
            
            function stripHtmlAndEmojis(text) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                return tempDiv.textContent || tempDiv.innerText || "";
            }


            // --- NAVIGATION & PAGE FLOW ---
            window.navigateTo = (pageId) => {
                const targetPage = document.getElementById(`page-${pageId}`);
                if (!targetPage) return console.warn('navigateTo: no page found for id', pageId);
                if (pageId === currentPage) return;
                
                clearInterval(timerInterval);
                if(speechService) speechService.cancel();

                document.getElementById(`page-${currentPage}`)?.classList.remove('active');
                targetPage.classList.add('active');
                currentPage = pageId;
                if (pageHistory[pageHistory.length - 1] !== currentPage) pageHistory.push(currentPage);
                
                const pageData = lessonData.pages.find(p => p.id === pageId);
                if (!pageData) return;

                if (pageData.type === 'timer') {
                    const timerEl = document.getElementById(pageData.content.timerId);
                    if (timerEl) startTimer(pageData.content.duration, timerEl, goNext);
                } else if (pageData.id === 'final-project-hub') {
                    window.showPhase(1); // Initialize the project hub view
                }

                if (speechService) {
                    if (pageData.type === 'dialogue') {
                        speechService.speakDialogue(pageData.content.dialogue);
                    } else if (pageData.type === 'certificate') {
                        runCompletionAnimation();
                        const textToSpeak = targetPage.querySelector('.readable-content')?.innerText;
                        if(textToSpeak) speechService.speak(stripHtmlAndEmojis(textToSpeak));
                    } else {
                        const readableContent = targetPage.querySelector('.readable-content');
                        const titleElement = targetPage.querySelector('h2, h3');
                        let textToSpeak = '';
                        if (readableContent) textToSpeak = readableContent.innerHTML;
                        else if (titleElement) textToSpeak = titleElement.innerHTML;
                        
                        if (textToSpeak) speechService.speak(stripHtmlAndEmojis(textToSpeak));
                    }
                }


                updateNavButtons();
                window.scrollTo(0, 0);
            }

            window.goNext = () => {
                const currentIndex = pageSequence.indexOf(currentPage);
                if (currentIndex > -1 && currentIndex < pageSequence.length - 1) navigateTo(pageSequence[currentIndex + 1]);
            }
            window.goBack = () => {
                if (pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); }
            }

            function updateNavButtons() {
                const nav = document.getElementById('nav-header');
                if (!nav) return;
                nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
                const backBtn = nav.querySelector('button:first-child');
                backBtn.disabled = pageHistory.length <= 1;
                backBtn.classList.toggle('opacity-50', backBtn.disabled);
                const nextBtn = nav.querySelector('button:last-child');
                const currentIndex = pageSequence.indexOf(currentPage);
                const isLast = currentIndex >= pageSequence.length - 1;
                const isCertificate = currentPage === 'certificate';
                nextBtn.disabled = isLast || currentPage === lessonData.homePageId || isCertificate;
                nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
            }
            
            // --- UI FEEDBACK, BADGES, & SCORE ---
            function showFeedbackMessage(isCorrect) {
                const correctFeedback = ["That's right!", "You got it!", "Excellent!", "Perfect!", "Great job!", "You're on fire!"];
                const incorrectFeedback = ["Not quite!", "Give it another look!", "Keep trying!", "Don't give up!", "You'll get the next one!"];
                const message = isCorrect ? correctFeedback[Math.floor(Math.random() * correctFeedback.length)] : incorrectFeedback[Math.floor(Math.random() * incorrectFeedback.length)];
                
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `feedback-toast ${isCorrect ? 'correct' : 'encouraging'}`;
                // Best Practice: Use ARIA roles for accessibility.
                // This ensures screen readers announce the dynamic feedback.
                toast.setAttribute('role', 'status');
                toast.setAttribute('aria-live', 'assertive');
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4500); // Remove after animations complete
            }

            function updateScore(points) {
                score += points;
                document.getElementById('score-display').textContent = score;
            }

            // --- QUIZ LOGIC ---
            window.checkTfngAnswer = function(clickedButton, chosenAnswer, correctAnswer) {
                const buttonContainer = clickedButton.parentElement;
                Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
                const isCorrect = chosenAnswer === correctAnswer;
                showFeedbackMessage(isCorrect);
                
                const feedbackIcon = document.createElement('span');
                feedbackIcon.className = `ml-2 text-xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'}`;
                feedbackIcon.textContent = isCorrect ? '✓' : '✗';
                clickedButton.closest('.question-group').appendChild(feedbackIcon);

                if (isCorrect) {
                    playSound(true);
                    clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-green-500');
                    updateScore(10);
                } else {
                    playSound(false);
                    clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-red-600');
                    const correctBtn = Array.from(buttonContainer.children).find(btn => btn.textContent === correctAnswer.charAt(0));
                    if (correctBtn) correctBtn.className = correctBtn.className.replace(/bg-\w+-500/, 'bg-green-500');
                }
            }
            
            window.checkMcqAnswer = function(button, isCorrect) {
                const questionGroup = button.closest('.question-group');
                questionGroup.querySelectorAll('.quiz-option').forEach(opt => opt.disabled = true);
                showFeedbackMessage(isCorrect);

                const feedbackIcon = document.createElement('span');
                feedbackIcon.className = `ml-2 text-xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'}`;
                feedbackIcon.textContent = isCorrect ? '✓' : '✗';
                button.appendChild(feedbackIcon);

                if (isCorrect) {
                    playSound(true);
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-green-500', 'border-green-600', 'text-white');
                    updateScore(10);
                } else {
                    playSound(false);
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-red-500', 'border-red-600', 'text-white');
                    const correctButton = questionGroup.querySelector(".quiz-option[data-correct='true']");
                    if (correctButton) {
                        correctButton.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                        correctButton.classList.add('bg-green-500', 'border-green-600', 'text-white');
                    }
                }
            }

            function initGapFill(pageId) {
                const page = document.getElementById(pageId);
                if (!page) return;
                const gaps = page.querySelectorAll('.gap');
                const words = page.querySelectorAll('.word-bank-word');
                const wordBank = page.querySelector('.word-bank-container');

                words.forEach(word => {
                    word.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', word.dataset.word); setTimeout(() => word.classList.add('opacity-50'), 0); });
                    word.addEventListener('dragend', () => word.classList.remove('opacity-50'));
                    word.addEventListener('click', handleWordClick);
                });

                gaps.forEach(gap => {
                    gap.addEventListener('dragover', e => e.preventDefault());
                    gap.addEventListener('drop', e => handleDrop(e, gap));
                    gap.addEventListener('click', handleGapClick);
                });

                function handleWordClick(e) {
                    const clickedWord = e.currentTarget;
                    if (clickedWord.parentElement.classList.contains('gap')) {
                        clickedWord.parentElement.classList.remove('correct', 'incorrect');
                        wordBank.appendChild(clickedWord);
                        return;
                    }
                    if (selectedWord.element) selectedWord.element.classList.remove('selected');
                    if (selectedWord.element === clickedWord) {
                        selectedWord = { element: null, text: '' };
                    } else {
                        selectedWord = { element: clickedWord, text: clickedWord.dataset.word };
                        clickedWord.classList.add('selected');
                    }
                }

                function handleGapClick(e) {
                    const clickedGap = e.currentTarget;
                    if (!selectedWord.element || clickedGap.children.length > 0) return;
                    const wordElement = selectedWord.element;
                    clickedGap.appendChild(wordElement);
                    wordElement.classList.remove('selected');
                    checkGap(clickedGap);
                    selectedWord = { element: null, text: '' };
                }

                function handleDrop(e, gap) {
                    e.preventDefault();
                    if (gap.children.length > 0) return;
                    const wordText = e.dataTransfer.getData('text/plain');
                    const wordElement = page.querySelector(`.word-bank-word[data-word="${wordText}"]`);
                    if (wordElement) {
                        gap.appendChild(wordElement);
                        checkGap(gap);
                    }
                }

                function checkGap(gap) {
                    const word = gap.querySelector('.word-bank-word');
                    const isCorrect = word && word.dataset.word === gap.dataset.answer;
                    gap.classList.remove('correct', 'incorrect');
                    gap.classList.add(isCorrect ? 'correct' : 'incorrect');
                    if (isCorrect) {
                        playSound(true);
                        updateScore(10);
                        showFeedbackMessage(true);
                        word.draggable = false;
                    } else {
                        playSound(false);
                        showFeedbackMessage(false);
                    }
                }
            }
            
            window.generateCertificate = function() {
                const name = document.getElementById('name-input-cert').value || "Dedicated Learner";
                document.getElementById('certificate-name').textContent = name;
                document.getElementById('certificate-score').textContent = score;
                document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
                document.getElementById('cert-initial-controls').classList.add('hidden');
                document.getElementById('cert-generated-controls').classList.remove('hidden');
            }

            window.downloadCertificateAsImage = function() {
                const certElement = document.getElementById('certificate-to-print');
                html2canvas(certElement, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'materials-lesson-certificate.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            }

            // --- DYNAMIC PAGE & QUIZ GENERATION ---
            function createPageElement(id, content) {
                const section = document.createElement('section');
                section.id = `page-${id}`;
                section.className = 'page';
                // Best Practice Note: Using innerHTML is safe here because the content
                // is from a trusted, hardcoded source (lessonData). If content came
                // from users or an external API, it would need to be sanitized
                // to prevent security risks like Cross-Site Scripting (XSS).
                section.innerHTML = content;
                document.getElementById('dynamic-pages-container').appendChild(section);
            }
            
            function populateQuizzes() {
                // Vocab Match Quiz
                const vocabMatchPage = lessonData.pages.find(p => p.id === 'vocab-match');
                vocabMatchPage.content.questions = lessonData.vocabulary.map((v, i) => {
                    const otherDefs = lessonData.vocabulary.filter((_, idx) => idx !== i).map(item => item.def);
                    const options = [v.def, ...otherDefs.sort(() => 0.5 - Math.random()).slice(0, 3)].sort(() => 0.5 - Math.random());
                    return { question: `What is the definition of "${v.word}"?`, options: options, correctAnswer: v.def };
                });

                // Reading Comprehension Quizzes
                lessonData.pages.find(p => p.id === 'reading-quiz-gap-fill').content.sentences = [
                    { text: ['Most plastic is made from non-renewable resources called', '.'], answer: 'Fossil Fuels' }, { text: ['A key goal of sustainability is to create a', 'where materials are reused, not discarded.'], answer: 'Circular Economy' }, { text: ['When plastic breaks apart in the ocean, it creates tiny particles known as', '.'], answer: 'Microplastics' }, { text: ['Bamboo is a good alternative to plastic because it is a', 'resource that grows quickly.'], answer: 'Renewable' }, { text: ['A coffee cup that is', 'can be broken down into soil, but often only in special facilities.'], answer: 'Compostable' }
                ];
                lessonData.pages.find(p => p.id === 'reading-quiz-tfng').content.questions = [
                    { statement: 'Single-use means you can use an item many times.', correctAnswer: 'False' }, { statement: 'All “biodegradable” plastics will disappear quickly in the ocean.', correctAnswer: 'False' }, { statement: 'A circular economy aims to eliminate waste.', correctAnswer: 'True' }, { statement: 'Microplastics are large, visible pieces of plastic trash.', correctAnswer: 'False' }, { statement: 'Considering a product’s full life cycle is important for sustainability.', correctAnswer: 'True' },
                ];
                lessonData.pages.find(p => p.id === 'reading-quiz-mcq').content.questions = [
                     { question: 'What is the main problem with the “linear life cycle” of plastic?', options: ['It is too circular.', 'It ends with the product being discarded as waste.', 'It uses too many renewable resources.', 'It is too expensive for consumers.'], correctAnswer: 'It ends with the product being discarded as waste.' }, { question: 'According to the text, why are some “bioplastics” not a perfect solution?', options: ['They are made from fossil fuels.', 'They are more expensive than gold.', 'They require special industrial conditions to break down.', 'They cannot be used for food packaging.'], correctAnswer: 'They require special industrial conditions to break down.' }, { question: 'Which of the following is an example of a renewable resource mentioned as a plastic alternative?', options: ['Oil.', 'Natural gas.', 'Mycelium (mushrooms).', 'Gold.'], correctAnswer: 'Mycelium (mushrooms).' }, { question: 'The term “conscious consumerism” means...', options: ['Buying things without thinking.', 'Thinking about the environmental and social impact of your purchases.', 'Only buying the cheapest products.', 'Never buying anything new.'], correctAnswer: 'Thinking about the environmental and social impact of your purchases.' }, { question: 'What is the main purpose of Germany’s “Pfand” system?', options: ['To make drinks more expensive.', 'To encourage consumers to return bottles and cans for recycling.', 'To collect data on what people are drinking.', 'To create jobs for bottle collectors.'], correctAnswer: 'To encourage consumers to return bottles and cans for recycling.' },
                ];
                
                // Listening Quizzes
                lessonData.pages.find(p => p.id === 'lecture-bioplastics-1-quiz-mcq').content.questions = [
                    { question: 'What does “biobased” mean?', options: ['Made from recycled plastic', 'Made from renewable resources like plants', 'Made from fossil fuels', 'Made from metal'], correctAnswer: 'Made from renewable resources like plants' }, { question: 'Which type of bioplastic is made from cornstarch?', options: ['PHA', 'PLA', 'BioPET', 'PVC'], correctAnswer: 'PLA' }, { question: 'What is a major challenge with many biodegradable bioplastics?', options: ['They are banned in most countries', 'They are too strong to break down', 'They need industrial composting', 'They melt in the sun'], correctAnswer: 'They need industrial composting' }, { question: 'What is a concern about land use for bioplastics?', options: ['It may increase air pollution', 'It could compete with food production', 'It makes plastic stronger', 'It helps reduce water use'], correctAnswer: 'It could compete with food production' }, { question: 'What is needed to help bioplastics succeed?', options: ['More fossil fuels', 'Less recycling', 'Better systems and public education', 'More plastic factories'], correctAnswer: 'Better systems and public education' }
                ];
                lessonData.pages.find(p => p.id === 'lecture-bioplastics-1-quiz-tfng').content.questions = [
                    { statement: "All biobased plastics are also biodegradable.", correctAnswer: 'False' }, { statement: "PHA is produced by microorganisms and is often flexible.", correctAnswer: 'True' }, { statement: "The lecture states bioplastics are always cheaper than traditional plastics.", correctAnswer: 'False' }, { statement: "BioPET is biodegradable.", correctAnswer: 'False' }, { statement: "Consumer confusion about labeling is a challenge for bioplastics.", correctAnswer: 'True' }
                ];
                lessonData.pages.find(p => p.id === 'lecture-bioplastics-1-quiz-gap-fill').content.sentences = [
                    { text: ['A material that can be broken down by microorganisms is called', '.'], answer: 'biodegradable' }, { text: ['Bio-PET is an example of a', 'bioplastic.'], answer: 'drop-in' }, { text: ['Using renewable resources can reduce our dependence on', '.'], answer: 'fossil fuels' }, { text: ['The entire journey of a product is called its', 'cycle.'], answer: 'life' }, { text: ['Growing crops for bioplastics could lead to', '.'], answer: 'deforestation' }
                ];

                lessonData.pages.find(p => p.id === 'lecture-plastic-crisis-quiz-mcq').content.questions = [
                    { question: 'What is the "linear life cycle" of plastics?', options: ['Take-Make-Reuse', 'Extract-Produce-Recycle', 'Take-Make-Dispose', 'Extract-Use-Compost'], correctAnswer: 'Take-Make-Dispose' }, { question: 'What is the most visible environmental impact of plastic waste?', options: ['Air pollution', 'Soil contamination', 'Ocean pollution', 'Noise pollution'], correctAnswer: 'Ocean pollution' }, { question: 'What does a circular economy for plastics focus on beyond recycling?', options: ['Burying waste', 'Burning waste', 'Redesigning products and systems', 'Exporting waste'], correctAnswer: 'Redesigning products and systems' }, { question: 'Which of these is mentioned as a promising, fully compostable alternative?', options: ['Glass', 'Aluminum', 'Mycelium', 'Bioplastics from corn'], correctAnswer: 'Mycelium' }, { question: 'What is a key problem with some bioplastics made from cornstarch?', options: ['They are not strong enough', 'They require industrial composting', 'They are toxic', 'They are made from oil'], correctAnswer: 'They require industrial composting' }
                ];
                lessonData.pages.find(p => p.id === 'lecture-plastic-crisis-quiz-tfng').content.questions = [
                    { statement: "Traditional plastics are not truly biodegradable.", correctAnswer: 'True' }, { statement: "Omar believes ocean pollution is not a significant problem.", correctAnswer: 'False' }, { statement: "A circular economy only focuses on recycling.", correctAnswer: 'False' }, { statement: "Seaweed can be turned into edible films.", correctAnswer: 'True' }, { statement: "The professor concludes that all plastic alternatives are perfect solutions.", correctAnswer: 'False' }
                ];
                lessonData.pages.find(p => p.id === 'lecture-plastic-crisis-quiz-gap-fill').content.sentences = [
                    { text: ['The take-make-dispose approach creates massive amounts of persistent', '.'], answer: 'waste' }, { text: ['Plastic debris breaks down into', 'in the ocean.'], answer: 'microplastics' }, { text: ['A circular economy is about designing for durability and', '.'], answer: 'repairability' }, { text: ['Mycelium is the root structure of', '.'], answer: 'mushrooms' }, { text: ['A', 'evaluation of a material\'s entire life cycle is essential.'], answer: 'critical' }
                ];

                lessonData.pages.find(p => p.id === 'podcast-convo-bioplastics-quiz-mcq').content.questions = [
                    { question: 'What is one benefit of bioplastics mentioned by Alex?', options: ['They are cheaper than traditional plastics', 'They are made from renewable resources', 'They are stronger than metal', 'They never break down'], correctAnswer: 'They are made from renewable resources' }, { question: 'What concern does Chris raise about biodegradable bioplastics?', options: ['They are too expensive to produce', 'They pollute the air', 'They need special composting conditions', 'They are banned in some countries'], correctAnswer: 'They need special composting conditions' }, { question: 'Why is proper disposal important for bioplastics?', options: ['They can explode if not handled correctly', 'They only work if thrown into the ocean', 'They need the right conditions to biodegrade', 'They are illegal in landfills'], correctAnswer: 'They need the right conditions to biodegrade' }, { question: 'What issue does Chris raise about growing crops for bioplastics?', options: ['It could compete with food production', 'It makes the soil toxic', 'It causes flooding', 'It increases plastic strength'], correctAnswer: 'It could compete with food production' }, { question: 'What do the speakers agree on at the end?', options: ['Bioplastics are a perfect solution', 'Bioplastics should be banned', 'More research and better systems are needed', 'Traditional plastics are better'], correctAnswer: 'More research and better systems are needed' }
                ];
                lessonData.pages.find(p => p.id === 'podcast-convo-bioplastics-quiz-tfng').content.questions = [
                    { statement: "All bioplastics are biodegradable in natural environments.", correctAnswer: 'False' }, { statement: "Chris thinks bioplastics are a good idea but not a complete solution.", correctAnswer: 'True' }, { statement: "Sarah says bioplastics are cheaper than traditional plastics.", correctAnswer: 'Not Given' }, { statement: "The conversation mentions that bioplastics can help reduce plastic waste.", correctAnswer: 'True' }, { statement: "Alex believes bioplastics are harmful to the environment.", correctAnswer: 'False' }
                ];
                lessonData.pages.find(p => p.id === 'podcast-convo-bioplastics-quiz-gap-fill').content.sentences = [
                    { text: ['Chris is not sure if bioplastics are the', 'bullet people make them out to be.'], answer: 'silver' }, { text: ['A lot of bioplastics need industrial', ', which isn\'t readily available.'], answer: 'composting' }, { text: ['Proper disposal', 'is key to handling bioplastics.'], answer: 'infrastructure' }, { text: ['Growing crops for bioplastics could compete with food', '.'], answer: 'production' }, { text: ['The speakers agree that clearer', 'on packaging is needed.'], answer: 'labeling' }
                ];

                lessonData.pages.find(p => p.id === 'dilemma-bubble-tea-quiz-mcq').content.questions = [
                    { question: 'What is Lachlan’s main concern about switching to sustainable cups?', options: ['The cups are not recyclable', 'The competitor might not switch', 'Customers prefer plastic', 'Government fines are too high'], correctAnswer: 'The competitor might not switch' }, { question: 'What does Daniel say about environmental regulations?', options: ['They are being removed', 'They are unpredictable', 'They are likely to become stricter', 'They are not enforced'], correctAnswer: 'They are likely to become stricter' }, { question: 'What alternative does Elizabeth propose to secret cooperation?', options: ['Public commitment', 'Lowering prices', 'Hiring more staff', 'Changing suppliers'], correctAnswer: 'Public commitment' }, { question: 'What strategy does Elizabeth mention that Dr. Chen suggested?', options: ['Price matching', 'Tit-for-tat cooperation', 'Legal action', 'Advertising campaigns'], correctAnswer: 'Tit-for-tat cooperation' }, { question: 'What do the group agree on at the end of the discussion?', options: ['The competitor should be ignored', 'There is no easy answer', 'Sustainable cups are too expensive', 'The government should intervene'], correctAnswer: 'There is no easy answer' }
                ];
                lessonData.pages.find(p => p.id === 'dilemma-bubble-tea-quiz-tfng').content.questions = [
                    { statement: "Elizabeth supports switching to sustainable cups.", correctAnswer: 'True' }, { statement: "Lachlan’s main concern is competitive risk and company survival.", correctAnswer: 'True' }, { statement: "Daniel suggests that pollution will continue if neither company switches.", correctAnswer: 'True' }, { statement: "The group decides to switch to sustainable cups immediately.", correctAnswer: 'False' }, { statement: "Dr. Chen is present during the discussion.", correctAnswer: 'False' }
                ];
                lessonData.pages.find(p => p.id === 'dilemma-bubble-tea-quiz-gap-fill').content.sentences = [
                    { text: ['Elizabeth believes switching to sustainable cups is important for', 'protection.'], answer: 'environmental' }, { text: ['Lachlan worries that switching alone could lead to', 'disadvantage.'], answer: 'competitive' }, { text: ['Daniel says future', 'regulations are likely to become stricter.'], answer: 'environmental' }, { text: ['Lachlan argues that company failure would affect not just profits but also', '.'], answer: 'employees' }, { text: ['Elizabeth suggests a', 'commitment instead of a secret agreement.'], answer: 'public' }
                ];
            }

            function initializeLesson() {
                document.getElementById('main-title').innerHTML = lessonData.title;
                document.getElementById('main-subtitle').innerHTML = lessonData.subtitle;
                document.getElementById('main-svg-container').innerHTML = `<svg viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:rgb(59, 130, 246);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(34, 197, 94);stop-opacity:1" /></linearGradient></defs><rect width="600" height="300" fill="#eff6ff"/><path d="M50,150 C150,50 350,50 450,150 S550,250 650,150" stroke="url(#grad1)" stroke-width="8" fill="none" stroke-linecap="round" opacity="0.5"/><path d="M-50,200 C50,100 250,100 350,200 S450,300 550,200" stroke="url(#grad1)" stroke-width="8" fill="none" stroke-linecap="round" opacity="0.7"/><text x="50%" y="45%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="40" fill="#1e3a8a" font-weight="bold">Beyond the Plastic Bottle <tspan aria-hidden="true">🌊</tspan></text></svg>`;

                populateQuizzes();

                const menuButtons = lessonData.mainMenu.map(item => {
                    const colors = { green: 'bg-green-500 border-green-700', blue: 'bg-blue-500 border-blue-700', sky: 'bg-sky-500 border-sky-700', amber: 'bg-amber-500 border-amber-700', rose: 'bg-rose-500 border-rose-700', violet: 'bg-violet-500 border-violet-700', teal: 'bg-teal-500 border-teal-700', orange: 'bg-orange-500 border-orange-700', indigo: 'bg-indigo-500 border-indigo-700', lime: 'bg-lime-500 border-lime-700', emerald: 'bg-emerald-500 border-emerald-700', red: 'bg-red-500 border-red-700', purple: 'bg-purple-500 border-purple-700' };
                    return `<button onclick="navigateTo('${item.target}')" class="btn-animated-3d ${colors[item.color] || colors['green']} text-white font-bold text-xl p-4 rounded-xl">${item.text}</button>`;
                }).join('');
                createPageElement(lessonData.homePageId, `<div class="bg-white rounded-2xl shadow-lg p-8"><h2 class="text-4xl font-bold text-center text-blue-800 mb-8">Main Menu</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4">${menuButtons}</div></div>`);
                
                // Build the master page sequence for next/back buttons
                pageSequence = [lessonData.startPageId, lessonData.homePageId];
                const menuOrder = lessonData.mainMenu.map(item => item.target);
                const pageOrderMap = {
                    'tps-start': ['tps-think', 'tps-pair', 'tps-share'],
                    'warm-up': ['vocab-start'],
                    'vocab-start': lessonData.vocabulary.map((v, i) => `vocab-${i}`),
                    'reading-main': ['reading-quiz-gap-fill', 'reading-quiz-tfng', 'reading-quiz-mcq'],
                    'lecture-bioplastics-1': ['lecture-bioplastics-1-quiz-mcq', 'lecture-bioplastics-1-quiz-tfng', 'lecture-bioplastics-1-quiz-gap-fill'],
                    'lecture-plastic-crisis': ['lecture-plastic-crisis-quiz-mcq', 'lecture-plastic-crisis-quiz-tfng', 'lecture-plastic-crisis-quiz-gap-fill'],
                    'podcast-convo-bioplastics': ['podcast-convo-bioplastics-quiz-mcq', 'podcast-convo-bioplastics-quiz-tfng', 'podcast-convo-bioplastics-quiz-gap-fill'],
                    'dilemma-bubble-tea': ['dilemma-bubble-tea-quiz-mcq', 'dilemma-bubble-tea-quiz-tfng', 'dilemma-bubble-tea-quiz-gap-fill'],
                    'thinking-prompts': ['exam-practice'],
                    'final-project-hub': ['writing-task', 'self-assessment', 'certificate']
                };
                 // Add the vocab quiz after the last vocab card
                pageOrderMap[`vocab-${lessonData.vocabulary.length - 1}`] = ['vocab-match'];

                menuOrder.forEach(startId => {
                    let queue = [startId];
                    let visited = new Set([startId]);
                    while(queue.length > 0) {
                        let current = queue.shift();
                        if (!pageSequence.includes(current)) {
                            pageSequence.push(current);
                        }
                        if (pageOrderMap[current]) {
                            pageOrderMap[current].forEach(next => {
                                if (!visited.has(next)) {
                                    queue.push(next);
                                    visited.add(next);
                                }
                            });
                        }
                    }
                });

                lessonData.vocabulary.forEach((v, i) => {
                    createPageElement(`vocab-${i}`, `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h3 class="text-2xl font-bold text-sky-600 mb-2">Vocabulary ${i + 1} / ${lessonData.vocabulary.length}</h3><div class="my-8"><h2 class="text-5xl font-bold text-gray-800 mb-4">${v.word}</h2><p class="text-2xl text-gray-600 mb-4">${v.def}</p><p class="text-xl text-gray-500 italic">"${v.sentence}"</p></div></div></div>`);
                });

                lessonData.pages.forEach(page => {
                    let pageHTML = '';
                    switch (page.type) {
                        case 'simple':
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-gray-800 mb-6">${page.content.title}</h2><p class="text-xl text-gray-600 mb-8">${page.content.text}</p></div></div>`;
                            break;
                        case 'timer':
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col justify-center text-left pt-16"><div class="w-full flex justify-between items-center mb-4"><h2 class="text-2xl md:text-3xl font-bold text-green-700">${page.content.title}</h2><div id="${page.content.timerId}" class="text-3xl md:text-4xl font-bold text-gray-700 ml-4"></div></div><div class="readable-content"><p class="text-lg md:text-xl text-gray-600 mt-8">${page.content.text}</p></div></div>`;
                            break;
                        case 'dialogue':
                        case 'lecture':
                        case 'html-content':
                            const titleColor = { 'dialogue': 'text-orange-700', 'lecture': 'text-amber-700', 'html-content': 'text-rose-700' }[page.type] || 'text-gray-800';
                            const contentHTML = page.type === 'html-content' ? page.content.html : (page.content.dialogue || '').split('\n\n').map(line => {
                                const [speaker, ...rest] = line.split(':');
                                return `<p><strong class="text-blue-700">${speaker}:</strong>${rest.join(':')}</p>`
                            }).join('');
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center ${titleColor} mb-6">${page.content.title}</h2><div class="readable-content text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg max-h-[70vh] overflow-y-auto">${contentHTML}</div></div>`;
                            break;
                        case 'quiz-tfng':
                        case 'quiz-mcq':
                        case 'quiz-gap-fill':
                            let questionsHTML = '';
                            if (page.type === 'quiz-tfng') {
                                questionsHTML = page.content.questions.map((q, index) => {
                                    const buttonsHTML = ['True', 'False', 'Not Given'].map(label => `<button onclick="checkTfngAnswer(this, '${label}', '${q.correctAnswer}')" class="tfng-button bg-${label === 'True' ? 'blue' : label === 'False' ? 'red' : 'gray'}-500 text-white font-bold w-12 h-10 rounded-full">${label.charAt(0)}</button>`).join('');
                                    return `<div class="question-group flex items-center gap-4 p-4 rounded-lg bg-gray-100"><div class="button-container flex-shrink-0 flex gap-2">${buttonsHTML}</div><p>${index + 1}. ${q.statement}</p></div>`;
                                }).join('');
                            } else if (page.type === 'quiz-mcq') {
                                questionsHTML = page.content.questions.map((q, index) => {
                                    const optionsHTML = q.options.map(opt => `<button onclick="checkMcqAnswer(this, ${opt === q.correctAnswer})" data-correct="${opt === q.correctAnswer}" class="quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200">${opt}</button>`).join('');
                                    return `<div class="question-group ${index > 0 ? 'border-t pt-6' : ''}"><p class="font-semibold mb-2">${index + 1}. ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-2">${optionsHTML}</div></div>`;
                                }).join('');
                            } else if (page.type === 'quiz-gap-fill') {
                                const words = page.content.sentences.map(s => s.answer).sort(() => Math.random() - 0.5);
                                const gapFillHTML = page.content.sentences.map((s, i) => `<p class="text-lg mb-4">${i + 1}. ${s.text[0]} <span class="gap" data-answer="${s.answer}"></span> ${s.text[1]}</p>`).join('');
                                const wordBankHTML = words.map(w => `<div class="word-bank-word" draggable="true" data-word="${w}">${w}</div>`).join('');
                                questionsHTML = `<div class="gap-fill-container">${gapFillHTML}</div><div class="word-bank-container mt-8 p-4 bg-gray-100 rounded-lg flex flex-wrap gap-4 justify-center">${wordBankHTML}</div>`;
                            }
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h3 class="text-3xl font-bold text-pink-600 mb-6 text-center">${page.content.title}</h3><div class="space-y-6">${questionsHTML}</div></div>`;
                            break;
                        case 'writing-task':
                            const startersHTML = page.content.starters.map(s => `<li class="text-gray-500">${s}</li>`).join('');
                            const wordBankHTML = page.content.wordBank ? `<div class="mt-6"><h4 class="font-bold text-lg text-indigo-600">Word Bank:</h4><div class="flex flex-wrap gap-2 mt-2 p-4 bg-gray-100 rounded-lg">${page.content.wordBank.map(w => `<span class="bg-white px-2 py-1 rounded-md shadow-sm text-gray-700">${w}</span>`).join('')}</div></div>` : '';
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-center text-indigo-700 mb-6">${page.content.title}</h2><div class="text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg"><h3 class="font-bold text-xl text-indigo-600">Prompt:</h3><p>${page.content.prompt}</p><h3 class="font-bold text-xl text-indigo-600 mt-4">Sentence Starters:</h3><ul class="list-disc list-inside ml-4">${startersHTML}</ul>${wordBankHTML}</div></div><div class="text-center mt-6"><button onclick="goNext()" class="action-button bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-xl hover:bg-blue-700">Continue to Final Reflection</button></div></div>`;
                            break;
                        case 'certificate':
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16 relative overflow-hidden"><canvas id="completion-canvas"></canvas><div class="relative z-10"><div class="readable-content"><h2 class="text-4xl font-bold text-amber-600 mb-4">${page.content.title}</h2><p class="text-xl text-gray-600 mb-6">${page.content.text}</p></div><div id="certificate-to-print" class="bg-blue-50 border-4 border-dashed border-blue-300 rounded-lg p-8 max-w-2xl mx-auto"><div class="flex justify-center mb-4"><span class="text-6xl">♻️</span></div><h3 class="text-3xl font-bold text-blue-800">${page.content.certificateTitle}</h3><p class="mt-4 text-lg">This certificate is awarded to</p><p id="certificate-name" class="text-2xl font-bold text-blue-600 my-2 border-b-2 border-gray-400 pb-2">[Enter Your Name Here]</p><p class="mt-4 text-lg">for successfully completing this lesson.</p><p class="mt-6 text-md"><strong>Final Score:</strong> <span id="certificate-score" class="font-bold"></span> points</p><p class="text-sm mt-1"><strong>Date of Completion:</strong> <span id="certificate-date"></span></p></div><div id="cert-controls" class="mt-6"><div id="cert-initial-controls"><input type="text" id="name-input-cert" placeholder="Enter your name for the certificate" class="text-center p-2 border rounded-lg w-full max-w-md"><button onclick="generateCertificate()" class="action-button mt-4 bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700">Generate Certificate</button></div><div id="cert-generated-controls" class="hidden mt-4 flex flex-wrap justify-center gap-4"><button onclick="downloadCertificateAsImage()" class="action-button bg-green-600 text-white font-bold py-2 px-4 rounded-full text-sm">Download Image</button></div></div></div></div>`;
                            break;
                    }
                    if (pageHTML) {
                        createPageElement(page.id, pageHTML);
                        if (page.type === 'quiz-gap-fill') {
                            initGapFill(`page-${page.id}`);
                        }
                    }
                });
                
                updateNavButtons();
            }

            initializeLesson();
            
            document.getElementById('keywordModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
