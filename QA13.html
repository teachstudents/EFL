<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QA13 Speaking Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
            position: relative;
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        audio::-webkit-media-controls-panel {
            padding: 5px;
        }
        /* Improve scrolling on mobile */
        .scroll-container {
            scrollbar-width: thin;
            scrollbar-color: #4f46e5 #e5e7eb;
        }
        .scroll-container::-webkit-scrollbar {
            width: 6px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gradient-to-br dark:from-slate-900 dark:via-blue-900 dark:to-slate-900 text-gray-800 dark:text-gray-200 flex items-center justify-center p-2 sm:p-4">
    
    <div id="app-container" class="w-full max-w-xl mx-auto text-center h-full relative z-10">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-white dark:bg-gray-800 dark:shadow-lg p-6 sm:p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center">
            <div id="name-entry-container">
                <div class="mb-6">
                    <i class="fas fa-microphone-lines text-5xl text-indigo-600 dark:text-indigo-400 mb-2"></i>
                </div>
                <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">QA13 Practice</h1>
                <p class="mb-6 text-gray-600 dark:text-gray-400 text-sm">Enter your name to begin session QA13.</p>
                <input type="text" id="name-input" placeholder="Your Name" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 text-center text-lg text-gray-900 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                <button id="start-with-name-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md transition-transform active:scale-95">Start QA13</button>
            </div>

            <div id="topic-selection-container" class="hidden h-full flex flex-col">
                 <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-2 flex-shrink-0">Hello, <span id="user-name-display"></span>!</h1>
                 
                 <div id="instructions" class="text-sm text-gray-600 dark:text-gray-400 mb-4 text-left space-y-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg flex-shrink-0 border border-gray-200 dark:border-gray-700">
                      <p><i class="fas fa-bullhorn mr-2 text-indigo-500"></i>Speak until the timer runs out.</p>
                      <p><i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Use the sentence starters for help.</p>
                      <p><i class="fas fa-download mr-2 text-blue-500"></i>Download your recording after speaking.</p>
                 </div>
                 
                 <div class="flex-grow overflow-y-auto scroll-container pr-1">
                    <div id="topic-selection" class="grid grid-cols-1 sm:grid-cols-2 gap-3 pb-2">
                        <!-- Topic buttons will be injected here -->
                    </div>
                 </div>
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practice-screen" class="hidden bg-white dark:bg-gray-800 dark:shadow-lg rounded-2xl shadow-lg app-shell p-3 sm:p-4">
            <header class="flex-shrink-0">
                <div class="flex justify-between items-center mb-2">
                    <div class="w-1/3 text-left">
                         <button id="back-to-topics-btn" class="text-xs sm:text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-1.5 px-3 rounded-lg shadow-sm transition-colors">
                             <i class="fas fa-arrow-left mr-1"></i>Topics
                         </button>
                    </div>
                    <div class="w-1/3 text-center">
                         <button id="samples-btn" class="hidden text-xs sm:text-sm bg-amber-500 hover:bg-amber-600 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition-colors">
                             <i class="fas fa-lightbulb mr-1"></i>Ideas
                         </button>
                    </div>
                    <div class="w-1/3 text-right">
                         <button id="next-btn" class="hidden text-xs sm:text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-sm disabled:bg-indigo-400 dark:disabled:bg-indigo-800 disabled:cursor-not-allowed transition-colors">
                             Next<i class="fas fa-arrow-right ml-1"></i>
                         </button>
                    </div>
                </div>

                <!-- Timer Display -->
                <div class="relative w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-2 flex-shrink-0">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-200 dark:text-gray-700" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="timer-progress" class="timer-circle text-indigo-500" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-2xl font-bold font-mono"></div>
                    <button id="pause-resume-btn" class="hidden absolute bottom-0 right-0 w-8 h-8 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center text-sm shadow-md z-20 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                        <i class="fas fa-pause"></i>
                    </button>
                </div>
                
                <p id="phase-indicator" class="font-semibold text-indigo-600 dark:text-indigo-400 mb-1 text-sm uppercase tracking-wide flex-shrink-0"></p>

                <!-- Question Display -->
                <div id="question-container" class="min-h-[60px] flex items-center justify-center mb-2 bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-xl border border-indigo-100 dark:border-indigo-800">
                    <h2 id="question-text" class="text-base sm:text-lg font-bold leading-snug text-center w-full text-gray-800 dark:text-gray-100"></h2>
                </div>
                
                <div id="error-message-box" class="hidden text-red-500 bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-800 p-2 rounded-lg text-xs mb-2"></div>

                <!-- Recording Action Buttons -->
                <div id="recording-actions-container" class="flex flex-col items-center justify-center mb-1">
                    <!-- Initial Record Button -->
                    <button id="record-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold w-14 h-14 rounded-full text-xl shadow-lg shadow-red-500/30 transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <!-- Stop Button -->
                    <button id="stop-record-btn" class="hidden bg-gray-800 hover:bg-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 text-white font-bold w-14 h-14 rounded-full text-xl shadow-lg flex items-center justify-center transition-all active:scale-95">
                        <i class="fas fa-stop"></i>
                    </button>
                    
                    <!-- Post-Recording Controls -->
                    <div id="post-recording-actions" class="hidden w-full flex-col items-center justify-center space-y-2 mt-1">
                        <audio id="audio-player" controls class="w-full max-w-xs h-8"></audio>
                        <div class="flex gap-2 w-full max-w-xs">
                            <!-- Download button -->
                            <button id="download-btn"
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg text-xs shadow-md transition-all flex items-center justify-center gap-2">
                                 <i class="fas fa-download"></i> Save MP3
                            </button>
                            
                            <!-- Upload/Share button (Example Link) -->
                            <a id="upload-link"
                               href="#" 
                               onclick="alert('Please configure the upload link in the code!'); return false;"
                               class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-3 rounded-lg text-xs shadow-md transition-all flex items-center justify-center gap-2">
                                 <i class="fas fa-cloud-upload-alt"></i> Upload
                            </a>
                        </div>
                    </div>
                </div>
                 <div id="recording-status" class="hidden items-center justify-center text-red-500 font-semibold text-xs animate-pulse">
                      <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
                      Recording in progress...
                 </div>
            </header>
            
            <main class="flex-grow flex flex-col overflow-y-auto scroll-container min-h-0 space-y-3 pt-2 px-1">
                 <!-- Sentence Starters -->
                <div id="starters-container" class="hidden text-left bg-white dark:bg-gray-700/30 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                    <h3 class="text-xs font-bold uppercase text-gray-400 mb-2 tracking-wider">Sentence Starters</h3>
                    <div id="starters-list" class="flex flex-wrap gap-2">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Word Bank -->
                <div id="word-bank-container" class="hidden text-left bg-white dark:bg-gray-700/30 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                    <h3 class="text-xs font-bold uppercase text-gray-400 mb-2 tracking-wider">Useful Vocabulary</h3>
                    <div id="word-bank-list" class="flex flex-wrap gap-2">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Sample Answers Display -->
                <div id="samples-container" class="hidden text-left">
                    <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 p-3 rounded-xl">
                        <h3 class="text-xs font-bold uppercase text-amber-600 dark:text-amber-500 mb-2 tracking-wider flex items-center">
                            <i class="fas fa-star mr-1"></i> Sample Responses
                        </h3>
                        <ul id="samples-list" class="space-y-2 list-none text-sm text-gray-700 dark:text-gray-300">
                        </ul>
                    </div>
                </div>
            </main>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center">
            <div id="certificate-to-download" class="w-full bg-slate-50 dark:bg-slate-700 p-6 sm:p-10 rounded-xl border-4 border-double border-yellow-400 dark:border-yellow-500 text-center shadow-inner relative overflow-hidden">
                <!-- Watermark -->
                <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none">
                    <i class="fas fa-award text-9xl"></i>
                </div>
                
                <div class="relative z-10">
                    <i class="fas fa-crown text-5xl text-yellow-500 mb-4 drop-shadow-sm"></i>
                    <h1 class="text-2xl sm:text-3xl font-serif font-bold text-gray-800 dark:text-white mb-2">Certificate of Excellence</h1>
                    <div class="h-1 w-20 bg-yellow-500 mx-auto mb-4"></div>
                    <p class="text-sm sm:text-base text-gray-600 dark:text-gray-300 uppercase tracking-widest mb-4">QA13 Presented To</p>
                    
                    <p id="certificate-name" class="text-3xl sm:text-5xl font-bold my-4 text-indigo-700 dark:text-indigo-300 font-serif italic"></p>
                    
                    <p class="text-base text-gray-600 dark:text-gray-300">For successfully completing the QA13 speaking practice.</p>
                    <div class="mt-8 flex justify-center items-center gap-2 text-xs text-gray-400">
                        <span>Date: <span id="certificate-date"></span></span>
                        <span>•</span>
                        <span>Verified</span>
                    </div>
                </div>
            </div>
            <button id="download-certificate-btn" class="mt-8 w-full max-w-xs bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-md transition-all active:scale-95 flex items-center justify-center">
                <i class="fas fa-file-image mr-2"></i>Download Image
            </button>
             <button id="back-to-main-menu-btn" class="mt-4 text-sm text-gray-500 hover:text-indigo-500 transition-colors">Start New Session</button>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 text-center max-w-sm w-full border border-gray-200 dark:border-gray-700">
            <div class="mb-4 text-yellow-500 text-4xl">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h3 id="modal-title" class="text-xl font-bold mb-2 dark:text-white">End Session?</h3>
            <p id="modal-message" class="text-gray-600 dark:text-gray-400 mb-6 text-sm">Returning to the topic list will clear your current progress.</p>
            <div class="flex justify-center gap-3">
                <button id="modal-cancel-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200 transition-colors">Cancel</button>
                <button id="modal-confirm-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">End Session</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // ==========================================
        //  QA13 DATA SECTION
        // ==========================================
        const practiceData = {
            "Polite Requests": [
                {
                    question: "Scenario: You are in a quiet library and someone nearby is talking loudly on their phone. How would you politely ask them to be quiet?",
                    starters: ["Excuse me, I'm sorry to bother you, but...", "I was wondering if you would mind...", "Pardon me, but would it be possible to...", "I know you may not realize, but..."],
                    wordBank: ["a little quieter", "take your call outside", "this is a quiet area", "I'm trying to study", "would you mind", "I'd appreciate it"],
                    samples: [
                        "Excuse me, I'm sorry to bother you, but I'm trying to study and your conversation is a bit loud. Would you mind taking your call outside?",
                        "Pardon me, I was wondering if you would mind being a little quieter? This is a designated quiet area of the library.",
                        "I know you may not realize it, but your voice is carrying. I'd really appreciate it if you could lower your voice or step into the hallway."
                    ]
                },
                {
                    question: "Scenario: You are on a crowded bus and an elderly person gets on. There are no empty seats. How would you ask a young person sitting down to give up their seat?",
                    starters: ["Excuse me, would you mind...", "Pardon me, I see you're sitting, but...", "Would it be possible for...", "This person seems to need..."],
                    wordBank: ["offer your seat", "needs this seat more", "give up your seat", "let this person sit", "elderly person", "looks tired"],
                    samples: [
                        "Excuse me, I see this elderly person doesn't have a seat. Would you mind letting them sit here? I'm sure they would be very grateful.",
                        "Pardon me, but would you consider offering your seat to this older gentleman? It looks like he is having trouble standing.",
                        "Excuse me, would it be possible for this person to have your seat? The bus is very crowded and it's difficult for them to stand."
                    ]
                }
            ],
            "Giving Directions": [
                {
                    question: "Scenario: A tourist stops you on the street and asks for directions to the nearest subway station. Explain how to get there.",
                    starters: ["Of course, the subway station is not far.", "You'll want to go down this street and...", "Keep going straight for about...", "When you see the..., turn..."],
                    wordBank: ["go straight", "turn left", "turn right", "at the traffic lights", "on the corner", "it's about a 5-minute walk", "you can't miss it", "across from"],
                    samples: [
                        "Sure. You just need to go straight down this street for about two blocks. When you see a big bank on the corner, turn right, and the station entrance will be right there.",
                        "The easiest way is to walk straight ahead until you get to the next big intersection with traffic lights. Turn left there, and you will see the subway sign about 50 meters ahead.",
                        "It's very close. Just keep walking in this direction. You will pass a post office on your left. The station is right across the street from the post office. You can't miss it."
                    ]
                },
                {
                    question: "Scenario: A new classmate wants to know where the school cafeteria is. Give them clear directions from your current classroom.",
                    starters: ["Sure, it's easy to find.", "From this classroom, you just need to...", "Go out this door and turn...", "When you get to the main hall..."],
                    wordBank: ["go down the stairs", "at the end of the hallway", "on the first floor", "it's a big open room", "next to the gym", "follow the signs", "main building"],
                    samples: [
                        "From our classroom, just turn right and go all the way to the end of this hallway. Then, go down the main staircase to the first floor. The cafeteria is the big noisy room on your left.",
                        "It's on the ground floor. Go out of this room, turn left, and walk until you see the library. The cafeteria is right next to the library.",
                        "You just need to go down these stairs. When you get to the bottom, walk straight through the main hall, and the cafeteria is the last door on the right."
                    ]
                }
            ],
            "Making an Apology": [
                {
                    question: "Scenario: You are 15 minutes late to meet your friend at a cafe. Apologize and explain why you are late.",
                    starters: ["I am so sorry I'm late.", "I really apologize for keeping you waiting.", "There was some unexpected...", "I completely lost track of time because..."],
                    wordBank: ["the traffic was terrible", "my bus was delayed", "I missed my alarm", "I hope you weren't waiting long", "it won't happen again", "I feel really bad"],
                    samples: [
                        "I am so sorry I'm late. The traffic on my way here was much worse than I expected. Have you been waiting long?",
                        "I really apologize for being late. I was finishing up some homework and completely lost track of time. It's totally my fault.",
                        "I'm so sorry for keeping you waiting. My subway line had a temporary delay, and we were stopped for about 10 minutes. I should have messaged you sooner."
                    ]
                },
                {
                    question: "Scenario: You accidentally spilled a drink on a stranger's bag in a crowded place. Apologize and offer to help.",
                    starters: ["Oh my gosh, I am so sorry!", "I'm so terribly sorry, that was completely my fault.", "Please let me help you clean that up.", "Is there anything I can do?"],
                    wordBank: ["so clumsy of me", "completely my fault", "let me get you some napkins", "can I buy you a new one?", "I wasn't paying attention", "are you okay?"],
                    samples: [
                        "Oh, I am so sorry! That was so clumsy of me. Here, let me get you some napkins to clean that up. Is there anything inside your bag that might be damaged?",
                        "I am so terribly sorry, I wasn't looking where I was going. Please, let me help. Is it okay? I feel awful about this.",
                        "That was completely my fault, I apologize. Can I buy you a coffee to make up for it? I would also be happy to pay for cleaning if the bag is stained."
                    ]
                }
            ],
            "Expressing an Opinion": [
                {
                    question: "Scenario: Your friends are debating whether online classes are better than in-person classes. What is your opinion and why?",
                    starters: ["That's an interesting debate. In my opinion...", "I can see both sides, but I personally think...", "From my perspective, ... is better because...", "I have to disagree, I believe that..."],
                    wordBank: ["flexibility", "self-discipline", "interaction", "social aspect", "more engaging", "convenient", "focus", "pros and cons"],
                    samples: [
                        "In my opinion, in-person classes are much better because I find it easier to focus and ask questions when the teacher is right there in the room with you.",
                        "I can see both sides. Online classes offer more flexibility with your schedule, but you miss out on the social aspect of being with your classmates.",
                        "From my perspective, it really depends on the subject. For a lecture-based class, online can be very efficient. But for a lab or a discussion-based class, in-person is necessary."
                    ]
                },
                {
                    question: "Scenario: Your teacher asks the class if they think schools should give less homework. What would you say?",
                    starters: ["I believe schools should give less homework because...", "On one hand, homework is important for practice, but...", "In my view, the amount of homework is...", "I think the focus should be on the quality, not the quantity..."],
                    wordBank: ["too much pressure", "not enough time", "mental health", "quality over quantity", "busy work", "reinforce learning", "time for hobbies", "balanced"],
                    samples: [
                        "I believe schools should give less homework because students already spend a long day at school. They need time in the evening to rest, pursue hobbies, and spend time with family.",
                        "In my view, the focus should be on the quality of the homework, not the quantity. One meaningful assignment is better than three hours of repetitive busy work.",
                        "On one hand, some homework is necessary to reinforce what we learn in class. But I think the current amount is too much and causes a lot of stress for students."
                    ]
                }
            ]
        };
        // ==========================================
        //  END OF QA13 DATA
        // ==========================================

        // --- DOM Elements ---
        const ui = {
            welcomeScreen: document.getElementById('welcome-screen'),
            practiceScreen: document.getElementById('practice-screen'),
            nameEntryContainer: document.getElementById('name-entry-container'),
            nameInput: document.getElementById('name-input'),
            startWithNameBtn: document.getElementById('start-with-name-btn'),
            topicSelectionContainer: document.getElementById('topic-selection-container'),
            userNameDisplay: document.getElementById('user-name-display'),
            topicSelection: document.getElementById('topic-selection'),
            nextBtn: document.getElementById('next-btn'),
            backToTopicsBtn: document.getElementById('back-to-topics-btn'),
            samplesBtn: document.getElementById('samples-btn'),
            timerDisplay: document.getElementById('timer-display'),
            timerProgress: document.getElementById('timer-progress'),
            phaseIndicator: document.getElementById('phase-indicator'),
            questionText: document.getElementById('question-text'),
            samplesContainer: document.getElementById('samples-container'),
            samplesList: document.getElementById('samples-list'),
            startersContainer: document.getElementById('starters-container'),
            startersList: document.getElementById('starters-list'),
            wordBankContainer: document.getElementById('word-bank-container'),
            wordBankList: document.getElementById('word-bank-list'),
            errorMessagebox: document.getElementById('error-message-box'),
            recordBtn: document.getElementById('record-btn'),
            stopRecordBtn: document.getElementById('stop-record-btn'),
            audioPlayer: document.getElementById('audio-player'),
            recordingStatus: document.getElementById('recording-status'),
            postRecordingActions: document.getElementById('post-recording-actions'),
            downloadBtn: document.getElementById('download-btn'),
            certificateScreen: document.getElementById('certificate-screen'),
            downloadCertificateBtn: document.getElementById('download-certificate-btn'),
            backToMainMenuBtn: document.getElementById('back-to-main-menu-btn'),
            modal: document.getElementById('confirmation-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
            pauseResumeBtn: document.getElementById('pause-resume-btn')
        };


        // --- State Variables ---
        let userName = '';
        let currentQuestionIndex = 0;
        let masterQuestionList = [];
        let currentQuestions = []; 
        let timerInterval;
        let isTimerPaused = false;
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob = null;
        let completedTopics = {};

        const FULL_DASH_ARRAY = 283;
        const DEFAULT_RESPONSE_TIME = 60; // Default time since it wasn't specified in new data

        // --- Text-to-Speech (Slowed down to 85%) ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;
        let ttsInitialized = false;

        function initializeTTS() {
            return new Promise((resolve) => {
                if (!synth) {
                    ttsInitialized = true;
                    return resolve();
                }

                const setBestVoice = () => {
                    const voices = synth.getVoices();
                    if (voices.length === 0) return;
                    
                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    const bestVoice = englishVoices.find(v => v.name.includes("Google") || v.name.includes("Microsoft") || v.name.includes("Natural"));
                    
                    preferredVoice = bestVoice || englishVoices[0] || voices[0];
                    ttsInitialized = true;
                    resolve();
                };

                if (synth.getVoices().length > 0) {
                    setBestVoice();
                } else {
                    synth.onvoiceschanged = setBestVoice;
                }
            });
        }

        function speak(text) {
            if (!ttsInitialized || !synth || !text) return;

            try {
                if (synth.speaking) synth.cancel();
                
                setTimeout(() => {
                    const utterThis = new SpeechSynthesisUtterance(text);
                    if (preferredVoice) utterThis.voice = preferredVoice;
                    utterThis.pitch = 1;
                    utterThis.rate = 0.85; // Slow down speech for secondary students
                    synth.speak(utterThis);
                }, 50); 
            } catch (e) {
                console.error("TTS Error:", e);
            }
        }

        // --- Local Storage (Updated for QA13) ---
        function loadProgress() {
            const savedCompletedTopics = localStorage.getItem('QA13_CompletedTopics');
            if (savedCompletedTopics) {
                try {
                    completedTopics = JSON.parse(savedCompletedTopics) || {};
                } catch (e) { completedTopics = {}; }
            }
            const savedName = localStorage.getItem('QA13_UserName');
            if (savedName) {
                 userName = savedName;
                 ui.nameInput.value = userName;
            }
        }

        function saveProgress() {
            localStorage.setItem('QA13_CompletedTopics', JSON.stringify(completedTopics));
            if(userName) localStorage.setItem('QA13_UserName', userName);
        }

        // --- UI Initialization & Data Setup ---
        function initializeTopics() {
            ui.topicSelection.innerHTML = '';
            for (const topic in practiceData) {
                const button = document.createElement('button');
                
                let checkmark = '';
                let bgClass = "bg-white dark:bg-gray-700 hover:bg-indigo-50 dark:hover:bg-indigo-900/40 border border-gray-200 dark:border-gray-600";
                
                if (completedTopics && completedTopics[topic]) {
                    checkmark = `<i class="fas fa-check-circle ml-auto text-emerald-500 text-xl"></i>`;
                    bgClass = "bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800";
                }

                button.className = `w-full text-left p-4 rounded-xl shadow-sm transition-all transform hover:scale-[1.02] flex items-center ${bgClass}`;
                button.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center mr-3 text-indigo-600 dark:text-indigo-400">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div>
                            <span class="block font-bold text-gray-800 dark:text-white">${topic}</span>
                        </div>
                    </div>
                    ${checkmark}
                `;
                
                button.dataset.topic = topic;
                button.addEventListener('click', () => startPractice(topic));
                ui.topicSelection.appendChild(button);
            }
        }
        
        function createMasterList() {
            masterQuestionList = [];
            for (const topic in practiceData) {
                practiceData[topic].forEach(question => {
                    masterQuestionList.push({ ...question, topicName: topic });
                });
            }
        }

        // --- Core App Logic ---
        function startPractice(topic) {
            const startIndex = masterQuestionList.findIndex(q => q.topicName === topic);
            currentQuestionIndex = (startIndex !== -1) ? startIndex : 0;
            currentQuestions = masterQuestionList;
            
            ui.welcomeScreen.classList.add('hidden');
            ui.practiceScreen.classList.remove('hidden');
            ui.certificateScreen.classList.add('hidden');
            ui.nextBtn.classList.remove('hidden');
            ui.samplesBtn.classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            // Track completion of previous topic
            if (currentQuestionIndex > 0) {
                const prevQuestion = currentQuestions[currentQuestionIndex - 1];
                const currentQuestion = currentQuestions[currentQuestionIndex];
                if (currentQuestion && prevQuestion.topicName !== currentQuestion.topicName) {
                    if (!completedTopics[prevQuestion.topicName]) {
                        completedTopics[prevQuestion.topicName] = true;
                        saveProgress();
                    }
                }
            }

            // End of all questions
            if (currentQuestionIndex >= currentQuestions.length) {
                if (currentQuestions.length > 0) {
                    const lastTopicName = currentQuestions[currentQuestions.length - 1].topicName;
                      if (!completedTopics[lastTopicName]) {
                        completedTopics[lastTopicName] = true;
                        saveProgress();
                    }
                }
                showCertificate();
                return;
            }

            ui.nextBtn.disabled = true;

            const item = currentQuestions[currentQuestionIndex];
            resetUIForNewQuestion();
            
            // Format question text
            let fullQuestion = (item.intro ? item.intro + " " : "") + item.question;
            ui.questionText.textContent = fullQuestion;
            ui.questionText.classList.add('fade-in');
            setTimeout(() => ui.questionText.classList.remove('fade-in'), 500);

            speak(fullQuestion);
            
            // Populate Starters
            if (item.starters && item.starters.length > 0) {
                ui.startersList.innerHTML = '';
                item.starters.forEach(starter => {
                    const span = document.createElement('span');
                    span.className = 'bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-1.5 rounded-lg dark:bg-indigo-900 dark:text-indigo-300 border border-indigo-200 dark:border-indigo-800';
                    span.textContent = starter;
                    ui.startersList.appendChild(span);
                });
                ui.startersContainer.classList.remove('hidden');
            }

            // Populate Word Bank
            if (item.wordBank && item.wordBank.length > 0) {
                ui.wordBankList.innerHTML = '';
                item.wordBank.forEach(word => {
                    const span = document.createElement('span');
                    span.className = 'bg-emerald-100 text-emerald-800 text-xs font-medium px-2.5 py-1.5 rounded-lg dark:bg-emerald-900 dark:text-emerald-300 border border-emerald-200 dark:border-emerald-800';
                    span.textContent = word;
                    ui.wordBankList.appendChild(span);
                });
                ui.wordBankContainer.classList.remove('hidden');
            }

            ui.phaseIndicator.textContent = `${item.topicName} • ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            
            const responseTime = item.timer || DEFAULT_RESPONSE_TIME;
            startTimer(responseTime, () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                }
                ui.recordBtn.disabled = true;
                ui.recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                ui.pauseResumeBtn.classList.add('hidden');
                ui.nextBtn.disabled = false;
                
                // Audio cue that time is up (optional)
                const ding = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'); // Placeholder
            });
        }
        
        function showCertificate() {
            ui.practiceScreen.classList.add('hidden');
            ui.welcomeScreen.classList.add('hidden');
            ui.certificateScreen.classList.remove('hidden');
            document.getElementById('certificate-name').textContent = userName;
            document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
            speak(`Congratulations ${userName}. You have completed all the QA13 speaking topics!`);
        }
        
        function showErrorMessage(message) {
            ui.errorMessagebox.textContent = message;
            ui.errorMessagebox.classList.remove('hidden');
            setTimeout(() => {
                ui.errorMessagebox.classList.add('hidden');
            }, 5000);
        }

        // --- Recording & Transcription Logic ---
        async function startRecording() {
            if (!window.MediaRecorder) {
                showErrorMessage("Audio recording is not supported on this browser.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const isMobileEdge = /Edg\/\d+.*Android/.test(navigator.userAgent);
                let options = {};
                if (!isMobileEdge) {
                    const mimeTypes = ['audio/webm;codecs=opus', 'audio/ogg;codecs=opus', 'audio/webm', 'audio/ogg'];
                    const supportedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
                    if (supportedType) options.mimeType = supportedType;
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.start();

                ui.recordBtn.classList.add('hidden');
                ui.stopRecordBtn.classList.remove('hidden');
                ui.recordingStatus.classList.remove('hidden');

                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    recordedBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedBlob);
                    ui.audioPlayer.src = audioUrl;
                    ui.postRecordingActions.classList.remove('hidden');
                    ui.recordingStatus.classList.add('hidden');
                    ui.stopRecordBtn.classList.add('hidden');
                    ui.recordBtn.classList.add('hidden');
                    ui.nextBtn.disabled = false;
                });
            } catch (err) {
                console.error("Error starting recording:", err);
                showErrorMessage("Microphone access denied. Please check your browser settings.");
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
        }
        
        // --- Confirmation Modal ---
        function showConfirmationModal(title, message, onConfirm) {
            ui.modalTitle.textContent = title;
            ui.modalMessage.textContent = message;
            ui.modal.classList.remove('hidden');

            const confirmHandler = () => {
                onConfirm();
                hide();
            };

            const hide = () => {
                ui.modal.classList.add('hidden');
                ui.modalConfirmBtn.removeEventListener('click', confirmHandler);
                ui.modalCancelBtn.removeEventListener('click', hide);
            };

            ui.modalConfirmBtn.addEventListener('click', confirmHandler);
            ui.modalCancelBtn.addEventListener('click', hide);
        }


        // --- Timer Functions ---
        function startTimer(duration, onEndCallback) {
            let timeLeft = duration;
            clearInterval(timerInterval);
            updateTimerDisplay(timeLeft, duration);

            timerInterval = setInterval(() => {
                if (!isTimerPaused) {
                    timeLeft--;
                    updateTimerDisplay(timeLeft, duration);
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        if(onEndCallback) onEndCallback();
                    }
                }
            }, 1000);
        }

        function togglePauseTimer() {
            isTimerPaused = !isTimerPaused;
            if (isTimerPaused) {
                ui.pauseResumeBtn.innerHTML = '<i class="fas fa-play"></i>';
                ui.pauseResumeBtn.classList.add('text-green-600');
            } else {
                ui.pauseResumeBtn.innerHTML = '<i class="fas fa-pause"></i>';
                ui.pauseResumeBtn.classList.remove('text-green-600');
            }
        }

        function updateTimerDisplay(timeLeft, totalDuration) {
            const minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            if (seconds < 10) seconds = `0${seconds}`;
            ui.timerDisplay.textContent = `${minutes}:${seconds}`;
            
            const fraction = timeLeft / totalDuration;
            const offset = fraction * FULL_DASH_ARRAY;
            ui.timerProgress.style.strokeDashoffset = FULL_DASH_ARRAY - offset;
            
            // Change color based on time left
            if (timeLeft <= 10) {
                ui.timerProgress.classList.add('text-red-500');
                ui.timerProgress.classList.remove('text-indigo-500');
            } else {
                ui.timerProgress.classList.add('text-indigo-500');
                ui.timerProgress.classList.remove('text-red-500');
            }
        }

        // --- UI Helper Functions ---
        function resetUIForNewQuestion() {
            ui.samplesContainer.classList.add('hidden');
            ui.startersContainer.classList.add('hidden');
            ui.wordBankContainer.classList.add('hidden');
            ui.errorMessagebox.classList.add('hidden');
            ui.recordBtn.disabled = false;
            ui.recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            resetRecordingUI();
            
            isTimerPaused = false;
            ui.pauseResumeBtn.innerHTML = '<i class="fas fa-pause"></i>';
            ui.pauseResumeBtn.classList.remove('hidden', 'text-green-600');
            ui.timerProgress.classList.add('text-indigo-500');
        }

        function resetRecordingUI() {
            ui.recordBtn.classList.remove('hidden');
            ui.stopRecordBtn.classList.add('hidden');
            ui.recordingStatus.classList.add('hidden');
            ui.postRecordingActions.classList.add('hidden');
            ui.audioPlayer.src = '';
            audioChunks = [];
            recordedBlob = null;
        }

        // --- Event Listeners ---
        ui.startWithNameBtn.addEventListener('click', () => {
            userName = ui.nameInput.value.trim();
            if (userName) {
                saveProgress();
                ui.nameEntryContainer.classList.add('hidden');
                ui.userNameDisplay.textContent = userName;
                ui.topicSelectionContainer.classList.remove('hidden');
                initializeTopics();
            } else {
                ui.nameInput.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => ui.nameInput.classList.remove('ring-2', 'ring-red-500'), 1000);
            }
        });

        ui.recordBtn.addEventListener('click', startRecording);
        ui.stopRecordBtn.addEventListener('click', stopRecording);
        ui.pauseResumeBtn.addEventListener('click', togglePauseTimer);
        
        ui.downloadCertificateBtn.addEventListener('click', () => {
          const certificateNode = document.getElementById('certificate-to-download');
          // Simple detection for mobile devices where auto-download might be blocked
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          
          html2canvas(certificateNode, { scale: 2 }).then(canvas => {
            canvas.toBlob(blob => {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `Certificate_${userName.replace(/\s+/g, '_')}.png`;
              
              if (isMobile) {
                  // Open in new tab for mobile so they can long-press save
                  const newWindow = window.open(url, '_blank');
                  if (!newWindow) alert('Please allow popups to download the certificate.');
              } else {
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
              }
              setTimeout(() => URL.revokeObjectURL(url), 100);
            });
          });
        });

        ui.backToMainMenuBtn.addEventListener('click', () => {
            ui.certificateScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            ui.nameEntryContainer.classList.add('hidden');
            ui.topicSelectionContainer.classList.remove('hidden');
            initializeTopics();
        });

        ui.downloadBtn.addEventListener('click', () => {
            if (recordedBlob) {
                const topicName = currentQuestions[currentQuestionIndex].topicName.replace(/\s+/g, '_');
                const sanitizedUserName = userName.replace(/\s+/g, '_');
                const fileNameAudio = `${sanitizedUserName}_${topicName}_Q${currentQuestionIndex + 1}.mp3`; // Naming it MP3 for compatibility though it is webm
                const blobUrl = URL.createObjectURL(recordedBlob);
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                a.download = fileNameAudio;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Visual feedback
                const btnContent = ui.downloadBtn.innerHTML;
                ui.downloadBtn.innerHTML = `<i class="fas fa-check"></i> Saved`;
                ui.downloadBtn.classList.replace('bg-blue-600', 'bg-green-600');
                setTimeout(() => {
                    ui.downloadBtn.innerHTML = btnContent;
                    ui.downloadBtn.classList.replace('bg-green-600', 'bg-blue-600');
                    URL.revokeObjectURL(blobUrl);
                }, 2000);
            }
        });

        ui.nextBtn.addEventListener('click', () => {
            ui.nextBtn.disabled = true;
            currentQuestionIndex++;
            showQuestion();
        });

        ui.backToTopicsBtn.addEventListener('click', () => {
            showConfirmationModal(
                'Return to Topics?',
                'Progress on the current topic will be lost.',
                () => {
                    ui.practiceScreen.classList.add('hidden');
                    ui.welcomeScreen.classList.remove('hidden');
                    clearInterval(timerInterval);
                    if (synth && synth.speaking) synth.cancel();
                    if (mediaRecorder && mediaRecorder.state === 'recording') stopRecording();
                    initializeTopics();
                }
            );
        });

        ui.samplesBtn.addEventListener('click', () => {
            if (!ui.samplesContainer.classList.contains('hidden')) {
                ui.samplesContainer.classList.add('hidden');
                return;
            }

            const currentTopicName = masterQuestionList[currentQuestionIndex].topicName;
            const item = currentQuestions[currentQuestionIndex];

            ui.samplesList.innerHTML = ''; 
            if (item.samples && item.samples.length > 0) {
                item.samples.forEach(sample => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-quote-left text-amber-500 mr-2 text-xs"></i>${sample}`;
                    li.className = 'mb-2 pb-2 border-b border-gray-100 dark:border-gray-700 last:border-0 last:mb-0 last:pb-0';
                    ui.samplesList.appendChild(li);
                });
            } else {
                 ui.samplesList.innerHTML = '<li>No sample answers available for this question.</li>';
            }
            ui.samplesContainer.classList.remove('hidden');
        });
        
        // --- Initial Load ---
        async function main() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder) {
                ui.recordBtn.disabled = true;
                ui.recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            await initializeTTS().catch(err => console.error(err));
            
            createMasterList();
            loadProgress();
            initializeTopics();
        }
        
        main();
    });
    </script>
</body>
</html>
