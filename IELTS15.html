<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>IELTS Speaking Master Class</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: #FDFBF7;
            color: #1a202c;
        }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(100, 116, 139, 0.2); border-radius: 4px; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background: rgba(100, 116, 139, 0.4); }

        .text-green-heading { color: #15803d; }
        .bg-cream-card { background-color: #ffffff; }
        
        .interactive-chip {
            cursor: pointer;
            transition: all 0.15s;
            background-color: white; 
            user-select: none;
        }
        .interactive-chip:hover {
            transform: translateY(-1px);
            background-color: #f8fafc; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .interactive-chip:active { transform: translateY(0); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
    </style>
</head>
<body class="flex items-center justify-center p-2 h-screen w-screen overflow-hidden bg-gray-50">
    
    <div id="app-container" class="w-full max-w-[1920px] h-full flex flex-col bg-white/80 rounded-2xl shadow-xl border border-gray-200 overflow-hidden backdrop-blur-sm relative">
        
        <!-- Confetti Container -->
        <div id="confetti-container" class="absolute inset-0 pointer-events-none overflow-hidden z-50 hidden"></div>

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="absolute inset-0 z-50 bg-cream-card flex flex-col justify-center items-center p-8 overflow-y-auto">
            <div id="name-entry-container" class="max-w-xl w-full text-center">
                <h1 class="text-6xl font-bold text-green-heading mb-4">IELTS Mastery</h1>
                <p class="text-lg text-gray-500 mb-10">Vocabulary • Grammar • Fluency</p>
                <input type="text" id="name-input" placeholder="Enter Your Name" class="w-full px-6 py-4 border-2 border-gray-200 rounded-2xl mb-8 text-center text-3xl outline-none focus:border-blue-500 focus:ring-0 transition-colors bg-white shadow-sm">
                <button id="start-with-name-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-2xl text-2xl shadow-xl transition-transform transform hover:scale-[1.01]">Start Practice</button>
            </div>
            
            <div id="topic-selection-container" class="hidden w-full max-w-[95%] flex flex-col h-full">
                 <div class="flex justify-between items-end mb-4 flex-shrink-0 pt-2">
                     <div>
                        <h1 class="text-4xl font-bold text-green-heading">Hello, <span id="user-name-display"></span>!</h1>
                        <p class="text-gray-500 mt-1">Select a topic to begin.</p>
                     </div>
                     <div class="flex items-center gap-3">
                         <button id="random-topic-btn" class="text-base bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-2 px-4 rounded-xl transition-colors shadow-sm flex items-center">
                             <i class="fas fa-random mr-2"></i> Surprise Me
                         </button>
                         <div class="text-xl font-bold text-blue-600" id="progress-text">0/10</div>
                     </div>
                 </div>
                 <div class="w-full bg-gray-200 rounded-full h-3 mb-6 flex-shrink-0">
                    <div id="overall-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                 </div>
                 <div id="topic-selection" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 overflow-y-auto pb-6 custom-scroll pr-2"></div>
            </div>
        </div>

        <!-- Practice Screen -->
        <div id="practice-screen" class="hidden flex flex-col h-full relative">
            
            <!-- HEADER (Compact) -->
            <header class="flex-shrink-0 bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between shadow-sm z-20 h-14">
                <div class="flex items-center gap-3 w-[200px]">
                    <button id="back-to-topics-btn" class="text-sm bg-gray-50 hover:bg-gray-100 text-gray-700 font-bold py-1.5 px-3 rounded-lg border border-gray-200 flex items-center transition-colors">
                        <i class="fas fa-home mr-2 text-green-600"></i>Home
                    </button>
                    <div id="phase-indicator" class="text-xs font-bold text-green-700 uppercase tracking-widest bg-green-50 px-2 py-1 rounded border border-green-100 whitespace-nowrap">PART 1</div>
                </div>

                <div class="flex items-center justify-center gap-4 flex-grow">
                    <button id="prev-btn" class="w-8 h-8 bg-white hover:bg-gray-50 text-gray-500 rounded-full border border-gray-200 shadow-sm flex items-center justify-center disabled:opacity-30 transition-transform active:scale-95">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <div class="flex items-center bg-gray-50 rounded-full px-3 py-1 border border-gray-200 shadow-inner gap-3">
                        <div class="flex flex-col items-center justify-center min-w-[50px]">
                            <div class="text-sm font-bold text-gray-700 leading-none" id="timer-display">0:00</div>
                            <div class="flex gap-1 mt-0.5">
                                <button id="pause-resume-btn" class="text-[10px] text-gray-500 hover:text-blue-600"><i class="fas fa-pause"></i></button>
                                <button id="reset-timer-btn" class="text-[10px] text-gray-500 hover:text-red-600"><i class="fas fa-redo"></i></button>
                            </div>
                        </div>
                        <button id="prep-timer-btn" class="hidden text-[10px] font-bold bg-yellow-100 text-yellow-700 px-2 py-1 rounded hover:bg-yellow-200 border border-yellow-200">1m PREP</button>
                        
                        <div class="h-6 w-[1px] bg-gray-300 mx-1"></div>

                        <div class="relative w-8 h-8 flex items-center justify-center">
                            <button id="record-btn" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full shadow flex items-center justify-center hover:scale-105 transition-transform"><i class="fas fa-microphone text-xs"></i></button>
                            <button id="stop-record-btn" class="hidden bg-gray-800 text-white w-8 h-8 rounded-full shadow flex items-center justify-center animate-pulse"><i class="fas fa-stop text-xs"></i></button>
                        </div>
                        
                        <div id="post-recording-actions" class="hidden flex items-center gap-2 animate-fadeIn">
                            <audio id="audio-player" controls class="h-6 w-24"></audio>
                            <button id="download-btn" class="bg-blue-600 text-white w-7 h-7 rounded-full text-xs flex items-center justify-center shadow hover:bg-blue-700 transition-colors">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>

                    <button id="next-btn" class="w-8 h-8 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-sm flex items-center justify-center disabled:opacity-50 transition-transform active:scale-95"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="w-[200px] flex justify-end">
                    <button id="samples-btn" class="text-sm bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1.5 px-3 rounded-lg shadow transition-colors ring-2 ring-yellow-100 hover:ring-yellow-200 flex items-center"><i class="fas fa-lightbulb mr-2"></i>Models</button>
                </div>
            </header>
            
            <!-- MAIN CONTENT AREA -->
            <main class="flex-grow flex flex-col min-h-0 overflow-hidden bg-[#FDFBF7] p-3">
                
                <!-- Question Banner (Compact) -->
                <div id="question-container" class="bg-white px-6 py-2 rounded-xl border border-gray-200 text-center shadow-sm flex-shrink-0 z-10 mb-2 min-h-[60px] flex items-center justify-center">
                    <h2 id="question-text" class="text-xl md:text-2xl font-bold leading-tight text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" title="Click to hear question"></h2>
                </div>

                <!-- Three Column Layout -->
                <div class="flex-grow flex flex-row min-h-0 gap-3">
                    
                    <!-- LEFT COLUMN: Fluency & Signposts -->
                    <div class="w-[28%] flex flex-col gap-3 overflow-y-auto custom-scroll pr-1">
                         <!-- Fillers -->
                         <div id="fillers-container" class="bg-gray-50 border border-gray-200 rounded-xl p-3 shadow-sm">
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center"><i class="fas fa-comments mr-1.5"></i> Fluency Fillers</span>
                            <div id="fillers-list" class="flex flex-wrap gap-1.5"></div>
                        </div>

                        <!-- Sentence Starters -->
                        <div id="starters-container" class="bg-blue-50/50 border border-blue-100 rounded-xl p-3 shadow-sm">
                            <span class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-2 block flex items-center"><i class="fas fa-play mr-1.5"></i> Sentence Starters</span>
                            <div id="starters-list" class="flex flex-wrap gap-1.5 content-start"></div>
                        </div>

                         <!-- Signposts / Transitions -->
                         <div class="bg-indigo-50/50 border border-indigo-100 rounded-xl p-3 shadow-sm flex-grow">
                            <span class="text-xs font-bold text-indigo-600 uppercase tracking-wider mb-2 flex items-center"><i class="fas fa-route mr-1.5"></i> Signposts & Transitions</span>
                            <div id="signposts-list" class="flex flex-wrap gap-1.5"></div>
                        </div>
                    </div>

                    <!-- CENTER COLUMN: Response Framework & Idioms -->
                    <div class="w-[34%] flex flex-col gap-3 overflow-y-auto custom-scroll pr-1">
                        <div class="bg-teal-50/40 border border-teal-100 rounded-xl p-4 shadow-sm h-full flex flex-col">
                            
                            <!-- Grammar Focus -->
                            <div class="mb-3 bg-white/60 p-3 rounded-lg border border-teal-100">
                                <span class="text-xs font-semibold text-teal-600 block mb-1 uppercase">Target Grammar</span>
                                <div id="grammar-focus-text" class="text-teal-900 font-bold text-lg leading-tight mb-1"></div>
                                <div id="grammar-example-text" class="text-teal-700 text-sm italic bg-teal-50/50 p-1.5 rounded border border-teal-100/50 cursor-pointer hover:bg-teal-50" title="Click to hear example"></div>
                            </div>

                            <!-- Template Steps -->
                            <div class="flex-shrink-0">
                                <span class="text-xs font-semibold text-teal-600 block mb-2 uppercase">Structure Template</span>
                                <div id="template-text" class="text-teal-900 text-base space-y-2"></div>
                            </div>

                            <!-- Idioms (Vertical List now below structure with less gap) -->
                            <div class="mt-4 pt-3 border-t border-teal-200/60 flex-grow">
                                <span class="text-xs font-bold text-purple-600 uppercase tracking-wide block mb-2">Idioms of the Day:</span>
                                <div id="idioms-list" class="flex flex-col gap-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: Vocabulary -->
                    <div class="w-[38%] bg-white/60 rounded-xl border border-gray-200 shadow-sm p-4 overflow-y-auto custom-scroll flex flex-col">
                        <div id="word-bank-container" class="h-full flex flex-col gap-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-bold text-green-700 uppercase tracking-wider flex items-center"><i class="fas fa-book mr-1.5"></i> Vocabulary Power</span>
                                <span class="text-[10px] text-green-600 bg-green-50 px-2 py-0.5 rounded border border-green-100">Tap to listen</span>
                            </div>
                            
                            <!-- Topic Words -->
                            <div class="bg-green-50/40 border border-green-100 rounded-lg p-2.5">
                                <span class="block text-xs text-green-800 font-bold mb-1.5 uppercase border-b border-green-200 pb-1">Topic Words</span>
                                <div id="word-bank-list" class="flex flex-wrap gap-1.5 content-start"></div>
                            </div>

                            <!-- Collocations -->
                            <div class="bg-green-50/40 border border-green-100 rounded-lg p-2.5 flex-grow">
                                <span class="block text-xs text-green-800 font-bold mb-1.5 uppercase border-b border-green-200 pb-1">Collocations</span>
                                <div id="collocations-list" class="flex flex-wrap gap-1.5 content-start"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Sample Answer Overlay -->
            <div id="samples-container" class="hidden absolute bottom-0 left-0 right-0 bg-white border-t-8 border-yellow-200 shadow-[0_-8px_30px_-5px_rgba(0,0,0,0.2)] z-30 max-h-[85%] overflow-y-auto custom-scroll transition-transform">
                <div class="p-6 bg-yellow-50/98 backdrop-blur-xl min-h-full">
                    <div class="flex justify-end items-center mb-2 sticky top-0">
                        <button id="close-samples-btn" class="text-yellow-700 hover:text-yellow-900 bg-yellow-200 hover:bg-yellow-300 rounded-full w-8 h-8 flex items-center justify-center transition-colors shadow-sm"><i class="fas fa-times"></i></button>
                    </div>
                    <ul id="samples-list" class="space-y-4 list-none text-lg text-gray-800 leading-relaxed font-medium"></ul>
                </div>
            </div>
            
            <!-- Completion Celebration -->
            <div id="celebration-overlay" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center p-4">
                <div class="bg-green-100 p-8 rounded-full mb-6 animate-bounce shadow-xl">
                    <i class="fas fa-check text-6xl text-green-600"></i>
                </div>
                <h2 class="text-4xl font-bold text-gray-800 mb-2">Topic Completed!</h2>
                <p class="text-xl text-gray-600">Great job!</p>
            </div>
        </div>

        <!-- Certificate Screen -->
        <div id="certificate-screen" class="hidden bg-white p-6 rounded-3xl shadow-2xl h-full flex flex-col justify-center items-center relative overflow-y-auto">
             <div id="certificate-to-download" class="w-full max-w-3xl bg-white p-12 rounded-3xl border-[12px] border-double border-blue-500 text-center relative shadow-2xl mb-6">
                <div class="absolute top-0 left-0 w-full h-4 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500"></div>
                <div class="flex justify-center mb-6"><i class="fas fa-medal text-6xl text-yellow-400 drop-shadow-xl scale-150"></i></div>
                <h1 class="text-5xl font-serif font-bold text-gray-900 mb-4">Certificate of Achievement</h1>
                <p class="text-xl mt-4 text-gray-600 italic">This is to certify that</p>
                <p id="certificate-name" class="text-5xl font-bold my-6 text-blue-700 font-serif border-b-4 border-gray-300 inline-block px-12 pb-3"></p>
                <p class="text-xl text-gray-700">has completed the <strong>IELTS Speaking Course</strong></p>
                <p class="text-base mt-6 text-gray-500">Date: <span id="certificate-date"></span></p>
            </div>
            <div class="flex gap-4">
                <button id="download-certificate-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl shadow-xl transition-colors text-lg"><i class="fas fa-download mr-2"></i>Save</button>
                <button id="back-to-main-menu-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-xl shadow-xl transition-colors text-lg">Menu</button>
            </div>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-6 text-center max-w-sm w-full">
            <h3 class="text-xl font-bold mb-2 text-gray-800">Exit Practice?</h3>
            <p class="text-base text-gray-600 mb-6">Recording will be lost.</p>
            <div class="flex justify-center gap-3">
                <button id="modal-confirm-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg shadow hover:bg-red-600">Yes</button>
                <button id="modal-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg shadow hover:bg-gray-300">No</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA: 10 Full Topics (2 Sets each) with Grammar Examples ---
        // UPGRADED MODEL ANSWERS to include target vocabulary, collocations, and idioms.
        const practiceData = {
            "Hometown": [
                { 
                    type: "Part 1 (Set A)", question: "Let's talk about your hometown. Where are you from?", timer: 30, 
                    grammar: "Present Perfect", grammarEx: "I have lived there for 10 years.",
                    template: "Direct Answer ➔ 'I have lived there for...' ➔ Adjective ➔ Feeling", 
                    signposts: ["To start with,", "Actually,", "To be precise,"], 
                    fillers: ["Let me think...", "I need a moment...", "To be honest..."], 
                    starters: ["I come from...", "My hometown is...", "It is situated in..."], wordBank: ["capital", "province", "historical", "modern", "district", "residents", "suburbs", "urban"], collocations: ["densely populated", "located in", "famous for", "bustling streets", "local community", "hometown glory", "residential area", "rich history"], idioms: ["Home is where the heart is", "East or west, home is best"], 
                    samples: [
                        "<strong>To be honest</strong>, I come from Beijing. It is a <strong>modern</strong> city <strong>located in</strong> the north of China. I have lived there for 10 years, and for me, <strong>home is where the heart is</strong>."
                    ] 
                },
                { 
                    type: "Part 2 (Set A)", question: "Describe a place in your hometown interesting to tourists.", timer: 90, 
                    grammar: "Relative Clauses", grammarEx: "It is a place which is famous for its food.",
                    template: "Identify Place ➔ 'Which is located...' ➔ 'It is a place where...' ➔ Why popular?", 
                    signposts: ["Specifically,", "In terms of,", "Furthermore,"], 
                    fillers: ["Let me gather my thoughts...", "I recall a place...", "Actually..."], 
                    starters: ["I want to describe...", "It is located in...", "You can see..."], wordBank: ["Great Wall", "Palace", "Temple", "site", "museum", "park", "lake", "view"], collocations: ["tourist attraction", "ancient architecture", "breathtaking view", "cultural heritage", "must-visit spot", "flock to", "historical significance", "well-preserved"], idioms: ["A stone's throw away", "Off the beaten track"], 
                    samples: [
                        "I want to describe the Forbidden City, which is a <strong>must-visit spot</strong> in Beijing. It is <strong>located in</strong> the center of the city and is famous for its <strong>ancient architecture</strong> and <strong>historical significance</strong>.",
                        "It is a place where tourists can see <strong>well-preserved</strong> palaces and learn about Chinese emperors. The site offers a <strong>breathtaking view</strong> of traditional design and is part of our <strong>cultural heritage</strong>. People from all over the world <strong>flock to</strong> this attraction.",
                        "This place is special because it represents the <strong>rich history</strong> of my hometown. For me, it’s not just a <strong>tourist attraction</strong> but a symbol of our identity. Visiting it always feels like taking a <strong>trip down memory lane</strong>."
                    ] 
                },
                { 
                    type: "Part 3 (Set A)", question: "How has your hometown changed recently?", timer: 60, 
                    grammar: "Used to / Would", grammarEx: "It used to be a small village, but now it is a city.",
                    template: "Opinion ➔ 'It used to be...' ➔ 'But now...' ➔ Result", 
                    signposts: ["Looking back,", "In contrast,", "Consequently,"], 
                    fillers: ["That's a tricky one...", "What I mean is...", "Ideally..."], 
                    starters: ["It has changed...", "In the past...", "Now we have..."], wordBank: ["skyscrapers", "subway", "traffic", "convenient", "economy", "shops", "roads", "tech"], collocations: ["urban development", "traffic congestion", "rapid change", "standard of living", "public transport", "shopping mall", "high-rise building", "technological advancement"], idioms: ["Concrete jungle", "Rome wasn't built in a day"], 
                    samples: [
                        "<strong>Looking back</strong>, it used to be a quiet town, but now it has become a <strong>concrete jungle</strong> with <strong>high-rise buildings</strong> and <strong>shopping malls</strong>. The <strong>rapid change</strong> has improved our <strong>standard of living</strong>, although <strong>traffic congestion</strong> is a big issue."
                    ] 
                },
                { 
                    type: "Part 1 (Set B)", question: "Is your hometown a good place for young people?", timer: 30, 
                    grammar: "Modals (Should/Can)", grammarEx: "Young people can find many jobs here.",
                    template: "Yes/No ➔ 'Young people can...' ➔ 'It offers...' ➔ Concession", 
                    signposts: ["For instance,", "On the other hand,", "All in all,"], 
                    fillers: ["I need a moment to think...", "Well, I'd say...", "Generally..."], 
                    starters: ["Definitely, because...", "There are many...", "It offers..."], wordBank: ["opportunities", "jobs", "entertainment", "nightlife", "education", "career", "facilities", "cinema"], collocations: ["job market", "career prospects", "entertainment facilities", "youth culture", "meet up with", "hang out", "educational resources", "lively atmosphere"], idioms: ["The world is your oyster", "Paint the town red"], 
                    samples: [
                        "<strong>Definitely, because</strong> the <strong>job market</strong> is strong and there are plenty of <strong>entertainment facilities</strong>. Young people can find opportunities and enjoy a <strong>lively atmosphere</strong> where they can <strong>paint the town red</strong>."
                    ] 
                },
                { 
                    type: "Part 2 (Set B)", question: "Describe a childhood memory from your hometown.", timer: 90, 
                    grammar: "Past Continuous", grammarEx: "I was playing in the park when it started to rain.",
                    template: "What happened? ➔ 'I was playing...' ➔ Details ➔ Why memorable?", 
                    signposts: ["I vividly remember,", "Back then,", "As a result,"], 
                    fillers: ["Let me think back...", "It feels like yesterday...", "Briefly..."], 
                    starters: ["One memory is...", "I used to...", "We often went..."], wordBank: ["park", "school", "friends", "playing", "games", "bicycle", "summer", "ice cream"], collocations: ["childhood friend", "happy memory", "play hide and seek", "after school", "grow up", "nostalgic feeling", "carefree days", "family gathering"], idioms: ["Trip down memory lane", "Ring a bell"], 
                    samples: [
                        "<strong>I vividly remember</strong> taking a <strong>trip down memory lane</strong> to the old park. <strong>Back then</strong>, I was riding my <strong>bicycle</strong> with my <strong>childhood friend</strong> during those <strong>carefree days</strong> of summer.",
                        "It gives me a <strong>nostalgic feeling</strong>. We were <strong>playing hide and seek</strong> after school when the ice cream truck music <strong>rang a bell</strong>, and we all ran to buy some."
                    ] 
                },
                { 
                    type: "Part 3 (Set B)", question: "What are the main problems in your hometown?", timer: 60, 
                    grammar: "Passive (Is caused by)", grammarEx: "Traffic congestion is caused by too many cars.",
                    template: "Identify Problem ➔ 'This is caused by...' ➔ Effect ➔ Solution", 
                    signposts: ["Primarily,", "This leads to,", "Ideally,"], 
                    fillers: ["Let me gather my thoughts...", "Sadly...", "To be blunt..."], 
                    starters: ["The main issue is...", "We suffer from...", "People complain about..."], wordBank: ["pollution", "noise", "crowds", "expensive", "housing", "parking", "stress", "competition"], collocations: ["air pollution", "noise pollution", "housing prices", "high cost of living", "traffic jam", "rush hour", "environmental issue", "waste disposal"], idioms: ["A drop in the ocean", "Caught in a rat race"], 
                    samples: [
                        "<strong>Primarily</strong>, the biggest issue is <strong>air pollution</strong>, which is caused by too many cars. This leads to <strong>traffic congestion</strong> and stress. <strong>Sadly</strong>, any solution seems like <strong>a drop in the ocean</strong> compared to the scale of the problem."
                    ] 
                }
            ],
            "Food": [
                { 
                    type: "Part 1 (Set A)", question: "What is your favorite dish?", timer: 30, 
                    grammar: "Adjectives of Taste", grammarEx: "It tastes incredibly spicy and savory.",
                    template: "Name Dish ➔ 'It tastes...' ➔ 'I usually eat it...'", 
                    signposts: ["My go-to dish is,", "Especially,", "Simply put,"], 
                    fillers: ["Let me think...", "Oh, definitely...", "Without a doubt..."], 
                    starters: ["I really love...", "It consists of...", "It is served with..."], wordBank: ["spicy", "savory", "sweet", "bitter", "salty", "crispy", "tender", "juicy"], collocations: ["traditional dish", "mouth-watering", "rich flavor", "staple food", "authentic taste", "culinary skills", "home-cooked meal", "secret ingredient"], idioms: ["Make my mouth water", "Eat like a horse"], 
                    samples: [
                        "<strong>Without a doubt</strong>, my favorite dish is hot pot. The <strong>spicy</strong> broth makes my <strong>mouth water</strong>, and I love the variety of fresh ingredients you can cook yourself. It’s a <strong>traditional dish</strong> that brings people together.",
                        "<strong>My go-to dish is</strong> dumplings. They are <strong>savory</strong> and <strong>juicy</strong>, and I never get tired of them."
                    ] 
                },
                { 
                    type: "Part 2 (Set A)", question: "Describe a memorable meal you had.", timer: 90, 
                    grammar: "Past Simple & Perfect", grammarEx: "We had ordered the fish before the music started.",
                    template: "Where/When? ➔ 'We had ordered...' ➔ Taste ➔ Why memorable?", 
                    signposts: ["It took place,", "What made it special was,", "Looking back,"], 
                    fillers: ["I recall a time...", "One meal stands out...", "Specifically..."], 
                    starters: ["I went to...", "We ordered...", "It tasted..."], wordBank: ["restaurant", "birthday", "cake", "seafood", "buffet", "delicious", "expensive", "service"], collocations: ["special occasion", "fine dining", "excellent service", "reasonable price", "celebratory meal", "book a table", "recommend a dish", "satisfied customer"], idioms: ["Wining and dining", "Eat one's fill"], 
                    samples: [
                        "<strong>One meal stands out</strong> — it was my birthday dinner at a <strong>fine dining</strong> restaurant. We had <strong>booked a table</strong> in advance, and the <strong>excellent service</strong> made the evening unforgettable.",
                        "We ordered seafood, and I had a dish that tasted incredibly <strong>savory</strong> and <strong>tender</strong>. The flavors were so rich that I felt completely satisfied. What made it special was not just the food but the company — sharing that moment with my family turned it into a <strong>celebratory meal</strong>.",
                        "Looking back, it was memorable because it combined <strong>delicious</strong> food, a <strong>special occasion</strong>, and great company. It was truly <strong>worth its weight in gold</strong>."
                    ] 
                },
                { 
                    type: "Part 3 (Set A)", question: "Is healthy food expensive?", timer: 60, 
                    grammar: "Comparatives", grammarEx: "Organic food is more expensive than junk food.",
                    template: "Direct Answer ➔ 'X is more expensive than Y' ➔ Reason ➔ Conclusion", 
                    signposts: ["On the surface,", "However,", "In the long run,"], 
                    fillers: ["That is a good point...", "It seems that...", "Let me see..."], 
                    starters: ["Fresh food is...", "Processed food is...", "If you cook..."], wordBank: ["organic", "vegetables", "fruit", "market", "supermarket", "price", "cost", "cheap"], collocations: ["organic food", "balanced diet", "nutritional value", "processed food", "junk food", "affordable options", "seasonal produce", "health conscious"], idioms: ["An apple a day", "Cost an arm and a leg"], 
                    samples: [
                        "<strong>On the surface</strong>, <strong>organic food</strong> is more expensive than <strong>junk food</strong>. It can <strong>cost an arm and a leg</strong>.",
                        "<strong>However</strong>, in the <strong>long run</strong>, eating a <strong>balanced diet</strong> is worth it because it prevents health problems."
                    ] 
                },
                { 
                    type: "Part 1 (Set B)", question: "Do you like cooking?", timer: 30, 
                    grammar: "Gerunds (Enjoy doing)", grammarEx: "I really enjoy baking cakes on weekends.",
                    template: "Yes/No ➔ 'I enjoy cooking...' ➔ Frequency ➔ Specialty", 
                    signposts: ["To be honest,", "Actually,", "Whenever I can,"], 
                    fillers: ["I need a moment...", "Not really...", "I'm a big fan of..."], 
                    starters: ["I enjoy cooking...", "I'm not good at...", "I can make..."], wordBank: ["cook", "chef", "recipe", "ingredients", "kitchen", "bake", "fry", "boil"], collocations: ["follow a recipe", "prepare a meal", "fresh ingredients", "culinary skills", "try new things", "burn the food", "master a dish", "signature dish"], idioms: ["Too many cooks", "Piece of cake"], 
                    samples: [
                        "<strong>Actually</strong>, I really enjoy cooking. I often <strong>try new recipes</strong> and experiment with <strong>fresh ingredients</strong>. Preparing a meal feels like a <strong>piece of cake</strong> when I <strong>follow a recipe</strong>, and it gives me a sense of accomplishment.",
                        "<strong>Not really</strong>. I usually <strong>burn the food</strong>, so I prefer eating out."
                    ] 
                },
                { 
                    type: "Part 2 (Set B)", question: "Describe a restaurant you like.", timer: 90, 
                    grammar: "Present Simple & Adjectives", grammarEx: "It is a cozy place that serves amazing pasta.",
                    template: "Name ➔ 'It is located...' ➔ Decor/Food ➔ Why you like it", 
                    signposts: ["The atmosphere is,", "I highly recommend it because,", "In addition,"], 
                    fillers: ["Let me think...", "I frequent a place...", "It's my favorite..."], 
                    starters: ["The restaurant is called...", "It serves...", "The decor is..."], wordBank: ["cozy", "modern", "menu", "waiter", "lighting", "music", "tasty", "clean"], collocations: ["cozy atmosphere", "extensive menu", "friendly staff", "reasonable price", "hidden gem", "romantic setting", "local cuisine", "top-notch service"], idioms: ["Out of this world", "Bread and butter"], 
                    samples: [
                        "I frequent a place called 'The Nook'. It is a <strong>hidden gem</strong> with a <strong>cozy atmosphere</strong> and <strong>top-notch service</strong>.",
                        "The atmosphere is modern, and the <strong>friendly staff</strong> make you feel welcome. The food is tasty and <strong>reasonably priced</strong>, truly <strong>out of this world</strong>."
                    ] 
                },
                { 
                    type: "Part 3 (Set B)", question: "How has food culture changed recently?", timer: 60, 
                    grammar: "Present Perfect Continuous", grammarEx: "People have been eating more fast food recently.",
                    template: "Observation ➔ 'People have been eating...' ➔ Cause ➔ Effect", 
                    signposts: ["Over the years,", "Resulting in,", "Conversely,"], 
                    fillers: ["It's obvious that...", "I suppose...", "Let me consider..."], 
                    starters: ["People consume...", "Fast food has...", "Traditional food is..."], wordBank: ["delivery", "apps", "fast", "unhealthy", "global", "variety", "diet", "trend"], collocations: ["fast food chain", "food delivery app", "global cuisine", "unhealthy eating habits", "traditional diet", "convenience food", "dining out", "dietary requirement"], idioms: ["Bite the bullet", "Spice of life"], 
                    samples: [
                        "<strong>Over the years</strong>, <strong>food delivery apps</strong> have taken over, making dining more convenient but leading to <strong>unhealthy eating habits</strong>.",
                        "<strong>It's obvious that</strong> we now enjoy more <strong>global cuisine</strong>, which adds variety and the <strong>spice of life</strong>."
                    ] 
                }
            ],
            "Festivals": [
                { 
                    type: "Part 1 (Set A)", question: "What is your favorite festival?", timer: 30, 
                    grammar: "Superlatives", grammarEx: "It is the most exciting time of the year.",
                    template: "Name ➔ 'It is the most...' ➔ Activity ➔ Feeling", 
                    signposts: ["For me,", "I particularly enjoy,", "In short,"], fillers: ["I need a moment...", "I'd have to say...", "It's definitely..."], starters: ["My favorite is...", "It happens in...", "I love the..."], wordBank: ["Spring Festival", "Christmas", "Lantern", "gift", "family", "fun", "holiday", "celebrate"], collocations: ["festive atmosphere", "exchange gifts", "family reunion", "public holiday", "celebrate together", "special occasion", "ancient tradition", "festive mood"], idioms: ["Have a ball", "Let one's hair down"], 
                    samples: [
                        "<strong>I'd have to say</strong> Spring Festival. It’s the most exciting time of the year because we have a <strong>family reunion</strong> and <strong>exchange gifts</strong>. The <strong>festive atmosphere</strong> makes it truly special."
                    ] 
                },
                { 
                    type: "Part 2 (Set A)", question: "Describe a traditional festival.", timer: 90, 
                    grammar: "Passive Voice", grammarEx: "Mooncakes are eaten during the festival.",
                    template: "Name ➔ 'It is celebrated...' ➔ Activities ➔ Meaning", 
                    signposts: ["Traditionally,", "It signifies,", "During this time,"], fillers: ["Let me think...", "I want to talk about...", "It dates back to..."], starters: ["It is called...", "People usually...", "We eat..."], wordBank: ["mooncake", "dragon", "lantern", "ancestors", "calendar", "worship", "pray", "costume"], collocations: ["lunar calendar", "pay respects", "cultural heritage", "traditional costume", "dragon dance", "family gathering", "religious ceremony", "historical significance"], idioms: ["Feast for the eyes", "Once in a blue moon"], 
                    samples: [
                        "I want to talk about the Lantern Festival, which is celebrated on the 15th day of the <strong>lunar calendar</strong>. <strong>Traditionally</strong>, people light lanterns and watch the <strong>dragon dance</strong>, which is a real <strong>feast for the eyes</strong>.",
                        "We also eat mooncakes and gather with family to <strong>pay respects</strong> to ancestors. The festival signifies family unity and has deep <strong>historical significance</strong>.",
                        "For me, it’s memorable because it combines <strong>cultural heritage</strong> with joy. It’s not just about entertainment but about remembering our roots. It happens only <strong>once in a blue moon</strong>, so it feels very special."
                    ] 
                },
                { 
                    type: "Part 3 (Set A)", question: "Why are festivals important?", timer: 60, 
                    grammar: "Infinitive of Purpose", grammarEx: "We celebrate to honor our ancestors.",
                    template: "Reason ➔ 'To preserve...' ➔ Detail ➔ Conclusion", 
                    signposts: ["Fundamentally,", "Moreover,", "Therefore,"], fillers: ["Let me gather my thoughts...", "I believe that...", "It helps to..."], starters: ["They remind us...", "We need to...", "It connects..."], wordBank: ["culture", "history", "identity", "root", "bond", "unify", "teach", "memory"], collocations: ["preserve tradition", "cultural identity", "sense of belonging", "pass down", "national holiday", "social cohesion", "keep traditions alive", "historical roots"], idioms: ["Keep the ball rolling", "Cup of tea"], 
                    samples: [
                        "<strong>Fundamentally</strong>, festivals help <strong>preserve tradition</strong> and strengthen <strong>social cohesion</strong>. They remind us of our <strong>historical roots</strong> and give us a <strong>sense of belonging</strong>."
                    ] 
                },
                { 
                    type: "Part 1 (Set B)", question: "How do you celebrate New Year?", timer: 30, 
                    grammar: "Adverbs of Sequence", grammarEx: "First we eat, then we watch fireworks.",
                    template: "First ➔ Then ➔ Finally ➔ Feeling", 
                    signposts: ["First of all,", "After that,", "Finally,"], fillers: ["I need a moment...", "Usually we...", "It's a tradition to..."], starters: ["We start by...", "We watch...", "We eat..."], wordBank: ["fireworks", "countdown", "party", "dinner", "resolution", "midnight", "cheer", "music"], collocations: ["firework display", "countdown to midnight", "new year resolution", "festive season", "toast to", "gather around", "watch the show", "celebratory dinner"], idioms: ["Ring in the new year", "Start with a clean slate"], 
                    samples: [
                        "<strong>First of all</strong>, we gather for a <strong>celebratory dinner</strong>. <strong>After that</strong>, we watch the <strong>firework display</strong> and join the <strong>countdown to midnight</strong>.",
                        "<strong>Finally</strong>, we make <strong>new year resolutions</strong> to <strong>start with a clean slate</strong>. It is the best way to <strong>ring in the new year</strong>."
                    ] 
                },
                { 
                    type: "Part 2 (Set B)", question: "Describe a music festival you saw.", timer: 90, 
                    grammar: "Sensory Details", grammarEx: "The music sounded loud and the lights looked amazing.",
                    template: "Name ➔ 'It sounded/looked...' ➔ The Band ➔ Atmosphere", 
                    signposts: ["The vibe was,", "What impressed me was,", "In the end,"], fillers: ["Let me remember...", "It was electric...", "I'll never forget..."], starters: ["I went to...", "The stage was...", "The music was..."], wordBank: ["loud", "stage", "band", "singer", "crowd", "lights", "dance", "energy"], collocations: ["live performance", "electric atmosphere", "sing along", "go wild", "talented artist", "main stage", "light show", "memorable experience"], idioms: ["Music to my ears", "Steal the show"], 
                    samples: [
                        "I went to a rock festival last summer. The <strong>vibe was</strong> electric and the <strong>live performance</strong> by the headliner was <strong>music to my ears</strong>.",
                        "The <strong>light show</strong> on the <strong>main stage</strong> was stunning. The crowd <strong>went wild</strong> and it was a truly <strong>memorable experience</strong>."
                    ] 
                },
                { 
                    type: "Part 3 (Set B)", question: "Are festivals becoming too commercial?", timer: 60, 
                    grammar: "Opinion (Too + Adjective)", grammarEx: "Christmas has become too focused on money.",
                    template: "Yes/No ➔ 'Companies focus on...' ➔ Example (Christmas) ➔ Effect", 
                    signposts: ["Undeniably,", "For example,", "Unfortunately,"], fillers: ["That's a tricky one...", "It seems so...", "I argue that..."], starters: ["Shops only want...", "The meaning is...", "People buy..."], wordBank: ["money", "buy", "sell", "business", "profit", "lost", "meaning", "ad"], collocations: ["commercial aspect", "lost its meaning", "focus on profit", "marketing stunt", "consumerism", "spending spree", "true spirit", "materialistic"], idioms: ["Cash cow", "Lose sight of"], 
                    samples: [
                        "<strong>Undeniably</strong>, yes. Many festivals have become a <strong>cash cow</strong> for businesses. For example, Christmas often focuses on <strong>consumerism</strong> rather than its true meaning.",
                        "<strong>Unfortunately</strong>, people sometimes <strong>lose sight of</strong> the cultural value. Events become a <strong>marketing stunt</strong> encouraging a <strong>spending spree</strong>."
                    ] 
                }
            ],
            "Shopping": [
                { 
                    type: "Part 1 (Set A)", question: "Do you enjoy shopping?", timer: 30, 
                    grammar: "Verbs of Emotion", grammarEx: "I absolutely love buying new clothes.",
                    template: "Yes/No ➔ 'I love/hate...' ➔ Frequency ➔ Who with", 
                    signposts: ["To be honest,", "Usually,", "However,"], fillers: ["Let me think...", "I'm a shopaholic...", "Not really..."], starters: ["I love buying...", "It is boring...", "I go with..."], wordBank: ["clothes", "mall", "online", "price", "fashion", "brand", "window", "friends"], collocations: ["go shopping", "window shopping", "bargain hunting", "latest fashion", "retail therapy", "waste of money", "reasonable price", "brand name"], idioms: ["Shop till you drop", "Cost a pretty penny"], 
                    samples: [
                        "<strong>To be honest</strong>, I'm a bit of a <strong>shopaholic</strong>. I love checking out the <strong>latest fashion</strong> and sometimes indulge in <strong>retail therapy</strong>. It’s fun to <strong>shop till you drop</strong> with friends.",
                        "<strong>On the other hand</strong>, I don't enjoy shopping when it feels like a <strong>waste of money</strong> or when malls are too crowded."
                    ] 
                },
                { 
                    type: "Part 2 (Set A)", question: "Describe something expensive you bought.", timer: 90, 
                    grammar: "Past Simple & Cost", grammarEx: "I bought a laptop and it cost $1000.",
                    template: "Item ➔ 'It cost...' ➔ Why you needed it ➔ Value", 
                    signposts: ["I decided to buy,", "Although it was pricey,", "In the end,"], fillers: ["I need a moment...", "I saved up for...", "It was a big purchase..."], starters: ["I bought a...", "It cost...", "I use it for..."], wordBank: ["laptop", "phone", "shoes", "save", "money", "quality", "useful", "luxury"], collocations: ["save up money", "good value for money", "high quality", "latest model", "special treat", "worth the price", "customer service", "make a purchase"], idioms: ["Break the bank", "Worth its weight in gold"], 
                    samples: [
                        "I decided to buy a new laptop last year. It was the <strong>latest model</strong> and cost around $1,000, which really <strong>broke the bank</strong> for me.",
                        "I had <strong>saved up money</strong> for months. Although it was pricey, the laptop has been <strong>worth its weight in gold</strong> due to its <strong>high quality</strong> and reliability.",
                        "<strong>In the end</strong>, it was a big purchase, but I don’t regret it. The <strong>high quality</strong> and usefulness made it a good investment."
                    ] 
                },
                { 
                    type: "Part 3 (Set A)", question: "Is online shopping better than in-store?", timer: 60, 
                    grammar: "Comparatives", grammarEx: "Online shopping is faster than going to the mall.",
                    template: "Opinion ➔ 'Online is more...' ➔ Contrast ➔ Conclusion", 
                    signposts: ["Primary advantage,", "Conversely,", "All things considered,"], fillers: ["Let me gather my thoughts...", "It's more convenient...", "There are risks..."], starters: ["Online is fast...", "You can't try...", "Delivery is..."], wordBank: ["delivery", "website", "return", "size", "touch", "fake", "review", "convenient"], collocations: ["convenient way", "doorstep delivery", "try on clothes", "return policy", "physical store", "online scam", "read reviews", "compare prices"], idioms: ["A mixed bag", "The real deal"], 
                    samples: [
                        "It's more convenient to shop online because of <strong>doorstep delivery</strong> and the ability to <strong>read reviews</strong>.",
                        "<strong>Conversely</strong>, in a <strong>physical store</strong>, you can <strong>try on clothes</strong> and check quality directly. <strong>All things considered</strong>, both have pros and cons — it's a <strong>mixed bag</strong>."
                    ] 
                },
                { 
                    type: "Part 1 (Set B)", question: "Do you prefer big malls or small shops?", timer: 30, 
                    grammar: "Preferences", grammarEx: "I prefer small shops because they are unique.",
                    template: "Preference ➔ 'Because malls have...' ➔ Contrast", 
                    signposts: ["I tend to prefer,", "On the flip side,", "Mainly because,"], fillers: ["I need a moment...", "I like malls...", "It depends..."], starters: ["Malls have everything...", "Small shops are...", "I like the atmosphere..."], wordBank: ["variety", "crowded", "unique", "local", "market", "owner", "chain", "product"], collocations: ["wide variety", "one-stop shop", "support local business", "unique items", "friendly service", "crowded atmosphere", "chain store", "boutique shop"], idioms: ["Spoilt for choice", "Dime a dozen"], 
                    samples: [
                        "<strong>I tend to prefer</strong> malls because they’re a <strong>one-stop shop</strong> where I’m <strong>spoilt for choice</strong> with a <strong>wide variety</strong>.",
                        "<strong>On the flip side</strong>, I also like <strong>boutique shops</strong> because they offer <strong>unique items</strong> and <strong>support local business</strong>."
                    ] 
                },
                { 
                    type: "Part 2 (Set B)", question: "Describe a bad shopping experience.", timer: 90, 
                    grammar: "Narrative Tenses", grammarEx: "I was waiting in line when the clerk shouted.",
                    template: "Item ➔ 'The problem was...' ➔ Staff Reaction ➔ Result", 
                    signposts: ["The problem started when,", "To make matters worse,", "Consequently,"], fillers: ["Let me think...", "It was terrible...", "I was so angry..."], starters: ["I bought...", "It was broken...", "The staff was..."], wordBank: ["rude", "broken", "refund", "manager", "complain", "mistake", "waiting", "service"], collocations: ["customer service", "ask for a refund", "defective product", "speak to the manager", "bad attitude", "waste of time", "make a complaint", "poor quality"], idioms: ["Rip-off", "Add insult to injury"], 
                    samples: [
                        "<strong>The problem started when</strong> I bought a <strong>defective product</strong> online. <strong>To make matters worse</strong>, the <strong>customer service</strong> was rude when I asked for a refund.",
                        "<strong>Consequently</strong>, I felt cheated — it was a complete <strong>rip-off</strong> and really <strong>added insult to injury</strong>. It was a huge <strong>waste of time</strong>."
                    ] 
                },
                { 
                    type: "Part 3 (Set B)", question: "Why do people buy things they don't need?", timer: 60, 
                    grammar: "Causative Verbs", grammarEx: "Advertising makes us want new things.",
                    template: "Reason ➔ 'Ads make us buy...' ➔ Peer Pressure ➔ Result", 
                    signposts: ["Firstly,", "Furthermore,", "Ultimately,"], fillers: ["That's a tricky one...", "It's consumerism...", "Advertising is powerful..."], starters: ["Ads make us...", "Trends are...", "They feel..."], wordBank: ["advertising", "trend", "fashion", "waste", "status", "impress", "impulse", "media"], collocations: ["impulse buying", "consumer culture", "latest trend", "keep up with the Joneses", "status symbol", "power of advertising", "instant gratification", "material possessions"], idioms: ["Keep up with the Joneses", "Burning a hole in one's pocket"], 
                    samples: [
                        "<strong>Firstly</strong>, the <strong>power of advertising</strong> drives <strong>impulse buying</strong>. Ads make us want the <strong>latest trend</strong>.",
                        "<strong>Furthermore</strong>, people buy to <strong>keep up with the Joneses</strong> or to show off a <strong>status symbol</strong>.",
                        "<strong>Ultimately</strong>, it's part of <strong>consumer culture</strong>, where money often feels like it's <strong>burning a hole in their pocket</strong>."
                    ] 
                }
            ],
            "School": [
                { 
                    type: "Part 1 (Set A)", question: "Tell me about your school.", timer: 30, 
                    grammar: "Adjectives & Present Simple", grammarEx: "It is a large school with modern classrooms.",
                    template: "Name ➔ 'It is a large/small...' ➔ Facilities ➔ Feeling", 
                    signposts: ["Basically,", "It features,", "Overall,"], fillers: ["I need a moment...", "It's quite a nice place...", "Well, I study at..."], starters: ["I go to...", "It has...", "The campus is..."], wordBank: ["campus", "library", "lab", "classroom", "playground", "strict", "modern", "facilities"], collocations: ["modern facilities", "spacious campus", "well-equipped laboratory", "strict discipline", "friendly atmosphere", "extra-curricular activities", "high academic standards", "attend classes"], idioms: ["Hit the books", "Teacher's pet"], 
                    samples: [
                        "<strong>Well, I study at</strong> a local high school. It has a <strong>spacious campus</strong> with <strong>modern facilities</strong> like a library and science labs.",
                        "<strong>Overall</strong>, the atmosphere is friendly, and students enjoy both academics and <strong>extra-curricular activities</strong>."
                    ] 
                },
                { 
                    type: "Part 2 (Set A)", question: "Describe a favorite subject.", timer: 90, 
                    grammar: "Causal Connectors", grammarEx: "I like math because it is logical.",
                    template: "Subject ➔ 'I find it...' ➔ Teacher/Content ➔ Why interesting?", 
                    signposts: ["The main reason is,", "Additionally,", "In particular,"], fillers: ["Let me think...", "I'm really into...", "Without a doubt..."], starters: ["My favorite is...", "I find history...", "The teacher makes..."], wordBank: ["history", "math", "science", "interesting", "boring", "exam", "learn", "formula"], collocations: ["fascinating subject", "solve problems", "conduct experiments", "memorize facts", "practical skills", "gain knowledge", "pass an exam", "pay attention"], idioms: ["Pass with flying colors", "Know one's stuff"], 
                    samples: [
                        "<strong>I'm really into</strong> History. I find it a <strong>fascinating subject</strong> because it helps me <strong>gain knowledge</strong> about the past.",
                        "<strong>Additionally</strong>, my teacher makes the lessons engaging. Thanks to her, I always <strong>pass with flying colors</strong> in exams."
                    ] 
                },
                { 
                    type: "Part 3 (Set A)", question: "Is homework necessary?", timer: 60, 
                    grammar: "Opinion + Conditionals", grammarEx: "If we don't do homework, we won't learn.",
                    template: "Yes/No ➔ 'If students don't practice...' ➔ Balance ➔ Conclusion", 
                    signposts: ["I strongly believe,", "On the flip side,", "Ideally,"], fillers: ["Let me gather my thoughts...", "It's a hot topic...", "Teachers say..."], starters: ["It reinforces...", "Too much is...", "We need..."], wordBank: ["practice", "review", "stress", "burden", "time", "grade", "skill", "useful"], collocations: ["reinforce learning", "heavy workload", "academic performance", "independent study", "time management", "stressful environment", "necessary evil", "daily practice"], idioms: ["Burn the midnight oil", "Bite off more than you can chew"], 
                    samples: [
                        "<strong>I strongly believe</strong> homework helps <strong>reinforce learning</strong> and improves <strong>academic performance</strong>.",
                        "<strong>On the flip side</strong>, too much homework can be a <strong>heavy workload</strong> and force students to <strong>burn the midnight oil</strong>."
                    ] 
                },
                { 
                    type: "Part 1 (Set B)", question: "Do you prefer studying alone or in a group?", timer: 30, 
                    grammar: "Preferences (Prefer X to Y)", grammarEx: "I prefer studying alone to studying in groups.",
                    template: "Preference ➔ 'I can focus better...' ➔ Exception", 
                    signposts: ["Generally,", "However,", "It depends,"], fillers: ["I need a moment...", "I'm a solitary learner...", "Groups are fun but..."], starters: ["I study better...", "Groups help with...", "Alone is..."], wordBank: ["focus", "distract", "quiet", "share", "idea", "help", "loud", "efficient"], collocations: ["concentrate on", "distractions", "share ideas", "study partner", "brainstorming session", "peace and quiet", "stay focused", "mutual support"], idioms: ["Two heads are better than one", "Keep your nose to the grindstone"], 
                    samples: [
                        "<strong>Generally</strong>, I prefer studying alone because I can <strong>stay focused</strong> without <strong>distractions</strong>.",
                        "<strong>However</strong>, for projects, I enjoy group work since <strong>two heads are better than one</strong>."
                    ] 
                },
                { 
                    type: "Part 2 (Set B)", question: "Describe a school rule you agree/disagree with.", timer: 90, 
                    grammar: "Modals of Obligation", grammarEx: "We have to wear a uniform every day.",
                    template: "Rule ➔ 'We have to...' ➔ Why it exists ➔ Your Opinion", 
                    signposts: ["The rule states,", "Personally,", "The logic is,"], fillers: ["Let me consider...", "It's quite strict...", "Many students hate..."], starters: ["We must wear...", "Phones are...", "It forbids..."], wordBank: ["uniform", "phone", "late", "punish", "fair", "strict", "safety", "respect"], collocations: ["strict rule", "school uniform", "banned items", "follow the rules", "break the rules", "face punishment", "discipline", "valid reason"], idioms: ["By the book", "Draw the line"], 
                    samples: [
                        "<strong>The rule states</strong> that we must wear a <strong>school uniform</strong> every day. <strong>Personally</strong>, I think it's fair because it promotes equality and <strong>discipline</strong>.",
                        "The logic is that it helps students focus on learning. In short, I support this rule because it keeps things <strong>by the book</strong>."
                    ] 
                },
                { 
                    type: "Part 3 (Set B)", question: "How will schools change in the future?", timer: 60, 
                    grammar: "Future Simple & Prediction", grammarEx: "I think schools will use more robots.",
                    template: "Prediction ➔ 'Classes will be...' ➔ Technology ➔ Result", 
                    signposts: ["In the future,", "Most likely,", "As a result,"], fillers: ["That's a tricky one...", "I imagine...", "It's probable that..."], starters: ["VR will be...", "Teachers will...", "Online learning..."], wordBank: ["online", "VR", "AI", "robot", "home", "flexible", "global", "screen"], collocations: ["virtual reality", "artificial intelligence", "online learning", "flexible schedule", "remote education", "technological integration", "personalized learning", "future trend"], idioms: ["Sky is the limit", "Time will tell"], 
                    samples: [
                        "<strong>In the future</strong>, schools will likely use <strong>virtual reality</strong> and <strong>artificial intelligence</strong> to personalize learning.",
                        "<strong>Most likely</strong>, students will have a <strong>flexible schedule</strong> and more <strong>online learning</strong> opportunities. <strong>Time will tell</strong>, but technology will be key."
                    ] 
                }
            ],
            "Sports": [
                { 
                    type: "Part 1 (Set A)", question: "Do you like playing sports?", timer: 30, 
                    grammar: "Present Simple & Adverbs", grammarEx: "I frequently play soccer on weekends.",
                    template: "Yes/No ➔ 'I often play...' ➔ Why (Health/Fun)", 
                    signposts: ["Absolutely,", "Not really,", "Occasionally,"], fillers: ["I need a moment...", "I'm quite sporty...", "I prefer watching..."], starters: ["I play...", "I am a fan of...", "It keeps me..."], wordBank: ["football", "swim", "run", "gym", "fit", "healthy", "team", "fun"], collocations: ["keep fit", "stay healthy", "team sport", "regular exercise", "physical activity", "relieve stress", "competitive spirit", "join a club"], idioms: ["Get the ball rolling", "Healthy body, healthy mind"], 
                    samples: [
                        "<strong>Absolutely</strong>, I play football regularly to <strong>keep fit</strong> and <strong>relieve stress</strong>. It's a great way to <strong>stay healthy</strong>.",
                        "<strong>Not really</strong>, but I know that <strong>regular exercise</strong> is important for a <strong>healthy body, healthy mind</strong>."
                    ] 
                },
                { 
                    type: "Part 2 (Set A)", question: "Describe a sport you want to try.", timer: 90, 
                    grammar: "Would like to + Infinitive", grammarEx: "I would like to try surfing because it looks fun.",
                    template: "Sport ➔ 'I would like to try...' ➔ Why? ➔ Equipment needed", 
                    signposts: ["It looks exciting,", "I've always wanted to,", "However,"], fillers: ["Let me think...", "It seems dangerous but...", "I'm curious about..."], starters: ["I want to try...", "Skiing looks...", "I need..."], wordBank: ["ski", "surf", "dive", "dangerous", "exciting", "gear", "lesson", "sea"], collocations: ["extreme sport", "adrenaline rush", "expensive gear", "take lessons", "master the skill", "physical strength", "challenging activity", "step out of comfort zone"], idioms: ["Give it a shot", "Jump in at the deep end"], 
                    samples: [
                        "I've always wanted to try surfing. It looks like an <strong>adrenaline rush</strong> and a great way to <strong>step out of my comfort zone</strong>.",
                        "It looks exciting, so I want to <strong>give it a shot</strong>, even though it requires <strong>expensive gear</strong> and I would need to <strong>take lessons</strong>."
                    ] 
                },
                { 
                    type: "Part 3 (Set A)", question: "Should children play sports?", timer: 60, 
                    grammar: "Modals of Advice (Should)", grammarEx: "Children should play sports to make friends.",
                    template: "Yes ➔ 'They should play...' ➔ Benefits (Social/Physical) ➔ Conclusion", 
                    signposts: ["definitely,", "The benefits are,", "In short,"], fillers: ["I need a moment to think...", "It's essential...", "They learn a lot..."], starters: ["It teaches...", "Teamwork is...", "They need..."], wordBank: ["teamwork", "health", "friends", "win", "lose", "rule", "fair", "grow"], collocations: ["build character", "team spirit", "learn to lose", "follow the rules", "social skills", "cooperation", "healthy lifestyle", "childhood development"], idioms: ["Level playing field", "Win some, lose some"], 
                    samples: [
                        "<strong>Definitely</strong>. Sports help <strong>build character</strong>, teach <strong>team spirit</strong>, and encourage a <strong>healthy lifestyle</strong>.",
                        "<strong>In short</strong>, children learn that you <strong>win some, lose some</strong>, which is an important life lesson for <strong>childhood development</strong>."
                    ] 
                },
                { 
                    type: "Part 1 (Set B)", question: "What is the most popular sport in your country?", timer: 30, 
                    grammar: "Superlatives", grammarEx: "Soccer is the most popular sport here.",
                    template: "Sport ➔ 'It is the most popular...' ➔ Why? ➔ Do you like it?", 
                    signposts: ["Without a doubt,", "Nationwide,", "Personally,"], fillers: ["Let me think...", "Everyone plays...", "It's everywhere..."], starters: ["Table tennis is...", "People love...", "Matches are..."], wordBank: ["popular", "fan", "stadium", "match", "player", "star", "national", "pride"], collocations: ["national sport", "huge fan base", "packed stadium", "cheer for", "national pride", "live match", "professional player", "widely played"], idioms: ["The name of the game", "Ahead of the pack"], 
                    samples: [
                        "<strong>Without a doubt</strong>, it's table tennis. It's considered the <strong>national sport</strong> and has a <strong>huge fan base</strong>.",
                        "<strong>Nationwide</strong>, people <strong>cheer for</strong> professional players, and matches often fill <strong>packed stadiums</strong>. It's <strong>ahead of the pack</strong> in popularity."
                    ] 
                },
                { 
                    type: "Part 2 (Set B)", question: "Describe a live sports match you watched.", timer: 90, 
                    grammar: "Sensory Language", grammarEx: "I could hear the crowd cheering loudly.",
                    template: "Event ➔ 'I went to...' ➔ Atmosphere (Loud/Exciting) ➔ Result", 
                    signposts: ["The atmosphere was,", "The crowd went wild,", "In the final minute,"], fillers: ["Let me recall...", "It was unforgettable...", "My heart was racing..."], starters: ["I watched...", "The stadium was...", "We screamed..."], wordBank: ["loud", "cheer", "score", "goal", "win", "excited", "tense", "amazing"], collocations: ["electric atmosphere", "score a goal", "winning team", "close match", "loud cheers", "support the team", "live broadcast", "unforgettable moment"], idioms: ["Blow the whistle", "Saved by the bell"], 
                    samples: [
                        "I <strong>vividly remember</strong> watching a match. The <strong>atmosphere was</strong> electric, with loud cheers every time a <strong>goal was scored</strong>.",
                        "My heart was racing during the <strong>close match</strong>. The <strong>crowd went wild</strong> when we won. We were truly <strong>saved by the bell</strong> when the referee blew the whistle."
                    ] 
                },
                { 
                    type: "Part 3 (Set B)", question: "Are athletes paid too much?", timer: 60, 
                    grammar: "Opinion + Contrast", grammarEx: "They earn a lot, but their career is short.",
                    template: "Opinion ➔ 'They earn...' ➔ Comparison (Doctors/Teachers) ➔ Justification (Short career?)", 
                    signposts: ["It's debatable,", "On one hand,", "Conversely,"], fillers: ["That's a tricky one...", "It seems unfair...", "They work hard but..."], starters: ["Their salary is...", "Doctors earn...", "It is entertainment..."], wordBank: ["salary", "unfair", "entertainment", "career", "short", "value", "millions", "fame"], collocations: ["exorbitant salary", "short career", "public entertainment", "role model", "income gap", "hard work", "market demand", "justified income"], idioms: ["Roll the dice", "Strike it rich"], 
                    samples: [
                        "<strong>It's debatable</strong>. On one hand, they <strong>strike it rich</strong> with an <strong>exorbitant salary</strong> due to the high <strong>market demand</strong> for <strong>public entertainment</strong>.",
                        "<strong>Conversely</strong>, they <strong>roll the dice</strong> with a <strong>short career</strong>, so perhaps the income is <strong>justified</strong> for their <strong>hard work</strong> and talent."
                    ] 
                }
            ],
            "Social Media": [
                { 
                    type: "Part 1 (Set A)", question: "Do you often use social media?", timer: 30, 
                    grammar: "Frequency Adverbs / Present Simple", grammarEx: "I use Instagram daily to check news.",
                    template: "Yes/No ➔ Frequency/Apps ➔ Reason (Connect/Trends) ➔ Concession", 
                    signposts: ["To be perfectly honest,", "On the other hand,", "Daily,"], 
                    fillers: ["Let me think...", "Well, actually...", "It depends..."], 
                    starters: ["I check apps like...", "I use it to...", "I try not to..."], wordBank: ["Instagram", "TikTok", "scroll", "daily", "trends", "friends", "waste", "time"], collocations: ["stay connected", "keep up with trends", "scroll endlessly", "waste of time", "social platform", "daily routine", "stay in touch", "overuse apps"], idioms: ["Keep up with the times", "Double-edged sword"], 
                    samples: [
                        "<strong>To be perfectly honest</strong>, yes. I check apps like Instagram and TikTok daily. They help me <strong>stay connected</strong> with friends and <strong>keep up with trends</strong>.",
                        "<strong>On the other hand</strong>, I try not to overuse them because <strong>scrolling endlessly</strong> can be a <strong>waste of time</strong>."
                    ] 
                },
                { 
                    type: "Part 2 (Set A)", question: "Describe a social media platform you use.", timer: 90, 
                    grammar: "Present Simple (Habits)", grammarEx: "I usually scroll through posts in the evening.",
                    template: "Platform ➔ Usage (Share/Scroll) ➔ Why (Features) ➔ Impact", 
                    signposts: ["I'd like to talk about,", "What I like most is,", "All in all,"], 
                    fillers: ["Let me consider...", "It's very popular...", "Actually..."], 
                    starters: ["I use it mainly to...", "I usually scroll...", "It affects my life..."], wordBank: ["Instagram", "photos", "stories", "share", "creative", "addictive", "knowledge", "fun"], collocations: ["user-friendly", "keep up with the times", "bite-sized knowledge", "express myself", "in moderation", "stay connected", "upload pictures", "educational accounts"], idioms: ["Blessing in disguise", "Keep up with the times"], 
                    samples: [
                        "I’d like to talk about Instagram. I use it mainly to share photos and stories. It’s very <strong>user-friendly</strong> and allows me to <strong>keep up with the times</strong>.",
                        "I usually scroll through posts in the evening. What I like most is following <strong>educational accounts</strong>, which provide <strong>bite-sized knowledge</strong> in a fun way.",
                        "It helps me <strong>express myself</strong> creatively. However, I use it <strong>in moderation</strong>. <strong>All in all</strong>, it’s a <strong>blessing in disguise</strong> because it entertains while teaching me."
                    ] 
                },
                { 
                    type: "Part 3 (Set A)", question: "How has social media changed the way students learn?", timer: 60, 
                    grammar: "Present Perfect", grammarEx: "It has made learning more interactive.",
                    template: "Opinion ➔ 'It has made...' ➔ Examples (Groups/Videos) ➔ Contrast (Distraction)", 
                    signposts: ["From my perspective,", "However,", "Ideally,"], 
                    fillers: ["That's an interesting question...", "It has changed a lot...", "Generally..."], 
                    starters: ["Students can join...", "It creates...", "It can be distracting..."], wordBank: ["interactive", "groups", "video", "distract", "memes", "homework", "research", "study"], collocations: ["online study groups", "educational videos", "interactive learning", "distraction", "access to information", "collaborative learning", "waste time", "stay focused"], idioms: ["Double-edged sword", "Food for thought"], 
                    samples: [
                        "<strong>From my perspective</strong>, social media has made learning more interactive. Students can join <strong>online study groups</strong> and watch <strong>educational videos</strong>.",
                        "<strong>However</strong>, it can also be distracting when students spend more time on memes than on homework. It is truly a <strong>double-edged sword</strong>."
                    ] 
                },
                { 
                    type: "Part 1 (Set B)", question: "What apps are most popular among teenagers?", timer: 30, 
                    grammar: "Superlatives", grammarEx: "TikTok is the most popular app right now.",
                    template: "App Name ➔ 'They are popular because...' ➔ Features ➔ Other Apps", 
                    signposts: ["Without a doubt,", "Generally speaking,", "Frankly speaking,"], 
                    fillers: ["Everyone uses...", "It's definitely...", "I'd say..."], 
                    starters: ["TikTok is...", "They like...", "WhatsApp is used for..."], wordBank: ["TikTok", "Instagram", "video", "chat", "feature", "short", "fast", "fun"], collocations: ["short videos", "interactive features", "instant communication", "group chats", "widely used", "viral content", "stay in touch", "share ideas"], idioms: ["All the rage", "Double-edged sword"], 
                    samples: [
                        "<strong>Without a doubt</strong>, TikTok and Instagram are the most popular. They’re <strong>all the rage</strong> because of <strong>short videos</strong> and <strong>interactive features</strong>.",
                        "<strong>Frankly speaking</strong>, social media is a <strong>double-edged sword</strong>. It helps people <strong>stay in touch</strong> and <strong>share ideas</strong>, but can cause addiction and cyberbullying."
                    ] 
                },
                { 
                    type: "Part 3 (Set B)", question: "Do you think schools should allow mobile phones in class?", timer: 60, 
                    grammar: "Modals (Should/Can) / Conditionals", grammarEx: "Ideally, they should be used for research.",
                    template: "Opinion (Yes/No) ➔ 'Only for...' ➔ Contrast (Gaming) ➔ Consequence", 
                    signposts: ["Ideally,", "On the flip side,", "Therefore,"], 
                    fillers: ["That's debatable...", "Teachers might disagree...", "It depends..."], 
                    starters: ["Phones can be used...", "If students use them...", "Research is easier..."], wordBank: ["research", "app", "chat", "game", "distract", "tool", "strict", "rule"], collocations: ["educational purposes", "language apps", "distraction", "access information", "classroom tool", "strict rules", "learning resource", "digital literacy"], idioms: ["Recipe for disaster", "Draw the line"], 
                    samples: [
                        "<strong>Ideally</strong>, yes, but only for <strong>educational purposes</strong>. Phones can be used for research or <strong>language apps</strong>.",
                        "<strong>On the flip side</strong>, if students use them for chatting or gaming, it becomes a <strong>recipe for disaster</strong> for the classroom environment."
                    ] 
                },
                { 
                    type: "Part 3 (Set B)", question: "How will social media affect jobs and lifestyle?", timer: 60, 
                    grammar: "Future Simple / Predictions", grammarEx: "Most likely, it will create new jobs.",
                    template: "Prediction (Jobs) ➔ 'It will create...' ➔ Lifestyle (Time) ➔ Balance", 
                    signposts: ["Most likely,", "At the same time,", "All in all,"], 
                    fillers: ["It's hard to predict...", "I imagine...", "We will see..."], 
                    starters: ["It will create...", "Traditional jobs may...", "People need to..."], wordBank: ["marketing", "content", "creator", "adapt", "online", "isolate", "balance", "real"], collocations: ["digital marketing", "content creation", "social isolation", "strike a balance", "real-life experience", "adapt to change", "future career", "stay connected"], idioms: ["Keep up with the times", "Double-edged sword"], 
                    samples: [
                        "<strong>Most likely</strong>, social media will create more jobs in <strong>digital marketing</strong> and <strong>content creation</strong>. Traditional jobs may disappear, so people need to <strong>adapt to change</strong>.",
                        "<strong>Absolutely</strong>. Spending too much time online leads to <strong>social isolation</strong>. <strong>All in all</strong>, young people should <strong>strike a balance</strong> and enjoy <strong>real-life experiences</strong>."
                    ] 
                }
            ]
        };

        // --- DOM ---
        const ui = {
            welcomeScreen: document.getElementById('welcome-screen'),
            practiceScreen: document.getElementById('practice-screen'),
            nameInput: document.getElementById('name-input'),
            startBtn: document.getElementById('start-with-name-btn'),
            topicContainer: document.getElementById('topic-selection-container'),
            topicSelection: document.getElementById('topic-selection'),
            progressBar: document.getElementById('overall-progress-bar'),
            progressText: document.getElementById('progress-text'),
            userNameDisplay: document.getElementById('user-name-display'),
            phaseIndicator: document.getElementById('phase-indicator'),
            questionText: document.getElementById('question-text'),
            timerDisplay: document.getElementById('timer-display'),
            prepTimerBtn: document.getElementById('prep-timer-btn'),
            pauseBtn: document.getElementById('pause-resume-btn'),
            resetBtn: document.getElementById('reset-timer-btn'),
            recordBtn: document.getElementById('record-btn'),
            stopBtn: document.getElementById('stop-record-btn'),
            postActions: document.getElementById('post-recording-actions'),
            audioPlayer: document.getElementById('audio-player'),
            downloadBtn: document.getElementById('download-btn'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            fillersList: document.getElementById('fillers-list'),
            startersContainer: document.getElementById('starters-container'),
            startersList: document.getElementById('starters-list'),
            wordBankContainer: document.getElementById('word-bank-container'),
            wordBankList: document.getElementById('word-bank-list'),
            collocationsList: document.getElementById('collocations-list'),
            idiomsList: document.getElementById('idioms-list'),
            grammarText: document.getElementById('grammar-focus-text'),
            templateText: document.getElementById('template-text'),
            signpostsList: document.getElementById('signposts-list'),
            samplesContainer: document.getElementById('samples-container'),
            samplesList: document.getElementById('samples-list'),
            samplesBtn: document.getElementById('samples-btn'),
            closeSamplesBtn: document.getElementById('close-samples-btn'),
            backBtn: document.getElementById('back-to-topics-btn'),
            modal: document.getElementById('confirmation-modal'),
            modalConfirm: document.getElementById('modal-confirm-btn'),
            modalCancel: document.getElementById('modal-cancel-btn'),
            celebration: document.getElementById('celebration-overlay'),
            certScreen: document.getElementById('certificate-screen'),
            certName: document.getElementById('certificate-name'),
            certDate: document.getElementById('certificate-date'),
            certDownload: document.getElementById('download-certificate-btn'),
            menuBtn: document.getElementById('back-to-main-menu-btn'),
            randomTopicBtn: document.getElementById('random-topic-btn'),
            confettiContainer: document.getElementById('confetti-container'),
            grammarExample: document.getElementById('grammar-example-text')
        };

        // --- STATE ---
        let state = { user: '', topic: '', qIndex: 0, questions: [], timer: null, timeLeft: 0, paused: false, mediaRecorder: null, audioChunks: [], blob: null, completed: {}, prepMode: false };
        let tts = window.speechSynthesis;
        let ttsInitialized = false;
        let topicVoices = {}; 

        // --- INIT ---
        function init() {
            try {
                const saved = localStorage.getItem('ieltsG7v17'); 
                if(saved) state.completed = JSON.parse(saved);
                const name = localStorage.getItem('ieltsG7v17Name');
                if(name) { state.user = name; ui.nameInput.value = name; }
                updateProgress();
            } catch(e){}
            initializeTTS();
            
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && !ui.practiceScreen.classList.contains('hidden')) {
                    e.preventDefault(); 
                    if (ui.recordBtn.classList.contains('hidden')) {
                         if (!ui.stopBtn.classList.contains('hidden')) stopRec();
                    } else {
                         startRec();
                    }
                }
                if (e.code === 'Escape') {
                     if (!ui.samplesContainer.classList.contains('hidden')) ui.samplesContainer.classList.add('hidden');
                }
            });
        }
        
        function initializeTTS() {
            return new Promise((resolve) => {
                if (!tts) { ttsInitialized = true; return resolve(); }
                const setVoices = () => {
                    const allVoices = tts.getVoices();
                    if (allVoices.length === 0) return;
                    const preferredNames = ["Andrew", "Brian", "Emma", "Ava"];
                    let selectedVoices = [];
                    preferredNames.forEach(name => {
                        const found = allVoices.find(v => v.name.includes(name));
                        if(found) selectedVoices.push(found);
                    });
                    if(selectedVoices.length === 0) {
                        selectedVoices = allVoices.filter(v => v.lang.startsWith('en'));
                    }
                    const topics = Object.keys(practiceData);
                    topics.forEach((topic, index) => {
                        topicVoices[topic] = selectedVoices[index % selectedVoices.length];
                    });
                    ttsInitialized = true;
                    resolve();
                };
                if (tts.getVoices().length > 0) setVoices();
                else tts.onvoiceschanged = setVoices;
            });
        }

        window.speak = function(text) {
            if (!ttsInitialized || !tts || !text) return;
            try {
                if (tts.speaking) tts.cancel();
                const u = new SpeechSynthesisUtterance(text);
                const currentTopic = state.topic || Object.keys(practiceData)[0]; 
                if (topicVoices[currentTopic]) u.voice = topicVoices[currentTopic];
                u.rate = 0.85; 
                u.pitch = 1;
                tts.speak(u);
            } catch (e) { console.error(e); }
        }
        
        function updateProgress() {
            const total = Object.keys(practiceData).length;
            const done = Object.keys(state.completed).length;
            ui.progressBar.style.width = `${(done/total)*100}%`;
            ui.progressText.innerText = `${done}/${total}`;
        }

        function renderTopics() {
            ui.topicSelection.innerHTML = '';
            Object.keys(practiceData).forEach(t => {
                const btn = document.createElement('button');
                const isDone = state.completed[t];
                btn.className = `p-6 rounded-2xl text-left border transition-all transform hover:scale-[1.02] flex items-center justify-between h-28 shadow-sm ${isDone ? 'bg-green-50 border-green-200' : 'bg-white border-gray-100 hover:border-blue-200 hover:shadow-md'}`;
                btn.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-xl ${isDone ? 'text-green-700' : 'text-gray-800'}">${t}</span>
                        <span class="text-xs text-gray-400 mt-1">${practiceData[t].length} Qs</span>
                    </div>
                    ${isDone ? '<i class="fas fa-check-circle text-green-500 text-2xl"></i>' : '<i class="fas fa-chevron-right text-gray-300"></i>'}
                `;
                btn.onclick = () => loadTopic(t);
                ui.topicSelection.appendChild(btn);
            });
        }

        function loadTopic(t) {
            state.topic = t;
            state.questions = practiceData[t];
            state.qIndex = 0;
            ui.welcomeScreen.classList.add('hidden');
            ui.certScreen.classList.add('hidden');
            ui.practiceScreen.classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            if (state.qIndex >= state.questions.length) {
                state.completed[state.topic] = true;
                localStorage.setItem('ieltsG7v17', JSON.stringify(state.completed));
                ui.celebration.classList.remove('hidden');
                fireConfetti();
                setTimeout(() => {
                    ui.celebration.classList.add('hidden');
                    if(Object.keys(state.completed).length === Object.keys(practiceData).length) showCert();
                    else {
                        ui.practiceScreen.classList.add('hidden');
                        ui.welcomeScreen.classList.remove('hidden');
                        updateProgress();
                        renderTopics();
                    }
                }, 2000);
                return;
            }

            const q = state.questions[state.qIndex];
            resetUI();
            
            ui.phaseIndicator.innerText = q.type;
            ui.questionText.innerText = q.question;
            ui.questionText.onclick = () => window.speak(q.question);

            if(q.type.includes('Part 2')) {
                ui.prepTimerBtn.classList.remove('hidden');
            } else {
                ui.prepTimerBtn.classList.add('hidden');
                startTimer(q.timer);
            }
            state.currentTimerDuration = q.timer;

            // Render UI
            renderChips(ui.fillersList, q.fillers || [], 'gray');
            renderChips(ui.startersList, q.starters || [], 'blue');
            renderChips(ui.signpostsList, q.signposts || [], 'indigo');
            renderChips(ui.wordBankList, q.wordBank || [], 'green');
            renderChips(ui.collocationsList, q.collocations || [], 'green');

            // Grammar & Example
            ui.grammarText.innerText = q.grammar || "Speaking Skills";
            
            // NEW: Render Grammar Example
            if (document.getElementById('grammar-example-text')) {
                const exText = q.grammarEx ? `e.g. "${q.grammarEx}"` : "";
                document.getElementById('grammar-example-text').innerText = exText;
                if(exText) {
                    document.getElementById('grammar-example-text').classList.remove('hidden');
                    document.getElementById('grammar-example-text').onclick = () => window.speak(q.grammarEx);
                    document.getElementById('grammar-example-text').style.cursor = 'pointer';
                } else {
                    document.getElementById('grammar-example-text').classList.add('hidden');
                }
            }
            
            const fmtTemplate = (q.template || "").split('➔').map(step => 
                `<div class="flex items-center"><i class="fas fa-arrow-right text-teal-400 mr-2 text-[10px]"></i><span class="leading-tight">${step.trim()}</span></div>`
            ).join('');
            ui.templateText.innerHTML = fmtTemplate;

            ui.idiomsList.innerHTML = '';
            (q.idioms || []).forEach(idiom => {
                const span = document.createElement('span');
                span.className = "text-[10px] font-medium text-purple-700 italic bg-purple-50 px-2 py-0.5 rounded border border-purple-100 cursor-pointer hover:bg-purple-100 transition-colors whitespace-nowrap";
                span.innerText = `"${idiom}"`;
                span.onclick = () => window.speak(idiom);
                ui.idiomsList.appendChild(span);
            });

            ui.samplesList.innerHTML = '';
            (q.samples || []).forEach(s => {
                const li = document.createElement('li');
                li.className = "mb-4 border-b border-yellow-100 pb-3 last:border-0";
                li.innerHTML = `
                    <div class="flex items-start">
                        <i class="fas fa-quote-left text-yellow-500 mr-2 mt-1 text-sm"></i>
                        <span class="text-gray-800 text-base leading-snug">${s}</span>
                    </div>`;
                ui.samplesList.appendChild(li);
            });

            ui.prevBtn.disabled = state.qIndex === 0;
        }

        function renderChips(container, items, color) {
            container.innerHTML = '';
            const styles = {
                gray: 'bg-white border-gray-200 text-gray-700',
                blue: 'bg-white border-blue-200 text-blue-700',
                indigo: 'bg-white border-indigo-200 text-indigo-700',
                green: 'bg-white border-green-200 text-green-700',
                purple: 'bg-white border-purple-200 text-purple-700'
            };
            items.forEach(txt => {
                const span = document.createElement('span');
                span.className = `${styles[color]} border px-2 py-1 rounded-lg text-[11px] font-semibold interactive-chip inline-block shadow-sm`;
                span.innerText = txt;
                span.onclick = () => window.speak(txt);
                container.appendChild(span);
            });
        }

        function stopRec() { 
             if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
                state.mediaRecorder.onstop = () => {
                    const blob = new Blob(state.audioChunks, { type: 'audio/webm' });
                    state.blob = blob;
                    const url = URL.createObjectURL(blob);
                    ui.audioPlayer.src = url;
                    
                    if(ui.stopBtn) ui.stopBtn.classList.add('hidden');
                    if(ui.recordBtn) ui.recordBtn.classList.add('hidden');
                    if(ui.postActions) {
                        ui.postActions.classList.remove('hidden');
                        ui.postActions.classList.add('flex');
                    }
                };
                state.mediaRecorder.stop();
            }
        }

        function resetUI() {
            clearInterval(state.timer);
            state.paused = false;
            state.prepMode = false;
            if(ui.timerDisplay) {
                ui.timerDisplay.innerText = "0:00";
            }
            if(ui.recordBtn) ui.recordBtn.classList.remove('hidden');
            if(ui.stopBtn) ui.stopBtn.classList.add('hidden');
            if(ui.postActions) {
                ui.postActions.classList.add('hidden');
                ui.postActions.classList.remove('flex');
            }
            ui.samplesContainer.classList.add('hidden');
            if(state.mediaRecorder && state.mediaRecorder.state === 'recording') state.mediaRecorder.stop();
        }

        function startTimer(sec, isPrep = false) {
            clearInterval(state.timer);
            state.timeLeft = sec;
            state.paused = false;
            state.prepMode = isPrep;
            updateTimerDisplay();
            state.timer = setInterval(() => {
                if(!state.paused) {
                    state.timeLeft--;
                    updateTimerDisplay();
                    if(state.timeLeft <= 0) {
                        clearInterval(state.timer);
                        if(isPrep) {
                            ui.prepTimerBtn.classList.add('hidden');
                            startTimer(state.currentTimerDuration);
                        } else {
                            if(state.mediaRecorder && state.mediaRecorder.state === 'recording') stopRec();
                        }
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(state.timeLeft / 60);
            const s = state.timeLeft % 60;
            ui.timerDisplay.innerText = `${m}:${s<10?'0':''}${s}`;
        }

        function fireConfetti() {
            ui.confettiContainer = document.createElement('div');
            ui.confettiContainer.style.position = 'fixed';
            ui.confettiContainer.style.inset = '0';
            ui.confettiContainer.style.pointerEvents = 'none';
            ui.confettiContainer.style.zIndex = '100';
            document.body.appendChild(ui.confettiContainer);
            
            const colors = ['#34D399', '#60A5FA', '#F472B6', '#FBBF24'];
            for (let i = 0; i < 100; i++) {
                const conf = document.createElement('div');
                conf.style.position = 'absolute';
                conf.style.width = '10px';
                conf.style.height = '10px';
                conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = '-10px';
                conf.style.transition = `top ${Math.random() * 2 + 1}s linear, transform 2s linear`;
                ui.confettiContainer.appendChild(conf);
                
                setTimeout(() => {
                    conf.style.top = '110vh';
                    conf.style.transform = `rotate(${Math.random() * 360}deg)`;
                }, 100);
            }
            setTimeout(() => { ui.confettiContainer.remove(); }, 3000);
        }

        async function startRec() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];
                state.mediaRecorder.ondataavailable = e => state.audioChunks.push(e.data);
                state.mediaRecorder.onstop = () => {
                    state.blob = new Blob(state.audioChunks, {type:'audio/webm'});
                    ui.audioPlayer.src = URL.createObjectURL(state.blob);
                    ui.stopBtn.classList.add('hidden');
                    ui.recordBtn.classList.add('hidden');
                    ui.postActions.classList.remove('hidden');
                    ui.postActions.classList.add('flex');
                };
                state.mediaRecorder.start();
                ui.recordBtn.classList.add('hidden');
                ui.stopBtn.classList.remove('hidden');
            } catch(e) { alert("Mic Error"); }
        }

        function showCert() {
            ui.practiceScreen.classList.add('hidden');
            ui.certScreen.classList.remove('hidden');
            ui.certName.innerText = state.user;
            ui.certDate.innerText = new Date().toLocaleDateString();
        }

        ui.startBtn.onclick = () => {
            const val = ui.nameInput.value.trim();
            if(!val) return;
            state.user = val;
            localStorage.setItem('ieltsG7v17Name', val);
            document.getElementById('name-entry-container').classList.add('hidden');
            ui.topicContainer.classList.remove('hidden');
            ui.topicContainer.classList.add('flex');
            renderTopics();
            ui.userNameDisplay.innerText = val;
        };
        ui.nextBtn.onclick = () => { state.qIndex++; loadQuestion(); };
        ui.prevBtn.onclick = () => { if(state.qIndex>0) state.qIndex--; loadQuestion(); };
        ui.prepTimerBtn.onclick = () => startTimer(60, true);
        ui.pauseBtn.onclick = () => { state.paused = !state.paused; };
        ui.resetBtn.onclick = () => startTimer(state.currentTimerDuration);
        ui.recordBtn.onclick = startRec;
        ui.stopBtn.onclick = stopRec;
        
        ui.samplesBtn.onclick = () => {
            if(ui.samplesContainer.classList.contains('hidden')) {
                ui.samplesContainer.classList.remove('hidden');
                setTimeout(() => { ui.samplesContainer.scrollTop = 0; }, 100);
            } else {
                ui.samplesContainer.classList.add('hidden');
            }
        };
        ui.closeSamplesBtn.onclick = () => ui.samplesContainer.classList.add('hidden');
        
        ui.randomTopicBtn.onclick = () => {
             const topics = Object.keys(practiceData);
             const incomplete = topics.filter(t => !state.completed[t]);
             if(incomplete.length > 0) {
                 const randomT = incomplete[Math.floor(Math.random() * incomplete.length)];
                 loadTopic(randomT);
             } else {
                 alert("All topics completed!");
                 state.completed = {};
                 updateProgress();
                 renderTopics();
             }
        };

        ui.backBtn.onclick = () => ui.modal.classList.remove('hidden');
        ui.modalConfirm.onclick = () => {
            ui.modal.classList.add('hidden');
            resetUI();
            ui.samplesContainer.classList.add('hidden'); 
            ui.practiceScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            renderTopics();
            updateProgress();
        };
        ui.modalCancel.onclick = () => ui.modal.classList.add('hidden');
        ui.downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(state.blob);
            a.download = `${state.user}_${state.topic}_Q${state.qIndex+1}.webm`;
            a.click();
        };
        ui.certDownload.onclick = () => {
            html2canvas(document.getElementById('certificate-to-download')).then(c => {
                const a = document.createElement('a');
                a.href = c.toDataURL();
                a.download = 'IELTS_Certificate.png';
                a.click();
            });
        };
        ui.menuBtn.onclick = () => {
            ui.certScreen.classList.add('hidden');
            ui.welcomeScreen.classList.remove('hidden');
            renderTopics();
        };

        init();
    });
    </script>
</body>
</html>
