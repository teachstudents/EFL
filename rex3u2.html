<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 11 Unit 2: Appearance and Reality</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Segoe+UI:wght@400;600;700&display=swap');
        
        @keyframes aestheticFlow {
            0% { background-color: #fff1f2; } /* rose-50 */
            25% { background-color: #f0f9ff; } /* sky-50 */
            50% { background-color: #f5f3ff; } /* violet-50 */
            75% { background-color: #ecfdf5; } /* emerald-50 */
            100% { background-color: #fff1f2; } /* rose-50 */
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            overscroll-behavior: none;
            animation: aestheticFlow 60s linear infinite;
            padding-top: 85px;
            color: #1e293b;
        }
        h1, h2, h3, h4 {
            font-family: 'Merriweather', serif;
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d, .tier-btn, .project-card {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06);
            border: none;
            cursor: pointer;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover, .tier-btn:hover, .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active, .tier-btn:active {
            transform: translateY(1px);
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 100px; height: 40px; padding: 0 8px;
            border: 2px dashed #94a3b8; border-radius: 6px; margin: 0 4px;
            vertical-align: middle; background-color: #ffffff;
            font-weight: bold; color: #334155;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 9999px;
            background-color: white; user-select: none; border: 1px solid #cbd5e1;
            font-weight: 600; color: #475569;
        }
        .word-bank-word.selected { outline: 2px solid #3b82f6; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; border: none; background: transparent; padding: 0; }
        .gap.correct { background-color: #dcfce7; border-color: #22c55e; color: #15803d; border-style: solid; }
        .gap.incorrect { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; border-style: solid; }

        /* Feedback Toast */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #3b82f6, #8b5cf6); animation-duration: 4.5s; }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 30px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 30px; } to { opacity: 0; bottom: 0; } }

        /* Progress Bar */
        #progress-container { background-color: #e2e8f0; border-radius: 9999px; overflow: hidden; height: 8px; width: 100%; margin-top: 8px; }
        #progress-bar { height: 100%; width: 0%; background-color: #3b82f6; transition: width 0.5s ease-out; }
        
        /* Shake Animation */
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        /* Floating Emoji */
        #emoji-floating-container { position: fixed; inset: 0; pointer-events: none; z-index: 40; }
        .floating-emoji {
            position: absolute; font-size: 28px; will-change: transform, opacity;
            opacity: 0; display: inline-block; animation-name: floatAcross;
            animation-timing-function: linear; animation-iteration-count: 1;
        }
        @keyframes floatAcross {
            0% { transform: translateX(-10vw) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateX(110vw) rotate(20deg); opacity: 0; }
        }

        /* Particles */
        .particle { position: fixed; pointer-events: none; z-index: 9999; opacity: 1; transition: opacity 0.5s ease-out; }
        .particle.glitter { width: 8px; height: 8px; border-radius: 50%; background: #fbbf24; }

        /* Tiered Reading Tabs */
        .tier-btn.active { background-color: #0056b3; color: white; border-color: #0056b3; }
        .tier-btn { background-color: white; color: #64748b; border: 1px solid #cbd5e1; }
        
        /* Dialogue Bubbles */
        .dialogue-bubble { padding: 15px; margin: 10px 0; border-radius: 12px; position: relative; max-width: 90%; }
        .bubble-left { background: #e0f2fe; margin-right: auto; border-bottom-left-radius: 2px; }
        .bubble-right { background: #fef3c7; margin-left: auto; border-bottom-right-radius: 2px; }

        /* Pedagogical Box Styles */
        .pedagogy-box { border-left: 4px solid #f59e0b; background: #fffbeb; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem; }
        .pedagogy-title { font-weight: bold; color: #b45309; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.05em; display: block; margin-bottom: 0.25rem; }

    </style>
</head>
<body class="antialiased text-gray-800 text-lg bg-slate-50">
    <canvas id="background-canvas"></canvas>
    <div id="reward-animation-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]"></div>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-md mx-auto bg-white/95 backdrop-blur-sm shadow-md rounded-2xl p-3 border border-slate-200">
            <div class="flex justify-between items-center gap-2">
                <button onclick="goBack()" class="nav-button bg-slate-100 text-slate-600 p-2 rounded-xl hover:bg-slate-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="flex-1 text-center font-bold text-slate-700 whitespace-nowrap"><span id="score-display" class="text-blue-600 text-xl">0</span> XP</div>
                <button onclick="navigateTo('main-menu')" class="nav-button bg-blue-600 text-white p-2 rounded-xl hover:bg-blue-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4h.01M5 19h14"></path></svg>
                </button>
                <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-xl bg-slate-100 hover:bg-slate-200" title="Read Aloud">
                    <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
                </button>
                <button onclick="goNext()" class="nav-button bg-emerald-500 hover:bg-emerald-600 text-white p-2 rounded-xl">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
        </div>
    </header>

    <div id="emoji-floating-container" aria-hidden="true"></div>

    <div id="app-container" class="max-w-3xl mx-auto p-4 sm:p-6 pb-20">
        <section id="page-title-screen" class="page active text-center bg-white rounded-3xl shadow-xl p-8 border border-slate-100">
            <div class="h-full flex flex-col justify-center items-center py-10">
                <div class="text-6xl mb-4">üé≠</div>
                <h1 id="main-title" class="text-4xl md:text-5xl font-bold text-slate-800 mb-2">Grade 11 Unit 2</h1>
                <h2 class="text-2xl text-rose-600 font-semibold mb-6">Appearance and Reality üçéüíÑ</h2>
                <p id="main-subtitle" class="text-xl text-gray-500 mb-8 max-w-lg">Investigate the ethics of aesthetic standards in food and human beauty.</p>
                <div class="flex flex-wrap gap-2 justify-center mb-8">
                    <span class="px-3 py-1 bg-rose-100 text-rose-800 rounded-full text-sm">Theme: Perception vs. Reality</span>
                    <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">Skills: Critical Analysis</span>
                </div>
                <button onclick="startApp()" class="action-button bg-rose-600 text-white font-bold py-4 px-10 rounded-full text-xl hover:bg-rose-700 shadow-lg transition-transform transform hover:scale-105">ENTER UNIT</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION ---
        // ===================================================================================
        const lessonData = {
            title: "Unit 2: Appearance",
            subtitle: "The Beauty of Ugly Food & Skin Deep üçé üíÑ",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-goals', text: 'üéØ Learning Roadmap (W.H.E.R.E.T.O.)', color: 'slate', target: 'goals-intro' },
                { id: 'menu-2a-intro', text: 'üçé 2A: The Beauty of Ugly Food', color: 'green', target: '2a-intro' },
                { id: 'menu-2b-intro', text: 'üíÑ 2B: Skin Deep (Culture)', color: 'rose', target: '2b-intro' },
                { id: 'menu-grasps', text: 'üèÜ GRASPS Performance Task', color: 'amber', target: 'grasps-task' },
                { id: 'menu-projects', text: 'üöÄ Active Learning Menu', color: 'blue', target: 'project-menu' },
                { id: 'menu-plenary', text: 'ü§î Plenary & Reflection', color: 'teal', target: 'final-plenary' },
            ],
            // Combined Vocab for Unit 2A and 2B
            vocabulary: [
                { word: 'Aesthetic', ipa: '/iÀêsÀàŒ∏…õt…™k/', def: 'Concerned with beauty.', sentence: 'Supermarkets prioritize aesthetic appeal over taste.' },
                { word: 'Discard', ipa: '/d…™Ààsk…ëÀêrd/', def: 'To get rid of something.', sentence: 'Farmers discard vegetables that are the wrong shape.' },
                { word: 'Landfill', ipa: '/Ààl√¶ndf…™l/', def: 'A place to dispose of waste.', sentence: 'Food waste in landfills produces methane.' },
                { word: 'Perception', ipa: '/p…ôrÀàs…õp É…ôn/', def: 'The way something is understood.', sentence: 'Marketing changes our perception of beauty.' },
                { word: 'Sustainable', ipa: '/s…ôÀàste…™n…ôb…ôl/', def: 'Able to be maintained.', sentence: 'Buying ugly food is a sustainable choice.' },
                { word: 'Conform', ipa: '/k…ônÀàf…îÀêrm/', def: 'To comply with rules or standards.', sentence: 'Teens feel pressure to conform to beauty trends.' },
                { word: 'Industrial', ipa: '/…™nÀàd åstri…ôl/', def: 'Relating to factories.', sentence: 'The Industrial Revolution changed work habits.' },
                { word: 'Leisure', ipa: '/ÀàliÀê í…ôr/', def: 'Free time.', sentence: 'Tanned skin became a sign of leisure time.' },
                { word: 'Status', ipa: '/Ààste…™t…ôs/', def: 'Social or professional position.', sentence: 'Skin color has been a marker of social status.' },
                { word: 'Ultraviolet', ipa: '/Àå åltr…ôÀàva…™…ôl…ôt/', def: 'Invisible light causing tanning.', sentence: 'UV rays can damage skin cells.' }
            ],
            pages: [
                // --- GOALS ---
                { id: 'goals-intro', type: 'simple', content: { 
                    title: 'Learning Roadmap', 
                    text: `
                    <div class="pedagogy-box"><span class="pedagogy-title">W.H.E.R.E.T.O. Framework</span>
                    <strong>W (Where):</strong> Analyze aesthetic standards in food and humans.<br>
                    <strong>H (Hook):</strong> Why do we reject "ugly" apples but accept "ugly" people?<br>
                    <strong>E (Equip):</strong> 20 Academic Keywords & Critical Theory.<br>
                    <strong>O (Organize):</strong> Harkness Debates & Persuasive Pitches.<br>
                    </div>
                    <ul class="list-disc list-inside text-left space-y-2 mt-4">
                        <li><strong>Objective:</strong> Trace historical shifts in beauty standards (pale vs. tanned).</li>
                        <li><strong>Outcome:</strong> Evaluate the ethics of "perfection" in supermarkets and media.</li>
                        <li><strong>Essential Question:</strong> To what extent are "beauty" definitions socially constructed?</li>
                    </ul>
                    ` 
                }},

                // --- 2A: UGLY FOOD ---
                { id: '2a-intro', type: 'simple', content: { title: '2A: Ugly Food üçé', text: '<strong>Hook:</strong> Which apple would you buy? A shiny, waxed one or a bumpy one with a spot?<br><strong>Fact:</strong> 1/3 of all food is wasted, often just because it looks "wrong".' } },
                
                { id: '2a-vocab', type: 'vocab-list', content: { title: '2A Vocabulary', words: [] } }, // Populated dynamically

                { id: '2a-reading', type: 'tiered-reading', content: { 
                    title: '2A: The Ugly Truth',
                    texts: {
                        'A2': "<h3>A Big Waste (A2)</h3><p>Every year, the world throws away a lot of food. Almost one-third of all food is never eaten. One reason is that we want our food to look perfect.</p><p><strong>Looking Good vs. Tasting Good:</strong> Supermarkets have strict rules called 'aesthetic standards'. They only buy fruits that are the right size and color. If a carrot is crooked, they reject it. Farmers must discard this edible food into landfills.</p><p><strong>Changing Minds:</strong> In France, a campaign called 'Inglorious Fruits' sold ugly food cheaper. It showed that ugly food tastes just as good.</p>",
                        'B1': "<h3>The Global Food Waste Crisis (B1)</h3><p>Nearly one-third of all food produced globally is wasted, often ending up in landfills and releasing greenhouse gases. A major cause is the strict <strong>aesthetic standards</strong> demanded by supermarkets.</p><p><strong>The Tyranny of Beauty:</strong> Retailers believe consumers only buy 'perfect' produce. If a cucumber is too curved, it is rejected. Consequently, farmers discard tons of nutritious food.</p><p><strong>Shifting Perception:</strong> Campaigns like 'Inglorious Fruits' in France aim to change perception. By selling imperfect items at a discount, they prove that appearance does not affect taste.</p>",
                        'B2': "<h3>The Environmental Cost of Perfectionism (B2)</h3><p>Global food security is threatened by a staggering inefficiency: one-third of agricultural output is squandered annually. A pernicious cause is the retail sector's rigid insistence on visual uniformity. </p><p><strong>Aesthetic Standards as Barriers:</strong> Supermarkets enforce stringent criteria for size and shape. Produce that deviates‚Äîa bifurcated carrot or blemished pear‚Äîis deemed unmarketable. This forces producers to discard viable inventory.</p><p><strong>Re-evaluating Value:</strong> The 'Ugly Food' movement seeks to destigmatize imperfection. It argues that embracing 'misfits' is an ethical imperative for a sustainable food system.</p>"
                    }
                }},

                { id: '2a-gap', type: 'quiz-gap-fill', content: { title: '2A: Gap Fill', sentences: [
                    { text: ['Supermarkets have strict', 'standards for produce.'], answer: 'aesthetic' },
                    { text: ['Farmers must', 'vegetables that are the wrong shape.'], answer: 'discard' },
                    { text: ['Ugly produce is just as', 'as perfect produce.'], answer: 'nutritious' },
                    { text: ['Buying ugly food is a more', 'choice for the planet.'], answer: 'sustainable' },
                    { text: ['The campaign aims to change consumer', '.'], answer: 'perception' }
                ], wordBank: ['aesthetic', 'discard', 'nutritious', 'sustainable', 'perception'] }},

                { id: '2a-tf', type: 'quiz-tfng', content: { title: '2A: True/False', questions: [
                    { statement: 'Most food waste happens because food is rotten.', correctAnswer: 'False' },
                    { statement: 'Aesthetic standards refer to nutritional value.', correctAnswer: 'False' },
                    { statement: 'Crooked carrots have fewer vitamins.', correctAnswer: 'False' },
                    { statement: 'Food rotting in landfills produces harmful gases.', correctAnswer: 'True' }
                ]}},

                { id: '2a-mcq', type: 'quiz-mcq', content: { title: '2A: Multiple Choice', questions: [
                    { question: 'What is the main cause of waste discussed?', options: ['Lack of fridges', 'Supermarket aesthetic standards', 'Farmers being lazy'], correctAnswer: 'Supermarket aesthetic standards' },
                    { question: 'What does "discard" mean?', options: ['To eat', 'To sell', 'To throw away'], correctAnswer: 'To throw away' },
                    { question: 'What was the goal of the French campaign?', options: ['To ban apples', 'To sell ugly food', 'To close farms'], correctAnswer: 'To sell ugly food' }
                ]}},

                { id: '2a-dialogue', type: 'dialogue', content: { 
                    title: 'Roleplay: The Skeptical Shopper', 
                    dialogue: `Person A: Look at these carrots. They are all twisted and strange looking. I'm not buying these.

Person B: I understand why you feel that way, but you have to consider that they taste exactly the same as straight carrots.

Person A: That may be true, but if I'm paying full price, I expect them to look good. They look damaged.

Person B: I see it differently. They aren't damaged, just different. If we don't buy them, the supermarket discards them to a landfill.

Person A: Really? They just throw them away? That seems wasteful.

Person B: Exactly. It's not sustainable. By choosing these, we reduce waste.` 
                }},

                // --- 2B: SKIN DEEP ---
                { id: '2b-intro', type: 'simple', content: { title: '2B: Skin Deep üíÑ', text: '<strong>Hook:</strong> Why do some people want a tan while others want to be pale?<br><strong>Focus:</strong> How history, class, and the Industrial Revolution shaped beauty standards.' } },

                { id: '2b-vocab', type: 'vocab-list', content: { title: '2B Vocabulary', words: [] } }, // Populated dynamically

                { id: '2b-reading', type: 'tiered-reading', content: { 
                    title: '2B: The Color of Status',
                    texts: {
                        'A2': "<h3>Old Ideas (A2)</h3><p>For a long time, being pale was beautiful in Europe and Asia. It showed you were rich and didn't work outside.</p><p><strong>A Big Change:</strong> After the Industrial Revolution, poor people worked inside factories and got pale. Rich people went on vacation and got tans. Coco Chanel made tanning fashionable in the 1920s.</p><p><strong>Modern Dangers:</strong> Today, Westerners use tanning beds (UV rays), while Asians use whitening creams. Both can be dangerous.</p>",
                        'B1': "<h3>The Historical Marker of Wealth (B1)</h3><p>Historically, pale skin was desirable because it associated the person with wealth‚Äîthey didn't have to do manual labor in the sun.</p><p><strong>The Industrial Shift:</strong> The Industrial Revolution flipped this. Workers moved into factories and became pale. The wealthy began enjoying leisure time outdoors. When Coco Chanel returned from a cruise with a tan, it became a trend symbolizing health and wealth.</p><p><strong>Global Industry:</strong> Today, the West has a tanning industry (risking skin cancer from UV), while Asia has a whitening industry (risking toxic chemicals). Both capitalize on insecurity.</p>",
                        'B2': "<h3>Skin Tone as Socioeconomic Signifier (B2)</h3><p>For centuries, pigmentation functioned as a signifier of status. A pallid complexion was intrinsically linked to aristocracy, visual proof of exemption from arduous outdoor labor.</p><p><strong>The Inversion:</strong> The Industrial Revolution precipitated a profound inversion. As the proletariat migrated to sunless factories, pallor became associated with poverty. Conversely, the leisure class adopted outdoor pursuits. The tan became an emblem of disposable income.</p><p><strong>Divergent Paths:</strong> Contemporary norms manifest divergently, yet both represent the commodification of dissatisfaction. Western tanning drives melanoma rates, while Asian skin-lightening perpetuates colorism.</p>"
                    }
                }},

                { id: '2b-gap', type: 'quiz-gap-fill', content: { title: '2B: Gap Fill', sentences: [
                    { text: ['Pale skin was historically', 'with wealth.'], answer: 'associated' },
                    { text: ['The', 'Revolution changed how people worked.'], answer: 'Industrial' },
                    { text: ['A tan became a sign of', 'time and money.'], answer: 'leisure' },
                    { text: ['Tanning beds use', 'rays that damage skin.'], answer: 'ultraviolet' },
                    { text: ['Teens feel pressure to', 'to beauty standards.'], answer: 'conform' }
                ], wordBank: ['associated', 'Industrial', 'leisure', 'ultraviolet', 'conform'] }},

                { id: '2b-tf', type: 'quiz-tfng', content: { title: '2B: True/False', questions: [
                    { statement: 'Pale skin has always been the standard in the West.', correctAnswer: 'False' },
                    { statement: 'Coco Chanel helped make tanning popular.', correctAnswer: 'True' },
                    { statement: 'The Industrial Revolution made poor people more tanned.', correctAnswer: 'False' },
                    { statement: 'Whitening creams are always safe.', correctAnswer: 'False' }
                ]}},

                { id: '2b-mcq', type: 'quiz-mcq', content: { title: '2B: Multiple Choice', questions: [
                    { question: 'Why was pale skin desirable in the past?', options: ['It was healthier', 'It showed you were rich', 'It was easier to paint'], correctAnswer: 'It showed you were rich' },
                    { question: 'What caused the shift to tanning?', options: ['Sunscreen', 'The Industrial Revolution', 'Global Warming'], correctAnswer: 'The Industrial Revolution' },
                    { question: 'What do both industries have in common?', options: ['They promote health', 'They profit from insecurity', 'They are free'], correctAnswer: 'They profit from insecurity' }
                ]}},

                { id: '2b-dialogue', type: 'dialogue', content: { 
                    title: 'Roleplay: Cultural Exchange', 
                    dialogue: `Person A: I've noticed so many advertisements for skin whitening creams here. It's very different from back home.

Person B: Really? What is it like where you are from?

Person A: Well, in my country, being tanned is considered very desirable. People spend hours sunbathing to get darker. They associate it with looking healthy.

Person B: That's interesting. Historically, here in Asia, pale skin was a sign of high status because it meant you didn't have to work in the fields.

Person A: That used to be true in Europe too, before the Industrial Revolution. It seems like the trends flipped.

Person B: Yes, but now both sides have problems. We worry about toxic chemicals, and you worry about UV exposure.` 
                }},

                // --- GRASPS ---
                { id: 'grasps-task', type: 'simple', content: { 
                    title: 'üèÜ GRASPS Task: Sustainability Consultant', 
                    text: `
                    <div class="text-left space-y-3">
                        <p><strong>Goal:</strong> Persuade a supermarket to sell "Imperfect Picks".</p>
                        <p><strong>Role:</strong> Sustainability Consultant.</p>
                        <p><strong>Audience:</strong> Board of Directors.</p>
                        <p><strong>Situation:</strong> The store rejects edible food based on looks. Waste is high.</p>
                        <p><strong>Product:</strong> A 3-minute pitch + 1 Poster.</p>
                        <div class="bg-yellow-50 p-3 rounded text-sm">
                            <strong>Rubric (KASEC):</strong> Knowledge (aesthetic vs nutrition), Analysis (env impact), Structure (problem-solution), Evidence (text facts), Clarity.
                        </div>
                    </div>
                    ` 
                }},

                // --- PROJECTS ---
                { id: 'project-menu', type: 'simple', content: {
                    title: 'Active Learning Menu',
                    text: `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                        <div class="project-card bg-rose-100 p-4 rounded-lg">
                            <strong>PBL: Marketing Campaign</strong><br>Design a "Zero Waste Week" for the school canteen challenging aesthetic standards.
                        </div>
                        <div class="project-card bg-blue-100 p-4 rounded-lg">
                            <strong>Inquiry: Media Analysis</strong><br>Compare 5 Western vs 5 Asian beauty ads. Analyze the keywords used.
                        </div>
                        <div class="project-card bg-purple-100 p-4 rounded-lg">
                            <strong>Experiential: Blind Taste Test</strong><br>Taste a "perfect" apple vs an "ugly" one blindfolded. Does perception change taste?
                        </div>
                        <div class="project-card bg-green-100 p-4 rounded-lg">
                            <strong>Problem-Based: The Farmer</strong><br>A hail storm dented 40% of the crop. Develop a business plan to save the farmer.
                        </div>
                    </div>
                    `
                }},

                // --- PLENARY ---
                { id: 'final-plenary', type: 'simple', content: { 
                    title: 'Plenary: So What? Now What?', 
                    text: `
                    <div class="text-left space-y-4">
                        <p><strong>So What?</strong> We learned that billions of tons of food and millions of dollars are wasted on arbitrary standards of beauty.</p>
                        <p><strong>Now What?</strong> Identify one specific change you will make when shopping or viewing media.</p>
                        <hr>
                        <strong>Self-Assessment:</strong>
                        <ul class="list-disc list-inside">
                            <li>Did you find yourself defending a viewpoint you didn't originally hold?</li>
                            <li>How did you ensure respect when discussing cultural beauty standards?</li>
                        </ul>
                    </div>
                    ` 
                }}
            ]
        };

        // --- SPEECH SERVICE ---
        class SpeechService {
             constructor() { this.synth = window.speechSynthesis; this.isInitialized = false; this.isTtsEnabled = true; this.voices = {}; this.speechRate = 0.85; }
             async _setupVoices() {
                 const voicesPromise = new Promise(resolve => { if (this.synth.getVoices().length) return resolve(this.synth.getVoices()); this.synth.onvoiceschanged = () => resolve(this.synth.getVoices()); });
                 const availableVoices = await voicesPromise;
                 const findVoice = (name) => availableVoices.find(v => v.name.includes(name) && v.name.includes('Natural')) || availableVoices.find(v => v.name.includes(name));
                 this.voices = {
                     'person a': findVoice('Andrew') || availableVoices[0],
                     'person b': findVoice('Ava') || availableVoices[0],
                     'default': findVoice('Ava') || availableVoices[0]
                 };
             }
             async init() { if (this.isInitialized) return; await this._setupVoices(); this.isInitialized = true; }
             _cleanTextForSpeech(text) { const tempDiv = document.createElement('div'); tempDiv.innerHTML = text.replace(/<span aria-hidden="true">.*?<\/span>/g, ' '); return tempDiv.innerText || tempDiv.textContent || ''; }
             speak(text) { if (!this.isTtsEnabled || !text) return; this.cancel(); const utterance = new SpeechSynthesisUtterance(this._cleanTextForSpeech(text)); utterance.voice = this.voices['default']; utterance.rate = this.speechRate; this.synth.speak(utterance); }
             speakDialogue(text) { if (!this.isTtsEnabled || !text) return; this.cancel(); const lines = text.split('\n\n'); const speakLine = (index) => { if (index >= lines.length) return; const line = lines[index]; const [speaker, ...rest] = line.split(': '); const lineText = rest.join(': '); const utterance = new SpeechSynthesisUtterance(this._cleanTextForSpeech(lineText || speaker)); const key = speaker.toLowerCase().trim(); utterance.voice = this.voices[key] || this.voices['default']; utterance.rate = this.speechRate; utterance.onend = () => speakLine(index + 1); this.synth.speak(utterance); }; speakLine(0); }
             cancel() { this.synth.cancel(); }
             toggleTTS() { this.isTtsEnabled = !this.isTtsEnabled; if(!this.isTtsEnabled) this.cancel(); return this.isTtsEnabled; }
         }

        // --- CORE LOGIC ---
        const speechService = new SpeechService();
        let score = 0, currentPage = lessonData.startPageId;
        const pageHistory = [lessonData.startPageId];
        
        // Populate Vocab Lists dynamically
        lessonData.pages.find(p => p.id === '2a-vocab').content.words = lessonData.vocabulary.slice(0, 5);
        lessonData.pages.find(p => p.id === '2b-vocab').content.words = lessonData.vocabulary.slice(5, 10);

        function getPageSequence() {
            return ['title-screen', 'goals-intro', 
                    '2a-intro', '2a-vocab', '2a-reading', '2a-gap', '2a-tf', '2a-mcq', '2a-dialogue',
                    '2b-intro', '2b-vocab', '2b-reading', '2b-gap', '2b-tf', '2b-mcq', '2b-dialogue',
                    'grasps-task', 'project-menu', 'final-plenary'];
        }
        let pageSequence = getPageSequence();

        window.startApp = async function() {
            await speechService.init();
            try { await Tone.start(); } catch(e){}
            navigateTo(lessonData.homePageId);
        }

        window.navigateTo = (pageId) => {
            const target = document.getElementById(`page-${pageId}`);
            if (!target) return;
            speechService.cancel();
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            target.classList.add('active');
            currentPage = pageId;
            if (pageHistory[pageHistory.length - 1] !== pageId) pageHistory.push(pageId);
            
            const pageDef = lessonData.pages.find(p => p.id === pageId);
            if (pageDef) {
                if (pageDef.type === 'dialogue') speechService.speakDialogue(pageDef.content.dialogue);
                else if (pageDef.type === 'tiered-reading') {
                    const activeTab = target.querySelector('.reading-content:not(.hidden)');
                    if(activeTab) speechService.speak(activeTab.innerText);
                } else {
                    const h2 = target.querySelector('h2');
                    const p = target.querySelector('p'); 
                    const text = (h2 ? h2.innerText : '') + '. ' + (p ? p.innerText : '');
                    speechService.speak(text);
                }
            }
            updateNavButtons();
            window.scrollTo(0,0);
        }

        window.goBack = () => { if(pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); } }
        window.goNext = () => { 
            const idx = pageSequence.indexOf(currentPage);
            if(idx > -1 && idx < pageSequence.length - 1) navigateTo(pageSequence[idx+1]);
            else navigateTo(lessonData.homePageId);
        }
        window.toggleTTS = (btn) => {
            const enabled = speechService.toggleTTS();
            btn.classList.toggle('bg-blue-100', enabled);
            btn.classList.toggle('bg-gray-200', !enabled);
            if(enabled) navigateTo(currentPage); 
        }

        // --- RENDER FUNCTIONS ---
        function createPageElement(id, html) {
            const sec = document.createElement('section');
            sec.id = `page-${id}`;
            sec.className = 'page';
            sec.innerHTML = html;
            document.getElementById('dynamic-pages-container').appendChild(sec);
        }

        function renderPages() {
            // Render Main Menu
            const menuBtns = lessonData.mainMenu.map(item => `
                <button onclick="navigateTo('${item.target}')" class="btn-animated-3d bg-${item.color}-500 text-white font-bold text-lg p-4 rounded-xl w-full text-left shadow-md hover:bg-${item.color}-600 border-b-4 border-${item.color}-700 active:border-b-0 active:translate-y-1 transition-all">
                    ${item.text}
                </button>
            `).join('');
            createPageElement(lessonData.homePageId, `
                <div class="bg-white rounded-3xl shadow-lg p-8 border border-slate-100">
                    <h2 class="text-3xl font-bold text-center text-slate-800 mb-6">Unit Map</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${menuBtns}</div>
                </div>
            `);

            // Render Lesson Pages
            lessonData.pages.forEach(page => {
                let html = '';
                const wrapper = (content) => `<div class="bg-white rounded-3xl shadow-lg p-6 md:p-8 pt-12 border border-slate-100 relative overflow-hidden">${content}</div>`;
                
                if (page.type === 'simple') {
                    html = wrapper(`<h2 class="text-3xl font-bold text-slate-800 mb-4">${page.content.title}</h2><div class="text-xl text-slate-600 leading-relaxed">${page.content.text}</div>`);
                } else if (page.type === 'vocab-list') {
                    const list = page.content.words.map(w => `<div class="bg-slate-50 p-3 rounded-lg border-l-4 border-rose-500"><div class="flex justify-between items-baseline"><strong class="text-rose-700 text-lg">${w.word}</strong><span class="text-sm text-gray-500 font-mono">${w.ipa}</span></div><p class="text-slate-600 italic mt-1 text-sm">${w.def}</p><p class="text-slate-800 mt-2 text-sm">"${w.sentence}"</p></div>`).join('');
                    html = wrapper(`<h2 class="text-3xl font-bold text-slate-800 mb-6">${page.content.title}</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${list}</div>`);
                } else if (page.type === 'tiered-reading') {
                    html = wrapper(`
                        <h2 class="text-3xl font-bold text-slate-800 mb-4">${page.content.title}</h2>
                        <div class="flex justify-center gap-2 mb-6">
                            ${['A2','B1','B2'].map(lvl => `<button onclick="switchTier('${page.id}', '${lvl}')" class="tier-btn px-4 py-2 rounded-full font-bold ${lvl==='B1'?'active':''} text-sm">${lvl}</button>`).join('')}
                        </div>
                        <div id="content-${page.id}-A2" class="reading-content hidden text-lg leading-relaxed text-slate-700 bg-amber-50 p-4 rounded-xl border-l-4 border-amber-400">${page.content.texts['A2']}</div>
                        <div id="content-${page.id}-B1" class="reading-content text-lg leading-relaxed text-slate-700 bg-blue-50 p-4 rounded-xl border-l-4 border-blue-400">${page.content.texts['B1']}</div>
                        <div id="content-${page.id}-B2" class="reading-content hidden text-lg leading-relaxed text-slate-700 bg-emerald-50 p-4 rounded-xl border-l-4 border-emerald-400">${page.content.texts['B2']}</div>
                    `);
                } else if (page.type === 'dialogue') {
                    const lines = page.content.dialogue.split('\n\n').map(l => {
                        const [speaker, text] = l.split(': ');
                        const isLeft = ['person a'].includes(speaker.toLowerCase());
                        return `<div class="dialogue-bubble ${isLeft ? 'bubble-left' : 'bubble-right'}"><strong class="text-sm uppercase tracking-wide text-slate-500 mb-1 block">${speaker}</strong><p>${text}</p></div>`;
                    }).join('');
                    html = wrapper(`<h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">${page.content.title}</h2><div class="space-y-4">${lines}</div>`);
                } else if (page.type.includes('quiz')) {
                    let qHtml = '';
                    if (page.type === 'quiz-gap-fill') {
                        const sentences = page.content.sentences.map((s,i) => `<p class="mb-4 text-lg">${i+1}. ${s.text[0]} <span class="gap" data-answer="${s.answer}" ondrop="drop(event)" ondragover="allowDrop(event)"></span> ${s.text[1]||''}</p>`).join('');
                        const words = page.content.wordBank.map(w => `<div class="word-bank-word inline-block m-1" draggable="true" ondragstart="drag(event)" data-word="${w}">${w}</div>`).join('');
                        qHtml = `<div class="gap-fill-container">${sentences}</div><div class="bg-slate-100 p-4 rounded-xl mt-6 flex flex-wrap gap-2 justify-center border border-slate-200">${words}</div>`;
                    } else if (page.type === 'quiz-mcq') {
                        qHtml = page.content.questions.map((q,i) => `
                            <div class="mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <p class="font-bold text-lg mb-3">${i+1}. ${q.question}</p>
                                <div class="grid gap-2">${q.options.map(opt => `<button onclick="checkMCQ(this, ${opt===q.correctAnswer})" class="quiz-option w-full text-left p-3 rounded-lg bg-white border border-slate-200 hover:bg-blue-50">${opt}</button>`).join('')}</div>
                            </div>`).join('');
                    } else if (page.type === 'quiz-tfng') {
                        qHtml = page.content.questions.map((q,i) => `
                            <div class="mb-4 p-4 bg-slate-50 rounded-xl border border-slate-200 flex flex-col sm:flex-row items-center justify-between gap-3">
                                <p class="font-medium text-lg flex-1">${q.statement}</p>
                                <div class="flex gap-2">${['True','False'].map(opt => `<button onclick="checkTF(this, '${opt}', '${q.correctAnswer}')" class="tfng-button px-4 py-2 bg-white border border-slate-200 rounded-lg font-bold text-sm hover:bg-blue-50">${opt}</button>`).join('')}</div>
                            </div>`).join('');
                    }
                    html = wrapper(`<h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">${page.content.title}</h2>${qHtml}`);
                }
                createPageElement(page.id, html);
            });
        }

        // --- HELPER FUNCTIONS ---
        window.switchTier = (pageId, tier) => {
            const page = document.getElementById(`page-${pageId}`);
            page.querySelectorAll('.reading-content').forEach(d => d.classList.add('hidden'));
            page.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
            page.querySelector(`#content-${pageId}-${tier}`).classList.remove('hidden');
            Array.from(page.querySelectorAll('.tier-btn')).find(b => b.innerText === tier).classList.add('active');
            speechService.speak(page.querySelector(`#content-${pageId}-${tier}`).innerText);
        }

        window.updateNavButtons = () => {
            const nav = document.getElementById('nav-header');
            if (currentPage === 'title-screen') nav.style.display = 'none';
            else nav.style.display = 'block';
        }

        // --- DRAG & DROP / QUIZ LOGIC ---
        window.allowDrop = (ev) => ev.preventDefault();
        window.drag = (ev) => ev.dataTransfer.setData("text", ev.target.dataset.word);
        window.drop = (ev) => {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const target = ev.target;
            if(target.classList.contains('gap') && !target.hasChildNodes()) {
                const wordEl = document.querySelector(`.word-bank-word[data-word="${data}"]`);
                target.appendChild(wordEl);
                checkGap(target);
            }
        }
        
        function checkGap(gap) {
            const word = gap.innerText.trim();
            const correct = gap.dataset.answer;
            if(word.toLowerCase() === correct.toLowerCase()) {
                gap.classList.add('correct');
                addPoints(10);
                playTone('C5');
            } else {
                gap.classList.add('incorrect');
                playTone('C3');
                setTimeout(() => gap.classList.remove('incorrect'), 1000);
            }
        }

        window.checkMCQ = (btn, isCorrect) => {
            const parent = btn.parentElement;
            Array.from(parent.children).forEach(c => c.disabled = true);
            if(isCorrect) {
                btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                addPoints(10);
                playTone('C5');
            } else {
                btn.classList.add('bg-red-100', 'border-red-500', 'shake');
                playTone('C3');
            }
        }

        window.checkTF = (btn, val, correct) => {
             const parent = btn.parentElement;
             Array.from(parent.children).forEach(c => c.disabled = true);
             if(val === correct) {
                 btn.classList.add('bg-green-500', 'text-white');
                 addPoints(10);
                 playTone('C5');
             } else {
                 btn.classList.add('bg-red-500', 'text-white');
                 playTone('C3');
             }
        }

        function addPoints(pts) { score += pts; document.getElementById('score-display').innerText = score; }
        function playTone(note) { try { const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease(note, "8n"); } catch(e){} }

        // Init
        renderPages();
    </script>
</body>
</html>
