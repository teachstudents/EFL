import React, { useState, useEffect, useRef } from 'react';
import { Play, Square, RefreshCw, Check, X, Map as MapIcon, BookOpen, Clock, Calendar, Phone, DollarSign, Navigation, Mail, Ruler, Users, List, MessageCircle, Trophy, Sparkles } from 'lucide-react';

// --- CONFIGURATION ---
const SPEECH_RATE = 0.85; // Slowed down for secondary students
const TOTAL_QUESTIONS_PER_ROUND = 10;

// --- AUDIO FX ---
const playSoundFx = (type) => {
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!AudioContext) return;
  
  const ctx = new AudioContext();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  
  osc.connect(gain);
  gain.connect(ctx.destination);

  if (type === 'correct') {
    const now = ctx.currentTime;
    osc.type = 'sine';
    osc.frequency.setValueAtTime(523.25, now); // C5
    osc.frequency.setValueAtTime(659.25, now + 0.1); // E5
    osc.frequency.setValueAtTime(783.99, now + 0.2); // G5
    
    gain.gain.setValueAtTime(0.1, now);
    gain.gain.linearRampToValueAtTime(0, now + 0.5);
    
    osc.start(now);
    osc.stop(now + 0.5);
  } else {
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(150, ctx.currentTime);
    osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
    osc.start();
    osc.stop(ctx.currentTime + 0.3);
  }
};

// --- UTILITIES ---

const PRAISES = ["Brilliant!", "Spot on!", "Excellent!", "Perfect!", "Well done!", "Fantastic!"];

const checkAnswer = (user, correct, type) => {
  if (!user) return false;
  const u = user.toLowerCase().trim().replace(/[\s-]/g, '');
  const c = correct.toString().toLowerCase().trim().replace(/[\s-]/g, '');
  
  if (u === c) return true;
  
  // Specific checks
  if (type === 'price') return u.includes(c) || c.includes(u);
  if (type === 'time') return u.replace('.',':') === c.replace('.',':');
  if (type === 'measurement') return u === c || u === c.replace(/meters|cms|kgs/, '').trim();
  
  return false;
};

// --- EXPANDED DATA ---

const NAMES = [
  'Weston', 'Bailey', 'Patterson', 'Jenkins', 'Martinez', 'Sutherland', 'Blackwood', 'Yates', 'Oliver', 'Franklin', 
  'Davidson', 'Holloway', 'Redgrave', 'Winchester', 'Kensington', 'Barrington', 'Stephenson', 'Macdonald', 'Fletcher', 'Underwood',
  'Whitmore', 'Ellington', 'Armstrong', 'Fairchild', 'Harrington', 'Lancaster', 'Montgomery', 'Pennington', 'Remington', 'Wellington'
];

const STREETS = [
  'Green', 'Broad', 'Church', 'Kings', 'Queens', 'North', 'West', 'Oak', 'Pine', 'Cedar', 'Maple', 
  'High', 'Station', 'Victoria', 'Albert', 'Chestnut', 'Market', 'Bridge', 'Park', 'Garden', 'Forest', 'River', 'Lake', 'Hill'
];

const EVENTS = ['conference', 'seminar', 'workshop', 'meeting', 'lecture', 'tutorial', 'exam', 'ceremony', 'orientation', 'interview'];

const FURNITURE = ['desk', 'sofa', 'table', 'bookshelf', 'cabinet', 'wardrobe', 'mirror', 'rug', 'armchair', 'lamp'];

const TRAIN_DESTINATIONS = ['London', 'Birmingham', 'Manchester', 'Leeds', 'Newcastle', 'Edinburgh', 'Bristol', 'Cardiff', 'Liverpool', 'Glasgow'];

const PRICE_ITEMS = ['ticket', 'membership', 'textbook', 'course fee', 'registration', 'locker deposit', 'printing card', 'excursion'];
const TRANSPORT = ['bus', 'train', 'taxi', 'shuttle', 'tram', 'ferry', 'bicycle', 'coach'];
const DESTINATIONS = ['airport', 'city center', 'university', 'stadium', 'museum', 'harbour', 'central station', 'town hall'];

const generateQuestion = (category) => {
  const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
  const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  let q = { category, type: category.id };

  switch (category.id) {
    case 1: // Names & Spelling
      const surname = rand(NAMES);
      const spelling = surname.split('').join('... ');
      q.stem = "Write the correct spelling of the surname.";
      q.answer = surname;
      q.script = [
        { speaker: 'A', text: `Can I have your surname for the form, please?` },
        { speaker: 'B', text: `Yes, it's ${surname}.` },
        { speaker: 'A', text: `Could you spell that for me?` },
        { speaker: 'B', text: `Certainly. It is ${spelling}.` },
        { speaker: 'A', text: `${spelling}. Thank you.` } // Repetition
      ];
      break;

    case 2: // Phone / ID
      const p1 = randInt(100, 999);
      const p2 = randInt(1000, 9999);
      const wrongP2 = p2 + randInt(1, 9);
      q.stem = "Write the phone number.";
      q.answer = `07${p1} ${p2}`;
      q.script = [
        { speaker: 'A', text: `What's the best contact number for you?` },
        { speaker: 'B', text: `Well, my old number was 07${p1} ${wrongP2}, but I've lost that phone.` },
        { speaker: 'A', text: `Oh, I see. So what is the current one?` },
        { speaker: 'B', text: `It is 07${p1} ${p2}.` },
        { speaker: 'A', text: `07${p1} ${p2}. Got it.` } // Repetition
      ];
      break;

    case 3: // Dates
      const month = rand(['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']);
      const day = randInt(10, 28);
      const event = rand(EVENTS);
      q.stem = `On what date will the ${event} take place?`;
      q.answer = `${day}th ${month}`;
      q.script = [
        { speaker: 'A', text: `Shall we book the venue for the ${day - 5}th of ${month}?` },
        { speaker: 'B', text: `I'm afraid it's fully booked then.` },
        { speaker: 'B', text: `The only date available for the ${event} is the ${day}th of ${month}.` },
        { speaker: 'A', text: `Okay, let's go with the ${day}th of ${month} then.` } 
      ];
      break;

    case 4: // Times
      const hr = randInt(2, 10);
      const min = rand([15, 30, 45, 10, 20, 40, 50]);
      const dest = rand(TRAIN_DESTINATIONS);
      q.stem = `What time does the train to ${dest} leave?`;
      q.answer = `${hr}:${min}`;
      q.script = [
        { speaker: 'A', text: `Does the train to ${dest} leave at ${hr} o'clock?` },
        { speaker: 'B', text: `No, that's the slow train.` },
        { speaker: 'B', text: `The express departs at ${hr}:${min}.` },
        { speaker: 'A', text: `Right, ${hr}:${min}. I'd better hurry.` } 
      ];
      break;

    case 5: // Schedules
      const open = randInt(7, 9);
      const close = randInt(4, 6);
      const facility = rand(['library', 'gym', 'computer lab', 'cafeteria', 'health center', 'reception']);
      q.stem = `When does the ${facility} close?`;
      q.answer = `${close} pm`;
      q.script = [
        { speaker: 'A', text: `I need to use the ${facility} later.` },
        { speaker: 'B', text: `Well, we open at ${open} am.` },
        { speaker: 'A', text: `And how late do you stay open?` },
        { speaker: 'B', text: `We usually close at ${close} pm.` },
        { speaker: 'A', text: `${close} pm. Okay, thanks.` } 
      ];
      break;

    case 6: // Prices
      const base = randInt(10, 50);
      const discount = base - 5;
      const item = rand(PRICE_ITEMS);
      q.stem = `How much does the ${item} cost for students?`;
      q.answer = `£${discount}`;
      q.script = [
        { speaker: 'A', text: `How much is the ${item}?` },
        { speaker: 'B', text: `The standard price is £${base}.` },
        { speaker: 'A', text: `I have a valid student card.` },
        { speaker: 'B', text: `Ah, in that case, it's reduced to £${discount}.` },
        { speaker: 'A', text: `Lovely, £${discount}. Here you go.` } 
      ];
      break;

    case 7: // Travel
      const mins = rand([25, 35, 45, 55]);
      const transport = rand(TRANSPORT);
      const destPlace = rand(DESTINATIONS);
      q.stem = `How long does it take to get to the ${destPlace} by ${transport}?`;
      q.answer = `${mins} minutes`;
      q.script = [
        { speaker: 'A', text: `Is it far to the ${destPlace}?` },
        { speaker: 'B', text: `If you walk, it's over an hour.` },
        { speaker: 'A', text: `What about the ${transport}?` },
        { speaker: 'B', text: `The ${transport} is quicker. It takes about ${mins} minutes.` },
        { speaker: 'A', text: `Okay, ${mins} minutes isn't too bad.` } 
      ];
      break;

    case 8: // Addresses
      const num = randInt(1, 99);
      const street = rand(STREETS);
      const type = rand(['Road', 'Street', 'Lane', 'Avenue', 'Drive', 'Close']);
      q.stem = "What is the address?";
      q.answer = `${num} ${street} ${type}`;
      q.script = [
        { speaker: 'A', text: `Where should I deliver the package?` },
        { speaker: 'B', text: `To number ${num}, ${street} ${type}.` },
        { speaker: 'A', text: `Did you say ${street} Court?` },
        { speaker: 'B', text: `No, ${street} ${type}. Like the tree.` },
        { speaker: 'A', text: `Number ${num}, ${street} ${type}. Noted.` } 
      ];
      break;

    case 9: // Emails
      const name = rand(['info', 'admin', 'sales', 'help', 'jobs', 'events', 'media', 'staff']);
      const domain = rand(['gym', 'school', 'shop', 'club', 'tech', 'arts', 'uni']);
      const tld = rand(['com', 'net', 'org', 'uk', 'edu']);
      
      q.stem = "Write down the email address.";
      q.answer = `${name}@${domain}.${tld}`;
      
      const spellName = name.toUpperCase().split('').join('-');
      const spellDomain = domain.toUpperCase().split('').join('-');
      
      q.script = [
        { speaker: 'A', text: `Where should I send the documents?` },
        { speaker: 'B', text: `Please email them to ${name} at ${domain} dot ${tld}.` },
        { speaker: 'A', text: `Sorry, could you spell that?` },
        { speaker: 'B', text: `Sure. It is ${spellName}, at symbol, ${spellDomain}, dot ${tld}.` },
        { speaker: 'A', text: `${name}@${domain}.${tld}. I've sent it.` } 
      ];
      break;

    case 10: // Measurements
      const val = rand([1.5, 2.4, 3.8, 5.2, 0.75, 10.5]);
      const dimension = rand(['width', 'height', 'depth', 'length']);
      const obj = rand(FURNITURE);
      q.stem = `What is the ${dimension} of the ${obj}?`;
      q.answer = `${val} meters`;
      q.script = [
        { speaker: 'A', text: `Will this ${obj} fit in my room?` },
        { speaker: 'B', text: `It's quite large.` },
        { speaker: 'B', text: `I don't have the full dimensions, but the ${dimension} is ${val} meters.` },
        { speaker: 'A', text: `Okay, I'll note that down: ${val} meters ${dimension}.` } 
      ];
      break;

    case 11: // Quantities
      const total = randInt(15, 100);
      const present = total - randInt(2, 10);
      const group = rand(['students', 'delegates', 'members', 'applicants', 'tourists']);
      q.stem = `How many ${group} actually attended?`;
      q.answer = `${present}`;
      q.script = [
        { speaker: 'A', text: `Did the event go well?` },
        { speaker: 'B', text: `Yes, we had ${total} ${group} sign up initially.` },
        { speaker: 'A', text: `That's a good turnout.` },
        { speaker: 'B', text: `However, a few cancelled, so only ${present} actually attended.` },
        { speaker: 'A', text: `Ah, ${present}. Still a decent number.` } 
      ];
      break;

    case 12: // Map Locations
      const locations = ['Library', 'Cafe', 'Gym', 'Main Hall'];
      const target = rand(locations);
      const locs = locations.filter(l => l !== target);
      const ref = locs[0];
      
      let prep = "";
      let desc = "";
      
      if (Math.random() > 0.5) {
        prep = "Next to";
        desc = `It is immediately next to the ${ref}.`;
      } else {
        prep = "Opposite";
        desc = `It is directly opposite the ${ref}, on the other side of the path.`;
      }

      q.stem = `Where is the ${target}?`;
      q.answer = `${prep} ${ref}`;
      q.isMap = true;
      q.target = target;
      q.ref = ref;
      q.script = [
        { speaker: 'A', text: `Excuse me, I'm looking for the ${target}.` },
        { speaker: 'B', text: `Right. Do you see the ${ref}?` },
        { speaker: 'A', text: `Yes, I see it.` },
        { speaker: 'B', text: `${desc}` },
        { speaker: 'A', text: `${prep} the ${ref}. Thanks!` } 
      ];
      break;

    case 13: // Options
      const opts = ['A', 'B', 'C'];
      const choice = rand(opts);
      const subject = rand(['plan', 'route', 'package', 'design']);
      q.stem = `Which ${subject} (A, B, or C) does the speaker choose?`;
      q.answer = choice;
      q.script = [
        { speaker: 'A', text: `We have three ${subject}s available.` },
        { speaker: 'A', text: `Option A is cheap but basic. Option B is premium but pricey.` },
        { speaker: 'B', text: `What about Option C?` },
        { speaker: 'A', text: `It's a good balance of both.` },
        { speaker: 'B', text: `Okay, I'll go with Option ${choice} then.` },
        { speaker: 'A', text: `Option ${choice}, excellent choice.` } 
      ];
      break;

    case 14: // Facts & Opinions
      const topics = ['food', 'weather', 'hotel', 'lecture', 'concert', 'exhibition', 'service'];
      const topic = rand(topics);
      const isPositive = Math.random() > 0.5;
      q.stem = `What is the speaker's opinion of the ${topic}? (Good/Bad)`;
      q.answer = isPositive ? "Good" : "Bad";
      
      let text = "";
      if (isPositive) text = "I was worried at first, but actually, it exceeded my expectations. Very pleasant.";
      else text = "I had high hopes, but honestly, it was a letdown. Quite disappointing.";

      q.script = [
        { speaker: 'A', text: `What did you think of the ${topic}?` },
        { speaker: 'B', text: text },
        { speaker: 'A', text: `So it was ${isPositive ? 'good' : 'bad'} then?` }, 
        { speaker: 'B', text: `Yes, exactly.` }
      ];
      break;
      
    default: break;
  }
  
  return q;
};

const CATEGORIES = [
  { id: 1, name: "Names & Spelling", icon: <BookOpen className="w-5 h-5" /> },
  { id: 2, name: "Phone / ID", icon: <Phone className="w-5 h-5" /> },
  { id: 3, name: "Dates", icon: <Calendar className="w-5 h-5" /> },
  { id: 4, name: "Times", icon: <Clock className="w-5 h-5" /> },
  { id: 5, name: "Schedules", icon: <List className="w-5 h-5" /> },
  { id: 6, name: "Prices", icon: <DollarSign className="w-5 h-5" /> },
  { id: 7, name: "Travel Details", icon: <Navigation className="w-5 h-5" /> },
  { id: 8, name: "Addresses", icon: <MapIcon className="w-5 h-5" /> },
  { id: 9, name: "Emails", icon: <Mail className="w-5 h-5" /> },
  { id: 10, name: "Measurements", icon: <Ruler className="w-5 h-5" /> },
  { id: 11, name: "Quantities", icon: <Users className="w-5 h-5" /> },
  { id: 12, name: "Map Locations", icon: <MapIcon className="w-5 h-5" /> },
  { id: 13, name: "Options", icon: <Check className="w-5 h-5" /> },
  { id: 14, name: "Facts & Opinions", icon: <MessageCircle className="w-5 h-5" /> },
];

// --- COMPONENTS ---

const Confetti = () => {
  return (
    <div className="absolute inset-0 pointer-events-none overflow-hidden z-50">
      {[...Array(20)].map((_, i) => (
        <div
          key={i}
          className="absolute w-2 h-2 bg-yellow-400 rounded-full animate-confetti"
          style={{
            left: `${Math.random() * 100}%`,
            top: `${Math.random() * 50}%`,
            backgroundColor: ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1'][Math.floor(Math.random() * 4)],
            animationDelay: `${Math.random() * 0.5}s`,
            animationDuration: `${0.5 + Math.random()}s`
          }}
        />
      ))}
    </div>
  );
};

const MapVisual = () => (
  <div className="bg-slate-100 border-2 border-slate-300 rounded-xl p-4 mb-4 relative h-64 w-full">
    <div className="absolute top-2 left-2 text-xs font-bold text-slate-400">NORTH ↑</div>
    
    <div className="grid grid-cols-2 gap-8 h-full">
       <div className="bg-blue-100 border-2 border-blue-300 rounded flex items-center justify-center font-bold text-blue-800">Gym</div>
       <div className="bg-red-100 border-2 border-red-300 rounded flex items-center justify-center font-bold text-red-800">Cafe</div>
       <div className="bg-green-100 border-2 border-green-300 rounded flex items-center justify-center font-bold text-green-800">Library</div>
       <div className="bg-purple-100 border-2 border-purple-300 rounded flex items-center justify-center font-bold text-purple-800">Main Hall</div>
    </div>
    
    <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
      <div className="bg-white px-2 py-1 rounded border border-slate-200 shadow-sm text-xs font-bold text-slate-500">Path</div>
    </div>
  </div>
);

export default function IELTSDetailDrills() {
  const [activeCat, setActiveCat] = useState(CATEGORIES[0]);
  const [question, setQuestion] = useState(null);
  const [input, setInput] = useState('');
  const [status, setStatus] = useState('idle'); 
  const [feedback, setFeedback] = useState('');
  const [praisePhrase, setPraisePhrase] = useState('');
  const [isPlaying, setIsPlaying] = useState(false);
  const [voices, setVoices] = useState([]);
  
  const [roundScore, setRoundScore] = useState(0);
  const [questionsLeft, setQuestionsLeft] = useState(TOTAL_QUESTIONS_PER_ROUND);

  const isCancelled = useRef(false);

  useEffect(() => {
     const initVoices = () => {
       const vs = window.speechSynthesis.getVoices();
       setVoices(vs);
     };
     initVoices();
     window.speechSynthesis.onvoiceschanged = initVoices;
  }, []);

  // --- STRICT VOICE SELECTION (EDGE MULTILINGUAL ONLY) ---
  const getVoicePair = () => {
    // Filter strictly for the specific Microsoft Edge voices requested
    const edgeVoices = voices.filter(v => 
      v.name.includes('Ava') || 
      v.name.includes('Brian') || 
      v.name.includes('Emma') || 
      v.name.includes('Andrew')
    );

    // If we found the target voices, restrict selection to ONLY these
    const targetPool = edgeVoices.length > 0 ? edgeVoices : voices;

    // Split into gender pools based on names if possible, otherwise random
    const females = targetPool.filter(v => v.name.includes('Ava') || v.name.includes('Emma') || v.name.includes('Female'));
    const males = targetPool.filter(v => v.name.includes('Brian') || v.name.includes('Andrew') || v.name.includes('Male'));

    // Fallback for safety if gender pools empty (rare if targetPool has items)
    const fPool = females.length > 0 ? females : targetPool;
    const mPool = males.length > 0 ? males : targetPool;

    const female = fPool[Math.floor(Math.random() * fPool.length)] || voices[0];
    const male = mPool[Math.floor(Math.random() * mPool.length)] || voices[0];

    return Math.random() > 0.5 ? { A: female, B: male } : { A: male, B: female };
  };

  const speakScript = async (script) => {
    isCancelled.current = false;
    setIsPlaying(true);
    window.speechSynthesis.cancel();
    
    const { A, B } = getVoicePair();
    
    // If voices aren't ready yet, retry shortly
    if (!A || !B) {
      setTimeout(() => speakScript(script), 500);
      return;
    }
    
    for (let line of script) {
      if (isCancelled.current) break;
      
      await new Promise(resolve => {
        const utt = new SpeechSynthesisUtterance(line.text);
        utt.voice = line.speaker === 'A' ? A : B;
        utt.rate = SPEECH_RATE; 
        utt.pitch = 1;
        utt.lang = 'en-GB';
        
        utt.onend = () => setTimeout(resolve, 500); 
        utt.onerror = () => resolve();
        window.speechSynthesis.speak(utt);
      });
    }
    setIsPlaying(false);
  };

  const stopAudio = () => {
    isCancelled.current = true;
    window.speechSynthesis.cancel();
    setIsPlaying(false);
  };

  const newQuestion = () => {
    stopAudio();
    if (questionsLeft <= 0) {
      setRoundScore(0);
      setQuestionsLeft(TOTAL_QUESTIONS_PER_ROUND);
    }
    const q = generateQuestion(activeCat);
    setQuestion(q);
    setInput('');
    setStatus('idle');
    setFeedback('');
    setPraisePhrase('');
  };

  const switchCategory = (cat) => {
    stopAudio();
    setActiveCat(cat);
    setRoundScore(0);
    setQuestionsLeft(TOTAL_QUESTIONS_PER_ROUND);
  };

  const handleCheck = (e) => {
    e.preventDefault();
    stopAudio();
    
    const isCorrect = checkAnswer(input, question.answer, question.type === 6 ? 'price' : (question.type === 4 ? 'time' : 'text'));
    
    if (isCorrect) {
      setStatus('correct');
      setRoundScore(prev => prev + 1);
      playSoundFx('correct');
      setPraisePhrase(PRAISES[Math.floor(Math.random() * PRAISES.length)]);
      setFeedback('Correct!');
    } else {
      setStatus('incorrect');
      playSoundFx('incorrect');
      setFeedback(`Incorrect. Answer: ${question.answer}`);
    }
    
    setQuestionsLeft(prev => Math.max(0, prev - 1));
  };

  useEffect(() => {
    newQuestion();
  }, [activeCat]);

  useEffect(() => () => stopAudio(), []);

  return (
    <div className="fixed inset-0 bg-slate-50 font-sans text-slate-800 flex flex-col md:flex-row overflow-hidden">
      
      {/* SIDEBAR */}
      <div className="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 md:h-full h-auto max-h-[25vh] md:max-h-full overflow-y-auto">
        <div className="p-2 space-y-1">
          {CATEGORIES.map(cat => (
            <button
              key={cat.id}
              onClick={() => switchCategory(cat)}
              className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-bold transition-all ${activeCat.id === cat.id ? 'bg-blue-50 text-blue-700 border border-blue-200 shadow-sm' : 'text-slate-600 hover:bg-slate-50 border border-transparent'}`}
            >
              {cat.icon}
              {cat.name}
            </button>
          ))}
        </div>
      </div>

      {/* MAIN AREA */}
      <div className="flex-1 flex flex-col h-full overflow-hidden relative">
        
        {/* HEADER */}
        <header className="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-sm z-10">
          <div className="flex items-center gap-2">
             <div className="p-2 bg-blue-100 text-blue-600 rounded-lg">{activeCat.icon}</div>
             <div>
               <h2 className="font-bold text-lg leading-none">{activeCat.name}</h2>
               <p className="text-xs text-slate-400 font-medium mt-1">Practice Mode</p>
             </div>
          </div>

          {/* SCOREBOARD */}
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2 bg-green-50 border border-green-200 px-3 py-1.5 rounded-lg">
              <Trophy className="w-4 h-4 text-green-600" />
              <div className="flex flex-col leading-none">
                <span className="text-[10px] font-bold text-green-600 uppercase">Correct</span>
                <span className="text-lg font-black text-green-800">{roundScore}</span>
              </div>
            </div>
            <div className="flex items-center gap-2 bg-slate-100 border border-slate-200 px-3 py-1.5 rounded-lg">
              <List className="w-4 h-4 text-slate-500" />
              <div className="flex flex-col leading-none">
                <span className="text-[10px] font-bold text-slate-500 uppercase">Left</span>
                <span className="text-lg font-black text-slate-700">{questionsLeft}</span>
              </div>
            </div>
          </div>

          <button 
            onClick={newQuestion}
            className="hidden md:flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-bold text-sm transition-colors"
          >
            <RefreshCw className="w-4 h-4" /> Skip
          </button>
        </header>

        {/* WORKSPACE */}
        <div className="flex-1 overflow-y-auto p-4 md:p-8 max-w-3xl mx-auto w-full pb-16">
          
          {question ? (
            <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
              
              {/* QUESTION CARD */}
              <div className="bg-white rounded-2xl shadow-sm border-2 border-slate-200 p-6 md:p-8 relative overflow-hidden">
                <div className="absolute top-0 left-0 w-2 h-full bg-blue-500"></div>
                
                {status === 'correct' && <Confetti />}

                <span className="inline-block px-3 py-1 rounded-full bg-slate-100 text-slate-500 text-xs font-black uppercase tracking-wider mb-4 border border-slate-200">
                  Question Stem
                </span>
                
                <h3 className="text-2xl font-black text-slate-800 mb-6">
                  "{question.stem}"
                </h3>

                {question.type === 12 && <MapVisual />}

                {/* CONTROLS */}
                <div className="flex items-center gap-4 mb-8">
                  {!isPlaying ? (
                    <button 
                      onClick={() => speakScript(question.script)}
                      className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white pl-5 pr-6 py-3 rounded-full font-bold text-lg shadow-[0_4px_0_rgb(29,78,216)] active:shadow-none active:translate-y-1 transition-all w-full md:w-auto justify-center"
                    >
                      <Play className="fill-current w-5 h-5" /> Listen
                    </button>
                  ) : (
                    <button 
                      onClick={stopAudio}
                      className="flex items-center gap-2 bg-red-500 hover:bg-red-400 text-white pl-5 pr-6 py-3 rounded-full font-bold text-lg shadow-[0_4px_0_rgb(185,28,28)] active:shadow-none active:translate-y-1 transition-all w-full md:w-auto justify-center"
                    >
                      <Square className="fill-current w-5 h-5" /> Stop
                    </button>
                  )}
                </div>

                {/* INPUT */}
                <form onSubmit={handleCheck} className="relative">
                   <input 
                     type="text" 
                     value={input}
                     onChange={(e) => setInput(e.target.value)}
                     placeholder="Type your answer..."
                     disabled={status === 'correct' || status === 'incorrect'}
                     className={`w-full bg-slate-50 border-2 rounded-xl px-5 py-4 text-xl font-bold outline-none transition-all ${status === 'correct' ? 'border-green-500 text-green-700 bg-green-50' : status === 'incorrect' ? 'border-red-500 text-red-700 bg-red-50' : 'border-slate-300 focus:border-blue-500 focus:bg-white'}`}
                   />
                   <button 
                     type="submit"
                     disabled={!input || status !== 'idle'}
                     className="absolute right-2 top-2 bottom-2 bg-slate-800 disabled:opacity-20 disabled:cursor-not-allowed hover:bg-slate-700 text-white px-6 rounded-lg font-bold transition-all"
                   >
                     Check
                   </button>
                </form>

                {/* FEEDBACK */}
                {status !== 'idle' && (
                  <div className={`mt-6 p-4 rounded-xl border-2 flex items-start gap-3 animate-in zoom-in-95 duration-300 ${status === 'correct' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                    {status === 'correct' ? <div className="bg-green-200 p-2 rounded-full"><Sparkles className="w-6 h-6 shrink-0 text-green-700" /></div> : <X className="w-6 h-6 shrink-0 mt-1" />}
                    <div className="flex-1">
                      <p className="font-black text-xl flex items-center gap-2">
                        {status === 'correct' ? praisePhrase : 'Incorrect'}
                      </p>
                      <p className="text-sm opacity-90 mt-1 font-medium">
                        {status === 'correct' ? 'Great job! Moving to transcript...' : `The correct answer was: ${question.answer}`}
                      </p>
                      
                      {questionsLeft > 0 && (
                        <button 
                          onClick={newQuestion}
                          className={`mt-3 text-sm font-bold px-4 py-2 rounded-lg flex items-center gap-2 transition-colors ${status === 'correct' ? 'bg-green-200 hover:bg-green-300 text-green-900' : 'bg-red-200 hover:bg-red-300 text-red-900'}`}
                        >
                          Next Question <RefreshCw className="w-3 h-3" />
                        </button>
                      )}
                    </div>
                  </div>
                )}

              </div>

              {/* TRANSCRIPT */}
              {(status === 'correct' || status === 'incorrect') && (
                <div className="bg-slate-100 rounded-2xl border-2 border-slate-200 p-6 md:p-8 animate-in fade-in duration-500">
                  <div className="flex items-center gap-2 mb-4 text-slate-400">
                    <MessageCircle className="w-4 h-4" />
                    <span className="text-xs font-black uppercase tracking-widest">Transcript</span>
                  </div>
                  <div className="space-y-4">
                    {question.script.map((line, idx) => (
                      <div key={idx} className="flex gap-4">
                        <div className={`w-8 h-8 shrink-0 rounded-full flex items-center justify-center font-bold text-sm ${line.speaker === 'A' ? 'bg-white border-2 border-slate-200 text-slate-600' : 'bg-slate-800 text-white'}`}>
                          {line.speaker}
                        </div>
                        <div className="bg-white p-3 rounded-lg rounded-tl-none border border-slate-200 shadow-sm">
                          <p className="text-slate-700 font-medium leading-relaxed">
                            {line.text}
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

            </div>
          ) : (
            // ROUND COMPLETE STATE
            <div className="flex flex-col items-center justify-center h-full py-12 text-center animate-in zoom-in-95">
              <div className="bg-yellow-100 p-6 rounded-full mb-6">
                <Trophy className="w-16 h-16 text-yellow-600" />
              </div>
              <h2 className="text-3xl font-black text-slate-800 mb-2">Round Complete!</h2>
              <p className="text-slate-500 font-medium mb-8">You scored {roundScore} out of {TOTAL_QUESTIONS_PER_ROUND}</p>
              <button 
                onClick={() => { setRoundScore(0); setQuestionsLeft(TOTAL_QUESTIONS_PER_ROUND); newQuestion(); }}
                className="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-blue-500 shadow-xl transition-all"
              >
                Start New Round
              </button>
            </div>
          )}

        </div>
      </div>
      
      <style>{`
        @keyframes confetti {
          0% { transform: translateY(0) rotate(0deg); opacity: 1; }
          100% { transform: translateY(100px) rotate(720deg); opacity: 0; }
        }
        .animate-confetti {
          animation-name: confetti;
          animation-timing-function: ease-out;
          animation-fill-mode: forwards;
        }
      `}</style>
    </div>
  );
}
