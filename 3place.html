<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Classroom Quiz Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            animation: backgroundShift 30s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0% { background: linear-gradient(45deg, #556cd6 0%, #5a3f8f 100%); }
            25% { background: linear-gradient(45deg, #e080e8 0%, #e04560 100%); }
            50% { background: linear-gradient(45deg, #2f8ed6 0%, #008fbf 100%); }
            75% { background: linear-gradient(45deg, #2fa15f 0%, #1f8f8f 100%); }
            100% { background: linear-gradient(45deg, #556cd6 0%, #5a3f8f 100%); }
        }

        .laser-beam {
            position: absolute;
            width: 4px;
            height: 200px;
            background: linear-gradient(to bottom, transparent, #00ffff, transparent);
            animation: laserMove 3s linear infinite;
            opacity: 0.7;
        }

        @keyframes laserMove {
            0% { transform: translateX(-100px) translateY(-100px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(calc(100vw + 100px)) translateY(100vh); opacity: 0; }
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 15px;
            position: relative;
            z-index: 10;
            justify-content: space-between;
        }

        .bottom-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 15px;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .progress-section {
            flex: 1;
            margin: 0 15px;
        }

        .progress-bar {
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb);
            border-radius: 15px;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-emoji {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            animation: bounce 0.5s ease-in-out infinite alternate;
        }

        @keyframes bounce {
            0% { transform: translateY(-50%) scale(1); }
            100% { transform: translateY(-50%) scale(1.2); }
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            background: linear-gradient(145deg, #d64545, #a83232);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .players-section {
            display: none;
        }

        .player-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .player-name {
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            line-height: 1.2;
        }

        .player-score {
            font-size: 14px;
            font-weight: 600;
            color: #ffd700;
            text-align: center;
            margin-top: 2px;
        }

        .player-stats {
            display: flex;
            gap: 8px;
            margin-top: 5px;
            font-size: 12px;
            color: #eee;
        }

        .player-streak {
            background: rgba(255, 165, 0, 0.3);
            padding: 2px 6px;
            border-radius: 8px;
            display: none; /* Hidden by default */
        }

        .player-badges {
            display: flex;
            gap: 2px;
        }

        .question-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .question-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .game-area {
            display: flex;
            flex: 1;
            gap: 15px;
            align-items: flex-start;
            margin-top: 20px;
            justify-content: center;
        }

        .choices-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            max-width: 33%;
        }

        .choice-button {
            background: linear-gradient(145deg, #4a5fd1, #5a3f8f);
            border: none;
            border-radius: 12px;
            padding: 5px 5px;
            font-size: 22px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0px #3a4a9f;
            position: relative;
            overflow: hidden;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-break: break-word;
            line-height: 1.1;
            text-transform: lowercase; /* Lowercase as requested */
        }

        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0px #3a4a9f;
            filter: brightness(1.1);
        }

        .choice-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0px #3a4a9f;
        }

        .choice-button.correct {
            animation: correctAnswer 4s ease-in-out;
            background: linear-gradient(145deg, #2fa15f, #1f8f8f);
            box-shadow: 0 4px 0px #1a7a4f;
        }

        .choice-button.incorrect {
            animation: incorrectAnswer 2s ease-in-out;
            background: linear-gradient(145deg, #d64545, #a83232);
            box-shadow: 0 4px 0px #8f2222;
        }

        @keyframes correctAnswer {
            0% { transform: scale(1); }
            10% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes incorrectAnswer {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .sparkle { position: absolute; width: 10px; height: 10px; background: #ffd700; border-radius: 50%; animation: sparkle 1s ease-out forwards; pointer-events: none; }
        @keyframes sparkle { 0% { opacity: 1; transform: scale(0); } 50% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0); } }
        .token { position: absolute; width: 20px; height: 20px; background: linear-gradient(45deg, #ffd700, #ffed4e); border-radius: 50%; border: 2px solid #ff6b6b; font-size: 12px; font-weight: bold; color: #333; display: flex; align-items: center; justify-content: center; animation: tokenFly 2s ease-out forwards; pointer-events: none; z-index: 1000; }
        @keyframes tokenFly { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.5); } }
        
        .leaderboard, .learning-phase, .name-shuffle {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.98); padding: 40px; border-radius: 30px; text-align: center; font-size: 24px; color: #333; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); z-index: 1000; display: none;
        }
        .name-shuffle { width: 80%; max-width: 800px; }
        .shuffle-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 30px; min-height: 200px; align-items: center; }
        .shuffle-name { padding: 10px 15px; background: linear-gradient(145deg, #667eea, #764ba2); color: white; border-radius: 10px; font-size: 16px; font-weight: 600; transition: all 0.3s ease; }
        .shuffle-name.selected { background: linear-gradient(145deg, #43e97b, #38f9d7); transform: scale(1.2); box-shadow: 0 0 20px #43e97b; }
        .selected-players { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .selected-player { background: linear-gradient(145deg, #f093fb, #f5576c); color: white; padding: 15px; border-radius: 15px; font-size: 18px; font-weight: 700; }

        .round-info-display {
            color: white; font-size: 18px; font-weight: 600; background: rgba(255, 255, 255, 0.2); padding: 8px 16px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.3); text-align: center; white-space: nowrap;
        }

        .main-menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .menu-container { background: rgba(255, 255, 255, 0.95); padding: 60px; border-radius: 30px; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .menu-title { font-size: 48px; font-weight: 700; color: #333; margin-bottom: 20px; }
        .grade-buttons { display: flex; gap: 20px; justify-content: center; }
        .grade-btn { background: linear-gradient(145deg, #4a5fd1, #5a3f8f); border: none; border-radius: 20px; padding: 20px 40px; font-size: 24px; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .grade-btn:hover { transform: translateY(-5px); }

        .fireworks, .winner-firework, .celebration-burst { pointer-events: none; position: absolute; }
        
        /* Glitter CSS */
        .glitter {
            position: absolute;
            width: 8px;
            height: 8px;
            background: linear-gradient(45deg, #ff69b4, #00ffff, #ffd700, #ff4757);
            border-radius: 50%;
            animation: glitterFloat 2s ease-out forwards;
            pointer-events: none;
            z-index: 2000;
        }

        @keyframes glitterFloat {
            0% { opacity: 1; transform: scale(0) rotate(0deg); }
            25% { opacity: 1; transform: scale(1.5) rotate(90deg); }
            50% { opacity: 0.8; transform: scale(1) rotate(180deg); }
            75% { opacity: 0.6; transform: scale(1.2) rotate(270deg); }
            100% { opacity: 0; transform: scale(0) rotate(360deg); }
        }
        
        /* Targeted Feedback Styles - Only animate correct button for specific player */
        .active-player-correct {
            animation: correctAnswer 4s ease-in-out;
            background: linear-gradient(145deg, #2fa15f, #1f8f8f) !important;
            box-shadow: 0 4px 0px #1a7a4f !important;
        }
        
        .active-player-incorrect {
            animation: incorrectAnswer 2s ease-in-out;
            background: linear-gradient(145deg, #d64545, #a83232) !important;
            box-shadow: 0 4px 0px #8f2222 !important;
        }
        
        /* Streak Indicator specific to this player */
        .streak-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, #FFD700, #FFA000);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
            animation: streakGlow 1s ease-in-out infinite alternate;
            border: 2px solid #FFF;
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div class="main-menu" id="mainMenu">
        <div class="menu-container">
            <h1 class="menu-title">üèôÔ∏è Place & Activity Quiz</h1>
            <h2 class="menu-subtitle">Select Your Grade</h2>
            <div class="grade-buttons">
                <button class="grade-btn" onclick="selectGrade(10)">Grade 10</button>
                <button class="grade-btn" onclick="selectGrade(11)">Grade 11</button>
                <button class="grade-btn" onclick="selectGrade(12)">Grade 12</button>
            </div>
        </div>
    </div>

    <div class="game-container" id="gameContainer" style="display: none;">
        <!-- Question Section (Hidden) -->
        <div class="question-section" style="display: none;">
            <div class="question-title" id="questionTitle"></div>
        </div>
        
        <!-- Global Streak Indicator (kept for big streaks, but individual stats are under players) -->
        <div class="streak-indicator" id="streakIndicator">
            üî• Streak: <span id="streakCount">0</span>
        </div>

        <!-- Game Area (Answer Buttons & Players) -->
        <div class="game-area">
            <div class="choices-column">
                <button class="choice-button" onclick="selectAnswer(0)">school</button>
                <button class="choice-button" onclick="selectAnswer(1)">park</button>
                <button class="choice-button" onclick="selectAnswer(2)">bank</button>
                <button class="choice-button" onclick="selectAnswer(3)">cinema</button>
                <div class="player-container">
                    <div class="player-name" id="player1">Player 1</div>
                    <div class="player-score" id="score1">0 points</div>
                    <div class="player-stats">
                        <div class="player-streak" id="streak1"></div>
                        <div class="player-badges" id="badges1"></div>
                    </div>
                </div>
            </div>

            <div class="choices-column">
                <button class="choice-button" onclick="selectAnswer(4)">library</button>
                <button class="choice-button" onclick="selectAnswer(5)">museum</button>
                <button class="choice-button" onclick="selectAnswer(6)">hospital</button>
                <button class="choice-button" onclick="selectAnswer(7)">cafe</button>
                <div class="player-container">
                    <div class="player-name" id="player2">Player 2</div>
                    <div class="player-score" id="score2">0 points</div>
                    <div class="player-stats">
                        <div class="player-streak" id="streak2"></div>
                        <div class="player-badges" id="badges2"></div>
                    </div>
                </div>
            </div>

            <div class="choices-column">
                <button class="choice-button" onclick="selectAnswer(8)">stadium</button>
                <button class="choice-button" onclick="selectAnswer(9)">airport</button>
                <button class="choice-button" onclick="selectAnswer(10)">gym</button>
                <button class="choice-button" onclick="selectAnswer(11)">mall</button>
                <div class="player-container">
                    <div class="player-name" id="player3">Player 3</div>
                    <div class="player-score" id="score3">0 points</div>
                    <div class="player-stats">
                        <div class="player-streak" id="streak3"></div>
                        <div class="player-badges" id="badges3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Controls (Timer, Menu, Round) -->
        <div class="bottom-section">
            <div class="control-buttons">
                <button class="control-btn" onclick="backToMenu()">üè† Menu</button>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">
                        <div class="progress-emoji" id="progressEmoji">üè´</div>
                    </div>
                </div>
            </div>
            <div class="round-info-display">
                <span id="roundDisplay">Round 1 of 8</span> | Questions Left: <span id="questionsLeft">10</span>
            </div>
        </div>
    </div>

    <!-- Overlays -->
    <div class="leaderboard" id="leaderboard">
        <h2>üèÜ Round Complete! üèÜ</h2>
        <div id="leaderboardContent"></div>
        <div id="globalLeaderboardContent" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
            <h3>üåü Global Leaderboard üåü</h3>
            <div id="globalScores"></div>
        </div>
        <div style="margin-top: 20px; font-size: 16px; color: #666;">Next round starting automatically in 5 seconds...</div>
    </div>

    <div class="learning-phase" id="learningPhase">
        <div id="learningContent"></div>
    </div>

    <div class="name-shuffle" id="nameShuffle">
        <h2 class="shuffle-title">Selecting Players...</h2>
        <div class="shuffle-container" id="shuffleContainer"></div>
        <div class="selected-players" id="selectedPlayers"></div>
    </div>

    <script>
        // ========================================
        // üìö STUDENT NAMES
        // ========================================
        const studentsByGrade = {
            10: [
                "ÂÜØÂ•ïÂ∞ò / FENG, YICHEN", "ÈªÑËã•Ê∂µ / HUANG, RUOHAN", "Êùé‰∏∞Â±π / LI, FENGYI", 
                "ÊùéÈπèÊΩû / LI, PENGLU", "Ê¢ÅÈî¶Â§© / LING, JINTIAN", "ÂàòÊôØÊâ¨ / LIU, JINGYANG",
                "Èæô‰øäÂøó / LONG, JUNZHI", "È©¨Ëµ´ / MA, HE", "ËÅÇÊ∫™Â∫∑ / NIE, XIKANG",
                "Â∫û‰∫ëËîö / PANG, YUNWEI", "Êõ≤ÂÆ∂Áëû / QU, JIARUI", "Â≠ôËØóÁ´• / SUN, SHITONG",
                "ÁéãÂ≠êË®Ä / WANG, ZIYAN", "ËµµÊµ©Áê≥ / Howlin", "Âº†ÂÆ∏ÊÅ∫ / ZHANG, CHENKAI",
                "ËµµÊµ©Êñá / ZHAO, HAOWEN",
            ],
            11: [
                "Êü¥ÂçìÁë∂ / Iris", "Êùé‰πãÁî® / Max", "Êûó‰∫ëÊõ¶ / Cathy",
                "ÂàòÁèÇÂê´ / Sandy", "È™ÜÊ¢¶‰πî / Vicky", "ÂÆãÊòäËΩ© / Jim",
                "ÂêëÂÆ∂ÊÖï / Jackie", "ÂæêÂòâÁÅè / Jay", "Êù®È¶•ÂÆÅ / Grace",
                "Âº†‰∏éÂçì / Emily", "ËµµÂçÉÊ¢¶ / Rhea"
            ],
            12: [
                "ÂÆâÊîøËÅø / AN, ZHENGYU", "Ëî°Â≠êÂ¢® / CAI, ZIMO", "ÂàòÈïáÊ¶ï / LIU, ZHENRONG",
                "È©¨Áü•Ë°å / MA, ZHIXING", "ÈÇ±Â§© / QIU, TIAN", "ÁõõÊÄùËØ≠ / SHENG, SIYU",
                "ÂîêÂèØÁõà / TANG, KEYING", "Áî∞Â≠êÂá° / TIAN, ZIFAN", "Ë∞¢ÊñØÈ£û / XIE, SIFEI",
                "Êù®Âä†È∫í / YANG, JIAQI", "Âº†Á®ãÁöì / ZHANG, CHENGHAO", "ËµµÊô®ËææÈë´ / ZHAO, CHENDAXIN",
                "Âë®ÈÄ∏Âá° / ZHOU, YIFAN"
            ]
        };

        // ========================================
        // üéØ PLACE DATABASE
        // ========================================
        
        const easyPlaces = [
            { id: "school", display: "School", spoken: "School", activity: "learn, study, or attend classes" },
            { id: "park", display: "Park", spoken: "Park", activity: "walk, play, or have a picnic" },
            { id: "library", display: "Library", spoken: "Library", activity: "read books and study quietly" },
            { id: "bank", display: "Bank", spoken: "Bank", activity: "deposit money or withdraw cash" },
            { id: "hospital", display: "Hospital", spoken: "Hospital", activity: "receive medical care or visit a doctor" },
            { id: "restaurant", display: "Restaurant", spoken: "Restaurant", activity: "eat a meal and enjoy food" },
            { id: "supermarket", display: "Supermarket", spoken: "Supermarket", activity: "buy groceries and household items" },
            { id: "cinema", display: "Cinema", spoken: "Cinema", activity: "watch a new movie" },
            { id: "gym", display: "Gym", spoken: "Gym", activity: "exercise, train, and lift weights" },
            { id: "cafe", display: "Caf√©", spoken: "Caf√©", activity: "drink coffee and relax" },
            { id: "zoo", display: "Zoo", spoken: "Zoo", activity: "see animals and learn about wildlife" },
            { id: "beach", display: "Beach", spoken: "Beach", activity: "swim and play in the sand" }, 
            { id: "bakery", display: "Bakery", spoken: "Bakery", activity: "buy fresh bread and cakes" },
            { id: "pharmacy", display: "Pharmacy", spoken: "Pharmacy", activity: "buy medicine and get health advice" },
            { id: "pool", display: "Swimming Pool", spoken: "Swimming Pool", activity: "swim and exercise in the water" }
        ];

        const mediumPlaces = [
            { id: "post_office", display: "Post Office", spoken: "Post Office", activity: "send letters and buy stamps" },
            { id: "police_station", display: "Police Station", spoken: "Police Station", activity: "report a crime or seek help" },
            { id: "museum", display: "Museum", spoken: "Museum", activity: "view exhibits and learn history" },
            { id: "fire_station", display: "Fire Station", spoken: "Fire Station", activity: "get help for an emergency" },
            { id: "hotel", display: "Hotel", spoken: "Hotel", activity: "stay overnight and rest" },
            { id: "theater", display: "Theater", spoken: "Theater", activity: "watch a play or performance" },
            { id: "stadium", display: "Stadium", spoken: "Stadium", activity: "watch a sports match or concert" },
            { id: "train_station", display: "Train Station", spoken: "Train Station", activity: "travel by rail or buy tickets" },
            { id: "airport", display: "Airport", spoken: "Airport", activity: "fly to a destination" },
            { id: "bus_station", display: "Bus Station", spoken: "Bus Station", activity: "catch a bus to another city" },
            { id: "mall", display: "Mall", spoken: "Mall", activity: "shop, eat, and meet friends" },
            { id: "university", display: "University", spoken: "University", activity: "attend lectures and research" },
            { id: "church", display: "Church", spoken: "Church", activity: "pray and attend services" },
            { id: "market", display: "Market", spoken: "Market", activity: "buy fresh food and meet people" },
            { id: "playground", display: "Playground", spoken: "Playground", activity: "swing, slide, and play games" }
        ];

        const hardPlaces = [
            { id: "observatory", display: "Observatory", spoken: "Observatory", activity: "watch stars and study planets" },
            { id: "laboratory", display: "Laboratory", spoken: "Laboratory", activity: "conduct experiments and research" },
            { id: "courthouse", display: "Courthouse", spoken: "Courthouse", activity: "attend a trial or seek justice" },
            { id: "lighthouse", display: "Lighthouse", spoken: "Lighthouse", activity: "guide ships and view the sea" },
            { id: "harbor", display: "Harbor", spoken: "Harbor", activity: "dock boats and go fishing" },
            { id: "factory", display: "Factory", spoken: "Factory", activity: "produce goods and work shifts" },
            { id: "aquarium", display: "Aquarium", spoken: "Aquarium", activity: "see fish and marine life" },
            { id: "gallery", display: "Art Gallery", spoken: "Art Gallery", activity: "view paintings and sculptures" },
            { id: "town_hall", display: "Town Hall", spoken: "Town Hall", activity: "attend meetings and get documents" },
            { id: "warehouse", display: "Warehouse", spoken: "Warehouse", activity: "store goods and manage inventory" },
            { id: "workshop", display: "Workshop", spoken: "Workshop", activity: "build, repair, and craft items" },
            { id: "office", display: "Office", spoken: "Office", activity: "work and meet colleagues" },
            { id: "farm", display: "Farm", spoken: "Farm", activity: "grow crops and raise animals" },
            { id: "clinic", display: "Clinic", spoken: "Clinic", activity: "get a checkup and treatment" },
            { id: "temple", display: "Temple", spoken: "Temple", activity: "meditate and worship" }
        ];

        // ========================================
        // üìù CONVERSATION TEMPLATES
        // ========================================
        
        const conversationTemplates = {
            easy: {
                templates: [
                    "I need to {activity}. Where should I go?",
                    "I want to {activity}. I am going to the...",
                    "My plan for today is to {activity}. I'll be at the...",
                    "I am going to the {item}.",
                    "Let's meet at the {item}.",
                    "I'll be at the {item} all afternoon."
                ]
            },
            medium: {
                templates: [
                    "I was going to go to the {distractor1}, but it's closed. I'll go to the {item} instead.",
                    "I intended to visit the {distractor1}, but I changed my mind. I'm going to the {item}.",
                    "I started walking towards the {distractor1}, but then I remembered I need to {activity}. So I'm heading to the {item}.",
                    "Let's meet at the {distractor1}. Actually, no, the {item} is closer. Let's meet there.",
                    "We agreed to meet at the {distractor1}, but it's too crowded. Let's switch to the {item}.",
                    "I don't need to go to the {distractor1} today. I need to {activity}, so I'm going to the {item}."
                ]
            },
            hard: {
                templates: [
                    "I considered the {distractor1}, then the {item}, and finally the {distractor2}. I've decided to go with the second option.",
                    "My schedule changed. First it was {distractor1}, then {item}, then {distractor2}. But I'm sticking with the middle choice.",
                    "I looked at the {distractor1}, then thought about the {distractor2}, but finally decided on the {item}. It's the best choice.",
                    "I don't want to go to the {distractor1} or the {distractor2}. I need a place where I can {activity}. The {item} is perfect.",
                    "The {distractor1} is too far, and the {distractor2} is closed for renovations. Since I need to {activity}, the {item} is my only option."
                ]
            }
        };

        // ======= STATE =======
        let currentGrade = null;
        let studentNames = [];
        let totalRounds = 8;
        let currentRound = 1;
        let currentQuestion = 1;
        let maxQuestions = 10;
        let isChampionship = false;
        let currentPlayers = [];
        let usedPlayers = [];
        let roundWinners = new Set();
        let playerScores = {};
        let globalLeaderboard = {};
        let playerStreaks = {};
        let timeLeft = 15;
        let gameActive = false;
        let currentQuestionData = null;
        let questionInterval = null;
        let timers = new Set();
        let cachedVoices = [];
        let voicesReady = false;

        // ======= HELPERS =======
        function clearTimer(ref) {
          if (!ref) return;
          if (ref._type === 'interval') clearInterval(ref.id);
          else clearTimeout(ref.id);
          timers.delete(ref);
        }

        function makeInterval(fn, ms) {
          const id = setInterval(fn, ms);
          const ref = { id, _type: 'interval' };
          timers.add(ref);
          return ref;
        }

        function makeTimeout(fn, ms) {
          const id = setTimeout(fn, ms);
          const ref = { id, _type: 'timeout' };
          timers.add(ref);
          return ref;
        }

        function stopAllSpeech() {
          if ('speechSynthesis' in window) {
            speechSynthesis.cancel();
          }
        }

        function ensureVoicesReady() {
          return new Promise(resolve => {
            if (voicesReady) return resolve(cachedVoices);
            const load = () => {
              cachedVoices = speechSynthesis.getVoices();
              if (cachedVoices && cachedVoices.length > 0) {
                voicesReady = true;
                resolve(cachedVoices);
              }
            };
            const existing = speechSynthesis.getVoices();
            if (existing && existing.length > 0) {
              cachedVoices = existing;
              voicesReady = true;
              resolve(cachedVoices);
            } else {
              window.speechSynthesis.onvoiceschanged = () => load();
              try {
                const u = new SpeechSynthesisUtterance('');
                speechSynthesis.speak(u);
                speechSynthesis.cancel();
              } catch {}
              makeTimeout(load, 1000);
            }
          });
        }

        // Generic speech function
        function speakOnce(text, { lang = 'en-US', rate = 0.85, pitch = 1, voicePref = null } = {}) {
            return new Promise(async (resolve) => {
                if (!('speechSynthesis' in window) || !text) return resolve();
                await ensureVoicesReady();
                stopAllSpeech(); 
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.rate = rate; 
                u.pitch = pitch;
                
                if (cachedVoices.length > 0) {
                    let selectedVoice;
                    if (voicePref === 'Brian') {
                        selectedVoice = cachedVoices.find(v => v.name.includes('Brian') && v.lang.startsWith('en'));
                    } else {
                        // Default to Emma for general questions
                        selectedVoice = cachedVoices.find(v => v.name.includes('Emma') && v.lang.startsWith('en')) ||
                                        cachedVoices.find(v => v.name.includes('Microsoft Emma')) ||
                                        cachedVoices.find(v => v.lang.startsWith('en'));
                    }
                    if (selectedVoice) u.voice = selectedVoice;
                }
                u.onend = () => resolve();
                u.onerror = () => resolve();
                speechSynthesis.speak(u);
            });
        }
        
        function speak(text) { return speakOnce(text, { lang: 'en-US', rate: 0.85, pitch: 1, voicePref: 'Emma' }); }
        
        // FEEDBACK VOICE: Brian
        function speakBrian(text) { return speakOnce(text, { lang: 'en-US', rate: 0.85, pitch: 1, voicePref: 'Brian' }); }

        function playAudio() {
            if (!currentQuestionData) return Promise.resolve();
            return speak(currentQuestionData.script);
        }

        // ======= GAME LOGIC =======
        function startTimer() {
            const progressFill = document.getElementById('progressFill');
            const progressEmoji = document.getElementById('progressEmoji');
            if (questionInterval) clearTimer(questionInterval);

            timeLeft = 15;
            progressFill.style.width = '100%';
            progressEmoji.textContent = 'üó∫Ô∏è';

            questionInterval = makeInterval(() => {
                timeLeft--;
                const percentage = (timeLeft / 15) * 100;
                progressFill.style.width = percentage + '%';
                if (timeLeft <= 5 && timeLeft > 0) { playTickSound(); }
                if (timeLeft <= 0) {
                    clearTimer(questionInterval);
                    questionInterval = null;
                    stopAllSpeech();
                    playBuzzerSound();
                    timeUp();
                }
            }, 1000);
        }

        async function startNewQuestion() {
            if (currentQuestion > maxQuestions) {
                endRound();
                return;
            }
            stopAllSpeech();
            if (questionInterval) clearTimer(questionInterval);

            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => {
                button.disabled = false;
                button.classList.remove('active-player-correct', 'active-player-incorrect');
                button.classList.remove('correct', 'incorrect'); // Clean up old classes
            });

            gameActive = true;
            timeLeft = 15;
            currentQuestionData = generateQuestion();
            document.getElementById('questionsLeft').textContent = (maxQuestions - currentQuestion + 1);
            document.getElementById('progressFill').style.width = '100%';
            updateStreakDisplay();
            startTimer();
            
            if (gameActive) await playAudio();
        }

        function generateQuestion() {
            let difficulty, itemPool;
            
            // Championship always uses Hard
            if (isChampionship) {
                difficulty = 'hard';
                itemPool = hardPlaces;
            } else {
                if (currentQuestion === 1) {
                    difficulty = 'easy';
                    itemPool = easyPlaces;
                } else if (currentQuestion <= 5) {
                    difficulty = 'medium';
                    itemPool = mediumPlaces;
                } else {
                    difficulty = 'hard';
                    itemPool = hardPlaces;
                }
            }
            
            const correctItem = itemPool[Math.floor(Math.random() * itemPool.length)];
            const allItems = [...easyPlaces, ...mediumPlaces, ...hardPlaces];
            const distractorPool = allItems.filter(item => item.id !== correctItem.id);
            const distractorItems = distractorPool.sort(() => Math.random() - 0.5).slice(0, 3);

            const choices = [correctItem, ...distractorItems];
            const templates = conversationTemplates[difficulty].templates;
            let script = templates[Math.floor(Math.random() * templates.length)];
            
            script = script.replace(/{item}/g, correctItem.spoken);
            script = script.replace(/{activity}/g, correctItem.activity); 
            if (distractorItems[0]) script = script.replace(/{distractor1}/g, distractorItems[0].spoken);
            if (distractorItems[1]) script = script.replace(/{distractor2}/g, distractorItems[1].spoken);

            const p1Choices = [...choices].sort(() => Math.random() - 0.5);
            const p2Choices = [...choices].sort(() => Math.random() - 0.5);
            const p3Choices = [...choices].sort(() => Math.random() - 0.5);
            
            const buttons = document.querySelectorAll('.choice-button');
            p1Choices.forEach((c, i) => { buttons[i].textContent = c.display.toLowerCase(); });
            p2Choices.forEach((c, i) => { buttons[i+4].textContent = c.display.toLowerCase(); });
            p3Choices.forEach((c, i) => { buttons[i+8].textContent = c.display.toLowerCase(); });

            return {
                script,
                correctItem,
                player1Choices: p1Choices,
                player2Choices: p2Choices,
                player3Choices: p3Choices
            };
        }

        async function selectAnswer(choiceIndex) {
            if (!gameActive || !currentQuestionData) return;
            
            gameActive = false;
            if (questionInterval) clearTimer(questionInterval);
            stopAllSpeech();

            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => button.disabled = true);

            let answeringPlayer, selectedChoice, playerStartIndex, playerEndIndex;
            
            if (choiceIndex < 4) { 
                answeringPlayer = currentPlayers[0]; 
                selectedChoice = currentQuestionData.player1Choices[choiceIndex];
                playerStartIndex = 0; playerEndIndex = 4;
            } else if (choiceIndex < 8) { 
                answeringPlayer = currentPlayers[1]; 
                selectedChoice = currentQuestionData.player2Choices[choiceIndex-4];
                playerStartIndex = 4; playerEndIndex = 8;
            } else { 
                answeringPlayer = currentPlayers[2]; 
                selectedChoice = currentQuestionData.player3Choices[choiceIndex-8];
                playerStartIndex = 8; playerEndIndex = 12;
            }
            
            const isCorrect = selectedChoice.id === currentQuestionData.correctItem.id;
            
            // Targeted highlighting: Only affect buttons for the answering player
            // And DO NOT reveal answer for other players
            const playerButton = buttons[choiceIndex];
            
            if (isCorrect) {
                playerButton.classList.add('active-player-correct');
                createFireworks(playerButton);
                createSparkles(playerButton);
            } else {
                playerButton.classList.add('active-player-incorrect');
                createShakeEffect(playerButton);
            }
            
            if (!playerStreaks[answeringPlayer]) playerStreaks[answeringPlayer] = 0;
            
            if (isCorrect) {
                playerStreaks[answeringPlayer]++;
                let points = 10 + (playerStreaks[answeringPlayer] >= 3 ? Math.min(playerStreaks[answeringPlayer]*2, 20) : 0);
                playerScores[answeringPlayer] += points;
                playCorrectSound();
                
                // Reset streak for current player if they were wrong previously? No, logic here is correct.
                
                let msg = `Correct!`;
                if (playerStreaks[answeringPlayer] > 2) msg += ` ${playerStreaks[answeringPlayer]} in a row!`;
                await speak(msg);
                await speakBrian(`${answeringPlayer.split(' / ')[0]}, correct! Plus ${points} points!`);
                createFlyingTokens(playerButton, getPlayerScoreElement(answeringPlayer), `+${points}`);
                if (playerStreaks[answeringPlayer] > 2) createStreakEffects(playerButton);
            } else {
                // Incorrect logic: Lose points AND give to others
                playerStreaks[answeringPlayer] = 0;
                playerScores[answeringPlayer] -= 5;
                
                // Distribute points to other players
                currentPlayers.forEach(p => {
                    if (p !== answeringPlayer) {
                        playerScores[p] += 5;
                        const scoreEl = getPlayerScoreElement(p);
                        createFlyingTokens(playerButton, scoreEl, '+5');
                    }
                });
                
                playWrongSound();
                await speak(`Incorrect.`);
                await speakBrian(`${answeringPlayer.split(' / ')[0]}, incorrect. Minus five points. Opponents get 5 points!`);
                createFlyingTokens(playerButton, getPlayerScoreElement(answeringPlayer), '-5');
            }
            
            updatePlayerDisplay();
            
            makeTimeout(() => {
                currentQuestion++;
                startNewQuestion();
            }, 2000);
        }

        async function timeUp() {
            gameActive = false;
            stopAllSpeech();
            currentPlayers.forEach(p => playerStreaks[p] = 0);
            
            const buttons = document.querySelectorAll('.choice-button');
            buttons.forEach(button => button.disabled = true);

            buttons.forEach((button) => {
                if (button.textContent === currentQuestionData.correctItem.display.toLowerCase()) {
                    button.classList.add('correct');
                }
            });

            await speakBrian(`Time's up! The correct answer is ${currentQuestionData.correctItem.display}`);
            updatePlayerDisplay();
            makeTimeout(() => { currentQuestion++; startNewQuestion(); }, 2000);
        }

        async function endRound() {
            stopAllSpeech();
            const leaderboard = document.getElementById('leaderboard');
            const content = document.getElementById('leaderboardContent');
            const globalContent = document.getElementById('globalScores');
            
            currentPlayers.forEach(player => {
                if (!globalLeaderboard[player]) globalLeaderboard[player] = 0;
                globalLeaderboard[player] += playerScores[player];
            });
            
            const sortedPlayers = [...currentPlayers].sort((a, b) => playerScores[b] - playerScores[a]);
            
            // Record Winner if not championship
            if (!isChampionship) {
                roundWinners.add(sortedPlayers[0]);
            }

            let leaderboardHTML = '<h3>Round Scores:</h3>';
            sortedPlayers.forEach((player, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                leaderboardHTML += `<div style="margin: 10px 0; font-size: 20px;">${medal} ${player.split(' / ')[0]}: ${playerScores[player]}</div>`;
            });
            
            const globalSorted = Object.entries(globalLeaderboard).sort(([,a], [,b]) => b - a).slice(0, 10);
            let globalHTML = '';
            globalSorted.forEach(([player, score], index) => {
                const medal = index === 0 ? 'üëë' : index === 1 ? 'ü•á' : index === 2 ? 'ü•à' : '‚≠ê';
                globalHTML += `<div style="margin: 5px 0; font-size: 16px;">${medal} ${player.split(' / ')[0]}: ${score}</div>`;
            });
            
            content.innerHTML = leaderboardHTML;
            globalContent.innerHTML = globalHTML;
            leaderboard.style.display = 'block';
            createWinnerFireworks();

            const winner = sortedPlayers[0];
            
            if (!isChampionship) {
                if (currentRound < totalRounds) {
                    await speak(`Round winner is ${winner.split(' / ')[1]}!`);
                    await speakBrian(`Congratulations ${winner.split(' / ')[0]}! You won this round!`);
                    makeTimeout(() => { nextRound(); }, 5000);
                } else {
                    // Go to championship
                    await speak(`Round winner is ${winner.split(' / ')[1]}!`);
                    await speakBrian(`End of regular rounds. Preparing for Championship!`);
                    makeTimeout(() => { startChampionshipRound(); }, 5000);
                }
            } else {
                // End of Championship
                const champion = sortedPlayers[0];
                await speak(`Championship Winner is ${champion.split(' / ')[1]}!`);
                await speakBrian(`The Ultimate Champion is... ${champion.split(' / ')[0]}!`);
                makeTimeout(() => { backToMenu(); }, 8000);
            }
        }

        function nextRound() {
            stopAllSpeech();
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('streakIndicator').style.display = 'none';
            currentRound++;
            // Check handled in endRound, so here we just setup normal next round
            currentQuestion = 1;
            maxQuestions = 10;
            document.getElementById('roundDisplay').textContent = `Round ${currentRound} of ${totalRounds}`;
            Object.keys(playerScores).forEach(p => playerScores[p] = 0);
            Object.keys(playerStreaks).forEach(p => playerStreaks[p] = 0);
            selectNewPlayers();
        }

        function startChampionshipRound() {
            stopAllSpeech();
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('streakIndicator').style.display = 'none';
            
            isChampionship = true;
            currentRound++; // Logically round + 1
            currentQuestion = 1;
            maxQuestions = 5; // 5 complicated questions
            
            document.getElementById('roundDisplay').textContent = `üèÜ CHAMPIONSHIP ROUND`;
            
            // Logic for championship players: Unique Winners first, then top scorers
            let potentialPlayers = Array.from(roundWinners);
            
            // If we have less than 3 winners (duplicates won multiple rounds), fill with top global scorers who aren't winners
            if (potentialPlayers.length < 3) {
                 const sortedGlobal = Object.entries(globalLeaderboard).sort(([,a], [,b]) => b - a).map(([p]) => p);
                 for (let p of sortedGlobal) {
                     if (!potentialPlayers.includes(p)) {
                         potentialPlayers.push(p);
                         if (potentialPlayers.length >= 3) break;
                     }
                 }
            }
            
            // Ensure we have exactly 3 for the layout
            currentPlayers = potentialPlayers.slice(0, 3);
            
            Object.keys(playerScores).forEach(p => playerScores[p] = 0);
            Object.keys(playerStreaks).forEach(p => playerStreaks[p] = 0);
            
            const shuffleDiv = document.getElementById('nameShuffle');
            shuffleDiv.querySelector('.shuffle-title').innerHTML = 'üèÜ CHAMPIONSHIP PLAYOFF üèÜ';
            document.getElementById('shuffleContainer').innerHTML = '<div style="font-size: 24px; color: #666; margin-bottom: 20px;">Round Winners Compete!</div>';
            const selectedPlayersDiv = document.getElementById('selectedPlayers');
            selectedPlayersDiv.innerHTML = '';
            
            currentPlayers.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'selected-player';
                d.textContent = `P${i+1}: ${p.split(' / ')[0]}`;
                selectedPlayersDiv.appendChild(d);
            });
            shuffleDiv.style.display = 'block';
            makeTimeout(() => showPlayerCountdown(true), 4000);
        }

        function selectNewPlayers() {
            showNameShuffle();
            
            let avail = studentNames.filter(n => !usedPlayers.includes(n));
            
            if (avail.length < 3) {
                usedPlayers = [];
                avail = [...studentNames];
            }
            
            const container = document.getElementById('shuffleContainer');
            container.innerHTML = '';
            document.getElementById('selectedPlayers').innerHTML = '';
            
            avail.forEach((n, i) => {
                setTimeout(() => {
                    const d = document.createElement('div');
                    d.className = 'shuffle-name';
                    d.textContent = n.split(' / ')[0];
                    container.appendChild(d);
                }, i*50);
            });
            setTimeout(() => selectPlayersSequentially(avail, 0), avail.length*50 + 1000);
        }

        function selectPlayersSequentially(avail, idx) {
            if (idx >= 3) { setTimeout(() => showPlayerCountdown(), 1000); return; }
            
            if (avail.length === 0) {
                 avail = studentNames.filter(n => !currentPlayers.includes(n));
            }

            const selIdx = Math.floor(Math.random() * avail.length);
            const p = avail.splice(selIdx, 1)[0];
            currentPlayers.push(p);
            usedPlayers.push(p);
            const pName = p.split(' / ')[0];

            const container = document.getElementById('shuffleContainer');
            const targetElement = Array.from(container.querySelectorAll('.shuffle-name')).find(el => el.textContent === pName);

            let count = 0;
            const int = setInterval(async () => {
                const names = Array.from(container.querySelectorAll('.shuffle-name'));
                names.forEach(e => e.classList.remove('selected'));
                
                if (count < 10) {
                    if (names.length > 0) {
                        const rand = Math.floor(Math.random() * names.length);
                        names[rand].classList.add('selected');
                    }
                } else {
                    clearInterval(int);
                    if (targetElement) targetElement.classList.add('selected');
                    
                    setTimeout(async () => {
                        if (targetElement) targetElement.remove();
                        
                        const d = document.createElement('div');
                        d.className = 'selected-player';
                        d.textContent = `P${idx + 1}: ${pName}`;
                        document.getElementById('selectedPlayers').appendChild(d);
                        
                        playCorrectSound();
                        await speakBrian(pName); 
                        
                        setTimeout(() => selectPlayersSequentially(avail, idx + 1), 500);
                    }, 500);
                }
                count++;
            }, 100);
        }

        function showNameShuffle() { document.getElementById('nameShuffle').style.display = 'block'; currentPlayers = []; playShuffleSound(); }
        function showPlayerCountdown(final=false) {
            const div = document.getElementById('nameShuffle');
            if (!final) div.querySelector('.shuffle-container').innerHTML = '';
            let c = 5;
            const t = div.querySelector('.shuffle-title');
            t.textContent = `Starting in ${c}...`;
            const i = setInterval(() => {
                c--;
                t.textContent = `Starting in ${c}...`;
                if (c<=0) {
                    clearInterval(i);
                    currentPlayers.forEach(p => playerScores[p]=0);
                    updatePlayerDisplay();
                    div.style.display='none';
                    startNewQuestion();
                }
            }, 1000);
        }

        function updatePlayerDisplay() {
            document.getElementById('player1').textContent = currentPlayers[0]?.split(' / ')[0] || 'P1';
            document.getElementById('score1').textContent = (playerScores[currentPlayers[0]]||0) + ' pts';
            document.getElementById('player2').textContent = currentPlayers[1]?.split(' / ')[0] || 'P2';
            document.getElementById('score2').textContent = (playerScores[currentPlayers[1]]||0) + ' pts';
            document.getElementById('player3').textContent = currentPlayers[2]?.split(' / ')[0] || 'P3';
            document.getElementById('score3').textContent = (playerScores[currentPlayers[2]]||0) + ' pts';
            updateStreakDisplay();
        }

        function updateStreakDisplay() {
            currentPlayers.forEach((p, idx) => {
                const streakDiv = document.getElementById(`streak${idx+1}`);
                const badgesDiv = document.getElementById(`badges${idx+1}`);
                const streak = playerStreaks[p] || 0;
                
                if (streak > 0) {
                    streakDiv.style.display = 'block';
                    streakDiv.textContent = `üî• ${streak}`;
                } else {
                    streakDiv.style.display = 'none';
                }
                
                let badgesHTML = '';
                if (streak >= 3) badgesHTML += '‚ö°';
                if (streak >= 5) badgesHTML += 'üëë';
                badgesDiv.innerHTML = badgesHTML;
            });
            document.getElementById('streakIndicator').style.display = 'none';
        }

        function backToMenu() {
            stopAllSpeech();
            if(questionInterval) clearTimer(questionInterval);
            gameActive = false; currentRound = 1; currentQuestion = 1; isChampionship = false;
            currentPlayers = []; usedPlayers = []; playerScores = {}; playerStreaks = {}; globalLeaderboard = {}; roundWinners = new Set();
            ['leaderboard', 'learningPhase', 'nameShuffle', 'gameContainer', 'streakIndicator'].forEach(id => document.getElementById(id).style.display = 'none');
            document.getElementById('mainMenu').style.display = 'flex';
        }

        function selectGrade(g) {
            currentGrade = g;
            studentNames = studentsByGrade[g];
            totalRounds = g === 10 ? 6 : 5;
            maxQuestions = 10;
            document.getElementById('roundDisplay').textContent = `Round 1 of ${totalRounds}`;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            selectNewPlayers();
        }

        // Effects
        function createFireworks(b) {
            const r = b.getBoundingClientRect();
            for(let i=0;i<15;i++) {
                setTimeout(()=>{
                    const f = document.createElement('div'); f.className='fireworks';
                    f.style.left = r.left + r.width/2 + 'px'; f.style.top = r.top + r.height/2 + 'px';
                    document.body.appendChild(f); setTimeout(()=>f.remove(), 2000);
                }, i*100);
            }
        }
        function createSparkles(b) {
            const r = b.getBoundingClientRect();
            for(let i=0;i<10;i++) {
                setTimeout(()=>{
                    const s = document.createElement('div'); s.className='sparkle';
                    s.style.left = r.left + Math.random()*r.width + 'px';
                    s.style.top = r.top + Math.random()*r.height + 'px';
                    document.body.appendChild(s); setTimeout(()=>s.remove(), 1000);
                }, i*50);
            }
            // Glitter
            for(let i=0;i<20;i++) {
                setTimeout(()=>{
                    const g = document.createElement('div'); g.className='glitter';
                    g.style.left = r.left + Math.random()*r.width + 'px';
                    g.style.top = r.top + Math.random()*r.height + 'px';
                    document.body.appendChild(g); setTimeout(()=>g.remove(), 2000);
                }, i*30);
            }
        }
        function createShakeEffect(b) {
            for(let i=0;i<5;i++) {
                setTimeout(()=>{
                    const x = document.createElement('div'); x.innerHTML='‚ùå'; x.style.position='absolute';
                    x.style.left = b.getBoundingClientRect().left + 20 + 'px';
                    x.style.top = b.getBoundingClientRect().top + 'px';
                    x.style.zIndex=1001; x.style.animation='fadeOut 1s forwards';
                    document.body.appendChild(x); setTimeout(()=>x.remove(), 1000);
                }, i*100);
            }
        }
        function createFlyingTokens(from, to, txt) {
            if(!from||!to)return;
            const f = from.getBoundingClientRect(); const t = to.getBoundingClientRect();
            for(let i=0;i<5;i++){
                setTimeout(()=>{
                    const tk = document.createElement('div'); tk.className='token'; tk.textContent=txt;
                    tk.style.left=f.left+f.width/2+'px'; tk.style.top=f.top+f.height/2+'px';
                    document.body.appendChild(tk);
                    setTimeout(()=>{
                        tk.style.transition='all 1s ease';
                        tk.style.left=t.left+t.width/2+'px'; tk.style.top=t.top+t.height/2+'px';
                        tk.style.opacity=0;
                    }, 50);
                    setTimeout(()=>tk.remove(), 1100);
                }, i*100);
            }
        }
        function createStreakEffects(b) { createFireworks(b); }
        function createWinnerFireworks() {
            for(let i=0;i<30;i++) {
                setTimeout(()=>{
                    const f = document.createElement('div'); f.className='winner-firework';
                    f.style.left=Math.random()*window.innerWidth+'px'; f.style.top=Math.random()*window.innerHeight+'px';
                    document.body.appendChild(f); setTimeout(()=>f.remove(), 3000);
                }, i*100);
            }
        }
        function getPlayerScoreElement(p) {
            const idx = currentPlayers.indexOf(p);
            if(idx===0) return document.getElementById('score1');
            if(idx===1) return document.getElementById('score2');
            if(idx===2) return document.getElementById('score3');
        }

        // Sound functions
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        function playTickSound() {
            const a = new AudioContext(); const o = a.createOscillator(); const g = a.createGain();
            o.connect(g); g.connect(a.destination); o.frequency.value=800; g.gain.value=0.1;
            o.start(); o.stop(a.currentTime+0.1);
        }
        function playBuzzerSound() {
            const a = new AudioContext(); const o = a.createOscillator(); const g = a.createGain();
            o.connect(g); g.connect(a.destination); o.frequency.value=200; g.gain.value=0.3;
            o.start(); o.stop(a.currentTime+0.5);
        }
        function playCorrectSound() {
            const a = new AudioContext(); 
            [523, 659, 784, 1047].forEach((f,i)=>{
                setTimeout(()=>{
                    const o = a.createOscillator(); const g = a.createGain();
                    o.connect(g); g.connect(a.destination); o.frequency.value=f; g.gain.value=0.1;
                    o.start(); o.stop(a.currentTime+0.2);
                }, i*100);
            });
        }
        function playWrongSound() {
            const a = new AudioContext(); const o = a.createOscillator(); const g = a.createGain();
            o.connect(g); g.connect(a.destination); o.frequency.value=150; g.gain.value=0.2;
            o.start(); o.stop(a.currentTime+0.4);
        }
        function playShuffleSound() {
            const a = new AudioContext();
            for(let i=0;i<5;i++){
                setTimeout(()=>{
                    const o=a.createOscillator(); const g=a.createGain();
                    o.connect(g); g.connect(a.destination); o.frequency.value=400+Math.random()*200; g.gain.value=0.05;
                    o.start(); o.stop(a.currentTime+0.1);
                }, i*100);
            }
        }

        window.addEventListener('load', () => {
            setTimeout(initGame, 1000);
            ensureVoicesReady();
        });
        
        function initGame() {
            // BG effects
            setInterval(()=>{
                const l = document.createElement('div'); l.className='laser-beam';
                l.style.left=Math.random()*window.innerWidth+'px';
                document.body.appendChild(l); setTimeout(()=>l.remove(), 3000);
            }, 2000);
        }
    </script>
</body>
</html>
