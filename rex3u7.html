<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 11 Unit 7: Energy for the Future</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Segoe+UI:wght@400;600;700&display=swap');
        
        /* Animation for Energy/Sustainability Theme */
        @keyframes energyFlow {
            0% { background-color: #f0fdf4; } /* green-50 */
            25% { background-color: #ecfccb; } /* lime-100 */
            50% { background-color: #fef9c3; } /* yellow-100 */
            75% { background-color: #e0f2fe; } /* sky-100 */
            100% { background-color: #f0fdf4; } /* green-50 */
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            overscroll-behavior: none;
            animation: energyFlow 60s linear infinite;
            padding-top: 90px; /* Increased padding for larger header */
            color: #1e293b;
            font-size: 1.25rem; /* Base font size increased from default */
        }
        h1, h2, h3, h4 {
            font-family: 'Merriweather', serif;
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d, .tier-btn, .project-card {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06);
            border: none;
            cursor: pointer;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover, .tier-btn:hover, .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active, .tier-btn:active {
            transform: translateY(1px);
        }
        
        /* Horizontal Quiz Layout Update */
        .quiz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Wider columns */
            gap: 15px;
            margin-top: 20px;
        }
        .quiz-option {
            width: 100%;
            padding: 20px; /* Larger padding */
            background: white;
            border: 2px solid #cbd5e1;
            border-radius: 16px;
            font-size: 1.2rem; /* Larger font */
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px; /* Taller buttons */
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 50px; padding: 0 12px;
            border: 3px dashed #94a3b8; border-radius: 8px; margin: 0 6px;
            vertical-align: middle; background-color: #ffffff;
            font-weight: bold; color: #334155;
            font-size: 1.2rem;
        }
        .word-bank-word {
            cursor: grab; padding: 12px 24px; border-radius: 9999px;
            background-color: white; user-select: none; border: 1px solid #cbd5e1;
            font-weight: 600; color: #475569;
            font-size: 1.2rem;
        }
        .word-bank-word.selected { outline: 3px solid #3b82f6; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; border: none; background: transparent; padding: 0; }
        .gap.correct { background-color: #dcfce7; border-color: #22c55e; color: #15803d; border-style: solid; }
        .gap.incorrect { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; border-style: solid; }

        /* Feedback Toast */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
            padding: 16px 32px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            font-size: 1.2rem;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #3b82f6, #8b5cf6); animation-duration: 4.5s; }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 40px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 40px; } to { opacity: 0; bottom: 0; } }

        /* Progress Bar */
        #progress-container { background-color: #e2e8f0; border-radius: 9999px; overflow: hidden; height: 12px; width: 100%; margin-top: 10px; }
        #progress-bar { height: 100%; width: 0%; background-color: #16a34a; transition: width 0.5s ease-out; }
        
        /* Floating Emoji */
        #emoji-floating-container { position: fixed; inset: 0; pointer-events: none; z-index: 40; }
        .floating-emoji {
            position: absolute; font-size: 40px; will-change: transform, opacity;
            opacity: 0; display: inline-block; animation-name: floatAcross;
            animation-timing-function: linear; animation-iteration-count: 1;
        }
        @keyframes floatAcross {
            0% { transform: translateX(-10vw) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateX(110vw) rotate(20deg); opacity: 0; }
        }

        /* Particles */
        .particle { position: fixed; pointer-events: none; z-index: 9999; opacity: 1; transition: opacity 0.5s ease-out; }
        .particle.glitter { width: 12px; height: 12px; border-radius: 50%; background: #fbbf24; }

        /* Tiered Reading Tabs */
        .tier-btn.active { background-color: #15803d; color: white; border-color: #15803d; }
        .tier-btn { background-color: white; color: #64748b; border: 1px solid #cbd5e1; padding: 12px 24px; font-size: 1.1rem; }
        
        /* Dialogue Bubbles */
        .dialogue-bubble { padding: 20px; margin: 15px 0; border-radius: 16px; position: relative; max-width: 90%; font-size: 1.3rem; }
        .bubble-left { background: #dcfce7; margin-right: auto; border-bottom-left-radius: 2px; }
        .bubble-right { background: #fef9c3; margin-left: auto; border-bottom-right-radius: 2px; }

        /* Pedagogical Box Styles */
        .pedagogy-box { border-left: 6px solid #f59e0b; background: #fffbeb; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 0.75rem; }
        .pedagogy-title { font-weight: bold; color: #b45309; text-transform: uppercase; font-size: 1rem; letter-spacing: 0.05em; display: block; margin-bottom: 0.5rem; }

        /* Typography overrides for larger scale */
        h1 { font-size: 3rem; line-height: 1.2; }
        h2 { font-size: 2.25rem; line-height: 1.3; }
        h3 { font-size: 1.8rem; line-height: 1.4; margin-bottom: 1rem; }
        p { font-size: 1.35rem; line-height: 1.7; margin-bottom: 1.2rem; }
        li { font-size: 1.3rem; margin-bottom: 0.8rem; }

    </style>
</head>
<body class="antialiased text-gray-800 bg-slate-50">
    <canvas id="background-canvas"></canvas>
    <div id="reward-animation-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]"></div>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-4" style="display: none;">
        <div class="max-w-6xl mx-auto bg-white/95 backdrop-blur-sm shadow-md rounded-2xl p-4 border border-slate-200">
            <div class="flex justify-between items-center gap-4">
                <button onclick="goBack()" class="nav-button bg-slate-100 text-slate-600 p-3 rounded-xl hover:bg-slate-200">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="flex-1 text-center font-bold text-slate-700 whitespace-nowrap"><span id="score-display" class="text-green-600 text-2xl">0</span> XP</div>
                <button onclick="navigateTo('main-menu')" class="nav-button bg-green-600 text-white p-3 rounded-xl hover:bg-green-700">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4h.01M5 19h14"></path></svg>
                </button>
                <button onclick="toggleTTS(this)" class="nav-button p-3 rounded-xl bg-slate-100 hover:bg-slate-200" title="Read Aloud">
                    <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
                </button>
                <button onclick="goNext()" class="nav-button bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded-xl">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
        </div>
    </header>

    <div id="emoji-floating-container" aria-hidden="true"></div>

    <div id="app-container" class="max-w-6xl mx-auto p-6 sm:p-8 pb-32">
        <section id="page-title-screen" class="page active text-center bg-white rounded-3xl shadow-xl p-12 border border-slate-100">
            <div class="h-full flex flex-col justify-center items-center py-12">
                <div class="text-8xl mb-6">‚ö°</div>
                <h1 id="main-title" class="text-5xl md:text-7xl font-bold text-slate-800 mb-4">Grade 11 Unit 7</h1>
                <h2 class="text-4xl text-green-600 font-semibold mb-8">Energy for the Future üåç</h2>
                <p id="main-subtitle" class="text-2xl text-gray-500 mb-10 max-w-2xl">Challenge & Innovation: Balancing demand with sustainability.</p>
                <div class="flex flex-wrap gap-4 justify-center mb-12">
                    <span class="px-5 py-2 bg-green-100 text-green-800 rounded-full text-lg">Theme: Sustainability</span>
                    <span class="px-5 py-2 bg-yellow-100 text-yellow-800 rounded-full text-lg">Skills: Pros & Cons</span>
                </div>
                <button onclick="startApp()" class="action-button bg-green-600 text-white font-bold py-5 px-12 rounded-full text-2xl hover:bg-green-700 shadow-xl transition-transform transform hover:scale-105">ENTER UNIT</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION: 7A & 7B ---
        // ===================================================================================
        const lessonData = {
            title: "Unit 7: Energy",
            subtitle: "Global Energy & Wave Power ‚ö° üåä",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-goals', text: 'üéØ Roadmap (W.H.E.R.E.T.O.)', color: 'slate', target: 'goals-intro' },
                { id: 'menu-7a', text: 'üåç 7A: Global Energy Challenge', color: 'green', target: '7a-intro' },
                { id: 'menu-7b', text: 'üåä 7B: Power from the Sea', color: 'blue', target: '7b-intro' },
                { id: 'menu-projects', text: 'üöÄ Active Learning Menu', color: 'amber', target: 'project-menu' },
                { id: 'menu-final', text: 'ü§î Plenary & Reflection', color: 'teal', target: 'final-plenary' },
            ],
            vocabulary: [
                // 7A Vocab
                { word: 'Alternative', ipa: '/…îÀêlÀàt…úÀêrn…ôt…™v/', def: 'Available as another possibility.', sentence: 'Solar is an alternative energy source.' },
                { word: 'Consumption', ipa: '/k…ônÀàs åmp É…ôn/', def: 'The action of using up a resource.', sentence: 'Global energy consumption is rising.' },
                { word: 'Crisis', ipa: '/Ààkra…™s…™s/', def: 'A time of intense difficulty.', sentence: 'We face an environmental crisis.' },
                { word: 'Emission', ipa: '/…™Ààm…™ É…ôn/', def: 'The production and discharge of gas.', sentence: 'Carbon emissions cause warming.' },
                { word: 'Finite', ipa: '/Ààfa…™na…™t/', def: 'Limited in size or extent.', sentence: 'Oil is a finite resource.' },
                { word: 'Fossil fuel', ipa: '/Ààf…ís…ôl fjuÀê…ôl/', def: 'Natural fuel from ancient remains.', sentence: 'Coal is a fossil fuel.' },
                { word: 'Generate', ipa: '/Ààd í…õn…ôÀåre…™t/', def: 'To produce or create.', sentence: 'Wind turbines generate power.' },
                { word: 'Infrastructure', ipa: '/Àà…™nfr…ôÀåstr åkt É…ôr/', def: 'Basic organizational structures.', sentence: 'We need new grid infrastructure.' },
                { word: 'Reliance', ipa: '/r…™Ààla…™…ôns/', def: 'Dependence on or trust in.', sentence: 'Our reliance on oil is risky.' },
                { word: 'Sustainable', ipa: '/s…ôÀàste…™n…ôb…ôl/', def: 'Able to be maintained.', sentence: 'Solar power is sustainable.' },
                // 7B Vocab
                { word: 'Coastal', ipa: '/Ààko äst…ôl/', def: 'Located near the sea shore.', sentence: 'Coastal cities benefit from wave energy.' },
                { word: 'Harness', ipa: '/Ààh…ëÀêrn…™s/', def: 'To control and make use of energy.', sentence: 'We harness the power of waves.' },
                { word: 'Innovation', ipa: '/Àå…™n…ôÀàve…™ É…ôn/', def: 'The introduction of something new.', sentence: 'Innovation lowers energy costs.' },
                { word: 'Intermittent', ipa: '/Àå…™nt…ôrÀàm…™t…ônt/', def: 'Occurring at irregular intervals.', sentence: 'Solar power is intermittent.' },
                { word: 'Kinetic', ipa: '/k…™Ààn…õt…™k/', def: 'Relating to motion.', sentence: 'Waves have kinetic energy.' },
                { word: 'Obstacle', ipa: '/Àà…íbst…ôk…ôl/', def: 'A thing that blocks progress.', sentence: 'Salt water is an obstacle for machines.' },
                { word: 'Potential', ipa: '/p…ôÀàt…õn É…ôl/', def: 'Latent qualities that may lead to success.', sentence: 'The ocean has huge energy potential.' },
                { word: 'Renewable', ipa: '/r…™ÀànuÀê…ôb…ôl/', def: 'Not depleted when used.', sentence: 'Wave power is renewable.' },
                { word: 'Technological', ipa: '/Àåt…õkn…ôÀàl…íd í…™k…ôl/', def: 'Relating to technology.', sentence: 'We face technological challenges.' },
                { word: 'Viable', ipa: '/Ààva…™…ôb…ôl/', def: 'Capable of working successfully.', sentence: 'Wave power is not yet economically viable.' }
            ],
            pages: [
                // --- GOALS ---
                { id: 'goals-intro', type: 'simple', content: { 
                    title: 'Learning Roadmap', 
                    text: `
                    <div class="pedagogy-box"><span class="pedagogy-title">W.H.E.R.E.T.O. Framework</span>
                    <strong>W (Where):</strong> Analyze energy transition challenges.<br>
                    <strong>H (Hook):</strong> Nighttime Earth & Storm Waves.<br>
                    <strong>E (Equip):</strong> 20 Keywords (Fossil vs. Wave).<br>
                    <strong>O (Organize):</strong> Debates & Pitches.<br>
                    </div>
                    <ul class="list-disc list-inside text-left space-y-4 mt-6">
                        <li><strong>Objective 1:</strong> Analyze consequences of fossil fuel reliance.</li>
                        <li><strong>Objective 2:</strong> Evaluate wave power potential vs. obstacles.</li>
                        <li><strong>Outcome:</strong> Negotiate a "Global Clean Energy Accord".</li>
                    </ul>
                    ` 
                }},

                // --- 7A: GLOBAL ENERGY ---
                { id: '7a-intro', type: 'simple', content: { title: '7A: Global Challenge üåç', text: '<strong>Hook:</strong> Look at Earth at night. What powers those lights? (80% Fossil Fuels).<br><strong>Problem:</strong> Finite resources & Climate Change.' } },
                
                { id: '7a-vocab', type: 'vocab-list', content: { title: '7A Vocabulary', words: [] } }, // Populated dynamically

                { id: '7a-reading', type: 'tiered-reading', content: { 
                    title: '7A: The Global Challenge',
                    texts: {
                        'A2': "<h3>Powering Our World (A2)</h3><p>Every day, we use energy for lights and cars. Most comes from fossil fuels like coal and oil. About 80% of our energy is from these sources.</p><p><strong>The Problem:</strong> Fossil fuels are finite (they will run out) and cause emissions that warm the Earth.</p><p><strong>Change:</strong> We face an energy crisis. We must find sustainable alternatives like sun and wind.</p>",
                        'B1': "<h3>An Insatiable Demand (B1)</h3><p>Global consumption has skyrocketed. Humanity has a heavy reliance on fossil fuels to meet 80% of needs. We burn these to generate electricity.</p><p><strong>Environmental Cost:</strong> Fossil fuels are finite. Their use releases carbon emissions, the primary driver of climate change.</p><p><strong>Transition:</strong> We need sustainable sources. However, our current infrastructure is built for oil and gas.</p>",
                        'B2': "<h3>The Fossil Fuel Paradigm (B2)</h3><p>Human progress is linked to fossil fuel combustion. The global economy has a systemic reliance on these high-density energy sources.</p><p><strong>Threats:</strong> We face a dual crisis: depletion of finite resources and the cumulative impact of emissions. This poses an existential threat.</p><p><strong>Imperatives:</strong> We need a systemic upheaval of energy infrastructure toward alternative modalities.</p>"
                    }
                }},

                { id: '7a-quiz', type: 'quiz-mcq', content: { 
                    title: '7A Comprehension', 
                    questions: [
                        { question: 'What percentage of energy comes from fossil fuels?', options: ['50%', '80%', '100%', '20%'], correctAnswer: '80%' },
                        { question: 'Which is NOT a fossil fuel?', options: ['Coal', 'Oil', 'Solar', 'Natural Gas'], correctAnswer: 'Solar' },
                        { question: 'What is the main problem discussed in Heading 2?', options: ['Cost', 'Environmental Cost', 'Politics', 'Speed'], correctAnswer: 'Environmental Cost' }
                    ]
                }},

                { id: '7a-dialogue', type: 'dialogue', content: { 
                    title: '7A Dialogue: The Debate', 
                    dialogue: `Person A: I read another report about climate change today. It's really scary how much we rely on fossil fuels.

Person B: It is a serious crisis. Our entire economy is built on the consumption of cheap oil and gas.

Person A: But we know they are finite and cause huge carbon emissions. Why don't we just switch to alternative energy?

Person B: It's not that simple. We need a massive new infrastructure to generate and store clean power. Building a sustainable system takes time.` 
                }},

                // --- 7B: POWER FROM THE SEA ---
                { id: '7b-intro', type: 'simple', content: { title: '7B: Power from the Sea üåä', text: '<strong>Hook:</strong> Watch huge waves crashing. Can we harness that kinetic energy?<br><strong>Focus:</strong> Innovation vs. Corrosion/Cost.' } },

                { id: '7b-vocab', type: 'vocab-list', content: { title: '7B Vocabulary', words: [] } }, // Populated dynamically

                { id: '7b-reading', type: 'tiered-reading', content: { 
                    title: '7B: Wave Power',
                    texts: {
                        'A2': "<h3>Energy in the Water (A2)</h3><p>The ocean is full of energy. The waves are always moving (kinetic energy). Scientists want to harness this power.</p><p><strong>How It Works:</strong> Machines float on water. As waves move them up and down, they create power.</p><p><strong>The Hard Part:</strong> Salt water damages machines (corrosion). Storms destroy them. It is a big technological obstacle.</p>",
                        'B1': "<h3>The Ocean's Promise (B1)</h3><p>Waves contain massive kinetic energy. Unlike fossil fuels, this is renewable. Waves are also more predictable than wind or solar, which are intermittent.</p><p><strong>Capturing Waves:</strong> Engineers use floating buoys to drive generators. The goal is to convert mechanical movement into electricity.</p><p><strong>Challenges:</strong> Saltwater causes corrosion. Storms tear devices apart. Designing durable machines is a major obstacle to making wave power viable.</p>",
                        'B2': "<h3>A Kinetic Reservoir (B2)</h3><p>The ocean offers a staggered potential for energy. It is denser and less intermittent than solar. Ocean swells transmit energy over vast distances.</p><p><strong>Innovation:</strong> Technologies range from point absorbers to oscillating water columns that pressurize air.</p><p><strong>Obstacles:</strong> The marine environment is unforgiving. Devices must withstand cyclic loading and biofouling. High costs currently render wave power barely economically viable.</p>"
                    }
                }},

                { id: '7b-quiz', type: 'quiz-mcq', content: { 
                    title: '7B Comprehension', 
                    questions: [
                        { question: 'What type of energy do waves have?', options: ['Thermal', 'Kinetic', 'Nuclear', 'Chemical'], correctAnswer: 'Kinetic' },
                        { question: 'Why is wave power better than solar?', options: ['It is cheaper', 'It is less intermittent', 'It is easier', 'It is hotter'], correctAnswer: 'It is less intermittent' },
                        { question: 'What is a major obstacle?', options: ['Fish', 'Corrosion/Storms', 'Too much sun', 'Wind'], correctAnswer: 'Corrosion/Storms' }
                    ]
                }},

                { id: '7b-dialogue', type: 'dialogue', content: { 
                    title: '7B Dialogue: Investor Pitch', 
                    dialogue: `Person A: You want me to invest in wave power? It seems too risky. The ocean destroys everything you put in it.

Person B: It is a major technological challenge, I agree. Corrosion and storms are huge obstacles.

Person A: Exactly. Why not just stick with solar? It's cheaper and easier.

Person B: Solar is great, but it's intermittent. The sun doesn't shine at night. The ocean offers massive, predictable potential.

Person A: Potential is nice, but is it a viable business right now?

Person B: Not yet compared to coal, but with the right innovation to harness that kinetic energy efficiently, it could power every coastal city in the world.` 
                }},

                // --- GRASPS ---
                { id: 'grasps-task', type: 'simple', content: { 
                    title: 'üèÜ GRASPS: Wave Energy Pitch', 
                    text: `
                    <div class="text-left space-y-4">
                        <p><strong>Goal:</strong> Secure funding for a pilot project.</p>
                        <p><strong>Role:</strong> Chief Engineer.</p>
                        <p><strong>Audience:</strong> Venture Capitalists.</p>
                        <p><strong>Product:</strong> 3-Minute Pitch explaining Potential vs. Solutions to Obstacles (Corrosion).</p>
                        <div class="bg-blue-50 p-4 rounded text-lg">
                            <strong>Rubric (KASEC):</strong> Technical Knowledge, Analysis of Challenges, Persuasion.
                        </div>
                    </div>
                    ` 
                }},

                // --- PROJECTS ---
                { id: 'project-menu', type: 'simple', content: {
                    title: 'Active Learning Menu',
                    text: `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                        <div class="project-card bg-green-100 p-6 rounded-xl">
                            <strong>PBL: Global Summit</strong><br>Simulate a UN meeting. Negotiate a "Clean Energy Accord" representing different nations.
                        </div>
                        <div class="project-card bg-blue-100 p-6 rounded-xl">
                            <strong>Inquiry: Energy Audit</strong><br>Where does YOUR school's power come from? Calculate the carbon footprint.
                        </div>
                        <div class="project-card bg-amber-100 p-6 rounded-xl">
                            <strong>Problem-Based: Island Power</strong><br>Design a renewable plan for a remote island currently using diesel.
                        </div>
                        <div class="project-card bg-indigo-100 p-6 rounded-xl">
                            <strong>Experiential: Wave Model</strong><br>Build a simple wave machine with a tub and paddle. Try to generate a current.
                        </div>
                    </div>
                    `
                }},

                // --- PLENARY ---
                { id: 'final-plenary', type: 'simple', content: { 
                    title: 'Plenary: Crystal Ball', 
                    text: `
                    <div class="text-left space-y-4">
                        <p><strong>Prediction:</strong> Imagine 2050. What will be the world's main energy source? Make a prediction based on evidence.</p>
                        <hr>
                        <strong>Self-Assessment:</strong>
                        <ul class="list-disc list-inside">
                            <li>Did you understand the "Intermittent" problem with solar?</li>
                            <li>How did you handle the technical vocab (kinetic, viable)?</li>
                        </ul>
                    </div>
                    ` 
                }}
            ]
        };

        // --- SPEECH SERVICE ---
        class SpeechService {
             constructor() { this.synth = window.speechSynthesis; this.isInitialized = false; this.isTtsEnabled = true; this.voices = {}; this.speechRate = 0.85; }
             async _setupVoices() {
                 const voicesPromise = new Promise(resolve => { if (this.synth.getVoices().length) return resolve(this.synth.getVoices()); this.synth.onvoiceschanged = () => resolve(this.synth.getVoices()); });
                 const availableVoices = await voicesPromise;
                 const findVoice = (name) => availableVoices.find(v => v.name.includes(name) && v.name.includes('Natural')) || availableVoices.find(v => v.name.includes(name));
                 this.voices = {
                     'person a': findVoice('Andrew') || availableVoices[0],
                     'person b': findVoice('Ava') || availableVoices[0],
                     'default': findVoice('Ava') || availableVoices[0]
                 };
             }
             async init() { if (this.isInitialized) return; await this._setupVoices(); this.isInitialized = true; }
             _cleanTextForSpeech(text) { const tempDiv = document.createElement('div'); tempDiv.innerHTML = text.replace(/<span aria-hidden="true">.*?<\/span>/g, ' '); return tempDiv.innerText || tempDiv.textContent || ''; }
             speak(text) { if (!this.isTtsEnabled || !text) return; this.cancel(); const utterance = new SpeechSynthesisUtterance(this._cleanTextForSpeech(text)); utterance.voice = this.voices['default']; utterance.rate = this.speechRate; this.synth.speak(utterance); }
             speakDialogue(text) { if (!this.isTtsEnabled || !text) return; this.cancel(); const lines = text.split('\n\n'); const speakLine = (index) => { if (index >= lines.length) return; const line = lines[index]; const [speaker, ...rest] = line.split(': '); const lineText = rest.join(': '); const utterance = new SpeechSynthesisUtterance(this._cleanTextForSpeech(lineText || speaker)); const key = speaker.toLowerCase().trim(); utterance.voice = this.voices[key] || this.voices['default']; utterance.rate = this.speechRate; utterance.onend = () => speakLine(index + 1); this.synth.speak(utterance); }; speakLine(0); }
             cancel() { this.synth.cancel(); }
             toggleTTS() { this.isTtsEnabled = !this.isTtsEnabled; if(!this.isTtsEnabled) this.cancel(); return this.isTtsEnabled; }
         }

        // --- CORE LOGIC ---
        const speechService = new SpeechService();
        let score = 0, currentPage = lessonData.startPageId;
        const pageHistory = [lessonData.startPageId];
        
        // Populate Vocab Lists dynamically
        lessonData.pages.find(p => p.id === '7a-vocab').content.words = lessonData.vocabulary.slice(0, 10);
        lessonData.pages.find(p => p.id === '7b-vocab').content.words = lessonData.vocabulary.slice(10, 20);

        function getPageSequence() {
            return ['title-screen', 'goals-intro', 
                    '7a-intro', '7a-vocab', '7a-reading', '7a-quiz', '7a-dialogue',
                    '7b-intro', '7b-vocab', '7b-reading', '7b-quiz', '7b-dialogue',
                    'grasps-task', 'project-menu', 'final-plenary'];
        }
        let pageSequence = getPageSequence();

        window.startApp = async function() {
            await speechService.init();
            try { await Tone.start(); } catch(e){}
            navigateTo(lessonData.homePageId);
        }

        window.navigateTo = (pageId) => {
            const target = document.getElementById(`page-${pageId}`);
            if (!target) return;
            speechService.cancel();
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            target.classList.add('active');
            currentPage = pageId;
            if (pageHistory[pageHistory.length - 1] !== pageId) pageHistory.push(pageId);
            
            const pageDef = lessonData.pages.find(p => p.id === pageId);
            if (pageDef) {
                if (pageDef.type === 'dialogue') speechService.speakDialogue(pageDef.content.dialogue);
                else if (pageDef.type === 'tiered-reading') {
                    const activeTab = target.querySelector('.reading-content:not(.hidden)');
                    if(activeTab) speechService.speak(activeTab.innerText);
                } else {
                    const h2 = target.querySelector('h2');
                    const p = target.querySelector('p'); 
                    const text = (h2 ? h2.innerText : '') + '. ' + (p ? p.innerText : '');
                    speechService.speak(text);
                }
            }
            updateNavButtons();
            window.scrollTo(0,0);
        }

        window.goBack = () => { if(pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); } }
        window.goNext = () => { 
            const idx = pageSequence.indexOf(currentPage);
            if(idx > -1 && idx < pageSequence.length - 1) navigateTo(pageSequence[idx+1]);
            else navigateTo(lessonData.homePageId);
        }
        window.toggleTTS = (btn) => {
            const enabled = speechService.toggleTTS();
            btn.classList.toggle('bg-blue-100', enabled);
            btn.classList.toggle('bg-gray-200', !enabled);
            if(enabled) navigateTo(currentPage); 
        }

        // --- RENDER FUNCTIONS ---
        function createPageElement(id, html) {
            const sec = document.createElement('section');
            sec.id = `page-${id}`;
            sec.className = 'page';
            sec.innerHTML = html;
            document.getElementById('dynamic-pages-container').appendChild(sec);
        }

        function renderPages() {
            const menuBtns = lessonData.mainMenu.map(item => `
                <button onclick="navigateTo('${item.target}')" class="btn-animated-3d bg-${item.color}-500 text-white font-bold text-lg p-6 rounded-2xl w-full text-left shadow-lg hover:bg-${item.color}-600 border-b-8 border-${item.color}-700 active:border-b-0 active:translate-y-2 transition-all">
                    ${item.text}
                </button>
            `).join('');
            createPageElement(lessonData.homePageId, `
                <div class="bg-white rounded-3xl shadow-xl p-10 border border-slate-100">
                    <h2 class="text-4xl font-bold text-center text-slate-800 mb-8">Unit Map</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">${menuBtns}</div>
                </div>
            `);

            lessonData.pages.forEach(page => {
                let html = '';
                const wrapper = (content) => `<div class="bg-white rounded-3xl shadow-xl p-10 md:p-12 pt-16 border border-slate-100 relative overflow-hidden">${content}</div>`;
                
                if (page.type === 'simple') {
                    html = wrapper(`<h2 class="text-4xl font-bold text-slate-800 mb-6">${page.content.title}</h2><div class="text-2xl text-slate-600 leading-relaxed">${page.content.text}</div>`);
                } else if (page.type === 'vocab-list') {
                    const list = page.content.words.map(w => `<div class="bg-slate-50 p-5 rounded-xl border-l-8 border-green-500"><div class="flex justify-between items-baseline"><strong class="text-green-700 text-2xl">${w.word}</strong><span class="text-lg text-gray-500 font-mono">${w.ipa}</span></div><p class="text-slate-600 italic mt-2 text-lg">${w.def}</p><p class="text-slate-800 mt-3 text-xl">"${w.sentence}"</p></div>`).join('');
                    html = wrapper(`<h2 class="text-4xl font-bold text-slate-800 mb-8">${page.content.title}</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-6">${list}</div>`);
                } else if (page.type === 'tiered-reading') {
                    html = wrapper(`
                        <h2 class="text-4xl font-bold text-slate-800 mb-6">${page.content.title}</h2>
                        <div class="flex justify-center gap-4 mb-8">
                            ${['A2','B1','B2'].map(lvl => `<button onclick="switchTier('${page.id}', '${lvl}')" class="tier-btn px-6 py-3 rounded-full font-bold ${lvl==='B1'?'active':''} text-xl shadow-sm">${lvl}</button>`).join('')}
                        </div>
                        <div id="content-${page.id}-A2" class="reading-content hidden text-2xl leading-relaxed text-slate-700 bg-green-50 p-8 rounded-2xl border-l-8 border-green-400">${page.content.texts['A2']}</div>
                        <div id="content-${page.id}-B1" class="reading-content text-2xl leading-relaxed text-slate-700 bg-blue-50 p-8 rounded-2xl border-l-8 border-blue-400">${page.content.texts['B1']}</div>
                        <div id="content-${page.id}-B2" class="reading-content hidden text-2xl leading-relaxed text-slate-700 bg-teal-50 p-8 rounded-2xl border-l-8 border-teal-400">${page.content.texts['B2']}</div>
                    `);
                } else if (page.type === 'dialogue') {
                    const lines = page.content.dialogue.split('\n\n').map(l => {
                        const [speaker, text] = l.split(': ');
                        const isLeft = ['person a'].includes(speaker.toLowerCase());
                        return `<div class="dialogue-bubble ${isLeft ? 'bubble-left' : 'bubble-right'}"><strong class="text-lg uppercase tracking-wide text-slate-500 mb-2 block">${speaker}</strong><p>${text}</p></div>`;
                    }).join('');
                    html = wrapper(`<h2 class="text-4xl font-bold text-slate-800 mb-8 text-center">${page.content.title}</h2><div class="space-y-6">${lines}</div>`);
                } else if (page.type.includes('quiz')) {
                    let qHtml = '';
                    if (page.type === 'quiz-mcq') {
                        qHtml = page.content.questions.map((q,i) => `
                            <div class="mb-8 p-6 bg-slate-50 rounded-2xl border border-slate-200 shadow-sm">
                                <p class="font-bold text-2xl mb-4 text-slate-800">${i+1}. ${q.question}</p>
                                <div class="quiz-grid">${q.options.map(opt => `<button onclick="checkMCQ(this, ${opt===q.correctAnswer})" class="quiz-option hover:bg-blue-50 shadow-sm hover:shadow-md transform hover:-translate-y-1">${opt}</button>`).join('')}</div>
                            </div>`).join('');
                    } 
                    html = wrapper(`<h2 class="text-4xl font-bold text-slate-800 mb-8 text-center">${page.content.title}</h2>${qHtml}`);
                }
                createPageElement(page.id, html);
            });
        }

        // --- HELPER FUNCTIONS ---
        window.switchTier = (pageId, tier) => {
            const page = document.getElementById(`page-${pageId}`);
            page.querySelectorAll('.reading-content').forEach(d => d.classList.add('hidden'));
            page.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
            page.querySelector(`#content-${pageId}-${tier}`).classList.remove('hidden');
            Array.from(page.querySelectorAll('.tier-btn')).find(b => b.innerText === tier).classList.add('active');
            speechService.speak(page.querySelector(`#content-${pageId}-${tier}`).innerText);
        }

        window.updateNavButtons = () => {
            const nav = document.getElementById('nav-header');
            if (currentPage === 'title-screen') nav.style.display = 'none';
            else nav.style.display = 'block';
        }

        window.checkMCQ = (btn, isCorrect) => {
            const parent = btn.parentElement;
            Array.from(parent.children).forEach(c => c.disabled = true);
            if(isCorrect) {
                btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                addPoints(10);
                playTone('C5');
            } else {
                btn.classList.add('bg-red-100', 'border-red-500', 'shake');
                playTone('C3');
            }
        }

        function addPoints(pts) { score += pts; document.getElementById('score-display').innerText = score; }
        function playTone(note) { try { const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease(note, "8n"); } catch(e){} }

        // Init
        renderPages();
    </script>
</body>
</html>
