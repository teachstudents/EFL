<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Listening Part 1 Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        :root {
            --primary: #D32F2F; /* IELTS Red */
            --secondary: #2C3E50;
            --accent: #F5F5F5;
            --text: #333;
            --correct: #2e7d32;
            --wrong: #c62828;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background-color: var(--primary);
            color: white;
            padding: 0.8rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        h1 { margin: 0; font-size: 1.4rem; }
        
        /* Header Exit Button */
        .btn-exit-header {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 0.4rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: none; /* Hidden on menu */
        }
        .btn-exit-header:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Container */
        main {
            flex: 1;
            padding: 1rem 2rem;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden; /* Prevent double scrollbars */
        }

        /* Menu View */
        #menu-view {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 800px;
            text-align: center;
            overflow-y: auto;
            padding-bottom: 2rem;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            width: 100%;
        }

        .scenario-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.2rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .scenario-btn:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.15);
        }

        .scenario-btn i {
            color: var(--primary);
            font-size: 1.3rem;
        }

        /* Game View */
        #game-view {
            display: none; /* Hidden by default */
            width: 100%;
            height: 100%;
            flex-direction: column;
        }

        /* Questions Layout */
        .questions-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            padding: 0.5rem;
            flex: 1;
        }

        .question-card {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .q-text {
            font-weight: 600;
            margin-bottom: 0.8rem;
            font-size: 1.05rem;
        }

        .options-row {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .option-btn {
            flex: 1;
            padding: 0.6rem;
            border: 2px solid #eee;
            background: #fafafa;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            text-align: center;
            transition: all 0.2s;
            min-width: 100px;
        }

        /* Locked state (during audio) */
        .option-btn.locked {
            cursor: not-allowed;
            opacity: 0.7;
            background: #f0f0f0;
            color: #888;
        }

        /* Active/Selected states */
        .option-btn:not(.locked):hover {
            border-color: #bbb;
            background: #f0f0f0;
        }

        .option-btn.selected {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .option-btn.correct {
            background: var(--correct);
            color: white;
            border-color: var(--correct);
        }

        .option-btn.incorrect {
            background: var(--wrong);
            color: white;
            border-color: var(--wrong);
        }

        .controls {
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            min-height: 50px;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-check { 
            background: var(--primary); 
            color: white; 
            display: none; /* Hidden until audio ends */
        }
        .btn-check:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Modal Overlay for Results */
        #result-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }
        .score-circle {
            width: 80px; height: 80px;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 1rem auto;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .options-row { flex-direction: column; gap: 0.5rem; }
            .option-btn { width: 100%; text-align: left; padding-left: 1rem; }
            .menu-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <h1>IELTS Listening Part 1</h1>
    <button class="btn-exit-header" id="header-exit-btn" onclick="goHome()">Exit Scenario</button>
</header>

<main>
    <!-- MENU VIEW -->
    <div id="menu-view">
        <h2 style="color: var(--secondary); margin-bottom: 1rem;">Select Scenario</h2>
        
        <div class="menu-grid">
            <!-- 1. Gym -->
            <div class="scenario-btn" onclick="startScenario(0)">
                <div>Gym Membership</div>
                <i class="fas fa-dumbbell"></i>
            </div>

            <!-- 2. Hotel -->
            <div class="scenario-btn" onclick="startScenario(1)">
                <div>Hotel Booking</div>
                <i class="fas fa-hotel"></i>
            </div>

            <!-- 3. Lost Property -->
            <div class="scenario-btn" onclick="startScenario(2)">
                <div>Lost Property</div>
                <i class="fas fa-suitcase"></i>
            </div>

            <!-- 4. Course Enquiry -->
            <div class="scenario-btn" onclick="startScenario(3)">
                <div>Course Enquiry</div>
                <i class="fas fa-graduation-cap"></i>
            </div>

            <!-- 5. Car Rental -->
            <div class="scenario-btn" onclick="startScenario(4)">
                <div>Car Rental</div>
                <i class="fas fa-car"></i>
            </div>

            <!-- 6. Library -->
            <div class="scenario-btn" onclick="startScenario(5)">
                <div>Library Card</div>
                <i class="fas fa-book"></i>
            </div>

            <!-- 7. Doctor -->
            <div class="scenario-btn" onclick="startScenario(6)">
                <div>Doctor Appt.</div>
                <i class="fas fa-user-md"></i>
            </div>

            <!-- 8. Bank -->
            <div class="scenario-btn" onclick="startScenario(7)">
                <div>Bank Account</div>
                <i class="fas fa-university"></i>
            </div>
        </div>
    </div>

    <!-- GAME VIEW -->
    <div id="game-view">
        <div class="questions-container" id="questions-container">
            <!-- Questions injected via JS -->
        </div>

        <div class="controls">
            <button id="submit-btn" class="btn btn-check" onclick="checkAnswers()">Check Answers</button>
            <div id="wait-msg" style="color: #666; font-style: italic;">Audio playing... Answers locked.</div>
        </div>
    </div>
</main>

<!-- RESULTS MODAL -->
<div id="result-modal">
    <div class="modal-content">
        <div class="score-circle" id="final-score">0/5</div>
        <h3>Session Complete</h3>
        <p id="feedback-text">Good effort!</p>
        <button class="btn btn-check" style="display:inline-block;" onclick="closeModal()">Review Answers</button>
        <button class="btn btn-home" style="padding: 0.8rem 1.5rem; border:none; background:#eee; border-radius:6px; cursor:pointer;" onclick="goHome()">Main Menu</button>
    </div>
</div>

<script>
    // --- DATA ---
    const scenarios = [
        // 1. Gym
        {
            title: "Gym Membership",
            speakers: { female: "Ava", male: "Brian" },
            questions: [
                { q: "1. Length of membership chosen:", options: ["3 months", "6 months", "12 months"], correct: 2 },
                { q: "2. The joining fee today is:", options: ["$30", "$40", "$50"], correct: 0 },
                { q: "3. Membership type includes:", options: ["Gym only", "Gym & Swim", "All access"], correct: 0 },
                { q: "4. Day of induction booked:", options: ["Monday", "Thursday", "Friday"], correct: 2 },
                { q: "5. Applicant must bring:", options: ["Towel", "ID Card", "Photo"], correct: 2 }
            ],
            script: [
                { s: "M", t: "Hi, I'd like to ask about joining the gym." },
                { s: "F", t: "Sure. We have three plans. A 3-month trial, a 6-month contract, or the full 12-month annual pass." },
                { s: "M", t: "I was thinking of the 6-month one initially." },
                { s: "F", t: "Just so you know, the 12-month pass is actually cheaper per month." },
                { s: "M", t: "Oh really? In that case, I'll go for the 12-month one to save money." },
                { s: "F", t: "Great choice. Now, there is normally a $50 joining fee." },
                { s: "M", t: "Oh, that's quite steep." },
                { s: "F", t: "However, we have a special offer today, so it's reduced to $30." },
                { s: "M", t: "Fantastic, that's much better." },
                { s: "F", t: "Now, what facilities do you want to use? The 'All Access' pass includes the pool and classes." },
                { s: "M", t: "I only really want to lift weights. Does the basic gym membership include the pool?" },
                { s: "F", t: "No, just the equipment room." },
                { s: "M", t: "That's fine, I don't like swimming anyway. Just the gym please." },
                { s: "F", t: "Okay. You'll need an induction. Can you come on Monday?" },
                { s: "M", t: "I work Mondays. Thursday is my day off." },
                { s: "F", t: "Ah, sorry, the trainer is fully booked Thursday. How about Friday morning?" },
                { s: "M", t: "Yes, Friday works for me." },
                { s: "F", t: "Perfect. Just bring some money for the fee." },
                { s: "M", t: "Do I need a towel?" },
                { s: "F", t: "We provide those. But please bring a passport-sized photo for your membership card." },
                { s: "M", t: "Okay, I'll bring a photo." }
            ]
        },
        // 2. Hotel
        {
            title: "Hotel Booking",
            speakers: { female: "Emma", male: "Andrew" },
            questions: [
                { q: "1. Room type available:", options: ["Single", "Double", "Twin"], correct: 2 },
                { q: "2. Arrival date:", options: ["15th", "16th", "17th"], correct: 0 },
                { q: "3. Price per night agreed:", options: ["$85", "$95", "$100"], correct: 0 },
                { q: "4. Meal plan selected:", options: ["Breakfast only", "Half board", "Full board"], correct: 1 },
                { q: "5. Parking location:", options: ["Garage", "Street", "Hotel Lot"], correct: 0 }
            ],
            script: [
                { s: "M", t: "Good morning, do you have any rooms for next week?" },
                { s: "F", t: "Let me check. You wanted a double room?" },
                { s: "M", t: "Yes please." },
                { s: "F", t: "I'm sorry, we are fully booked for doubles. We only have a twin room left." },
                { s: "M", t: "Oh, well, if that's all you have, the twin is fine." },
                { s: "F", t: "Okay. And that's for arrival on the 16th?" },
                { s: "M", t: "No, actually, my flight is the day before, so the 15th." },
                { s: "F", t: "Right, the 15th. Got it. The rate is normally $100 per night." },
                { s: "M", t: "Is there any discount for business travelers?" },
                { s: "F", t: "Yes, we can do it for $85." },
                { s: "M", t: "Excellent. Does that include food?" },
                { s: "F", t: "That includes breakfast. Or you can do Full Board with all meals?" },
                { s: "M", t: "I'll be out for lunch, so can I just add dinner? Is there a half-board option?" },
                { s: "F", t: "Yes, certainly. I'll put you down for half board." },
                { s: "M", t: "One last thing, parking. Do you have a hotel lot?" },
                { s: "F", t: "No, sorry. You can park on the street, but it's busy." },
                { s: "M", t: "I'd prefer somewhere safer." },
                { s: "F", t: "There is a secure garage two blocks away." },
                { s: "M", t: "Okay, I'll use the garage then." }
            ]
        },
        // 3. Lost Property
        {
            title: "Lost Property",
            speakers: { female: "Emma", male: "Brian" },
            questions: [
                { q: "1. Item lost:", options: ["Briefcase", "Backpack", "Suitcase"], correct: 1 },
                { q: "2. Color of item:", options: ["Black", "Dark Blue", "Brown"], correct: 1 },
                { q: "3. Where it was left:", options: ["On the bus", "On the train", "Station platform"], correct: 2 },
                { q: "4. Time it was lost:", options: ["2:30 PM", "3:00 PM", "3:30 PM"], correct: 1 },
                { q: "5. Important content:", options: ["Laptop", "Books", "Clothes only"], correct: 2 }
            ],
            script: [
                { s: "F", t: "Lost property office. Can I help?" },
                { s: "M", t: "Yes, I've lost my luggage. It's a suitcase." },
                { s: "F", t: "A hard-shell suitcase?" },
                { s: "M", t: "Actually, sorry, I'm confused. It's my large hiking backpack." },
                { s: "F", t: "Okay, a backpack. What color?" },
                { s: "M", t: "It's black." },
                { s: "F", t: "Solid black?" },
                { s: "M", t: "Well, under the light it actually looks dark blue. Yes, put down dark blue." },
                { s: "F", t: "Okay. And did you leave it on the train?" },
                { s: "M", t: "I thought I did, but I remember holding it when I got off. I think I left it on the platform bench." },
                { s: "F", t: "The station platform. Okay. What time was this?" },
                { s: "M", t: "My train arrived at 2:30." },
                { s: "F", t: "So you lost it then?" },
                { s: "M", t: "No, I waited for a friend for half an hour. So it was 3:00 PM." },
                { s: "F", t: "Right. 3 o'clock. Anything valuable inside? A laptop?" },
                { s: "M", t: "I had my laptop in my hand. The bag just has gym clothes." },
                { s: "F", t: "Okay, clothes only. We'll take a look." }
            ]
        },
        // 4. Course Enquiry
        {
            title: "Course Enquiry",
            speakers: { female: "Ava", male: "Andrew" },
            questions: [
                { q: "1. Language to learn:", options: ["Spanish", "French", "Italian"], correct: 0 },
                { q: "2. Level required:", options: ["Beginner", "Intermediate", "Advanced"], correct: 0 },
                { q: "3. Class start time:", options: ["6:00 PM", "7:00 PM", "7:30 PM"], correct: 2 },
                { q: "4. Course fee:", options: ["$150", "$180", "$200"], correct: 0 },
                { q: "5. Room number:", options: ["Room 10", "Room 12", "Main Hall"], correct: 1 }
            ],
            script: [
                { s: "F", t: "Hello, Language Center." },
                { s: "M", t: "Hi, I'm interested in the French evening classes." },
                { s: "F", t: "Ah, the French class is fully booked I'm afraid." },
                { s: "M", t: "Oh that's a shame. Do you have space in the Spanish one?" },
                { s: "F", t: "Yes, Spanish has space." },
                { s: "M", t: "Okay, I'll take Spanish then. I've done it before, about 10 years ago." },
                { s: "F", t: "So, Intermediate level?" },
                { s: "M", t: "Honestly, I've forgotten it all. I better start from scratch. Beginner please." },
                { s: "F", t: "Beginner it is. That runs on Tuesdays." },
                { s: "M", t: "What time? I finish work at 6." },
                { s: "F", t: "The class usually starts at 6, which might be tight for you." },
                { s: "M", t: "Yeah, I can't make that." },
                { s: "F", t: "Wait, the Beginner class is actually later. It starts at 7:30." },
                { s: "M", t: "7:30 is perfect." },
                { s: "F", t: "Great. The fee is $200." },
                { s: "M", t: "I'm a student at the university. Do I get a discount?" },
                { s: "F", t: "Yes, students pay $150." },
                { s: "M", t: "Excellent. Where do I go?" },
                { s: "F", t: "It's in the Main Hall usually. Oh no, sorry, they moved it to Room 12 this term." },
                { s: "M", t: "Room 12. Got it." }
            ]
        },
        // 5. Car Rental
        {
            title: "Car Rental",
            speakers: { female: "Emma", male: "Brian" },
            questions: [
                { q: "1. Type of car requested:", options: ["Compact", "Sedan", "SUV"], correct: 0 },
                { q: "2. Rental duration:", options: ["3 days", "5 days", "7 days"], correct: 1 },
                { q: "3. Insurance cover:", options: ["Basic", "Standard", "Premium"], correct: 2 },
                { q: "4. Total cost quoted:", options: ["$200", "$250", "$300"], correct: 1 },
                { q: "5. Pick up location:", options: ["Airport", "City Center", "Hotel"], correct: 0 }
            ],
            script: [
                { s: "F", t: "Welcome to City Rentals. How can I help?" },
                { s: "M", t: "Hi, I need a car for a few days." },
                { s: "F", t: "Okay. What size? We have a special on SUVs." },
                { s: "M", t: "No, I just need something small and easy to park. A compact car." },
                { s: "F", t: "Compact. Sure. For how long?" },
                { s: "M", t: "From Monday to Friday." },
                { s: "F", t: "Okay, that's 5 days." },
                { s: "M", t: "I might extend it to Sunday." },
                { s: "F", t: "For now, I'll book it for 5 days. You can call to extend." },
                { s: "M", t: "Fine. What about insurance?" },
                { s: "F", t: "Basic cover is included. But there is a high excess." },
                { s: "M", t: "I'd prefer full protection. No risks." },
                { s: "F", t: "Okay, I'll add the Premium cover then. That brings the total to $300." },
                { s: "M", t: "That's a bit high. Can you do any better?" },
                { s: "F", t: "I can apply a discount code... okay, $250." },
                { s: "M", t: "Deal. $250. Do I pick it up here in the city?" },
                { s: "F", t: "You can, but the car is actually at our Airport branch." },
                { s: "M", t: "That's actually better, I'm flying in anyway." }
            ]
        },
        // 6. Library Card
        {
            title: "Library Card",
            speakers: { female: "Ava", male: "Andrew" },
            questions: [
                { q: "1. Document needed for ID:", options: ["Passport", "Driving License", "Bill"], correct: 2 },
                { q: "2. Number of books allowed:", options: ["5", "8", "10"], correct: 1 },
                { q: "3. Loan period:", options: ["2 weeks", "3 weeks", "4 weeks"], correct: 1 },
                { q: "4. Fine for late return:", options: ["10 cents", "20 cents", "50 cents"], correct: 1 },
                { q: "5. Internet access cost:", options: ["Free", "$1/hour", "$2/hour"], correct: 0 }
            ],
            script: [
                { s: "F", t: "Good morning, would you like to join the library?" },
                { s: "M", t: "Yes please." },
                { s: "F", t: "Do you have ID? A passport?" },
                { s: "M", t: "I left my passport at home. I have my driving license though." },
                { s: "F", t: "Sorry, it needs to have your current address. Do you have a utility bill?" },
                { s: "M", t: "I have a water bill on my phone." },
                { s: "F", t: "That works. A bill is fine. Now, you can borrow up to 10 items." },
                { s: "M", t: "Great." },
                { s: "F", t: "But only 8 of those can be books. The rest can be DVDs." },
                { s: "M", t: "Okay, 8 books is plenty." },
                { s: "F", t: "You can keep them for 4 weeks." },
                { s: "M", t: "Oh, really? My old library was 2 weeks." },
                { s: "F", t: "Wait, sorry, I'm looking at the staff rules. For members it's 3 weeks." },
                { s: "M", t: "3 weeks. Got it. And if I'm late?" },
                { s: "F", t: "It's 50 cents a day." },
                { s: "M", t: "That's expensive." },
                { s: "F", t: "Oh, hold on, that's for DVDs. Books are 20 cents a day." },
                { s: "M", t: "Phew, okay. Do I pay for the computers?" },
                { s: "F", t: "No, internet is free for members for one hour." },
                { s: "M", t: "Excellent." }
            ]
        },
        // 7. Doctor Appointment
        {
            title: "Doctor Appt.",
            speakers: { female: "Emma", male: "Andrew" },
            questions: [
                { q: "1. Doctor requested:", options: ["Dr. Smith", "Dr. Jones", "Dr. Brown"], correct: 2 },
                { q: "2. Appointment day:", options: ["Tuesday", "Wednesday", "Thursday"], correct: 1 },
                { q: "3. Time available:", options: ["9:30 AM", "10:00 AM", "2:00 PM"], correct: 2 },
                { q: "4. Reason for visit:", options: ["Vaccine", "Check-up", "Prescription"], correct: 0 },
                { q: "5. Patient needs to bring:", options: ["Insurance Card", "Previous Records", "Mask"], correct: 2 }
            ],
            script: [
                { s: "F", t: "Medical Center. How can I help?" },
                { s: "M", t: "I'd like to see a doctor please. Dr. Smith is my usual." },
                { s: "F", t: "I'm afraid Dr. Smith is on holiday. Dr. Jones is available." },
                { s: "M", t: "I'd prefer someone else. Is Dr. Brown there?" },
                { s: "F", t: "Yes, Dr. Brown is working this week." },
                { s: "M", t: "Okay, Dr. Brown then. Can I come on Tuesday?" },
                { s: "F", t: "Tuesday is fully booked. How about Wednesday?" },
                { s: "M", t: "Wednesday works." },
                { s: "F", t: "I have a slot at 9:30 AM." },
                { s: "M", t: "That's too early. Anything in the afternoon?" },
                { s: "F", t: "I have 2:00 PM." },
                { s: "M", t: "2:00 PM is perfect." },
                { s: "F", t: "Is it for a routine check-up?" },
                { s: "M", t: "No, I need a travel vaccine." },
                { s: "F", t: "Okay, a vaccination. Please remember to wear a face mask." },
                { s: "M", t: "Do I need my insurance card?" },
                { s: "F", t: "No, we have that on file. Just the mask." }
            ]
        },
        // 8. Bank Account
        {
            title: "Bank Account",
            speakers: { female: "Ava", male: "Brian" },
            questions: [
                { q: "1. Account type:", options: ["Savings", "Checking", "Student"], correct: 2 },
                { q: "2. Monthly fee:", options: ["Free", "$5", "$10"], correct: 0 },
                { q: "3. Minimum deposit:", options: ["$50", "$100", "$500"], correct: 0 },
                { q: "4. Interest rate:", options: ["1.5%", "2%", "3%"], correct: 1 },
                { q: "5. Free gift included:", options: ["Pen", "Notepad", "Movie Tickets"], correct: 2 }
            ],
            script: [
                { s: "F", t: "Welcome to Metro Bank. Are you opening a new account?" },
                { s: "M", t: "Yes, I need a checking account for my salary." },
                { s: "F", t: "We have a standard Checking Account with a $5 monthly fee." },
                { s: "M", t: "I'm actually a student part-time. Does that help?" },
                { s: "F", t: "Oh, in that case, you qualify for the Student Account." },
                { s: "M", t: "Is there a fee for that?" },
                { s: "F", t: "No, it's completely free." },
                { s: "M", t: "Great, I'll take the Student one." },
                { s: "F", t: "You need to make an initial deposit. Usually it's $100." },
                { s: "M", t: "I only have $50 on me right now." },
                { s: "F", t: "That's fine, for students the minimum is just $50." },
                { s: "M", t: "Perfect. What's the interest rate?" },
                { s: "F", t: "It was 1.5% last year, but we've just increased it to 2%." },
                { s: "M", t: "2% sounds good." },
                { s: "F", t: "And you get a free gift for joining." },
                { s: "M", t: "A pen?" },
                { s: "F", t: "Better. Two movie tickets." },
                { s: "M", t: "Wow, nice." }
            ]
        }
    ];

    // --- STATE ---
    let currentScenario = null;
    let selectedAnswers = [];
    let isAudioPlaying = false;
    let synth = window.speechSynthesis;
    let voices = [];

    // --- INITIALIZATION ---
    window.onload = function() {
        // Force voice loading
        voices = synth.getVoices();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = () => { voices = synth.getVoices(); };
        }
    };

    function goHome() {
        cancelAudio();
        document.getElementById('game-view').style.display = 'none';
        document.getElementById('menu-view').style.display = 'flex';
        document.getElementById('result-modal').style.display = 'none';
        
        // Header button logic
        document.getElementById('header-exit-btn').style.display = 'none';
    }

    // --- GAME LOGIC ---
    function startScenario(index) {
        currentScenario = scenarios[index];
        selectedAnswers = new Array(5).fill(null);
        
        // UI Setup
        document.getElementById('menu-view').style.display = 'none';
        document.getElementById('game-view').style.display = 'flex';
        document.getElementById('header-exit-btn').style.display = 'block';
        
        // Render Questions
        const qContainer = document.getElementById('questions-container');
        qContainer.innerHTML = '';
        currentScenario.questions.forEach((q, i) => {
            const card = document.createElement('div');
            card.className = 'question-card';
            card.innerHTML = `
                <div class="q-text">${q.q}</div>
                <div class="options-row" id="q${i}-options">
                    ${q.options.map((opt, optIndex) => `
                        <button class="option-btn locked" onclick="selectOption(${i}, ${optIndex})" id="btn-${i}-${optIndex}">
                            ${opt}
                        </button>
                    `).join('')}
                </div>
            `;
            qContainer.appendChild(card);
        });

        // Controls Reset
        document.getElementById('submit-btn').style.display = 'none';
        document.getElementById('wait-msg').style.display = 'block';
        document.getElementById('wait-msg').textContent = "Audio playing... Listen carefully. Answers locked.";

        // Start Audio
        setTimeout(() => playScript(currentScenario.script, currentScenario.speakers), 500);
    }

    function selectOption(qIndex, optIndex) {
        if (isAudioPlaying) return; // Locked during audio

        selectedAnswers[qIndex] = optIndex;
        
        // Visual Update
        const buttons = document.querySelectorAll(`#q${qIndex}-options .option-btn`);
        buttons.forEach((btn, idx) => {
            if (idx === optIndex) btn.classList.add('selected');
            else btn.classList.remove('selected');
        });
    }

    function checkAnswers() {
        let score = 0;
        currentScenario.questions.forEach((q, i) => {
            const userAns = selectedAnswers[i];
            const correctAns = q.correct;
            
            // Score
            if (userAns === correctAns) score++;

            // Visual Feedback
            const buttons = document.querySelectorAll(`#q${i}-options .option-btn`);
            buttons.forEach((btn, idx) => {
                btn.classList.remove('selected');
                if (idx === correctAns) btn.classList.add('correct'); // Show correct (Green)
                if (idx === userAns && idx !== correctAns) btn.classList.add('incorrect'); // Show error (Red)
            });
        });

        // Show Modal
        document.getElementById('final-score').textContent = `${score}/5`;
        document.getElementById('feedback-text').textContent = score === 5 ? "Perfect Score! You avoided all the traps!" : "Review your mistakes. Watch out for distractors!";
        document.getElementById('result-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
    }

    // --- AUDIO SYSTEM ---
    function getVoice(name, gender) {
        // Priority 1: Specific Microsoft Natural Voice requested
        const specific = voices.find(v => v.name.includes("Microsoft " + name) && v.name.includes("Natural"));
        if (specific) return specific;

        // Priority 2: Any Microsoft Voice of that name
        const msName = voices.find(v => v.name.includes("Microsoft " + name));
        if (msName) return msName;

        // Priority 3: Fallback based on gender/locale
        // Basic heuristic for Male vs Female if name match fails
        if (gender === 'F') {
            return voices.find(v => v.name.includes("Female") || v.name.includes("Google US English") || v.name.includes("Samantha"));
        } else {
            return voices.find(v => v.name.includes("Male") || v.name.includes("Google UK English Male") || v.name.includes("Daniel"));
        }
    }

    function cancelAudio() {
        if (synth.speaking) synth.cancel();
        isAudioPlaying = false;
    }

    async function playScript(script, speakers) {
        cancelAudio();
        isAudioPlaying = true;
        
        // Find Voices
        const femaleVoice = getVoice(speakers.female, 'F');
        const maleVoice = getVoice(speakers.male, 'M');

        for (let i = 0; i < script.length; i++) {
            if (!isAudioPlaying) break; // Exit if cancelled

            const line = script[i];
            const utter = new SpeechSynthesisUtterance(line.t);
            
            // Settings
            utter.voice = line.s === 'F' ? femaleVoice : maleVoice;
            utter.rate = 1.0; // Normal Speed
            utter.pitch = 1;

            // Promise wrapper to wait for end
            await new Promise(resolve => {
                utter.onend = resolve;
                utter.onerror = resolve; // Handle errors gracefully
                synth.speak(utter);
            });

            // Small pause between speakers
            await new Promise(r => setTimeout(r, 400));
        }

        // End of Audio
        isAudioPlaying = false;
        document.getElementById('wait-msg').style.display = 'none';
        document.getElementById('submit-btn').style.display = 'inline-block';
        
        // Unlock buttons
        const allBtns = document.querySelectorAll('.option-btn');
        allBtns.forEach(btn => btn.classList.remove('locked'));
    }

</script>

</body>
</html>
