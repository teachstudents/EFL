<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grade 7 Speaking Master</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts: Nunito is rounded and friendly for younger students -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* Base Styles */
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
      overflow: hidden;
      color: #2d3748;
    }

    /* Container */
    .app-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
      position: relative;
    }

    /* Cards/Screens */
    .screen-card {
      background: rgba(255, 255, 255, 0.96);
      border-radius: 20px;
      padding: 1rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 1200px;
      height: 98vh;
      display: none; /* Hidden by default */
      flex-direction: column;
      animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      border: 3px solid #fff;
    }

    .screen-card.active {
      display: flex;
    }

    @keyframes popIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Setup Screen */
    .input-group {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        padding: 0.8rem;
        border-radius: 12px;
        margin-bottom: 0.8rem;
    }

    .student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 0.6rem;
      overflow-y: auto;
      padding: 0.5rem;
      background: #f0f4f8;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      flex-grow: 1;
    }

    .student-card {
      background: #fff;
      border: 2px solid #cbd5e0;
      border-radius: 10px;
      padding: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .student-card:hover { border-color: #4fd1c5; transform: translateY(-2px); }
    .student-card.selected { background: #e6fffa; border-color: #38b2ac; }
    
    .student-avatar {
      width: 28px;
      height: 28px;
      background: #edf2f7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #4a5568;
      font-size: 0.8rem;
    }

    /* Speaking Screen Layout */
    .speaking-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding: 0 0.5rem;
        gap: 1rem;
    }
    
    .nav-btn {
        background: #edf2f7;
        color: #4a5568;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.9rem;
        border: 2px solid #cbd5e0;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }
    .nav-btn:hover { background: #e2e8f0; transform: translateY(-1px); }
    
    .nav-btn.next-student { background: #ebf8ff; color: #3182ce; border-color: #bee3f8; }
    .nav-btn.next-student:hover { background: #bee3f8; }

    .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #f7fafc;
        padding: 0.25rem;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
    }

    .control-btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: white;
        border: 1px solid #cbd5e0;
        cursor: pointer;
        color: #4a5568;
        transition: all 0.1s;
    }
    .control-btn:hover { background: #edf2f7; color: #2b6cb0; }
    .control-btn.active { background: #bee3f8; color: #2c5282; border-color: #90cdf4; }

    .question-layout {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 0.8rem;
      overflow: hidden;
    }

    /* Big Question Box */
    .question-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      border-radius: 16px;
      font-family: 'Fredoka', sans-serif;
      text-align: center;
      box-shadow: 0 5px 15px rgba(118, 75, 162, 0.25);
      position: relative;
      min-height: 20%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid rgba(255,255,255,0.2);
    }

    .question-text-display {
      font-size: 1.6rem; 
      line-height: 1.3;
      font-weight: 500;
      padding: 0 2rem;
    }

    /* Help Section (Bento Grid) */
    .help-grid {
      display: grid;
      grid-template-columns: 1.2fr 1.2fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 0.8rem;
      flex-grow: 1;
      min-height: 0;
    }

    /* Mobile handling handled by Tailwind classes in HTML generally, but grid needs help */
    @media (max-width: 768px) {
        .help-grid { grid-template-columns: 1fr; grid-template-rows: auto; overflow-y: auto; }
    }

    .help-panel {
      background: #fff;
      border: 2px solid #edf2f7;
      border-radius: 14px;
      padding: 0.8rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .help-header {
      font-family: 'Fredoka', sans-serif;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-weight: bold;
      border-bottom: 2px solid #f7fafc;
      padding-bottom: 0.2rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      overflow-y: auto;
      align-content: flex-start;
      height: 100%;
    }

    .tag {
      background: #f7fafc;
      padding: 0.3rem 0.6rem;
      border-radius: 8px;
      border: 1px solid #cbd5e0;
      font-size: 0.9rem;
      color: #2d3748;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.1s;
    }
    .tag:active { transform: scale(0.95); background: #e2e8f0; }
    
    .tag.highlight { background: #feebc8; border-color: #fbd38d; color: #744210; }
    .tag.structure { background: #e6fffa; border-color: #81e6d9; color: #234e52; width: 100%; text-align: left; }
    .tag.grammar { background: #ebf4ff; border-color: #a3bffa; color: #434190; font-family: monospace; }
    
    /* Timer & Progress */
    .timer-float {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(4px);
      color: white;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: 800;
      font-size: 1.1rem; 
      border: 2px solid rgba(255,255,255,0.4);
    }

    .progress-track {
      width: 100%;
      height: 10px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: auto;
      flex-shrink: 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #48bb78, #38a169);
      width: 100%;
      /* Transition handled by JS for pause support */
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #4fd1c5 0%, #38b2ac 100%);
      color: white;
      padding: 0.8rem 2rem;
      border-radius: 12px;
      font-weight: bold;
      font-size: 1.2rem;
      border: none;
      cursor: pointer;
      width: 100%;
      font-family: 'Fredoka', sans-serif;
      box-shadow: 0 4px 0 #2c7a7b;
    }
    .btn-primary:active { transform: translateY(4px); box-shadow: none; }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; background: #cbd5e0; box-shadow: none; transform: none; }

    /* Selection Screen */
    .roulette-wrapper {
      background: #2d3748;
      color: white;
      border-radius: 30px;
      padding: 3rem 1rem;
      text-align: center;
      margin: 2rem 0;
      border: 8px solid #4a5568;
    }
    .roulette-name { font-size: 3.5rem; font-family: 'Fredoka', sans-serif; }

    /* Transition Overlay */
    #transition-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.98);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 50;
        border-radius: 24px;
    }
    
    .hidden { display: none !important; }
  </style>
 </head>
 <body>

 <div class="app-container">

  <!-- 1. SETUP SCREEN -->
  <div id="screen-setup" class="screen-card active">
    <h1 class="text-3xl font-extrabold text-center text-gray-700 mb-4 font-fredoka">Junior Speaking Master üéì</h1>
    
    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="input-group flex flex-col justify-center">
            <label class="font-bold text-gray-500 mb-1 text-xs uppercase">Topic (10 Choices)</label>
            <select id="theme-select" class="w-full p-2 bg-white border border-gray-300 rounded-lg font-bold text-lg text-gray-700 outline-none focus:border-blue-400">
                <!-- JS Populates -->
            </select>
        </div>
        
        <div class="input-group">
            <label class="font-bold text-gray-500 mb-1 text-xs uppercase">Paste Class List</label>
            <div class="flex gap-2">
                <textarea id="paste-area" class="w-full p-2 h-16 bg-white border border-gray-300 rounded-lg text-xs" placeholder="Alice&#10;Bob..."></textarea>
                <button onclick="parsePastedNames()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold px-3 rounded text-sm">Load</button>
            </div>
        </div>
    </div>

    <div class="flex-grow flex flex-col min-h-0">
      <div class="flex justify-between items-end mb-2">
        <h2 class="text-lg font-bold text-gray-700">Student List <span id="student-count" class="text-gray-400 text-sm">(0)</span></h2>
        <div class="space-x-2">
            <button onclick="addPlaceholderStudents()" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200">Add 20</button>
            <button onclick="selectAllStudents()" class="text-blue-500 font-bold hover:bg-blue-50 px-2 py-1 rounded text-sm">All</button>
        </div>
      </div>
      
      <div id="student-grid" class="student-grid">
        <div class="col-span-full text-center text-gray-400 py-8 italic text-sm">
            Paste names above or click "Add 20" to start.
        </div>
      </div>
    </div>

    <button id="btn-start" class="btn-primary mt-4" disabled>üöÄ Start Class!</button>
  </div>

  <!-- 2. PREVIEW SCREEN -->
  <div id="screen-preview" class="screen-card">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-extrabold text-gray-700 font-fredoka">Today's Mission</h2>
      <div class="bg-red-500 text-white font-black px-4 py-1 rounded-full text-xl shadow-lg border-2 border-red-600" id="preview-timer">60</div>
    </div>
    
    <div id="preview-content" class="flex flex-col gap-3 h-full overflow-y-auto">
      <!-- Populated by JS -->
    </div>
  </div>

  <!-- 3. SELECTION SCREEN -->
  <div id="screen-selection" class="screen-card" style="max-width: 800px; justify-content: center; align-items: center;">
    <h2 class="text-3xl font-extrabold text-gray-600 text-center mb-6">Who is next?</h2>
    <div class="roulette-wrapper w-full">
      <div id="roulette-display" class="roulette-name">...</div>
    </div>
  </div>

  <!-- 4. COUNTDOWN SCREEN -->
  <div id="screen-countdown" class="screen-card" style="justify-content: center; align-items: center;">
    <div id="countdown-display" class="text-9xl font-black text-purple-600 font-fredoka animate-bounce">3</div>
    <div id="next-speaker-name" class="text-3xl mt-8 font-bold text-blue-500 bg-blue-50 px-6 py-2 rounded-full"></div>
  </div>

  <!-- 5. SPEAKING SCREEN (MAIN) -->
  <div id="screen-speaking" class="screen-card">
    <!-- Overlay -->
    <div id="transition-overlay">
        <div class="text-6xl mb-4">üåü</div>
        <h1 class="text-5xl font-black text-blue-500 mb-2 font-fredoka">Awesome!</h1>
        <p class="text-xl text-gray-400 font-bold">Getting next student...</p>
    </div>

    <!-- Navigation Header -->
    <div class="speaking-header">
        <button onclick="location.reload()" class="nav-btn" title="Back Home">
            üè†
        </button>
        
        <!-- Center Controls -->
        <div class="flex items-center gap-4">
            <div class="control-group">
                <button class="control-btn" onclick="changePart(-1)" title="Previous Part">‚¨ÖÔ∏è</button>
                <button id="btn-pause" class="control-btn" onclick="togglePause()" title="Pause Timer">‚è∏Ô∏è</button>
                <button class="control-btn" onclick="changePart(1)" title="Next Part">‚û°Ô∏è</button>
            </div>
            
            <div class="flex items-center gap-2">
                <span id="part-indicator" class="text-xs font-bold uppercase tracking-wider text-gray-400">Part 1</span>
                <span id="speaker-indicator" class="text-sm font-bold bg-gray-100 px-3 py-1 rounded-full text-gray-600">Student</span>
            </div>
        </div>

        <button onclick="finishStudent()" class="nav-btn next-student">
            Next Student ‚è≠Ô∏è
        </button>
    </div>

    <div class="question-layout">
      
      <!-- Top: Big Question -->
      <div class="question-box">
        <div id="question-timer" class="timer-float">30</div>
        <div id="question-text" class="question-text-display cursor-pointer" onclick="speakText(this.textContent)">
          Question text goes here...
        </div>
      </div>

      <!-- Bottom: BENTO GRID SCAFFOLDS -->
      <div class="help-grid">
        
        <!-- 1. Structure & Flow -->
        <div class="help-panel border-purple-200">
          <div class="help-header text-purple-600"><span>üèóÔ∏è</span> Structure Template</div>
          <div id="structure-container" class="tag-container">
              <!-- JS Populates: Yes/No, How long -->
          </div>
        </div>

        <!-- 2. Sentence Starters -->
        <div class="help-panel border-blue-200 row-span-2">
          <div class="help-header text-blue-600"><span>üó£Ô∏è</span> Sentence Starters</div>
          <div id="stems-container" class="tag-container"></div>
        </div>

        <!-- 3. Vocabulary Power (Click to listen) -->
        <div class="help-panel border-green-200 row-span-2">
          <div class="help-header text-green-600"><span>üìö</span> Vocabulary (Tap to Listen)</div>
          <div id="words-container" class="tag-container"></div>
        </div>

        <!-- 4. Fluency Fillers & Signposts -->
        <div class="help-panel border-orange-200">
            <div class="help-header text-orange-600"><span>üåä</span> Fluency Fillers</div>
            <div id="fluency-container" class="tag-container"></div>
        </div>

         <!-- 5. Grammar & Quantifiers -->
         <!-- Note: This grid cell might need adjustment depending on screen size, 
              but in this grid it fits under structure or as a separate block -->
         <!-- We will merge Grammar into the first column row 2 -->
      </div>
      
      <!-- Grammar Bar (Extra row visually) -->
      <div class="flex gap-2 overflow-x-auto pb-1" id="grammar-bar">
          <!-- Populated by JS -->
      </div>

      <div class="progress-track">
        <div id="progress-bar" class="progress-fill"></div>
      </div>
      
    </div>
  </div>

 </div>

 <script>
/* * GRADE 7 CONFIGURATION * */

/* --- STATIC SCAFFOLDS --- */
const SCAFFOLDS = {
    fillers: ["Let me see...", "Well...", "Actually...", "To be honest...", "I mean...", "You know..."],
    signposts: ["First...", "Then...", "After that...", "However...", "Also...", "Finally..."],
    quantifiers: ["Too much (+ noun)", "Too many (+ noun)", "A lot of...", "Not enough..."],
    grammar_patterns: [
        "I enjoy + DOING", 
        "I used to + VERB", 
        "It takes (time) to...", 
        "If I have time, I will..."
    ],
    templates: {
        part1: ["Answer (Yes/No)", "Reason (Because...)", "Example (For instance...)"],
        part2: ["Introduction", "Details (Who/Where/When)", "Feeling (Why I liked it)"],
        part3: ["Opinion", "Reason", "Example", "Conclusion"]
    }
};

/* --- THEMES (Expanded) --- */
const THEMES = [
  {
    name: "üéÆ Video Games",
    idiom: "Game changer",
    collocations: ["Play online", "Beat the boss", "High score", "Level up"],
    part1: "What is your favorite video game right now?",
    part1_stems: ["My favorite game is...", "I love playing...", "It's fun because...", "I play on my..."],
    part1_words: ["online", "teammates", "level up", "win", "lose", "graphics", "exciting"],
    
    part2: "Talk about a game you played recently. What was it? Did you win? Who did you play with?",
    part2_stems: ["I played...", "It was hard because...", "I played with...", "The best part was..."],
    part2_words: ["strategy", "character", "score", "victory", "challenge", "multiplayer"],
    
    part3: "Are video games good for your brain?",
    part3_stems: ["Yes, because...", "They help us...", "However, too much...", "We can learn..."],
    part3_words: ["reaction time", "solving", "addiction", "relax", "eyesight"]
  },
  {
    name: "üé® Hobbies",
    idiom: "Practice makes perfect",
    collocations: ["Spend time", "Take up a hobby", "Join a club"],
    part1: "What do you do in your free time?",
    part1_stems: ["I usually...", "I like to...", "My hobby is...", "I enjoy..."],
    part1_words: ["drawing", "reading", "dancing", "collecting", "music", "relaxing"],
    
    part2: "Describe a new hobby you want to learn. What is it? Why do you want to learn it?",
    part2_stems: ["I want to learn...", "It looks...", "My friend does it...", "I need to buy..."],
    part2_words: ["instrument", "skill", "creative", "interesting", "talent", "effort"],
    
    part3: "Why is it important to have hobbies?",
    part3_stems: ["Hobbies help us...", "We can forget...", "It makes life...", "We make friends..."],
    part3_words: ["stress", "happiness", "balance", "social", "community", "fun"]
  },
  {
    name: "üçî Food",
    idiom: "Eat like a horse",
    collocations: ["Fast food", "Balanced diet", "Grab a bite", "Home cooked"],
    part1: "What is your favorite meal of the day?",
    part1_stems: ["I love breakfast...", "Dinner is best...", "I usually eat...", "My mom cooks..."],
    part1_words: ["breakfast", "lunch", "dinner", "delicious", "hungry", "full"],
    
    part2: "Describe a delicious meal you ate recently. What was it? Where? Who with?",
    part2_stems: ["I ate...", "We went to...", "It tasted...", "It was special because..."],
    part2_words: ["spicy", "sweet", "flavor", "restaurant", "chef", "homemade"],
    
    part3: "Is it important to eat healthy food?",
    part3_stems: ["Yes, definitely...", "We need vitamins...", "If we eat bad food...", "Healthy food..."],
    part3_words: ["vegetables", "energy", "grow", "strong", "vitamins", "body"]
  },
  {
    name: "üç´ Snacks",
    idiom: "Sweet tooth",
    collocations: ["Junk food", "Healthy snack", "Late night snack"],
    part1: "What is your favorite snack?",
    part1_stems: ["I really like...", "I often buy...", "Chocolate is my...", "I prefer salty..."],
    part1_words: ["chips", "chocolate", "candy", "cookies", "fruit", "yogurt"],
    
    part2: "Describe a snack shop near your school. What does it sell? Do you go often?",
    part2_stems: ["There is a shop...", "It sells...", "I go there...", "It is popular..."],
    part2_words: ["convenience store", "buy", "price", "choice", "popular", "cheap"],
    
    part3: "Should students eat snacks in class?",
    part3_stems: ["I think...", "It might be messy...", "Maybe only...", "It helps us focus..."],
    part3_words: ["messy", "distraction", "break time", "hungry", "focus", "rules"]
  },
  {
    name: "üè´ School Life",
    idiom: "Teacher's pet",
    collocations: ["Do homework", "Take a test", "Pay attention", "Skip class"],
    part1: "What is your favorite subject?",
    part1_stems: ["I like Math...", "English is fun...", "PE is best...", "I am good at..."],
    part1_words: ["subject", "learn", "interesting", "boring", "difficult", "easy"],
    
    part2: "Talk about a school trip. Where did you go? Did you have fun?",
    part2_stems: ["We went to...", "We took a bus...", "I sat with...", "We saw..."],
    part2_words: ["museum", "park", "bus", "classmates", "photos", "memory"],
    
    part3: "Do you think homework is useful?",
    part3_stems: ["Sometimes...", "Too much is...", "We need time...", "It helps us remember..."],
    part3_words: ["practice", "review", "stress", "free time", "grades", "study"]
  },
  {
    name: "üéâ Holidays",
    idiom: "Have a blast",
    collocations: ["Public holiday", "Celebrate with", "Family reunion"],
    part1: "What is your favorite festival?",
    part1_stems: ["My favorite is...", "I like Spring Festival...", "Because we can...", "I get to..."],
    part1_words: ["celebrate", "family", "tradition", "happy", "gift", "holiday"],
    
    part2: "Describe last Spring Festival. What did you eat? Who did you see?",
    part2_stems: ["We had dinner...", "I got red envelopes...", "We visited...", "We watched..."],
    part2_words: ["dumplings", "red envelope", "fireworks", "grandparents", "reunion", "lucky"],
    
    part3: "Why are festivals important?",
    part3_stems: ["Families come together...", "We work hard...", "It is time to...", "We remember..."],
    part3_words: ["together", "love", "share", "connect", "culture", "rest"]
  },
  {
    name: "‚úàÔ∏è Travel",
    idiom: "Hit the road",
    collocations: ["Book a ticket", "Go sightseeing", "Take photos"],
    part1: "Do you prefer cars, trains, or planes?",
    part1_stems: ["I prefer trains...", "Planes are fast...", "I like cars...", "Trains are comfy..."],
    part1_words: ["fast", "slow", "comfortable", "view", "ticket", "station"],
    
    part2: "Describe a city you want to visit. Where? Why?",
    part2_stems: ["I want to go to...", "It is in...", "I want to see...", "The food is..."],
    part2_words: ["famous", "sightseeing", "beautiful", "scenery", "tourist", "explore"],
    
    part3: "What can we learn when we travel?",
    part3_stems: ["We learn about...", "We see different...", "It opens our eyes...", "We try new..."],
    part3_words: ["culture", "history", "people", "world", "language", "customs"]
  },
  {
    name: "ü¶Å Animals",
    idiom: "Busy as a bee",
    collocations: ["Wild animal", "Endangered species", "Natural habitat"],
    part1: "What is your favorite wild animal?",
    part1_stems: ["I like pandas...", "Lions are cool...", "Monkeys are funny...", "My favorite is..."],
    part1_words: ["cute", "strong", "fast", "fur", "dangerous", "forest"],
    
    part2: "Describe a visit to the zoo. Who with? What did you see?",
    part2_stems: ["I went with...", "We saw a big...", "The weather was...", "My favorite part..."],
    part2_words: ["zoo", "cage", "ticket", "watch", "feed", "animals"],
    
    part3: "Are zoos good or bad?",
    part3_stems: ["It protects them...", "But they need freedom...", "Zoos help us learn...", "Cages are small..."],
    part3_words: ["protect", "wild", "nature", "cage", "freedom", "sad"]
  },
  {
    name: "üê∂ Pets",
    idiom: "Raining cats and dogs",
    collocations: ["Walk the dog", "Feed the cat", "Look after"],
    part1: "Do you have a pet?",
    part1_stems: ["I have a...", "I don't have one...", "I want a cat...", "My mom says no..."],
    part1_words: ["dog", "cat", "fish", "hamster", "cute", "noisy"],
    
    part2: "Describe the perfect pet. What is it? Name?",
    part2_stems: ["I want a...", "I would name it...", "I would feed it...", "We would play..."],
    part2_words: ["walk", "feed", "clean", "responsibility", "loyal", "friend"],
    
    part3: "Is it hard to keep a pet?",
    part3_stems: ["Yes, you must...", "You need to clean...", "Food costs money...", "It takes time..."],
    part3_words: ["responsibility", "time", "money", "care", "sick", "love"]
  },
  {
    name: "üèÄ Sports",
    idiom: "Give it your best shot",
    collocations: ["Score a goal", "Win a match", "Join a team"],
    part1: "What sport do you like?",
    part1_stems: ["I like basketball...", "I watch football...", "I am good at...", "I don't like sports..."],
    part1_words: ["basketball", "football", "badminton", "running", "swimming", "team"],
    
    part2: "Describe a sport you do at school.",
    part2_stems: ["In PE we play...", "I play with...", "It makes me tired...", "It is good exercise..."],
    part2_words: ["PE class", "playground", "run", "jump", "teamwork", "score"],
    
    part3: "Why is exercise important?",
    part3_stems: ["We sit all day...", "It makes us strong...", "It helps relax...", "Health is important..."],
    part3_words: ["healthy", "strong", "fit", "energy", "sick", "move"]
  }
];

let state = {
  selectedThemeIndex: 0,
  selectedStudents: new Set(),
  remainingStudents: [],
  currentStudent: null,
  currentPart: 1,
  timerInterval: null,
  audioContext: null,
  isPaused: false,
  remainingTime: 0,
  duration: 0
};

// Default list is empty. Users add them.
let STUDENTS = [];

// TIMING (Seconds) - Shorter for younger students
const TIMING = {
    part1: 30, // Easy Question
    part2: 60, // Long Turn
    part3: 30  // Discussion
};

/* --- AUDIO EFFECTS --- */
function initAudio() {
    if (!state.audioContext) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        state.audioContext = new AudioContext();
    }
    if (state.audioContext.state === 'suspended') {
        state.audioContext.resume();
    }
}

function playTone(freq, type, duration) {
  if(!state.audioContext) return;
  const osc = state.audioContext.createOscillator();
  const gain = state.audioContext.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, state.audioContext.currentTime);
  gain.gain.setValueAtTime(0.1, state.audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, state.audioContext.currentTime + duration);
  osc.connect(gain);
  gain.connect(state.audioContext.destination);
  osc.start();
  osc.stop(state.audioContext.currentTime + duration);
}

function playClick() { playTone(600, 'square', 0.1); }
function playTick() { playTone(800, 'sine', 0.1); }
function playWin() { 
  if(!state.audioContext) return;
  [523, 659, 783, 1046].forEach((f, i) => setTimeout(() => playTone(f, 'triangle', 0.4), i * 100));
}

/* --- TTS (Enhanced for Multilingual/Andrew/Ava) --- */
function speakText(text) {
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  
  const voices = window.speechSynthesis.getVoices();
  // Prioritize Microsoft Multilingual (Andrew/Ava) or generic English
  const preferred = voices.find(v => (v.name.includes("Andrew") || v.name.includes("Ava")) && v.name.includes("Multilingual")) 
                 || voices.find(v => v.lang === 'en-US' && v.name.includes('Microsoft'))
                 || voices.find(v => v.lang === 'en-US');
                 
  if (preferred) utterance.voice = preferred;
  
  utterance.rate = 0.85; // Slow for clarity
  utterance.pitch = 1.05; 
  window.speechSynthesis.speak(utterance);
}
// Force load
window.speechSynthesis.onvoiceschanged = () => {};


/* --- APP LOGIC --- */
const screens = {
  setup: document.getElementById('screen-setup'),
  preview: document.getElementById('screen-preview'),
  selection: document.getElementById('screen-selection'),
  countdown: document.getElementById('screen-countdown'),
  speaking: document.getElementById('screen-speaking')
};

function init() {
  const themeSelect = document.getElementById('theme-select');
  THEMES.forEach((theme, index) => {
    const opt = document.createElement('option');
    opt.value = index;
    opt.textContent = theme.name;
    themeSelect.appendChild(opt);
  });
  
  document.getElementById('theme-select').addEventListener('change', (e) => state.selectedThemeIndex = parseInt(e.target.value));
  document.getElementById('btn-start').addEventListener('click', startPreview);
}

// 1. STUDENT MANAGEMENT
function parsePastedNames() {
    const input = document.getElementById('paste-area').value;
    const lines = input.split(/\n/).map(s => s.trim()).filter(s => s.length > 0);
    if(lines.length > 0) {
        STUDENTS = lines.map(name => ({ name: name }));
        renderStudentGrid();
        document.getElementById('paste-area').value = ""; 
    }
}

function addPlaceholderStudents() {
    for(let i=1; i<=20; i++) {
        STUDENTS.push({ name: `Student ${i}` });
    }
    renderStudentGrid();
}

function renderStudentGrid() {
  const grid = document.getElementById('student-grid');
  grid.innerHTML = '';
  document.getElementById('student-count').textContent = `(${STUDENTS.length})`;
  
  if(STUDENTS.length === 0) {
    grid.innerHTML = `<div class="col-span-full text-center text-gray-400 py-8 italic text-sm">Paste names above or click "Add 20" to start.</div>`;
    document.getElementById('btn-start').disabled = true;
    return;
  }

  STUDENTS.forEach((student, index) => {
    const el = document.createElement('div');
    el.className = `student-card ${state.selectedStudents.has(index) ? 'selected' : ''}`;
    el.onclick = () => toggleStudent(index);
    el.innerHTML = `
      <div class="student-avatar">${student.name.substring(0,1)}</div>
      <div class="font-bold text-gray-700 text-xs truncate">${student.name}</div>
    `;
    grid.appendChild(el);
  });
  
  document.getElementById('btn-start').disabled = state.selectedStudents.size === 0;
}

function toggleStudent(index) {
  if (state.selectedStudents.has(index)) state.selectedStudents.delete(index);
  else state.selectedStudents.add(index);
  renderStudentGrid();
}

function selectAllStudents() {
  if(STUDENTS.length === 0) return;
  if(state.selectedStudents.size === STUDENTS.length) {
      state.selectedStudents.clear();
  } else {
      STUDENTS.forEach((_, i) => state.selectedStudents.add(i));
  }
  renderStudentGrid();
}

function switchScreen(screenName) {
  Object.values(screens).forEach(s => s.classList.remove('active'));
  screens[screenName].classList.add('active');
}

// 2. PREVIEW PHASE
function startPreview() {
  initAudio();
  const theme = THEMES[state.selectedThemeIndex];
  const container = document.getElementById('preview-content');
  
  container.innerHTML = `
    <div class="preview-card bg-blue-50 border-blue-200">
      <h3 class="preview-title text-blue-600 mb-1 font-bold text-sm">Part 1: Quick Questions</h3>
      <p class="text-xl font-bold text-gray-800">${theme.part1}</p>
    </div>
    <div class="preview-card bg-green-50 border-green-200">
      <h3 class="preview-title text-green-600 mb-1 font-bold text-sm">Part 2: Long Turn</h3>
      <p class="text-xl font-bold text-gray-800">${theme.part2}</p>
    </div>
    <div class="preview-card bg-purple-50 border-purple-200">
      <h3 class="preview-title text-purple-600 mb-1 font-bold text-sm">Part 3: Discussion</h3>
      <p class="text-xl font-bold text-gray-800">${theme.part3}</p>
    </div>
  `;

  // Shuffle selected students
  let selectedIndices = Array.from(state.selectedStudents);
  for (let i = selectedIndices.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [selectedIndices[i], selectedIndices[j]] = [selectedIndices[j], selectedIndices[i]];
  }
  state.remainingStudents = selectedIndices.map(i => STUDENTS[i]);

  switchScreen('preview');
  
  let timeLeft = 30;
  const timerDisplay = document.getElementById('preview-timer');
  timerDisplay.textContent = timeLeft;
  
  const interval = setInterval(() => {
    timeLeft--;
    timerDisplay.textContent = timeLeft;
    if(timeLeft <= 5) playTick();
    if(timeLeft <= 0) {
      clearInterval(interval);
      startSelection();
    }
  }, 1000);
}

// 3. SELECTION PHASE
function startSelection() {
  if(state.remainingStudents.length === 0) {
    alert("Class Finished! Great job everyone! üéâ");
    location.reload();
    return;
  }
  
  document.getElementById('transition-overlay').style.display = 'none';
  switchScreen('selection');
  
  const display = document.getElementById('roulette-display');
  const targetStudent = state.remainingStudents[0];
  let counter = 0;
  let speed = 50;
  
  const namePool = STUDENTS.map(s => s.name);
  
  const spin = () => {
    display.textContent = namePool[Math.floor(Math.random() * namePool.length)];
    playClick();
    
    counter++;
    if(counter < 25) {
      setTimeout(spin, speed);
      speed += 5;
    } else {
      state.currentStudent = targetStudent;
      display.textContent = state.currentStudent.name;
      display.style.color = '#4fd1c5';
      playWin();
      
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 },
        colors: ['#4fd1c5', '#63b3ed', '#f687b3']
      });

      setTimeout(startCountdown, 2500);
    }
  };
  spin();
}

// 4. COUNTDOWN
function startCountdown() {
  switchScreen('countdown');
  document.getElementById('next-speaker-name').textContent = state.currentStudent.name;
  let timeLeft = 3;
  const display = document.getElementById('countdown-display');
  display.textContent = timeLeft;
  
  const interval = setInterval(() => {
    timeLeft--;
    display.textContent = timeLeft;
    playTick();
    if(timeLeft <= 0) {
      clearInterval(interval);
      startSpeakingSession();
    }
  }, 1000);
}

// 5. SPEAKING SESSION
function startSpeakingSession() {
  switchScreen('speaking');
  document.getElementById('speaker-indicator').textContent = state.currentStudent.name;
  state.isPaused = false;
  runPart(1);
}

function togglePause() {
    state.isPaused = !state.isPaused;
    const btn = document.getElementById('btn-pause');
    btn.textContent = state.isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
    btn.classList.toggle('active');
}

function changePart(offset) {
    const newPart = state.currentPart + offset;
    if (newPart >= 1 && newPart <= 3) {
        // Reset pause state on manual change
        state.isPaused = false;
        document.getElementById('btn-pause').textContent = '‚è∏Ô∏è';
        document.getElementById('btn-pause').classList.remove('active');
        runPart(newPart);
    } else if (newPart > 3) {
        finishStudent();
    }
}

function runPart(partNumber) {
  if(state.timerInterval) clearInterval(state.timerInterval);
  
  state.currentPart = partNumber;
  const theme = THEMES[state.selectedThemeIndex];
  const qText = document.getElementById('question-text');
  const pBar = document.getElementById('progress-bar');
  const partIndicator = document.getElementById('part-indicator');
  
  let question, duration, stems, words;
  let templateKey = 'part1';
  
  if(partNumber === 1) {
    question = theme.part1; duration = TIMING.part1; stems = theme.part1_stems; words = theme.part1_words; templateKey = 'part1';
  } else if(partNumber === 2) {
    question = theme.part2; duration = TIMING.part2; stems = theme.part2_stems; words = theme.part2_words; templateKey = 'part2';
  } else {
    question = theme.part3; duration = TIMING.part3; stems = theme.part3_stems; words = theme.part3_words; templateKey = 'part3';
  }

  // Update State for Timer
  state.duration = duration;
  state.remainingTime = duration;

  partIndicator.textContent = `Part ${partNumber}`;
  qText.textContent = question;
  
  // Reset Bar visually
  pBar.style.width = '100%';
  pBar.style.transition = 'none'; // Controlled by JS loop now
  
  // -- RENDER SCAFFOLDS --
  
  // 1. Structure
  renderTags('structure-container', SCAFFOLDS.templates[templateKey], 'structure');
  
  // 2. Fluency Fillers & Signposts (Combined)
  renderTags('fluency-container', [...SCAFFOLDS.fillers, ...SCAFFOLDS.signposts]);
  
  // 3. Stems
  renderTags('stems-container', stems);
  
  // 4. Vocabulary + Collocations + Idiom
  const vocabList = [...words, ...theme.collocations];
  renderTags('words-container', vocabList);
  // Add Idiom
  const wordsContainer = document.getElementById('words-container');
  const idiomTag = document.createElement('span');
  idiomTag.className = 'tag highlight w-full text-center border-dashed';
  idiomTag.innerHTML = `üåü <b>${theme.idiom}</b>`;
  idiomTag.onclick = () => speakText(theme.idiom);
  wordsContainer.prepend(idiomTag);
  
  // 5. Grammar Bar (Bottom)
  const grammarBar = document.getElementById('grammar-bar');
  grammarBar.innerHTML = '';
  const grammarItems = [...SCAFFOLDS.quantifiers, ...SCAFFOLDS.grammar_patterns];
  grammarItems.forEach(item => {
      const gTag = document.createElement('span');
      gTag.className = 'tag grammar whitespace-nowrap';
      gTag.textContent = item;
      grammarBar.appendChild(gTag);
  });

  // Read Question
  speakText(question);

  const timerDisplay = document.getElementById('question-timer');
  timerDisplay.textContent = state.remainingTime;
  timerDisplay.style.background = 'white';
  timerDisplay.style.color = '#764ba2';

  // Timer Loop (1s)
  state.timerInterval = setInterval(() => {
    if (!state.isPaused) {
        state.remainingTime--;
        timerDisplay.textContent = state.remainingTime;
        
        // Update Bar manually
        const percentage = (state.remainingTime / state.duration) * 100;
        pBar.style.width = `${percentage}%`;
        
        if(state.remainingTime <= 5) {
           timerDisplay.style.background = '#fc8181'; 
           timerDisplay.style.color = 'white';
           playTick();
        }

        if(state.remainingTime <= 0) {
          clearInterval(state.timerInterval);
          if(partNumber < 3) {
            runPart(partNumber + 1);
          } else {
            finishStudent();
          }
        }
    }
  }, 1000);
}

function renderTags(containerId, items, specialClass = '') {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  items.forEach(item => {
    const tag = document.createElement('span');
    tag.className = `tag ${specialClass}`;
    tag.textContent = item;
    // Tap to listen
    tag.onclick = () => speakText(item);
    container.appendChild(tag);
  });
}

function finishStudent() {
  if(state.timerInterval) clearInterval(state.timerInterval);
  state.remainingStudents.shift();
  
  const overlay = document.getElementById('transition-overlay');
  overlay.style.display = 'flex';
  playWin();
  confetti({ particleCount: 150, origin: { y: 0.5 } });

  setTimeout(() => {
      startSelection();
  }, 3000);
}

init();

 </script>
 </body>
</html>
