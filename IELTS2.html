<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Prep Hub: Exam Mode</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f4f8; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Highlight for Gap Fill Inputs */
        .gap-input:focus { outline: 2px solid #4f46e5; border-color: transparent; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // DATA: TEST CONTENT
        // ==========================================
        
        // --- FULL SCRIPT (Urban Planning) ---
        const TEST_1_SCRIPT = [
            { speaker: "Dr. Anderson", text: "Come in, Tom, Jess. Have you had a chance to refine your proposal for the Urban Planning project?" },
            { speaker: "Tom", text: "Yes, Dr. Anderson. We've decided to focus on the impact of green spaces on mental health in high-density cities." },
            { speaker: "Jess", text: "We were originally going to look at transport systems, but the data was too scattered. Green spaces felt more relevant given the recent city council initiatives." },
            { speaker: "Dr. Anderson", text: "An excellent choice. It is a very current topic. Now, regarding your methodology. How do you plan to gather your primary data?" },
            { speaker: "Tom", text: "We thought about online surveys, but honestly, I think they are too impersonal. We want to do face-to-face interviews in the parks themselves." },
            { speaker: "Jess", text: "I agree with Tom. Online surveys often get low response rates, and you can't verify who is actually answering. Interviews are more reliable." },
            { speaker: "Dr. Anderson", text: "Fair point. Just be mindful of the time constraint. Now, moving to the literature review. You mentioned 'Source A' in your draft—the article by Professor Yip." },
            { speaker: "Jess", text: "Yes. I found his arguments quite compelling, although a bit pessimistic about modern architecture." },
            { speaker: "Tom", text: "See, I had a different issue. The statistics he uses are from 2010. In urban development terms, that is ancient history. That was my main criticism." },
            { speaker: "Dr. Anderson", text: "It is dated, yes. But his theory on 'adaptable spaces' is still the standard. You should mention that adaptability is the key to longevity in design." },
            { speaker: "Jess", text: "I'll make a note of that. I did like how he balanced the argument though; he didn't just attack developers, he offered solutions." },
            { speaker: "Tom", text: "True, the tone was very balanced." },
            { speaker: "Dr. Anderson", text: "Alright, let's look at the workload allocation. You need to be clear on who is doing what." },
            { speaker: "Jess", text: "I've already started the literature review, so I'm happy to finish that." },
            { speaker: "Tom", text: "Great, because I prefer the practical side. I'll handle the survey design and the actual data collection." },
            { speaker: "Dr. Anderson", text: "And the final analysis?" },
            { speaker: "Jess", text: "We agreed we need to do that together to ensure we interpret the findings correctly." },
            { speaker: "Tom", text: "Absolutely. We can't split that up." },
            { speaker: "Dr. Anderson", text: "Finally, for the presentation... make sure you define your terms. Last year, students failed because they didn't define 'density' clearly." },
            { speaker: "Jess", text: "Got it. Define density." },
            { speaker: "Dr. Anderson", text: "And remember, the deadline is the 15th of November, not the 30th. Don't get caught out." }
        ];

        // --- QUESTIONS (21-30) ---
        const TEST_1_QUESTIONS = [
            // MCQs (4 Questions)
            { id: 'h1', type: 'header', text: "Questions 21–24: Choose the correct letter." },
            { id: 21, type: 'mc', text: "Why did the students choose 'Green Spaces' as their topic?", options: ["A) Assigned by tutor", "B) Insufficient data elsewhere", "C) Recent initiatives"], answer: "C" },
            { id: 22, type: 'mc', text: "Why did they reject online surveys?", options: ["A) Too expensive", "B) Low response rate", "C) Lack reliability"], answer: "C" },
            { id: 23, type: 'mc', text: "What does Tom criticize about 'Source A'?", options: ["A) Outdated data", "B) Aggressive tone", "C) Biased author"], answer: "A" },
            { id: 24, type: 'mc', text: "Dr. Anderson says 'adaptability' is key for:", options: ["A) Reducing costs", "B) Design longevity", "C) Construction speed"], answer: "B" },
            
            // Matching (Who said what)
            { id: 'h2', type: 'header', text: "Questions 25–27: Who said what? (A: Tom, B: Jess, C: Dr. Anderson)" },
            { id: 25, type: 'matching', text: "The literature review is already underway.", options: ["A", "B", "C"], answer: "B" },
            { id: 26, type: 'matching', text: "Data collection is preferred over writing.", options: ["A", "B", "C"], answer: "A" },
            { id: 27, type: 'matching', text: "Defining key terms like 'density' is crucial.", options: ["A", "B", "C"], answer: "C" },

            // Gap Fill
            { id: 'h3', type: 'header', text: "Questions 28–30: Complete the sentences (Max 2 words)." },
            { id: 28, type: 'gap', text: "The students must work together on the final ______.", answer: "analysis" },
            { id: 29, type: 'gap', text: "Failure to define 'density' caused students to ______ last year.", answer: "fail" },
            { id: 30, type: 'gap', text: "The project deadline has been confirmed as the 15th of ______.", answer: "november" }
        ];

        // Placeholder for tests 2-6
        const GENERIC_SCRIPT = JSON.parse(JSON.stringify(TEST_1_SCRIPT));
        const GENERIC_QUESTIONS = JSON.parse(JSON.stringify(TEST_1_QUESTIONS));

        const ALL_TESTS = [
            { id: 1, title: "Urban Research", icon: "fa-city", color: "indigo", script: TEST_1_SCRIPT, questions: TEST_1_QUESTIONS },
            { id: 2, title: "Oceanography", icon: "fa-water", color: "blue", script: GENERIC_SCRIPT, questions: GENERIC_QUESTIONS },
            { id: 3, title: "History Project", icon: "fa-landmark", color: "amber", script: GENERIC_SCRIPT, questions: GENERIC_QUESTIONS },
            { id: 4, title: "Marketing Case", icon: "fa-chart-line", color: "emerald", script: GENERIC_SCRIPT, questions: GENERIC_QUESTIONS },
            { id: 5, title: "Robot Engineering", icon: "fa-robot", color: "rose", script: GENERIC_SCRIPT, questions: GENERIC_QUESTIONS },
            { id: 6, title: "Biology Lab", icon: "fa-dna", color: "teal", script: GENERIC_SCRIPT, questions: GENERIC_QUESTIONS },
        ];

        const colorStyles = {
            indigo: { card: "bg-indigo-50 text-indigo-600 border-indigo-100 hover:border-indigo-300", icon: "bg-indigo-100", btn: "bg-indigo-600 hover:bg-indigo-700" },
            blue: { card: "bg-blue-50 text-blue-600 border-blue-100 hover:border-blue-300", icon: "bg-blue-100", btn: "bg-blue-600 hover:bg-blue-700" },
            amber: { card: "bg-amber-50 text-amber-600 border-amber-100 hover:border-amber-300", icon: "bg-amber-100", btn: "bg-amber-600 hover:bg-amber-700" },
            emerald: { card: "bg-emerald-50 text-emerald-600 border-emerald-100 hover:border-emerald-300", icon: "bg-emerald-100", btn: "bg-emerald-600 hover:bg-emerald-700" },
            rose: { card: "bg-rose-50 text-rose-600 border-rose-100 hover:border-rose-300", icon: "bg-rose-100", btn: "bg-rose-600 hover:bg-rose-700" },
            teal: { card: "bg-teal-50 text-teal-600 border-teal-100 hover:border-teal-300", icon: "bg-teal-100", btn: "bg-teal-600 hover:bg-teal-700" },
        };

        // ==========================================
        // COMPONENT: IELTS TEST INTERFACE
        // ==========================================
        const IeltsInterface = ({ activeTest, goBack }) => {
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentLine, setCurrentLine] = useState(-1);
            const [userAnswers, setUserAnswers] = useState({});
            const [showResults, setShowResults] = useState(false);
            const [score, setScore] = useState(0);
            
            const synth = window.speechSynthesis;
            const isPlayingRef = useRef(false);
            const [voices, setVoices] = useState([]);
            const transcriptRef = useRef(null);
            const voiceAssignments = useRef({});

            useEffect(() => {
                const load = () => setVoices(synth.getVoices());
                load();
                if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = load;
                return () => synth.cancel();
            }, []);

            const getVoice = (speaker) => {
                if (voiceAssignments.current[speaker]) return voiceAssignments.current[speaker];
                let selected = null;
                // Prioritize Microsoft Voices
                if (speaker === "Jess") {
                    selected = voices.find(v => v.name.includes("Emma") && v.name.includes("Multilingual")) || 
                               voices.find(v => v.name.includes("Zira")) || voices.find(v => v.name.includes("Female"));
                } else if (speaker === "Tom") {
                    selected = voices.find(v => v.name.includes("Brian") && v.name.includes("Multilingual")) || 
                               voices.find(v => v.name.includes("David")) || voices.find(v => v.name.includes("Male"));
                } else if (speaker.includes("Dr")) {
                    selected = voices.find(v => v.name.includes("Andrew") && v.name.includes("Multilingual")) || 
                               voices.find(v => v.name.includes("Mark")); 
                } else if (speaker === "Ava") {
                     selected = voices.find(v => v.name.includes("Ava") && v.name.includes("Multilingual"));
                }
                if (selected) voiceAssignments.current[speaker] = selected;
                return selected || voices[0];
            };

            const scrollToLine = (index) => {
                if (transcriptRef.current) {
                    const element = document.getElementById(`line-${index}`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            };

            const playSequence = (index) => {
                if (!isPlayingRef.current || index >= activeTest.script.length) {
                    setIsPlaying(false);
                    isPlayingRef.current = false;
                    return;
                }
                setCurrentLine(index);
                scrollToLine(index);

                const line = activeTest.script[index];
                const utt = new SpeechSynthesisUtterance(line.text);
                const voice = getVoice(line.speaker);
                if (voice) utt.voice = voice;
                
                utt.rate = 1.0; // CHANGED: Normal Speed
                
                utt.onend = () => {
                    setTimeout(() => {
                        if (isPlayingRef.current) playSequence(index + 1);
                    }, 300);
                };
                synth.speak(utt);
            };

            const toggleAudio = () => {
                if (isPlaying) {
                    synth.cancel();
                    setIsPlaying(false);
                    isPlayingRef.current = false;
                } else {
                    setIsPlaying(true);
                    isPlayingRef.current = true;
                    playSequence(currentLine > -1 ? currentLine : 0);
                }
            };

            const submit = () => {
                let s = 0;
                activeTest.questions.forEach(q => {
                    if (q.type === 'header') return;
                    const userAns = (userAnswers[q.id] || "").trim().toLowerCase();
                    const correctAns = q.answer.toLowerCase();
                    if (userAns === correctAns) s++;
                });
                setScore(s);
                setShowResults(true);
            };

            return (
                <div className="flex flex-col h-screen bg-gray-100 fade-in">
                    {/* Header - Compact */}
                    <div className="h-14 bg-indigo-900 text-white flex items-center justify-between px-4 shrink-0 shadow-md z-20">
                        <button onClick={goBack} className="hover:text-indigo-200 font-bold flex items-center transition-colors text-sm">
                            <i className="fas fa-arrow-left mr-2"></i> Exit
                        </button>
                        <div className="font-bold text-base">{activeTest.title}</div>
                        <div className="w-16 text-right text-xs bg-indigo-800 px-2 py-1 rounded">Part 3</div>
                    </div>

                    {/* Main Content Area */}
                    <div className="flex-1 flex overflow-hidden relative">
                        
                        {/* QUESTIONS PANEL (Tightened Layout) */}
                        <div className="flex-1 overflow-y-auto p-4 bg-white pb-32">
                            <div className="max-w-5xl mx-auto space-y-4">
                                
                                {activeTest.questions.map((q, idx) => {
                                    if (q.type === 'header') return <h3 key={idx} className="text-sm font-bold text-indigo-800 uppercase tracking-wide border-b border-indigo-100 pb-1 mt-4">{q.text}</h3>;
                                    
                                    const isCorrect = showResults && (userAnswers[q.id] || "").toLowerCase() === q.answer.toLowerCase();
                                    const isWrong = showResults && !isCorrect;

                                    return (
                                        <div key={idx} className={`p-3 rounded-lg border transition-all ${isCorrect ? 'border-green-500 bg-green-50' : isWrong ? 'border-red-500 bg-red-50' : 'border-gray-200 hover:border-indigo-300 bg-gray-50'}`}>
                                            
                                            {/* Question Text */}
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="font-semibold text-gray-800 text-sm leading-tight flex-1">
                                                    <span className="text-indigo-600 mr-2 font-mono">{q.id}.</span>
                                                    {q.type === 'gap' ? (
                                                        <span>
                                                            {q.text.split('______')[0]}
                                                            <input 
                                                                type="text" 
                                                                disabled={showResults}
                                                                className="gap-input mx-1 w-32 border-b border-gray-400 bg-transparent text-center font-mono text-indigo-800 focus:outline-none focus:border-indigo-600 text-sm"
                                                                value={userAnswers[q.id] || ''}
                                                                onChange={(e) => setUserAnswers({...userAnswers, [q.id]: e.target.value})}
                                                            />
                                                            {q.text.split('______')[1]}
                                                        </span>
                                                    ) : (
                                                        q.text
                                                    )}
                                                </div>
                                                {isCorrect && <i className="fas fa-check text-green-600 ml-2"></i>}
                                                {isWrong && <i className="fas fa-times text-red-500 ml-2"></i>}
                                            </div>

                                            {/* MCQ Options (Compact) */}
                                            {q.type === 'mc' && (
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-2 ml-6">
                                                    {q.options.map(opt => (
                                                        <label key={opt} className="flex items-center cursor-pointer group p-1.5 rounded hover:bg-white border border-transparent hover:border-gray-200 transition-colors">
                                                            <div className={`w-4 h-4 rounded-full border flex items-center justify-center mr-2 shrink-0 ${userAnswers[q.id] === opt.charAt(0) ? 'border-indigo-600' : 'border-gray-400'}`}>
                                                                {userAnswers[q.id] === opt.charAt(0) && <div className="w-2 h-2 rounded-full bg-indigo-600"></div>}
                                                            </div>
                                                            <input type="radio" name={`q${q.id}`} value={opt.charAt(0)} className="hidden" 
                                                                disabled={showResults}
                                                                checked={userAnswers[q.id] === opt.charAt(0)}
                                                                onChange={() => setUserAnswers({...userAnswers, [q.id]: opt.charAt(0)})}
                                                            />
                                                            <span className="text-xs text-gray-700">{opt}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            )}

                                            {/* Matching Options (Compact) */}
                                            {q.type === 'matching' && (
                                                <div className="flex gap-3 ml-6 mt-1">
                                                    {q.options.map(opt => (
                                                        <button key={opt} 
                                                            disabled={showResults}
                                                            onClick={() => setUserAnswers({...userAnswers, [q.id]: opt})}
                                                            className={`w-8 h-8 rounded-full text-xs font-bold border transition-all ${userAnswers[q.id] === opt ? 'bg-indigo-600 text-white border-indigo-600 shadow' : 'bg-white text-gray-500 border-gray-300 hover:border-indigo-400'}`}>
                                                            {opt}
                                                        </button>
                                                    ))}
                                                </div>
                                            )}

                                            {/* Correct Answer */}
                                            {showResults && !isCorrect && (
                                                <div className="mt-1 ml-6 text-xs text-red-600 font-bold">
                                                    Ans: {q.answer}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* TRANSCRIPT & AUDIO BAR (Optimized Height) */}
                    <div className="h-48 bg-white border-t shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-30 relative flex flex-col">
                        
                        {/* Auto-Scrolling Transcript */}
                        <div className="flex-1 overflow-y-auto p-4 bg-gray-50 border-b" ref={transcriptRef}>
                            <div className="max-w-4xl mx-auto space-y-2">
                                <h4 className="text-[10px] font-bold text-gray-400 uppercase tracking-widest sticky top-0 bg-gray-50 py-1">Live Transcript</h4>
                                {activeTest.script.map((line, idx) => (
                                    <div key={idx} id={`line-${idx}`} className={`text-sm p-2 rounded transition-all duration-300 ${currentLine === idx ? 'bg-yellow-100 border-l-4 border-yellow-500 shadow-sm' : 'text-gray-400 opacity-70'}`}>
                                        <span className={`font-bold mr-2 text-[10px] uppercase px-1.5 py-0.5 rounded ${line.speaker.includes('Dr') ? 'bg-red-100 text-red-700' : line.speaker === 'Jess' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{line.speaker}</span>
                                        {line.text}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Player Controls */}
                        <div className="h-14 bg-white px-6 flex items-center justify-between shrink-0">
                            <div className="flex items-center gap-4">
                                <button onClick={toggleAudio} className={`w-10 h-10 rounded-full text-white flex items-center justify-center shadow hover:scale-105 transition-all ${isPlaying ? 'bg-rose-500' : 'bg-indigo-600'}`}>
                                    <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play pl-0.5'} text-sm`}></i>
                                </button>
                                <div>
                                    <div className="text-xs font-bold text-gray-800">Audio Track 3.4</div>
                                    <div className="text-[10px] text-gray-500 font-mono">{isPlaying ? 'Playing (1.0x)...' : 'Paused'}</div>
                                </div>
                            </div>

                            {!showResults ? (
                                <button onClick={submit} className="bg-green-600 hover:bg-green-700 text-white px-6 py-1.5 rounded font-bold text-sm shadow transform transition hover:-translate-y-0.5">
                                    Submit
                                </button>
                            ) : (
                                <div className="text-sm font-bold text-gray-800 bg-gray-100 px-4 py-1.5 rounded border border-gray-300">
                                    Score: <span className={score >= 5 ? 'text-green-600' : 'text-red-600'}>{score} / 10</span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // MAIN APP CONTROLLER
        // ==========================================
        const App = () => {
            const [view, setView] = useState('landing');
            const [activeTestId, setActiveTestId] = useState(null);
            const [completedTests, setCompletedTests] = useState({}); 

            // Landing Page
            if (view === 'landing') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 to-indigo-900 flex items-center justify-center p-4 fade-in">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 md:p-12 max-w-lg w-full text-center relative overflow-hidden">
                            <div className="relative z-10">
                                <div className="inline-block p-4 rounded-full bg-indigo-50 text-indigo-600 text-4xl mb-6 shadow-sm">
                                    <i className="fas fa-headphones-alt"></i>
                                </div>
                                <h1 className="text-3xl md:text-4xl font-extrabold text-gray-800 mb-4 tracking-tight">IELTS Prep Hub</h1>
                                <p className="text-base text-gray-500 mb-8 leading-relaxed">
                                    Practice <strong>Part 3 Discussions</strong> with AI voices.<br/>
                                    Real-time transcripts • Exam-style questions
                                </p>
                                <button onClick={() => setView('menu')} className="bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-bold py-3 px-8 rounded-xl shadow-lg transform transition hover:scale-105 hover:shadow-xl active:scale-95">
                                    Enter Exam Mode <i className="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Dashboard
            if (view === 'menu') {
                return (
                    <div className="min-h-screen bg-gray-50 p-4 md:p-8 fade-in">
                        <div className="max-w-6xl mx-auto">
                            <header className="mb-8 flex flex-col md:flex-row justify-between items-end">
                                <div>
                                    <button onClick={() => setView('landing')} className="text-gray-400 hover:text-indigo-600 text-xs font-bold mb-2 flex items-center transition-colors">
                                        <i className="fas fa-arrow-left mr-2"></i> Back to Home
                                    </button>
                                    <h1 className="text-3xl font-extrabold text-gray-900">Exam Library</h1>
                                </div>
                                <div className="bg-white px-6 py-2 rounded-xl shadow-sm border border-gray-200 mt-4 md:mt-0">
                                    <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Progress</div>
                                    <div className="text-xl font-bold text-indigo-600">{Object.keys(completedTests).length} <span className="text-gray-300 text-sm">/ 6 Tests</span></div>
                                </div>
                            </header>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {ALL_TESTS.map((test) => {
                                    const style = colorStyles[test.color] || colorStyles.indigo;
                                    return (
                                        <div key={test.id} onClick={() => { setActiveTestId(test.id); setView('test'); }}
                                            className={`group relative flex flex-col p-6 rounded-2xl border-2 border-transparent transition-all duration-300 cursor-pointer hover:-translate-y-1 hover:shadow-lg bg-white ${style.card}`}>
                                            <div className="flex justify-between items-start w-full mb-4">
                                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-sm ${style.icon}`}>
                                                    <i className={`fas ${test.icon}`}></i>
                                                </div>
                                                {completedTests[test.id] && <i className="fas fa-check-circle text-green-500 text-xl"></i>}
                                            </div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-1 group-hover:text-indigo-800">{test.title}</h3>
                                            <p className="text-xs text-gray-500 font-medium mb-6">10 Questions • 5 Mins</p>
                                            <div className={`mt-auto py-2 px-4 rounded-lg text-center text-sm font-bold text-white transition-colors ${style.btn}`}>
                                                Start Test
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            // Test
            if (view === 'test' && activeTestId) {
                const activeTest = ALL_TESTS.find(t => t.id === activeTestId);
                return <IeltsInterface activeTest={activeTest} goBack={() => setView('menu')} />;
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
