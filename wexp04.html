<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bridging Worlds: Animal Crossings and Biodiversity</title>

  <!-- Development: Tailwind CDN (replace with built CSS in production) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; margin:0; padding-top:72px; background:#f7fafc; color:#0f172a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .page { display:none; max-width:980px; margin: 1.5rem auto; padding: 1.5rem; background: white; border-radius:12px; box-shadow: 0 10px 25px rgba(2,6,23,0.08); }
    .page.active { display:block; animation: fadeIn 240ms ease-out both; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(12px); } to { opacity:1; transform: translateY(0); } }

    .action-button { display:inline-block; padding: 0.6rem 1.1rem; border-radius:999px; cursor:pointer; font-weight:600; box-shadow: 0 8px 18px rgba(2,6,23,0.06); border:none; }
    .action-button.green { background:#059669; color:#fff; }
    .action-button.blue { background:#2563eb; color:#fff; }
    .action-button.gray { background:#e6e7eb; color:#111827; }

    #nav-header { position:fixed; top:8px; left:50%; transform:translateX(-50%); z-index:60; width:fit-content; }
    #nav-inner { display:flex; gap:8px; align-items:center; padding:8px; background: rgba(255,255,255,0.95); border-radius:9999px; box-shadow: 0 8px 20px rgba(2,6,23,0.08); }
    .nav-button { width:44px; height:44px; border-radius:9999px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:none; }
    .nav-button:disabled { opacity:0.5; pointer-events:none; }

    .quiz-option { display:block; width:100%; text-align:left; padding:10px 12px; margin:6px 0; border-radius:10px; background:#f3f4f6; border:1px solid rgba(15,23,42,0.05); cursor:pointer; font-weight:500; }
    .quiz-option.correct { background:#dcfce7; border-color:#16a34a; color:#065f46; }
    .quiz-option.incorrect { background:#fee2e2; border-color:#ef4444; color:#7f1d1d; }
    .tfng-button { padding:8px 10px; margin-right:8px; border-radius:8px; background:#f3f4f6; cursor:pointer; border:none; }

    .feedback-toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); padding:10px 18px; border-radius:999px; color:white; font-weight:700; z-index:80; box-shadow: 0 10px 30px rgba(2,6,23,0.12); }
    .feedback-toast.good { background:linear-gradient(90deg,#10b981,#059669); }
    .feedback-toast.bad { background:linear-gradient(90deg,#ef4444,#f97316); }

    .gap { display:inline-block; min-width:160px; padding:8px; border:2px dashed #9ca3af; border-radius:8px; background:#f8fafc; }
    .word-bank { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .word { background:white; padding:8px 12px; border-radius:8px; border:1px solid rgba(2,6,23,0.05); cursor:grab; }

    #background-canvas { position:fixed; left:0; top:0; right:0; bottom:0; z-index:-10; pointer-events:none; }

    pre.dialogue { white-space:pre-wrap; font-family:inherit; font-size:1rem; line-height:1.6; background:#f8fafc; padding:12px; border-radius:8px; }

    .muted { color:#6b7280; font-weight:500; }
  </style>
</head>
<body>
  <canvas id="background-canvas" width="1600" height="900"></canvas>

  <div id="nav-header" aria-hidden="false">
    <div id="nav-inner" role="navigation" aria-label="Lesson navigation">
      <button id="nav-back" class="nav-button" title="Back" aria-label="Back" aria-disabled="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0f172a"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path></svg>
      </button>
      <div style="font-weight:700; color:#059669; padding:0 8px;">Score: <span id="score-display" aria-live="polite">0</span></div>
      <button id="nav-home" class="nav-button" title="Home" aria-label="Home">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0f172a"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2"></path></svg>
      </button>
      <button id="nav-tts" class="nav-button" title="Toggle TTS" aria-pressed="true" aria-label="Toggle TTS">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0f172a"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 5v14l8-7-8-7z"></path></svg>
      </button>
      <button id="nav-next" class="nav-button" title="Next" aria-label="Next">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0f172a"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path></svg>
      </button>
    </div>
  </div>

  <main>
    <!-- Title / start screen -->
    <section id="page-title-screen" class="page active" aria-labelledby="main-title">
      <h1 id="main-title" class="text-4xl font-bold text-center">Bridging Worlds</h1>
      <p class="muted text-center mt-2">Animal Crossings and Biodiversity <span aria-hidden>üåâüêæ</span></p>

      <div style="max-width:600px;margin:18px auto;">
        <svg viewBox="0 0 400 160" width="100%" height="160" aria-hidden="true">
          <rect x="0" y="80" width="400" height="80" fill="#10b981"/>
          <rect x="40" y="40" width="120" height="40" rx="8" fill="#8b5cf6"/>
          <rect x="240" y="20" width="120" height="60" rx="8" fill="#f97316"/>
          <text x="200" y="68" text-anchor="middle" fill="#fff" font-size="14">Wildlife Bridge</text>
        </svg>
      </div>

      <div style="text-align:center; margin-top:12px;">
        <button id="start-lesson" class="action-button green" aria-label="Start Lesson">START LESSON</button>
      </div>
    </section>

    <!-- dynamic pages container -->
    <div id="dynamic-pages-container" aria-live="polite"></div>
  </main>

  <!-- Keyword Modal -->
  <div id="keywordModal" class="hidden" role="dialog" aria-modal="true" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:80;">
    <div style="background:white; max-width:760px; width:94%; border-radius:12px; padding:18px; box-shadow:0 12px 40px rgba(2,6,23,0.12);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 id="modalTitle" style="font-weight:700;"></h3>
        <button id="modalClose" aria-label="Close modal" style="border:none;background:none;font-size:22px;cursor:pointer;">&times;</button>
      </div>
      <div id="modalContent" style="margin-top:8px;color:#374151;"></div>
    </div>
  </div>

  <!-- AudioWorklet inline processor -->
  <script id="sequence-processor" type="worklet-script">
    class SequenceProcessor extends AudioWorkletProcessor {
      constructor() {
        super();
        this._sequence = [];
        this._index = 0;
        this._samplesUntil = 0;
        this._playing = false;
        this.port.onmessage = (e) => {
          if (e.data && e.data.type === 'play') {
            this._sequence = e.data.sequence || [];
            this._index = 0;
            this._samplesUntil = 0;
            this._playing = true;
          }
        };
      }
      process(inputs, outputs, parameters) {
        if (!this._playing) return true;
        for (let i=0;i<128;i++){
          if (this._samplesUntil <= 0 && this._index < this._sequence.length) {
            const n = this._sequence[this._index++];
            this.port.postMessage({ type:'noteOn', freq:n.freq, dur:n.dur||0.2, vol:n.vol||0.3, type:n.type||'sine' });
            this._samplesUntil = (n.gap || n.dur || 0.2) * sampleRate;
          }
          this._samplesUntil--;
        }
        if (this._index >= this._sequence.length && this._samplesUntil < -sampleRate) this._playing = false;
        return true;
      }
    }
    registerProcessor('sequence-processor', SequenceProcessor);
  </script>

  <script>
    (function(){
      // ---------- lesson content ----------
      const lessonData = {
        title: "Bridging Worlds",
        subtitle: "Animal Crossings and Biodiversity",
        startPageId: 'title-screen',
        homePageId: 'main-menu',
        vocabulary: [
          { word:'Habitat', def:'The natural home or environment of an animal or plant.', sentence:'The forest provides a perfect habitat.'},
          { word:'Fragmentation', def:'Being broken into smaller parts.', sentence:'Roads cause habitat fragmentation.'},
          { word:'Corridor', def:'A strip of land connecting habitats.', sentence:'A wildlife corridor allows safe movement.'}
        ],
        pages: [
          // main menu
          { id:'main-menu', type:'html-content', content:{ title:'Main Menu', html: `
            <div class="grid gap-4 sm:grid-cols-2">
              <button class="action-button green" data-target="tps-start">Think-Pair-Share</button>
              <button class="action-button gray" data-target="learning-goals">Learning Goals</button>
              <button class="action-button green" data-target="warm-up">Warm-Up & Vocab</button>
              <button class="action-button blue" data-target="reading-main">Reading</button>
              <button class="action-button gray" data-target="conversation-practice">Conversation Practice</button>
              <button class="action-button gray" data-target="animal-crossing-incident">Animal Crossing: Road Incidents</button>
              <button class="action-button green" data-target="final-project-hub">Final Project</button>
            </div>
          ` }},
          // Think Pair Share
          { id:'tps-start', type:'simple', content:{ title:'Think-Pair-Share', text:'Think, Pair, Share activities to start.' } },
          { id:'tps-think', type:'timer', content:{ title:'Think', text:'60 seconds...', duration:60, timerId:'tps-think-timer' } },
          { id:'tps-pair', type:'timer', content:{ title:'Pair', text:'90 seconds...', duration:90, timerId:'tps-pair-timer' } },
          { id:'tps-share', type:'timer', content:{ title:'Share', text:'120 seconds...', duration:120, timerId:'tps-share-timer' } },

          { id:'learning-goals', type:'html-content', content:{ title:'Learning Goals', html:`<p>Define fragmentation, describe crossings, design a crossing.</p>` } },
          { id:'warm-up', type:'html-content', content:{ title:'Warm-Up', html:`<p>Background questions to prompt discussion.</p>` } },
          { id:'reading-main', type:'html-content', content:{ title:'Reading', html:`<p>Tiered texts about crossings and biodiversity.</p>` } },

          // NEW: Animal Crossing ‚Äî Road Incidents page (requested)
          { id:'animal-crossing-incident', type:'html-content', content:{ title:'Animal Crossing: Road Incidents', html: `
            <h3>Real-world problem: animals hit by cars</h3>
            <p>When roads cut through wildlife habitat, animals sometimes try to cross and are struck by vehicles. This causes animal mortality and can also put drivers at risk. Understanding the causes helps us design solutions.</p>

            <div style="display:flex; gap:12px; align-items:center; margin-top:12px;">
              <svg width="160" height="100" viewBox="0 0 160 100" aria-hidden="true">
                <rect x="0" y="60" width="160" height="40" fill="#111827" rx="6"></rect>
                <rect x="14" y="30" width="42" height="22" rx="4" fill="#ef4444"></rect>
                <rect x="86" y="10" width="42" height="22" rx="4" fill="#2563eb"></rect>
                <text x="80" y="55" fill="#fff" font-size="10" text-anchor="middle">Road corridor</text>
              </svg>

              <div>
                <p style="margin:0;"><strong>Causes:</strong></p>
                <ul style="margin:6px 0 0 18px;">
                  <li>Habitat fragmentation and loss</li>
                  <li>No safe crossing points</li>
                  <li>High vehicle speeds and poor visibility</li>
                </ul>
              </div>
            </div>

            <h4 style="margin-top:12px;">Short dialogue</h4>
            <pre class="dialogue">Driver: I almost hit a deer at night on the highway last week.
Ranger: Those collisions are sadly common. Where did it happen?
Driver: Near the overpass area ‚Äî no lights and the animals cross there often.
Ranger: Building a wildlife overpass or lowering speed can help.</pre>
            <div style="margin-top:10px">
              <button class="action-button blue" id="play-car-sound">Play car sound (demo)</button>
              <button class="action-button gray" id="explain-mitigations">Explain mitigations (TTS)</button>
            </div>

            <h4 style="margin-top:14px;">Reflect & Quiz</h4>
            <p>Reflect: Why do animals cross roads? What human choices make collisions more likely?</p>

            <div style="margin-top:8px;">
              <div style="font-weight:700">Quick MCQ</div>
              <button class="quiz-option" data-correct="true">A: Reduce vehicle speed and provide crossings</button>
              <button class="quiz-option">B: Increase lighting and higher speeds</button>
              <button class="quiz-option">C: Remove all vegetation from roadsides</button>
            </div>

            <div style="margin-top:12px;">
              <div style="font-weight:700">Gap Fill</div>
              <div style="margin-top:8px">When animals move between fragments to find mates and food they are at risk of ________.</div>
              <div class="gap" data-answer="collision" id="gap-animal-0">[ collision ]</div>
            </div>
          ` } },

          // conversation practice
          { id:'conversation-practice', type:'dialogue', content:{ title:'Conversation Practice', dialogue:
`Leo: I never really thought about roads and animals.
Mia: It's a bigger issue than most people realize.
Leo: Could we propose an overpass project?
Mia: Yes ‚Äî research, design and community support are needed.` } },

          // final project hub
          { id:'final-project-hub', type:'html-content', content:{ title:'Final Project Hub', html: `
            <h2>Design a Wildlife Crossing</h2>
            <p>Pick a local road. Research species and propose a crossing.</p>
            <div style="margin-top:12px"><button class="action-button gray" data-phase="1">Phase 1</button> <button class="action-button gray" data-phase="2">Phase 2</button></div>
          ` }},

          { id:'writing-task', type:'writing-task', content:{ title:'Writing Activity', prompt:'Write a formal letter proposing a wildlife crossing.', starters:['I am writing to express...'], wordBank:['biodiversity','corridor','conservation'] }},

          { id:'certificate', type:'certificate', content:{ title:'Module Complete!', text:'You have completed Bridging Worlds. Great job!' } }
        ]
      };

      // ---------- state & audio/TTS ----------
      let score = 0;
      let currentPage = 'page-title-screen';
      const pageHistory = [];
      let pageSequence = [];
      let audioContext = null;
      let sequenceNode = null;
      let speechService = null;
      let timerInterval = null;

      const correctSounds = [ { freq:880, dur:0.12 }, { freq:660, dur:0.08 } ];
      const incorrectSounds = [ { freq:240, dur:0.35, type:'square' } ];
      const correctPhrases = ['Great!', 'Correct!', 'Well done!'];
      const incorrectPhrases = ['Try again!', 'Not quite, keep going.'];

      class SpeechService {
        constructor() { this.synth = window.speechSynthesis; this.voices = []; this.ready=false; this.enabled=true; this.rate=0.95; }
        async init() {
          const voices = new Promise(res=>{
            const v = this.synth.getVoices();
            if (v && v.length) return res(v);
            this.synth.onvoiceschanged = ()=> res(this.synth.getVoices());
          });
          this.voices = await voices;
          this.ready = true;
        }
        speak(text) {
          if (!this.enabled || !this.ready || !text) return;
          try {
            this.synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.rate = this.rate;
            if (this.voices && this.voices.length) u.voice = this.voices.find(v=>v.lang.startsWith('en')) || this.voices[0];
            this.synth.speak(u);
          } catch(e){ console.warn('TTS error', e); }
        }
        toggle() { this.enabled = !this.enabled; if (!this.enabled) this.synth.cancel(); return this.enabled; }
      }

      async function initAudio() {
        if (audioContext) return;
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const processorScript = document.getElementById('sequence-processor').textContent;
          const blob = new Blob([processorScript], { type: 'application/javascript' });
          const url = URL.createObjectURL(blob);
          try {
            await audioContext.audioWorklet.addModule(url);
            sequenceNode = new AudioWorkletNode(audioContext, 'sequence-processor');
            sequenceNode.port.onmessage = e => {
              if (e.data && e.data.type === 'noteOn') playOscillator(e.data.freq, e.data.dur, e.data.vol, e.data.type);
            };
            sequenceNode.connect(audioContext.destination);
          } catch(err) {
            console.warn('AudioWorklet not available', err);
            sequenceNode = null;
          }
        } catch(e) { console.error('Audio init failed', e); }
      }

      function playOscillator(freq=440, dur=0.2, vol=0.2, type='sine') {
        try {
          if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
          if (audioContext.state === 'suspended') audioContext.resume();
          const osc = audioContext.createOscillator();
          const g = audioContext.createGain();
          osc.type = type;
          osc.frequency.value = freq;
          g.gain.value = vol;
          osc.connect(g); g.connect(audioContext.destination);
          osc.start();
          setTimeout(()=>{ try { osc.stop(); osc.disconnect(); g.disconnect(); } catch(e){} }, dur*1000);
        } catch(e){}
      }

      function playSequence(seq) {
        if (sequenceNode && sequenceNode.port) {
          sequenceNode.port.postMessage({ type:'play', sequence: seq.map(s=>({freq:s.freq,dur:s.dur||0.2,vol:s.vol||0.25,type:s.type||'sine',gap:s.gap}))});
        } else {
          seq.forEach(s => playOscillator(s.freq, s.dur||0.2, s.vol||0.25, s.type||'sine'));
        }
      }

      function playCarSoundDemo() {
        // simple car pass: low rumble then horn-like beep
        playSequence([
          { freq:120, dur:0.35, vol:0.12, type:'sine' },
          { freq:180, dur:0.25, vol:0.14, type:'sine', gap:0.05 },
          { freq:800, dur:0.12, vol:0.18, type:'square', gap:0.1 } // horn-like
        ]);
      }

      // ---------- UI build & handlers ----------
      function buildPages() {
        const container = document.getElementById('dynamic-pages-container');
        container.innerHTML = '';
        lessonData.pages.forEach(p => {
          const el = document.createElement('section');
          el.id = `page-${p.id}`;
          el.className = 'page';
          let inner = '';
          if (p.type === 'simple') {
            inner = `<h2 style="font-weight:700">${escapeHtml(p.content.title)}</h2><p style="margin-top:8px">${escapeHtml(p.content.text)}</p><div style="margin-top:12px"><button class="action-button green" data-next>Next</button></div>`;
          } else if (p.type === 'timer') {
            inner = `<h2 style="font-weight:700">${escapeHtml(p.content.title)}</h2><p style="margin-top:8px">${escapeHtml(p.content.text)}</p><div id="${p.content.timerId}" style="font-family:monospace;font-size:20px;margin-top:8px">00:00</div><div style="margin-top:12px"><button class="action-button green" data-next>Next</button></div>`;
          } else if (p.type === 'html-content') {
            inner = `<h2 style="font-weight:700">${escapeHtml(p.content.title)}</h2><div style="margin-top:12px">${p.content.html}</div><div style="margin-top:12px"><button class="action-button green" data-next>Next</button></div>`;
          } else if (p.type === 'dialogue') {
            inner = `<h2 style="font-weight:700">${escapeHtml(p.content.title)}</h2><pre class="dialogue">${escapeHtml(p.content.dialogue)}</pre><div style="margin-top:12px"><button class="action-button blue" data-play-dialogue>Play</button> <button class="action-button green" data-next>Next</button></div>`;
          } else if (p.type === 'quiz-mcq') {
            inner = `<h2 style="font-weight:700">${escapeHtml(p.content.title)}</h2>`;
            p.content.questions.forEach((q, qi) => {
              inner += `<div class="question-group" style="margin-top:12px; padding:10px; border-radius:10px; border:1px solid rgba(2,6,23,0.04);"><div style="font-weight:700">${qi+1}. ${escapeHtml(q.q)}</div>`;
              q.options.forEach((opt, oi) => {
                const correctAttr = (oi === q.correctIndex) ? 'data-correct="true"' : '';
                inner += `<button class="quiz-option" ${correctAttr} data-answer-index="${oi}">${escapeHtml(opt)}</button>`;
              });
              inner += `</div>`;
            });
            inner += `<div style="margin-top:12px"><button class="action-button green" data-next>Next</button></div>`;
          } else if (p.type === 'quiz-tfng') {
            inner = `<h2 style="font-weight:700">${escapeHtml(p.content.title)}</h2>`;
            p.content.questions.forEach((q, qi)=>{
              inner += `<div class="question-group" style="margin-top:12px; padding:10px; border-radius:10px; border:1px solid rgba(2,6,23,0.04);"><div style="font-weight:700">${qi+1}. ${escapeHtml(q.q)}</div>`;
              ['TRUE','FALSE','NOT GIVEN'].forEach(opt=>{
                inner += `<button class="tfng-button" data-chosen="${opt}" data-correct="${q.a}">${opt}</button>`;
              });
              inner += `</div>`;
            });
            inner += `<div style="margin-top:12px"><button class="action-button green" data-next>Next</button></div>`;
          } else if (p.type === 'quiz-gap-fill') {
            inner = `<h2 style="font-weight:700">${escapeHtml(p.content.title)}</h2><div style="margin-top:12px">`;
            p.content.sentences.forEach((s, si)=>{
              inner += `<div style="margin-top:8px">${escapeHtml(s.text.replace('______',''))} <span class="gap" data-answer="${escapeHtml(s.answer)}" id="gap-${p.id}-${si}">[ ${escapeHtml(s.answer)} ]</span></div>`;
            });
            inner += `<div class="word-bank" style="margin-top:10px">${p.content.sentences.map(s=>`<div class="word" draggable="true" data-word="${escapeHtml(s.answer)}">${escapeHtml(s.answer)}</div>`).join('')}</div>`;
            inner += `</div><div style="margin-top:12px"><button class="action-button green" data-next>Next</button></div>`;
          } else if (p.type === 'writing-task') {
            inner = `<h2 style="font-weight:700">${escapeHtml(p.content.title)}</h2><p style="margin-top:8px">${escapeHtml(p.content.prompt)}</p><textarea id="writing-response" rows="8" style="width:100%;margin-top:8px;padding:10px;border-radius:8px;border:1px solid rgba(2,6,23,0.06)"></textarea><div style="margin-top:8px"><button class="action-button green" id="submit-writing">Submit</button> <button class="action-button gray" data-next>Next</button></div>`;
          } else if (p.type === 'certificate') {
            inner = `<h2 style="font-weight:700">${escapeHtml(p.content.title)}</h2><p style="margin-top:8px">${escapeHtml(p.content.text)}</p><div style="margin-top:12px"><button class="action-button green" id="celebrate">Celebrate</button></div>`;
          } else {
            inner = `<h2>${escapeHtml(p.id)}</h2>`;
          }
          el.innerHTML = inner;
          container.appendChild(el);
        });

        pageSequence = lessonData.pages.map(p => p.id);
        attachGeneratedHandlers();
      }

      function attachGeneratedHandlers() {
        const container = document.getElementById('dynamic-pages-container');

        container.addEventListener('click', (ev) => {
          // play dialogue
          const play = ev.target.closest('[data-play-dialogue]');
          if (play) {
            const page = play.closest('.page');
            const pre = page.querySelector('pre.dialogue');
            if (pre && speechService) speakDialogue(pre.textContent);
          }
          // next
          const next = ev.target.closest('[data-next]');
          if (next) goNext();
          // menu buttons
          const targetBtn = ev.target.closest('[data-target]');
          if (targetBtn) {
            navigateTo(targetBtn.getAttribute('data-target'));
          }
          // quiz mcq
          const mcq = ev.target.closest('.quiz-option');
          if (mcq) {
            const isCorrect = mcq.getAttribute('data-correct') === 'true';
            const group = mcq.closest('.question-group');
            group.querySelectorAll('.quiz-option').forEach(b => b.disabled = true);
            mcq.classList.add(isCorrect ? 'correct' : 'incorrect');
            if (isCorrect) { playSequence([correctSounds[Math.floor(Math.random()*correctSounds.length)]]); showToast(true); updateScore(10); }
            else { playSequence([incorrectSounds[Math.floor(Math.random()*incorrectSounds.length)]]); showToast(false); const correctBtn = group.querySelector("[data-correct='true']"); if (correctBtn) correctBtn.classList.add('correct'); }
          }
          // TF/NG
          const tf = ev.target.closest('.tfng-button');
          if (tf) {
            const chosen = tf.getAttribute('data-chosen');
            const correct = tf.getAttribute('data-correct');
            const parent = tf.closest('.question-group');
            if (!parent) return;
            parent.querySelectorAll('button').forEach(b=>b.disabled=true);
            const ok = (chosen === correct);
            if (ok) { playSequence([correctSounds[Math.floor(Math.random()*correctSounds.length)]]); showToast(true); updateScore(10); parent.style.borderColor='#16a34a'; }
            else { playSequence([incorrectSounds[Math.floor(Math.random()*incorrectSounds.length)]]); showToast(false); parent.style.borderColor='#ef4444'; }
          }
          // word drag fallback click doesn't apply here
          // final project phase buttons
          const phaseBtn = ev.target.closest('[data-phase]');
          if (phaseBtn) {
            showPhase(Number(phaseBtn.getAttribute('data-phase')));
          }
        });

        // word drag
        container.querySelectorAll('.word').forEach(w=>{
          w.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', w.dataset.word));
        });
        container.querySelectorAll('.gap').forEach(g=>{
          g.addEventListener('dragover', e => e.preventDefault());
          g.addEventListener('drop', e => {
            e.preventDefault();
            const w = e.dataTransfer.getData('text/plain');
            const dragged = document.querySelector(`.word[data-word="${w}"]`);
            if (!dragged) return;
            g.innerHTML = '';
            g.appendChild(dragged);
            if (g.dataset.answer && g.dataset.answer.toLowerCase() === w.toLowerCase()) {
              g.classList.add('correct'); playSequence([correctSounds[0]]); showToast(true); updateScore(8);
            } else { g.classList.add('incorrect'); playSequence([incorrectSounds[0]]); showToast(false); }
          });
        });

        // special page controls:
        const playCarBtn = document.getElementById('play-car-sound');
        if (playCarBtn) playCarBtn.addEventListener('click', () => playCarSoundDemo());
        const explainBtn = document.getElementById('explain-mitigations');
        if (explainBtn) explainBtn.addEventListener('click', () => {
          if (speechService) speechService.speak('Mitigations include building wildlife overpasses, lowering vehicle speeds, installing fences and signs, and restoring corridors.');
        });

        const submitWriting = document.getElementById('submit-writing');
        if (submitWriting) submitWriting.addEventListener('click', (e) => {
          const p = e.target.closest('.page');
          const ta = p.querySelector('#writing-response');
          if (!ta || !ta.value.trim()) { alert('Please write something before submitting.'); return; }
          playSequence([correctSounds[0]]); showToast(true); updateScore(20);
        });

        const celebrate = document.getElementById('celebrate');
        if (celebrate) celebrate.addEventListener('click', () => runCompletionAnimation());
      }

      // navigation
      function navigateTo(pageId) {
        const normalized = pageId.replace(/^page-/,'');
        const targetEl = document.getElementById(`page-${normalized}`);
        if (!targetEl) { console.warn('No page',pageId); return; }
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        targetEl.classList.add('active');
        currentPage = normalized;
        pageHistory.push(normalized);
        const pageDef = lessonData.pages.find(p=>p.id===normalized);
        if (pageDef && pageDef.type === 'timer') {
          const el = document.getElementById(pageDef.content.timerId);
          if (el) startTimer(pageDef.content.duration, el, goNext);
        }
        if (speechService && speechService.ready) {
          speechService.speak(stripHtml((pageDef && pageDef.content && (pageDef.content.title || pageDef.content.text)) || ''));
        }
        updateNavState();
      }

      function goNext() {
        const idx = pageSequence.indexOf(currentPage);
        if (idx === -1 && pageSequence.length>0) { navigateTo(pageSequence[0]); return; }
        if (idx >= 0 && idx < pageSequence.length - 1) navigateTo(pageSequence[idx+1]);
      }
      function goBack() {
        if (pageHistory.length <= 1) return;
        pageHistory.pop(); const prev = pageHistory.pop();
        if (prev) navigateTo(prev);
      }
      function updateNavState() {
        const nav = document.getElementById('nav-header');
        nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
        document.getElementById('nav-back').disabled = pageHistory.length <= 1;
      }

      // timers
      function startTimer(duration, displayEl, onComplete) {
        let t = duration;
        displayEl.textContent = formatTime(t);
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(()=>{
          t--; displayEl.textContent = formatTime(t);
          if (t < 0) { clearInterval(timerInterval); timerInterval = null; if (onComplete) onComplete(); }
        },1000);
      }
      function formatTime(s) { if (s<0) s=0; return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }

      // toast
      function showToast(correct) {
        const t = document.createElement('div');
        t.className = 'feedback-toast ' + (correct ? 'good' : 'bad');
        t.textContent = correct ? correctPhrases[Math.floor(Math.random()*correctPhrases.length)] : incorrectPhrases[Math.floor(Math.random()*incorrectPhrases.length)];
        document.body.appendChild(t);
        setTimeout(()=> t.remove(), 2800);
        if (speechService && speechService.ready) speechService.speak(t.textContent);
      }
      function updateScore(points) { score += points; document.getElementById('score-display').textContent = score; }

      // dialogue TTS
      async function speakDialogue(text) {
        if (!speechService) return;
        const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
        for (const line of lines) {
          const parts = line.split(':');
          const content = parts.length>1 ? parts.slice(1).join(':').trim() : line;
          speechService.speak(content);
          await new Promise(r=>setTimeout(r, Math.min(1600, content.length*25)));
        }
      }

      function showPhase(n) {
        const content = document.getElementById('phaseContent');
        if (!content) return;
        const phases = {
          1: { title:'Phase 1: Identify', items:['Map green spaces','Record collisions','Talk to locals'] },
          2: { title:'Phase 2: Research', items:['Species lists','Movement patterns','Site constraints'] },
          3: { title:'Phase 3: Design', items:['Crossing type','Planting and slope','Maintenance'] },
          4: { title:'Phase 4: Monitor', items:['Post-install monitoring','Community feedback','Cost analysis'] }
        };
        const p = phases[n];
        content.innerHTML = `<h3 style="font-weight:700">${escapeHtml(p.title)}</h3><ul style="margin-top:8px">${p.items.map(it=>`<li>${escapeHtml(it)}</li>`).join('')}</ul>`;
      }

      // background subtle particles
      (function animateCanvas(){
        const canvas = document.getElementById('background-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
        resize(); addEventListener('resize', resize);
        const parts = [];
        function frame(){
          ctx.clearRect(0,0,canvas.width,canvas.height);
          if (Math.random() > 0.986 && parts.length < 140) parts.push({ x: Math.random()*canvas.width, y: canvas.height+10, r: Math.random()*6+2, speed: Math.random()*1.4+0.4, color: ['#34d399','#60a5fa','#a78bfa','#f59e0b'][Math.floor(Math.random()*4)], alpha:0.6+Math.random()*0.4});
          for (let i=parts.length-1;i>=0;i--){
            const p = parts[i];
            p.y -= p.speed; p.x += Math.sin(p.y/60)*0.3;
            ctx.beginPath(); ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
            if (p.y < -10) parts.splice(i,1);
          }
          requestAnimationFrame(frame);
        }
        frame();
      })();

      // completion confetti
      function runCompletionAnimation(){
        const canvas = document.createElement('canvas');
        canvas.style.position='fixed'; canvas.style.left=0; canvas.style.top=0; canvas.style.width='100%'; canvas.style.height='100%'; canvas.style.zIndex=9999; canvas.style.pointerEvents='none';
        document.body.appendChild(canvas);
        const ctx = canvas.getContext('2d'); canvas.width = innerWidth; canvas.height = innerHeight;
        const confetti = [];
        for (let i=0;i<80;i++) confetti.push({x:Math.random()*canvas.width,y:-10,vx:(Math.random()-0.5)*6,vy:Math.random()*3+2,w:8,h:12,color:['#fde68a','#f97316','#60a5fa','#34d399'][Math.floor(Math.random()*4)],angle:Math.random()*Math.PI});
        let t=0;
        (function frame(){
          t++; ctx.clearRect(0,0,canvas.width,canvas.height);
          for (let i=confetti.length-1;i>=0;i--){
            const c=confetti[i]; c.x+=c.vx; c.y+=c.vy; c.vy+=0.05; ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.angle); ctx.fillStyle=c.color; ctx.fillRect(-c.w/2,-c.h/2,c.w,c.h); ctx.restore(); if (c.y>canvas.height+20) confetti.splice(i,1);
          }
          if (t<220) requestAnimationFrame(frame); else canvas.remove();
        })();
      }

      // utilities
      function escapeHtml(s){ return String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
      function stripHtml(s){ const d=document.createElement('div'); d.innerHTML = s||''; return d.textContent||d.innerText||''; }

      // init wiring
      document.addEventListener('DOMContentLoaded', async ()=> {
        buildPages();
        pageSequence = lessonData.pages.map(p => p.id);
        document.getElementById('nav-header').style.display = 'none';
        speechService = new SpeechService();
        await speechService.init();

        document.getElementById('start-lesson').addEventListener('click', async ()=>{
          await initAudio();
          buildPages();
          navigateTo('main-menu');
          document.getElementById('nav-header').style.display = 'block';
        });
        document.getElementById('nav-back').addEventListener('click', ()=> goBack());
        document.getElementById('nav-next').addEventListener('click', ()=> goNext());
        document.getElementById('nav-home').addEventListener('click', ()=> navigateTo('main-menu'));
        document.getElementById('nav-tts').addEventListener('click', function(){ const on = speechService.toggle(); this.setAttribute('aria-pressed', String(on)); this.style.opacity = on ? '1' : '0.6'; });

        document.getElementById('modalClose').addEventListener('click', ()=> document.getElementById('keywordModal').style.display = 'none');

        // wire new page special buttons (in case buildPages ran earlier)
        document.addEventListener('click', (ev)=>{
          if (ev.target && ev.target.id === 'play-car-sound') { playCarSoundDemo(); }
          if (ev.target && ev.target.id === 'explain-mitigations') {
            if (speechService) speechService.speak('Mitigations include building overpasses, fences, lowering speed limits, and restoring corridors.');
          }
        }, true);
      });

      // expose for debug
      window._lesson = { lessonData, navigateTo, showPhase, playCarSoundDemo };

    })();
  </script>
</body>
</html>
