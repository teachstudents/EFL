<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridging Worlds: Animal Crossings and Biodiversity</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌉</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @keyframes slowColorChange {
            0% { background-color: #166534; } /* Green */
            25% { background-color: #5d4037; } /* Brown */
            50% { background-color: #15803d; } /* Darker Green */
            75% { background-color: #5d4037; } /* Brown */
            100% { background-color: #166534; } /* Green */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            animation: slowColorChange 240s linear infinite;
            padding-top: 70px; /* Add padding to prevent nav overlap */
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
            border: none;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.2);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px -1px rgba(0,0,0,0.2), 0 1px 2px -2px rgba(0,0,0,0.1), inset 0 -2px 0 0 rgba(0,0,0,0.2);
        }

        /* Best Practice: Accessibility improvement for keyboard navigation */
        .action-button:focus-visible, .nav-button:focus-visible, .quiz-option:focus-visible, .tfng-button:focus-visible, .word-bank-word:focus-visible, .btn-animated-3d:focus-visible {
            outline: 3px solid #60a5fa; /* A nice blue outline */
            outline-offset: 2px;
        }
        
        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 44px; padding: 0 4px;
            border: 2px dashed #9ca3af; border-radius: 8px; margin: 0 4px;
            vertical-align: middle; background-color: #f3f4f6;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 8px;
            background-color: white; user-select: none;
        }
        .word-bank-word.selected { outline: 2px solid #6366f1; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; }
        .gap.correct .word-bank-word { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .gap.incorrect .word-bank-word { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Feedback Message & Badge Notification */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #fde047, #f97316); }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 20px; } to { opacity: 0; bottom: 0; } }

        /* Certificate Canvas */
        #completion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* Final Project Hub Styles */
        .phase-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .phase-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .keyword-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .keyword-item:hover {
            transform: scale(1.02);
            background-color: #f0f9ff;
        }
        .rooftop-animation {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .building-svg {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #certificate-to-print, #certificate-to-print * { visibility: visible; }
            #certificate-to-print { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="antialiased text-gray-800 text-lg">
    <canvas id="background-canvas"></canvas>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-sm mx-auto p-1.5 flex justify-center items-center gap-2 bg-white/90 backdrop-blur-sm shadow-lg rounded-full">
            <button onclick="goBack()" class="nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div class="font-bold text-base text-green-600 px-3">Score: <span id="score-display" aria-live="polite">0</span></div>
            <button onclick="navigateTo('main-menu')" class="nav-button bg-gray-800 text-white font-bold p-2 rounded-full hover:bg-gray-900">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            </button>
            <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-full hover:bg-gray-200" title="Toggle Sound">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"></path></svg>
            </button>
            <button onclick="goNext()" class="nav-button bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </header>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <section id="page-title-screen" class="page active text-center bg-white rounded-2xl shadow-lg p-8">
            <div class="h-full flex flex-col justify-center items-center">
                <h1 id="main-title" class="text-5xl md:text-6xl font-bold text-green-800 mb-4"></h1>
                <p id="main-subtitle" class="text-xl md:text-2xl text-gray-600 mb-8"></p>
                <div id="main-svg-container" class="rounded-lg shadow-md mb-8 w-full max-w-lg mx-auto"></div>
                <button onclick="startApp()" class="action-button bg-green-600 text-white font-bold py-3 px-8 rounded-full text-2xl hover:bg-green-700">START LESSON</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <!-- Keyword Modal -->
    <div id="keywordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <p id="modalContent" class="text-gray-700 leading-relaxed"></p>
            </div>
        </div>
    </div>
    
    <!-- 
        Best Practice: AudioWorklet for generating sound effect sequences.
        This runs on a separate audio thread, ensuring smooth, responsive audio 
        without blocking the main UI thread, preventing clicks and lag.
    -->
    <script id="sequence-processor" type="worklet-script">
        class SequenceProcessor extends AudioWorkletProcessor {
            constructor() {
                super();
                this._sequence = [];
                this._currentNoteIndex = 0;
                this._samplesUntilNextStep = 0;
                this._isPlaying = false;

                this.port.onmessage = (event) => {
                    if (event.data.type === 'play') {
                        this._sequence = event.data.sequence;
                        this._currentNoteIndex = 0;
                        this._samplesUntilNextStep = 0;
                        this._isPlaying = true;
                    }
                };
            }

            process(inputs, outputs, parameters) {
                const output = outputs[0];
                const outputChannel = output[0];

                if (!this._isPlaying) {
                    return true;
                }

                for (let i = 0; i < outputChannel.length; i++) {
                    if (this._samplesUntilNextStep <= 0 && this._currentNoteIndex < this._sequence.length) {
                        const note = this._sequence[this._currentNoteIndex];
                        
                        this.port.postMessage({
                            type: 'noteOn',
                            freq: note.freq,
                            dur: note.dur || 0.3,
                            vol: note.vol || 0.5,
                            waveType: note.type || 'sine'
                        });

                        const gap = note.gap || note.dur || 0.3;
                        this._samplesUntilNextStep = gap * sampleRate;
                        this._currentNoteIndex++;
                    }

                    this._samplesUntilNextStep--;
                    outputChannel[i] = 0; // The main thread will generate the actual sound
                }

                if (this._currentNoteIndex >= this._sequence.length && this._samplesUntilNextStep <= - (0.3 * sampleRate) ) {
                    this._isPlaying = false;
                }

                return true;
            }
        }
        registerProcessor('sequence-processor', SequenceProcessor);
    </script>


    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION ---
        // ===================================================================================
        const lessonData = {
            title: "Bridging Worlds",
            subtitle: "Animal Crossings and Biodiversity <span aria-hidden='true'>🌉🐾</span>",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-tps', text: 'Think-Pair-Share <span aria-hidden="true">🧠</span>', color: 'green', target: 'tps-start' },
                { id: 'menu-goals', text: 'Learning Goals <span aria-hidden="true">🎯</span>', color: 'teal', target: 'learning-goals' },
                { id: 'menu-warmup', text: 'Warm-Up & Vocab <span aria-hidden="true">📚</span>', color: 'sky', target: 'warm-up' },
                { id: 'menu-reading', text: 'Reading: A Safe Path <span aria-hidden="true">📖</span>', color: 'blue', target: 'reading-main' },
                { id: 'menu-convo', text: 'Conversation Practice <span aria-hidden="true">🗣️</span>', color: 'indigo', target: 'conversation-practice' },
                { id: 'menu-lecture1', text: 'Listening: Engineering for Coexistence <span aria-hidden="true">🧑‍🔬</span>', color: 'amber', target: 'lecture-coexistence' },
                { id: 'menu-podcast1', text: 'Listening: A Conversation <span aria-hidden="true">🎧</span>', color: 'lime', target: 'podcast-biodiversity' },
                { id: 'menu-dilemma-solar', text: 'Dilemma: Solar Farm <span aria-hidden="true">🤔</span>', color: 'rose', target: 'dilemma-solar-farm' },
                { id: 'menu-dilemma-wind', text: 'Dilemma: Wind Farm <span aria-hidden="true">⚠️</span>', color: 'red', target: 'dilemma-wind-farm' },
                { id: 'menu-thinking', text: 'Thinking & Exam Prep <span aria-hidden="true">📝</span>', color: 'purple', target: 'thinking-prompts' },
                { id: 'menu-final', text: 'Final Project <span aria-hidden="true">✍️</span>', color: 'violet', target: 'final-project-hub' },
            ],
            badges: {
                'STREAK_5': { name: 'Hot Streak', icon: '🔥', description: '5 correct answers in a row' },
                'PERFECT_LEVEL': { name: 'Flawless', icon: '💎', description: 'Complete a level with no mistakes' },
                'GAME_COMPLETE': { name: 'Conservation Champion', icon: '🏆', description: 'Complete all challenges' },
            },
            vocabulary: [
                { word: 'Habitat', def: 'The natural home or environment of an animal or plant.', sentence: 'The forest provides a perfect habitat for deer and wild birds.' },
                { word: 'Fragmentation', def: 'The process of being broken into smaller or separate parts.', sentence: 'Roads cause habitat fragmentation, which isolates animal populations.' },
                { word: 'Corridor', def: 'A strip of land that connects two or more larger areas of similar habitat.', sentence: 'A wildlife corridor allows animals to move safely between forests.' },
                { word: 'Biodiversity', def: 'The variety of plant and animal life in a particular habitat.', sentence: 'Protecting biodiversity is essential for a healthy planet.' },
                { word: 'Coexistence', def: 'The state of living or existing at the same time or in the same place.', sentence: 'Animal bridges help promote coexistence between humans and wildlife.' },
                { word: 'Infrastructure', def: 'Basic physical systems like roads, bridges, and power supplies.', sentence: 'New infrastructure projects must consider their environmental impact.' },
                { word: 'Migration', def: 'Seasonal movement of animals from one region to another.', sentence: 'The bridge helps animals during their annual migration to find food.' },
                { word: 'Overpass', def: 'A bridge by which a road or railway line passes over another.', sentence: 'An animal overpass is a bridge built specifically for wildlife.' },
                { word: 'Underpass', def: 'A road or tunnel that passes under another road or a railway.', sentence: 'Smaller animals like frogs and badgers often prefer to use an underpass.' },
                { word: 'Conservation', def: 'The protection of animals, plants, and natural resources.', sentence: 'Wildlife conservation is the main goal of this project.' }
            ],
            pages: [
                 // Think Pair Share
                { id: 'tps-start', type: 'simple', content: { title: 'Activity: Think-Pair-Share <span aria-hidden="true">🧠</span>', text: 'Let\'s brainstorm about our local environment.' } },
                { id: 'tps-think', type: 'timer', content: { title: 'Think <span aria-hidden="true">🤔</span>', text: 'Have you ever seen an animal (other than a bird) trying to cross a busy road? What happened? What were the dangers?', duration: 120, timerId: 'timer-think' } },
                { id: 'tps-pair', type: 'timer', content: { title: 'Pair <span aria-hidden="true">👥</span>', text: 'Pair with a colleague. Look at a map of your city. Where are the green spaces (parks, forests)? Are they connected, or are they islands separated by roads and buildings?', duration: 180, timerId: 'timer-pair' } },
                { id: 'tps-share', type: 'timer', content: { title: 'Share <span aria-hidden="true">🗣️</span>', text: 'Let\'s share some ideas. If you were an animal, what would be the most difficult part of living in a city?', duration: 300, timerId: 'timer-share' } },
                
                // STAGE 1 & 2
                { id: 'learning-goals', type: 'html-content', content: { title: 'Stage 1: Desired Results <span aria-hidden="true">🎯</span>', html: `
                        <p><strong class="text-rose-600">Topic:</strong> Animal Bridges and Wildlife Corridors</p>
                        <p><strong class="text-rose-600">Theme:</strong> Human-Wildlife Coexistence and Conservation Engineering</p>
                        <p><strong class="text-rose-600">Essential Question:</strong> How can innovative engineering and design help humans and wildlife coexist safely and support biodiversity in a developing world?</p>
                        <p><strong class="text-rose-600">Learning Intention:</strong> We are learning to analyze how roads and cities create problems for wildlife and to design an engineering solution that helps animals move safely.</p>
                        <hr class="my-4">
                        <h3 class="text-2xl font-bold text-rose-600 mb-3">Success Criteria</h3>
                        <ul class="list-disc list-inside space-y-2 text-xl">
                            <li>I can define “habitat fragmentation” and explain why it is a problem for animals.</li>
                            <li>I can describe two different types of wildlife crossings and how they work.</li>
                            <li>I can collaborate to design a wildlife bridge and explain its key features.</li>
                        </ul>` } },
                
                // STAGE 3 - W, H, E
                { id: 'warm-up', type: 'html-content', content: { title: 'Hook & Engage: Warm-Up', html: `
                        <h3 class="text-2xl font-bold text-sky-600 mb-3">Background-Building Questions</h3>
                        <ol class="list-decimal list-inside space-y-4 text-xl">
                            <li>Have you ever seen an animal (other than a bird) trying to cross a busy road? What happened? What were the dangers?</li>
                            <li>Look at a map of your city. Where are the green spaces (parks, forests)? Are they connected, or are they islands separated by roads and buildings?</li>
                            <li>If you were an animal, what would be the most difficult part of living in a city?</li>
                        </ol>` } },
                { id: 'vocab-start', type: 'simple', content: { title: 'Unit Vocabulary <span aria-hidden="true">📚</span>', text: 'Let\'s learn the key terms for this unit. Click "Next" in the header to cycle through the words.' } },
                { id: 'vocab-match', type: 'quiz-mcq', content: { title: 'Vocabulary Practice: Matching', questions: [] } },
                { id: 'reading-main', type: 'html-content', content: { title: 'Reading: Tiered Texts <span aria-hidden="true">📖</span>', html: `
                        <div class="mb-8">
                            <h3 class="text-2xl font-bold text-blue-600 mb-3">Pre-Reading Questions</h3>
                            <ol class="list-decimal list-inside space-y-2 text-xl">
                                <li>Why can’t animals just stay on one side of a road?</li>
                                <li>What kind of features would a bridge for animals need to have?</li>
                                <li>Do you think building a bridge for animals is a good use of money? Why or why not?</li>
                            </ol>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-bold text-xl text-blue-800">Text 1: A Safe Path for Animals</h4>
                                <p>When we build a big road, it can cut a forest in two. This is called habitat fragmentation. It is a problem for animals. They cannot move to find food or meet other animals. It is also dangerous for them to cross the road. To help, we can build special bridges for animals. A bridge that goes over the road is an overpass. A tunnel that goes under the road is an underpass. These bridges are covered with grass and trees to make them feel like a real habitat. This helps animals cross safely.</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-bold text-xl text-yellow-800">Text 2: Connecting a Fragmented World</h4>
                                <p>Human infrastructure, like highways and railways, is essential for our lives. However, it creates a serious problem for wildlife: habitat fragmentation. When a road cuts through a forest, it creates two smaller, isolated islands of land. This is dangerous for the biodiversity of the area. Animal populations can become trapped, unable to access food, water, or mates in the other part of their habitat. This can lead to a decline in their numbers. The solution is to create wildlife corridors. These are safe passages that connect fragmented habitats. The most famous examples are wildlife overpasses—large bridges covered in native vegetation—and underpasses. These structures allow for the safe migration of animals, from large deer to small amphibians, promoting human-wildlife coexistence and preventing vehicle collisions.</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-bold text-xl text-red-800">Text 3: Engineering for Coexistence: The Science of Wildlife Corridors</h4>
                                <p>As human development expands, the integrity of natural ecosystems is increasingly threatened by habitat fragmentation. This phenomenon, primarily caused by linear infrastructure like highways, isolates wildlife populations, which restricts genetic exchange and can lead to local extinctions. This loss of connectivity is one of the greatest threats to global biodiversity. Effective conservation strategies must therefore address this challenge directly. The most successful interventions are wildlife corridors, engineered structures that restore landscape connectivity. These range from large-scale vegetated overpasses that mimic natural habitat for large mammals, to smaller culverts and underpasses designed for amphibians and small mammals. The design of these corridors is a science in itself. Factors such as location, width, noise-dampening barriers, and the type of vegetation are all critical for success. By providing safe passage, these structures not only protect wildlife but also enhance human safety by significantly reducing the number of dangerous and costly wildlife-vehicle collisions. They are a prime example of innovative engineering promoting coexistence in a crowded world.</p>
                            </div>
                        </div>` } },
                { id: 'reading-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap Fill', sentences: [] } },
                { id: 'reading-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False', questions: [] } },
                { id: 'reading-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [] } },
                { id: 'conversation-practice', type: 'dialogue', content: { title: 'Interactive Conversation Practice <span aria-hidden="true">🗣️</span>', dialogue: "Leo: I never really thought about how a road could be a huge wall for an animal. It’s a new perspective for me.\n\nMia: I know, right? A deer wouldn’t know how to look both ways before crossing. The idea of an animal bridge is genius.\n\nLeo: I agree, but they must be incredibly expensive to build. I wonder if the money could be better spent on other conservation projects.\n\nMia: That’s a valid point. However, the text mentioned they also reduce car accidents, which saves money and lives. So there’s a human benefit, too.\n\nLeo: That’s true. And I suppose you can’t protect a species if its habitat is fragmented. It seems to me that these corridors are essential.\n\nMia: My thoughts exactly. It’s about solving the root problem, not just the symptoms. What if they made them a required part of every new highway project?\n\nLeo: That’s a brilliant idea! It would make conservation a standard part of infrastructure planning.\n\nMia: I’m glad you agree. It’s about planning for coexistence from the start." } },
                
                // LISTENING ACTIVITIES
                { id: 'lecture-coexistence', type: 'dialogue', content: { title: 'Listening: Engineering for Coexistence <span aria-hidden="true">🧑‍🔬</span>', dialogue: "Professor: Welcome everyone to our lecture on ecological engineering. Today we're focusing on engineering for coexistence, the science of wildlife corridors. We'll start by examining the challenge of habitat fragmentation caused by human development, then explore how wildlife corridors address this problem, look at the science behind their design, and finally, discuss their benefits for both wildlife and humans. I'm joined by two students who have been researching this topic, Sarah and David. Thanks for being here.\n\nSarah: Thank you, professor. It's a fascinating topic.\n\nDavid: Yeah, thanks for having us, professor. We're eager to discuss our findings.\n\nProfessor: Excellent. Let's dive right in. Sarah, could you begin by explaining the problem of habitat fragmentation and its impact on wildlife?\n\nSarah: Sure, professor. Habitat fragmentation occurs when human infrastructure, like roads and buildings, breaks up large natural areas into smaller, isolated patches. This makes it difficult for wildlife to move between these areas, leading to reduced genetic diversity, smaller populations, and increased vulnerability to local extinction.\n\nProfessor: That isolation is a major threat to biodiversity. David, how do wildlife corridors help to mitigate this fragmentation?\n\nDavid: Wildlife corridors are designed to reconnect these fragmented habitats, professor. They provide safe pathways for animals to travel between isolated patches, allowing for gene flow, access to resources, and movement in response to environmental changes. They can be overpasses, underpasses, or even strips of natural vegetation.\n\nProfessor: So they're essentially engineered bridges for wildlife. Sarah, what are some of the ecological considerations that go into designing an effective wildlife corridor?\n\nSarah: The location is crucial, professor. It needs to be placed where animals are likely to cross or where connectivity is most needed. The width of the corridor, the type of vegetation, and minimizing disturbances like noise and light are also important factors to ensure animals actually use it.\n\nProfessor: It sounds like a complex science. David, beyond the ecological benefits, are there any advantages for humans?\n\nDavid: Absolutely, professor. One of the most significant human benefits is the reduction in wildlife-vehicle collisions. By providing safe passage for animals, we decrease the risk of accidents, which improves human safety and reduces property damage.\n\nProfessor: That's a clear win-win. To wrap up, let's review the key points. We've learned how habitat fragmentation threatens biodiversity and how wildlife corridors provide a vital solution by restoring connectivity. We also discussed the scientific principles behind designing effective corridors and the benefits they offer to both wildlife and human safety. Thank you, Sarah and David for your insights today.\n\nSarah: Thank you, professor.\n\nDavid: Thanks, professor. It was very informative." } },
                { id: 'lecture-coexistence-quiz-mcq', type: 'quiz-mcq', content: { title: 'Coexistence Lecture Quiz (MCQ)', questions: [] } },
                { id: 'lecture-coexistence-quiz-tfng', type: 'quiz-tfng', content: { title: 'Coexistence Lecture Quiz (TFNG)', questions: [] } },
                { id: 'lecture-coexistence-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Coexistence Lecture Quiz (Gap Fill)', sentences: [] } },
                { id: 'podcast-biodiversity', type: 'dialogue', content: { title: 'Listening: Biodiversity Conversation <span aria-hidden="true">🎧</span>', dialogue: "Chris: G'day everyone! As engineers, how can we truly design infrastructure that allows humans and wildlife to coexist, especially when it comes to something as vital as biodiversity?\n\nSarah: That's a fantastic question to kick us off, Chris. I'm Sarah, an ecological engineer based in London, and my work often involves mitigating the impact of urban development on local ecosystems. I think the answer lies in smart, data-driven design.\n\nAlex: I'm Alex, a transportation planner from California, focusing on sustainable infrastructure. Great to be discussing this with you both. Sarah, I agree. It's about intentional design. Chris, your point about biodiversity is spot on. It's not just about individual animals, but maintaining healthy populations.\n\nChris: Exactly Alex, I'm Chris, a civil engineer from Sydney, and I've seen firsthand the challenges of urban sprawl on native species. So, when we talk about wildlife corridors, what are the key engineering considerations? For instance, where should they even be located to be most effective?\n\nSarah: Location is absolutely critical, Chris. We need to place corridors in areas that connect existing habitats or crucial resources. It requires ecological surveys to understand animal movement patterns, and the width matters too. A narrow strip isn't much use for many species. We're often talking about widths that can range from tens to hundreds of meters, depending on the target species.\n\nAlex: And from a transportation perspective, reducing vehicle collisions is a huge driver for these projects. We've implemented underpasses and overpasses in California, for example. But beyond just physical crossings, what about noise barriers? Does traffic noise deter animals from using a corridor? And how can we engineer solutions for that?\n\nChris: That's a fair point Alex. Noise can definitely stress wildlife. We need to consider materials and designs for noise walls that absorb or deflect sound effectively. Also, the type of vegetation within and around the corridor is crucial isn't it Sarah? It provides cover and food, making it more attractive and safer for animals.\n\nSarah: Absolutely Chris, native vegetation is key, it mimics natural habitats and supports local wildlife. So if we were to design a new wildlife crossing over a busy highway, what would be our top three engineering priorities to ensure it's effective and safe for both animals and humans?\n\nAlex: Okay, if we're designing one. First, I'd prioritize structural integrity and safety for vehicles below. Second, ensuring the crossing is wide enough and properly vegetated to encourage animal use. And third, incorporating features like fencing to funnel animals towards the crossing and potentially noise reduction measures.\n\nChris: Good points Alex. I'd add that the transition zones at either end are vital, making sure animals feel safe approaching. And ongoing monitoring is an engineering challenge in itself. How do we track if animals are actually using it and if it's reducing collisions effectively? We need integrated sensor systems perhaps.\n\nSarah: Monitoring is essential for evaluating success. So designing in those data collection points from the start is key. Perhaps we could even design a modular system, a kit of parts for different environments. Imagine designing a standard underpass or overpass module that can be adapted with different fencing, vegetation and monitoring tech depending on the location and target species.\n\nAlex: That would be a fascinating engineering challenge. A modular design approach? I love that Sarah. It makes these solutions more scalable and potentially more cost effective for wider implementation. We'd need to engineer for durability in different climates, ease of construction and integration with various local ecosystems.\n\nChris: That's a real engineering for coexistence challenge right there. Righto, that's a ripper idea. It's a design adaptable modular wildlife crossing system. It'd need to handle everything from kangaroos in the outback to deer in the US and badgers in the UK. A complex but incredibly rewarding engineering project, aiming for a future where our infrastructure supports, rather than hinders, the incredible biodiversity we share the planet with." } },
                { id: 'podcast-biodiversity-quiz-mcq', type: 'quiz-mcq', content: { title: 'Biodiversity Podcast Quiz (MCQ)', questions: [] } },
                { id: 'podcast-biodiversity-quiz-tfng', type: 'quiz-tfng', content: { title: 'Biodiversity Podcast Quiz (TFNG)', questions: [] } },
                { id: 'podcast-biodiversity-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Biodiversity Podcast Quiz (Gap Fill)', sentences: [] } },
                { id: 'dilemma-solar-farm', type: 'dialogue', content: { title: 'Dilemma: Solar Farm <span aria-hidden="true">🤔</span>', dialogue: "Sarah: So, um, so uh moving on to another scenario. This one about the massive solar farm, choosing between location A, the sacred ancestral land, or location B, the farmland. This is, this is a really difficult ethical choice.\n\nDavid: Indeed. A classic utilitarian versus deontological conflict in a way. As the person who has to make a recommendation, I suppose, thinking about it, in my opinion, the best course of action is to recommend location B.\n\nEmma: Yeah, I see your point, David, about the larger number of people affected by destroying the farmland, but I have a different perspective. I believe we should choose location A. This is justified because, from my perspective, the most ethical choice is respecting the rights and cultural heritage of the indigenous community. Their connection to that land is irreplaceable.\n\nSarah: Hmm, I understand why you say that, Emma. The cultural significance is immense. But um, while it is true that location A is sacred land, I still believe that the impact on the rural town of 5,000 people is, are more critical right now. The evidence suggests that losing their farmland would be devastating to their livelihoods and community structure.\n\nDavid: Precisely, Sarah. And could you please explain what you mean by irreplaceable, Emma? I'm not sure I fully understand the, the long-term consequence of displacing the indigenous community versus destroying the farmland.\n\nEmma: Right. Well it's about history, you know, and identity. That land holds generations of their stories and traditions. Furthermore, we must consider the principle of not forcibly removing people from their homes and cultural sites. It's not just about the immediate displacement. Think about the stolen generations here in Australia. The trauma of being removed from your land and culture lasts for generations, you know?\n\nSarah: That's a great point, Emma. I'd also like to add that while 5,000 is a larger number, displacing 200 people from their ancestral land seems like a more profound violation of rights than impacting the livelihoods of 5,000 who could potentially adapt or be compensated, though that's not ideal either.\n\nDavid: True, true. On the one hand, the cultural and historical significance of location A is compelling. But on the other hand, the sheer number of people whose lives would be severely impacted by destroying the farmland at location B. What would happen if we explored alternative solar farm technologies or smaller, distributed solar projects that wouldn't require such a massive footprint?\n\nEmma: Yeah, I see what you mean, David. It's a bit of a balancing act, isn't it? The value of cultural heritage versus economic livelihood and population size. It seems to me that the only real option is, well, it's not easy to choose who suffers.\n\nSarah: Absolutely. I mean, ideally there would be a win-win scenario, but with these two stark choices, I respectfully disagree that location A is the only real option though. The responsibility to the larger population in the rural town is also a significant ethical consideration.\n\nDavid: Perhaps a negotiation approach is the way to go. But, you know, that idea of engaging with both communities to find a solution that minimizes harm.\n\nEmma: Yeah, that makes sense. Little by little I reckon. Talk to the indigenous community, talk to the townspeople, see if there's any common ground or alternative solutions.\n\nSarah: That's a possibility. We'd need to weigh the pros and cons carefully for a negotiation process too. It could be time-consuming and might not lead to a viable solution.\n\nDavid: Indeed. It's a complex issue with, with no easy answers in this scenario. A truly unenviable position for the person making the recommendation.\n\nEmma: So uh to review, we've chatted about the sacred land versus farmland dilemma, the value of cultural heritage versus economic livelihood and population size, and the idea of maybe trying a negotiation or alternative technology approach. We also touched on real-world examples, like the stolen generations. Pretty much covered the, uh, the main points, I think." } },
                { id: 'dilemma-solar-farm-quiz-mcq', type: 'quiz-mcq', content: { title: 'Solar Farm Dilemma Quiz (MCQ)', questions: [] } },
                { id: 'dilemma-solar-farm-quiz-tfng', type: 'quiz-tfng', content: { title: 'Solar Farm Dilemma Quiz (TFNG)', questions: [] } },
                { id: 'dilemma-solar-farm-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Solar Farm Dilemma Quiz (Gap Fill)', sentences: [] } },
                { id: 'dilemma-wind-farm', type: 'dialogue', content: { title: 'Dilemma: Wind Farm <span aria-hidden="true">⚠️</span>', dialogue: "Sarah: So, uh moving on to another scenario about the towns needing a new power source and the wind farm. This is, this is another one about cooperation and trust between communities.\n\nDavid: Indeed. A classic collective action problem. As the representative for my town, I suppose, thinking about it, in my opinion, the best course of action is to agree to invest in the wind farm.\n\nEmma: Yeah, I see your point, David, about the clean reliable energy, but I have a different perspective. I believe we should choose not to invest, at least not without a very solid agreement. This is justified because, from my perspective, the most ethical choice is protecting our town's money from being exploited. We don't want to pay for it while they benefit for free.\n\nSarah: Hmm, I understand why you say that, Emma. The risk of the other town not paying their share is real. But um, while it is true that there's a risk of exploitation if only one invests, I still believe that the potential for clean reliable energy and avoiding future pollution and blackouts is, are more critical right now. The evidence suggests that relying on old power sources is becoming increasingly unsustainable.\n\nDavid: Precisely, Sarah. And could you please explain what you mean by a solid agreement, Emma? I'm not sure I fully understand the, the level of guarantee you would need from the other town.\n\nEmma: Right. Well it's about trust, you know, and consequences. If we invest and they don't, our town is out a lot of money and they get free energy. Furthermore, we must consider the impact on our town's finances if we're stuck with the whole bill. It's not just about the energy.\n\nSarah: That's a great point, Emma. I'd also like to add that if neither town invests, both continue to suffer from pollution and blackouts. That's a guaranteed negative outcome.\n\nDavid: True, true. On the one hand, the risk of financial exploitation is compelling. But on the other hand, the certainty of continued pollution and blackouts if neither invests. What would happen if we tried to involve a third-party mediator to oversee the investment and ensure both towns contribute?\n\nEmma: Yeah, I, I see what you mean, David. It's a bit of a balancing act, isn't it? Trust versus the need for clean energy. It seems to me that the only real option is, well, it's not easy to decide without knowing if we can truly rely on the other town.\n\nSarah: Absolutely. I mean, ideally we'd have a strong inter-town relationship already, but in this scenario, we have to make a call based on the potential for cooperation versus the risk of being taken advantage of. I respectfully disagree that the only real option is not investing though. The potential shared benefit is, is pretty clear if both cooperate.\n\nDavid: Perhaps a phased investment approach is the way to go. Start with a smaller initial investment to build trust, as Dr. Chen suggested previously. Though, of course, we don't have Dr. Chen here today. But, you know, that idea of starting small and then, then committing fully.\n\nEmma: Yeah, that makes sense. Little by little I reckon. Put in a bit of money, see if they match it, and if they do, invest the rest.\n\nSarah: That's a possibility. We'd need to weigh the pros and cons carefully for that approach too. What if they just take the initial investment and still don't contribute fully?\n\nDavid: Indeed. It's a complex issue with, with no easy answers in this scenario. A truly unenviable position for the town representatives." } },
                { id: 'dilemma-wind-farm-quiz-mcq', type: 'quiz-mcq', content: { title: 'Wind Farm Dilemma Quiz (MCQ)', questions: [] } },
                { id: 'dilemma-wind-farm-quiz-tfng', type: 'quiz-tfng', content: { title: 'Wind Farm Dilemma Quiz (TFNG)', questions: [] } },
                { id: 'dilemma-wind-farm-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Wind Farm Dilemma Quiz (Gap Fill)', sentences: [] } },

                // STAGE 3 - R, E, T, O
                { id: 'thinking-prompts', type: 'html-content', content: { title: 'Rethink, Revise, Reflect <span aria-hidden="true">📝</span>', html: `
                        <div class="mb-6">
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Harkness Discussion Prompt</h3>
                            <p class="text-xl italic">“When there is a conflict between human development (like a new highway or housing project) and wildlife conservation, which should be the priority? Is compromise always possible?”</p>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Higher-Order Thinking Questions</h3>
                            <ul class="list-disc list-inside space-y-2 text-lg">
                                <li><b>Remembering:</b> What are two types of wildlife crossings?</li>
                                <li><b>Understanding:</b> Explain in your own words why habitat fragmentation is a threat to biodiversity.</li>
                                <li><b>Applying:</b> Choose a local park or green space near you. If a new road were to cut through it, where would you propose building a wildlife corridor and why?</li>
                                <li><b>Analyzing:</b> Compare the needs of a large migrating animal (like a bear) with a small, slow-moving animal (like a turtle) when designing a wildlife corridor. How would the designs differ?</li>
                                <li><b>Evaluating:</b> Argue whether it is more effective to build one very large, expensive wildlife overpass or many small, cheaper underpasses. Justify your reasoning.</li>
                                <li><b>Creating:</b> You are an animal that has just used a wildlife bridge for the first time. Write a short story or a poem about your journey.</li>
                            </ul>
                        </div>` } },
                { id: 'exam-practice', type: 'html-content', content: { title: 'Connections to IELTS & TOEFL', html: `
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-2xl font-bold text-purple-600 mb-3">IELTS Speaking Practice</h3>
                                <p><b>Part 1:</b> Do you like animals? What is your country’s most famous animal? Do you think it’s important to protect wild animals?</p>
                                <p><b>Part 2 (Cue Card):</b> Describe a time when you saw a wild animal. You should say: what the animal was, where you saw it, what it was doing, and explain how you felt about the experience.</p>
                                <p><b>Part 3:</b> What are the main reasons why some animals are endangered? How can humans help protect endangered species? Do you think zoos are good or bad for animals?</p>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-purple-600 mb-3">TOEFL Independent Speaking</h3>
                                <p>Some people think that governments should spend money on protecting wild animals, while others think the money should be spent on human needs. Which view do you agree with and why?</p>
                            </div>
                        </div>` } },
                { id: 'final-project-hub', type: 'html-content', content: { title: 'Final Project Hub <span aria-hidden="true">✍️</span>', html: `
                        <div class="bg-gradient-to-br from-green-50 to-teal-50">
                            <header class="bg-white shadow-lg border-b-4 border-green-500">
                                <div class="max-w-7xl mx-auto px-6 py-8">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h1 class="text-4xl font-bold text-gray-800 mb-2"><span aria-hidden="true">🌉🐾</span> Bridging Worlds</h1>
                                            <p class="text-xl text-gray-600">Final Project Guide</p>
                                        </div>
                                        <div class="rooftop-animation">
                                            <svg class="w-24 h-24" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 70 C 30 50, 70 50, 90 70" stroke="#8d6e63" stroke-width="6" fill="none"/><path d="M10 70 V 90 H 20 V 70 Z" fill="#a1887f"/><path d="M80 70 V 90 H 90 V 70 Z" fill="#a1887f"/><path d="M20 60 Q 50 40, 80 60" stroke="#4caf50" stroke-width="12" fill="none" stroke-linecap="round"/><text x="30" y="55" font-size="10">🌳</text><text x="50" y="50" font-size="10">🌲</text><text x="70" y="55" font-size="10">🌳</text></svg>
                                        </div>
                                    </div>
                                </div>
                            </header>
                            <section class="max-w-7xl mx-auto px-6 py-12">
                                <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">🎯</span> Big Ideas & Understanding</h2>
                                    <div class="grid md:grid-cols-2 gap-8"><div class="bg-gradient-to-r from-green-100 to-teal-100 p-6 rounded-xl"><h3 class="text-xl font-semibold text-gray-800 mb-4"><span aria-hidden="true">🌍</span> Enduring Understanding</h3><p class="text-gray-700 leading-relaxed">Thoughtful design and infrastructure can solve complex conflicts between human development and natural ecosystems.</p></div><div class="bg-gradient-to-r from-teal-100 to-cyan-100 p-6 rounded-xl"><h3 class="text-xl font-semibold text-gray-800 mb-4"><span aria-hidden="true">💡</span> Big Idea</h3><p class="text-gray-700 leading-relaxed">We can build our world in harmony with nature.</p></div></div>
                                </div>
                                <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">🎓</span> Transferable KSA Skills</h2>
                                    <div class="grid md:grid-cols-3 gap-6"><div class="text-center p-6 bg-red-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">🧠</span></div><h3 class="text-xl font-semibold text-red-700 mb-3">Knowledge</h3><p class="text-gray-700 text-sm">Habitat fragmentation, types of animal crossings, urban planning, ecological corridors.</p></div><div class="text-center p-6 bg-blue-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">🛠️</span></div><h3 class="text-xl font-semibold text-blue-700 mb-3">Skills</h3><p class="text-gray-700 text-sm">Collaborative problem-solving, critical analysis, persuasive communication, research, technical design.</p></div><div class="text-center p-6 bg-green-50 rounded-xl"><div class="text-4xl mb-4"><span aria-hidden="true">❤️</span></div><h3 class="text-xl font-semibold text-green-700 mb-3">Attitudes</h3><p class="text-gray-700 text-sm">Environmental stewardship, curiosity, responsibility, confidence to advocate for creative solutions.</p></div></div>
                                </div>
                                <div class="mb-12">
                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8"><span aria-hidden="true">🚀</span> Project-Based Learning Journey</h2>
                                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6"><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(1)"><div class="text-4xl mb-4"><span aria-hidden="true">🔍</span></div><h3 class="text-xl font-bold mb-2">Phase 1</h3><p class="text-sm opacity-90">Identifying Problems & Initial Inquiry</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(2)"><div class="text-4xl mb-4"><span aria-hidden="true">📚</span></div><h3 class="text-xl font-bold mb-2">Phase 2</h3><p class="text-sm opacity-90">Researching Solutions & Concepts</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(3)"><div class="text-4xl mb-4"><span aria-hidden="true">📐</span></div><h3 class="text-xl font-bold mb-2">Phase 3</h3><p class="text-sm opacity-90">Planning & Design</p></div><div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(4)"><div class="text-4xl mb-4"><span aria-hidden="true">📊</span></div><h3 class="text-xl font-bold mb-2">Phase 4</h3><p class="text-sm opacity-90">Evaluation & Communication</p></div></div>
                                </div>
                                <div id="phaseContent" class="bg-white rounded-2xl shadow-xl p-8"></div>
                            </section>
                        </div>` } },
                { id: 'writing-task', type: 'writing-task', content: { 
                    title: 'Writing Activity <span aria-hidden="true">✍️</span>', 
                    prompt: 'A new high-speed railway is being planned to go through a rural area near your town. Write a formal letter to your local government representative expressing your concern about habitat fragmentation and persuading them to include wildlife corridors in the railway’s design.', 
                    starters: ['I am writing to you today with a serious concern regarding...', 'The construction of this railway will cause significant...', 'Therefore, I strongly urge you to advocate for the inclusion of...', 'This is not only a matter of conservation; it is also a matter of safety...', 'By integrating these features into the design now, we can create a project that benefits both people and nature...'],
                    wordBank: ['accident', 'benefit', 'biodiversity', 'bridge', 'coexist', 'connect', 'conservation', 'corridor', 'cost', 'design', 'ecosystem', 'engineering', 'environment', 'fragmentation', 'future', 'habitat', 'highway', 'human', 'infrastructure', 'local', 'migration', 'population', 'protect', 'safety', 'wildlife']
                } },
                { id: 'self-assessment', type: 'html-content', content: { title: 'Self-Assessment & Rubric <span aria-hidden="true">🧑‍🏫</span>', html: `
                        <div class="mb-8">
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Metacognitive Self-Assessment</h3>
                            <ol class="list-decimal list-inside space-y-4 text-xl">
                                <li>“Which activity helped me understand the problem of habitat fragmentation the most? Why was it effective for me?”</li>
                                <li>“On a scale of 1-5, how confident am I that I could explain the purpose of a wildlife bridge to a family member in English? What one keyword do I need to practice more?”</li>
                            </ol>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Final Project Rubric (KASE-C)</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="bg-purple-50">
                                            <th class="border-b-2 p-2 w-1/4">Criterion</th>
                                            <th class="border-b-2 p-2">5 - Exemplary</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="border-b p-2 font-semibold">K – Knowledge</td><td class="border-b p-2">The proposal demonstrates a deep, nuanced understanding of habitat fragmentation and the specific ecological needs of the target species. It expertly analyzes the landscape and problem.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">A – Analysis</td><td class="border-b p-2">The proposed bridge design is highly creative, technically sound, and perfectly tailored to the context. It demonstrates exceptional critical thinking and innovative, nature-inspired engineering.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">S – Structure</td><td class="border-b p-2">The presentation is exceptionally clear, engaging, and persuasive. It uses powerful rhetorical strategies and a compelling narrative to connect with a technical and political audience.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">E – Evidence</td><td class="border-b p-2">All claims are consistently supported by strong, relevant, and well-integrated evidence from ecological research and engineering principles. The proposal uses data and diagrams effectively.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">C – Clarity</td><td class="border-b p-2">The student demonstrates a masterful command of English, using a wide and precise range of scientific and technical vocabulary and complex sentence structures accurately and effectively.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>` } },
                { id: 'certificate', type: 'certificate', content: { title: 'Module Complete! <span aria-hidden="true">🎉</span>', text: 'You have successfully completed the "Bridging Worlds" module.', certificateTitle: 'Certificate of Completion' } }
            ]
        };
        // --- END OF LESSON CONTENT CONFIGURATION ---
        // ===================================================================================

        // --- PROJECT HUB DATA & FUNCTIONS ---
        const phases = {
            1: { title: "Phase 1: Identifying the Problem & Initial Inquiry", icon: "<span aria-hidden='true'>🔍</span>", keywords: { "Habitat Fragmentation": "The new highway caused habitat fragmentation, dividing a large forest into smaller areas and making it difficult for animals to move safely.", "Human-Wildlife Conflict": "The new urban area led to increased human-wildlife conflict as animals searched for food and water near homes.", "Urban Expansion": "As a result of urban expansion, the city grew, and more of the surrounding natural land was developed for houses and roads.", "Conservation": "The local government started a conservation program to protect the endangered species living in the area." } },
            2: { title: "Phase 2: Researching Solutions & Foundational Concepts", icon: "<span aria-hidden='true'>📚</span>", keywords: { "Biodiversity": "By creating protected areas, the national park hopes to maintain the biodiversity of the region's plants and animals.", "Animal Crossing": "The new overpass, called an animal crossing, allows deer and other animals to safely cross the highway without causing accidents.", "Ecological Corridor": "The conservation group is working to create an ecological corridor by planting trees and connecting small habitats.", "Wildlife Bridge": "The state built a wildlife bridge over the busy road so that animals could safely travel from one side of the forest to the other.", "Culvert": "The culvert under the road provides a safe passage for small animals like turtles and frogs, protecting them from cars.", "Migration Route": "The salmon's migration route was blocked by the dam, which prevented them from swimming upstream to reproduce.", "Urban Planning": "Good urban planning can help create a city that is both modern and environmentally sustainable, with parks and green spaces integrated into the design." } },
            3: { title: "Phase 3: Planning & Design", icon: "<span aria-hidden='true'>📐</span>", keywords: { "Site Analysis": "The team performed a site analysis to determine the best location for the animal crossing, considering factors like animal trails and human traffic.", "Engineering Feasibility": "The engineers had to ensure the bridge's engineering feasibility, making sure the design was strong and safe to build.", "Ecosystem Restoration": "The project included a plan for ecosystem restoration, planting native trees and plants to recreate the animals' natural habitat.", "Spatial Analysis": "The urban planners used spatial analysis to map the area and identify potential locations for the animal crossing.", "Mapping": "The team used mapping software to show the best route for the new animal crossing and its surrounding wildlife paths." } },
            4: { title: "Phase 4: Evaluation & Communication", icon: "<span aria-hidden='true'>📊</span>", keywords: { "Cost-Benefit Analysis": "We performed a cost-benefit analysis of the wildlife bridge, showing that the project would save lives and money in the long run.", "Social Impact": "The project's social impact was a key part of the proposal, showing how it would reduce car accidents and improve community safety.", "Project Proposal": "The team's final product was a compelling project proposal that clearly explained their goals, budget, and plans for the new animal crossing.", "Persuasive Communication": "The team used powerful visuals and data to create a persuasive communication that convinced the local government to invest in their idea.", "Public Awareness": "The project's public awareness campaign aimed to educate the local community about the importance of protecting wildlife." } }
        };

        window.showPhase = function(phaseNumber) {
            const phase = phases[phaseNumber];
            const content = document.querySelector('#page-final-project-hub #phaseContent');
            if (!content) return;
            let keywordsHtml = Object.entries(phase.keywords).map(([keyword, definition]) => `
                <div class="keyword-item bg-gray-50 p-4 rounded-xl border-l-4 border-green-500" onclick="showKeyword('${keyword}', '${definition.replace(/'/g, "\\'")}')">
                    <h4 class="font-semibold text-gray-800 mb-2">${keyword}</h4>
                    <p class="text-gray-600 text-sm">${definition.substring(0, 100)}...</p>
                </div>`).join('');
            content.innerHTML = `
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">${phase.icon}</div>
                    <h3 class="text-2xl font-bold text-gray-800">${phase.title}</h3>
                </div>
                <div class="grid md:grid-cols-2 gap-4">${keywordsHtml}</div>`;
        }
        window.showKeyword = function(keyword, definition) {
            document.getElementById('modalTitle').textContent = keyword;
            document.getElementById('modalContent').textContent = definition;
            document.getElementById('keywordModal').classList.remove('hidden');
            document.getElementById('keywordModal').classList.add('flex');
        }
        window.closeModal = function() {
            document.getElementById('keywordModal').classList.add('hidden');
            document.getElementById('keywordModal').classList.remove('flex');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // ===================================================================================
            // --- MAIN SCRIPT ---
            // Best practices applied:
            // 1. AudioWorklet: For non-blocking, performant audio.
            // 2. Accessibility: ARIA live regions and focus-visible styles.
            // 3. Code Organization: Clear sections for state, audio, UI, etc.
            // 4. Robustness: Graceful handling of audio initialization failures.
            // ===================================================================================

            // --- STATE MANAGEMENT ---
            let score = 0, currentPage = lessonData.startPageId, timerInterval;
            const pageHistory = [lessonData.startPageId];
            let pageSequence = [];
            let earnedBadges = [];
            let selectedWord = { element: null, text: '' };

            // --- AUDIO & TTS ENGINE ---
            let audioContext, speechService, sequenceNode;
            
            // --- SOUND & PHRASE CONTENT ---
            const correctPhrases = [ "Stellar work!", "You've got it!", "Absolutely brilliant!", "That's the one!", "Incredible!", "You're a genius!", "Keep it up!", "Outstanding!", "Perfectly done!", "You're on fire!" ];
            const incorrectPhrases = [ "That was a great attempt! Let's try another.", "Not this time, but you're getting warmer!", "Every try is a step forward. Keep going!", "Mistakes are proof that you are trying. Don't stop!", "That's not the answer, but I believe in you!", "So close! What's your next idea?", "Don't worry, the best discoveries come after a few tries.", "That's a learning opportunity! Try again.", "Your persistence is inspiring. Let's go again.", "Even experts get it wrong sometimes. You've got this!" ];
            const correctSounds = [ {name: "Bright Ding", seq: [{freq:880,dur:0.3}]}, {name: "Double Chime", seq: [{freq:660,dur:0.2},{freq:880,dur:0.2}]}, {name: "Sparkle Sweep", seq: [{freq:500,dur:0.3},{freq:1500,dur:0.1}]}, {name: "Bell Ping", seq: [{freq:784,dur:0.4}]}, {name: "Arcade Win", seq: [{freq:880,type:'square',dur:0.15},{freq:1320,type:'square',dur:0.15}]}, {name: "Coin Drop", seq: [{freq:1200,type:'sawtooth',dur:0.15},{freq:1800,type:'sawtooth',dur:0.15}]}, {name: "Harp Pluck", seq: [{freq:660,dur:0.15},{freq:880,dur:0.15},{freq:990,dur:0.15}]}, {name: "Pop Click", seq: [{freq:1000,type:'square',dur:0.05}]}, {name: "Magic Twinkle", seq: [{freq:1200,dur:0.1},{freq:2000,dur:0.1}]}, {name: "Level Up", seq: [{freq:660,dur:0.15},{freq:880,dur:0.15},{freq:1320,dur:0.15}]}, {name: "Rising Arpeggio", seq: [{freq:523, dur:0.1}, {freq:659, dur:0.1}, {freq:784, dur:0.1}, {freq:1046, dur:0.1}]}, {name: "Quick Trill", seq: [{freq:988, dur:0.05, gap: 0.05}, {freq:1046, dur:0.05, gap: 0.05}, {freq:988, dur:0.05, gap: 0.05}, {freq:1046, dur:0.05}]}, {name: "Fanfare", seq: [{freq:784, dur:0.15}, {freq:1046, dur:0.25}]}, {name: "Confirm Beep", seq: [{freq:600, type:'triangle', dur:0.1}, {freq:1200, type:'triangle', dur:0.1, gap: 0.1}]}, {name: "Synth Pluck", seq: [{freq:900, type:'sawtooth', vol: 0.3, dur:0.2}]}, {name: "Bell Tree", seq: [{freq:2000, dur:0.05}, {freq:2500, dur:0.05, gap:0.1}, {freq:3000, dur:0.05}]}, {name: "Scale Up", seq: [{freq:440, dur:0.1}, {freq:550, dur:0.1}, {freq:660, dur:0.1}]}, {name: "Shimmer", seq: [{freq:1500, dur:0.4, vol: 0.4}, {freq:1510, dur:0.4, vol:0.4, gap: -0.4}]}, {name: "Power Up", seq: [{freq:330, type:'square', dur:0.1}, {freq:440, type:'square', dur:0.1}, {freq:660, type:'square', dur:0.2}]}, {name: "Complete Chime", seq: [{freq:1046, dur:0.5}]}, {name: "Success Chord", seq: [{freq:523.25, dur:0.4}, {freq:659.25, dur:0.4, gap: -0.4}, {freq:783.99, dur:0.4, gap: -0.4}]}, {name: "Laser Zap", seq: [{freq:1500, type:'sawtooth', dur:0.01}, {freq:500, type:'sawtooth', dur:0.1}]}, {name: "Soft Bell", seq: [{freq:1046.50, dur:0.5, vol: 0.4}]}, {name: "Echo Ping", seq: [{freq:1200, dur:0.1, gap: 0.2}, {freq:1200, dur:0.1, vol: 0.2}]}, {name: "Bubble Pop", seq: [{freq:800, type:'triangle', dur:0.05, vol:0.8}]}, {name: "Achievement", seq: [{freq:392, dur:0.1}, {freq:523, dur:0.1}, {freq:784, dur:0.2}]}, {name: "Positive Chirp", seq: [{freq:2000, type:'sine', dur:0.1}]}, {name: "Digital OK", seq: [{freq:880, type:'square', dur:0.15}, {freq:1108, type:'square', dur:0.15}]}, {name: "Crystal Clear", seq: [{freq:3000, dur:0.2, vol:0.3}]}, {name: "Triumph", seq: [{freq:523.25, type:'sawtooth', dur:0.6}]}, {name: "Glimmer", seq: [{freq:2000, dur:0.3}, {freq:2010, dur:0.3, gap: -0.3}]}, {name: "Double Pop", seq: [{freq:1000, type:'square', dur:0.05, gap:0.05}, {freq:1200, type:'square', dur:0.05}]}, {name: "Ascend", seq: [{freq:440, dur:0.05}, {freq:554, dur:0.05}, {freq:659, dur:0.05}, {freq:880, dur:0.1}]}, {name: "Mission Done", seq: [{freq:261, dur:0.15}, {freq:392, dur:0.15}, {freq:523, dur:0.3}]}, {name: "Harp Cascade", seq: [{freq:1046, dur:0.1}, {freq:784, dur:0.1}, {freq:659, dur:0.1}, {freq:523, dur:0.1}]}, {name: "Victory", seq: [{freq:523, dur:0.1}, {freq:523, dur:0.1, gap:0.1}, {freq:784, dur:0.2}, {freq:659, dur:0.3}]}, {name: "Simple OK", seq: [{freq:700, type:'triangle', dur:0.2}]}, {name: "Gleam", seq: [{freq:4000, dur:0.05, vol:0.2}]}, {name: "Prize Reveal", seq: [{freq:1200, dur:0.1}, {freq:1600, dur:0.1}, {freq:2000, dur:0.2}]}, {name: "Final Ding", seq: [{freq:1046.50, dur:0.4}]} ];
            const incorrectSounds = [ {name: "Buzzer", seq: [{freq:200,type:'square',dur:0.5}]}, {name: "Double Buzz", seq: [{freq:200,type:'square',dur:0.2},{freq:200,type:'square',dur:0.2}]}, {name: "Descending Wah", seq: [{freq:600,dur:0.2},{freq:200,dur:0.3}]}, {name: "Flat Fail", seq: [{freq:150,dur:0.4}]}, {name: "Error Beep", seq: [{freq:400,type:'sawtooth',dur:0.3}]}, {name: "Glitch Zap", seq: [{freq:1000,type:'square',dur:0.05},{freq:300,type:'square',dur:0.05}]}, {name: "Sad Trombone", seq: [{freq:400,dur:0.2},{freq:300,dur:0.2},{freq:200,dur:0.3}]}, {name: "Reject Click", seq: [{freq:100,type:'square',dur:0.05}]}, {name: "Alarm Chirp", seq: [{freq:500,dur:0.2},{freq:500,dur:0.2}]}, {name: "Drop Off", seq: [{freq:800,dur:0.2},{freq:100,dur:0.3}]}, {name: "Wobble", seq: [{freq:300, dur:0.4}, {freq:290, dur:0.4, gap: -0.4}]}, {name: "Downward Slide", seq: [{freq:500, type:'sawtooth', dur:0.05}, {freq:400, type:'sawtooth', dur:0.05}, {freq:300, type:'sawtooth', dur:0.05}, {freq:200, type:'sawtooth', dur:0.2}]}, {name: "Detuned Chord", seq: [{freq:220, dur:0.5}, {freq:225, dur:0.5, gap: -0.5}]}, {name: "Muted Thud", seq: [{freq:100, type:'triangle', dur:0.2, vol: 0.8}]}, {name: "Static Burst", seq: [{freq:1800, type:'sawtooth', dur:0.05}, {freq:1900, type:'sawtooth', dur:0.05, gap: -0.05}, {freq:1700, type:'sawtooth', dur:0.05, gap: -0.05}]}, {name: "Game Over", seq: [{freq:330, dur:0.2}, {freq:220, dur:0.2}, {freq:110, dur:0.3}]}, {name: "Clank", seq: [{freq:800, type:'square', dur:0.1}, {freq:810, type:'square', dur:0.1, gap: -0.1}]}, {name: "Wrong Synth", seq: [{freq:155, type:'sawtooth', dur:0.4}]}, {name: "Fail Arpeggio", seq: [{freq:523, dur:0.1}, {freq:392, dur:0.1}, {freq:261, dur:0.2}]}, {name: "Rattle", seq: [{freq:900, type:'square', dur:0.02, gap:0.02}, {freq:900, type:'square', dur:0.02, gap:0.02}, {freq:900, type:'square', dur:0.02}]}, {name: "Wrong Chord", seq: [{freq:261.63, dur:0.5}, {freq:311.13, dur:0.5, gap:-0.5}, {freq:369.99, dur:0.5, gap:-0.5}]}, {name: "System Error", seq: [{freq:110, type:'square', dur:0.6}]}, {name: "Mechanical Fail", seq: [{freq:250, type:'sawtooth', dur:0.2}, {freq:240, type:'sawtooth', dur:0.2, gap:-0.2}]}, {name: "Short Circuit", seq: [{freq:1800, type:'square', dur:0.02}, {freq:1850, type:'square', dur:0.02, gap:-0.02}]}, {name: "Deflated", seq: [{freq:500, dur:0.1}, {freq:400, dur:0.1}, {freq:300, dur:0.1}, {freq:200, dur:0.2}]}, {name: "Denied", seq: [{freq:220, dur:0.2, gap:0.1}, {freq:220, dur:0.2}]}, {name: "Alert Beep", seq: [{freq:1000, type:'sawtooth', dur:0.1, gap:0.1}, {freq:1000, type:'sawtooth', dur:0.1}]}, {name: "Low Drone", seq: [{freq:80, dur:0.8}]}, {name: "Scrape", seq: [{freq:600, type:'sawtooth', dur:0.3}, {freq:610, type:'sawtooth', dur:0.3, gap:-0.3}]}, {name: "Bonk", seq: [{freq:150, type:'triangle', dur:0.15, vol:0.9}]}, {name: "Glitchy Signal", seq: [{freq:800, type:'square', dur:0.03}, {freq:400, type:'square', dur:0.03}, {freq:1200, type:'square', dur:0.03}]}, {name: "Sad Beep", seq: [{freq:440, dur:0.3}, {freq:415, dur:0.3, gap:-0.3}]}, {name: "Error Chord", seq: [{freq:440, dur:0.4}, {freq:466, dur:0.4, gap:-0.4}]}, {name: "System Halt", seq: [{freq:100, type:'sawtooth', dur:0.6}]}, {name: "Warning Siren", seq: [{freq:800, dur:0.2, gap:0.1}, {freq:700, dur:0.2}]}, {name: "Interference", seq: [{freq:2500, type:'square', dur:0.2, vol:0.2}, {freq:2550, type:'square', dur:0.2, vol:0.2, gap:-0.2}]}, {name: "Shutdown", seq: [{freq:400, type:'square', dur:0.1}, {freq:300, type:'square', dur:0.1}, {freq:200, type:'square', dur:0.2}]}, {name: "Muted Error", seq: [{freq:120, dur:0.2}]}, {name: "Dissonant Ring", seq: [{freq:1000, dur:0.4}, {freq:1015, dur:0.4, gap:-0.4}]}, {name: "Final Buzz", seq: [{freq:120, type:'square', dur:0.5}]} ];

            /** * SpeechService v6.1 — Patched for fixed Microsoft Natural Online voices and corrected Australian voice */
            class SpeechService {
                constructor() {
                    this.synth = window.speechSynthesis;
                    this.isInitialized = false;
                    this.isTtsEnabled = true;
                    this.voices = [];
                    this.speechRate = 0.85;

                    this.speakerVoiceMap = {
                        'ava':     { names: ['Microsoft Ava Online (Natural) - English (United States)'], lang: 'en-US' },
                        'emma':    { names: ['Microsoft Emma Online (Natural) - English (United States)'], lang: 'en-US' },
                        'brian':   { names: ['Microsoft Brian Online (Natural) - English (United States)'], lang: 'en-US' },
                        'andrew':  { names: ['Microsoft Andrew Online (Natural) - English (United States)'], lang: 'en-US' },
                        'chris':   { names: ['Microsoft Brian Online (Natural) - English (United States)'], lang: 'en-US' },
                        'chen':    { names: ['Microsoft Andrew Online (Natural) - English (United States)'], lang: 'en-US' },
                        'sofia':   { names: ['Microsoft Ava Online (Natural) - English (United States)'], lang: 'en-US' },
                        'lecturer':{ names: ['Microsoft Brian Online (Natural) - English (United States)'], lang: 'en-US' },
                        'professor':{ names: ['Microsoft Andrew Online (Natural) - English (United States)'], lang: 'en-US' },
                        'alex':    { names: ['Microsoft Andrew Online (Natural) - English (United States)'], lang: 'en-US' },
                        'sarah':   { names: ['Microsoft Ava Online (Natural) - English (United States)'], lang: 'en-US' }
                        'david':   { names: ['Microsoft Brian Online (Natural) - English (United States)'], lang: 'en-US' },
                        'leo':     { names: ['Microsoft Andrew Online (Natural) - English (United States)'], lang: 'en-US' },
                        'mia':     { names: ['Microsoft Ava Online (Natural) - English (United States)'], lang: 'en-US' }
                    };
                }

                async _setupVoices() {
                    const voicesPromise = new Promise(resolve => {
                        if (this.synth.getVoices().length) return resolve(this.synth.getVoices());
                        this.synth.onvoiceschanged = () => resolve(this.synth.getVoices());
                    });

                    this.voices = await voicesPromise;
                    if (!this.voices.length) {
                        console.warn("No voices available.");
                        return;
                    }
                    
                    const warmUp = new SpeechSynthesisUtterance(' ');
                    warmUp.volume = 0;
                    this.synth.speak(warmUp);
                    this.synth.cancel();

                    this.isInitialized = true;
                    console.log("Voices loaded and speech engine warmed up:", this.voices.map(v => v.name));
                }

                _getVoiceForSpeaker(speakerName) {
                    if (!speakerName) return null;
                    const key = speakerName.toLowerCase();
                    const entry = this.speakerVoiceMap[key];
                    if (!entry) return null;

                    for (const preferredName of entry.names) {
                        const match = this.voices.find(v => v.name === preferredName);
                        if (match) return match;
                    }
                    return this.voices.find(v => v.lang === entry.lang) || null;
                }

                speak(text, speakerName = null, rate = this.speechRate) {
                    if (!this.isTtsEnabled || !text || !text.trim()) {
                        return;
                    }
                    if (!this.isInitialized) {
                        console.warn("SpeechService not initialized yet.");
                        return;
                    }
                
                    this.synth.cancel();
                
                    const utter = new SpeechSynthesisUtterance(text);
                    utter.rate = rate;
                
                    const finalSpeakerName = speakerName || 'brian';
                    const voice = this._getVoiceForSpeaker(finalSpeakerName);
                
                    if (voice) {
                        utter.voice = voice;
                    } else {
                        utter.voice = this.voices.find(v => v.lang === 'en-US') || this.voices[0];
                        console.warn(`Voice for speaker "${finalSpeakerName}" not found. Using fallback: ${utter.voice?.name}`);
                    }
                
                    utter.onerror = (e) => {
                        if (e.error !== 'canceled') {
                           console.error("SpeechSynthesisUtterance.onerror", e);
                        }
                    };
                    this.synth.speak(utter);
                }

                toggleTts() {
                    this.isTtsEnabled = !this.isTtsEnabled;
                }
            }
            
            async function speakDialogue(text) {
                if (!speechService || !speechService.isInitialized || !speechService.isTtsEnabled || !text) {
                    return;
                }
                
                if (speechService.synth) speechService.synth.cancel();
                await new Promise(resolve => setTimeout(resolve, 150)); 

                const lines = text.split('\n').filter(line => line.trim() !== '');
                const queue = lines.map(line => {
                    const parts = line.split(':');
                    const speaker = parts.length > 1 ? parts[0].trim() : null;
                    const dialogue = (parts.length > 1 ? parts.slice(1).join(':') : line).trim();

                    if (!dialogue) return null;

                    const utter = new SpeechSynthesisUtterance(dialogue);
                    utter.rate = speechService.speechRate;
                    
                    const voice = speechService._getVoiceForSpeaker(speaker);
                    if (voice) {
                        utter.voice = voice;
                    } else {
                        utter.voice = speechService.voices.find(v => v.lang === 'en-US') || speechService.voices[0];
                    }
                    
                    utter.onerror = (e) => {
                        if (e.error !== 'canceled') {
                            console.error('SpeechSynthesisUtterance.onerror (dialogue)', e);
                        }
                    };
                    
                    return utter;
                }).filter(item => item !== null);

                let currentUtteranceIndex = 0;

                const playNext = () => {
                    if (currentUtteranceIndex < queue.length && speechService.isTtsEnabled) {
                        const item = queue[currentUtteranceIndex];
                        item.onend = playNext;
                        speechService.synth.speak(item);
                        currentUtteranceIndex++;
                    }
                };
                playNext();
            }

            window.toggleTTS = (button) => {
                if (!speechService) return;
                speechService.toggleTts();
                const isNowEnabled = speechService.isTtsEnabled;

                const iconPath = isNowEnabled 
                    ? "M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 104.243 4.243M9 12l4.243 4.243"
                    : "M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707a1 1 0 011.414 0v14a1 1 0 01-1.414 0L5.586 15z M17 14l-4-4m0 4l4-4";
                button.querySelector('svg').classList.toggle('text-gray-600', isNowEnabled);
                button.querySelector('svg').classList.toggle('text-gray-400', !isNowEnabled);
                button.querySelector('path').setAttribute('d', iconPath);

                if (isNowEnabled) {
                    const pageData = lessonData.pages.find(p => p.id === currentPage);
                     if(pageData) {
                        if (pageData.type === 'dialogue') {
                            speakDialogue(pageData.content.dialogue);
                        } else {
                            const targetPage = document.getElementById(`page-${currentPage}`);
                            let textToSpeak = '';
                            if (pageData.id === 'reading-main') {
                                const readingContainer = targetPage.querySelector('.space-y-6');
                                if (readingContainer) {
                                    textToSpeak = Array.from(readingContainer.querySelectorAll('h4, p'))
                                        .map(el => el.textContent)
                                        .join(' \n ');
                                }
                            } else { 
                                const readableContent = targetPage.querySelector('.readable-content');
                                const titleElement = targetPage.querySelector('h2, h3');
                                if (readableContent) {
                                    textToSpeak = readableContent.innerHTML;
                                } else if (titleElement) {
                                    textToSpeak = titleElement.innerHTML;
                                }
                            }
                            if (textToSpeak) {
                                speechService.speak(stripHtmlAndEmojis(textToSpeak), 'brian');
                            }
                        }
                    }
                } else {
                    if (speechService.synth) speechService.synth.cancel();
                }
            };
            
            async function initializeAudio() {
                if (audioContext) return;
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    const processorScript = document.getElementById('sequence-processor').textContent;
                    const blob = new Blob([processorScript], { type: 'application/javascript' });
                    const workletURL = URL.createObjectURL(blob);
                    await audioContext.audioWorklet.addModule(workletURL);

                    sequenceNode = new AudioWorkletNode(audioContext, 'sequence-processor');
                    sequenceNode.connect(audioContext.destination);
                    
                    speechService = new SpeechService();
                    await speechService._setupVoices();

                } catch (e) {
                    console.error("Audio/Speech initialization failed:", e);
                }
            }

            const playSound = (isCorrect) => {
                if (!sequenceNode) return;
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                const soundBank = isCorrect ? correctSounds : incorrectSounds;
                const sound = soundBank[Math.floor(Math.random() * soundBank.length)];
                sequenceNode.port.postMessage({
                    type: 'play',
                    sequence: sound.seq
                });
            }

            // --- Background & Completion Animations ---
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            let particles = [];
            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                particles.forEach((p, i) => {
                    p.y -= p.speed;
                    p.x += Math.sin(p.y / 50);
                    if (p.y < -p.radius) particles.splice(i, 1);
                    bgCtx.beginPath();
                    bgCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    bgCtx.globalAlpha = p.opacity;
                    bgCtx.fillStyle = p.color;
                    bgCtx.fill();
                });
                if (Math.random() > 0.97 && particles.length < 100) {
                    particles.push({ x: Math.random() * bgCanvas.width, y: bgCanvas.height + 20, radius: Math.random() * 5 + 2, speed: Math.random() * 2 + 1, color: ['#34d399', '#f59e0b', '#a78bfa'][Math.floor(Math.random() * 3)], opacity: Math.random() * 0.5 + 0.5 });
                }
                requestAnimationFrame(animateBackground);
            }
            window.addEventListener('resize', () => { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; });
            animateBackground();

            function runCompletionAnimation() {
                const canvas = document.getElementById('completion-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
                let fireworks = [], confetti = [];

                function Firework(sx, sy, tx, ty) { this.x = sx; this.y = sy; this.sx = sx; this.sy = sy; this.tx = tx; this.ty = ty; this.distanceToTarget = Math.sqrt(Math.pow(tx - sx, 2) + Math.pow(ty - sy, 2)); this.distanceTraveled = 0; this.angle = Math.atan2(ty - sy, tx - sx); this.speed = 2; this.acceleration = 1.05; this.brightness = Math.random() * 50 + 50; this.targetRadius = 1; this.particles = []; }
                Firework.prototype.update = function(index) { this.speed *= this.acceleration; let vx = Math.cos(this.angle) * this.speed; let vy = Math.sin(this.angle) * this.speed; this.distanceTraveled = Math.sqrt(Math.pow(this.x - this.sx, 2) + Math.pow(this.y - this.sy, 2)); if (this.distanceTraveled >= this.distanceToTarget) { for(let i = 0; i < 30; i++) { this.particles.push(new Particle(this.tx, this.ty)); } fireworks.splice(index, 1); } else { this.x += vx; this.y += vy; } }
                Firework.prototype.draw = function() { ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x - Math.cos(this.angle) * 10, this.y - Math.sin(this.angle) * 10); ctx.strokeStyle = `hsl(${Math.random() * 360}, 100%, ${this.brightness}%)`; ctx.stroke(); }
                function Particle(x, y) { this.x = x; this.y = y; this.angle = Math.random() * Math.PI * 2; this.speed = Math.random() * 10; this.friction = 0.95; this.gravity = 1; this.hue = Math.random() * 360; this.brightness = Math.random() * 50 + 50; this.alpha = 1; this.decay = Math.random() * 0.03 + 0.015; }
                Particle.prototype.update = function(index) { this.speed *= this.friction; this.x += Math.cos(this.angle) * this.speed; this.y += Math.sin(this.angle) * this.speed + this.gravity; this.alpha -= this.decay; if (this.alpha <= this.decay) this.particles.splice(index, 1); }
                Particle.prototype.draw = function() { ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); ctx.fillStyle = `hsla(${this.hue}, 100%, ${this.brightness}%, ${this.alpha})`; ctx.fill(); }
                function Confetti() { this.x = Math.random() * canvas.width; this.y = -20; this.w = 10; this.h = 20; this.speed = Math.random() * 3 + 2; this.gravity = 0.5; this.angle = 0; this.rotation = Math.random() * 0.1 - 0.05; this.color = `hsl(${Math.random() * 360}, 100%, 50%)`; }
                Confetti.prototype.update = function(index) { this.y += this.speed; this.speed += this.gravity; this.angle += this.rotation; if (this.y > canvas.height) confetti.splice(index, 1); }
                Confetti.prototype.draw = function() { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle); ctx.fillStyle = this.color; ctx.fillRect(-this.w / 2, -this.h / 2, this.w, this.h); ctx.restore(); }

                let animationRunning = true;
                function animate() {
                    if (!animationRunning) return;
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.globalCompositeOperation = 'lighter';
                    fireworks.forEach((f, i) => { f.draw(); f.update(i); f.particles.forEach((p, j) => { p.draw(); p.update(j); }); });
                    confetti.forEach((c, i) => { c.draw(); c.update(i); });
                    requestAnimationFrame(animate);
                }
                const interval = setInterval(() => {
                    fireworks.push(new Firework(canvas.width / 2, canvas.height, Math.random() * canvas.width, Math.random() * canvas.height / 2));
                    for(let i = 0; i < 10; i++) confetti.push(new Confetti());
                }, 800);
                setTimeout(() => { clearInterval(interval); setTimeout(() => animationRunning = false, 5000); }, 5000);
                animate();
            }

            // --- APP INITIALIZATION ---
            window.startApp = async function() {
                await initializeAudio();
                navigateTo(lessonData.homePageId);
            }
            
            function startTimer(duration, display, onComplete) {
                let timer = duration;
                const update = () => { display.textContent = `${String(Math.floor(timer/60)).padStart(2,'0')}:${String(timer%60).padStart(2,'0')}`; };
                update();
                timerInterval = setInterval(() => { timer--; update(); if (timer < 0) { clearInterval(timerInterval); if (onComplete) onComplete(); } }, 1000);
            }
            
            function stripHtmlAndEmojis(text) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                return tempDiv.textContent || tempDiv.innerText || "";
            }


            // --- NAVIGATION & PAGE FLOW ---
            window.navigateTo = (pageId) => {
                const targetPage = document.getElementById(`page-${pageId}`);
                if (!targetPage) return console.warn('navigateTo: no page found for id', pageId);
                if (pageId === currentPage) return;
                
                clearInterval(timerInterval);
                if(speechService && speechService.synth) speechService.synth.cancel();

                document.getElementById(`page-${currentPage}`)?.classList.remove('active');
                targetPage.classList.add('active');
                currentPage = pageId;
                if (pageHistory[pageHistory.length - 1] !== currentPage) pageHistory.push(currentPage);
                
                const pageData = lessonData.pages.find(p => p.id === pageId);
                if (!pageData) return;

                if (pageData.type === 'timer') {
                    const timerEl = document.getElementById(pageData.content.timerId);
                    if (timerEl) startTimer(pageData.content.duration, timerEl, goNext);
                } else if (pageData.id === 'final-project-hub') {
                    window.showPhase(1); // Initialize the project hub view
                }

                if (speechService) {
                    if (pageData.type === 'dialogue') {
                        speakDialogue(pageData.content.dialogue);
                    } else {
                        let textToSpeak = '';
                        if (pageData.id === 'reading-main') {
                            const readingContainer = targetPage.querySelector('.space-y-6');
                            if (readingContainer) {
                                textToSpeak = Array.from(readingContainer.querySelectorAll('h4, p'))
                                    .map(el => el.textContent)
                                    .join(' \n ');
                            }
                        } else { 
                            const readableContent = targetPage.querySelector('.readable-content');
                            const titleElement = targetPage.querySelector('h2, h3');
                            if (readableContent) {
                                textToSpeak = readableContent.innerHTML;
                            } else if (titleElement) {
                                textToSpeak = titleElement.innerHTML;
                            }
                        }
                        
                        if (textToSpeak) {
                            speechService.speak(stripHtmlAndEmojis(textToSpeak), 'brian');
                        }

                        if (pageData.type === 'certificate') {
                            runCompletionAnimation();
                        }
                    }
                }


                updateNavButtons();
                window.scrollTo(0, 0);
            }

            window.goNext = () => {
                const currentIndex = pageSequence.indexOf(currentPage);
                if (currentIndex > -1 && currentIndex < pageSequence.length - 1) navigateTo(pageSequence[currentIndex + 1]);
            }
            window.goBack = () => {
                if (pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); }
            }

            function updateNavButtons() {
                const nav = document.getElementById('nav-header');
                if (!nav) return;
                nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
                const backBtn = nav.querySelector('button:first-child');
                backBtn.disabled = pageHistory.length <= 1;
                backBtn.classList.toggle('opacity-50', backBtn.disabled);
                const nextBtn = nav.querySelector('button:last-child');
                const currentIndex = pageSequence.indexOf(currentPage);
                const isLast = currentIndex >= pageSequence.length - 1;
                const isCertificate = currentPage === 'certificate';
                nextBtn.disabled = isLast || currentPage === lessonData.homePageId || isCertificate;
                nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
            }
            
            // --- UI FEEDBACK, BADGES, & SCORE ---
            function showFeedbackMessage(isCorrect) {
                const phrases = isCorrect ? correctPhrases : incorrectPhrases;
                const message = phrases[Math.floor(Math.random() * phrases.length)];
                
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `feedback-toast ${isCorrect ? 'correct' : 'encouraging'}`;
                toast.setAttribute('role', 'status');
                toast.setAttribute('aria-live', 'assertive');
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4500);

                if (speechService) {
                    speechService.speak(message);
                }
            }

            function updateScore(points) {
                score += points;
                document.getElementById('score-display').textContent = score;
            }

            // --- QUIZ LOGIC ---
            window.checkTfngAnswer = function(clickedButton, chosenAnswer, correctAnswer) {
                const buttonContainer = clickedButton.parentElement;
                Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
                const isCorrect = chosenAnswer === correctAnswer;
                showFeedbackMessage(isCorrect);
                
                const feedbackIcon = document.createElement('span');
                feedbackIcon.className = `ml-2 text-xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'}`;
                feedbackIcon.textContent = isCorrect ? '✓' : '✗';
                clickedButton.closest('.question-group').appendChild(feedbackIcon);

                if (isCorrect) {
                    playSound(true);
                    clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-green-500');
                    updateScore(10);
                } else {
                    playSound(false);
                    clickedButton.className = clickedButton.className.replace(/bg-\w+-500/, 'bg-red-600');
                    const correctBtn = Array.from(buttonContainer.children).find(btn => btn.textContent === correctAnswer.charAt(0));
                    if (correctBtn) correctBtn.className = correctBtn.className.replace(/bg-\w+-500/, 'bg-green-500');
                }
            }
            
            window.checkMcqAnswer = function(button, isCorrect) {
                const questionGroup = button.closest('.question-group');
                questionGroup.querySelectorAll('.quiz-option').forEach(opt => opt.disabled = true);
                showFeedbackMessage(isCorrect);

                const feedbackIcon = document.createElement('span');
                feedbackIcon.className = `ml-2 text-xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'}`;
                feedbackIcon.textContent = isCorrect ? '✓' : '✗';
                button.appendChild(feedbackIcon);

                if (isCorrect) {
                    playSound(true);
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-green-500', 'border-green-600', 'text-white');
                    updateScore(10);
                } else {
                    playSound(false);
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-red-500', 'border-red-600', 'text-white');
                    const correctButton = questionGroup.querySelector(".quiz-option[data-correct='true']");
                    if (correctButton) {
                        correctButton.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                        correctButton.classList.add('bg-green-500', 'border-green-600', 'text-white');
                    }
                }
            }

            function initGapFill(pageId) {
                const page = document.getElementById(pageId);
                if (!page) return;
                const gaps = page.querySelectorAll('.gap');
                const words = page.querySelectorAll('.word-bank-word');
                const wordBank = page.querySelector('.word-bank-container');

                words.forEach(word => {
                    word.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', word.dataset.word); setTimeout(() => word.classList.add('opacity-50'), 0); });
                    word.addEventListener('dragend', () => word.classList.remove('opacity-50'));
                    word.addEventListener('click', handleWordClick);
                });

                gaps.forEach(gap => {
                    gap.addEventListener('dragover', e => e.preventDefault());
                    gap.addEventListener('drop', e => handleDrop(e, gap));
                    gap.addEventListener('click', handleGapClick);
                });

                function handleWordClick(e) {
                    const clickedWord = e.currentTarget;
                    if (clickedWord.parentElement.classList.contains('gap')) {
                        clickedWord.parentElement.classList.remove('correct', 'incorrect');
                        wordBank.appendChild(clickedWord);
                        return;
                    }
                    if (selectedWord.element) selectedWord.element.classList.remove('selected');
                    if (selectedWord.element === clickedWord) {
                        selectedWord = { element: null, text: '' };
                    } else {
                        selectedWord = { element: clickedWord, text: clickedWord.dataset.word };
                        clickedWord.classList.add('selected');
                    }
                }

                function handleGapClick(e) {
                    const clickedGap = e.currentTarget;
                    if (!selectedWord.element || clickedGap.children.length > 0) return;
                    const wordElement = selectedWord.element;
                    clickedGap.appendChild(wordElement);
                    wordElement.classList.remove('selected');
                    checkGap(clickedGap);
                    selectedWord = { element: null, text: '' };
                }

                function handleDrop(e, gap) {
                    e.preventDefault();
                    if (gap.children.length > 0) return;
                    const wordText = e.dataTransfer.getData('text/plain');
                    const wordElement = page.querySelector(`.word-bank-word[data-word="${wordText}"]`);
                    if (wordElement) {
                        gap.appendChild(wordElement);
                        checkGap(gap);
                    }
                }

                function checkGap(gap) {
                    const word = gap.querySelector('.word-bank-word');
                    const isCorrect = word && word.dataset.word === gap.dataset.answer;
                    gap.classList.remove('correct', 'incorrect');
                    gap.classList.add(isCorrect ? 'correct' : 'incorrect');
                    if (isCorrect) {
                        playSound(true);
                        updateScore(10);
                        showFeedbackMessage(true);
                        word.draggable = false;
                    } else {
                        playSound(false);
                        showFeedbackMessage(false);
                    }
                }
            }
            
            window.generateCertificate = function() {
                const name = document.getElementById('name-input-cert').value || "Dedicated Learner";
                document.getElementById('certificate-name').textContent = name;
                document.getElementById('certificate-score').textContent = score;
                document.getElementById('certificate-date').textContent = new Date().toLocaleDateString();
                document.getElementById('cert-initial-controls').classList.add('hidden');
                document.getElementById('cert-generated-controls').classList.remove('hidden');
            }

            window.downloadCertificateAsImage = function() {
                const certElement = document.getElementById('certificate-to-print');
                html2canvas(certElement, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'bridging-worlds-certificate.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            }

            // --- DYNAMIC PAGE & QUIZ GENERATION ---
            function createPageElement(id, content) {
                const section = document.createElement('section');
                section.id = `page-${id}`;
                section.className = 'page';
                section.innerHTML = content;
                document.getElementById('dynamic-pages-container').appendChild(section);
            }
            
            function populateQuizzes() {
                // Vocab Match Quiz
                const vocabMatchPage = lessonData.pages.find(p => p.id === 'vocab-match');
                vocabMatchPage.content.questions = lessonData.vocabulary.map((v, i) => {
                    const otherDefs = lessonData.vocabulary.filter((_, idx) => idx !== i).map(item => item.def);
                    const options = [v.def, ...otherDefs.sort(() => 0.5 - Math.random()).slice(0, 3)].sort(() => 0.5 - Math.random());
                    return { question: `What is the definition of "${v.word}"?`, options: options, correctAnswer: v.def };
                });

                // Reading Comprehension Quizzes
                lessonData.pages.find(p => p.id === 'reading-quiz-gap-fill').content.sentences = [
                    { text: ['A bridge for animals that goes over a road is called an', '.'], answer: 'Overpass' }, { text: ['Human', 'like roads and railways can divide natural areas.'], answer: 'Infrastructure' }, { text: ['The variety of life in an area is known as', '.'], answer: 'Biodiversity' }, { text: ['When a forest is cut into separate pieces, it is called habitat', '.'], answer: 'Fragmentation' }, { text: ['Wildlife crossings help humans and animals', 'safely.'], answer: 'Coexistence' }
                ];
                lessonData.pages.find(p => p.id === 'reading-quiz-tfng').content.questions = [
                    { statement: 'Habitat fragmentation helps animals find more food.', correctAnswer: 'False' }, { statement: 'An underpass is a tunnel that goes under a road.', correctAnswer: 'True' }, { statement: 'Wildlife corridors only benefit animals and not humans.', correctAnswer: 'False' }, { statement: 'The design of a wildlife corridor does not need to consider vegetation.', correctAnswer: 'False' }, { statement: 'Wildlife crossings can help reduce car accidents.', correctAnswer: 'True' },
                ];
                lessonData.pages.find(p => p.id === 'reading-quiz-mcq').content.questions = [
                     { question: 'What is the main problem caused by habitat fragmentation?', options: ['Animals have too much space.', 'It isolates animal populations.', 'It makes forests grow too quickly.', 'It creates more food for wildlife.'], correctAnswer: 'It isolates animal populations.' }, { question: 'What is the purpose of a wildlife corridor?', options: ['To create a new park for people.', 'To connect separated habitats.', 'To build new roads faster.', 'To study animals in cages.'], correctAnswer: 'To connect separated habitats.' }, { question: 'According to the text, what is a critical factor for a successful animal bridge?', options: ['Making it out of metal.', 'Painting it bright colors.', 'Its location, width, and vegetation.', 'Building it as quickly as possible.'], correctAnswer: 'Its location, width, and vegetation.' }, { question: 'Which is an example of an animal that might use an underpass?', options: ['A large bear.', 'A bird.', 'A small frog.', 'A giraffe.'], correctAnswer: 'A small frog.' }, { question: 'How do wildlife corridors improve human safety?', options: ['They make roads wider.', 'They reduce wildlife-vehicle collisions.', 'They have streetlights for drivers.', 'They create scenic views from the highway.'], correctAnswer: 'They reduce wildlife-vehicle collisions.' },
                ];
                
                // Listening Quizzes
                lessonData.pages.find(p => p.id === 'lecture-coexistence-quiz-mcq').content.questions = [
                    { question: 'What is a major threat to biodiversity mentioned by the professor?', options: ['Climate change', 'Habitat fragmentation', 'Pollution', 'Lack of food'], correctAnswer: 'Habitat fragmentation' }, { question: 'What is a human benefit of wildlife corridors mentioned by David?', options: ['Increased property values', 'More tourism', 'Reduction in vehicle collisions', 'Quieter highways'], correctAnswer: 'Reduction in vehicle collisions' }, { question: 'Which of these is NOT mentioned by Sarah as a key design consideration?', options: ['Width of the corridor', 'Type of vegetation', 'Minimizing noise', 'The color of the bridge'], correctAnswer: 'The color of the bridge' }, { question: 'What does Sarah say habitat fragmentation leads to?', options: ['Animals becoming smarter', 'Reduced genetic diversity', 'An increase in animal populations', 'Cleaner air'], correctAnswer: 'Reduced genetic diversity' }, { question: 'What is the main purpose of wildlife corridors?', options: ['To create zoos', 'To reconnect fragmented habitats', 'To make roads wider', 'To provide a place for people to walk'], correctAnswer: 'To reconnect fragmented habitats' }
                ];
                lessonData.pages.find(p => p.id === 'lecture-coexistence-quiz-tfng').content.questions = [
                    { statement: "Habitat fragmentation makes it easier for animals to find mates.", correctAnswer: 'False' }, { statement: "Wildlife corridors can be both overpasses and underpasses.", correctAnswer: 'True' }, { statement: "The professor believes there are no benefits for humans from wildlife corridors.", correctAnswer: 'False' }, { statement: "The lecture suggests that the location of a corridor is not very important.", correctAnswer: 'False' }, { statement: "The speakers agree that wildlife corridors are a vital solution for conservation.", correctAnswer: 'True' }
                ];
                lessonData.pages.find(p => p.id === 'lecture-coexistence-quiz-gap-fill').content.sentences = [
                    { text: ['Habitat fragmentation breaks up large natural areas into smaller, isolated', '.'], answer: 'patches' }, { text: ['Wildlife corridors provide safe', 'for animals to travel.'], answer: 'pathways' }, { text: ['Reduced genetic', 'is a consequence of isolated populations.'], answer: 'diversity' }, { text: ['The width of the corridor and type of', 'are important design factors.'], answer: 'vegetation' }, { text: ['Wildlife corridors improve human', 'by reducing accidents.'], answer: 'safety' }
                ];

                lessonData.pages.find(p => p.id === 'podcast-biodiversity-quiz-mcq').content.questions = [
                    { question: 'What does Sarah say is key to designing infrastructure for coexistence?', options: ['Using the cheapest materials', 'Smart, data-driven design', 'Building as quickly as possible', 'Ignoring animal movement'], correctAnswer: 'Smart, data-driven design' }, { question: 'What is a huge driver for building wildlife crossings from a transportation perspective?', options: ['Reducing vehicle collisions', 'Increasing speed limits', 'Making roads prettier', 'Creating tolls'], correctAnswer: 'Reducing vehicle collisions' }, { question: 'What does Chris say is a challenge for monitoring the success of a corridor?', options: ['The animals are too fast', 'The cameras are too expensive', 'Tracking if animals are using it effectively', 'The weather is too unpredictable'], correctAnswer: 'Tracking if animals are using it effectively' }, { question: 'What innovative idea does Sarah propose for building crossings in different environments?', options: ['A modular system', 'Using only one type of bridge', 'Building them only at night', 'Asking volunteers to build them'], correctAnswer: 'A modular system' }, { question: 'What is the ultimate goal of the engineering project discussed?', options: ['To make money for the engineers', 'To build the biggest bridge in the world', 'To support, rather than hinder, biodiversity', 'To stop all animals from crossing roads'], correctAnswer: 'To support, rather than hinder, biodiversity' }
                ];
                lessonData.pages.find(p => p.id === 'podcast-biodiversity-quiz-tfng').content.questions = [
                    { statement: "Chris is a civil engineer from Sydney.", correctAnswer: 'True' }, { statement: "The speakers agree that the width of a corridor does not matter.", correctAnswer: 'False' }, { statement: "Alex suggests that noise from traffic does not affect wildlife.", correctAnswer: 'False' }, { statement: "Native vegetation is considered key for a successful corridor.", correctAnswer: 'True' }, { statement: "The speakers conclude that a modular design for crossings is not a good idea.", correctAnswer: 'False' }
                ];
                lessonData.pages.find(p => p.id === 'podcast-biodiversity-quiz-gap-fill').content.sentences = [
                    { text: ['The speakers are discussing how to design infrastructure that allows humans and wildlife to', '.'], answer: 'coexist' }, { text: ['Sarah says ecological', 'are required to understand animal movement patterns.'], answer: 'surveys' }, { text: ['Alex mentions that', 'can be used to reduce traffic noise.'], answer: 'noise barriers' }, { text: ['Alex prioritizes structural', 'and safety for vehicles below a wildlife bridge.'], answer: 'integrity' }, { text: ['A modular design would make solutions more', 'and cost-effective.'], answer: 'scalable' }
                ];

                lessonData.pages.find(p => p.id === 'dilemma-solar-farm-quiz-mcq').content.questions = [
                    { question: 'What is Emma’s main reason for choosing Location A?', options: ['It is cheaper to build there', 'It is closer to the power grid', 'It is sacred land with cultural significance', 'It has better sunlight exposure'], correctAnswer: 'It is sacred land with cultural significance' }, { question: 'What does Sarah say about the 5,000 people in the rural town?', options: ['They can easily relocate', 'Their livelihoods would be devastated', 'They support the solar farm', 'They are not aware of the project'], correctAnswer: 'Their livelihoods would be devastated' }, { question: 'What ethical principle does Emma emphasize?', options: ['Economic growth', 'Cultural preservation and non-removal', 'Technological innovation', 'Majority rule'], correctAnswer: 'Cultural preservation and non-removal' }, { question: 'What alternative does David suggest?', options: ['Building on both sites', 'Delaying the project', 'Using smaller, distributed solar projects', 'Asking the government to decide'], correctAnswer: 'Using smaller, distributed solar projects' }, { question: 'What does the group agree on at the end?', options: ['Location A is the best choice', 'There is no perfect solution', 'The farmland should be protected', 'The indigenous community should be relocated'], correctAnswer: 'There is no perfect solution' }
                ];
                lessonData.pages.find(p => p.id === 'dilemma-solar-farm-quiz-tfng').content.questions = [
                    { statement: "Sarah is from Los Angeles, California.", correctAnswer: 'True' }, { statement: "David believes the farmland is more important than the sacred land.", correctAnswer: 'True' }, { statement: "Emma says the indigenous community has already agreed to relocate.", correctAnswer: 'False' }, { statement: "The group discusses the possibility of negotiating with both communities.", correctAnswer: 'True' }, { statement: "Dr. Chen is present during the discussion.", correctAnswer: 'False' }
                ];
                lessonData.pages.find(p => p.id === 'dilemma-solar-farm-quiz-gap-fill').content.sentences = [
                    { text: ['David describes the dilemma as a conflict between utilitarian and', 'ethics.'], answer: 'deontological' }, { text: ['Emma argues that the sacred land is', 'because of its cultural and historical value.'], answer: 'irreplaceable' }, { text: ['Sarah believes that losing the farmland would be devastating to the rural town’s', '.'], answer: 'livelihoods' }, { text: ['Emma refers to the trauma of the', 'Generations as a real-world example.'], answer: 'Stolen' }, { text: ['David suggests exploring smaller, distributed solar projects to reduce the massive', '.'], answer: 'footprint' }
                ];

                lessonData.pages.find(p => p.id === 'dilemma-wind-farm-quiz-mcq').content.questions = [
                    { question: 'What is Emma’s main concern about investing in the wind farm?', options: ['The wind farm is not reliable', 'Her town might be exploited financially', 'The technology is too new', 'The energy is not clean'], correctAnswer: 'Her town might be exploited financially' }, { question: 'What does Sarah say about not investing at all?', options: ['It will delay the project', 'It will cause pollution and blackouts', 'It will save money', 'It will improve trust'], correctAnswer: 'It will cause pollution and blackouts' }, { question: 'What solution does David propose to build trust between towns?', options: ['A public debate', 'A third-party mediator', 'A government subsidy', 'A shared energy contract'], correctAnswer: 'A third-party mediator' }, { question: 'What strategy does David mention that Dr. Chen suggested?', options: ['Phased investment', 'Legal action', 'Advertising campaign', 'Price matching'], correctAnswer: 'Phased investment' }, { question: 'What does the group agree on at the end of the discussion?', options: ['The wind farm should be canceled', 'There is no easy answer', 'The other town should pay more', 'The old power source is better'], correctAnswer: 'There is no easy answer' }
                ];
                lessonData.pages.find(p => p.id === 'dilemma-wind-farm-quiz-tfng').content.questions = [
                    { statement: "Sarah is from Los Angeles, California.", correctAnswer: 'True' }, { statement: "David believes both towns should invest in the wind farm.", correctAnswer: 'True' }, { statement: "Emma says her town has already invested in the wind farm.", correctAnswer: 'False' }, { statement: "The group discusses using a mediator to ensure fairness.", correctAnswer: 'True' }, { statement: "Dr. Chen is present during the discussion.", correctAnswer: 'False' }
                ];
                lessonData.pages.find(p => p.id === 'dilemma-wind-farm-quiz-gap-fill').content.sentences = [
                    { text: ['David describes the situation as a classic', 'action problem.'], answer: 'collective' }, { text: ['Emma worries that her town might be', 'if the other town doesn’t invest.'], answer: 'exploited' }, { text: ['Sarah says relying on old power sources is increasingly', '.'], answer: 'unsustainable' }, { text: ['Emma says the issue is not just about energy, but also about her town’s', '.'], answer: 'finances' }, { text: ['David suggests involving a third-party', 'to ensure fairness.'], answer: 'mediator' }
                ];
            }

            function initializeLesson() {
                document.getElementById('main-title').innerHTML = lessonData.title;
                document.getElementById('main-subtitle').innerHTML = lessonData.subtitle;
                document.getElementById('main-svg-container').innerHTML = `<svg viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:rgb(22, 163, 74);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(163, 126, 96);stop-opacity:1" /></linearGradient></defs><rect width="600" height="300" fill="#f0fdf4"/><path d="M0 200 C 150 100, 450 100, 600 200" stroke="#a3e635" stroke-width="80" fill="none" /><path d="M250 200 C 275 170, 325 170, 350 200" stroke="#78716c" stroke-width="20" fill="none" stroke-linecap="round" /><text x="50%" y="45%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="48" fill="#14532d" font-weight="bold">Bridging Worlds <tspan aria-hidden="true">🌉</tspan></text></svg>`;

                populateQuizzes();

                const menuButtons = lessonData.mainMenu.map(item => {
                    const colors = { green: 'bg-green-500 border-green-700', blue: 'bg-blue-500 border-blue-700', sky: 'bg-sky-500 border-sky-700', amber: 'bg-amber-500 border-amber-700', rose: 'bg-rose-500 border-rose-700', violet: 'bg-violet-500 border-violet-700', teal: 'bg-teal-500 border-teal-700', orange: 'bg-orange-500 border-orange-700', indigo: 'bg-indigo-500 border-indigo-700', lime: 'bg-lime-500 border-lime-700', emerald: 'bg-emerald-500 border-emerald-700', red: 'bg-red-500 border-red-700', purple: 'bg-purple-500 border-purple-700' };
                    return `<button onclick="navigateTo('${item.target}')" class="btn-animated-3d ${colors[item.color] || colors['green']} text-white font-bold text-xl p-4 rounded-xl">${item.text}</button>`;
                }).join('');
                createPageElement(lessonData.homePageId, `<div class="bg-white rounded-2xl shadow-lg p-8"><h2 class="text-4xl font-bold text-center text-green-800 mb-8">Main Menu</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4">${menuButtons}</div></div>`);
                
                // Build the master page sequence for next/back buttons
                pageSequence = [lessonData.startPageId, lessonData.homePageId];
                const menuOrder = lessonData.mainMenu.map(item => item.target);
                const pageOrderMap = {
                    'tps-start': ['tps-think', 'tps-pair', 'tps-share'],
                    'warm-up': ['vocab-start'],
                    'vocab-start': lessonData.vocabulary.map((v, i) => `vocab-${i}`),
                    'reading-main': ['reading-quiz-gap-fill', 'reading-quiz-tfng', 'reading-quiz-mcq'],
                    'lecture-coexistence': ['lecture-coexistence-quiz-mcq', 'lecture-coexistence-quiz-tfng', 'lecture-coexistence-quiz-gap-fill'],
                    'podcast-biodiversity': ['podcast-biodiversity-quiz-mcq', 'podcast-biodiversity-quiz-tfng', 'podcast-biodiversity-quiz-gap-fill'],
                    'dilemma-solar-farm': ['dilemma-solar-farm-quiz-mcq', 'dilemma-solar-farm-quiz-tfng', 'dilemma-solar-farm-quiz-gap-fill'],
                    'dilemma-wind-farm': ['dilemma-wind-farm-quiz-mcq', 'dilemma-wind-farm-quiz-tfng', 'dilemma-wind-farm-quiz-gap-fill'],
                    'thinking-prompts': ['exam-practice'],
                    'final-project-hub': ['writing-task', 'self-assessment', 'certificate']
                };
                 // Add the vocab quiz after the last vocab card
                pageOrderMap[`vocab-${lessonData.vocabulary.length - 1}`] = ['vocab-match'];

                menuOrder.forEach(startId => {
                    let queue = [startId];
                    let visited = new Set([startId]);
                    while(queue.length > 0) {
                        let current = queue.shift();
                        if (!pageSequence.includes(current)) {
                            pageSequence.push(current);
                        }
                        if (pageOrderMap[current]) {
                            pageOrderMap[current].forEach(next => {
                                if (!visited.has(next)) {
                                    queue.push(next);
                                    visited.add(next);
                                }
                            });
                        }
                    }
                });

                lessonData.vocabulary.forEach((v, i) => {
                    createPageElement(`vocab-${i}`, `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h3 class="text-2xl font-bold text-sky-600 mb-2">Vocabulary ${i + 1} / ${lessonData.vocabulary.length}</h3><div class="my-8"><h2 class="text-5xl font-bold text-gray-800 mb-4">${v.word}</h2><p class="text-2xl text-gray-600 mb-4">${v.def}</p><p class="text-xl text-gray-500 italic">"${v.sentence}"</p></div></div></div>`);
                });

                lessonData.pages.forEach(page => {
                    let pageHTML = '';
                    switch (page.type) {
                        case 'simple':
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-gray-800 mb-6">${page.content.title}</h2><p class="text-xl text-gray-600 mb-8">${page.content.text}</p></div></div>`;
                            break;
                        case 'timer':
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col justify-center text-left pt-16"><div class="w-full flex justify-between items-center mb-4"><h2 class="text-2xl md:text-3xl font-bold text-green-700">${page.content.title}</h2><div id="${page.content.timerId}" class="text-3xl md:text-4xl font-bold text-gray-700 ml-4"></div></div><div class="readable-content"><p class="text-lg md:text-xl text-gray-600 mt-8">${page.content.text}</p></div></div>`;
                            break;
                        case 'dialogue':
                        case 'lecture':
                        case 'html-content':
                            const titleColor = { 'dialogue': 'text-orange-700', 'lecture': 'text-amber-700', 'html-content': 'text-rose-700' }[page.type] || 'text-gray-800';
                            const contentHTML = page.type === 'html-content' ? page.content.html : (page.content.dialogue || '').split('\n\n').map(line => {
                                const [speaker, ...rest] = line.split(':');
                                return `<p><strong class="text-green-700">${speaker}:</strong>${rest.join(':')}</p>`
                            }).join('');
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h2 class="text-4xl font-bold text-center ${titleColor} mb-6">${page.content.title}</h2><div class="readable-content text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg max-h-[70vh] overflow-y-auto">${contentHTML}</div></div>`;
                            break;
                        case 'quiz-tfng':
                        case 'quiz-mcq':
                        case 'quiz-gap-fill':
                            let questionsHTML = '';
                            if (page.type === 'quiz-tfng') {
                                questionsHTML = page.content.questions.map((q, index) => {
                                    const buttonsHTML = ['True', 'False', 'Not Given'].map(label => `<button onclick="checkTfngAnswer(this, '${label}', '${q.correctAnswer}')" class="tfng-button bg-${label === 'True' ? 'blue' : label === 'False' ? 'red' : 'gray'}-500 text-white font-bold w-12 h-10 rounded-full">${label.charAt(0)}</button>`).join('');
                                    return `<div class="question-group flex items-center gap-4 p-4 rounded-lg bg-gray-100"><div class="button-container flex-shrink-0 flex gap-2">${buttonsHTML}</div><p>${index + 1}. ${q.statement}</p></div>`;
                                }).join('');
                            } else if (page.type === 'quiz-mcq') {
                                questionsHTML = page.content.questions.map((q, index) => {
                                    const optionsHTML = q.options.map(opt => `<button onclick="checkMcqAnswer(this, ${opt === q.correctAnswer})" data-correct="${opt === q.correctAnswer}" class="quiz-option p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 border border-gray-200">${opt}</button>`).join('');
                                    return `<div class="question-group ${index > 0 ? 'border-t pt-6' : ''}"><p class="font-semibold mb-2">${index + 1}. ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-2">${optionsHTML}</div></div>`;
                                }).join('');
                            } else if (page.type === 'quiz-gap-fill') {
                                const words = page.content.sentences.map(s => s.answer).sort(() => Math.random() - 0.5);
                                const gapFillHTML = page.content.sentences.map((s, i) => `<p class="text-lg mb-4">${i + 1}. ${s.text[0]} <span class="gap" data-answer="${s.answer}"></span> ${s.text[1]}</p>`).join('');
                                const wordBankHTML = words.map(w => `<div class="word-bank-word" draggable="true" data-word="${w}">${w}</div>`).join('');
                                questionsHTML = `<div class="gap-fill-container">${gapFillHTML}</div><div class="word-bank-container mt-8 p-4 bg-gray-100 rounded-lg flex flex-wrap gap-4 justify-center">${wordBankHTML}</div>`;
                            }
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><h3 class="text-3xl font-bold text-pink-600 mb-6 text-center">${page.content.title}</h3><div class="space-y-6">${questionsHTML}</div></div>`;
                            break;
                        case 'writing-task':
                            const startersHTML = page.content.starters.map(s => `<li class="text-gray-500">${s}</li>`).join('');
                            const wordBankHTML = page.content.wordBank ? `<div class="mt-6"><h4 class="font-bold text-lg text-indigo-600">Word Bank:</h4><div class="flex flex-wrap gap-2 mt-2 p-4 bg-gray-100 rounded-lg">${page.content.wordBank.map(w => `<span class="bg-white px-2 py-1 rounded-md shadow-sm text-gray-700">${w}</span>`).join('')}</div></div>` : '';
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 pt-16"><div class="readable-content"><h2 class="text-4xl font-bold text-center text-indigo-700 mb-6">${page.content.title}</h2><div class="text-lg leading-relaxed space-y-4 bg-gray-50 p-6 rounded-lg"><h3 class="font-bold text-xl text-indigo-600">Prompt:</h3><p>${page.content.prompt}</p><h3 class="font-bold text-xl text-indigo-600 mt-4">Sentence Starters:</h3><ul class="list-disc list-inside ml-4">${startersHTML}</ul>${wordBankHTML}</div></div><div class="text-center mt-6"><button onclick="goNext()" class="action-button bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-xl hover:bg-blue-700">Continue to Final Reflection</button></div></div>`;
                            break;
                        case 'certificate':
                            pageHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center pt-16 relative overflow-hidden"><canvas id="completion-canvas"></canvas><div class="relative z-10"><div class="readable-content"><h2 class="text-4xl font-bold text-amber-600 mb-4">${page.content.title}</h2><p class="text-xl text-gray-600 mb-6">${page.content.text}</p></div><div id="certificate-to-print" class="bg-green-50 border-4 border-dashed border-green-300 rounded-lg p-8 max-w-2xl mx-auto"><div class="flex justify-center mb-4"><span class="text-6xl">🌉</span></div><h3 class="text-3xl font-bold text-green-800">${page.content.certificateTitle}</h3><p class="mt-4 text-lg">This certificate is awarded to</p><p id="certificate-name" class="text-2xl font-bold text-green-600 my-2 border-b-2 border-gray-400 pb-2">[Enter Your Name Here]</p><p class="mt-4 text-lg">for successfully completing this lesson.</p><p class="mt-6 text-md"><strong>Final Score:</strong> <span id="certificate-score" class="font-bold"></span> points</p><p class="text-sm mt-1"><strong>Date of Completion:</strong> <span id="certificate-date"></span></p></div><div id="cert-controls" class="mt-6"><div id="cert-initial-controls"><input type="text" id="name-input-cert" placeholder="Enter your name for the certificate" class="text-center p-2 border rounded-lg w-full max-w-md"><button onclick="generateCertificate()" class="action-button mt-4 bg-green-600 text-white font-bold py-2 px-6 rounded-full hover:bg-green-700">Generate Certificate</button></div><div id="cert-generated-controls" class="hidden mt-4 flex flex-wrap justify-center gap-4"><button onclick="downloadCertificateAsImage()" class="action-button bg-blue-600 text-white font-bold py-2 px-4 rounded-full text-sm">Download Image</button></div></div></div></div>`;
                            break;
                    }
                    if (pageHTML) {
                        createPageElement(page.id, pageHTML);
                        if (page.type === 'quiz-gap-fill') {
                            initGapFill(`page-${page.id}`);
                        }
                    }
                });
                
                updateNavButtons();
            }

            initializeLesson();
            
            document.getElementById('keywordModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
