<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bridging Worlds: Animal Crossings and Biodiversity</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåâ</text></svg>">
    <!-- NOTE: For development the CDN is convenient. For production follow the Tailwind build steps I provided earlier and replace the script with a compiled CSS link. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        @keyframes slowColorChange {
            0% { background-color: #166534; } /* Green */
            25% { background-color: #5d4037; } /* Brown */
            50% { background-color: #15803d; } /* Darker Green */
            75% { background-color: #5d4037; } /* Brown */
            100% { background-color: #166534; } /* Green */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            animation: slowColorChange 240s linear infinite;
            padding-top: 70px; /* Add padding to prevent nav overlap */
        }
        #background-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .page { display: none; position: relative; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-button, .nav-button, .quiz-option, .tfng-button, .word-bank-word, .btn-animated-3d {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -2px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.02);
            border: none;
        }
        .action-button:hover, .nav-button:hover, .quiz-option:hover:not(:disabled), .tfng-button:hover:not(:disabled), .word-bank-word:hover, .btn-animated-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.1), inset 0 -4px 0 0 rgba(0,0,0,0.02);
        }
        .action-button:active, .nav-button:active, .quiz-option:active, .tfng-button:active, .btn-animated-3d:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px -1px rgba(0,0,0,0.2), 0 1px 2px -2px rgba(0,0,0,0.1), inset 0 -2px 0 0 rgba(0,0,0,0.02);
        }

        .action-button:focus-visible, .nav-button:focus-visible, .quiz-option:focus-visible, .tfng-button:focus-visible, .word-bank-word:focus-visible, .btn-animated-3d:focus-visible {
            outline: 3px solid #60a5fa; /* A nice blue outline */
            outline-offset: 2px;
        }

        /* Gap Fill Styles */
        .gap-fill-container .gap {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; height: 44px; padding: 0 4px;
            border: 2px dashed #9ca3af; border-radius: 8px; margin: 0 4px;
            vertical-align: middle; background-color: #f3f4f6;
        }
        .word-bank-word {
            cursor: grab; padding: 8px 16px; border-radius: 8px;
            background-color: white; user-select: none;
        }
        .word-bank-word.selected { outline: 2px solid #6366f1; transform: scale(1.05); }
        .gap .word-bank-word { cursor: pointer; }
        .gap.correct .word-bank-word { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .gap.incorrect .word-bank-word { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* Feedback Message & Badge Notification */
        .feedback-toast, .badge-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 9999px; color: white;
            font-weight: bold; z-index: 200;
            animation: slideUpFadeIn 0.5s ease-out, slideDownFadeOut 0.5s ease-in 3.5s forwards;
        }
        .feedback-toast.correct { background-color: #22c55e; }
        .feedback-toast.encouraging { background-color: #f59e0b; }
        .badge-toast { background: linear-gradient(45deg, #fde047, #f97316); }
        @keyframes slideUpFadeIn { from { opacity: 0; bottom: 0; } to { opacity: 1; bottom: 20px; } }
        @keyframes slideDownFadeOut { from { opacity: 1; bottom: 20px; } to { opacity: 0; bottom: 0; } }

        /* Certificate Canvas */
        #completion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* Final Project Hub Styles */
        .phase-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .phase-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .keyword-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .keyword-item:hover {
            transform: scale(1.02);
            background-color: #f0f9ff;
        }
        .rooftop-animation {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #certificate-to-print, #certificate-to-print * { visibility: visible; }
            #certificate-to-print { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="antialiased text-gray-800 text-lg">
    <canvas id="background-canvas"></canvas>

    <header id="nav-header" class="fixed top-0 left-0 right-0 z-50 p-2" style="display: none;">
        <div class="max-w-sm mx-auto p-1.5 flex justify-center items-center gap-2 bg-white/90 backdrop-blur-sm shadow-lg rounded-full">
            <button onclick="goBack()" class="nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-full" aria-label="Back">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div class="font-bold text-base text-green-600 px-3">Score: <span id="score-display" aria-live="polite">0</span></div>
            <button onclick="navigateTo('main-menu')" class="nav-button bg-gray-800 text-white font-bold p-2 rounded-full hover:bg-gray-900" aria-label="Home">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"></path></svg>
            </button>
            <button onclick="toggleTTS(this)" class="nav-button p-2 rounded-full hover:bg-gray-200" title="Toggle Sound" aria-pressed="false">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5v14l8-7-8-7z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
            </button>
            <button onclick="goNext()" class="nav-button bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-full" aria-label="Next">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </header>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <section id="page-title-screen" class="page active text-center bg-white rounded-2xl shadow-lg p-8">
            <div class="h-full flex flex-col justify-center items-center">
                <h1 id="main-title" class="text-5xl md:text-6xl font-bold text-green-800 mb-4">Bridging Worlds</h1>
                <p id="main-subtitle" class="text-xl md:text-2xl text-gray-600 mb-8">Animal Crossings and Biodiversity <span aria-hidden="true">üåâüêæ</span></p>
                <div id="main-svg-container" class="rounded-lg shadow-md mb-8 w-full max-w-lg mx-auto">
                    <svg viewBox="0 0 200 80" class="w-full h-40" preserveAspectRatio="xMidYMid meet">
                        <rect x="0" y="40" width="200" height="40" fill="#6ee7b7" rx="6"></rect>
                        <rect x="20" y="20" width="60" height="20" fill="#8b5cf6" rx="4"></rect>
                        <rect x="120" y="10" width="60" height="30" fill="#f97316" rx="4"></rect>
                        <text x="100" y="32" fill="#fff" font-size="10" text-anchor="middle">Wildlife Bridge</text>
                    </svg>
                </div>
                <button onclick="startApp()" class="action-button bg-green-600 text-white font-bold py-3 px-8 rounded-full text-2xl hover:bg-green-700">START LESSON</button>
            </div>
        </section>
        <div id="dynamic-pages-container"></div>
    </div>
    
    <!-- Keyword Modal -->
    <div id="keywordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4" role="dialog" aria-modal="true">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl" aria-label="Close">&times;</button>
                </div>
                <p id="modalContent" class="text-gray-700 leading-relaxed"></p>
            </div>
        </div>
    </div>

    <!-- AudioWorklet inline processor -->
    <script id="sequence-processor" type="worklet-script">
        class SequenceProcessor extends AudioWorkletProcessor {
            constructor() {
                super();
                this._sequence = [];
                this._currentNoteIndex = 0;
                this._samplesUntilNextStep = 0;
                this._isPlaying = false;
                this.port.onmessage = (event) => {
                    if (event.data && event.data.type === 'play') {
                        this._sequence = event.data.sequence || [];
                        this._currentNoteIndex = 0;
                        this._samplesUntilNextStep = 0;
                        this._isPlaying = true;
                    }
                };
            }
            process(inputs, outputs, parameters) {
                const output = outputs[0];
                if (!this._isPlaying) return true;
                for (let i = 0; i < (output && output[0] ? output[0].length : 128); i++) {
                    if (this._samplesUntilNextStep <= 0 && this._currentNoteIndex < this._sequence.length) {
                        const note = this._sequence[this._currentNoteIndex];
                        this.port.postMessage({
                            type: 'noteOn',
                            freq: note.freq,
                            dur: note.dur || 0.3,
                            vol: note.vol || 0.5,
                            waveType: note.type || 'sine'
                        });
                        const gap = note.gap || note.dur || 0.3;
                        this._samplesUntilNextStep = gap * sampleRate;
                        this._currentNoteIndex++;
                    }
                    this._samplesUntilNextStep--;
                }
                if (this._currentNoteIndex >= this._sequence.length && this._samplesUntilNextStep < -sampleRate) {
                    this._isPlaying = false;
                }
                return true;
            }
        }
        registerProcessor('sequence-processor', SequenceProcessor);
    </script>


    <script>
        // ===================================================================================
        // --- LESSON CONTENT CONFIGURATION ---
        // ===================================================================================
        const lessonData = {
            title: "Bridging Worlds",
            subtitle: "Animal Crossings and Biodiversity <span aria-hidden='true'>üåâüêæ</span>",
            startPageId: 'title-screen',
            homePageId: 'main-menu',
            mainMenu: [
                { id: 'menu-tps', text: 'Think-Pair-Share <span aria-hidden="true">üß†</span>', color: 'green', target: 'tps-start' },
                { id: 'menu-goals', text: 'Learning Goals <span aria-hidden="true">üéØ</span>', color: 'teal', target: 'learning-goals' },
                { id: 'menu-warmup', text: 'Warm-Up & Vocab <span aria-hidden="true">üìö</span>', color: 'sky', target: 'warm-up' },
                { id: 'menu-reading', text: 'Reading: A Safe Path <span aria-hidden="true">üìñ</span>', color: 'blue', target: 'reading-main' },
                { id: 'menu-convo', text: 'Conversation Practice <span aria-hidden="true">üó£Ô∏è</span>', color: 'indigo', target: 'conversation-practice' },
                { id: 'menu-lecture1', text: 'Listening: Engineering for Coexistence <span aria-hidden="true">üßë‚Äçüî¨</span>', color: 'amber', target: 'lecture-coexistence' },
                { id: 'menu-podcast1', text: 'Listening: A Conversation <span aria-hidden="true">üéß</span>', color: 'lime', target: 'podcast-biodiversity' },
                { id: 'menu-dilemma-solar', text: 'Dilemma: Solar Farm <span aria-hidden="true">ü§î</span>', color: 'rose', target: 'dilemma-solar-farm' },
                { id: 'menu-dilemma-wind', text: 'Dilemma: Wind Farm <span aria-hidden="true">‚ö†Ô∏è</span>', color: 'red', target: 'dilemma-wind-farm' },
                { id: 'menu-thinking', text: 'Thinking & Exam Prep <span aria-hidden="true">üìù</span>', color: 'purple', target: 'thinking-prompts' },
                { id: 'menu-final', text: 'Final Project <span aria-hidden="true">‚úçÔ∏è</span>', color: 'violet', target: 'final-project-hub' },
            ],
            badges: {
                'STREAK_5': { name: 'Hot Streak', icon: 'üî•', description: '5 correct answers in a row' },
                'PERFECT_LEVEL': { name: 'Flawless', icon: 'üíé', description: 'Complete a level with no mistakes' },
                'GAME_COMPLETE': { name: 'Conservation Champion', icon: 'üèÜ', description: 'Complete all challenges' },
            },
            vocabulary: [
                { word: 'Habitat', def: 'The natural home or environment of an animal or plant.', sentence: 'The forest provides a perfect habitat for deer and wild birds.' },
                { word: 'Fragmentation', def: 'The process of being broken into smaller or separate parts.', sentence: 'Roads cause habitat fragmentation, which isolates animal populations.' },
                { word: 'Corridor', def: 'A strip of land that connects two or more larger areas of similar habitat.', sentence: 'A wildlife corridor allows animals to move safely between forests.' },
                { word: 'Biodiversity', def: 'The variety of plant and animal life in a particular habitat.', sentence: 'Protecting biodiversity is essential for a healthy planet.' },
                { word: 'Coexistence', def: 'The state of living or existing at the same time or in the same place.', sentence: 'Animal bridges help promote coexistence between humans and wildlife.' },
                { word: 'Infrastructure', def: 'Basic physical systems like roads, bridges, and power supplies.', sentence: 'New infrastructure projects must consider their environmental impact.' },
                { word: 'Migration', def: 'Seasonal movement of animals from one region to another.', sentence: 'The bridge helps animals during their annual migration to find food.' },
                { word: 'Overpass', def: 'A bridge by which a road or railway line passes over another.', sentence: 'An animal overpass is a bridge built specifically for wildlife.' },
                { word: 'Underpass', def: 'A road or tunnel that passes under another road or a railway.', sentence: 'Smaller animals like frogs and badgers often prefer to use an underpass.' },
                { word: 'Conservation', def: 'The protection of animals, plants, and natural resources.', sentence: 'Wildlife conservation is the main goal of this project.' }
            ],
            pages: [
                // Think Pair Share
                { id: 'tps-start', type: 'simple', content: { title: 'Activity: Think-Pair-Share üß†', text: 'Let\'s brainstorm about our local environment.' } },
                { id: 'tps-think', type: 'timer', content: { title: 'Think ü§î', text: 'Have you ever seen an animal (other than a bird) trying to cross a busy road? What happened? What were the dangers?', duration: 60, timerId: 'tps-think-timer' } },
                { id: 'tps-pair', type: 'timer', content: { title: 'Pair üë•', text: 'Pair with a colleague. Look at a map of your city. Where are the green spaces?', duration: 90, timerId: 'tps-pair-timer' } },
                { id: 'tps-share', type: 'timer', content: { title: 'Share üó£Ô∏è', text: 'Share some ideas with your group.', duration: 120, timerId: 'tps-share-timer' } },
                
                // STAGE 1 & 2
                { id: 'learning-goals', type: 'html-content', content: { title: 'Stage 1: Desired Results üéØ', html: `
                        <p><strong class="text-rose-600">Topic:</strong> Animal Bridges and Wildlife Corridors</p>
                        <p><strong class="text-rose-600">Theme:</strong> Human-Wildlife Coexistence and Conservation Engineering</p>
                        <p><strong class="text-rose-600">Essential Question:</strong> How can innovative engineering and design help humans and wildlife coexist safely and support biodiversity in developed landscapes?</p>
                        <p><strong class="text-rose-600">Learning Intention:</strong> We are learning to analyze how roads and cities create problems for wildlife and to design engineering solutions that reduce harm and support biodiversity.</p>
                        <hr class="my-4">
                        <h3 class="text-2xl font-bold text-rose-600 mb-3">Success Criteria</h3>
                        <ul class="list-disc list-inside space-y-2 text-xl">
                            <li>I can define ‚Äúhabitat fragmentation‚Äù and explain why it is a problem for animals.</li>
                            <li>I can describe two different types of wildlife crossings and how they work.</li>
                            <li>I can collaborate to design a wildlife bridge and explain its key features.</li>
                        </ul>` } },
                
                // STAGE 3 - W, H, E
                { id: 'warm-up', type: 'html-content', content: { title: 'Hook & Engage: Warm-Up', html: `
                        <h3 class="text-2xl font-bold text-sky-600 mb-3">Background-Building Questions</h3>
                        <ol class="list-decimal list-inside space-y-4 text-xl">
                            <li>Have you ever seen an animal (other than a bird) trying to cross a busy road? What happened? What were the dangers?</li>
                            <li>Look at a map of your city. Where are the green spaces (parks, forests)? Are they connected, or are they islands separated by roads and buildings?</li>
                            <li>If you were an animal, what would be the most difficult part of living in a city?</li>
                        </ol>` } },
                { id: 'vocab-start', type: 'simple', content: { title: 'Unit Vocabulary üìö', text: 'Let\'s learn the key terms for this unit.' } },
                { id: 'vocab-match', type: 'quiz-mcq', content: { title: 'Vocabulary Practice: Matching', questions: [
                    { q: 'What is the "natural home or environment of an animal or plant"?', options: ['Corridor','Habitat','Infrastructure','Overpass'], correctIndex: 1 },
                    { q: 'Which term describes breaking habitats into smaller isolated pieces?', options: ['Migration','Fragmentation','Corridor','Conservation'], correctIndex: 1 },
                    { q: 'Which is a strip that connects two habitats?', options: ['Overpass','Corridor','Migration','Underpass'], correctIndex: 1 }
                ] } },

                // READING
                { id: 'reading-main', type: 'html-content', content: { title: 'Reading: Tiered Texts üìñ', html: `
                        <div class="mb-8">
                            <h3 class="text-2xl font-bold text-blue-600 mb-3">Pre-Reading Questions</h3>
                            <ol class="list-decimal list-inside space-y-2 text-xl">
                                <li>Why can‚Äôt animals just stay on one side of a road?</li>
                                <li>What kind of features would a bridge for animals need to have?</li>
                                <li>Do you think building a bridge for animals is a good use of money? Why or why not?</li>
                            </ol>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-bold text-xl text-blue-800">Text 1: A Safe Path for Animals</h4>
                                <p>When we build a big road, it can cut a forest in two. This is called habitat fragmentation. It is a problem for animals. They cannot move to find food or meet other animals. Roads can also cause accidents. A wildlife bridge gives animals a safe way to cross.</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-bold text-xl text-yellow-800">Text 2: Connecting a Fragmented World</h4>
                                <p>Human infrastructure like highways and railways is important for people, but it separates habitats. Wildlife corridors‚Äîlike overpasses and underpasses‚Äîhelp connect these fragments so animals can reach resources and maintain genetic diversity.</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-bold text-xl text-red-800">Text 3: Engineering for Coexistence</h4>
                                <p>Engineers and ecologists work together to design crossings that are safe and usable for many species. Features include native plantings, noise barriers, and gradual slopes to make animals feel secure. Monitoring and community support are vital for success.</p>
                            </div>
                        </div>` } },

                { id: 'reading-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Comprehension: Gap Fill', sentences: [
                    { text: 'When a road cuts a forest in two it is called ________.', answer: 'fragmentation' },
                    { text: 'A ________ allows animals to move safely between habitats.', answer: 'corridor' }
                ] } },
                { id: 'reading-quiz-tfng', type: 'quiz-tfng', content: { title: 'Comprehension: True/False/Not Given', questions: [
                    { q: 'Wildlife crossings always cost less than fencing a road.', a: 'NOT GIVEN' },
                    { q: 'Underpasses are more suitable for small, shy animals.', a: 'TRUE' }
                ] } },
                { id: 'reading-quiz-mcq', type: 'quiz-mcq', content: { title: 'Comprehension: Multiple Choice', questions: [
                    { q: 'Which of these helps reduce wildlife-vehicle collisions?', options: ['Building wildlife bridges','Adding more parking','Wider roads for cars','Reducing public transport'], correctIndex: 0 },
                    { q: 'Which feature makes a crossing attractive to wildlife?', options: ['High fences','Native plants and cover','Bright lights','Steep concrete sides'], correctIndex: 1 }
                ] } },

                // CONVERSATION PRACTICE
                { id: 'conversation-practice', type: 'dialogue', content: { title: 'Interactive Conversation Practice üó£Ô∏è', dialogue: `Leo: I never really thought about how roads affect animals.  
Mia: Same here. I saw a fox trying to cross a busy road last year and it was scary.  
Leo: What would help animals in this situation?  
Mia: A simple wildlife overpass or even a small underpass for amphibians could make a big difference.` } },

                // LISTENING ACTIVITIES
                { id: 'lecture-coexistence', type: 'dialogue', content: { title: 'Listening: Engineering for Coexistence üßë‚Äçüî¨', dialogue: `Professor: Welcome everyone. Today we'll look at how engineering and ecology can work together.  
Student: What kind of data do you need to design a crossing?  
Professor: We need movement patterns, species lists, and road collision records. We also monitor after construction to ensure it's effective.` } },
                { id: 'lecture-coexistence-quiz-mcq', type: 'quiz-mcq', content: { title: 'Coexistence Lecture Quiz (MCQ)', questions: [
                    { q: 'Which data is useful for designing a crossing?', options: ['Species movement patterns','Popular car models','Movie schedules','Local restaurant menus'], correctIndex: 0 }
                ] } },
                { id: 'lecture-coexistence-quiz-tfng', type: 'quiz-tfng', content: { title: 'Coexistence Lecture Quiz (TFNG)', questions: [
                    { q: 'Monitoring after construction is unnecessary.', a: 'FALSE' }
                ] } },
                { id: 'lecture-coexistence-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Coexistence Lecture Gap Fill', sentences: [
                    { text: 'Engineers use ________ patterns to design effective crossings.', answer: 'movement' }
                ] } },
                { id: 'podcast-biodiversity', type: 'dialogue', content: { title: 'Listening: Biodiversity Conversation üéß', dialogue: `Chris: G'day everyone! As engineers, it's our duty to design with nature in mind.  
Sarah: Agreed. Small design choices like planting native shrubs make crossings much more successful.  
Chris: And community involvement ensures long-term maintenance and funding.` } },
                { id: 'podcast-biodiversity-quiz-mcq', type: 'quiz-mcq', content: { title: 'Biodiversity Podcast Quiz (MCQ)', questions: [
                    { q: 'What helps crossings succeed long-term?', options: ['Community involvement','Ignoring local opinion','Short-term funding only','Concrete barriers'], correctIndex: 0 }
                ] } },
                { id: 'podcast-biodiversity-quiz-tfng', type: 'quiz-tfng', content: { title: 'Biodiversity Podcast Quiz (TFNG)', questions: [
                    { q: 'Native plants make crossings less attractive to wildlife.', a: 'FALSE' }
                ] } },
                { id: 'podcast-biodiversity-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Biodiversity Podcast Gap Fill', sentences: [
                    { text: 'Planting ________ shrubs helps animals use crossings.', answer: 'native' }
                ] } },

                // Dilemmas
                { id: 'dilemma-solar-farm', type: 'dialogue', content: { title: 'Dilemma: Solar Farm ü§î', dialogue: `Sarah: We're planning a solar farm on the edge of town. It could power thousands of homes.  
Alex: But it would remove a corridor used by deer and smaller mammals.  
Sarah: What are the trade-offs? Could we design around wildlife movement?` } },
                { id: 'dilemma-solar-farm-quiz-mcq', type: 'quiz-mcq', content: { title: 'Solar Farm Dilemma Quiz (MCQ)', questions: [
                    { q: 'Which is a mitigation for habitat loss?', options: ['Design corridors around the site','Remove all vegetation','Block all animal movement','Install tall fences'], correctIndex: 0 }
                ] } },
                { id: 'dilemma-solar-farm-quiz-tfng', type: 'quiz-tfng', content: { title: 'Solar Farm Dilemma Quiz (TFNG)', questions: [
                    { q: 'Solar farms always destroy biodiversity.', a: 'NOT GIVEN' }
                ] } },
                { id: 'dilemma-solar-farm-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Solar Farm Dilemma Gap Fill', sentences: [
                    { text: 'One solution is to leave ________ zones around the panels for wildlife.', answer: 'buffer' }
                ] } },

                { id: 'dilemma-wind-farm', type: 'dialogue', content: { title: 'Dilemma: Wind Farm ‚ö†Ô∏è', dialogue: `Sarah: A new wind farm could reduce emissions but may affect birds and bats.  
Alex: We need impact studies and careful siting to reduce collision risks.  
Sarah: Could we combine turbine siting with protected corridors?` } },
                { id: 'dilemma-wind-farm-quiz-mcq', type: 'quiz-mcq', content: { title: 'Wind Farm Dilemma Quiz (MCQ)', questions: [
                    { q: 'What reduces risk to flying wildlife?', options: ['Careful siting and monitoring','Increasing turbine speed','Painting turbines bright colors','Removing all vegetation'], correctIndex: 0 }
                ] } },
                { id: 'dilemma-wind-farm-quiz-tfng', type: 'quiz-tfng', content: { title: 'Wind Farm Dilemma Quiz (TFNG)', questions: [
                    { q: 'Monitoring is unnecessary after install.', a: 'FALSE' }
                ] } },
                { id: 'dilemma-wind-farm-quiz-gap-fill', type: 'quiz-gap-fill', content: { title: 'Wind Farm Dilemma Gap Fill', sentences: [
                    { text: 'Careful ________ can reduce impacts on migratory birds.', answer: 'siting' }
                ] } },

                // STAGE 3 - R, E, T, O
                { id: 'thinking-prompts', type: 'html-content', content: { title: 'Rethink, Revise, Reflect üìù', html: `
                        <div class="mb-6">
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Harkness Discussion Prompt</h3>
                            <p class="text-xl italic">‚ÄúWhen there is a conflict between human development (like a new highway or housing project) and wildlife conservation, which should be the priority and why?‚Äù</p>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Higher-Order Thinking Questions</h3>
                            <ul class="list-disc list-inside space-y-2 text-lg">
                                <li><b>Remembering:</b> What are two types of wildlife crossings?</li>
                                <li><b>Understanding:</b> Explain why habitat fragmentation is a threat to biodiversity.</li>
                                <li><b>Applying:</b> Choose a nearby park. Where would you propose a corridor and why?</li>
                                <li><b>Analyzing:</b> Compare needs of a bear vs a turtle when designing a crossing.</li>
                                <li><b>Evaluating:</b> Argue whether one large overpass or many small underpasses is better.</li>
                                <li><b>Creating:</b> Write a short story as an animal crossing a wildlife bridge.</li>
                            </ul>
                        </div>` } },
                { id: 'exam-practice', type: 'html-content', content: { title: 'Connections to IELTS & TOEFL', html: `
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-2xl font-bold text-purple-600 mb-3">IELTS Speaking Practice</h3>
                                <p><b>Part 1:</b> Do you like animals? What is your country‚Äôs most famous animal? Do you think it‚Äôs important to protect wild animals?</p>
                                <p><b>Part 2 (Cue Card):</b> Describe a time when you saw a wild animal. You should say: what the animal was, where you saw it, what it was doing, and explain how you felt.</p>
                                <p><b>Part 3:</b> What are the main reasons why some animals are endangered? How can humans help protect endangered species?</p>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-purple-600 mb-3">TOEFL Independent Speaking</h3>
                                <p>Some people think that governments should spend money on protecting wild animals, while others think the money should be spent on human needs. Which view do you agree with? Use details and examples to support your answer.</p>
                            </div>
                        </div>` } },

                { id: 'final-project-hub', type: 'html-content', content: { title: 'Final Project Hub ‚úçÔ∏è', html: `
                        <div class="bg-gradient-to-br from-green-50 to-teal-50">
                            <header class="bg-white shadow-lg border-b-4 border-green-500">
                                <div class="max-w-7xl mx-auto px-6 py-8">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h1 class="text-4xl font-bold text-gray-800 mb-2">üåâüêæ Bridging Worlds</h1>
                                            <p class="text-xl text-gray-600">Final Project Guide</p>
                                        </div>
                                        <div class="rooftop-animation">
                                            <svg class="w-24 h-24" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 70 C 30 50, 70 50, 90 70" stroke="#8d6e63" stroke-width="3" fill="none"/></svg>
                                        </div>
                                    </div>
                                </div>
                            </header>
                            <section class="max-w-7xl mx-auto px-6 py-12">
                                <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Big Ideas & Understanding</h2>
                                    <div class="grid md:grid-cols-2 gap-8">
                                        <div class="bg-gradient-to-r from-green-100 to-teal-100 p-6 rounded-xl">
                                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Core Concepts</h3>
                                            <p>Understand habitat fragmentation, corridors, and basic ecology.</p>
                                        </div>
                                        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 p-6 rounded-xl">
                                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Design Principles</h3>
                                            <p>Consider species needs, materials, and long-term maintenance when designing crossings.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-white rounded-2xl shadow-xl p-8 mb-12">
                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Transferable KSA Skills</h2>
                                    <div class="grid md:grid-cols-3 gap-6">
                                        <div class="text-center p-6 bg-red-50 rounded-xl"><div class="text-4xl mb-4">üß†</div><h3 class="font-semibold">Critical Thinking</h3></div>
                                        <div class="text-center p-6 bg-blue-50 rounded-xl"><div class="text-4xl mb-4">üìù</div><h3 class="font-semibold">Communication</h3></div>
                                        <div class="text-center p-6 bg-green-50 rounded-xl"><div class="text-4xl mb-4">üî¨</div><h3 class="font-semibold">Technical</h3></div>
                                    </div>
                                </div>
                                <div class="mb-12">
                                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Project-Based Learning Journey</h2>
                                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        <div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(1)"><div class="text-4xl mb-4">üîç</div><h3 class="font-semibold">Phase 1</h3></div>
                                        <div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(2)"><div class="text-4xl mb-4">üìö</div><h3 class="font-semibold">Phase 2</h3></div>
                                        <div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(3)"><div class="text-4xl mb-4">üìê</div><h3 class="font-semibold">Phase 3</h3></div>
                                        <div class="phase-card rounded-2xl p-6 text-white cursor-pointer" onclick="showPhase(4)"><div class="text-4xl mb-4">üìä</div><h3 class="font-semibold">Phase 4</h3></div>
                                    </div>
                                </div>
                                <div id="phaseContent" class="bg-white rounded-2xl shadow-xl p-8"></div>
                            </section>
                        </div>` } },
                { id: 'writing-task', type: 'writing-task', content: { 
                    title: 'Writing Activity ‚úçÔ∏è', 
                    prompt: 'A new high-speed railway is being planned to go through a rural area near your town. Write a formal letter to your local government representative expressing your concern and proposing a solution that balances development with wildlife conservation.',
                    starters: ['I am writing to you today with a serious concern regarding...', 'The construction of this railway will cause significant...', 'Therefore, I strongly urge you to advocate for...'],
                    wordBank: ['accident', 'benefit', 'biodiversity', 'bridge', 'coexist', 'connect', 'conservation', 'corridor', 'cost', 'design', 'ecosystem', 'engineering', 'environment', 'fragmentation']
                } },
                { id: 'self-assessment', type: 'html-content', content: { title: 'Self-Assessment & Rubric üßë‚Äçüè´', html: `
                        <div class="mb-8">
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Metacognitive Self-Assessment</h3>
                            <ol class="list-decimal list-inside space-y-4 text-xl">
                                <li>Which activity helped me understand the problem of habitat fragmentation the most? Why was it effective for me?</li>
                                <li>On a scale of 1-5, how confident am I that I could explain the purpose of a wildlife bridge to a family member in English?</li>
                            </ol>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-purple-600 mb-3">Final Project Rubric (KASE-C)</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="bg-purple-50">
                                            <th class="border-b-2 p-2 w-1/4">Criterion</th>
                                            <th class="border-b-2 p-2">5 - Exemplary</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="border-b p-2 font-semibold">K ‚Äì Knowledge</td><td class="border-b p-2">The proposal demonstrates a deep, nuanced understanding of habitat fragmentation and practical mitigation strategies.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">A ‚Äì Analysis</td><td class="border-b p-2">The proposed bridge design is creative, technically sound, and perceives site constraints.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">S ‚Äì Structure</td><td class="border-b p-2">The presentation is exceptionally clear, engaging, and persuasive.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">E ‚Äì Evidence</td><td class="border-b p-2">All claims are consistently supported by strong, relevant, and well-integrated evidence.</td></tr>
                                        <tr><td class="border-b p-2 font-semibold">C ‚Äì Clarity</td><td class="border-b p-2">The student demonstrates a masterful command of English, using a wide and appropriate vocabulary.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>` } },
                { id: 'certificate', type: 'certificate', content: { title: 'Module Complete! üéâ', text: 'You have successfully completed the "Bridging Worlds" module. Well done!' } }
            ]
        };
        // --- END OF LESSON CONTENT CONFIGURATION ---
        // ===================================================================================

        // --- PROJECT HUB DATA & FUNCTIONS ---
        const phases = {
            1: { title: "Phase 1: Identifying the Problem & Initial Inquiry", icon: "üîç", keywords: { "Habitat Fragmentation": "The new highway caused habitat fragmentation by splitting continuous forest into isolated patches; this reduces gene flow.", "Roadkill": "Frequent wildlife-vehicle collisions on this stretch." } },
            2: { title: "Phase 2: Researching Solutions & Foundational Concepts", icon: "üìö", keywords: { "Biodiversity": "The variety of life in a place, important for ecosystem resilience.", "Corridor": "Connects separate habitats to allow movement and genetic exchange." } },
            3: { title: "Phase 3: Planning & Design", icon: "üìê", keywords: { "Site Analysis": "Assessing topography, species, and movement routes to place a crossing.", "Design Features": "Native planting, gentle slopes, and noise reduction to encourage use." } },
            4: { title: "Phase 4: Evaluation & Communication", icon: "üìä", keywords: { "Cost-Benefit Analysis": "Comparing long-term benefits to costs, including reduced collisions.", "Community Engagement": "Keeping local stakeholders informed and involved." } },
        };

        window.showPhase = function(phaseNumber) {
            const phase = phases[phaseNumber];
            const content = document.querySelector('#page-final-project-hub #phaseContent');
            if (!content) return;
            let keywordsHtml = Object.entries(phase.keywords).map(([keyword, definition]) => `
                <div class="keyword-item bg-gray-50 p-4 rounded-xl border-l-4 border-green-500" onclick="showKeyword('${keyword}', '${definition.replace(/'/g, "\\'")}')">
                    <h4 class="font-semibold text-gray-800 mb-2">${keyword}</h4>
                    <p class="text-gray-600 text-sm">${definition.substring(0, 150)}${definition.length > 150 ? '...' : ''}</p>
                </div>`).join('');
            content.innerHTML = `
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">${phase.icon}</div>
                    <h3 class="text-2xl font-bold text-gray-800">${phase.title}</h3>
                </div>
                <div class="grid md:grid-cols-2 gap-4">${keywordsHtml}</div>`;
        }
        window.showKeyword = function(keyword, definition) {
            document.getElementById('modalTitle').textContent = keyword;
            document.getElementById('modalContent').textContent = definition;
            document.getElementById('keywordModal').classList.remove('hidden');
            document.getElementById('keywordModal').classList.add('flex');
        }
        window.closeModal = function() {
            document.getElementById('keywordModal').classList.add('hidden');
            document.getElementById('keywordModal').classList.remove('flex');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // ===================================================================================
            // --- MAIN SCRIPT ---
            // ===================================================================================

            // --- STATE MANAGEMENT ---
            let score = 0, currentPage = lessonData.startPageId, timerInterval;
            const pageHistory = [lessonData.startPageId];
            let pageSequence = [];
            let earnedBadges = [];
            let selectedWord = { element: null, text: '' };

            // --- AUDIO & TTS ENGINE ---
            let audioContext, speechService, sequenceNode;
            
            // --- SOUND & PHRASE CONTENT ---
            const correctPhrases = [ "Stellar work!", "You've got it!", "Absolutely brilliant!", "That's the one!", "Incredible!", "Keep it up!" ];
            const incorrectPhrases = [ "That was a great attempt! Let's try another.", "Not this time, but you're getting warmer!", "Every try is a step forward. Keep going!" ];
            const correctSounds = [ {name: "Bright Ding", seq: [{freq:880,dur:0.18}]}, {name: "Double Chime", seq: [{freq:660,dur:0.12},{freq:880,dur:0.12}]} ];
            const incorrectSounds = [ {name: "Buzzer", seq: [{freq:200,type:'square',dur:0.4}]} ];

            class SpeechService {
                constructor() {
                    this.synth = window.speechSynthesis;
                    this.isInitialized = false;
                    this.isTtsEnabled = true;
                    this.voices = [];
                    this.speechRate = 0.9;
                    this.speakerVoiceMap = { 'default': { names: [], lang: 'en-US' } };
                }

                async _setupVoices() {
                    const voicesPromise = new Promise(resolve => {
                        const v = this.synth.getVoices();
                        if (v && v.length) return resolve(v);
                        this.synth.onvoiceschanged = () => resolve(this.synth.getVoices());
                    });
                    this.voices = await voicesPromise;
                    if (!this.voices.length) {
                        console.warn("No voices available.");
                        this.isInitialized = true;
                        return;
                    }
                    try {
                        const warmUp = new SpeechSynthesisUtterance(' ');
                        warmUp.volume = 0;
                        this.synth.speak(warmUp);
                        this.synth.cancel();
                    } catch (e) {}
                    this.isInitialized = true;
                }

                _getVoiceForSpeaker(speakerName) {
                    if (!this.voices || !this.voices.length) return null;
                    const key = (speakerName || 'default').toLowerCase();
                    const entry = this.speakerVoiceMap[key] || this.speakerVoiceMap['default'];
                    for (const preferredName of (entry.names || [])) {
                        const match = this.voices.find(v => v.name === preferredName);
                        if (match) return match;
                    }
                    return this.voices.find(v => v.lang === entry.lang) || this.voices[0];
                }

                speak(text, speakerName = null, rate = this.speechRate) {
                    if (!this.isTtsEnabled || !text || !text.trim()) return;
                    if (!this.isInitialized) {
                        console.warn("SpeechService not initialized yet.");
                        return;
                    }
                    try {
                        this.synth.cancel();
                        const utter = new SpeechSynthesisUtterance(text);
                        utter.rate = rate;
                        const voice = this._getVoiceForSpeaker(speakerName || 'default');
                        if (voice) utter.voice = voice;
                        this.synth.speak(utter);
                    } catch (e) {
                        console.error("SpeechSynthesis error", e);
                    }
                }

                toggleTts() {
                    this.isTtsEnabled = !this.isTtsEnabled;
                    return this.isTtsEnabled;
                }
            }
            
            async function speakDialogue(text) {
                if (!speechService || !speechService.isInitialized || !speechService.isTtsEnabled || !text) return;
                if (speechService.synth) speechService.synth.cancel();
                await new Promise(resolve => setTimeout(resolve, 120));
                const lines = text.split('\n').map(l => l.trim()).filter(l => l !== '');
                let i = 0;
                function next() {
                    if (!speechService.isTtsEnabled || i >= lines.length) return;
                    const parts = lines[i++].split(':');
                    const speaker = parts.length > 1 ? parts[0].trim() : null;
                    const dialogue = (parts.length > 1 ? parts.slice(1).join(':') : parts[0]).trim();
                    if (dialogue) speechService.speak(dialogue, speaker);
                    setTimeout(next, Math.min(1400, dialogue.length * 30));
                }
                next();
            }

            window.toggleTTS = (button) => {
                if (!speechService) return;
                const isNowEnabled = speechService.toggleTts();
                button.setAttribute('aria-pressed', String(isNowEnabled));
                if (!isNowEnabled && speechService.synth) speechService.synth.cancel();
                button.classList.toggle('opacity-60', !isNowEnabled);
            };
            
            async function initializeAudio() {
                if (audioContext) return;
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const processorScript = document.getElementById('sequence-processor').textContent;
                    const blob = new Blob([processorScript], { type: 'application/javascript' });
                    const workletURL = URL.createObjectURL(blob);
                    try {
                        await audioContext.audioWorklet.addModule(workletURL);
                        sequenceNode = new AudioWorkletNode(audioContext, 'sequence-processor');
                        sequenceNode.port.onmessage = (e) => {
                            if (e.data && e.data.type === 'noteOn') {
                                playOscillator(e.data.freq, e.data.dur, e.data.vol, e.data.waveType);
                            }
                        };
                        sequenceNode.connect(audioContext.destination);
                    } catch (e) {
                        console.warn('AudioWorklet failed to load, using oscillator fallback', e);
                        sequenceNode = null;
                    }
                    speechService = new SpeechService();
                    await speechService._setupVoices();
                } catch (e) {
                    console.error("Audio/Speech initialization failed:", e);
                }
            }

            const playOscillator = (freq = 440, dur = 0.2, vol = 0.2, type = 'sine') => {
                try {
                    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    if (audioContext.state === 'suspended') audioContext.resume();
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.type = type;
                    osc.frequency.value = freq;
                    gain.gain.value = vol;
                    osc.connect(gain); gain.connect(audioContext.destination);
                    osc.start();
                    setTimeout(() => { try { osc.stop(); osc.disconnect(); gain.disconnect(); } catch (e){} }, dur * 1000);
                } catch (e) { /* ignore */ }
            };

            const playSound = (isCorrect) => {
                const bank = isCorrect ? correctSounds : incorrectSounds;
                const sound = bank[Math.floor(Math.random() * bank.length)];
                if (!sound) return;
                if (sequenceNode && sequenceNode.port) {
                    sequenceNode.port.postMessage({ type: 'play', sequence: sound.seq });
                } else {
                    sound.seq.forEach(n => playOscillator(n.freq, n.dur || 0.2, n.vol || 0.2, n.type || 'sine'));
                }
            }

            // Background animation
            const bgCanvas = document.getElementById('background-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            function fitCanvas() { bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; }
            fitCanvas();
            window.addEventListener('resize', fitCanvas);
            let particles = [];
            function animateBackground() {
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                particles.forEach((p,i) => {
                    p.y -= p.speed;
                    p.x += Math.sin(p.y / 50) * 0.3;
                    if (p.y < -p.radius) particles.splice(i,1);
                    bgCtx.beginPath();
                    bgCtx.arc(p.x, p.y, p.radius, 0, Math.PI*2);
                    bgCtx.globalAlpha = p.opacity;
                    bgCtx.fillStyle = p.color;
                    bgCtx.fill();
                });
                if (Math.random() > 0.97 && particles.length < 120) {
                    particles.push({
                        x: Math.random() * bgCanvas.width,
                        y: bgCanvas.height + 20,
                        radius: Math.random()*6 + 2,
                        speed: Math.random()*1.5 + 0.5,
                        color: ['#34d399','#f59e0b','#a78bfa','#60a5fa'][Math.floor(Math.random()*4)],
                        opacity: 0.6 + Math.random()*0.4
                    });
                }
                requestAnimationFrame(animateBackground);
            }
            animateBackground();

            function runCompletionAnimation() {
                const canvas = document.createElement('canvas');
                canvas.id = 'completion-canvas';
                canvas.style.position = 'fixed';
                canvas.style.left = 0; canvas.style.top = 0; canvas.style.width = '100%'; canvas.style.height = '100%';
                canvas.style.zIndex = 9999; canvas.style.pointerEvents = 'none';
                document.body.appendChild(canvas);
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                let confetti = [];
                function spawn() {
                    for (let i=0;i<60;i++){
                        confetti.push({x: Math.random()*canvas.width, y: -10, vx: (Math.random()-0.5)*6, vy: Math.random()*3+2, w: 8, h: 12, color: ['#fde68a','#f97316','#60a5fa','#34d399'][Math.floor(Math.random()*4)], angle: Math.random()*Math.PI});
                    }
                }
                spawn();
                let t=0;
                function frame(){
                    t++;
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    confetti.forEach((c,i)=> {
                        c.x += c.vx; c.y += c.vy; c.vy += 0.05;
                        ctx.save();
                        ctx.translate(c.x,c.y);
                        ctx.rotate(c.angle);
                        ctx.fillStyle = c.color;
                        ctx.fillRect(-c.w/2,-c.h/2,c.w,c.h);
                        ctx.restore();
                        if (c.y > canvas.height + 20) confetti.splice(i,1);
                    });
                    if (t < 200) requestAnimationFrame(frame);
                    else canvas.remove();
                }
                frame();
            }

            // Utility helpers
            function stripHtmlAndEmojis(text) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                return tempDiv.textContent || tempDiv.innerText || "";
            }
            function escapeForTemplate(s) {
                return (s || '').replace(/`/g, '\\`').replace(/\$/g, '\\$');
            }

            // Build pages dynamically from lessonData
            function buildPages() {
                const container = document.getElementById('dynamic-pages-container');
                container.innerHTML = '';
                lessonData.pages.forEach(p => {
                    const el = document.createElement('section');
                    el.id = `page-${p.id}`;
                    el.className = 'page bg-white rounded-2xl shadow-lg p-6 my-6';
                    if (p.type === 'simple') {
                        el.innerHTML = `<h2 class="text-2xl font-bold mb-3">${p.content.title}</h2><p class="text-lg">${p.content.text}</p><div class="mt-4"><button class="action-button bg-green-600 text-white px-4 py-2 rounded" onclick="goNext()">Next</button></div>`;
                    } else if (p.type === 'timer') {
                        el.innerHTML = `<h2 class="text-2xl font-bold mb-3">${p.content.title}</h2><p class="text-lg mb-4">${p.content.text}</p><div class="text-2xl font-mono" id="${p.content.timerId}">00:00</div><div class="mt-4"><button class="action-button bg-green-600 text-white px-4 py-2 rounded" onclick="goNext()">Next</button></div>`;
                    } else if (p.type === 'html-content') {
                        el.innerHTML = `<h2 class="text-2xl font-bold mb-3">${p.content.title}</h2><div class="readable-content">${p.content.html}</div><div class="mt-4"><button class="action-button bg-green-600 text-white px-4 py-2 rounded" onclick="goNext()">Next</button></div>`;
                    } else if (p.type === 'dialogue') {
                        el.innerHTML = `<h2 class="text-2xl font-bold mb-3">${p.content.title}</h2><pre class="whitespace-pre-wrap">${p.content.dialogue}</pre><div class="mt-4"><button class="action-button bg-blue-600 text-white px-4 py-2 rounded" onclick="speakDialogue(\`${escapeForTemplate(p.content.dialogue)}\`)">Play</button> <button class="action-button bg-green-600 text-white px-4 py-2 rounded" onclick="goNext()">Next</button></div>`;
                    } else if (p.type === 'quiz-mcq') {
                        let qHtml = `<h2 class="text-2xl font-bold mb-3">${p.content.title}</h2>`;
                        p.content.questions.forEach((q,qi) => {
                            qHtml += `<div class="question-group mb-3 p-3 border rounded"><div class="mb-2 font-semibold">${qi+1}. ${q.q}</div>`;
                            q.options.forEach((opt,oi) => {
                                const isCorrect = (oi === q.correctIndex) ? "data-correct='true'" : '';
                                qHtml += `<button class="quiz-option block w-full text-left p-2 my-1 bg-gray-100 rounded hover:bg-gray-200" onclick="checkMcqAnswer(this, ${oi === q.correctIndex})" ${isCorrect}>${String.fromCharCode(65+oi)}. ${opt}</button>`;
                            });
                            qHtml += `</div>`;
                        });
                        qHtml += `<div class="mt-4"><button class="action-button bg-green-600 text-white px-4 py-2 rounded" onclick="goNext()">Next</button></div>`;
                        el.innerHTML = qHtml;
                    } else if (p.type === 'quiz-tfng') {
                        let qHtml = `<h2 class="text-2xl font-bold mb-3">${p.content.title}</h2>`;
                        p.content.questions.forEach((q,qi) => {
                            qHtml += `<div class="question-group mb-3 p-3 border rounded"><div class="mb-2 font-semibold">${qi+1}. ${q.q}</div>`;
                            ['TRUE','FALSE','NOT GIVEN'].forEach(opt => {
                                qHtml += `<button class="tfng-button mr-2 mb-2 p-2 bg-gray-100 rounded" onclick="checkTfngAnswer(this,'${opt}','${q.a}')">${opt}</button>`;
                            });
                            qHtml += `</div>`;
                        });
                        qHtml += `<div class="mt-4"><button class="action-button bg-green-600 text-white px-4 py-2 rounded" onclick="goNext()">Next</button></div>`;
                        el.innerHTML = qHtml;
                    } else if (p.type === 'quiz-gap-fill') {
                        let html = `<h2 class="text-2xl font-bold mb-3">${p.content.title}</h2><div class="gap-fill-container">`;
                        p.content.sentences.forEach((s,si) => {
                            html += `<div class="mb-3"><span>${s.text.replace('______','<span class="gap" id="gap-${p.id}-${si}" data-answer="${s.answer}"><span class="word-bank-word" tabindex="0" draggable="true" data-word="${s.answer}">${s.answer}</span></span>')}</span></div>`;
                        });
                        html += `</div><div class="mt-4"><button class="action-button bg-green-600 text-white px-4 py-2 rounded" onclick="goNext()">Next</button></div>`;
                        el.innerHTML = html;
                    } else if (p.type === 'writing-task') {
                        el.innerHTML = `<h2 class="text-2xl font-bold mb-3">${p.content.title}</h2><p class="mb-4">${p.content.prompt}</p><textarea id="writing-response" class="w-full p-2 border rounded mb-3" rows="6" placeholder="Write here..."></textarea><div><button class="action-button bg-green-600 text-white px-4 py-2 rounded" onclick="submitWriting()">Submit</button> <button class="action-button bg-gray-400 text-white px-4 py-2 rounded" onclick="goNext()">Next</button></div>`;
                    } else if (p.type === 'certificate') {
                        el.innerHTML = `<h2 class="text-3xl font-bold mb-3">${p.content.title}</h2><p>${p.content.text}</p><div class="mt-4"><button class="action-button bg-blue-600 text-white px-4 py-2 rounded" onclick="runCompletionAnimation()">Celebrate</button></div>`;
                    } else {
                        el.innerHTML = `<h2>${p.id}</h2>`;
                    }
                    container.appendChild(el);
                });
                // Build pageSequence
                pageSequence = lessonData.pages.map(p => p.id);
                if (!pageSequence.includes(lessonData.homePageId)) pageSequence.unshift(lessonData.homePageId);
            }

            // Navigation & flow
            window.navigateTo = (pageId) => {
                const normalized = pageId.replace(/^page-/, '');
                const target = document.getElementById(`page-${normalized}`);
                if (!target) return console.warn('navigateTo: no page found for id', pageId);
                if (normalized === currentPage) return;

                clearInterval(timerInterval);
                if (speechService && speechService.synth) speechService.synth.cancel();

                document.getElementById(`page-${currentPage}`)?.classList.remove('active');
                target.classList.add('active');
                currentPage = normalized;
                if (pageHistory[pageHistory.length - 1] !== currentPage) pageHistory.push(currentPage);

                const pageData = lessonData.pages.find(p => p.id === currentPage);
                if (!pageData) return;

                if (pageData.type === 'timer') {
                    const timerEl = document.getElementById(pageData.content.timerId);
                    if (timerEl) startTimer(pageData.content.duration, timerEl, goNext);
                } else if (pageData.id === 'final-project-hub') {
                    window.showPhase(1);
                }

                if (speechService) {
                    if (pageData.type === 'dialogue') {
                        speakDialogue(pageData.content.dialogue);
                    } else {
                        let textToSpeak = '';
                        if (pageData.id === 'reading-main') {
                            const readingContainer = target.querySelector('.space-y-6');
                            if (readingContainer) {
                                textToSpeak = Array.from(readingContainer.querySelectorAll('h4, p')).map(el => el.textContent).join(' \n ');
                            }
                        } else {
                            const readableContent = target.querySelector('.readable-content');
                            const titleElement = target.querySelector('h2, h3');
                            if (readableContent) textToSpeak = readableContent.innerHTML;
                            else if (titleElement) textToSpeak = titleElement.innerHTML;
                        }
                        if (textToSpeak) speechService.speak(stripHtmlAndEmojis(textToSpeak), 'default');
                        if (pageData.type === 'certificate') runCompletionAnimation();
                    }
                }

                updateNavButtons();
                window.scrollTo(0,0);
            }

            window.goNext = () => {
                const currentIndex = pageSequence.indexOf(currentPage);
                if (currentIndex > -1 && currentIndex < pageSequence.length - 1) navigateTo(pageSequence[currentIndex + 1]);
            }
            window.goBack = () => {
                if (pageHistory.length > 1) { pageHistory.pop(); navigateTo(pageHistory.pop()); }
            }

            function updateNavButtons() {
                const nav = document.getElementById('nav-header');
                if (!nav) return;
                nav.style.display = (currentPage === lessonData.startPageId) ? 'none' : 'block';
                const backBtn = nav.querySelector('button[aria-label="Back"]');
                backBtn.disabled = pageHistory.length <= 1;
                backBtn.classList.toggle('opacity-50', backBtn.disabled);
                const nextBtn = nav.querySelector('button[aria-label="Next"]');
                const currentIndex = pageSequence.indexOf(currentPage);
                const isLast = currentIndex >= pageSequence.length - 1;
                const isCertificate = currentPage === 'certificate';
                nextBtn.disabled = isLast || currentPage === lessonData.homePageId || isCertificate;
                nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
            }
            
            // Feedback & scoring
            function showFeedbackMessage(isCorrect) {
                const phrases = isCorrect ? correctPhrases : incorrectPhrases;
                const message = phrases[Math.floor(Math.random() * phrases.length)];
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `feedback-toast ${isCorrect ? 'correct' : 'encouraging'}`;
                toast.setAttribute('role', 'status');
                toast.setAttribute('aria-live', 'assertive');
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4500);
                if (speechService) speechService.speak(message);
            }

            function updateScore(points) {
                score += points;
                document.getElementById('score-display').textContent = score;
            }

            // Quiz handlers
            window.checkTfngAnswer = function(clickedButton, chosenAnswer, correctAnswer) {
                const buttonContainer = clickedButton.parentElement;
                Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
                const isCorrect = chosenAnswer === correctAnswer;
                showFeedbackMessage(isCorrect);
                
                const feedbackIcon = document.createElement('span');
                feedbackIcon.className = `ml-2 text-xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'}`;
                feedbackIcon.textContent = isCorrect ? '‚úì' : '‚úó';
                clickedButton.closest('.question-group').appendChild(feedbackIcon);

                if (isCorrect) {
                    playSound(true);
                    updateScore(10);
                } else {
                    playSound(false);
                }
            }
            
            window.checkMcqAnswer = function(button, isCorrect) {
                const questionGroup = button.closest('.question-group');
                questionGroup.querySelectorAll('.quiz-option').forEach(opt => opt.disabled = true);
                showFeedbackMessage(isCorrect);

                const feedbackIcon = document.createElement('span');
                feedbackIcon.className = `ml-2 text-xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'}`;
                feedbackIcon.textContent = isCorrect ? '‚úì' : '‚úó';
                button.appendChild(feedbackIcon);

                if (isCorrect) {
                    playSound(true);
                    button.classList.add('bg-green-500', 'border-green-600', 'text-white');
                    updateScore(10);
                } else {
                    playSound(false);
                    button.classList.add('bg-red-500', 'border-red-600', 'text-white');
                    const correctButton = questionGroup.querySelector(".quiz-option[data-correct='true']");
                    if (correctButton) {
                        correctButton.classList.add('bg-green-500', 'border-green-600', 'text-white');
                    }
                }
            }

            // Gap-fill helpers (basic)
            function initGapFill(pageId) {
                const page = document.getElementById(`page-${pageId}`);
                if (!page) return;
                const gaps = page.querySelectorAll('.gap');
                const words = page.querySelectorAll('.word-bank-word');

                words.forEach(word => {
                    word.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', word.dataset.word); setTimeout(() => word.classList.add('opacity-50'), 0); });
                    word.addEventListener('dragend', () => word.classList.remove('opacity-50'));
                    word.addEventListener('click', e => {
                        const clicked = e.currentTarget;
                        if (clicked.parentElement.classList.contains('gap')) {
                            clicked.parentElement.classList.remove('correct','incorrect');
                            document.body.appendChild(clicked);
                        }
                    });
                });

                gaps.forEach(gap => {
                    gap.addEventListener('dragover', e => e.preventDefault());
                    gap.addEventListener('drop', e => {
                        e.preventDefault();
                        const wordText = e.dataTransfer.getData('text/plain');
                        const dragged = Array.from(document.querySelectorAll('.word-bank-word')).find(w => w.dataset.word === wordText);
                        if (!dragged) return;
                        gap.innerHTML = '';
                        gap.appendChild(dragged);
                        if (gap.dataset.answer && gap.dataset.answer.toLowerCase() === wordText.toLowerCase()) {
                            gap.classList.add('correct');
                        } else gap.classList.add('incorrect');
                    });
                });
            }

            window.submitWriting = function() {
                const val = document.getElementById('writing-response')?.value || '';
                if (!val.trim()) { alert('Please write something before submitting.'); return; }
                showFeedbackMessage(true);
                updateScore(20);
            }

            // Initialize
            buildPages();
            (async () => { speechService = new SpeechService(); await speechService._setupVoices(); })();

            // expose debug utilities
            window._debug = { lessonData, phases, playOscillator };

        });
    </script>
</body>
</html>
