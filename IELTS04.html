<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classroom Speaking Master</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* Base Styles */
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      overflow: hidden;
      color: #2d3748;
    }

    /* Container */
    .app-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      position: relative;
    }

    /* Cards/Screens */
    .screen-card {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 24px;
      padding: 1.5rem;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 1200px;
      height: 95vh;
      display: none; /* Hidden by default */
      flex-direction: column;
      animation: slideIn 0.4s ease-out;
      position: relative;
    }

    .screen-card.active {
      display: flex;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Setup Screen */
    .student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 0.8rem;
      overflow-y: auto;
      padding-right: 0.5rem;
      max-height: 50vh;
    }

    .student-card {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .student-card:hover { border-color: #667eea; transform: translateY(-2px); }
    .student-card.selected { background: #ebf8ff; border-color: #4299e1; }
    
    .student-avatar {
      width: 32px;
      height: 32px;
      background: #edf2f7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #4a5568;
      font-size: 0.9rem;
    }

    /* Speaking Screen Layout */
    .question-layout {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 0.8rem; /* Reduced gap */
    }

    /* Big Question Box at Top - REDUCED SIZE */
    .question-box {
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 20px;
      font-family: 'Fredoka', sans-serif;
      text-align: center;
      box-shadow: 0 8px 20px rgba(66, 153, 225, 0.4);
      position: relative;
      min-height: 18%; /* Reduced from 25% */
      flex-grow: 0;
      display: flex;
      align-items: flex-start; /* Move text to top */
      justify-content: center;
      padding-top: 1rem;
    }

    .question-text-display {
      font-size: 1.8rem; /* Reduced from 2.2rem */
      line-height: 1.2;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 0.5rem;
      padding-right: 3rem; /* Make room for timer */
    }

    /* Info Bar Below Question */
    .info-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f7fafc;
      padding: 0.5rem 1.5rem;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      flex-shrink: 0;
    }

    /* Help Section (Word Bank) - EXPANDED */
    .help-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr; 
      gap: 1rem;
      flex-grow: 1; /* Allow to grow to fill space */
      min-height: 0; /* Important for scroll */
    }

    .help-panel {
      background: #fff;
      border: 2px solid #edf2f7;
      border-radius: 16px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
    }

    .help-header {
      font-family: 'Fredoka', sans-serif;
      color: #4a5568;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: bold;
    }

    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      overflow-y: auto;
      align-content: flex-start;
      padding-bottom: 0.5rem;
    }

    .tag {
      background: #f7fafc;
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      border: 1px solid #cbd5e0;
      font-size: 0.9rem;
      color: #2d3748;
      font-weight: 600;
      box-shadow: 0 2px 0 rgba(0,0,0,0.05);
    }
    
    .tag.special {
        background: #ebf8ff;
        border-color: #bee3f8;
        color: #2b6cb0;
    }
    
    .tag.idiom {
        background: #f0fff4;
        border-color: #9ae6b4;
        color: #276749;
        font-weight: 800;
        width: 100%; /* Force idiom to own line */
        text-align: center;
    }

    /* Timer & Progress */
    .timer-float {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(4px);
      color: white;
      padding: 0.2rem 1.2rem;
      border-radius: 50px;
      font-weight: 800;
      font-size: 1.5rem; /* Reduced slightly */
      border: 2px solid rgba(255,255,255,0.4);
    }

    .progress-track {
      width: 100%;
      height: 12px;
      background: #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
      margin-top: auto;
      flex-shrink: 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #48bb78, #38a169);
      width: 100%;
      transition: width 1s linear;
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: bold;
      font-size: 1.2rem;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 15px rgba(0,0,0,0.2); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background: #cbd5e0; }

    /* Selection Screen */
    .roulette-wrapper {
      background: #2d3748;
      color: white;
      border-radius: 30px;
      padding: 4rem 2rem;
      text-align: center;
      margin: 2rem 0;
      border: 8px solid #4a5568;
      box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
    }
    .roulette-name { font-size: 4.5rem; font-family: 'Fredoka', sans-serif; text-shadow: 0 4px 0 #000; }

    /* Countdown */
    .giant-countdown {
      font-size: 12rem;
      font-weight: 900;
      color: #4299e1;
      text-align: center;
      animation: pulse 1s infinite;
      font-family: 'Fredoka', sans-serif;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    /* Preview Screen Layout */
    .preview-grid {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 1.5rem;
    }
    .preview-card {
      flex: 1;
      background: #ebf8ff;
      border-left: 8px solid #4299e1;
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* Transition Overlay */
    #transition-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 50;
        border-radius: 24px;
    }
  </style>
 </head>
 <body>

 <div class="app-container">

  <!-- 1. SETUP SCREEN -->
  <div id="screen-setup" class="screen-card active">
    <h1 class="text-4xl font-extrabold text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-6 font-fredoka">IELTS Speaking Master</h1>
    
    <div class="grid grid-cols-2 gap-6 mb-6">
      <div class="flex flex-col">
        <label class="font-bold text-gray-600 mb-2 text-lg">ðŸ“… Practice Date</label>
        <input type="date" id="date-picker" class="p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none text-xl font-bold text-gray-700">
      </div>
      <div class="flex flex-col">
        <label class="font-bold text-gray-600 mb-2 text-lg">ðŸ“š Select Topic</label>
        <select id="theme-select" class="p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none bg-white text-xl font-bold text-gray-700">
          <!-- Populated by JS -->
        </select>
      </div>
    </div>

    <div class="flex-grow flex flex-col min-h-0">
      <div class="flex justify-between items-end mb-2">
        <h2 class="text-2xl font-bold text-gray-700">ðŸŽ“ Attendance (10 Max Recommended)</h2>
        <button onclick="selectAllStudents()" class="text-blue-600 font-bold hover:bg-blue-50 px-3 py-1 rounded">Select All</button>
      </div>
      <div id="student-grid" class="student-grid">
        <!-- Populated by JS -->
      </div>
    </div>

    <button id="btn-start" class="btn-primary mt-6" disabled>ðŸš€ Start Session</button>
  </div>

  <!-- 2. PREVIEW SCREEN -->
  <div id="screen-preview" class="screen-card">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-3xl font-extrabold text-gray-800">Topic Preview</h2>
      <div class="bg-red-100 text-red-600 font-black px-6 py-2 rounded-xl text-3xl shadow-sm border border-red-200" id="preview-timer">60</div>
    </div>
    
    <div id="preview-content" class="preview-grid">
      <!-- Populated by JS to fill screen -->
    </div>
  </div>

  <!-- 3. SELECTION SCREEN -->
  <div id="screen-selection" class="screen-card" style="max-width: 900px; justify-content: center;">
    <h2 class="text-4xl font-extrabold text-gray-700 text-center mb-6">ðŸŽ² Who is speaking next?</h2>
    <div class="roulette-wrapper">
      <div id="roulette-display" class="roulette-name">...</div>
    </div>
  </div>

  <!-- 4. COUNTDOWN SCREEN -->
  <div id="screen-countdown" class="screen-card" style="justify-content: center;">
    <h2 class="text-4xl font-bold text-gray-600 text-center mb-10">Get Ready!</h2>
    <div id="countdown-display" class="giant-countdown">5</div>
    <div id="next-speaker-name" class="text-4xl mt-12 font-bold text-blue-600 text-center"></div>
  </div>

  <!-- 5. SPEAKING SCREEN (MAIN) -->
  <div id="screen-speaking" class="screen-card">
    <!-- Overlay for Fast Transition -->
    <div id="transition-overlay">
        <div class="text-6xl mb-4">ðŸŽ‰</div>
        <h1 class="text-5xl font-black text-blue-600 mb-2">Great Job!</h1>
        <p class="text-2xl text-gray-500 font-bold">Getting next student...</p>
    </div>

    <div class="question-layout">
      
      <!-- Top: Big Question -->
      <div class="question-box">
        <div id="question-timer" class="timer-float">30</div>
        <div id="question-text" class="question-text-display">
          Question text goes here...
        </div>
      </div>

      <!-- Middle: Info Bar -->
      <div class="info-bar">
        <div class="flex items-center gap-4">
          <div class="bg-blue-100 p-3 rounded-full text-blue-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </div>
          <div>
            <div class="text-xs font-bold text-gray-400 uppercase tracking-wide">Current Speaker</div>
            <div id="active-speaker" class="text-2xl font-black text-gray-800">Student Name</div>
          </div>
        </div>

        <div class="bg-gray-100 px-6 py-2 rounded-lg border border-gray-200">
          <div class="text-xs font-bold text-gray-400 uppercase text-center">Current Section</div>
          <div id="active-part" class="text-xl font-bold text-blue-600">Part 1</div>
        </div>

        <div id="recording-badge" class="flex items-center gap-3 bg-red-50 text-red-600 px-5 py-2 rounded-full border border-red-100 shadow-sm animate-pulse">
            <div class="w-4 h-4 bg-red-500 rounded-full shadow-[0_0_10px_rgba(239,68,68,0.8)]"></div> 
            <span class="font-bold tracking-wider">RECORDING</span>
        </div>
      </div>

      <!-- Bottom: Help & Progress (Reordered) -->
      <div class="help-grid">
        <!-- 1. IELTS Toolkit (Left) -->
        <div class="help-panel bg-purple-50 border-purple-100">
          <div class="help-header text-purple-600">
            <span>ðŸš€</span> IELTS Toolkit
          </div>
          <div id="toolkit-container" class="tag-container">
            <!-- Universal Cohesive Devices -->
          </div>
        </div>

        <!-- 2. Idea Starters (Middle) -->
        <div class="help-panel">
          <div class="help-header text-blue-600">
            <span>ðŸ’¡</span> Idea Starters
          </div>
          <div id="stems-container" class="tag-container"></div>
        </div>

        <!-- 3. Key Vocabulary (Right) -->
        <div class="help-panel">
          <div class="help-header text-green-600">
            <span>ðŸ“š</span> Key Vocabulary
          </div>
          <div id="words-container" class="tag-container"></div>
        </div>
      </div>

      <div class="progress-track">
        <div id="progress-bar" class="progress-fill"></div>
      </div>
      
    </div>
  </div>

 </div>

 <script>
/** * CONFIGURATION & DATA */
// EXPANDED TOOLKIT FOR SECONDARY STUDENTS
const IELTS_TOOLKIT = [
  "Let me see...", "That's a tricky one...", "To be honest...", "Frankly speaking...",
  "On the other hand...", "Furthermore...", "Consequently...", "For instance...",
  "Another key point is...", "In contrast...", "Generally speaking...", "Specifically...",
  "Looking at it from another angle...", "I guess what I'm trying to say is...",
  "It goes without saying that...", "Believe it or not...", "As far as I'm concerned...",
  "To put it simply...", "Needless to say..."
];

const STUDENTS = [
  { english: "Iris", chinese: "æŸ´å“ç‘¶" },
  { english: "Max", chinese: "æŽä¹‹ç”¨" },
  { english: "Cathy", chinese: "æž—äº‘æ›¦" },
  { english: "Sandy", chinese: "åˆ˜ç‚å«" },
  { english: "Vicky", chinese: "éª†æ¢¦ä¹”" },
  { english: "Jim", chinese: "å®‹æ˜Šè½©" },
  { english: "Jackie", chinese: "å‘å®¶æ…•" },
  { english: "Jay", chinese: "å¾å˜‰ç" },
  { english: "Grace", chinese: "æ¨é¦¥å®" },
  { english: "Emily", chinese: "å¼ ä¸Žå“" },
  { english: "Rhea", chinese: "èµµåƒæ¢¦" }
];

// TIMING CONFIGURATION (Adjusted for 40 min class / 10 students)
const TIMING = {
    part1: 30, // Warm up (Fast)
    part2: 90, // Monologue (1.5 min)
    part3: 45  // Discussion (Short & Sharp)
};

// Expanded Word Banks
const THEMES = [
  {
    name: "Hobbies & Free Time",
    idiom: "Recharge one's batteries (å……ç”µ/æ¢å¤ä½“åŠ›)",
    part1: "What do you usually do on weekends to relax?",
    part1_stems: ["I tend to...", "My go-to activity is...", "I'm really into...", "Whenever I have a spare moment...", "I'm completely hooked on..."],
    part1_words: ["unwind", "leisure", "passion", "recharge", "escapism", "downtime", "therapeutic", "extra-curricular", "stress-buster"],
    
    part2: "Describe a hobby you really enjoy. What is it? When did you start? Why do you like it?",
    part2_stems: ["One hobby I'm passionate about is...", "I took it up when...", "It appeals to me because...", "What draws me to this is...", "I've been doing this since..."],
    part2_words: ["creative outlet", "therapeutic", "challenging", "sense of achievement", "stimulating", "productivity", "skill-building", "dedication"],
    
    part3: "Why is it important for students to have hobbies outside of school?",
    part3_stems: ["Crucially...", "It fosters...", "Aside from academics...", "Striking a balance is key because...", "From a mental health perspective..."],
    part3_words: ["well-rounded", "mental well-being", "social skills", "balance", "holistic development", "burnout", "academic pressure", "relief"]
  },
  {
    name: "School Life",
    idiom: "Hit the books (ç”¨åŠŸè¯»ä¹¦)",
    part1: "Which subject do you find most interesting at school?",
    part1_stems: ["Without a doubt...", "I find ... fascinating because...", "I'm drawn to...", "I have a knack for...", "It captures my imagination because..."],
    part1_words: ["engaging", "curriculum", "concepts", "practical", "theory", "intellectually stimulating", "hands-on", "thought-provoking"],
    
    part2: "Describe your favorite teacher. Who are they? What do they teach? Why do you like them?",
    part2_stems: ["The teacher who stands out is...", "Their teaching style is...", "I admire them for...", "They have a unique way of...", "What sets them apart is..."],
    part2_words: ["inspirational", "approachable", "knowledgeable", "engaging", "mentor", "role model", "supportive", "charismatic", "patience"],
    
    part3: "Do you think homework is useful for students?",
    part3_stems: ["To some extent...", "Conversely...", "It reinforces...", "It's a contentious issue but...", "Ideally, it should be..."],
    part3_words: ["consolidation", "burden", "independent learning", "discipline", "time management", "academic performance", "workload", "retention"]
  },
  {
    name: "Friends",
    idiom: "Through thick and thin (åŒç”˜å…±è‹¦)",
    part1: "How often do you see your friends outside of school?",
    part1_stems: ["Typically...", "We make a point to...", "Due to my schedule...", "Not as often as I'd like...", "We try to coordinate..."],
    part1_words: ["catch up", "socialize", "bond", "hang out", "quality time", "interaction", "camaraderie", "get-together"],
    
    part2: "Describe your best friend. How did you meet? What do you do together? Why are you close?",
    part2_stems: ["My closest companion is...", "We crossed paths...", "Our bond is built on...", "We hit it off immediately because...", "We are like two peas in a pod..."],
    part2_words: ["inseparable", "mutual trust", "supportive", "confidant", "shared interests", "reliability", "childhood friend", "soulmate"],
    
    part3: "What qualities make a good friend?",
    part3_stems: ["Fundamentally...", "A key attribute is...", "Above all...", "I value...", "In my opinion, the foundation is..."],
    part3_words: ["loyalty", "empathy", "reliability", "non-judgmental", "integrity", "trustworthiness", "support system", "dependable"]
  },
  {
    name: "Food & Snacks",
    idiom: "Make my mouth water (ä»¤äººåž‚æ¶Ž/æµå£æ°´)",
    part1: "What is your favorite snack?",
    part1_stems: ["I have a sweet tooth for...", "I crave...", "My absolute favorite is...", "I can't resist...", "When I'm feeling peckish..."],
    part1_words: ["savory", "nutritious", "guilty pleasure", "refreshing", "addictive", "homemade", "processed", "crispy"],
    
    part2: "Describe a special meal you had recently. What did you eat? Who were you with? Why was it special?",
    part2_stems: ["A memorable dining experience was...", "The highlight was...", "The ambiance was...", "We feasted on...", "It wasn't just about the food, but..."],
    part2_words: ["cuisine", "delicacy", "gathering", "atmosphere", "celebratory", "authentic", "aroma", "hospitality", "gourmet"],
    
    part3: "Do you think young people today eat too much fast food?",
    part3_stems: ["Undeniably...", "The convenience leads to...", "From a health perspective...", "It's a worrying trend that...", "We are bombarded by advertisements for..."],
    part3_words: ["obesity", "processed", "lifestyle", "dietary habits", "nutrition", "calories", "convenience culture", "well-balanced diet"]
  },
  {
    name: "Social Media",
    idiom: "Go viral (è¿…é€Ÿèµ°çº¢)",
    part1: "Which app do you use the most on your phone?",
    part1_stems: ["I'm constantly on...", "I find myself scrolling...", "It's essential for...", "I'm glued to...", "It's my primary source of..."],
    part1_words: ["interface", "connect", "content", "algorithm", "addictive", "user-friendly", "notification", "digital footprint"],
    
    part2: "Describe a website or app that helps you learn. What is it? How do you use it? Why is it helpful?",
    part2_stems: ["An invaluable tool for me is...", "It features...", "It enhances my learning by...", "I rely on it for...", "It simplifies complex topics by..."],
    part2_words: ["resource", "interactive", "comprehensive", "accessible", "tutorial", "visual aid", "database", "efficient"],
    
    part3: "Do teenagers spend too much time on their phones?",
    part3_stems: ["It's a double-edged sword...", "Excessive screen time...", "We need to balance...", "The fear of missing out drives...", "It distracts us from..."],
    part3_words: ["detrimental", "virtual interaction", "sedentary", "moderation", "cyberbullying", "attention span", "face-to-face", "addiction"]
  },
  {
    name: "Sports",
    idiom: "Give it my best shot (å…¨åŠ›ä»¥èµ´)",
    part1: "Do you prefer watching sports or playing sports?",
    part1_stems: ["I'm more of a spectator...", "I definitely prefer participating...", "I find playing more...", "There is nothing like the feeling of...", "Watching is passive, whereas..."],
    part1_words: ["adrenaline", "competitive", "atmosphere", "physically demanding", "team spirit", "cheering", "engagement", "fitness"],
    
    part2: "Describe a sport you would like to try in the future. What is it? Why do you want to try it?",
    part2_stems: ["I've always been intrigued by...", "It seems incredibly...", "I'd love to attempt...", "It challenges your...", "It looks like an exhilarating way to..."],
    part2_words: ["extreme sport", "coordination", "endurance", "thrilling", "stamina", "agility", "discipline", "technique"],
    
    part3: "Why is PE class important in school?",
    part3_stems: ["It's vital because...", "It combats...", "Beyond fitness...", "It provides a break from...", "It instills values like..."],
    part3_words: ["sedentary lifestyle", "teamwork", "stress relief", "discipline", "obesity prevention", "mental clarity", "cooperation", "physical health"]
  },
  {
    name: "Movies",
    idiom: "On the edge of my seat (æ‰£äººå¿ƒå¼¦)",
    part1: "What kind of movies do you like best?",
    part1_stems: ["I'm a huge fan of...", "I gravitate towards...", "My genre of choice is...", "I appreciate movies that...", "I'm a sucker for..."],
    part1_words: ["sci-fi", "plot twists", "visual effects", "cinematography", "suspense", "character development", "blockbuster", "soundtrack"],
    
    part2: "Describe a movie that made you laugh. What was it? Who was in it? Why was it funny?",
    part2_stems: ["A film that had me in stitches was...", "The humor was...", "It starred...", "The punchlines were...", "I couldn't stop laughing because..."],
    part2_words: ["comedy", "hilarious", "witty", "slapstick", "dialogue", "entertaining", "comic relief", "performance"],
    
    part3: "Is it better to watch movies at home or in the cinema?",
    part3_stems: ["There are pros and cons...", "The cinema offers...", "Home viewing is...", "For visual spectacles...", "If you prioritize comfort..."],
    part3_words: ["immersive experience", "convenience", "social outing", "sound system", "atmosphere", "distractions", "big screen", "flexibility"]
  },
  {
    name: "Travel",
    idiom: "Off the beaten track (äººè¿¹ç½•è‡³/ä¸è½ä¿—å¥—)",
    part1: "Do you like traveling by car or by plane?",
    part1_stems: ["Given the choice...", "I prefer the speed of...", "Road trips are...", "Flying is definitely...", "I enjoy the flexibility of..."],
    part1_words: ["efficiency", "scenic", "journey", "hassle", "destination", "convenience", "security check", "landscape"],
    
    part2: "Describe a city you want to visit. Where is it? What is it famous for? Why do you want to go?",
    part2_stems: ["Top of my bucket list is...", "It's renowned for...", "I'm dying to visit...", "I've heard amazing things about...", "It attracts tourists because..."],
    part2_words: ["architecture", "culture", "landmarks", "vibrant", "cuisine", "historical", "metropolis", "atmosphere"],
    
    part3: "What can we learn from visiting other places?",
    part3_stems: ["It broadens our horizons...", "We gain insight into...", "Exposure to...", "It shatters stereotypes...", "It teaches us to appreciate..."],
    part3_words: ["cultural diversity", "perspective", "tolerance", "history", "customs", "global citizen", "empathy", "traditions"]
  },
  {
    name: "Festivals & Holidays",
    idiom: "Have a blast (çŽ©å¾—å¾ˆç—›å¿«)",
    part1: "What is your favorite holiday of the year?",
    part1_stems: ["I look forward to...", "Nothing beats...", "My favorite has to be...", "It holds a special place in my heart...", "The vibe during ... is amazing"],
    part1_words: ["festive", "reunion", "atmosphere", "anticipation", "decorations", "tradition", "break", "memorable"],
    
    part2: "Describe how you celebrated a festival recently. What did you do? What did you eat? Who were you with?",
    part2_stems: ["During the recent...", "We observed the tradition of...", "It was a joyous occasion because...", "The highlight of the day was...", "We gathered to..."],
    part2_words: ["gathering", "traditional", "customs", "feast", "celebration", "ceremony", "relatives", "blessing", "ritual"],
    
    part3: "Why are traditional festivals important?",
    part3_stems: ["They preserve...", "They serve as a reminder...", "Culturally speaking...", "They bind generations together...", "In a modernizing world..."],
    part3_words: ["heritage", "identity", "continuity", "ancestors", "cultural preservation", "belonging", "values", "roots"]
  },
  {
    name: "Shopping & Fashion",
    idiom: "Cost an arm and a leg (éžå¸¸æ˜‚è´µ)",
    part1: "Do you enjoy buying new clothes?",
    part1_stems: ["I'm quite into...", "I view it as...", "Not particularly, because...", "I only shop when...", "I love keeping up with..."],
    part1_words: ["fashion trends", "express myself", "chore", "retail therapy", "wardrobe", "style", "necessity", "bargain"],
    
    part2: "Describe something you bought recently that you like. What is it? Where did you buy it? Why do you like it?",
    part2_stems: ["I recently purchased...", "I picked it up at...", "It caught my eye because...", "It was a steal...", "It's incredibly versatile..."],
    part2_words: ["good value", "quality", "design", "practical", "impulse buy", "investment", "durable", "aesthetic"],
    
    part3: "Do you think famous brands are worth the money?",
    part3_stems: ["It depends entirely on...", "Often you are paying for...", "In terms of quality...", "Sometimes it's just about the logo...", "Luxury brands offer..."],
    part3_words: ["status symbol", "craftsmanship", "marketing", "durability", "prestige", "overpriced", "reputation", "materialism"]
  }
];

let state = {
  date: new Date().toISOString().split('T')[0],
  selectedThemeIndex: 0,
  selectedStudents: new Set(),
  remainingStudents: [],
  currentStudent: null,
  step: 'setup', 
  currentPart: 1,
  timerInterval: null,
  mediaRecorder: null,
  audioChunks: [],
  stream: null
};

/* --- AUDIO EFFECTS --- */
// Using Web Audio API for synthesized sounds
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

function playTone(freq, type, duration) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}

function playClickSound() { playTone(800, 'square', 0.05); }
function playTickSound() { playTone(1200, 'sine', 0.05); }
function playWinSound() { 
  [400, 500, 600, 800].forEach((f, i) => setTimeout(() => playTone(f, 'triangle', 0.3), i * 100));
}

/* --- TTS --- */
function speakText(text) {
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  
  const voices = window.speechSynthesis.getVoices();
  const targetVoice = voices.find(v => v.name.includes('Andrew') || v.name.includes('Brian') || v.name.includes('Emma'));
  const backupVoice = voices.find(v => v.name.includes('Microsoft') && v.lang.includes('en'));
  
  if (targetVoice) utterance.voice = targetVoice;
  else if (backupVoice) utterance.voice = backupVoice;
  
  utterance.rate = 0.85; // Slow down
  window.speechSynthesis.speak(utterance);
}

// Init voices
window.speechSynthesis.onvoiceschanged = () => { console.log("Voices loaded"); };


/* --- DOM & LOGIC --- */
const screens = {
  setup: document.getElementById('screen-setup'),
  preview: document.getElementById('screen-preview'),
  selection: document.getElementById('screen-selection'),
  countdown: document.getElementById('screen-countdown'),
  speaking: document.getElementById('screen-speaking')
};

function init() {
  document.getElementById('date-picker').value = state.date;
  const themeSelect = document.getElementById('theme-select');
  THEMES.forEach((theme, index) => {
    const opt = document.createElement('option');
    opt.value = index;
    opt.textContent = theme.name;
    themeSelect.appendChild(opt);
  });
  renderStudentGrid();
  document.getElementById('theme-select').addEventListener('change', (e) => state.selectedThemeIndex = parseInt(e.target.value));
  document.getElementById('date-picker').addEventListener('change', (e) => state.date = e.target.value);
  document.getElementById('btn-start').addEventListener('click', startPreview);
}

function renderStudentGrid() {
  const grid = document.getElementById('student-grid');
  grid.innerHTML = '';
  STUDENTS.forEach((student, index) => {
    const el = document.createElement('div');
    el.className = `student-card ${state.selectedStudents.has(index) ? 'selected' : ''}`;
    el.onclick = () => toggleStudent(index);
    el.innerHTML = `
      <div class="student-avatar">${student.english.substring(0,2)}</div>
      <div>
        <div class="font-bold text-gray-700">${student.english}</div>
        <div class="text-xs text-gray-400">${student.chinese}</div>
      </div>
    `;
    grid.appendChild(el);
  });
  document.getElementById('btn-start').disabled = state.selectedStudents.size === 0;
}

function toggleStudent(index) {
  if (state.selectedStudents.has(index)) state.selectedStudents.delete(index);
  else state.selectedStudents.add(index);
  renderStudentGrid();
}

function selectAllStudents() {
  state.selectedStudents = new Set(STUDENTS.map((_, i) => i));
  renderStudentGrid();
}

function switchScreen(screenName) {
  Object.values(screens).forEach(s => s.classList.remove('active'));
  screens[screenName].classList.add('active');
}

// Helper: Fisher-Yates Shuffle for robust randomization
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// 1. PREVIEW
async function startPreview() {
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  try {
    state.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch (err) {
    alert("Microphone access is required for recording!");
  }

  const theme = THEMES[state.selectedThemeIndex];
  const container = document.getElementById('preview-content');
  
  container.innerHTML = `
    <div class="preview-card bg-blue-50 border-l-8 border-blue-500">
      <h3 class="text-2xl font-black text-blue-700 uppercase tracking-widest mb-2">Part 1 (${TIMING.part1}s)</h3>
      <p class="text-3xl font-bold text-gray-800 leading-tight">${theme.part1}</p>
    </div>
    <div class="preview-card bg-green-50 border-l-8 border-green-500">
      <h3 class="text-2xl font-black text-green-700 uppercase tracking-widest mb-2">Part 2 (${TIMING.part2}s)</h3>
      <p class="text-3xl font-bold text-gray-800 leading-tight">${theme.part2}</p>
    </div>
    <div class="preview-card bg-purple-50 border-l-8 border-purple-500">
      <h3 class="text-2xl font-black text-purple-700 uppercase tracking-widest mb-2">Part 3 (${TIMING.part3}s)</h3>
      <p class="text-3xl font-bold text-gray-800 leading-tight">${theme.part3}</p>
    </div>
  `;

  // ROBUST RANDOMIZATION: Fisher-Yates shuffle
  let selectedIndices = Array.from(state.selectedStudents);
  selectedIndices = shuffleArray(selectedIndices);
  state.remainingStudents = selectedIndices.map(i => STUDENTS[i]);

  switchScreen('preview');
  
  let timeLeft = 60;
  const timerDisplay = document.getElementById('preview-timer');
  const interval = setInterval(() => {
    timeLeft--;
    timerDisplay.textContent = timeLeft;
    if (timeLeft <= 10) playTickSound();
    if(timeLeft <= 0) {
      clearInterval(interval);
      startSelection();
    }
  }, 1000);
}

// 2. SELECTION
function startSelection() {
  if(state.remainingStudents.length === 0) {
    alert("All students have finished!");
    location.reload();
    return;
  }
  
  // Hide transition overlay if active
  document.getElementById('transition-overlay').style.display = 'none';

  switchScreen('selection');
  const display = document.getElementById('roulette-display');
  let counter = 0;
  let speed = 50;
  
  const spin = () => {
    // Show random name from ALL students for visual effect, but pick specific one at end
    const randomName = STUDENTS[Math.floor(Math.random() * STUDENTS.length)].english;
    display.textContent = randomName;
    playClickSound();
    
    counter++;
    if(counter < 30) { // Reduced spin time for efficiency
      setTimeout(spin, speed);
      speed += 5;
    } else {
      // Pick the next student in the shuffled queue
      state.currentStudent = state.remainingStudents[0];
      display.textContent = state.currentStudent.english;
      display.style.color = '#48bb78';
      playWinSound();
      
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
      });

      setTimeout(startCountdown, 2000); // Faster transition
    }
  };
  spin();
}

// 3. COUNTDOWN
function startCountdown() {
  switchScreen('countdown');
  document.getElementById('next-speaker-name').textContent = `${state.currentStudent.english} (${state.currentStudent.chinese})`;
  let timeLeft = 3; // Reduced from 5 for speed
  const display = document.getElementById('countdown-display');
  
  const interval = setInterval(() => {
    timeLeft--;
    display.textContent = timeLeft;
    playTickSound();
    if(timeLeft <= 0) {
      clearInterval(interval);
      startSpeakingSession();
    }
  }, 1000);
}

// 4. SPEAKING SESSION
function startSpeakingSession() {
  switchScreen('speaking');
  document.getElementById('active-speaker').textContent = state.currentStudent.english;
  
  if (state.stream) {
    state.audioChunks = [];
    state.mediaRecorder = new MediaRecorder(state.stream);
    state.mediaRecorder.ondataavailable = e => state.audioChunks.push(e.data);
    state.mediaRecorder.start();
    document.getElementById('recording-badge').style.opacity = 1;
  }

  runPart(1);
}

function runPart(partNumber) {
  state.currentPart = partNumber;
  const theme = THEMES[state.selectedThemeIndex];
  const qText = document.getElementById('question-text');
  const pBar = document.getElementById('progress-bar');
  const partLabel = document.getElementById('active-part');
  
  let question, duration, stems, words;
  if(partNumber === 1) {
    question = theme.part1; duration = TIMING.part1; stems = theme.part1_stems; words = theme.part1_words;
  } else if(partNumber === 2) {
    question = theme.part2; duration = TIMING.part2; stems = theme.part2_stems; words = theme.part2_words;
  } else {
    question = theme.part3; duration = TIMING.part3; stems = theme.part3_stems; words = theme.part3_words;
  }

  partLabel.textContent = `Part ${partNumber}`;
  qText.textContent = question;
  pBar.style.width = '100%';
  pBar.style.transition = 'none';
  
  renderTags('stems-container', stems);
  renderTags('words-container', words);
  renderTags('toolkit-container', IELTS_TOOLKIT, true);
  
  const wordsContainer = document.getElementById('words-container');
  const idiomTag = document.createElement('span');
  idiomTag.className = 'tag idiom';
  idiomTag.textContent = theme.idiom;
  wordsContainer.prepend(idiomTag);

  speakText(question);

  const timerDisplay = document.getElementById('question-timer');
  let remaining = duration;
  timerDisplay.textContent = remaining;

  setTimeout(() => {
    pBar.style.transition = `width ${duration}s linear`;
    pBar.style.width = '0%';
  }, 100);

  if(state.timerInterval) clearInterval(state.timerInterval);

  state.timerInterval = setInterval(() => {
    remaining--;
    timerDisplay.textContent = remaining;
    
    if(remaining <= 10) {
       timerDisplay.style.background = 'red'; 
       playTickSound();
    } else {
       timerDisplay.style.background = 'rgba(255,255,255,0.2)';
    }

    if(remaining <= 0) {
      clearInterval(state.timerInterval);
      if(partNumber < 3) runPart(partNumber + 1);
      else finishStudent();
    }
  }, 1000);
}

function renderTags(containerId, items, isSpecial = false) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  items.forEach(item => {
    const tag = document.createElement('span');
    tag.className = `tag ${isSpecial ? 'special' : ''}`;
    tag.textContent = item;
    container.appendChild(tag);
  });
}

// 5. FAST FINISH (NO FEEDBACK SCREEN)
function finishStudent() {
  state.remainingStudents.shift();
  
  // Stop Recorder & Download
  if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
    state.mediaRecorder.onstop = () => {
      const blob = new Blob(state.audioChunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${state.currentStudent.english}_${state.date}_IELTS_Practice.webm`;
      a.click();
    };
    state.mediaRecorder.stop();
  }

  // Show Overlay on top of Speaking Screen
  const overlay = document.getElementById('transition-overlay');
  overlay.style.display = 'flex';
  playWinSound();
  confetti({ particleCount: 100, origin: { y: 0.5 } });

  // Auto-next after 3 seconds
  setTimeout(() => {
      startSelection();
  }, 3000);
}

init();

</script>
</body>
</html>
